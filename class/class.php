<?php
isset($_SESSION) or session_start();

//error_reporting(0);//desactivo errores
ini_set('display_errors', 1);
// Motrar todos los errores de PHP
error_reporting(E_ALL);//muestro errores
//evita el error Fatal error: Allowed memory size of X bytes exhausted (tried to allocate Y bytes)...
ini_set('memory_limit', '-1'); 
// es lo mismo que set_time_limit(300) ;
ini_set('max_execution_time', 3800); 
//error_log("display_errors", 3, "error_log.log");

require_once("classconexion.php");
/* Clase principal de PHPMailer */
require("PHPMailer/PHPMailer.php");
/* Clase SMTP, necesaria si quieres usar SMTP */
require("PHPMailer/SMTP.php");
/* Clase Exception */
require("PHPMailer/Exception.php");

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\SMTP;
use PHPMailer\PHPMailer\Exception;
use function PHP81_BC\strftime;

################################## CLASE LOGIN ###################################
class Login extends Db
{

public function __construct()
{
	parent::__construct();
} 	

###################### FUNCION PARA CALCULAR EXISTENCIA VIRTUAL DE PRODUCTOS HIJO ####################
/**
 * Calcula la existencia disponible considerando productos compuestos
 * Para productos HIJO: existencia = stock_padre / cantidad_conversion
 * Para productos SIMPLE/PADRE: existencia = stock propio
 * 
 * @param array $producto - Array con datos del producto
 * @return float - Existencia disponible (virtual para HIJO, real para otros)
 */
public function CalcularExistenciaVirtual($producto)
{
	$tipoProducto = isset($producto['tipo_producto']) ? $producto['tipo_producto'] : 'SIMPLE';
	
	if ($tipoProducto == 'HIJO' && isset($producto['producto_padre_id']) && $producto['producto_padre_id'] > 0) {
		// Producto HIJO: calcular existencia virtual basada en el padre
		$cantidadConversion = isset($producto['cantidad_conversion']) ? floatval($producto['cantidad_conversion']) : 1;
		
		if ($cantidadConversion > 0) {
			// Obtener existencia del padre
			$sql = "SELECT existencia FROM productos WHERE idproducto = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($producto['producto_padre_id']));
			$padre = $stmt->fetch(PDO::FETCH_ASSOC);
			
			if ($padre) {
				$existenciaPadre = floatval($padre['existencia']);
				// Existencia virtual = cuántos "hijos" se pueden formar con el stock del padre
				return floor($existenciaPadre / $cantidadConversion);
			}
		}
		return 0;
	}
	
	// Producto SIMPLE o PADRE: retornar existencia directa
	return isset($producto['existencia']) ? floatval($producto['existencia']) : 0;
}

/**
 * Obtiene la existencia virtual de un producto por su ID
 * @param int $idproducto
 * @param int $codsucursal
 * @return float
 */
public function ObtenerExistenciaProducto($idproducto, $codsucursal)
{
	self::SetNames();
	$sql = "SELECT 
		productos.existencia,
		productos.tipo_producto,
		productos.producto_padre_id,
		productos.cantidad_conversion,
		producto_padre.existencia AS padre_existencia
	FROM productos 
	LEFT JOIN productos AS producto_padre ON productos.producto_padre_id = producto_padre.idproducto
	WHERE productos.idproducto = ? AND productos.codsucursal = ?";
	
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($idproducto, $codsucursal));
	$row = $stmt->fetch(PDO::FETCH_ASSOC);
	
	if (!$row) return 0;
	
	$tipoProducto = isset($row['tipo_producto']) ? $row['tipo_producto'] : 'SIMPLE';
	
	if ($tipoProducto == 'HIJO' && isset($row['producto_padre_id'])) {
		$cantidadConversion = isset($row['cantidad_conversion']) ? floatval($row['cantidad_conversion']) : 1;
		if ($cantidadConversion > 0 && isset($row['padre_existencia'])) {
			return floor(floatval($row['padre_existencia']) / $cantidadConversion);
		}
		return 0;
	}
	
	return floatval($row['existencia']);
}
###################### FIN FUNCION CALCULAR EXISTENCIA VIRTUAL ####################


###################### FUNCION PARA EXPIRAR SESSION POR INACTIVIDAD ####################
public function ExpiraSession()
{
}
###################### FUNCION PARA EXPIRAR SESSION POR INACTIVIDAD ####################


#################### FUNCION PARA ACCEDER AL SISTEMA ####################
public function Logueo()
{
	self::SetNames();
	if(empty($_POST["usuario"]) or empty($_POST["password"]))
	{
		echo "1";
		exit;
	}

	$sql = "SELECT
	usuarios.codigo, 
	usuarios.dni,
	usuarios.nombres,
	usuarios.sexo,
	usuarios.direccion,
	usuarios.telefono,
	usuarios.email,
	usuarios.usuario,
	usuarios.password,
	usuarios.nivel,
	usuarios.status,
	usuarios.codsucursal,
	sucursales.documsucursal,
	sucursales.cuitsucursal,
	sucursales.nomsucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.iniciofactura,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.descsucursal,
	sucursales.porcentaje,
	sucursales.estado,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	provincias.provincia,
	departamentos.departamento
	FROM usuarios LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	WHERE usuarios.usuario = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["usuario"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		echo "2";
		exit;
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[]=$row;
		}
		if (limpiar($row['nivel']) != "ADMINISTRADOR(A) GENERAL" && limpiar($row['estado']) == 0)
		{  
			echo "3";
			exit; 
	    } 
	    elseif (limpiar($row['status']) == 0) 
		{  
			echo "4";
			exit;
		} 
		elseif (password_verify($_POST["password"], $row['password'])) {
		
		######### DATOS DEL USUARIO ###########
		$_SESSION["codigo"]    = $p[0]["codigo"];
		$_SESSION["dni"]       = $p[0]["dni"];
		$_SESSION["nombres"]   = $p[0]["nombres"];
		$_SESSION["sexo"]      = $p[0]["sexo"];
		$_SESSION["direccion"] = $p[0]["direccion"];
		$_SESSION["telefono"]  = $p[0]["telefono"];
		$_SESSION["email"]     = $p[0]["email"];
		$_SESSION["usuario"]   = $p[0]["usuario"];
		$_SESSION["password"]  = $p[0]["password"];
		$_SESSION["nivel"]     = $p[0]["nivel"];
		$_SESSION["status"]    = $p[0]["status"];
		$_SESSION["ingreso"]   = limpiar(date("d-m-Y H:i:s A"));
		######### DATOS DEL USUARIO ###########

        ######### DATOS DE LA SUCURSAL ###########
		$_SESSION["codsucursal"]     = $p[0]["codsucursal"];
		$_SESSION["documsucursal"]   = $p[0]["documsucursal"];
		$_SESSION["cuitsucursal"]    = $p[0]["cuitsucursal"];
		$_SESSION["nomsucursal"]     = $p[0]["nomsucursal"];
		$_SESSION["tlfsucursal"]     = $p[0]["tlfsucursal"];
		$_SESSION["id_provincia"]    = $p[0]["id_provincia"];
		$_SESSION["provincia"]       = $p[0]["provincia"];
		$_SESSION["id_departamento"] = $p[0]["id_departamento"];
		$_SESSION["departamento"]    = $p[0]["departamento"];
		$_SESSION["direcsucursal"]   = $p[0]["direcsucursal"];
		$_SESSION["correosucursal"]  = $p[0]["correosucursal"];
		$_SESSION["nomencargado"]    = $p[0]["nomencargado"];
		$_SESSION["descsucursal"]    = $p[0]["descsucursal"];
		$_SESSION["porcentaje"]      = $p[0]["porcentaje"];
		$_SESSION["documento"]       = $p[0]["documento"];
		$_SESSION["documento2"]      = $p[0]["documento2"];
		$_SESSION["simbolo"]         = $p[0]["simbolo"];
		$_SESSION["simbolo2"]        = $p[0]["simbolo2"];
		######### DATOS DE LA SUCURSAL ###########

		######### DATOS DE ACCESO ###########
		$query = "INSERT INTO log VALUES (null, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1,$a);
		$stmt->bindParam(2,$b);
		$stmt->bindParam(3,$c);
		$stmt->bindParam(4,$d);
		$stmt->bindParam(5,$e);
		$stmt->bindParam(6,$f);

		$a = limpiar($_SERVER['REMOTE_ADDR']);
		$b = limpiar(date("Y-m-d H:i:s"));
		$c = limpiar($_SERVER['HTTP_USER_AGENT']);
		$d = limpiar($_SERVER['PHP_SELF']);
		$e = limpiar($_POST["usuario"]);
		$f = limpiar($_SESSION["nivel"]== "administradorG" ? "0" : $_SESSION["codsucursal"]);
		$stmt->execute();
		######### DATOS DE ACCESO ###########

		$redirect = '/logout';
        switch($_SESSION["nivel"])
		{
			case 'ADMINISTRADOR(A) GENERAL':
			$_SESSION["acceso"] = 'administradorG';
			$redirect           = 'panel';
			break;
			case 'ADMINISTRADOR(A) SUCURSAL':
			$_SESSION["acceso"] = 'administradorS';
			$redirect           = 'panel';
			break;
			case 'SECRETARIA':
			$_SESSION["acceso"] = 'secretaria';
		    $redirect           = 'panel';
			break;
			case 'CAJERO(A)':
			$_SESSION["acceso"] = 'cajero';
			$redirect           = 'panel';
			break;
			case 'VENDEDOR(A)':
			$_SESSION["acceso"] = 'vendedor';
			$redirect           = 'panel';
			break;
		    }//end switch
            die($redirect);
		   
	    } else {

  	      echo "5";
  	      exit;
	    }
    } 
}
#################### FUNCION PARA ACCEDER AL SISTEMA ####################

############################ FUNCION DATOS SESSION ID #################################
public function SessionPorId()
{
	self::SetNames();
	$sql = "SELECT 
	usuarios.*, 
	sucursales.documsucursal,
	sucursales.cuitsucursal,
	sucursales.nomsucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.iniciofactura,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.descsucursal,
	sucursales.porcentaje,
	sucursales.estado,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	provincias.provincia,
	departamentos.departamento
	FROM usuarios LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	WHERE usuarios.codigo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_SESSION["codigo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################ FUNCION DATOS SESSION ID #################################

########################### CLASE LOGUEO ###############################

















######################## FUNCION RECUPERAR Y ACTUALIZAR PASSWORD #######################

########################### FUNCION PARA RECUPERAR CLAVE #############################
public function RecuperarPassword()
{
	self::SetNames();
	if(empty($_POST["email"]))
	{
		echo "1";
		exit;
	}
	################## DATOS DE CONFIGURACION #####################
	$sql = "SELECT * FROM configuracion";
	foreach ($this->dbh->query($sql) as $row)
	{
	   $this->p[] = $row;
	}
    $cuitsucursal = $row['cuit'];
    $nomsucursal = $row['nomsucursal'];
    $correosucursal = $row['correosucursal'];
    ################## DATOS DE CONFIGURACION #####################

	################# OBTENGO DATOS DEL USUARIO #################
	$sql = " SELECT * FROM usuarios WHERE email = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["email"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "2";
		exit;
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$pa[] = $row;
		}
		$id = $pa[0]["codigo"];
		$nombres = $pa[0]["nombres"];
		$email = $pa[0]["email"];
		$pass = strtoupper(generar_clave(10));
	}
	################# OBTENGO DATOS DEL USUARIO #################

	#################### VALIDACION DE ENVIO DE CORREO CON PHPMAILER ####################
    //Create a new PHPMailer instance
    $mail = new PHPMailer(TRUE);

    $mail->isSMTP();// Set mailer to use SMTP
	$mail->CharSet     = 'UTF-8';
	$mail->SMTPAuth    = true;// Enable SMTP authentication
	$mail->SMTPSecure  = PHPMailer::ENCRYPTION_STARTTLS;// Enable TLS encryption, `ssl` also accepted

	$mail->Host        = 'smtp.gmail.com';// Specify main and backup SMTP servers
	$mail->Port        = 587;// TCP port to connect to
	$mail->SMTPDebug   = 0;
	$mail->SMTPOptions = array(
	   'ssl' => array(
	      'verify_peer' => false,
	      'verify_peer_name' => false,
	      'allow_self_signed' => true
	   )
	);
	$mail->isHTML(true);// Set email format to HTML

	$mail->Username = 'elsaiya@gmail.com';// SMTP username
	$mail->Password = 'aszzhdhghvdqpugc';// SMTP password

	$mail->setFrom('elsaiya@gmail.com', $nomsucursal);//Your application NAME and EMAIL
	$mail->AddReplyTo('no-reply@mycomp.com','no-reply');
	$mail->Subject  = 'Nueva Clave de Acceso';//Message subject

	# establecemos un limite de caracteres de anchura
	$mail->WordWrap = 50; // set word wrap

	# NOTA: Los correos es conveniente enviarlos en formato HTML y Texto para que
	# cualquier programa de correo pueda leerlo.

	# Definimos el contenido HTML del correo
	$contenidoHTML="<head>";
	$contenidoHTML.="<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">";
	$contenidoHTML.="</head><body>";
	$contenidoHTML.="<b>Recuperación de Contraseña</b>";
	$contenidoHTML.="<p>$nombres</p>";
	$contenidoHTML.="<p>Su Nueva Contraseña de Acceso es: <b>$pass</b></p>";
	$contenidoHTML.="</body>\n";

	# Definimos el contenido en formato Texto del correo
	$contenidoTexto= " Recuperación de Contraseña";
	$contenidoTexto.="\n\n";
	
	# Indicamos el contenido
	$mail->AltBody=$contenidoTexto; //Text Body
	$mail->MsgHTML($contenidoHTML); //Text body HTML

	$mail->addAddress($email,str_replace(" ", "_",$nombres));// Target email
    $mail->AddAttachment("fotos/logo_principal.png", "img.png");

	if(!$mail->send()) {

	    //Mensaje no pudo ser enviado
	    echo "3";
		exit;

	} else {

		################# ACTUALIZO CLAVE DE USUARIO #################
		$sql = " UPDATE usuarios set "
		." password = ? "
		." WHERE "
		." codigo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $password);
		$stmt->bindParam(2, $codigo);

		$codigo = $id;
		$password = password_hash($pass, PASSWORD_DEFAULT);
		$stmt->execute();
		################# ACTUALIZO CLAVE DE USUARIO #################

	   echo "<span class='fa fa-check-square-o'></span> SU NUEVA CLAVE DE ACCESO LE FUE ENVIADA A SU CORREO ELECTRONICO EXITOSAMENTE";
	   exit;
    }
    #################### VALIDACION DE ENVIO DE CORREO CON PHPMAILER ####################
}	
############################# FUNCION PARA RECUPERAR CLAVE ############################

########################### FUNCION PARA ENVIAR FACTURA CORREO #############################
public function EnviarFacturaCorreo($codventa,$doc)
{
	self::SetNames();
	############################ OBTENGO DATOS DE VENTA ############################
    $sql = "SELECT
    ventas.codventa,
	ventas.tipodocumento,
	ventas.codfactura,
	ventas.codserie,
	ventas.codcliente,
	ventas.fechaventa,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.direcsucursal,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.emailcliente
    FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	WHERE ventas.codventa = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($codventa)));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $tipodocumento = $row['tipodocumento'];
    $codfactura    = $row['codfactura'];
    $codserie      = $row['codserie'];
    $codcliente    = $row['codcliente'];
    $fechaventa    = $row['fechaventa'];
    $cuitsucursal  = $row['cuitsucursal'];
    $nomsucursal   = $row['nomsucursal'];
    $dnicliente    = (empty($row['dnicliente']) ? "" : $row['dnicliente']);
    $nomcliente    = (empty($row['nomcliente']) ? "" : $row['nomcliente']);
    $emailcliente  = (empty($row['emailcliente']) ? "" : $row['emailcliente']);
    ############################ OBTENGO DATOS DE VENTA ############################

   if(!empty($codcliente) && !empty($emailcliente)){

	    //Create a new PHPMailer instance
	    $mail = new PHPMailer(TRUE);

	    $mail->isSMTP();// Set mailer to use SMTP
		$mail->CharSet = 'UTF-8';
		$mail->SMTPAuth = true;// Enable SMTP authentication
		$mail->SMTPSecure = PHPMailer::ENCRYPTION_STARTTLS;// Enable TLS encryption, `ssl` also accepted

		$mail->Host = 'smtp.gmail.com';// Specify main and backup SMTP servers
		$mail->Port = 587;// TCP port to connect to
		$mail->SMTPDebug = 0;
		$mail->SMTPOptions = array(
		   'ssl' => array(
		      'verify_peer' => false,
		      'verify_peer_name' => false,
		      'allow_self_signed' => true
		   )
		);
		$mail->isHTML(true);// Set email format to HTML

		$mail->Username = 'elsaiya@gmail.com';// SMTP username
		$mail->Password = 'aszzhdhghvdqpugc';// SMTP password

		$mail->setFrom('elsaiya@gmail.com', $nomsucursal);//Your application NAME and EMAIL
		$mail->AddReplyTo('no-reply@mycomp.com','no-reply');
		$mail->Subject = 'Documento de Compra';//Message subject

		# establecemos un limite de caracteres de anchura
		$mail->WordWrap   = 50; // set word wrap

		# NOTA: Los correos es conveniente enviarlos en formato HTML y Texto para que
		# cualquier programa de correo pueda leerlo.

		# Definimos el contenido HTML del correo
		$contenidoHTML="<head>";
		$contenidoHTML.="<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\">";
		$contenidoHTML.="</head><body>";
		$contenidoHTML.="<p>$nomcliente</p>";
		$contenidoHTML.="<p>USTED HA REALIZADO UNA COMPRA</p>";
		$contenidoHTML.="<p>Nº DE ".$tipodocumento.": <b>$codfactura</b></p>";
		$contenidoHTML.="<p>FECHA <b>".date("d/m/Y",strtotime($fechaventa))."</b></p>";
		$contenidoHTML.="<p>HORA <b>".date("H:i",strtotime($fechaventa))."</b></p>";
		$contenidoHTML.="</body>\n";

		# Definimos el contenido en formato Texto del correo
		$contenidoTexto= "";
		$contenidoTexto.="\n\n";
		
		# Indicamos el contenido
		$mail->AltBody=$contenidoTexto; //Text Body
		$mail->MsgHTML($contenidoHTML); //Text body HTML

		$mail->addAddress($emailcliente,str_replace(" ", "_",$nomcliente));// Target email
	    $mail->AddAttachment($doc, $tipodocumento."_".$codfactura.".pdf", "base64", "application/pdf");

		if(!$mail->Send()){

		    //Mensaje no pudo ser enviado
		    echo "";
			exit;
	    }
	}
}	
############################# FUNCION PARA ENVIAR FACTURA CORREO ############################

########################## FUNCION PARA ACTUALIZAR PASSWORD ############################
public function ActualizarPassword()
{
	self::SetNames();
	if(empty($_POST["codigo"]) or empty($_POST["clave"]) or empty($_POST["password"]) or empty($_POST["password2"]))
	{
		echo "1";
		exit;
	}
	elseif (password_verify($_POST["password"], $_SESSION['password']))
	{
		echo "2";
		exit;
	}
		
	$sql = " UPDATE usuarios set "
	." usuario = ?, "
	." password = ? "
	." WHERE "
	." codigo = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $usuario);
	$stmt->bindParam(2, $password);
	$stmt->bindParam(3, $codigo);	

	$usuario  = limpiar($_POST["usuario"]);
	$password = password_hash($_POST["password"], PASSWORD_DEFAULT);
	$codigo   = limpiar($_POST["codigo"]);
	$stmt->execute();
	
	echo "<span class='fa fa-check-square-o'></span> SU CLAVE DE ACCESO FUE ACTUALIZADA EXITOSAMENTE, SER&Aacute; EXPULSADO DE SU SESI&Oacute;N Y DEBER&Aacute; DE ACCEDER NUEVAMENTE";
	?>
	<script>
		function redireccionar(){location.href="logout.php";}
		setTimeout ("redireccionar()", 3000);
	</script>
	<?php
	exit;
}
########################## FUNCION PARA ACTUALIZAR PASSWORD  ############################

####################### FUNCION RECUPERAR Y ACTUALIZAR PASSWORD ########################


























########################## FUNCION CONFIGURACION DEL SISTEMA ########################

######################## FUNCION ID CONFIGURACION DEL SISTEMA ########################
public function ConfiguracionPorId()
{
	self::SetNames();
	$sql = " SELECT 
	configuracion.id,
	configuracion.documsucursal,
	configuracion.cuit,
	configuracion.nomsucursal,
	configuracion.tlfsucursal,
	configuracion.correosucursal,
	configuracion.id_provincia,
	configuracion.id_departamento,
	configuracion.direcsucursal,
	configuracion.documencargado,
	configuracion.dniencargado,
	configuracion.nomencargado,
	documentos.documento,
	documentos2.documento AS documento2,
	provincias.provincia,
	departamentos.departamento
	FROM configuracion 
	LEFT JOIN documentos ON configuracion.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON configuracion.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON configuracion.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON configuracion.id_departamento = departamentos.id_departamento 
	WHERE configuracion.id = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array('1'));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION ID CONFIGURACION DEL SISTEMA #########################

######################## FUNCION  ACTUALIZAR CONFIGURACION #########################
public function ActualizarConfiguracion()
{
	self::SetNames();
	if(empty($_POST["cuit"]) or empty($_POST["nomsucursal"]) or empty($_POST["tlfsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " UPDATE configuracion set "
	." documsucursal = ?, "
	." cuit = ?, "
	." nomsucursal = ?, "
	." tlfsucursal = ?, "
	." correosucursal = ?, "
	." id_provincia = ?, "
	." id_departamento = ?, "
	." direcsucursal = ?, "
	." documencargado = ?, "
	." dniencargado = ?, "
	." nomencargado = ? "
	." WHERE "
	." id = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $documsucursal);
	$stmt->bindParam(2, $cuit);
	$stmt->bindParam(3, $nomsucursal);
	$stmt->bindParam(4, $tlfsucursal);
	$stmt->bindParam(5, $correosucursal);
	$stmt->bindParam(6, $id_provincia);
	$stmt->bindParam(7, $id_departamento);
	$stmt->bindParam(8, $direcsucursal);
	$stmt->bindParam(9, $documencargado);
	$stmt->bindParam(10, $dniencargado);
	$stmt->bindParam(11, $nomencargado);
	$stmt->bindParam(12, $id);

	$documsucursal   = limpiar($_POST['documsucursal'] == '' ? "0" : $_POST['documsucursal']);
	$cuit            = limpiar($_POST["cuit"]);
	$nomsucursal     = limpiar($_POST["nomsucursal"]);
	$tlfsucursal     = limpiar($_POST["tlfsucursal"]);
	$correosucursal  = limpiar($_POST["correosucursal"]);
	$id_provincia    = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
	$id_departamento = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
	$direcsucursal   = limpiar($_POST["direcsucursal"]);
	$documencargado  = limpiar($_POST["documencargado"]);
	$dniencargado    = limpiar($_POST["dniencargado"]);
	$nomencargado    = limpiar($_POST["nomencargado"]);
	$id              = limpiar($_POST["id"]);
	$stmt->execute();

	############################## SUBIR LOGO PRINCIPAL #1 ##############################
    //datos del arhivo
    $nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
	$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
	$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
    //compruebo si las características del archivo son las que deseo  
	if (!empty($_FILES["imagen"]) && (strpos($tipo_archivo,'image/png')!==false)&&$tamano_archivo<8000000)//1MB
	{  
		if (move_uploaded_file($_FILES['imagen']['tmp_name'], "fotos/".$nombre_archivo) && rename("fotos/".$nombre_archivo,"fotos/logo_principal.png"))
		{ 
		## se puede dar un aviso
		} 
		## se puede dar otro aviso 
	}
	############################## SUBIR LOGO PRINCIPAL #1 ##############################

	############################## SUBIR LOGO PDF #1 ##############################
    //datos del arhivo
    $nombre_archivo2 = limpiar(isset($_FILES['imagen2']['name']) ? $_FILES['imagen2']['name'] : "");
	$tipo_archivo2   = limpiar(isset($_FILES['imagen2']['type']) ? $_FILES['imagen2']['type'] : "");
	$tamano_archivo2 = limpiar(isset($_FILES['imagen2']['size']) ? $_FILES['imagen2']['size'] : "");
    //compruebo si las características del archivo son las que deseo  
	if ((strpos($tipo_archivo2,'image/png')!==false)&&$tamano_archivo2<8000000)//1MB 
	{  
		if (move_uploaded_file($_FILES['imagen2']['tmp_name'], "fotos/".$nombre_archivo2) && rename("fotos/".$nombre_archivo2,"fotos/logo_pdf.png"))
		{ 
		## se puede dar un aviso
		} 
		## se puede dar otro aviso 
	}
	############################## SUBIR LOGO PDF #1 ##############################

	############################## SUBIR LOGO PDF #2 ##############################
    //datos del arhivo
    $nombre_archivo3 = limpiar(isset($_FILES['imagen3']['name']) ? $_FILES['imagen3']['name'] : "");
	$tipo_archivo3   = limpiar(isset($_FILES['imagen3']['type']) ? $_FILES['imagen3']['type'] : "");
	$tamano_archivo3 = limpiar(isset($_FILES['imagen3']['size']) ? $_FILES['imagen3']['size'] : "");
    //compruebo si las características del archivo son las que deseo  
	if ((strpos($tipo_archivo3,'image/png')!==false)&&$tamano_archivo3<8000000)//1MB 
	{  
		if (move_uploaded_file($_FILES['imagen3']['tmp_name'], "fotos/".$nombre_archivo3) && rename("fotos/".$nombre_archivo3,"fotos/logo_pdf2.png"))
		{ 
		## se puede dar un aviso
		} 
		## se puede dar otro aviso 
	}
	############################## SUBIR LOGO PDF #2 ##############################

	echo "<span class='fa fa-check-square-o'></span> LOS DATOS DE CONFIGURACI&Oacute;N FUERON ACTUALIZADOS EXITOSAMENTE";
	exit;
}
######################## FUNCION  ACTUALIZAR CONFIGURACION #########################

###################### FIN DE FUNCION CONFIGURACION DEL SISTEMA #######################


























################################## CLASE USUARIOS #####################################

############################## FUNCION REGISTRAR USUARIOS ##############################
public function RegistrarUsuarios()
{
	self::SetNames();
	if(empty($_POST["nombres"]) or empty($_POST["usuario"]) or empty($_POST["password"]))
	{
		echo "1";
		exit;
	}
	if($_POST["nivel"]=="ADMINISTRADOR(A) GENERAL" && decrypt($_POST["codsucursal"])!="0")
	{
		echo "2";
		exit;
	}
	elseif($_POST["nivel"]!="ADMINISTRADOR(A) GENERAL" && decrypt($_POST["codsucursal"])=="0")
	{
		echo "3";
		exit;
	}
	$sql = " SELECT dni FROM usuarios WHERE dni = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["dni"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "4";
		exit;
	}
	$sql = " SELECT email FROM usuarios WHERE email = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["email"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "5";
		exit;
	}
	$sql = " SELECT usuario FROM usuarios WHERE usuario = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["usuario"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
	    ############## OBTENGO DATOS DE SUCURSALES ASOCIADAS #################
		$rs = "SELECT gruposid FROM usuarios
		WHERE codsucursal = '".decrypt($_POST["codsucursal"])."' AND nivel = 'ADMINISTRADOR(A) SUCURSAL'";
		foreach ($this->dbh->query($rs) as $row) {
            $p[] = $row;
        }
		$valores = (empty($p[0]['gruposid']) ? "0" : $p[0]['gruposid']);
		############## OBTENGO DATOS DE SUCURSALES ASOCIADAS #################

		############## REGISTRO USUARIO #################
		$query = " INSERT INTO usuarios values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $dni);
		$stmt->bindParam(2, $nombres);
		$stmt->bindParam(3, $sexo);
		$stmt->bindParam(4, $direccion);
		$stmt->bindParam(5, $telefono);
		$stmt->bindParam(6, $email);
		$stmt->bindParam(7, $usuario);
		$stmt->bindParam(8, $password);
		$stmt->bindParam(9, $nivel);
		$stmt->bindParam(10, $status);
		$stmt->bindParam(11, $comision);
		$stmt->bindParam(12, $limite_descuento);
		$stmt->bindParam(13, $codsucursal);
		$stmt->bindParam(14, $gruposid);

		$dni              = limpiar($_POST["dni"]);
		$nombres          = limpiar($_POST["nombres"]);
		$sexo             = limpiar($_POST["sexo"]);
		$direccion        = limpiar($_POST["direccion"]);
		$telefono         = limpiar($_POST["telefono"]);
		$email            = limpiar($_POST["email"]);
		$usuario          = limpiar($_POST["usuario"]);
		$password         = password_hash($_POST["password"], PASSWORD_DEFAULT);
		$nivel            = limpiar($_POST["nivel"]);
		$status           = limpiar($_POST["status"]);
		$comision         = limpiar($_POST["comision"]);
		$limite_descuento = limpiar($_POST["limite_descuento"]);
		$codsucursal      = limpiar(decrypt($_POST["codsucursal"]));
		if($_SESSION['acceso'] == "administradorG"){
			if($_POST["nivel"] == "ADMINISTRADOR(A) SUCURSAL"){
				$gruposid = limpiar(empty($_POST['gruposid']) ? "0" : implode(", ",$_POST['gruposid']));
			} else {
				$gruposid = limpiar($valores);
			}
	    } else {
	    $gruposid         = limpiar($valores);
		}
		$stmt->execute();
		############## REGISTRO USUARIO #################

	    ########################## SUBIR FOTO DE USUARIOS ##########################
	    //datos del arhivo  
		$nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
	    //compruebo si las características del archivo son las que deseo  
		if (!empty($_FILES["imagen"]) && (strpos($tipo_archivo,'image/jpeg')!==false)&&$tamano_archivo<50000) 
		{  
			if (move_uploaded_file($_FILES['imagen']['tmp_name'], "fotos/".$nombre_archivo) && rename("fotos/".$nombre_archivo,"fotos/".$_POST["dni"].".jpg"))
			{ 
	        ## se puede dar un aviso
			} 
	        ## se puede dar otro aviso 
		}
	    ########################## SUBIR FOTO DE USUARIOS ##########################

		echo "<span class='fa fa-check-square-o'></span> EL USUARIO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;
    }
	else
	{
	   echo "6";
		exit;	
	}
}
############################# FUNCION REGISTRAR USUARIOS ###############################

############################# FUNCION LISTAR USUARIOS ################################
public function ListarUsuarios()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		usuarios.*,
		sucursales.cuitsucursal,
		sucursales.nomsucursal
		FROM usuarios LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal
		ORDER BY usuarios.codigo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT 
		usuarios.*,
		sucursales.cuitsucursal,
		sucursales.nomsucursal
		FROM usuarios LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal
		WHERE usuarios.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		ORDER BY usuarios.codigo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################## FUNCION LISTAR USUARIOS ################################

########################## FUNCION BUSQUEDA DE LOGS DE USUARIOS ###############################
public function BusquedaLogs()
{
	self::SetNames();
	
	$buscar = limpiar($_POST['b']);

	if(empty($buscar)) {
      echo "";
      exit;
    }

    if ($_SESSION['acceso'] == "administradorG") {

	    $sql = "SELECT * FROM log LEFT JOIN sucursales ON log.codsucursal = sucursales.codsucursal 
	    WHERE CONCAT(log.ip, '',log.tiempo, '',log.detalles, '',log.usuario) LIKE '%".$buscar."%' 
	    ORDER BY log.tiempo ASC LIMIT 0,60";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<center><div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<span class='fa fa-info-circle'></span> NO SE ENCONTRARON REGISTROS PARA TU BUSQUEDA</div></center>";
			exit;
			
		} else {
				
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}

    } else {

		$sql = "SELECT * FROM log LEFT JOIN sucursales ON log.codsucursal = sucursales.codsucursal 
		WHERE CONCAT(log.ip, '',log.tiempo, '',log.detalles, '',log.usuario) LIKE '%".$buscar."%' 
		AND log.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		ORDER BY log.tiempo ASCLIMIT 0,60";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0) {

			echo "<center><div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<span class='fa fa-info-circle'></span> NO SE ENCONTRARON REGISTROS PARA TU BUSQUEDA</div></center>";
			exit;
			
		} else {
				
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}
    }
}
########################## FUNCION BUSQUEDA DE LOGS DE USUARIOS ###############################

########################### FUNCION LISTAR LOGS DE USUARIOS ###########################
public function ListarLogs()
{
	self::SetNames();
	$sql = "SELECT * FROM log";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION LISTAR LOGS DE USUARIOS ###########################

############################ FUNCION ID USUARIOS #################################
public function UsuariosPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM usuarios  
	LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal 
	WHERE usuarios.codigo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codigo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID USUARIOS #################################

############################ FUNCION ACTUALIZAR USUARIOS ############################
public function ActualizarUsuarios()
{
	self::SetNames();
	if(empty($_POST["dni"]) or empty($_POST["nombres"]) or empty($_POST["usuario"]) or empty($_POST["password"]))
	{
		echo "1";
		exit;
	}
	if($_POST["nivel"]=="ADMINISTRADOR(A) GENERAL" && decrypt($_POST["codsucursal"])!="0")
	{
		echo "2";
		exit;
	}
	elseif($_POST["nivel"]!="ADMINISTRADOR(A) GENERAL" && decrypt($_POST["codsucursal"])=="0")
	{
		echo "3";
		exit;
	}
	$sql = "SELECT * FROM usuarios WHERE codigo != ? AND dni = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codigo"],$_POST["dni"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "4";
		exit;
	}
	$sql = " SELECT email FROM usuarios WHERE codigo != ? AND email = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codigo"],$_POST["email"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "5";
		exit;
	}
	$sql = " SELECT usuario FROM usuarios WHERE codigo != ? AND usuario = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codigo"],$_POST["usuario"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		############## OBTENGO DATOS DE SUCURSALES ASOCIADAS #################
		$rs = "SELECT gruposid FROM usuarios
		WHERE codsucursal = '".decrypt($_POST["codsucursal"])."' AND nivel = 'ADMINISTRADOR(A) SUCURSAL'";
		foreach ($this->dbh->query($rs) as $row) {
            $p[] = $row;
        }
		$valores = (empty($p[0]['gruposid']) ? "0" : $p[0]['gruposid']);
		############## OBTENGO DATOS DE SUCURSALES ASOCIADAS #################

		############## ACTUALIZO USUARIO #################
		$sql = " UPDATE usuarios set "
		." dni = ?, "
		." nombres = ?, "
		." sexo = ?, "
		." direccion = ?, "
		." telefono = ?, "
		." email = ?, "
		." usuario = ?, "
		." password = ?, "
		." nivel = ?, "
		." status = ?, "
		." comision = ?, "
		." limite_descuento = ?, "
		." codsucursal = ?, "
		." gruposid = ? "
		." WHERE "
		." codigo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $dni);
		$stmt->bindParam(2, $nombres);
		$stmt->bindParam(3, $sexo);
		$stmt->bindParam(4, $direccion);
		$stmt->bindParam(5, $telefono);
		$stmt->bindParam(6, $email);
		$stmt->bindParam(7, $usuario);
		$stmt->bindParam(8, $password);
		$stmt->bindParam(9, $nivel);
		$stmt->bindParam(10, $status);
		$stmt->bindParam(11, $comision);
		$stmt->bindParam(12, $limite_descuento);
		$stmt->bindParam(13, $codsucursal);
		$stmt->bindParam(14, $gruposid);
		$stmt->bindParam(15, $codigo);

		$dni              = limpiar($_POST["dni"]);
		$nombres          = limpiar($_POST["nombres"]);
		$sexo             = limpiar($_POST["sexo"]);
		$direccion        = limpiar($_POST["direccion"]);
		$telefono         = limpiar($_POST["telefono"]);
		$email            = limpiar($_POST["email"]);
		$usuario          = limpiar($_POST["usuario"]);
		$password         = password_hash($_POST["password"], PASSWORD_DEFAULT);
		$nivel            = limpiar($_POST["nivel"]);
		$status           = limpiar($_POST["status"]);
		$comision         = limpiar($_POST["comision"]);
		$limite_descuento = limpiar($_POST["limite_descuento"]);
		$codsucursal      = limpiar(decrypt($_POST["codsucursal"]));
		if($_SESSION['acceso'] == "administradorG"){
			if($_POST["nivel"] == "ADMINISTRADOR(A) SUCURSAL"){
				$gruposid = limpiar(empty($_POST['gruposid']) ? "0" : implode(", ",$_POST['gruposid']));
			} else {
				$gruposid = limpiar($valores);
			}
	    } else {
	    $gruposid         = limpiar($valores);
		}
		$codigo           = limpiar($_POST["codigo"]);
		$stmt->execute();
		############## ACTUALIZO USUARIO #################

		########################## SUBIR FOTO DE USUARIOS ##########################
	    //datos del arhivo  
		$nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
	    //compruebo si las características del archivo son las que deseo  
		if (!empty($_FILES["imagen"]) && (strpos($tipo_archivo,'image/jpeg')!==false)&&$tamano_archivo<50000) 
		{  
			if (move_uploaded_file($_FILES['imagen']['tmp_name'], "fotos/".$nombre_archivo) && rename("fotos/".$nombre_archivo,"fotos/".$_POST["dni"].".jpg"))
			{ 
	        ## se puede dar un aviso
			} 
	        ## se puede dar otro aviso 
		}
	    ########################## SUBIR FOTO DE USUARIOS ##########################

		echo "<span class='fa fa-check-square-o'></span> EL USUARIO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;
	}
	else
	{
		echo "6";
		exit;
	}
}
############################ FUNCION ACTUALIZAR USUARIOS ############################

############################# FUNCION CAMBIAR STATUS USUARIOS ################################
public function EstadoUsuarios()
{
	self::SetNames();
	###################### ACTUALIZO STATUS DE USUARIO ######################
	$sql = "UPDATE usuarios set "
	." status = ? "
	." WHERE "
	." codigo = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $status);
	$stmt->bindParam(2, $codigo);

	$status = limpiar(decrypt($_GET['status']) == 1 ? 0 : 1);
	$codigo = limpiar(decrypt($_GET["codigo"]));
	$stmt->execute();
	###################### ACTUALIZO STATUS DE USUARIO ######################

	echo "1";
	exit;	
}
############################## FUNCION CAMBIAR STATUS USUARIOS ##############################

############################# FUNCION ELIMINAR USUARIOS ################################
public function EliminarUsuarios()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codigo FROM ventas WHERE codigo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codigo"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " DELETE FROM usuarios WHERE codigo = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codigo);
		$codigo = decrypt($_GET["codigo"]);
		$stmt->execute();

		$dni = decrypt($_GET["dni"]);
		if (file_exists("fotos/".$dni.".jpg")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/".$dni.".jpg";		
		unlink($archivos);
		}

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
############################## FUNCION ELIMINAR USUARIOS ##############################

######################## FUNCION BUSCAR USUARIOS POR SUCURSAL ##########################
public function BuscarUsuariosxSucursal() 
{
	self::SetNames();
	$sql = " SELECT * FROM usuarios 
	INNER JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal 
	WHERE usuarios.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<option value=''> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	    while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION BUSCAR USUARIOS POR SUCURSAL ##########################

################### FUNCION SELECCIONA USUARIO POR CODIGO Y SUCURSAL ###################
public function BuscarUsuariosxCodigo() 
{
	self::SetNames();
	$sql = " SELECT * FROM usuarios WHERE codigo = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codigo"],decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<option value=''> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
		while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION SELECCIONA USUARIO POR CODIGO Y SUCURSAL ##################

############################ FIN DE CLASE USUARIOS ################################


























################################ CLASE PROVINCIAS ##################################

########################## FUNCION REGISTRAR PROVINCIAS ###############################
public function RegistrarProvincias()
{
	self::SetNames();
	if(empty($_POST["provincia"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT provincia FROM provincias WHERE provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["provincia"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO provincias values (null, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $provincia);

		$provincia = limpiar($_POST["provincia"]);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA PROVINCIA HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
############################ FUNCION REGISTRAR PROVINCIAS ############################

############################ FUNCION LISTAR PROVINCIAS ################################
public function ListarProvincias()
{
	self::SetNames();
	$sql = "SELECT * FROM provincias";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION LISTAR PROVINCIAS ################################

########################### FUNCION ID PROVINCIAS #################################
public function ProvinciasPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM provincias WHERE id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["id_provincia"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PROVINCIAS #################################

############################ FUNCION ACTUALIZAR PROVINCIAS ############################
public function ActualizarProvincias()
{
	self::SetNames();
	if(empty($_POST["id_provincia"]) or empty($_POST["provincia"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT provincia FROM provincias WHERE id_provincia != ? AND provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["id_provincia"],$_POST["provincia"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE provincias set "
		." provincia = ? "
		." WHERE "
		." id_provincia = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $provincia);
		$stmt->bindParam(2, $id_provincia);

		$provincia = limpiar($_POST["provincia"]);
		$id_provincia = limpiar($_POST['id_provincia']);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA PROVINCIA HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR PROVINCIAS ############################

############################ FUNCION ELIMINAR PROVINCIAS ############################
public function EliminarProvincias()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT id_provincia FROM departamentos WHERE id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["id_provincia"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{

		$sql = "DELETE FROM provincias WHERE id_provincia = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$id_provincia);
		$id_provincia = decrypt($_GET["id_provincia"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
############################ FUNCION ELIMINAR PROVINCIAS ##############################

############################## FIN DE CLASE PROVINCIAS ################################


























############################### CLASE DEPARTAMENTOS ################################

############################# FUNCION REGISTRAR DEPARTAMENTOS ###########################
public function RegistrarDepartamentos()
{
	self::SetNames();
	if(empty($_POST["departamento"]) or empty($_POST["id_provincia"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT departamento FROM departamentos WHERE departamento = ? AND id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["departamento"],$_POST["id_provincia"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO departamentos values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $departamento);
		$stmt->bindParam(2, $id_provincia);

		$departamento = limpiar($_POST["departamento"]);
		$id_provincia = limpiar($_POST['id_provincia']);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL DEPARTAMENTO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################### FUNCION REGISTRAR DEPARTAMENTOS ########################

########################## FUNCION PARA LISTAR DEPARTAMENTOS ##########################
public function ListarDepartamentos()
{
	self::SetNames();
	$sql = "SELECT * FROM departamentos LEFT JOIN provincias ON departamentos.id_provincia = provincias.id_provincia";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION PARA LISTAR DEPARTAMENTOS ##########################

########################## FUNCION PARA LISTAR DEPARTAMENTOS DE PROVINCIA ##########################
public function ListarDepartamentosAsignados($id_provincia)
{
	self::SetNames();
	$sql = "SELECT * FROM departamentos LEFT JOIN provincias ON departamentos.id_provincia = provincias.id_provincia
	WHERE departamentos.id_provincia = '".limpiar($id_provincia)."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION PARA LISTAR DEPARTAMENTOS DE PROVINCIA ##########################

###################### FUNCION LISTAR DEPARTAMENTOS POR PROVINCIAS #####################
public function ListarDepartamentoXProvincias() 
{
	self::SetNames();
	$sql = "SELECT * FROM departamentos WHERE id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["id_provincia"]));
	$num = $stmt->rowCount();
	    if($num==0)
	{
		echo "<option value='0' selected> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
##################### FUNCION LISTAR DEPARTAMENTOS POR PROVINCIAS ######################

################# FUNCION PARA SELECCIONAR DEPARTAMENTOS POR PROVINCIA #################
public function SeleccionaDepartamento()
{
	self::SetNames();
	$sql = "SELECT * FROM departamentos WHERE id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["id_provincia"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<option value=''> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
		while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################# FUNCION PARA SELECCIONAR DEPARTAMENTOS POR PROVINCIA ################

############################ FUNCION ID DEPARTAMENTOS #################################
public function DepartamentosPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM departamentos LEFT JOIN provincias ON departamentos.id_provincia = provincias.id_provincia WHERE departamentos.id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["id_provincia"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID DEPARTAMENTOS #################################

######################## FUNCION ACTUALIZAR DEPARTAMENTOS ############################
public function ActualizarDepartamentos()
{
	self::SetNames();
	if(empty($_POST["id_departamento"]) or empty($_POST["departamento"]) or empty($_POST["id_provincia"]))
	{
		echo "1";
		exit;
	}

	$sql = "SELECT departamento FROM departamentos WHERE id_departamento != ? AND departamento = ? AND id_provincia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["id_departamento"],$_POST["departamento"],$_POST["id_provincia"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE departamentos set "
		." departamento = ?, "
		." id_provincia = ? "
		." WHERE "
		." id_departamento = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $departamento);
		$stmt->bindParam(2, $id_provincia);
		$stmt->bindParam(3, $id_departamento);

		$departamento    = limpiar($_POST["departamento"]);
		$id_provincia    = limpiar($_POST['id_provincia']);
		$id_departamento = limpiar($_POST['id_departamento']);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL DEPARTAMENTO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR DEPARTAMENTOS #######################

############################ FUNCION ELIMINAR DEPARTAMENTOS ###########################
public function EliminarDepartamentos()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT id_departamento FROM configuracion WHERE id_departamento = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["id_departamento"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM departamentos WHERE id_departamento = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$id_departamento);
		$id_departamento = decrypt($_GET["id_departamento"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR DEPARTAMENTOS ############################

############################## FIN DE CLASE DEPARTAMENTOS ##############################


























################################ CLASE TIPOS DE DOCUMENTOS ##############################

########################### FUNCION REGISTRAR TIPO DE DOCUMENTOS ########################
public function RegistrarDocumentos()
{
	self::SetNames();
	if(empty($_POST["documento"]) or empty($_POST["descripcion"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT * FROM documentos WHERE documento = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["documento"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO documentos values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $documento);
		$stmt->bindParam(2, $descripcion);

		$documento   = limpiar($_POST["documento"]);
		$descripcion = limpiar($_POST["descripcion"]);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE DOCUMENTO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION REGISTRAR TIPO DE MONEDA ########################

########################## FUNCION LISTAR TIPO DE MONEDA ################################
public function ListarDocumentos()
{
	self::SetNames();
	$sql = "SELECT * FROM documentos ORDER BY documento ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION LISTAR TIPO DE DOCUMENTOS ##########################

######################### FUNCION ID TIPO DE DOCUMENTOS ###############################
public function DocumentoPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM documentos WHERE coddocumento = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["coddocumento"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION ID TIPO DE DOCUMENTOS #########################

######################### FUNCION ACTUALIZAR TIPO DE DOCUMENTOS ########################
public function ActualizarDocumentos()
{
	self::SetNames();
	if(empty($_POST["coddocumento"]) or empty($_POST["documento"]) or empty($_POST["descripcion"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT documento FROM documentos WHERE coddocumento != ? AND documento = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["coddocumento"],$_POST["documento"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE documentos set "
		." documento = ?, "
		." descripcion = ? "
		." WHERE "
		." coddocumento = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $documento);
		$stmt->bindParam(2, $descripcion);
		$stmt->bindParam(3, $coddocumento);

		$documento    = limpiar($_POST["documento"]);
		$descripcion  = limpiar($_POST["descripcion"]);
		$coddocumento = limpiar($_POST["coddocumento"]);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE DOCUMENTO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
####################### FUNCION ACTUALIZAR TIPO DE DOCUMENTOS #######################

######################### FUNCION ELIMINAR TIPO DE DOCUMENTOS #########################
public function EliminarDocumentos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT documsucursal FROM sucursales WHERE documsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["coddocumento"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM documentos WHERE coddocumento = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddocumento);
		$coddocumento = decrypt($_GET["coddocumento"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
######################## FUNCION ELIMINAR TIPOS DE DOCUMENTOS ###########################

########################### FIN DE CLASE TIPOS DE DOCUMENTOS ###########################



























############################### CLASE TIPOS DE MONEDAS ##############################

############################ FUNCION REGISTRAR TIPO DE MONEDA ##########################
public function RegistrarTipoMoneda()
{
	self::SetNames();
	if(empty($_POST["moneda"]) or empty($_POST["siglas"]) or empty($_POST["simbolo"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT * FROM tiposmoneda WHERE moneda = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["moneda"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO tiposmoneda values (null, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $moneda);
		$stmt->bindParam(2, $siglas);
		$stmt->bindParam(3, $simbolo);

		$moneda  = limpiar($_POST["moneda"]);
		$siglas  = limpiar($_POST["siglas"]);
		$simbolo = limpiar($_POST["simbolo"]);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE MONEDA HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
######################### FUNCION REGISTRAR TIPO DE MONEDA #######################

########################## FUNCION LISTAR TIPO DE MONEDA ################################
public function ListarTipoMoneda()
{
	self::SetNames();
	$sql = "SELECT * FROM tiposmoneda";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION LISTAR TIPO DE MONEDA #########################

############################ FUNCION ID TIPO DE MONEDA #################################
public function TipoMonedaPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM tiposmoneda WHERE codmoneda = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmoneda"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID TIPO DE MONEDA #################################

####################### FUNCION ACTUALIZAR TIPO DE MONEDA ###########################
public function ActualizarTipoMoneda()
{
	self::SetNames();
	if(empty($_POST["codmoneda"]) or empty($_POST["moneda"]) or empty($_POST["siglas"]) or empty($_POST["simbolo"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT moneda FROM tiposmoneda WHERE codmoneda != ? AND moneda = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codmoneda"],$_POST["moneda"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE tiposmoneda set "
		." moneda = ?, "
		." siglas = ?, "
		." simbolo = ? "
		." WHERE "
		." codmoneda = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $moneda);
		$stmt->bindParam(2, $siglas);
		$stmt->bindParam(3, $simbolo);
		$stmt->bindParam(4, $codmoneda);

		$moneda    = limpiar($_POST["moneda"]);
		$siglas    = limpiar($_POST["siglas"]);
		$simbolo   = limpiar($_POST["simbolo"]);
		$codmoneda = limpiar($_POST["codmoneda"]);
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE MONEDA HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
######################## FUNCION ACTUALIZAR TIPO DE MONEDA ############################

######################### FUNCION ELIMINAR TIPO DE MONEDA ###########################
public function EliminarTipoMoneda()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codmoneda FROM tiposcambio WHERE codmoneda = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmoneda"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM tiposmoneda WHERE codmoneda = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codmoneda);
		$codmoneda = decrypt($_GET["codmoneda"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR TIPOS DE MONEDAS ########################

##################### FUNCION BUSCAR TIPOS DE CAMBIOS POR MONEDA #######################
public function BuscarTiposCambios()
{
	self::SetNames();
	$sql = "SELECT * FROM tiposmoneda 
	INNER JOIN tiposcambio ON tiposmoneda.codmoneda = tiposcambio.codmoneda 
	WHERE tiposcambio.codmoneda = ? 
	ORDER BY tiposcambio.codcambio 
	DESC LIMIT 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmoneda"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<center><div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<span class='fa fa-info-circle'></span> NO SE ENCONTRARON TIPOS DE CAMBIO PARA LA MONEDA SELECCIONADA</div></center>";
		exit;
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
##################### FUNCION BUSCAR TIPOS DE CAMBIOS POR MONEDA #####################

############################# FIN DE CLASE TIPOS DE MONEDAS #############################

















############################## CLASE TIPOS DE CAMBIOS ################################

########################## FUNCION REGISTRAR TIPO DE CAMBIO #########################
public function RegistrarTipoCambio()
{
	self::SetNames();
	if(empty($_POST["descripcioncambio"]) or empty($_POST["montocambio"]) or empty($_POST["codmoneda"]) or empty($_POST["fechacambio"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
			
	$sql = "SELECT codmoneda, fechacambio 
	FROM tiposcambio WHERE codmoneda = ? AND fechacambio = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codmoneda"],date("Y-m-d",strtotime($_POST['fechacambio'])),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = "INSERT INTO tiposcambio values (null, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $descripcioncambio);
		$stmt->bindParam(2, $montocambio);
		$stmt->bindParam(3, $codmoneda);
		$stmt->bindParam(4, $fechacambio);
		$stmt->bindParam(5, $codsucursal);

		$descripcioncambio = limpiar($_POST["descripcioncambio"]);
		$montocambio       = number_format($_POST["montocambio"], 3, '.', '');
		$codmoneda         = limpiar(decrypt($_POST["codmoneda"]));
		$fechacambio       = limpiar(date("Y-m-d",strtotime($_POST['fechacambio'])));
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE CAMBIO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
######################### FUNCION REGISTRAR TIPO DE CAMBIO ########################

########################### FUNCION LISTAR TIPO DE CAMBIO ########################
public function ListarTipoCambio()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		tiposcambio.codcambio,
		tiposcambio.descripcioncambio,
		tiposcambio.montocambio,
		tiposcambio.codmoneda,
		tiposcambio.fechacambio,
		tiposcambio.codsucursal,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM tiposcambio INNER JOIN tiposmoneda ON tiposcambio.codmoneda = tiposmoneda.codmoneda
	    LEFT JOIN sucursales ON tiposcambio.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (tiposcambio.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR tiposcambio.codsucursal = '0')
		ORDER BY tiposcambio.fechacambio ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		tiposcambio.codcambio,
		tiposcambio.descripcioncambio,
		tiposcambio.montocambio,
		tiposcambio.codmoneda,
		tiposcambio.fechacambio,
		tiposcambio.codsucursal,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM tiposcambio INNER JOIN tiposmoneda ON tiposcambio.codmoneda = tiposmoneda.codmoneda
	    LEFT JOIN sucursales ON tiposcambio.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (tiposcambio.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR tiposcambio.codsucursal = '0')
		ORDER BY tiposcambio.fechacambio ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION LISTAR TIPO DE CAMBIO ################################

######################## FUNCION ID TIPO DE CAMBIO #################################
public function TipoCambioPorId()
{
	self::SetNames();
	$sql = "SELECT
	tiposcambio.codcambio,
	tiposcambio.descripcioncambio,
	tiposcambio.montocambio,
	tiposcambio.codmoneda,
	tiposcambio.fechacambio,
	tiposcambio.codsucursal,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos.documento
    FROM tiposcambio INNER JOIN tiposmoneda ON tiposcambio.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN sucursales ON tiposcambio.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	WHERE tiposcambio.codcambio = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcambio"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID TIPO DE CAMBIO #################################

####################### FUNCION ACTUALIZAR TIPO DE CAMBIO ############################
public function ActualizarTipoCambio()
{
	self::SetNames();
	if(empty($_POST["codcambio"])or empty($_POST["descripcioncambio"]) or empty($_POST["montocambio"]) or empty($_POST["codmoneda"]) or empty($_POST["fechacambio"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
			
	$sql = "SELECT codmoneda, fechacambio 
	FROM tiposcambio WHERE codcambio != ? AND codmoneda = ? AND fechacambio = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcambio"]),$_POST["codmoneda"],date("Y-m-d",strtotime($_POST['fechacambio'])),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE tiposcambio set "
		." descripcioncambio = ?, "
		." montocambio = ?, "
		." codmoneda = ?, "
		." fechacambio = ?, "
		." codsucursal = ? "
		." WHERE "
		." codcambio = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $descripcioncambio);
		$stmt->bindParam(2, $montocambio);
		$stmt->bindParam(3, $codmoneda);
		$stmt->bindParam(4, $fechacambio);
		$stmt->bindParam(5, $codsucursal);
		$stmt->bindParam(6, $codcambio);

		$descripcioncambio = limpiar($_POST["descripcioncambio"]);
		$montocambio       = number_format($_POST["montocambio"], 3, '.', '');
		$codmoneda         = limpiar(decrypt($_POST["codmoneda"]));
		$fechacambio       = limpiar(date("Y-m-d",strtotime($_POST['fechacambio'])));
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$codcambio         = limpiar(decrypt($_POST["codcambio"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL TIPO DE CAMBIO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
###################### FUNCION ACTUALIZAR TIPO DE CAMBIO ############################

########################## FUNCION ELIMINAR TIPO DE CAMBIO ###########################
public function EliminarTipoCambio()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	    $sql = "DELETE FROM tiposcambio WHERE codcambio = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcambio);
		$codcambio = decrypt($_GET["codcambio"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
	   
		echo "2";
		exit;
	} 
}
########################### FUNCION ELIMINAR TIPO DE CAMBIO ###########################

######################## FUNCION BUSCAR PRODUCTOS POR MONEDA ###########################
public function MonedaProductoId()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		tiposcambio.montocambio 
		FROM sucursales 
		INNER JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		INNER JOIN tiposcambio ON tiposmoneda2.codmoneda = tiposcambio.codmoneda 
		WHERE sucursales.codsucursal = ? 
		ORDER BY tiposcambio.codcambio 
		DESC LIMIT 1";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "";
		}
		else
		{
			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;
		}

	} else {

		$sql = "SELECT 
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		tiposcambio.montocambio 
		FROM sucursales 
		INNER JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		INNER JOIN tiposcambio ON tiposmoneda2.codmoneda = tiposcambio.codmoneda 
		WHERE sucursales.codsucursal = ? 
		ORDER BY tiposcambio.codcambio 
		DESC LIMIT 1";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($_SESSION["codsucursal"]));
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "";
		}
		else
		{
			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;
		}
	}
}
###################### FUNCION BUSCAR PRODUCTOS POR MONEDA ##########################

############################ FIN DE CLASE TIPOS DE CAMBIOS #############################




















################################# CLASE MEDIOS DE PAGOS ################################

########################### FUNCION REGISTRAR MEDIOS DE PAGOS ###########################
public function RegistrarMediosPagos()
{
	self::SetNames();
	if(empty($_POST["mediopago"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT mediopago FROM mediospagos WHERE mediopago = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["mediopago"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO mediospagos values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $mediopago);
		$stmt->bindParam(2, $codsucursal);

		$mediopago   = limpiar($_POST["mediopago"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL MEDIO DE PAGO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
############################ FUNCION REGISTRAR MEDIOS DE PAGOS ##########################

########################## FUNCION LISTAR MEDIOS DE PAGOS ##########################
public function ListarMediosPagos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		mediospagos.codmediopago,
		mediospagos.mediopago,
		mediospagos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM mediospagos LEFT JOIN sucursales ON mediospagos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (mediospagos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR mediospagos.codsucursal = '0')
		ORDER BY mediospagos.mediopago ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		mediospagos.codmediopago,
		mediospagos.mediopago,
		mediospagos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM mediospagos LEFT JOIN sucursales ON mediospagos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (mediospagos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR mediospagos.codsucursal = '0')
		ORDER BY mediospagos.mediopago ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR MEDIOS DE PAGOS ##########################

############################ FUNCION ID MEDIOS DE PAGOS #################################
public function MediosPagosPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM mediospagos WHERE codmediopago = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmediopago"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID MEDIOS DE PAGOS #################################

##################### FUNCION ACTUALIZAR MEDIOS DE PAGOS ############################
public function ActualizarMediosPagos()
{
	self::SetNames();
	if(empty($_POST["codmediopago"]) or empty($_POST["mediopago"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT mediopago FROM mediospagos WHERE codmediopago != ? AND mediopago = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codmediopago"]),$_POST["mediopago"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE mediospagos set "
		." mediopago = ?, "
		." codsucursal = ? "
		." WHERE "
		." codmediopago = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $mediopago);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codmediopago);

		$mediopago    = limpiar($_POST["mediopago"]);
		$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
		$codmediopago = limpiar(decrypt($_POST["codmediopago"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL MEDIO DE PAGO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

		} else {

		echo "2";
		exit;
	}
}
##################### FUNCION ACTUALIZAR MEDIOS DE PAGOS ############################

########################## FUNCION ELIMINAR MEDIOS DE PAGOS #########################
public function EliminarMediosPagos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codmediopago FROM mediospagoxventas WHERE codmediopago = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmediopago"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM mediospagos WHERE codmediopago = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codmediopago);
		$codmediopago = decrypt($_GET["codmediopago"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR MEDIOS DE PAGOS ###########################

############################ FIN DE CLASE MEDIOS DE PAGOS ##############################



















############################### CLASE IMPUESTOS ####################################

############################ FUNCION REGISTRAR IMPUESTOS ###############################
public function RegistrarImpuestos()
{
	self::SetNames();
	if(empty($_POST["nomimpuesto"]) or empty($_POST["valorimpuesto"]) or empty($_POST["statusimpuesto"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT statusimpuesto FROM impuestos WHERE nomimpuesto != ? AND statusimpuesto = ? AND codsucursal = ? AND statusimpuesto = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomimpuesto"],$_POST["statusimpuesto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num>0)
	{
		echo "2";
		exit;
	}
	$sql = " SELECT nomimpuesto FROM impuestos WHERE nomimpuesto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomimpuesto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO impuestos values (null, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nomimpuesto);
		$stmt->bindParam(2, $valorimpuesto);
		$stmt->bindParam(3, $posicionimpuesto);
		$stmt->bindParam(4, $statusimpuesto);
		$stmt->bindParam(5, $fechaimpuesto);
		$stmt->bindParam(6, $codsucursal);

		$nomimpuesto      = limpiar($_POST["nomimpuesto"]);
		$valorimpuesto    = limpiar($_POST["valorimpuesto"]);
		$posicionimpuesto = limpiar("0");
		$statusimpuesto   = limpiar($_POST["statusimpuesto"]);
		$fechaimpuesto    = limpiar(date("Y-m-d",strtotime($_POST['fechaimpuesto'])));
		$codsucursal      = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL IMPUESTO HA SIDO REGISTRADO  EXITOSAMENTE";
		exit;

	} else {

		echo "3";
		exit;
	}
}
############################ FUNCION REGISTRAR IMPUESTOS ###############################

############################# FUNCION LISTAR IMPUESTOS ################################
public function ListarImpuestos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		impuestos.statusimpuesto,
		impuestos.fechaimpuesto,
		impuestos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM impuestos LEFT JOIN sucursales ON impuestos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (impuestos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR impuestos.codsucursal = '0')
		ORDER BY impuestos.nomimpuesto ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		impuestos.statusimpuesto,
		impuestos.fechaimpuesto,
		impuestos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM impuestos LEFT JOIN sucursales ON impuestos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (impuestos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR impuestos.codsucursal = '0')
		ORDER BY impuestos.nomimpuesto ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################# FUNCION LISTAR IMPUESTOS ################################

############################# FUNCION LISTAR IMPUESTOS ACTIVOS ################################
public function ListarImpuestosActivos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		impuestos.statusimpuesto,
		impuestos.fechaimpuesto,
		impuestos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM impuestos LEFT JOIN sucursales ON impuestos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE impuestos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND statusimpuesto = 1
		ORDER BY impuestos.nomimpuesto ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		impuestos.statusimpuesto,
		impuestos.fechaimpuesto,
		impuestos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM impuestos LEFT JOIN sucursales ON impuestos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE impuestos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND statusimpuesto = 1
		ORDER BY impuestos.nomimpuesto ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################# FUNCION LISTAR IMPUESTOS ACTIVOS ################################

############################ FUNCION ID IMPUESTOS #################################
public function ImpuestosPorId()
{
	self::SetNames();
	if (empty($_SESSION['acceso']) && $_SESSION['acceso'] == "administradorG" && isset($_GET["codsucursal"])) {

	    $codsucursal = (empty($_GET["codsucursal"]) ? "0" : decrypt($_GET["codsucursal"]));

		$sql = "SELECT * FROM impuestos WHERE codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND statusimpuesto = 1";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT * FROM impuestos WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND statusimpuesto = 1";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################ FUNCION ID IMPUESTOS #################################

############################ FUNCION ACTUALIZAR IMPUESTOS ############################
public function ActualizarImpuestos()
{
	self::SetNames();
	if(empty($_POST["codimpuesto"]) or empty($_POST["nomimpuesto"]) or empty($_POST["valorimpuesto"]) or empty($_POST["statusimpuesto"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT statusimpuesto FROM impuestos WHERE codimpuesto != ? AND statusimpuesto = ? AND codsucursal = ? AND statusimpuesto = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codimpuesto"]),$_POST["statusimpuesto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num>0)
	{
		echo "2";
		exit;
	}
	$sql = "SELECT nomimpuesto FROM impuestos WHERE codimpuesto != ? AND nomimpuesto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codimpuesto"]),$_POST["nomimpuesto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE impuestos set "
		." nomimpuesto = ?, "
		." valorimpuesto = ?, "
		." statusimpuesto = ?, "
		." codsucursal = ? "
		." WHERE "
		." codimpuesto = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomimpuesto);
		$stmt->bindParam(2, $valorimpuesto);
		$stmt->bindParam(3, $statusimpuesto);
		$stmt->bindParam(4, $codsucursal);
		$stmt->bindParam(5, $codimpuesto);

		$nomimpuesto    = limpiar($_POST["nomimpuesto"]);
		$valorimpuesto  = limpiar($_POST["valorimpuesto"]);
		$statusimpuesto = limpiar($_POST["statusimpuesto"]);
		$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
		$codimpuesto    = limpiar(decrypt($_POST["codimpuesto"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL IMPUESTO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "3";
		exit;
	}
}
############################ FUNCION ACTUALIZAR IMPUESTOS ############################

######################### FUNCION ELIMINAR IMPUESTOS #########################
public function EliminarImpuestos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT * FROM impuestos WHERE codimpuesto = ? AND statusimpuesto = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codimpuesto"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM impuestos WHERE codimpuesto = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codimpuesto);
		$codimpuesto = decrypt($_GET["codimpuesto"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
   } else {
		
		echo "3";
		exit;
	}	
}
######################## FUNCION ELIMINAR IMPUESTOS ###########################

############################ FIN DE CLASE IMPUESTOS ################################



















################################# CLASE BANCOS ################################

########################### FUNCION REGISTRAR BANCOS ###########################
public function RegistrarBancos()
{
	self::SetNames();
	if(empty($_POST["nombanco"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nombanco FROM bancos WHERE nombanco = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nombanco"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO bancos values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nombanco);
		$stmt->bindParam(2, $codsucursal);

		$nombanco    = limpiar($_POST["nombanco"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL BANCO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
############################ FUNCION REGISTRAR BANCOS ##########################

########################## FUNCION LISTAR BANCOS ##########################
public function ListarBancos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		bancos.codbanco,
		bancos.nombanco,
		bancos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM bancos LEFT JOIN sucursales ON bancos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (bancos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR bancos.codsucursal = '0')
		ORDER BY bancos.nombanco ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		bancos.codbanco,
		bancos.nombanco,
		bancos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM bancos LEFT JOIN sucursales ON bancos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (bancos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR bancos.codsucursal = '0')
		ORDER BY bancos.nombanco ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR BANCOS ##########################

############################ FUNCION ID BANCOS #################################
public function BancosPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM bancos WHERE codbanco = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codbanco"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID BANCOS #################################

##################### FUNCION ACTUALIZAR BANCOS ############################
public function ActualizarBancos()
{
	self::SetNames();
	if(empty($_POST["codbanco"]) or empty($_POST["nombanco"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nombanco FROM bancos WHERE codbanco != ? AND nombanco = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codbanco"]),$_POST["nombanco"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE bancos set "
		." nombanco = ?, "
		." codsucursal = ? "
		." WHERE "
		." codbanco = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nombanco);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codbanco);

		$nombanco    = limpiar($_POST["nombanco"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codbanco    = limpiar(decrypt($_POST["codbanco"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL BANCO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
##################### FUNCION ACTUALIZAR BANCOS ############################

########################## FUNCION ELIMINAR BANCOS #########################
public function EliminarBancos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codbanco FROM abonoscreditoscompras WHERE codbanco = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codbanco"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM bancos WHERE codbanco = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codbanco);
		$codbanco = decrypt($_GET["codbanco"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR BANCOS ###########################

############################ FIN DE CLASE BANCOS ##############################























############################# CLASE SUCURSALES ##################################

############################ FUNCION REGISTRAR SUCURSALES ##########################
public function RegistrarSucursales()
{
	self::SetNames();
	if(empty($_POST["dniencargado"]) or empty($_POST["nomencargado"]) or empty($_POST["cuitsucursal"]) or empty($_POST["nomsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT correosucursal FROM sucursales WHERE correosucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["correosucursal"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "2";
		exit;
	}
	$sql = " SELECT cuitsucursal FROM sucursales WHERE cuitsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["cuitsucursal"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		############################ REGISTRO DE SUCURSAL ############################
		$query = " INSERT INTO sucursales values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nrosucursal);
		$stmt->bindParam(2, $documsucursal);
		$stmt->bindParam(3, $cuitsucursal);
		$stmt->bindParam(4, $nomsucursal);
		$stmt->bindParam(5, $id_provincia);
		$stmt->bindParam(6, $id_departamento);
		$stmt->bindParam(7, $direcsucursal);
		$stmt->bindParam(8, $correosucursal);
		$stmt->bindParam(9, $tlfsucursal);
		$stmt->bindParam(10, $nroactividadsucursal);
		$stmt->bindParam(11, $inicioticket);
		$stmt->bindParam(12, $iniciofactura);
		$stmt->bindParam(13, $inicioguia);
		$stmt->bindParam(14, $inicionotaventa);
		$stmt->bindParam(15, $inicionotacredito);
		$stmt->bindParam(16, $fechaautorsucursal);
		$stmt->bindParam(17, $llevacontabilidad);
		$stmt->bindParam(18, $documencargado);
		$stmt->bindParam(19, $dniencargado);
		$stmt->bindParam(20, $nomencargado);
		$stmt->bindParam(21, $tlfencargado);
		$stmt->bindParam(22, $descsucursal);
		$stmt->bindParam(23, $porcentaje);
		$stmt->bindParam(24, $codmoneda);
		$stmt->bindParam(25, $codmoneda2);
		$stmt->bindParam(26, $membrete);
		$stmt->bindParam(27, $mostrar_pos);
		$stmt->bindParam(28, $ticket_general);
		$stmt->bindParam(29, $estado);

		$nrosucursal          = limpiar($_POST["nrosucursal"]);
		$documsucursal        = limpiar($_POST['documsucursal'] == '' ? "0" : decrypt($_POST['documsucursal']));
		$cuitsucursal         = limpiar($_POST["cuitsucursal"]);
		$nomsucursal          = limpiar($_POST["nomsucursal"]);
		$id_provincia         = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento      = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direcsucursal        = limpiar($_POST["direcsucursal"]);
		$correosucursal       = limpiar($_POST["correosucursal"]);
		$tlfsucursal          = limpiar($_POST["tlfsucursal"]);
		$nroactividadsucursal = limpiar($_POST["nroactividadsucursal"]);
		$inicioticket         = limpiar($_POST["inicioticket"]);
		$iniciofactura        = limpiar($_POST["iniciofactura"]);
		$inicioguia           = limpiar($_POST["inicioguia"]);
		$inicionotaventa      = limpiar($_POST["inicionotaventa"]);
		$inicionotacredito    = limpiar($_POST["inicionotacredito"]);
		$fechaautorsucursal   = limpiar($_POST['fechaautorsucursal'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaautorsucursal'])));
		$llevacontabilidad    = limpiar($_POST["llevacontabilidad"]);
		$documencargado       = limpiar($_POST['documencargado'] == '' ? "0" : decrypt($_POST['documencargado']));
		$dniencargado         = limpiar($_POST["dniencargado"]);
		$nomencargado         = limpiar($_POST["nomencargado"]);
		$tlfencargado         = limpiar($_POST["tlfencargado"]);
		$descsucursal         = limpiar($_POST["descsucursal"]);
		$porcentaje           = limpiar($_POST["porcentaje"]);
		$codmoneda            = limpiar(decrypt($_POST["codmoneda"]));
		$codmoneda2           = limpiar($_POST['codmoneda2'] == '' ? "0" : decrypt($_POST['codmoneda2']));
		$membrete             = limpiar($_POST["membrete"]);
		$mostrar_pos          = limpiar(isset($_POST['mostrar_pos']) ? $_POST['mostrar_pos'] : "");
		$ticket_general       = limpiar(isset($_POST['ticket_general']) ? $_POST['ticket_general'] : "");
		$estado               = limpiar("1");
		$stmt->execute();
		############################ REGISTRO DE SUCURSAL ############################

		############################ OBTENGO EL ULTIMO ID DE SUCURSAL ############################
	    $lastIdSucursal = $this->dbh->lastInsertId();
	    ############################ OBTENGO EL ULTIMO ID DE SUCURSAL ############################ 

        ############################ SUBIR LOGO DE SUCURSAL ############################
	    //datos de carpetas
	    $dirmake_producto = limpiar(is_dir('fotos/productos/'.$lastIdSucursal) ? "" : mkdir('fotos/productos/'.$lastIdSucursal, 0777));//creo carpeta en productos
	    $dirmake_combo    = limpiar(is_dir('fotos/combos/'.$lastIdSucursal) ? "" : mkdir('fotos/combos/'.$lastIdSucursal, 0777));//creo carpeta en productos
	    $dirmake_factura  = limpiar(is_dir('archivos/facturas/'.$lastIdSucursal) ? "" : mkdir('archivos/facturas/'.$lastIdSucursal, 0777));//creo carpeta en facturas
        //datos del arhivo  
	    $nombre_archivo   = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo     = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo   = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");

	    //compruebo si las características del archivo son las que deseo  
        if (!empty($_FILES["imagen"]) && (strpos($tipo_archivo,'image/png')!==false)&&$tamano_archivo<2097152)// 2MB 
        {  
		   if (move_uploaded_file($_FILES['imagen']['tmp_name'], "fotos/sucursales/".$nombre_archivo) && rename("fotos/sucursales/".$nombre_archivo,"fotos/sucursales/".$_POST["cuitsucursal"].".png"))
		   { 
	       ## se puede dar un aviso
		   } 
	       ## se puede dar otro aviso 
	    }
	    ############################ SUBIR LOGO DE SUCURSAL ############################ 

		echo "<span class='fa fa-check-square-o'></span> LA SUCURSAL HA SIDO REGISTRADA EXITOSAMENTE";
		exit;
	}
	else
	{
		echo "3";
		exit;
	}
}
######################### FUNCION REGISTRAR SUCURSALES ###############################

######################## FUNCION LISTAR SUCURSALES ###############################
public function ListarSucursales()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		sucursales.*,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda2.moneda AS moneda2,
		provincias.provincia,
		departamentos.departamento 
		FROM sucursales 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} elseif ($_SESSION['acceso'] == "administradorS") {
		
		$sql = "SELECT 
		sucursales.*,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda2.moneda AS moneda2,
		provincias.provincia,
		departamentos.departamento 
		FROM sucursales 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE sucursales.codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR SUCURSALES ##########################

######################## FUNCION LISTAR SUCURSALES DIFERENTES A SESSION ###############################
public function ListarSucursalesDiferentes($gruposid)
{
	self::SetNames();
	$sql = "SELECT 
	sucursales.*,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda2.moneda AS moneda2,
	provincias.provincia,
	departamentos.departamento
	FROM sucursales 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	WHERE sucursales.codsucursal IN ($gruposid)";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION LISTAR SUCURSALES DIFERENTES A SESSION ########################## 

############################ FUNCION ID SUCURSALES #################################
public function SucursalesPorId()
{
	self::SetNames();
	$sql = "SELECT  
	sucursales.*,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda2.moneda AS moneda2,
	provincias.provincia,
	departamentos.departamento 
	FROM sucursales 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	WHERE sucursales.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID SUCURSALES #################################

############################ FUNCION ID SESSION SUCURSALES #################################
public function SucursalesSessionPorId()
{
	self::SetNames();
	$sql = "SELECT 
	sucursales.*,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	provincias.provincia,
	departamentos.departamento,
	usuarios.codigo,
	usuarios.dni,
	usuarios.nombres,
	usuarios.sexo,
	usuarios.direccion,
	usuarios.telefono,
	usuarios.email,
	usuarios.comision,
    usuarios.limite_descuento,
	usuarios.gruposid
	FROM usuarios
	LEFT JOIN sucursales ON usuarios.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	WHERE usuarios.codigo = ? AND usuarios.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_SESSION["codigo"]),limpiar($_SESSION["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID SESSION SUCURSALES #################################

############################ FUNCION ACTUALIZAR SUCURSALES ############################
public function ActualizarSucursales()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["dniencargado"]) or empty($_POST["nomencargado"]) or empty($_POST["cuitsucursal"]) or empty($_POST["nomsucursal"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT correosucursal FROM sucursales WHERE codsucursal != ? AND correosucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codsucursal"]),$_POST["correosucursal"]));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "2";
		exit;
	}

	$sql = " SELECT cuitsucursal FROM sucursales WHERE codsucursal != ? AND cuitsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codsucursal"]),$_POST["cuitsucursal"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		############################ ACTUALIZACION DE SUCURSAL ############################
		$sql = " UPDATE sucursales SET "
		." nrosucursal = ?, "
		." documsucursal = ?, "
		." cuitsucursal = ?, "
		." nomsucursal = ?, "
		." id_provincia = ?, "
		." id_departamento = ?, "
		." direcsucursal = ?, "
		." correosucursal = ?, "
		." tlfsucursal = ?, "
		." inicioticket = ?, "
		." iniciofactura = ?, "
		." inicioguia = ?, "
		." inicionotaventa = ?, "
		." inicionotacredito = ?, "
		." nroactividadsucursal = ?, "
		." fechaautorsucursal = ?, "
		." llevacontabilidad = ?, "
		." documencargado = ?, "
		." dniencargado = ?, "
		." nomencargado = ?, "
		." tlfencargado = ?, "
		." descsucursal = ?, "
		." porcentaje = ?, "
		." codmoneda = ?, "
		." codmoneda2 = ?, "
		." membrete = ?, "
		." mostrar_pos = ?, "
		." ticket_general = ? "
		." WHERE "
		." codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nrosucursal);
		$stmt->bindParam(2, $documsucursal);
		$stmt->bindParam(3, $cuitsucursal);
		$stmt->bindParam(4, $nomsucursal);
		$stmt->bindParam(5, $id_provincia);
		$stmt->bindParam(6, $id_departamento);
		$stmt->bindParam(7, $direcsucursal);
		$stmt->bindParam(8, $correosucursal);
		$stmt->bindParam(9, $tlfsucursal);
		$stmt->bindParam(10, $inicioticket);
		$stmt->bindParam(11, $iniciofactura);
		$stmt->bindParam(12, $inicioguia);
		$stmt->bindParam(13, $inicionotaventa);
		$stmt->bindParam(14, $inicionotacredito);
		$stmt->bindParam(15, $nroactividadsucursal);
		$stmt->bindParam(16, $fechaautorsucursal);
		$stmt->bindParam(17, $llevacontabilidad);
		$stmt->bindParam(18, $documencargado);
		$stmt->bindParam(19, $dniencargado);
		$stmt->bindParam(20, $nomencargado);
		$stmt->bindParam(21, $tlfencargado);
		$stmt->bindParam(22, $descsucursal);
		$stmt->bindParam(23, $porcentaje);
		$stmt->bindParam(24, $codmoneda);
		$stmt->bindParam(25, $codmoneda2);
		$stmt->bindParam(26, $membrete);
		$stmt->bindParam(27, $mostrar_pos);
		$stmt->bindParam(28, $ticket_general);
		$stmt->bindParam(29, $codsucursal);

		$nrosucursal          = limpiar($_POST["nrosucursal"]);
		$documsucursal        = limpiar($_POST['documsucursal'] == '' ? "0" : decrypt($_POST['documsucursal']));
		$cuitsucursal         = limpiar($_POST["cuitsucursal"]);
		$nomsucursal          = limpiar($_POST["nomsucursal"]);
		$id_provincia         = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento      = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direcsucursal        = limpiar($_POST["direcsucursal"]);
		$correosucursal       = limpiar($_POST["correosucursal"]);
		$tlfsucursal          = limpiar($_POST["tlfsucursal"]);
		$nroactividadsucursal = limpiar($_POST["nroactividadsucursal"]);
		$inicioticket         = limpiar($_POST["inicioticket"]);
		$iniciofactura        = limpiar($_POST["iniciofactura"]);
		$inicioguia           = limpiar($_POST["inicioguia"]);
		$inicionotaventa      = limpiar($_POST["inicionotaventa"]);
		$inicionotacredito    = limpiar($_POST["inicionotacredito"]);
		$fechaautorsucursal   = limpiar($_POST['fechaautorsucursal'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaautorsucursal'])));
		$llevacontabilidad    = limpiar($_POST["llevacontabilidad"]);
		$documencargado       = limpiar($_POST['documencargado'] == '' ? "0" : decrypt($_POST['documencargado']));
		$dniencargado         = limpiar($_POST["dniencargado"]);
		$nomencargado         = limpiar($_POST["nomencargado"]);
		$tlfencargado         = limpiar($_POST["tlfencargado"]);
		$descsucursal         = limpiar($_POST["descsucursal"]);
		$porcentaje           = limpiar($_POST["porcentaje"]);
		$codmoneda            = limpiar(decrypt($_POST["codmoneda"]));
		$codmoneda2           = limpiar($_POST['codmoneda2'] == '' ? "0" : decrypt($_POST['codmoneda2']));
		$membrete             = limpiar($_POST["membrete"]);
		$mostrar_pos          = limpiar(isset($_POST['mostrar_pos']) ? $_POST['mostrar_pos'] : "");
		$ticket_general       = limpiar(isset($_POST['ticket_general']) ? $_POST['ticket_general'] : "");
		$codsucursal          = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		############################ ACTUALIZACION DE SUCURSAL ############################

		############################ SUBIR LOGO DE SUCURSAL ############################
	    //datos de carpetas
	    $dirmake_producto = limpiar(is_dir('fotos/productos/'.$codsucursal) ? "" : mkdir('fotos/productos/'.$codsucursal, 0777));//creo carpeta en productos
	    $dirmake_combo    = limpiar(is_dir('fotos/combos/'.$codsucursal) ? "" : mkdir('fotos/combos/'.$codsucursal, 0777));//creo carpeta en productos
	    $dirmake_factura  = limpiar(is_dir('archivos/facturas/'.$codsucursal) ? "" : mkdir('archivos/facturas/'.$codsucursal, 0777));//creo carpeta en facturas
        //datos del arhivo  
	    $nombre_archivo   = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo     = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo   = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");

	    //compruebo si las características del archivo son las que deseo  
        if (!empty($_FILES["imagen"]) && (strpos($tipo_archivo,'image/png')!==false)&&$tamano_archivo<2097152)// 2MB 
        {  
		    if (move_uploaded_file($_FILES['imagen']['tmp_name'], "fotos/sucursales/".$nombre_archivo) && rename("fotos/sucursales/".$nombre_archivo,"fotos/sucursales/".$_POST["cuitsucursal"].".png"))
		    { 
	        ## se puede dar un aviso
		    } 
	        ## se puede dar otro aviso 
	    }
	    ############################ SUBIR LOGO DE SUCURSAL ############################

		echo "<span class='fa fa-check-square-o'></span> LA SUCURSAL HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;
	}
	else
	{
		echo "3";
		exit;
	}
}
############################ FUNCION ACTUALIZAR SUCURSALES ############################

############################# FUNCION CAMBIAR STATUS SUCURSALES ################################
public function EstadoSucursales()
{
	self::SetNames();
	###################### ACTUALIZO STATUS DE SUCURSAL ######################
	$sql = "UPDATE sucursales set "
	." estado = ? "
	." WHERE "
	." codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $estado);
	$stmt->bindParam(2, $codsucursal);

	$estado = limpiar(decrypt($_GET['estado']) == 1 ? 0 : 1);
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
	$stmt->execute();
	###################### ACTUALIZO STATUS DE SUCURSAL ######################

	echo "1";
	exit;	
}
############################## FUNCION CAMBIAR STATUS SUCURSALES ##############################

########################## FUNCION ELIMINAR SUCURSALES ########################
public function EliminarSucursales()
{
self::SetNames();
   if($_SESSION['acceso'] == "administradorG") {

	$sql = "SELECT codsucursal FROM productos WHERE codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " DELETE FROM sucursales WHERE codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codsucursal);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
############################ FUNCION ELIMINAR SUCURSALES #######################

############################# FIN DE CLASE SUCURSALES ################################


























################################ CLASE FAMILIAS ######################################

############################# FUNCION REGISTRAR FAMILIAS ###############################
public function RegistrarFamilias()
{
	self::SetNames();
	if(empty($_POST["nomfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomfamilia FROM familias WHERE nomfamilia = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomfamilia"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO familias values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nomfamilia);
		$stmt->bindParam(2, $codsucursal);

		$nomfamilia  = limpiar($_POST["nomfamilia"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA FAMILIA HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
########################### FUNCION REGISTRAR FAMILIAS ###############################

########################### FUNCION LISTAR FAMILIAS ################################
public function ListarFamilias()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		familias.codfamilia,
		familias.nomfamilia,
		familias.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM familias LEFT JOIN sucursales ON familias.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (familias.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR familias.codsucursal = '0')
		ORDER BY familias.nomfamilia ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		familias.codfamilia,
		familias.nomfamilia,
		familias.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM familias LEFT JOIN sucursales ON familias.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (familias.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR familias.codsucursal = '0')
		ORDER BY familias.nomfamilia ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION LISTAR FAMILIAS ################################

############################ FUNCION ID FAMILIAS #################################
public function FamiliasPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM familias WHERE codfamilia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codfamilia"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID FAMILIAS #################################

############################ FUNCION ACTUALIZAR FAMILIAS ############################
public function ActualizarFamilias()
{
	self::SetNames();
	if(empty($_POST["codfamilia"]) or empty($_POST["nomfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomfamilia FROM familias WHERE codfamilia != ? AND nomfamilia = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codfamilia"]),$_POST["nomfamilia"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE familias set "
		." nomfamilia = ?, "
		." codsucursal = ? "
		." WHERE "
		." codfamilia = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomfamilia);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codfamilia);

		$nomfamilia  = limpiar($_POST["nomfamilia"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codfamilia  = limpiar(decrypt($_POST["codfamilia"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA FAMILIA HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR FAMILIAS ############################

########################### FUNCION ELIMINAR FAMILIAS #################################
public function EliminarFamilias()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codfamilia FROM subfamilias WHERE codfamilia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codfamilia"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM familias WHERE codfamilia = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codfamilia);
		$codfamilia = decrypt($_GET["codfamilia"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR FAMILIAS #################################

############################# FIN DE CLASE FAMILIAS #################################


























################################# CLASE SUBFAMILIAS ####################################

########################### FUNCION REGISTRAR SUBFAMILIAS #########################
public function RegistrarSubfamilias()
{
	self::SetNames();
	if(empty($_POST["nomsubfamilia"]) or empty($_POST["codfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomsubfamilia FROM subfamilias WHERE nomsubfamilia = ? AND codfamilia = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomsubfamilia"],decrypt($_POST["codfamilia"]),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO subfamilias values (null, ?, ?, ?);";
		$stmt  = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nomsubfamilia);
		$stmt->bindParam(2, $codfamilia);
		$stmt->bindParam(3, $codsucursal);

		$nomsubfamilia = limpiar($_POST["nomsubfamilia"]);
		$codfamilia    = limpiar(decrypt($_POST["codfamilia"]));
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

	   echo "<span class='fa fa-check-square-o'></span> LA SUBFAMILIA HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
########################## FUNCION REGISTRAR SUBFAMILIAS ###############################

######################### FUNCION LISTAR SUBFAMILIAS ################################
public function ListarSubfamilias()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		subfamilias.codsubfamilia,
		subfamilias.nomsubfamilia,
		subfamilias.codfamilia,
		subfamilias.codsucursal,
		familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM subfamilias LEFT JOIN familias ON subfamilias.codfamilia = familias.codfamilia
	    LEFT JOIN sucursales ON subfamilias.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (subfamilias.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR subfamilias.codsucursal = '0')
		ORDER BY subfamilias.nomsubfamilia ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		subfamilias.codsubfamilia,
		subfamilias.nomsubfamilia,
		subfamilias.codfamilia,
		subfamilias.codsucursal,
		familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM subfamilias LEFT JOIN familias ON subfamilias.codfamilia = familias.codfamilia
	    LEFT JOIN sucursales ON subfamilias.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (subfamilias.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR subfamilias.codsucursal = '0')
		ORDER BY subfamilias.nomsubfamilia ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR SUBFAMILIAS ################################

####################### FUNCION LISTAR SUBFAMILIAS POR FAMILIAS ######################
public function ListarSubfamilias2() 
{
	self::SetNames();
	$sql = "SELECT * FROM subfamilias WHERE codfamilia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codfamilia"])));
	$num = $stmt->rowCount();
	    if($num==0)
	{
		echo "<option value='0' selected> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	    while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
####################### FUNCION LISTAR SUBFAMILIAS POR FAMILIAS #########################

########################## FUNCION PARA LISTAR SUBFAMILIAS DE FAMILIA ##########################
public function ListarSubfamiliasAsignados($codfamilia)
{
	self::SetNames();
	$sql = "SELECT * FROM subfamilias LEFT JOIN familias ON subfamilias.codfamilia = familias.codfamilia
	WHERE subfamilias.codfamilia = '".limpiar($codfamilia)."' ORDER BY subfamilias.nomsubfamilia ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION PARA LISTAR SUBFAMILIAS DE FAMILIA ##########################

############################ FUNCION ID SUBFAMILIAS #################################
public function SubfamiliasPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM subfamilias LEFT JOIN familias ON familias.codfamilia = subfamilias.codfamilia 
	WHERE subfamilias.codsubfamilia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsubfamilia"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID SUBFAMILIAS #################################

############################ FUNCION ACTUALIZAR SUBFAMILIAS ############################
public function ActualizarSubfamilias()
{
	self::SetNames();
	if(empty($_POST["codsubfamilia"]) or empty($_POST["nomsubfamilia"]) or empty($_POST["codfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = "SELECT nomsubfamilia FROM subfamilias 
	WHERE codsubfamilia != ? AND nomsubfamilia = ? AND codfamilia = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codsubfamilia"]),$_POST["nomsubfamilia"],decrypt($_POST["codfamilia"]),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE subfamilias set "
		." nomsubfamilia = ?, "
		." codfamilia = ?, "
		." codsucursal = ? "
		." WHERE "
		." codsubfamilia = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomsubfamilia);
		$stmt->bindParam(2, $codfamilia);
		$stmt->bindParam(3, $codsucursal);
		$stmt->bindParam(4, $codsubfamilia);

		$nomsubfamilia = limpiar($_POST["nomsubfamilia"]);
		$codfamilia    = limpiar(decrypt($_POST["codfamilia"]));
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$codsubfamilia = limpiar(decrypt($_POST["codsubfamilia"]));
		$stmt->execute();

	    echo "<span class='fa fa-check-square-o'></span> LA SUBFAMILIA HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR SUBFAMILIAS ############################

############################ FUNCION ELIMINAR SUBFAMILIAS ##########################
public function EliminarSubfamilias()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codsubfamilia FROM productos WHERE codsubfamilia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsubfamilia"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM subfamilias WHERE codsubfamilia = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codsubfamilia);
		$codsubfamilia = decrypt($_GET["codsubfamilia"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
############################ FUNCION ELIMINAR SUBFAMILIAS ##########################

############################## FIN DE CLASE SUBFAMILIAS ##############################


























################################## CLASE MARCAS ######################################

############################ FUNCION REGISTRAR MARCAS ###############################
public function RegistrarMarcas()
{
	self::SetNames();
	if(empty($_POST["nommarca"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nommarca FROM marcas WHERE nommarca = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nommarca"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO marcas values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nommarca);
		$stmt->bindParam(2, $codsucursal);

		$nommarca    = limpiar($_POST["nommarca"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA MARCA HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
############################ FUNCION REGISTRAR MARCAS ###############################

############################## FUNCION LISTAR MARCAS ################################
public function ListarMarcas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		marcas.codmarca,
		marcas.nommarca,
		marcas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM marcas LEFT JOIN sucursales ON marcas.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (marcas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR marcas.codsucursal = '0')
		ORDER BY marcas.nommarca ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		marcas.codmarca,
		marcas.nommarca,
		marcas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM marcas LEFT JOIN sucursales ON marcas.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (marcas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR marcas.codsucursal = '0')
		ORDER BY marcas.nommarca ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################################## FUNCION LISTAR MARCAS ################################

############################ FUNCION ID MARCAS #################################
public function MarcasPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM marcas WHERE codmarca = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmarca"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID MARCAS #################################

############################ FUNCION ACTUALIZAR MARCAS ############################
public function ActualizarMarcas()
{
	self::SetNames();
	if(empty($_POST["codmarca"]) or empty($_POST["nommarca"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nommarca FROM marcas WHERE codmarca != ? AND nommarca = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codmarca"]),$_POST["nommarca"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE marcas set "
		." nommarca = ?, "
		." codsucursal = ? "
		." WHERE "
		." codmarca = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nommarca);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codmarca);

		$nommarca    = limpiar($_POST["nommarca"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codmarca    = limpiar(decrypt($_POST["codmarca"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA MARCA HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR MARCAS ############################

########################### FUNCION ELIMINAR MARCAS #################################
public function EliminarMarcas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codmarca FROM modelos WHERE codmarca = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmarca"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM marcas WHERE codmarca = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codmarca);
		$codmarca = decrypt($_GET["codmarca"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR MARCAS #################################

############################## FIN DE CLASE MARCAS ###################################


















################################# CLASE MODELOS ######################################

########################### FUNCION REGISTRAR MODELOS ###############################
public function RegistrarModelos()
{
	self::SetNames();
	if(empty($_POST["nommodelo"]) or empty($_POST["codmarca"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nommodelo FROM modelos WHERE nommodelo = ? AND codmarca = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nommodelo"],decrypt($_POST["codmarca"]),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO modelos values (null, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nommodelo);
		$stmt->bindParam(2, $codmarca);
		$stmt->bindParam(3, $codsucursal);

		$nommodelo   = limpiar($_POST["nommodelo"]);
		$codmarca    = limpiar(decrypt($_POST["codmarca"]));
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL MODELO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################### FUNCION REGISTRAR MODELOS ###############################

############################ FUNCION LISTAR MODELOS ################################
public function ListarModelos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		modelos.codmodelo,
		modelos.nommodelo,
		modelos.codmarca,
		modelos.codsucursal,
		marcas.nommarca,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM modelos LEFT JOIN marcas ON modelos.codmarca = marcas.codmarca
	    LEFT JOIN sucursales ON modelos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (modelos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR modelos.codsucursal = '0')
		ORDER BY modelos.nommodelo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		modelos.codmodelo,
		modelos.nommodelo,
		modelos.codmarca,
		modelos.codsucursal,
		marcas.nommarca,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM modelos LEFT JOIN marcas ON modelos.codmarca = marcas.codmarca
	    LEFT JOIN sucursales ON modelos.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (modelos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR modelos.codsucursal = '0')
		ORDER BY modelos.nommodelo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################## FUNCION LISTAR MODELOS ################################

########################## FUNCION PARA LISTAR MODELOS DE MARCA ##########################
public function ListarModelosAsignados($codmarca)
{
	self::SetNames();
	$sql = "SELECT * FROM modelos LEFT JOIN marcas ON modelos.codmarca = marcas.codmarca
	WHERE modelos.codmarca = '".limpiar($codmarca)."' ORDER BY modelos.nommodelo ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION PARA LISTAR MODELOS DE MARCA ##########################

############################ FUNCION ID MODELOS #################################
public function ModelosPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM modelos LEFT JOIN marcas ON marcas.codmarca = modelos.codmarca WHERE modelos.codmodelo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmodelo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID MODELOS #################################

############################ FUNCION ACTUALIZAR MODELOS ############################
public function ActualizarModelos()
{
	self::SetNames();
	if(empty($_POST["codmodelo"]) or empty($_POST["nommodelo"]) or empty($_POST["codmarca"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	$sql = "SELECT nommodelo FROM modelos WHERE codmodelo != ? AND nommodelo = ? AND codmarca = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codmodelo"]),$_POST["nommodelo"],decrypt($_POST["codmarca"]),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE modelos set "
		." nommodelo = ?, "
		." codmarca = ?, "
		." codsucursal = ? "
		." WHERE "
		." codmodelo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nommodelo);
		$stmt->bindParam(2, $codmarca);
		$stmt->bindParam(3, $codsucursal);
		$stmt->bindParam(4, $codmodelo);

		$nommodelo   = limpiar($_POST["nommodelo"]);
		$codmarca    = limpiar(decrypt($_POST["codmarca"]));
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codmodelo   = limpiar(decrypt($_POST["codmodelo"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL MODELO HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR MODELOS ############################

############################ FUNCION ELIMINAR MODELOS ############################
public function EliminarModelos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codmodelo FROM productos WHERE codmodelo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmodelo"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM modelos WHERE codmodelo = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codmodelo);
		$codmodelo = decrypt($_GET["codmodelo"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
############################ FUNCION ELIMINAR MODELOS ############################

########################## FUNCION LISTAR MODELOS POR MARCAS ##########################
public function ListarModelosxMarcas() 
{
	self::SetNames();
	$sql = "SELECT * FROM modelos WHERE codmarca = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmarca"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
        echo "<option value='0' selected> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	   while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################# FUNCION LISTAR MODELOS POR MARCAS #########################

########################## FUNCION LISTAR MODELOS #2 POR MARCAS ##########################
public function ListarModelos2xMarcas() 
{
	self::SetNames();
	$sql = "SELECT * FROM modelos WHERE codmarca = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codmarca2"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
      echo "<option value='0' selected> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	   while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################# FUNCION LISTAR MODELOS #2 POR MARCAS #########################

############################## FIN DE CLASE MODELOS #################################















################################# CLASE PRESENTACIONES ################################

########################### FUNCION REGISTRAR PRESENTACIONES ##########################
public function RegistrarPresentaciones()
{
	self::SetNames();
	if(empty($_POST["nompresentacion"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nompresentacion FROM presentaciones WHERE nompresentacion = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nompresentacion"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO presentaciones values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nompresentacion);
		$stmt->bindParam(2, $codsucursal);

		$nompresentacion = limpiar($_POST["nompresentacion"]);
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA PRESENTACI&Oacute;N HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
########################### FUNCION REGISTRAR PRESENTACIONES #########################

########################### FUNCION LISTAR PRESENTACIONES ############################
public function ListarPresentaciones()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		presentaciones.codpresentacion,
		presentaciones.nompresentacion,
		presentaciones.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM presentaciones LEFT JOIN sucursales ON presentaciones.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (presentaciones.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR presentaciones.codsucursal = '0')
		ORDER BY presentaciones.nompresentacion ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		presentaciones.codpresentacion,
		presentaciones.nompresentacion,
		presentaciones.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM presentaciones LEFT JOIN sucursales ON presentaciones.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (presentaciones.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR presentaciones.codsucursal = '0')
		ORDER BY presentaciones.nompresentacion ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR PRESENTACIONES #########################

############################ FUNCION ID PRESENTACIONES #################################
public function PresentacionesPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM presentaciones WHERE codpresentacion = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpresentacion"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PRESENTACIONES #################################

######################### FUNCION ACTUALIZAR PRESENTACIONES #######################
public function ActualizarPresentaciones()
{
	self::SetNames();
	if(empty($_POST["codpresentacion"]) or empty($_POST["nompresentacion"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nompresentacion FROM presentaciones WHERE codpresentacion != ? AND nompresentacion = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codpresentacion"]),$_POST["nompresentacion"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE presentaciones set "
		." nompresentacion = ?, "
		." codsucursal = ? "
		." WHERE "
		." codpresentacion = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nompresentacion);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codpresentacion);

		$nompresentacion = limpiar($_POST["nompresentacion"]);
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$codpresentacion = limpiar(decrypt($_POST["codpresentacion"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA PRESENTACI&Oacute;N HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
######################## FUNCION ACTUALIZAR PRESENTACIONES #######################

########################### FUNCION ELIMINAR PRESENTACIONES ############################
public function EliminarPresentaciones()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codpresentacion FROM productos WHERE codpresentacion = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpresentacion"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM presentaciones WHERE codpresentacion = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpresentacion);
		$codpresentacion = decrypt($_GET["codpresentacion"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR PRESENTACIONES ###########################

########################### FIN DE CLASE PRESENTACIONES ###############################


























################################## CLASE COLORES ######################################

########################### FUNCION REGISTRAR COLORES ###############################
public function RegistrarColores()
{
	self::SetNames();
	if(empty($_POST["nomcolor"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomcolor FROM colores WHERE nomcolor = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomcolor"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO colores values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nomcolor);
		$stmt->bindParam(2, $codsucursal);

		$nomcolor    = limpiar($_POST["nomcolor"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL COLOR HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################## FUNCION REGISTRAR COLORES ###############################

########################## FUNCION LISTAR COLORES ################################
public function ListarColores()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		colores.codcolor,
		colores.nomcolor,
		colores.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM colores LEFT JOIN sucursales ON colores.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (colores.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR colores.codsucursal = '0')
		ORDER BY colores.nomcolor ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		colores.codcolor,
		colores.nomcolor,
		colores.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM colores LEFT JOIN sucursales ON colores.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (colores.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR colores.codsucursal = '0')
		ORDER BY colores.nomcolor ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR COLORES ################################

############################ FUNCION ID COLORES #################################
public function ColoresPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM colores WHERE codcolor = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcolor"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID COLORES #################################

############################ FUNCION ACTUALIZAR COLORES ############################
public function ActualizarColores()
{
	self::SetNames();
	if(empty($_POST["codcolor"]) or empty($_POST["nomcolor"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomcolor FROM colores WHERE codcolor != ? AND nomcolor = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcolor"]),$_POST["nomcolor"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE colores set "
		." nomcolor = ?, "
		." codsucursal = ? "
		." WHERE "
		." codcolor = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomcolor);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codcolor);

		$nomcolor    = limpiar($_POST["nomcolor"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codcolor    = limpiar(decrypt($_POST["codcolor"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL COLOR HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR COLORES ############################

########################### FUNCION ELIMINAR COLORES ###########################
public function EliminarColores()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codcolor FROM productos WHERE codcolor = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcolor"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM colores WHERE codcolor = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcolor);
		$codcolor = decrypt($_GET["codcolor"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR COLORES #################################

############################ FIN DE CLASE COLORES ##################################


























################################### CLASE ORIGENES ####################################

########################## FUNCION REGISTRAR ORIGENES ###############################
public function RegistrarOrigenes()
{
	self::SetNames();
	if(empty($_POST["nomorigen"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomorigen FROM origenes WHERE nomorigen = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomorigen"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO origenes values (null, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nomorigen);
		$stmt->bindParam(2, $codsucursal);

		$nomorigen   = limpiar($_POST["nomorigen"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL ORIGEN HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################# FUNCION REGISTRAR ORIGENES ###############################

############################ FUNCION LISTAR ORIGENES ################################
public function ListarOrigenes()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		origenes.codorigen,
		origenes.nomorigen,
		origenes.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM origenes LEFT JOIN sucursales ON origenes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (origenes.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR origenes.codsucursal = '0')
		ORDER BY origenes.nomorigen ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		origenes.codorigen,
		origenes.nomorigen,
		origenes.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM origenes LEFT JOIN sucursales ON origenes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE (origenes.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR origenes.codsucursal = '0')
		ORDER BY origenes.nomorigen ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION LISTAR ORIGENES ################################

############################ FUNCION ID ORIGENES #################################
public function OrigenesPorId()
{
	self::SetNames();
	$sql = "SELECT * FROM origenes WHERE codorigen = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codorigen"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID ORIGENES #################################

############################ FUNCION ACTUALIZAR ORIGENES ############################
public function ActualizarOrigenes()
{
	self::SetNames();
	if(empty($_POST["codorigen"]) or empty($_POST["nomorigen"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT nomorigen FROM origenes WHERE codorigen != ? AND nomorigen = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codorigen"]),$_POST["nomorigen"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = " UPDATE origenes set "
		." nomorigen = ?, "
		." codsucursal = ? "
		." WHERE "
		." codorigen = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomorigen);
		$stmt->bindParam(2, $codsucursal);
		$stmt->bindParam(3, $codorigen);

		$nomorigen   = limpiar($_POST["nomorigen"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codorigen   = limpiar(decrypt($_POST["codorigen"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL ORIGEN HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR ORIGENES ############################

########################### FUNCION ELIMINAR ORIGENES ##############################
public function EliminarOrigenes()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codorigen FROM productos WHERE codorigen = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codorigen"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM origenes WHERE codorigen = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codorigen);
		$codorigen = decrypt($_GET["codorigen"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR ORIGENES #################################

############################ FIN DE CLASE ORIGENES #################################


















############################## CLASE IMEIS ################################

########################## FUNCION REGISTRAR IMEIS #########################
public function RegistrarImei()
{
	self::SetNames();
	if(empty($_POST["numeroimei"]) or empty($_POST["estadoimei"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}	
	$sql = "SELECT numeroimei FROM imei WHERE numeroimei = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["numeroimei"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = "INSERT INTO imei values (null, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $numeroimei);
		$stmt->bindParam(2, $observaciones);
		$stmt->bindParam(3, $estadoimei);
		$stmt->bindParam(4, $codsucursal);

		$numeroimei    = limpiar($_POST["numeroimei"]);
		$observaciones = limpiar($_POST["observaciones"]);
		$estadoimei    = limpiar($_POST["estadoimei"]);
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL IMEI HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
######################### FUNCION REGISTRAR IMEIS ########################

########################### FUNCION LISTAR IMEIS ########################
public function ListarImei()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		imei.codimei,
		imei.numeroimei,
		imei.observaciones,
		imei.estadoimei,
		imei.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM imei
	    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		ORDER BY imei.numeroimei ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		imei.codimei,
		imei.numeroimei,
		imei.observaciones,
		imei.estadoimei,
		imei.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM imei
	    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		ORDER BY imei.numeroimei ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION LISTAR IMEIS ################################

######################## FUNCION ID IMEIS #################################
public function ImeiPorId()
{
	self::SetNames();
	$sql = "SELECT
	imei.codimei,
	imei.numeroimei,
	imei.observaciones,
	imei.estadoimei,
	imei.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos.documento
    FROM imei
    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	WHERE imei.codimei = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codimei"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID IMEIS #################################

####################### FUNCION ACTUALIZAR IMEIS ############################
public function ActualizarImei()
{
	self::SetNames();
	if(empty($_POST["codimei"])or empty($_POST["numeroimei"]) or empty($_POST["estadoimei"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}	
	$sql = "SELECT numeroimei FROM imei WHERE codimei != ? AND numeroimei = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codimei"]),$_POST["numeroimei"]));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE imei set "
		." numeroimei = ?, "
		." observaciones = ?, "
		." estadoimei = ?, "
		." codsucursal = ? "
		." WHERE "
		." codimei = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $numeroimei);
		$stmt->bindParam(2, $observaciones);
		$stmt->bindParam(3, $estadoimei);
		$stmt->bindParam(4, $codsucursal);
		$stmt->bindParam(5, $codimei);

		$numeroimei    = limpiar($_POST["numeroimei"]);
		$observaciones = limpiar($_POST["observaciones"]);
		$estadoimei    = limpiar($_POST["estadoimei"]);
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$codimei       = limpiar(decrypt($_POST["codimei"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL IMEI HA SIDO ACTUALIZADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
   }
}
###################### FUNCION ACTUALIZAR IMEIS ############################

############################# FUNCION CAMBIAR ESTADO IMEI ################################
public function EstadoImei()
{
	self::SetNames();
	$sql = "UPDATE imei set "
	." estadoimei = ? "
	." WHERE "
	." codimei = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $estado);
	$stmt->bindParam(2, $codimei);

	$estado = limpiar($_GET['estado']);
	//$estado = limpiar('4');
	$codimei = limpiar(decrypt($_GET["codimei"]));
	$stmt->execute();

	echo "1";
	exit;	
}
############################## FUNCION CAMBIAR ESTADO IMEI ##############################

########################## FUNCION ELIMINAR IMEIS ###########################
public function EliminarImei()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	    $sql = "DELETE FROM imei WHERE codimei = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codimei);
		$codimei = decrypt($_GET["codimei"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
	   
		echo "2";
		exit;
	} 
}
########################### FUNCION ELIMINAR IMEIS ###########################

########################### FUNCION LISTAR IMEIS ACTIVOS ########################
public function ListarImeiActivos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		imei.codimei,
		imei.numeroimei,
		imei.observaciones,
		imei.estadoimei,
		imei.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM imei
	    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND (imei.estadoimei = 1 OR imei.estadoimei = 4)
		ORDER BY imei.numeroimei ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		imei.codimei,
		imei.numeroimei,
		imei.observaciones,
		imei.estadoimei,
		imei.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM imei
	    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND (imei.estadoimei = 1 OR imei.estadoimei = 4)
		ORDER BY imei.numeroimei ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION LISTAR IMEIS ACTIVOS ################################

########################### FUNCION LISTAR IMEIS X BUSQUEDA ########################
public function ListarImeixBusqueda()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		if(decrypt($_GET['var']) == 0){
			
			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 1){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND imei.estadoimei = 1
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 2){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND imei.estadoimei = 1
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 3){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND imei.estadoimei = 3
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;
		}

	} else {

		if(decrypt($_GET['var']) == 0){
			
			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 1){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
			AND imei.estadoimei = 1
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 2){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
			AND imei.estadoimei = 1
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;

		} elseif(decrypt($_GET['var']) == 3){

			$sql = "SELECT
			imei.codimei,
			imei.numeroimei,
			imei.observaciones,
			imei.estadoimei,
			imei.codsucursal,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			documentos.documento
		    FROM imei
		    LEFT JOIN sucursales ON imei.codsucursal = sucursales.codsucursal
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			WHERE imei.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
			AND imei.estadoimei = 3
			ORDER BY imei.numeroimei ASC";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			return $this->p;
			$this->dbh=null;
		}
	}
}
######################### FUNCION LISTAR IMEIS X BUSQUEDA ################################

############################ FIN DE CLASE IMEIS #############################


















################################## CLASE CLIENTES ##################################

############################### FUNCION CARGAR CLIENTES ##############################
public function CargarClientes()
{
	self::SetNames();
	if(empty($_FILES["sel_file"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
    //Aquí es donde seleccionamos nuestro csv
    $fname = $_FILES['sel_file']['name'];
    //echo 'Cargando nombre del archivo: '.$fname.' ';
    $chk_ext = explode(".",$fname);
     
    if(strtolower(end($chk_ext)) == "csv"){

    //si es correcto, entonces damos permisos de lectura para subir
    $filename = $_FILES['sel_file']['tmp_name'];
    $handle = fopen($filename, "r");
    $this->dbh->beginTransaction();
    
    $primera = true;
    while (($data = fgetcsv($handle, 1000, ";")) !== FALSE) {
    // Evitamos la primer línea
    if ($primera){
      $primera = false;
      continue;
    }
	    ############## CREO CODIGO DE CLIENTE #################
		$sql = "SELECT codcliente
		FROM clientes
		ORDER BY idcliente DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$cliente = $row["codcliente"];
		}
		$codcliente = limpiar(empty($cliente) ? "1" : $cliente+1);
		############## CREO CODIGO DE CLIENTE #################

	    //Insertamos los datos con los valores...  
		$query = "INSERT INTO clientes values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcliente);
		$stmt->bindParam(2, $tipocliente);
		$stmt->bindParam(3, $documcliente);
		$stmt->bindParam(4, $dnicliente);
		$stmt->bindParam(5, $nomcliente);
		$stmt->bindParam(6, $razoncliente);
		$stmt->bindParam(7, $girocliente);
		$stmt->bindParam(8, $tlfcliente);
		$stmt->bindParam(9, $id_provincia);
		$stmt->bindParam(10, $id_departamento);
		$stmt->bindParam(11, $direccliente);
		$stmt->bindParam(12, $emailcliente);
		$stmt->bindParam(13, $limitecredito);
		$stmt->bindParam(14, $fechaingreso);
		$stmt->bindParam(15, $codsucursal);

		$tipocliente     = limpiar($data[0]);
		$documcliente    = limpiar($data[1]);
		$dnicliente      = limpiar($data[2]);
		$nomcliente      = utf8_encode($data[3]);
		$razoncliente    = utf8_encode($data[4]);
		$girocliente     = utf8_encode($data[5]);
		$tlfcliente      = limpiar($data[6]);
		$id_provincia    = limpiar($data[7]);
		$id_departamento = limpiar($data[8]);
		$direccliente    = utf8_encode($data[9]);
		$emailcliente    = limpiar($data[10]);
		$limitecredito   = limpiar($data[11]);
		$fechaingreso    = limpiar(date("Y-m-d"));
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		$codcliente++;
    }
    $this->dbh->commit();
    //cerramos la lectura del archivo "abrir archivo" con un "cerrar archivo"
    fclose($handle);
	        
	    echo "<span class='fa fa-check-square-o'></span> LA CARGA MASIVA DE CLIENTES FUE REALIZADA EXITOSAMENTE";
	    exit;
             
    } else {
    //si aparece esto es posible que el archivo no tenga el formato adecuado, inclusive cuando es cvs, revisarlo para ver si esta separado por " , "
        echo "2";
		exit;
    }  
}
################################# FUNCION CARGAR CLIENTES ###############################

############################ FUNCION REGISTRAR CLIENTES ###############################
public function RegistrarClientes()
{
	self::SetNames();
	if(empty($_POST["tipocliente"]) or empty($_POST["dnicliente"]) or empty($_POST["direccliente"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	############## CREO CODIGO DE CLIENTE #################
	$sql = "SELECT codcliente
	FROM clientes
	ORDER BY idcliente DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$cliente = $row["codcliente"];
	}
	$codcliente = limpiar(empty($cliente) ? "1" : $cliente + 1);
	############## CREO CODIGO DE CLIENTE #################

	$sql = "SELECT dnicliente FROM clientes WHERE dnicliente = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["dnicliente"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = "INSERT INTO clientes values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcliente);
		$stmt->bindParam(2, $tipocliente);
		$stmt->bindParam(3, $documcliente);
		$stmt->bindParam(4, $dnicliente);
		$stmt->bindParam(5, $nomcliente);
		$stmt->bindParam(6, $razoncliente);
		$stmt->bindParam(7, $girocliente);
		$stmt->bindParam(8, $tlfcliente);
		$stmt->bindParam(9, $id_provincia);
		$stmt->bindParam(10, $id_departamento);
		$stmt->bindParam(11, $direccliente);
		$stmt->bindParam(12, $emailcliente);
		$stmt->bindParam(13, $limitecredito);
		$stmt->bindParam(14, $fechaingreso);
		$stmt->bindParam(15, $codsucursal);
		
		$tipocliente     = limpiar($_POST["tipocliente"]);
		$documcliente    = limpiar($_POST['documcliente'] == '' ? "0" : $_POST['documcliente']);
		$dnicliente      = limpiar($_POST["dnicliente"]);
		$nomcliente      = limpiar($_POST['tipocliente'] == 'NATURAL' ? $_POST["nomcliente"] : "");
		$razoncliente    = limpiar($_POST['tipocliente'] == 'NATURAL' ? "" : $_POST["razoncliente"]);
		$girocliente     = limpiar($_POST['tipocliente'] == 'NATURAL' ? "" : $_POST["girocliente"]);
		$tlfcliente      = limpiar($_POST["tlfcliente"]);
		$id_provincia    = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direccliente    = limpiar($_POST["direccliente"]);
		$emailcliente    = limpiar($_POST["emailcliente"]);
		$limitecredito   = limpiar($_POST["limitecredito"]);
	    $fechaingreso    = limpiar(date("Y-m-d"));
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL CLIENTE HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
######################## FUNCION REGISTRAR CLIENTES ###############################

########################## FUNCION BUSQUEDA DE CLIENTES ###############################
public function BusquedaClientes() 
{
	self::SetNames();
	$sql ="SELECT
	clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	clientes.codsucursal,
	clientes.fechaingreso,
    documentos.documento,
	provincias.provincia,
	departamentos.departamento,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos2.documento AS documento2
	FROM clientes 
	LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	WHERE CONCAT(
		clientes.dnicliente, '',
		clientes.nomcliente, '',
		clientes.razoncliente, '',
		clientes.direccliente, '',
		clientes.emailcliente) 
	LIKE '%".limpiar($_GET['bclientes'])."%'
	AND (clientes.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR clientes.codsucursal = '0') LIMIT 0,60";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION BUSQUEDA DE CLIENTES ###############################

############################ FUNCION LISTAR CLIENTES ################################
public function ListarClientes()
{
    self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		clientes.codcliente,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.nomcliente,
		clientes.razoncliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		clientes.fechaingreso,
		clientes.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2
		FROM clientes 
		LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
		LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		WHERE (clientes.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR clientes.codsucursal = '0')
		ORDER BY clientes.nomcliente, clientes.razoncliente ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		clientes.codcliente,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.nomcliente,
		clientes.razoncliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		clientes.fechaingreso,
		clientes.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2
		FROM clientes 
		LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
		LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		WHERE (clientes.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR clientes.codsucursal = '0')
		ORDER BY clientes.nomcliente, clientes.razoncliente ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION LISTAR CLIENTES ################################

############################ FUNCION LISTAR CLIENTES ################################
public function ListarClientesxCreditosActivos()
{
    self::SetNames();
    if ($_SESSION['acceso'] == "administradorG") {

   	    $sql = "SELECT
		clientes.codcliente,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		clientes.fechaingreso,
		clientes.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2,
		creditosxclientes.montocredito,
		creditosxclientes.codsucursal
		FROM clientes
		INNER JOIN creditosxclientes ON clientes.codcliente = creditosxclientes.codcliente 
		LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
		LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	    WHERE (clientes.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR clientes.codsucursal = '0')
	    AND creditosxclientes.montocredito != 0.00";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

   } else {

		$sql = "SELECT
		clientes.codcliente,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		clientes.fechaingreso,
		clientes.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2,
		creditosxclientes.montocredito,
		creditosxclientes.codsucursal
		FROM clientes
		INNER JOIN creditosxclientes ON clientes.codcliente = creditosxclientes.codcliente 
		LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
		LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		WHERE creditosxclientes.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND creditosxclientes.montocredito != 0.00";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR CLIENTES ################################

######################### FUNCION ID CLIENTES #################################
public function ClientesPorId()
{
	self::SetNames();
	$sql = "SELECT
	clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	clientes.fechaingreso,
    documentos.documento,
	provincias.provincia,
	departamentos.departamento,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos2.documento AS documento2,
	IFNULL(ventas.codcliente,'0.00') AS cantidad,
	IFNULL(ventas.totalpago,'0.00') AS totalcompras
	FROM clientes 
	LEFT JOIN ventas ON clientes.codcliente = ventas.codcliente
	LEFT JOIN documentos ON clientes.documcliente = documentos.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN sucursales ON clientes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	WHERE clientes.codcliente = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcliente"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID CLIENTES #################################
	
############################ FUNCION ACTUALIZAR CLIENTES ############################
public function ActualizarClientes()
{
	self::SetNames();
	if(empty($_POST["codcliente"]) or empty($_POST["tipocliente"]) or empty($_POST["dnicliente"]) or empty($_POST["direccliente"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT dnicliente FROM clientes WHERE codcliente != ? AND dnicliente = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcliente"]),$_POST["dnicliente"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE clientes set "
		." tipocliente = ?, "
		." documcliente = ?, "
		." dnicliente = ?, "
		." nomcliente = ?, "
		." razoncliente = ?, "
		." girocliente = ?, "
		." tlfcliente = ?, "
		." id_provincia = ?, "
		." id_departamento = ?, "
		." direccliente = ?, "
		." emailcliente = ?, "
		." limitecredito = ?, "
		." codsucursal = ? "
		." WHERE "
		." codcliente = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipocliente);
	    $stmt->bindParam(2, $documcliente);
		$stmt->bindParam(3, $dnicliente);
		$stmt->bindParam(4, $nomcliente);
		$stmt->bindParam(5, $razoncliente);
		$stmt->bindParam(6, $girocliente);
		$stmt->bindParam(7, $tlfcliente);
		$stmt->bindParam(8, $id_provincia);
		$stmt->bindParam(9, $id_departamento);
		$stmt->bindParam(10, $direccliente);
		$stmt->bindParam(11, $emailcliente);
		$stmt->bindParam(12, $limitecredito);
		$stmt->bindParam(13, $codsucursal);
		$stmt->bindParam(14, $codcliente);
		
		$documcliente = limpiar($_POST['documcliente'] == '' ? "0" : $_POST['documcliente']);
		$dnicliente = limpiar($_POST["dnicliente"]);
		$nomcliente = limpiar($_POST['tipocliente'] == 'NATURAL' ? $_POST["nomcliente"] : "");
		$razoncliente = limpiar($_POST['tipocliente'] == 'NATURAL' ? "" : $_POST["razoncliente"]);
		$girocliente = limpiar($_POST['tipocliente'] == 'NATURAL' ? "" : $_POST["girocliente"]);
		$tlfcliente = limpiar($_POST["tlfcliente"]);
		$id_provincia = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direccliente = limpiar($_POST["direccliente"]);
		$emailcliente = limpiar($_POST["emailcliente"]);
		$tipocliente = limpiar($_POST["tipocliente"]);
		$limitecredito = limpiar($_POST["limitecredito"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$codcliente = limpiar(decrypt($_POST["codcliente"]));
		$stmt->execute();
    
	echo "<span class='fa fa-check-square-o'></span> EL CLIENTE HA SIDO ACTUALIZADO EXITOSAMENTE";
	exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR CLIENTES ############################

########################### FUNCION ELIMINAR CLIENTES #################################
public function EliminarClientes()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codcliente, codsucursal FROM ventas WHERE codcliente = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcliente"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM clientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcliente);
		$stmt->bindParam(2,$codsucursal);
		$codcliente = decrypt($_GET["codcliente"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR CLIENTES #################################

############################## FIN DE CLASE CLIENTES #################################


























################################## CLASE PROVEEDORES ###################################

########################## FUNCION CARGAR PROVEEDORES ###############################
public function CargarProveedores()
{
	self::SetNames();
	if(empty($_FILES["sel_file"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
    //Aquí es donde seleccionamos nuestro csv
    $fname = $_FILES['sel_file']['name'];
    //echo 'Cargando nombre del archivo: '.$fname.' ';
    $chk_ext = explode(".",$fname);
     
    if(strtolower(end($chk_ext)) == "csv"){

    //si es correcto, entonces damos permisos de lectura para subir
    $filename = $_FILES['sel_file']['tmp_name'];
    $handle = fopen($filename, "r");
    $this->dbh->beginTransaction();
    
    $primera = true;
    while (($data = fgetcsv($handle, 1000, ";")) !== FALSE) {
    // Evitamos la primer línea
    if ($primera){
      $primera = false;
      continue;
    }
	    ############## CREO CODIGO DE PROVEEDOR #################
		$sql = "SELECT codproveedor
		FROM proveedores
		ORDER BY idproveedor DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$proveedor = $row["codproveedor"];
		}
		$codproveedor = limpiar(empty($proveedor) ? "1" : $proveedor+1);
		############## CREO CODIGO DE PROVEEDOR #################

        //Insertamos los datos con los valores...   
		$query = "INSERT INTO proveedores values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codproveedor);
		$stmt->bindParam(2, $documproveedor);
		$stmt->bindParam(3, $dniproveedor);
		$stmt->bindParam(4, $nomproveedor);
		$stmt->bindParam(5, $tlfproveedor);
		$stmt->bindParam(6, $id_provincia);
		$stmt->bindParam(7, $id_departamento);
		$stmt->bindParam(8, $direcproveedor);
		$stmt->bindParam(9, $emailproveedor);
		$stmt->bindParam(10, $vendedor);
		$stmt->bindParam(11, $tlfvendedor);
		$stmt->bindParam(12, $fechaingreso);
		$stmt->bindParam(13, $codsucursal);

		$documproveedor  = limpiar($data[0]);
		$dniproveedor    = limpiar($data[1]);
		$nomproveedor    = utf8_encode($data[2]);
		$tlfproveedor    = limpiar($data[3]);
		$id_provincia    = limpiar($data[4]);
		$id_departamento = limpiar($data[5]);
		$direcproveedor  = utf8_encode($data[6]);
		$emailproveedor  = limpiar($data[7]);
		$vendedor        = utf8_encode($data[8]);
		$tlfvendedor     = limpiar($data[9]);
		$fechaingreso    = limpiar(date("Y-m-d"));
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

	   $codproveedor++;
    }
    $this->dbh->commit();
    //cerramos la lectura del archivo "abrir archivo" con un "cerrar archivo"
    fclose($handle);
	        
	   echo "<span class='fa fa-check-square-o'></span> LA CARGA MASIVA DE PROVEEDORES FUE REALIZADA EXITOSAMENTE";
	   exit;
    }
    else
    {
    //si aparece esto es posible que el archivo no tenga el formato adecuado, inclusive cuando es cvs, revisarlo para ver si esta separado por " , "
      echo "2";
		exit;
    }  
}
############################# FUNCION CARGAR PROVEEDORES ##############################

############################ FUNCION REGISTRAR PROVEEDORES ##########################
public function RegistrarProveedores()
{
	self::SetNames();
	if(empty($_POST["cuitproveedor"]) or empty($_POST["nomproveedor"]) or empty($_POST["direcproveedor"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	############## CREO CODIGO DE PROVEEDOR #################
	$sql = "SELECT codproveedor
	FROM proveedores
	ORDER BY idproveedor DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$proveedor = $row["codproveedor"];
	}
	$codproveedor = limpiar(empty($proveedor) ? "1" : $proveedor + 1);
	############## CREO CODIGO DE PROVEEDOR #################

	$sql = " SELECT cuitproveedor FROM proveedores WHERE cuitproveedor = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["cuitproveedor"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = " INSERT INTO proveedores values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codproveedor);
	    $stmt->bindParam(2, $documproveedor);
		$stmt->bindParam(3, $cuitproveedor);
		$stmt->bindParam(4, $nomproveedor);
		$stmt->bindParam(5, $tlfproveedor);
		$stmt->bindParam(6, $id_provincia);
		$stmt->bindParam(7, $id_departamento);
		$stmt->bindParam(8, $direcproveedor);
		$stmt->bindParam(9, $emailproveedor);
		$stmt->bindParam(10, $vendedor);
		$stmt->bindParam(11, $tlfvendedor);
		$stmt->bindParam(12, $fechaingreso);
		$stmt->bindParam(13, $codsucursal);
		
		$documproveedor  = limpiar($_POST['documproveedor'] == '' ? "0" : $_POST['documproveedor']);
		$cuitproveedor   = limpiar($_POST["cuitproveedor"]);
		$nomproveedor    = limpiar($_POST["nomproveedor"]);
		$tlfproveedor    = limpiar($_POST["tlfproveedor"]);
		$id_provincia    = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direcproveedor  = limpiar($_POST["direcproveedor"]);
		$emailproveedor  = limpiar($_POST["emailproveedor"]);
		$vendedor        = limpiar($_POST["vendedor"]);
		$tlfvendedor     = limpiar($_POST["tlfvendedor"]);
	    $fechaingreso    = limpiar(date("Y-m-d"));
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> EL PROVEEDOR HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################### FUNCION REGISTRAR PROVEEDORES ########################

########################### FUNCION LISTAR PROVEEDORES ################################
public function ListarProveedores()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		proveedores.codproveedor,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		proveedores.tlfproveedor,
		proveedores.id_provincia,
		proveedores.id_departamento,
		proveedores.direcproveedor,
		proveedores.emailproveedor,
		proveedores.vendedor,
		proveedores.tlfvendedor,
		proveedores.fechaingreso,
		proveedores.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2
		FROM proveedores 
		LEFT JOIN documentos ON proveedores.documproveedor = documentos.coddocumento
		LEFT JOIN provincias ON proveedores.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON proveedores.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON proveedores.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		WHERE (proveedores.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' OR proveedores.codsucursal = '0')
		ORDER BY proveedores.nomproveedor ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

	    $sql = "SELECT
		proveedores.codproveedor,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		proveedores.tlfproveedor,
		proveedores.id_provincia,
		proveedores.id_departamento,
		proveedores.direcproveedor,
		proveedores.emailproveedor,
		proveedores.vendedor,
		proveedores.tlfvendedor,
		proveedores.fechaingreso,
		proveedores.codsucursal,
	    documentos.documento,
		provincias.provincia,
		departamentos.departamento,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos2.documento AS documento2
		FROM proveedores 
		LEFT JOIN documentos ON proveedores.documproveedor = documentos.coddocumento
		LEFT JOIN provincias ON proveedores.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON proveedores.id_departamento = departamentos.id_departamento
		LEFT JOIN sucursales ON proveedores.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		WHERE (proveedores.codsucursal = '".limpiar($_SESSION["codsucursal"])."' OR proveedores.codsucursal = '0')
		ORDER BY proveedores.nomproveedor ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION LISTAR PROVEEDORES ################################

########################### FUNCION ID PROVEEDORES #################################
public function ProveedoresPorId()
{
	self::SetNames();
	$sql = "SELECT
	proveedores.codproveedor,
	proveedores.documproveedor,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	proveedores.tlfproveedor,
	proveedores.id_provincia,
	proveedores.id_departamento,
	proveedores.direcproveedor,
	proveedores.emailproveedor,
	proveedores.vendedor,
	proveedores.tlfvendedor,
	proveedores.fechaingreso,
    documentos.documento,
	provincias.provincia,
	departamentos.departamento,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos2.documento AS documento2
	FROM proveedores 
	LEFT JOIN documentos ON proveedores.documproveedor = documentos.coddocumento
	LEFT JOIN provincias ON proveedores.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON proveedores.id_departamento = departamentos.id_departamento
	LEFT JOIN sucursales ON proveedores.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	WHERE proveedores.codproveedor = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codproveedor"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PROVEEDORES #################################
	
############################ FUNCION ACTUALIZAR PROVEEDORES ############################
public function ActualizarProveedores()
	{
	self::SetNames();
	if(empty($_POST["codproveedor"]) or empty($_POST["cuitproveedor"]) or empty($_POST["nomproveedor"]) or empty($_POST["direcproveedor"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}
	$sql = " SELECT cuitproveedor FROM proveedores WHERE codproveedor != ? AND cuitproveedor = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codproveedor"]),$_POST["cuitproveedor"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE proveedores set "
		." documproveedor = ?, "
		." cuitproveedor = ?, "
		." nomproveedor = ?, "
		." tlfproveedor = ?, "
		." id_provincia = ?, "
		." id_departamento = ?, "
		." direcproveedor = ?, "
		." emailproveedor = ?, "
		." vendedor = ?, "
		." tlfvendedor = ?, "
		." codsucursal = ? "
		." WHERE "
		." codproveedor = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $documproveedor);
		$stmt->bindParam(2, $cuitproveedor);
		$stmt->bindParam(3, $nomproveedor);
		$stmt->bindParam(4, $tlfproveedor);
		$stmt->bindParam(5, $id_provincia);
		$stmt->bindParam(6, $id_departamento);
		$stmt->bindParam(7, $direcproveedor);
		$stmt->bindParam(8, $emailproveedor);
		$stmt->bindParam(9, $vendedor);
		$stmt->bindParam(10, $tlfvendedor);
		$stmt->bindParam(11, $codsucursal);
		$stmt->bindParam(12, $codproveedor);
		
		$documproveedor  = limpiar($_POST['documproveedor'] == '' ? "0" : $_POST['documproveedor']);
		$cuitproveedor   = limpiar($_POST["cuitproveedor"]);
		$nomproveedor    = limpiar($_POST["nomproveedor"]);
		$tlfproveedor    = limpiar($_POST["tlfproveedor"]);
		$id_provincia    = limpiar($_POST['id_provincia'] == '' ? "0" : $_POST['id_provincia']);
		$id_departamento = limpiar($_POST['id_departamento'] == '' ? "0" : $_POST['id_departamento']);
		$direcproveedor  = limpiar($_POST["direcproveedor"]);
		$emailproveedor  = limpiar($_POST["emailproveedor"]);
		$vendedor        = limpiar($_POST["vendedor"]);
		$tlfvendedor     = limpiar($_POST["tlfvendedor"]);
		$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
		$codproveedor    = limpiar(decrypt($_POST["codproveedor"]));
		$stmt->execute();
    
	   echo "<span class='fa fa-check-square-o'></span> EL PROVEEDOR HA SIDO ACTUALIZADO EXITOSAMENTE";
	   exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR PROVEEDORES ############################

########################## FUNCION ELIMINAR PROVEEDORES #################################
public function EliminarProveedores()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codproveedor, codsucursal FROM productos WHERE codproveedor = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codproveedor"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM proveedores WHERE codproveedor = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codproveedor);
		$stmt->bindParam(2,$codsucursal);
		$codproveedor = decrypt($_GET["codproveedor"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################### FUNCION ELIMINAR PROVEEDORES #########################

############################## FIN DE CLASE PROVEEDORES #################################


















###################################### CLASE PEDIDOS ###################################

############################ FUNCION REGISTRAR PEDIDOS #############################
public function RegistrarPedidos()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["codproveedor"]) or empty($_POST["txtTotal"]) or empty($_POST["fecharegistro"]))
	{
		echo "1";
		exit;
	}
	elseif(empty($_SESSION["CarritoPedido"]))
	{
		echo "2";
		exit;
	}
	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	codsucursal, 
	nroactividadsucursal, 
	iniciofactura 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nroactividad  = $row['nroactividadsucursal'];
	$iniciofactura = $row['iniciofactura'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE PEDIDO ####################
	$sql = "SELECT codpedido FROM pedidos 
	ORDER BY idpedido DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$pedido = $row["codpedido"];
	}
	if(empty($pedido))
	{
		$codpedido = "01";

	} else {

		$num         = substr($pedido, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codpedido   = $codigofinal;
	}
    ################ CREO CODIGO DE PEDIDO ###############

    ################### CREO CODIGO DE FACTURA ####################
	$sql = "SELECT codfactura FROM pedidos 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idpedido DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$factura=$row["codfactura"];
	}
	if(empty($pedido))
	{
		$codfactura = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = $var4;
	}
    ################### CREO CODIGO DE FACTURA ####################

    $query = "INSERT INTO pedidos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codpedido);
	$stmt->bindParam(2, $codfactura);
	$stmt->bindParam(3, $codproveedor);
	$stmt->bindParam(4, $subtotal);
	$stmt->bindParam(5, $subtotalexento);
	$stmt->bindParam(6, $subtotaliva);
	$stmt->bindParam(7, $iva);
	$stmt->bindParam(8, $totaliva);
	$stmt->bindParam(9, $descontado);
	$stmt->bindParam(10, $descuento);
	$stmt->bindParam(11, $totaldescuento);
	$stmt->bindParam(12, $totalpago);
	$stmt->bindParam(13, $observaciones);
	$stmt->bindParam(14, $fechapedido);
	$stmt->bindParam(15, $procesada);
	$stmt->bindParam(16, $codigo);
	$stmt->bindParam(17, $codsucursal);

	$codproveedor   = limpiar($_POST["codproveedor"]);
	$subtotal       = limpiar($_POST["txtsubtotal"]);
	$subtotalexento = limpiar($_POST["txtexento"]);
	$subtotaliva    = limpiar($_POST["txtsubtotaliva"]);
	$iva            = limpiar($_POST["iva"]);
	$totaliva       = limpiar($_POST["txtIva"]);
	$descontado     = limpiar($_POST["txtdescontado"]);
	$descuento      = limpiar($_POST["descuento"]);
	$totaldescuento = limpiar($_POST["txtDescuento"]);
	$totalpago      = limpiar($_POST["txtTotal"]);
	$observaciones  = limpiar($_POST["observaciones"]);
    $fechapedido    = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fecharegistro'])));
    $procesada      = limpiar("1");
	$codigo         = limpiar($_SESSION["codigo"]);
	$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	
	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoPedido"];
	for($i=0;$i<count($detalle);$i++){

		$query = "INSERT INTO detallepedidos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpedido);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioxmayor);
		$stmt->bindParam(15, $precioxmenor);
		$stmt->bindParam(16, $precioxpublico);
	    $stmt->bindParam(17, $posicionimpuesto);
	    $stmt->bindParam(18, $tipoimpuesto);
		$stmt->bindParam(19, $ivaproducto);
		$stmt->bindParam(20, $descproducto);
		$stmt->bindParam(21, $descfactura);
		$stmt->bindParam(22, $valortotal);
		$stmt->bindParam(23, $totaldescuentoc);
		$stmt->bindParam(24, $subtotalimpuestos);
		$stmt->bindParam(25, $valorneto);
		$stmt->bindParam(26, $codsucursal);
			
	    $idproducto      = limpiar($detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	    $condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]['descproductofact']/100;
		$valortotal      = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($_POST["iva"]/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
    }
        
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoPedido"]);
    $this->dbh->commit();

	echo "<span class='fa fa-check-square-o'></span> EL PEDIDO DE PRODUCTOS AL PROVEEDOR HA SIDO REGISTRADO EXITOSAMENTE";
	echo "<script>VentanaCentrada('reportepdf?codpedido=".encrypt($codpedido)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt("FACTURAPEDIDO")."', '', '', '1024', '568', 'true');</script>";
	exit;
}
############################ FUNCION REGISTRAR PEDIDOS ###############################

########################### FUNCION LISTAR PEDIDOS ################################
public function ListarPedidos()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		pedidos.codpedido, 
		pedidos.codfactura,
		pedidos.codproveedor,  
		pedidos.subtotal,
		pedidos.subtotalexento, 
		pedidos.subtotaliva, 
		pedidos.iva, 
		pedidos.totaliva, 
		pedidos.descontado, 
		pedidos.descuento, 
		pedidos.totaldescuento, 
		pedidos.totalpago,
		pedidos.observaciones, 
		pedidos.fechapedido,
		pedidos.procesada, 
		pedidos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(detallepedidos.cantidad) AS articulos 
		FROM (pedidos LEFT JOIN detallepedidos ON detallepedidos.codpedido = pedidos.codpedido) 
		LEFT JOIN sucursales ON pedidos.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON pedidos.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON pedidos.codigo = usuarios.codigo
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	    WHERE pedidos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		GROUP BY detallepedidos.codpedido 
		ORDER BY pedidos.idpedido ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT 
		pedidos.codpedido, 
		pedidos.codfactura,
		pedidos.codproveedor,  
		pedidos.subtotal,
		pedidos.subtotalexento, 
		pedidos.subtotaliva, 
		pedidos.iva, 
		pedidos.totaliva, 
		pedidos.descontado, 
		pedidos.descuento, 
		pedidos.totaldescuento, 
		pedidos.totalpago,
		pedidos.observaciones, 
		pedidos.fechapedido,
		pedidos.procesada, 
		pedidos.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(detallepedidos.cantidad) AS articulos 
		FROM (pedidos LEFT JOIN detallepedidos ON detallepedidos.codpedido = pedidos.codpedido) 
		LEFT JOIN sucursales ON pedidos.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON pedidos.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON pedidos.codigo = usuarios.codigo 
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE pedidos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY detallepedidos.codpedido 
		ORDER BY pedidos.idpedido ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################# FUNCION LISTAR PEDIDOS ############################

############################ FUNCION ID PEDIDOS #################################
public function PedidosPorId()
{
	self::SetNames();
	$sql = "SELECT 
	pedidos.codpedido, 
	pedidos.codfactura,
	pedidos.codproveedor,  
	pedidos.subtotal,
	pedidos.subtotalexento, 
	pedidos.subtotaliva, 
	pedidos.iva, 
	pedidos.totaliva, 
	pedidos.descontado, 
	pedidos.descuento, 
	pedidos.totaldescuento, 
	pedidos.totalpago,
	pedidos.observaciones, 
	pedidos.fechapedido,
	pedidos.procesada, 
	pedidos.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
    proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,  
	proveedores.id_provincia AS id_provincia2,
	proveedores.id_departamento AS id_departamento2, 
	proveedores.direcproveedor, 
	proveedores.emailproveedor,  
	proveedores.vendedor,
	proveedores.tlfvendedor,
    documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3, 
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	pag.articulos
	FROM (pedidos INNER JOIN sucursales ON pedidos.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON proveedores.codproveedor = pedidos.codproveedor
    LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON proveedores.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON proveedores.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON pedidos.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   codpedido,
	   SUM(detallepedidos.cantidad) AS articulos
	   FROM detallepedidos
	   WHERE detallepedidos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detallepedidos.codpedido) pag ON pag.codpedido = pedidos.codpedido

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE pedidos.codpedido = ? AND pedidos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpedido"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PEDIDOS #################################
	
########################### FUNCION VER DETALLES PEDIDOS ###########################
public function VerDetallesPedidos()
{
	self::SetNames();
	$sql = "SELECT
	detallepedidos.coddetallepedido,
	detallepedidos.codpedido,
	detallepedidos.idproducto,
	detallepedidos.codproducto,
	detallepedidos.producto,
	detallepedidos.descripcion,
	detallepedidos.imei,
	detallepedidos.condicion,
	detallepedidos.codmarca,
	detallepedidos.codmodelo,
	detallepedidos.codpresentacion,
	detallepedidos.codcolor,
	detallepedidos.preciocompra,
	detallepedidos.precioxmayor,
	detallepedidos.precioxmenor,
	detallepedidos.precioxpublico,
	detallepedidos.cantidad,
	detallepedidos.posicionimpuesto,
	detallepedidos.tipoimpuesto,
	detallepedidos.ivaproducto,
	detallepedidos.descproducto,
	detallepedidos.descfactura,
	detallepedidos.valortotal, 
	detallepedidos.totaldescuentoc,
	detallepedidos.subtotalimpuestos,
	detallepedidos.valorneto,
	detallepedidos.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallepedidos 
	LEFT JOIN marcas ON detallepedidos.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallepedidos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detallepedidos.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallepedidos.codcolor = colores.codcolor
	WHERE detallepedidos.codpedido = ? 
	AND detallepedidos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpedido"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION VER DETALLES PEDIDOS ############################

########################### FUNCION ACTUALIZAR PEDIDOS #############################
public function ActualizarPedidos()
{
	self::SetNames();
	if(empty($_POST["codpedido"]) or empty($_POST["codsucursal"]) or empty($_POST["codproveedor"]) or empty($_POST["fechapedido"]))
	{
		echo "1";
		exit;
	}
	for($i=0;$i<count($_POST['coddetallepedido']);$i++){  //recorro el array
        if (!empty($_POST['coddetallepedido'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
    }

    $this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['coddetallepedido']);$i++){  //recorro el array
	    if (!empty($_POST['coddetallepedido'][$i])) {

			################## OBTENGO CANTIDAD DE DETALLE ##################
			$sql = "SELECT cantidad FROM detallepedidos 
		    WHERE coddetallepedido = '".limpiar($_POST['coddetallepedido'][$i])."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$cantidadBD = number_format($row['cantidad'], 2, '.', '');
			################## OBTENGO CANTIDAD DE DETALLE ##################

	        if($cantidadBD != $_POST['cantidad'][$i]){

			################### ACTUALIZO DETALLES PEDIDOS ###################
			$query = "UPDATE detallepedidos set"
			." cantidad = ?, "
			." valortotal = ?, "
			." totaldescuentoc = ?, "
			." subtotalimpuestos = ?, "
			." valorneto = ? "
			." WHERE "
			." coddetallepedido = ? AND codpedido = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $cantidad);
			$stmt->bindParam(2, $valortotal);
			$stmt->bindParam(3, $totaldescuento);
			$stmt->bindParam(4, $subtotalimpuestos);
			$stmt->bindParam(5, $valorneto);
			$stmt->bindParam(6, $coddetallepedido);
			$stmt->bindParam(7, $codpedido);
			$stmt->bindParam(8, $codsucursal);

			$cantidad          = limpiar($_POST['cantidad'][$i], 2, '.', '');
			$preciocompra      = limpiar($_POST['preciocompra'][$i]);
			$ivaproducto       = limpiar($_POST['ivaproducto'][$i]);
			$descuento         = $_POST['descfactura'][$i]/100;
			$valortotal        = number_format($_POST['valortotal'][$i], 2, '.', '');
			$totaldescuento    = number_format($_POST['totaldescuentoc'][$i], 2, '.', '');
			$subtotalimpuestos = number_format($_POST['subtotalimpuestos'][$i], 2, '.', '');
			$valorneto         = number_format($_POST['valorneto'][$i], 2, '.', '');
			$coddetallepedido  = limpiar($_POST['coddetallepedido'][$i]);
			$codpedido         = limpiar(decrypt($_POST["codpedido"]));
			$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			################### ACTUALIZO DETALLES PEDIDOS ###################

		} else {

                echo "";

	        }
        }
    }
    $this->dbh->commit();

   ############ ACTUALIZO LOS TOTALES EN PEDIDO ##############
	$sql = " UPDATE pedidos SET "
	." codproveedor = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "	
	." observaciones = ?, "
	." fechapedido = ? "
	." WHERE "
	." codpedido = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $codproveedor);
	$stmt->bindParam(2, $subtotal);
	$stmt->bindParam(3, $subtotalexento);
	$stmt->bindParam(4, $subtotaliva);
	$stmt->bindParam(5, $totaliva);
	$stmt->bindParam(6, $descontado);
	$stmt->bindParam(7, $descuento);
	$stmt->bindParam(8, $totaldescuento);
	$stmt->bindParam(9, $totalpago);
	$stmt->bindParam(10, $observaciones);
	$stmt->bindParam(11, $fechapedido);
	$stmt->bindParam(12, $codpedido);
	$stmt->bindParam(13, $codsucursal);

	$codproveedor    = limpiar($_POST["codproveedor"]);
	$subtotal        = number_format($_POST["txtsubtotal"], 2, '.', '');
	$subtotalexento  = number_format($_POST["txtexento"], 2, '.', '');
	$subtotaliva     = number_format($_POST["txtsubtotaliva"], 2, '.', '');
	$totaliva        = number_format($_POST["txtIva"], 2, '.', '');
	$descontado      = number_format($_POST["txtdescontado"], 2, '.', '');
	$descuento       = limpiar($_POST["descuento"]);
    $totaldescuento  = number_format($_POST["txtDescuento"], 2, '.', '');
    $totalpago       = number_format($_POST["txtTotal"], 2, '.', '');
	$observaciones   = limpiar($_POST["observaciones"]);
	$fechapedido     = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fechapedido'])));
	$codpedido       = limpiar(decrypt($_POST["codpedido"]));
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	############ ACTUALIZO LOS TOTALES EN PEDIDO ##############

	echo "<span class='fa fa-check-square-o'></span> EL PEDIDO DE PRODUCTOS AL PROVEEDOR HA SIDO ACTUALIZADO EXITOSAMENTE";
	echo "<script>VentanaCentrada('reportepdf?codpedido=".encrypt($codpedido)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt("FACTURAPEDIDO")."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################### FUNCION ACTUALIZAR PEDIDOS ############################

########################### FUNCION AGREGAR DETALLES PEDIDOS ############################
public function AgregarDetallesPedidos()
{
	self::SetNames();
	if(empty($_POST["codpedido"]) or empty($_POST["codsucursal"]) or empty($_POST["codproveedor"]) or empty($_POST["fechapedido"]))
	{
		echo "1";
		exit;
	}
    elseif(empty($_SESSION["CarritoPedido"]))
	{
		echo "2";
		exit;
	}

	############ CONSULTO TOTAL ACTUAL DE PEDIDO ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM pedidos 
	WHERE codpedido = '".limpiar(decrypt($_POST["codpedido"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row['descuento'];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE PEDIDO ##############

	$this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoPedido"];
	for($i=0;$i<count($detalle);$i++){

	$sql = "SELECT * 
	FROM detallepedidos 
	WHERE codpedido = '".limpiar(decrypt($_POST['codpedido']))."' 
	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'  
	AND idproducto = '".limpiar($detalle[$i]['id'])."'
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0)
	{
        ############################ REGISTRO DETALLES DE PEDIDOS ############################
		$query = "INSERT INTO detallepedidos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpedido);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioxmayor);
		$stmt->bindParam(15, $precioxmenor);
		$stmt->bindParam(16, $precioxpublico);
	    $stmt->bindParam(17, $posicionimpuesto);
	    $stmt->bindParam(18, $tipoimpuesto);
		$stmt->bindParam(19, $ivaproducto);
		$stmt->bindParam(20, $descproducto);
		$stmt->bindParam(21, $descfactura);
		$stmt->bindParam(22, $valortotal);
		$stmt->bindParam(23, $totaldescuentoc);
		$stmt->bindParam(24, $subtotalimpuestos);
		$stmt->bindParam(25, $valorneto);
		$stmt->bindParam(26, $codsucursal);
			
	    $codpedido       = limpiar(decrypt($_POST["codpedido"]));
	    $idproducto      = limpiar($detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
		$condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]['descproductofact']/100;
		$valortotal      = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		############################ REGISTRO DETALLES DE PEDIDOS ############################

	} else {

		################## OBTENGO CANTIDAD DE DETALLE ##################
		$sql = "SELECT cantidad 
	  	FROM detallepedidos 
	  	WHERE codpedido = '".limpiar(decrypt($_POST['codpedido']))."' 
	  	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'
	  	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	  	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$cantidadBD = $row['cantidad'];
		################## OBTENGO CANTIDAD DE DETALLE ##################

	  	############################ ACTUALIZO DETALLES DE COMPRAS ############################
	  	$query = "UPDATE detallepedidos set"
		." cantidad = ?, "
		." descproducto = ?, "
		." descfactura = ?, "
		." valortotal = ?, "
		." totaldescuentoc = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ? "
		." WHERE "
		." codpedido = ? AND codsucursal = ? AND idproducto = ? AND codproducto = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $descproducto);
		$stmt->bindParam(3, $descfactura);
		$stmt->bindParam(4, $valortotal);
		$stmt->bindParam(5, $totaldescuentoc);
		$stmt->bindParam(6, $subtotalimpuestos);
		$stmt->bindParam(7, $valorneto);
		$stmt->bindParam(8, $codpedido);
		$stmt->bindParam(9, $codsucursal);
		$stmt->bindParam(10, $idproducto);
		$stmt->bindParam(11, $codproducto);

		$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidadBD);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]["descproductofact"]/100;
		$valortotal      = number_format($detalle[$i]['precio']*$cantidad, 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$codpedido   = limpiar(decrypt($_POST["codpedido"]));
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$idproducto  = limpiar($detalle[$i]['id']);
		$codproducto = limpiar($detalle[$i]['txtCodigo']);
		$stmt->execute();
		############################ ACTUALIZO DETALLES DE PEDIDOS ############################

	   }
    }    
   
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoPedido"]);
    $this->dbh->commit();

    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentoc) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto FROM detallepedidos WHERE codpedido = '".limpiar(decrypt($_POST["codpedido"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
     	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentoc) AS totaldescuentono, SUM(valorneto) AS valorneto FROM detallepedidos WHERE codpedido = '".limpiar(decrypt($_POST["codpedido"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ############ ACTUALIZO LOS TOTALES EN PEDIDO ##############
	$sql = " UPDATE pedidos SET "
	." codproveedor = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." observaciones = ?, "
	." fechapedido = ? "
	." WHERE "
	." codpedido = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $codproveedor);
	$stmt->bindParam(2, $TxtSubtotal);
	$stmt->bindParam(3, $TxtSubtotalExento);
	$stmt->bindParam(4, $TxtSubtotalIva);
	$stmt->bindParam(5, $TxtTotalIva);
	$stmt->bindParam(6, $TxtDescontado);
	$stmt->bindParam(7, $descuento);
	$stmt->bindParam(8, $TxtTotalDescuento);
	$stmt->bindParam(9, $TxtTotal);
	$stmt->bindParam(10, $observaciones);
	$stmt->bindParam(11, $fechapedido);
	$stmt->bindParam(12, $codpedido);
	$stmt->bindParam(13, $codsucursal);

	$codproveedor = limpiar($_POST["codproveedor"]);
	
	/*###################################################### CALCULO DE DESCUENTO ######################################################*/
    //PORCENTAJE DESCUENTO
	$descuento     = $_POST["descuento"]+$descuentoBD;
	$Porcentaje    = $descuento/100;

	//PORCENTAJE IVA
	$txtIva        = $ivaBD;
	$PorcentajeIva = $txtIva/100;

	/*OBTENGO DESCUENTO DE EXENTO*/
	$RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	$TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	/*OBTENGO SUBTOTAL IVA*/
	$RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	/*OBTENGO TOTAL IVA*/
	$TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	//CALCULO DE TOTAL FACTURA
	$TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	$TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	$TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	$TxtTotal          = number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', '');
	/*###################################################### CALCULO DE DESCUENTO ######################################################*/

	$observaciones  = limpiar($_POST["observaciones"]);
	$fechapedido    = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fechapedido'])));
	$codpedido      = limpiar(decrypt($_POST["codpedido"]));
	$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	############ ACTUALIZO LOS TOTALES EN PEDIDO ##############

	echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS AL PEDIDO EXITOSAMENTE <";
	echo "<script>VentanaCentrada('reportepdf?codpedido=".encrypt($codpedido)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt("FACTURAPEDIDO")."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################### FUNCION AGREGAR DETALLES PEDIDOS ############################

########################### FUNCION PROCESAR PEDIDOS A COMPRA ############################
public function ProcesarPedidos()
{
	self::SetNames();
	if(empty($_POST["codpedido"]) or empty($_POST["codproveedor"]) or empty($_POST["codsucursal"]) or empty($_POST["codfactura"]) or empty($_POST["fechaemision"]) or empty($_POST["fecharecepcion"]))
	{
		echo "1";
		exit;
	}
	for($i=0;$i<count($_POST['coddetallepedido']);$i++){  //recorro el array
        if (!empty($_POST['coddetallepedido'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
    }

	if (limpiar($_POST["tipocompra"]) == "CREDITO") { 

	    $fechaactual = date("Y-m-d");
	    $fechavence = date("Y-m-d",strtotime($_POST['fechavencecredito']));
	
        if (strtotime($fechavence) < strtotime($fechaactual)) {
  
            echo "3";
	        exit;
        }
    }

    $sql = "SELECT codfactura FROM compras WHERE codfactura = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST['codfactura'],decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		################ CREO CODIGO DE COMPRA ####################
		$sql = "SELECT codcompra FROM compras 
		ORDER BY idcompra DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$compra = $row["codcompra"];
		}
		if(empty($compra))
		{
			$codcompra = "01";

		} else {

			$num         = substr($compra, 0);
	        $dig         = $num + 1;
	        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
	        $codcompra   = $codigofinal;
		}
	    ################ CREO CODIGO DE COMPRA ###############

	    ############################ REGISTRO COMPRAS ############################
		$query = "INSERT INTO compras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $tipodocumento);
		$stmt->bindParam(3, $codfactura);
		$stmt->bindParam(4, $codproveedor);
		$stmt->bindParam(5, $subtotal);
		$stmt->bindParam(6, $subtotalexento);
		$stmt->bindParam(7, $subtotaliva);
		$stmt->bindParam(8, $iva);
		$stmt->bindParam(9, $totaliva);
		$stmt->bindParam(10, $descontado);
		$stmt->bindParam(11, $descuento);
		$stmt->bindParam(12, $totaldescuento);
		$stmt->bindParam(13, $totalpago);
		$stmt->bindParam(14, $gastoenvio);
		$stmt->bindParam(15, $creditopagado);
		$stmt->bindParam(16, $tipocompra);
		$stmt->bindParam(17, $formacompra);
		$stmt->bindParam(18, $fechavencecredito);
		$stmt->bindParam(19, $fechapagado);
		$stmt->bindParam(20, $statuscompra);
		$stmt->bindParam(21, $fechaemision);
		$stmt->bindParam(22, $fecharecepcion);
		$stmt->bindParam(23, $observaciones);
		$stmt->bindParam(24, $codigo);
		$stmt->bindParam(25, $codsucursal);
	   
		$tipodocumento     = limpiar($_POST["tipodocumento"]);
		$codfactura        = limpiar($_POST["codfactura"]);
		$codproveedor      = limpiar(decrypt($_POST["codproveedor"]));
		$subtotal          = limpiar($_POST["txtsubtotal"]);
		$subtotalexento    = limpiar($_POST["txtexento"]);
		$subtotaliva       = limpiar($_POST["txtsubtotaliva"]);
		$iva               = limpiar($_POST["iva"]);
		$totaliva          = limpiar($_POST["txtIva"]);
		$descontado        = limpiar($_POST["txtdescontado"]);
		$descuento         = limpiar($_POST["descuento"]);
		$totaldescuento    = limpiar($_POST["txtDescuento"]);
		$totalpago         = limpiar($_POST["txtTotal"]);
		$gastoenvio        = limpiar($_POST["gastoenvio"]);
		$creditopagado     = limpiar("0.00");
		$tipocompra        = limpiar($_POST["tipocompra"]);
		$formacompra       = limpiar($_POST["tipocompra"] == "CONTADO" ? $_POST["formacompra"] : "CREDITO");
		$fechavencecredito = limpiar($_POST["tipocompra"] == "CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
	    $fechapagado       = limpiar("0000-00-00");
		$statuscompra      = limpiar($_POST["tipocompra"] == "CONTADO" ? "PAGADA" : "PENDIENTE");
	    $fechaemision      = limpiar(date("Y-m-d",strtotime($_POST['fechaemision'])));
	    $fecharecepcion    = limpiar(date("Y-m-d",strtotime($_POST['fecharecepcion'])));
	    $observaciones     = limpiar($_POST["observaciones"]);
		$codigo            = limpiar($_SESSION["codigo"]);
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		############################ REGISTRO COMPRAS ############################

    $this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['coddetallepedido']);$i++){  //recorro el array
	    if (!empty($_POST['coddetallepedido'][$i])) {

			############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
			$sql = "SELECT * FROM productos 
			WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."' 
			AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$ivaproductoBD = $row['ivaproducto'];
		    $existenciaBD  = $row['existencia'];
			############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

			############################ REGISTRO DETALLES DE COMPRAS ############################
			$query = "INSERT INTO detallecompras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcompra);
		    $stmt->bindParam(2, $idproducto);
		    $stmt->bindParam(3, $codproducto);
		    $stmt->bindParam(4, $producto);
		    $stmt->bindParam(5, $descripcion);
		    $stmt->bindParam(6, $imei);
		    $stmt->bindParam(7, $condicion);
		    $stmt->bindParam(8, $codmarca);
		    $stmt->bindParam(9, $codmodelo);
		    $stmt->bindParam(10, $codpresentacion);
		    $stmt->bindParam(11, $codcolor);
			$stmt->bindParam(12, $preciocompra);
			$stmt->bindParam(13, $precioxmayor);
			$stmt->bindParam(14, $precioxmenor);
			$stmt->bindParam(15, $precioxpublico);
			$stmt->bindParam(16, $cantidad);
			$stmt->bindParam(17, $posicionimpuesto);
			$stmt->bindParam(18, $tipoimpuesto);
			$stmt->bindParam(19, $ivaproducto);
			$stmt->bindParam(20, $descproducto);
			$stmt->bindParam(21, $descfactura);
			$stmt->bindParam(22, $valortotal);
			$stmt->bindParam(23, $totaldescuentoc);
			$stmt->bindParam(24, $subtotalimpuestos);
			$stmt->bindParam(25, $valorneto);
			$stmt->bindParam(26, $lote);
			$stmt->bindParam(27, $fechaelaboracion);
			$stmt->bindParam(28, $fechaoptimo);
			$stmt->bindParam(29, $fechamedio);
			$stmt->bindParam(30, $fechaminimo);
			$stmt->bindParam(31, $stockoptimo);
			$stmt->bindParam(32, $stockmedio);
			$stmt->bindParam(33, $stockminimo);
			$stmt->bindParam(34, $codsucursal);
				
			$idproducto        = limpiar($_POST['idproducto'][$i]);
			$codproducto       = limpiar($_POST['codproducto'][$i]);
			$producto          = limpiar($_POST['producto'][$i]);
			$descripcion       = limpiar($_POST['descripcion'][$i]);
			$imei              = limpiar($_POST['imei'][$i]);
			$condicion         = limpiar($_POST['condicion'][$i]);
			$codmarca          = limpiar($_POST['codmarca'][$i]);
			$codmodelo         = limpiar($_POST['codmodelo'][$i]);
			$codpresentacion   = limpiar($_POST['codpresentacion'][$i]);
			$codcolor          = limpiar($_POST['codcolor'][$i]);
			$preciocompra      = limpiar($_POST['preciocompra'][$i]);
			$precioxmayor      = limpiar($_POST['precioxmayor'][$i]);
			$precioxmenor      = limpiar($_POST['precioxmenor'][$i]);
			$precioxpublico    = limpiar($_POST['precioxpublico'][$i]);
			$cantidad          = limpiar($_POST['cantidad'][$i]);
			$posicionimpuesto  = limpiar($_POST['posicionimpuesto'][$i]);
			$tipoimpuesto      = limpiar($_POST['tipoimpuesto'][$i]);
			$ivaproducto       = limpiar($_POST['ivaproducto'][$i]);
			$descproducto      = limpiar($_POST['descproducto'][$i]);
			$descfactura       = limpiar($_POST['descfactura'][$i]);
			$valortotal        = number_format($_POST['valortotal'][$i], 2, '.', '');
			$totaldescuentoc   = number_format($_POST['totaldescuentoc'][$i], 2, '.', '');
			$subtotalimpuestos = number_format($_POST['subtotalimpuestos'][$i], 2, '.', '');
			$valorneto         = number_format($_POST['valorneto'][$i], 2, '.', '');
			$lote              = limpiar($row['lote']);
			$fechaelaboracion  = limpiar($row['fechaelaboracion']);
			$fechaoptimo       = limpiar($row['fechaoptimo']);
			$fechamedio        = limpiar($row['fechamedio']);
			$fechaminimo       = limpiar($row['fechaminimo']);
			$stockoptimo       = limpiar($row['stockoptimo']);
			$stockmedio        = limpiar($row['stockmedio']);
			$stockminimo       = limpiar($row['stockminimo']);
			$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			############################ REGISTRO DETALLES DE COMPRAS ############################

			##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################
			$sql = "UPDATE productos set "
				." lote = ?, "
			    ." preciocompra = ?, "
				." precioxmayor = ?, "
				." precioxmenor = ?, "
				." precioxpublico = ?, "
				." existencia = ?, "
				." stockoptimo = ?, "
				." stockmedio = ?, "
				." stockminimo = ?, "
				." descproducto = ?, "
				." fechaelaboracion = ?, "
				." fechaoptimo = ?, "
				." fechamedio = ?, "
				." fechaminimo = ?, "
				." codproveedor = ? "
				." WHERE "
				." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $lote);
			$stmt->bindParam(2, $preciocompra);
			$stmt->bindParam(3, $precioxmayor);
			$stmt->bindParam(4, $precioxmenor);
			$stmt->bindParam(5, $precioxpublico);
			$stmt->bindParam(6, $existencia);
			$stmt->bindParam(7, $stockoptimo);
			$stmt->bindParam(8, $stockmedio);
			$stmt->bindParam(9, $stockminimo);
			//$stmt->bindParam(10, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $fechaelaboracion);
			$stmt->bindParam(12, $fechaoptimo);
			$stmt->bindParam(13, $fechamedio);
			$stmt->bindParam(14, $fechaminimo);
			$stmt->bindParam(15, $codproveedor);
			$stmt->bindParam(16, $idproducto);
			$stmt->bindParam(17, $codproducto);
			$stmt->bindParam(18, $codsucursal);
			
			$lote             = limpiar($row['lote']);
			$preciocompra     = limpiar($_POST['preciocompra'][$i]);
			$precioxmayor     = limpiar($_POST['precioxmayor'][$i]);
			$precioxmenor     = limpiar($_POST['precioxmenor'][$i]);
			$precioxpublico   = limpiar($_POST['precioxpublico'][$i]);
			$existencia       = limpiar($_POST['cantidad'][$i]+$existenciaBD);
			$stockoptimo      = limpiar($row['stockoptimo']);
			$stockmedio       = limpiar($row['stockmedio']);
			$stockminimo      = limpiar($row['stockminimo']);
			//$ivaproducto      = limpiar($_POST['ivaproducto'][$i]);
			$descproducto     = limpiar($_POST['descproducto'][$i]);
			$fechaelaboracion = limpiar($row['fechaelaboracion']);
			$fechaoptimo      = limpiar($row['fechaoptimo']);
			$fechamedio       = limpiar($row['fechamedio']);
			$fechaminimo      = limpiar($row['fechaminimo']);
			$codproveedor     = limpiar(decrypt($_POST['codproveedor']));
			$idproducto       = limpiar($_POST['idproducto'][$i]);
			$codproducto      = limpiar($_POST['codproducto'][$i]);
			$codsucursal      = limpiar(decrypt($_POST['codsucursal']));
			$stmt->execute();
			##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################

			##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
		    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcompra);
			$stmt->bindParam(2, $codproveedor);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
			$stmt->bindParam(15, $procedimiento);		
			$stmt->bindParam(16, $codsucursal);
			$stmt->bindParam(17, $codigo);

			$codproveedor  = limpiar(decrypt($_POST["codproveedor"]));
			$codproducto   = limpiar($_POST['codproducto'][$i]);
			$movimiento    = limpiar("ENTRADAS");
			$entradas      = limpiar($_POST['cantidad'][$i]);
			$salidas       = limpiar("0.00");
			$devolucion    = limpiar("0.00");
			$stockactual   = limpiar($_POST['cantidad'][$i]+$existenciaBD);
			$precio        = limpiar($_POST['preciocompra'][$i]);
			$ivaproducto   = limpiar($_POST['ivaproducto'][$i] == "0" ? "EXENTO" : $_POST['tipoimpuesto'][$i]." (".$_POST['ivaproducto'][$i]." %)");
			$descproducto  = limpiar($_POST['descproducto'][$i]);
			$documento     = limpiar("COMPRA (PEDIDO PROCESADO): ".$_POST['codfactura']);
			$fechakardex   = limpiar(date("Y-m-d H:i:s"));
			$tipokardex    = limpiar("1");
			$procedimiento = limpiar("1");
			$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
			$codigo        = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
        }
    }
    $this->dbh->commit();

    ##################### ACTUALIZO PEDIDO A PROCESADO ####################
	$sql = "UPDATE pedidos set "
	." procesada = ? "
	." WHERE "
	." codpedido = '".limpiar(decrypt($_POST["codpedido"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $procesada);

	$procesada = limpiar("0");
	$stmt->execute();
    ##################### ACTUALIZO PEDIDO A PROCESADO ####################

	   echo "<span class='fa fa-check-square-o'></span> LA COMPRA DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
       echo "<script>VentanaCentrada('reportepdf?codcompra=".encrypt($codcompra)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	   exit;
    }
	else
	{
		echo "4";
		exit;
	}
}
########################### FUNCION PROCESAR PEDIDOS A COMPRA ############################

########################## FUNCION ELIMINAR DETALLES PEDIDOS #########################
public function EliminarDetallesPedidos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	############ CONSULTO TOTAL ACTUAL DE PEDIDO ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM pedidos 
	WHERE codpedido = '".limpiar(decrypt($_GET["codpedido"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row["codfactura"];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row["descuento"];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE PEDIDO ##############

	$sql = "SELECT * FROM detallepedidos WHERE codpedido = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpedido"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		########## ELIMINAMOS EL PRODUCTO EN DETALLE DE PEDIDO ###########
		$sql = "DELETE FROM detallepedidos WHERE coddetallepedido = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetallepedido);
		$stmt->bindParam(2,$codsucursal);
		$coddetallepedido = decrypt($_GET["coddetallepedido"]);
		$codsucursal      = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		########## ELIMINAMOS EL PRODUCTO EN DETALLE DE PEDIDO ###########

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentoc) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto FROM detallepedidos WHERE codpedido = '".limpiar(decrypt($_GET["codpedido"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentoc) AS totaldescuentono, SUM(valorneto) AS valorneto FROM detallepedidos WHERE codpedido = '".limpiar(decrypt($_GET["codpedido"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

		############ ACTUALIZO LOS TOTALES EN PEDIDO ##############
		$sql = " UPDATE pedidos SET "
		." subtotal = ?, "
	    ." subtotalexento = ?, "
	    ." subtotaliva = ?, "
	    ." totaliva = ?, "
	    ." descontado = ?, "
	    ." totaldescuento = ?, "
	    ." totalpago = ?, "
		." WHERE "
		." codpedido = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $TxtTotal);
		$stmt->bindParam(8, $codpedido);
		$stmt->bindParam(9, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento     = $descuentoBD;
	    $Porcentaje    = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva        = $ivaBD;
	    $PorcentajeIva = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $TxtTotal          = ($exoneradoBD == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/
		$codpedido   = limpiar(decrypt($_GET["codpedido"]));
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN PEDIDO ##############

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
######################## FUNCION ELIMINAR DETALLES PEDIDOS #########################

######################### FUNCION ELIMINAR PEDIDOS ###############################
public function EliminarPedidos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

		#################### ELIMINO PEDIDO ####################
		$sql = "DELETE FROM pedidos WHERE codpedido = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpedido);
		$stmt->bindParam(2,$codsucursal);
		$codpedido   = decrypt($_GET["codpedido"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		#################### ELIMINO PEDIDO ####################

		#################### ELIMINO DETALLE DE PEDIDO ####################
		$sql = "DELETE FROM detallepedidos WHERE codpedido = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpedido);
		$stmt->bindParam(2,$codsucursal);
		$codpedido   = decrypt($_GET["codpedido"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		#################### ELIMINO DETALLE DE PEDIDO ####################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
####################### FUNCION ELIMINAR PEDIDOS #################################

###################### FUNCION BUSQUEDA PEDIDOS POR PROVEEDORES ######################
public function BuscarPedidosxProveedor() 
{
   self::SetNames();
	$sql = "SELECT 
	pedidos.codpedido, 
	pedidos.codfactura,
	pedidos.codproveedor,  
	pedidos.subtotal,
	pedidos.subtotalexento, 
	pedidos.subtotaliva, 
	pedidos.iva, 
	pedidos.totaliva, 
	pedidos.descontado, 
	pedidos.descuento, 
	pedidos.totaldescuento, 
	pedidos.totalpago,
	pedidos.observaciones, 
	pedidos.fechapedido,
	pedidos.procesada, 
	pedidos.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
    proveedores.documproveedor, 
	proveedores.codproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	proveedores.direcproveedor, 
	proveedores.vendedor, 
    documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3, 
	provincias.provincia, 
	departamentos.departamento,
	pag.articulos,
	pag.detalles_productos 
	FROM (pedidos LEFT JOIN sucursales ON pedidos.codsucursal = sucursales.codsucursal) 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON pedidos.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias ON proveedores.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON proveedores.id_departamento = departamentos.id_departamento

	LEFT JOIN
	    (SELECT
	    codpedido,
	    SUM(detallepedidos.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallepedidos.cantidad, ' | ', 
		 	detallepedidos.producto, ' | ', 
		   	detallepedidos.descripcion, ' | ',
		   	if(detallepedidos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallepedidos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallepedidos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallepedidos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallepedidos
			LEFT JOIN marcas ON detallepedidos.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallepedidos.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallepedidos.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallepedidos.codcolor = colores.codcolor
			WHERE detallepedidos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallepedidos.codpedido) pag ON pag.codpedido = pedidos.codpedido

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE pedidos.codsucursal = ? 
	AND pedidos.codproveedor = ? 
	GROUP BY pedidos.codpedido
	ORDER BY pedidos.codpedido ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"]),decrypt($_GET["codproveedor"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON PEDIDOS PARA EL PROVEEDOR SELECCIONADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA PEDIDOS POR PROVEEDORES ######################

###################### FUNCION BUSQUEDA PEDIDOS POR FECHAS ######################
public function BuscarPedidosxFechas() 
{
    self::SetNames();
	$sql = "SELECT 
	pedidos.codpedido, 
	pedidos.codfactura,
	pedidos.codproveedor,  
	pedidos.subtotal,
	pedidos.subtotalexento, 
	pedidos.subtotaliva, 
	pedidos.iva, 
	pedidos.totaliva, 
	pedidos.descontado, 
	pedidos.descuento, 
	pedidos.totaldescuento, 
	pedidos.totalpago,
	pedidos.observaciones, 
	pedidos.fechapedido,
	pedidos.procesada, 
	pedidos.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
    proveedores.documproveedor, 
	proveedores.codproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	proveedores.direcproveedor, 
	proveedores.vendedor, 
    documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3, 
	provincias.provincia, 
	departamentos.departamento,
	pag.articulos,
	pag.detalles_productos 
	FROM (pedidos LEFT JOIN sucursales ON pedidos.codsucursal = sucursales.codsucursal) 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON pedidos.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias ON proveedores.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON proveedores.id_departamento = departamentos.id_departamento

	LEFT JOIN
	    (SELECT
	    codpedido,
	    SUM(detallepedidos.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallepedidos.cantidad, ' | ', 
		 	detallepedidos.producto, ' | ', 
		   	detallepedidos.descripcion, ' | ',
		   	if(detallepedidos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallepedidos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallepedidos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallepedidos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallepedidos
			LEFT JOIN marcas ON detallepedidos.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallepedidos.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallepedidos.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallepedidos.codcolor = colores.codcolor
			WHERE detallepedidos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallepedidos.codpedido) pag ON pag.codpedido = pedidos.codpedido

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE pedidos.codsucursal = ? 
	AND DATE_FORMAT(pedidos.fechapedido,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY pedidos.codpedido
	ORDER BY pedidos.codpedido ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON PEDIDOS PARA EL PROVEEDOR SELECCIONADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA PEDIDOS POR FECHAS ######################

############################# FIN DE CLASE PEDIDOS #################################


























################################# CLASE PRODUCTOS ######################################

############################### FUNCION CARGAR PRODUCTOS ##############################
public function CargarProductos()
{
	self::SetNames();
	if(empty($_FILES["sel_file"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	############## OBTENGO VALOR DE IMPUESTO #################
	$sql = "SELECT
	codimpuesto,
	nomimpuesto, 
	valorimpuesto
	FROM impuestos 
	WHERE codsucursal = '".decrypt($_POST["codsucursal"])."'
	AND statusimpuesto = 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codimpuestoDef  = (empty($row['codimpuesto']) ? "0" : $row['codimpuesto']);
	$nomimpuesto     = (empty($row['nomimpuesto']) ? "" : $row['nomimpuesto']);
	$valorimpuesto   = (empty($row['valorimpuesto']) ? "0.00" : $row['valorimpuesto']);
	############## OBTENGO VALOR DE IMPUESTO #################

    // Seleccionamos el archivo CSV
    $fname = $_FILES['sel_file']['name'];
    $chk_ext = explode(".",$fname);
     
    if(strtolower(end($chk_ext)) == "csv")
    {
    // Damos permisos de lectura
    $filename = $_FILES['sel_file']['tmp_name'];
    $handle = fopen($filename, "r");
    $this->dbh->beginTransaction();
    
    $primera = true;
    $linea = 0;
    while (($data = fgetcsv($handle, 1000, ";")) !== FALSE) {
    $linea++;
    // Evitamos la primer línea (encabezados)
    if ($primera){
      $primera = false;
      continue;
    }
    
    // Validar que tenga al menos los campos requeridos
    if (count($data) < 12) {
        $this->dbh->rollBack();
        fclose($handle);
        echo "Error en línea $linea: Faltan campos. Se requieren 12 columnas.";
        exit;
    }

    // ========== PLANTILLA SIMPLIFICADA ==========
    // Columnas: CODIGO;NOMBRE;DESCRIPCION;COD_FAMILIA;COD_MARCA;PRECIO_COMPRA;PRECIO_VENTA;EXISTENCIA;COD_IVA;USA_INVENTARIO;TIPO_COMISION;COMISION_VENTA;CODIGO_BARRAS
    
    // Función para convertir decimales con coma a punto
    $convertirDecimal = function($valor) {
        $valor = trim($valor);
        if ($valor == '') return "0.00";
        // Reemplazar coma por punto para decimales
        $valor = str_replace(',', '.', $valor);
        return $valor;
    };
    
    $codproducto      = limpiar($data[0]);
    $producto         = utf8_encode($data[1]);
    $descripcion      = utf8_encode($data[2]);
    $codfamilia       = limpiar($data[3] == '' ? "1" : $data[3]);
    $codmarca         = limpiar($data[4] == '' ? "0" : $data[4]);
    $preciocompra     = limpiar($convertirDecimal($data[5]));
    $precioxpublico   = limpiar($convertirDecimal($data[6]));
    $existencia       = limpiar($convertirDecimal($data[7]));
    $ivaproducto      = limpiar($data[8] == '' ? "0" : $data[8]);
    $usa_inventario   = limpiar(strtoupper(trim($data[9])) == 'NO' ? "NO" : "SI");
    $tipo_comision    = limpiar(strtoupper(trim($data[10])));
    $comision_venta   = limpiar($convertirDecimal($data[11]));
    // Columna 13: CODIGO_BARRAS (opcional, si no viene usa el código del producto)
    $codigobarra      = isset($data[12]) && trim($data[12]) != '' ? limpiar($data[12]) : $codproducto;
    
    // Validar tipo_comision
    if (!in_array($tipo_comision, ['NINGUNA', 'PORCENTAJE', 'VALOR'])) {
        $tipo_comision = 'NINGUNA';
        $comision_venta = '0.00';
    }
    
    // Valores por defecto para campos no incluidos en plantilla simplificada
    $imei             = "";
    $condicion        = "NUEVO";
    $fabricante       = "";
    $codsubfamilia    = "0";
    $codmodelo        = "0";
    $codpresentacion  = "0";
    $codcolor         = "0";
    $codorigen        = "0";
    $year             = "0";
    $nroparte         = "0";
    $lote             = "0";
    $peso             = "0";
    $precioxmayor     = $precioxpublico;
    $precioxmenor     = $precioxpublico;
    $stockoptimo      = "0.00";
    $stockmedio       = "0.00";
    $stockminimo      = "0.00";
    $descproducto     = "0.00";
    $fechaelaboracion = "0000-00-00";
    $fechaoptimo      = "0000-00-00";
    $fechamedio       = "0000-00-00";
    $fechaminimo      = "0000-00-00";
    $codproveedor     = "0";
    $stockteorico     = "0";
    $motivoajuste     = "NINGUNO";
    $codsucursal      = limpiar(decrypt($_POST["codsucursal"]));
    $tipo_producto    = "SIMPLE";
    $producto_padre_id = null;
    $cantidad_conversion = "1.00";
    
    // Si es servicio, existencia debe ser 0
    if ($usa_inventario == 'NO') {
        $existencia = "0";
    }

    // INSERT con nombres de columnas explícitos para evitar problemas de orden
    $query = "INSERT INTO productos (
        codproducto, producto, descripcion, imei, condicion, fabricante,
        codfamilia, codsubfamilia, codmarca, codmodelo, codpresentacion, codcolor,
        codorigen, year, nroparte, lote, peso,
        preciocompra, precioxmayor, precioxmenor, precioxpublico,
        existencia, stockoptimo, stockmedio, stockminimo,
        ivaproducto, descproducto, tipo_comision, comision_venta,
        codigobarra, fechaelaboracion, fechaoptimo, fechamedio, fechaminimo,
        codproveedor, stockteorico, motivoajuste, codsucursal,
        tipo_producto, producto_padre_id, cantidad_conversion, usa_inventario
    ) VALUES (
        ?, ?, ?, ?, ?, ?,
        ?, ?, ?, ?, ?, ?,
        ?, ?, ?, ?, ?,
        ?, ?, ?, ?,
        ?, ?, ?, ?,
        ?, ?, ?, ?,
        ?, ?, ?, ?, ?,
        ?, ?, ?, ?,
        ?, ?, ?, ?
    )";
    $stmt = $this->dbh->prepare($query);
    $stmt->bindParam(1, $codproducto);
    $stmt->bindParam(2, $producto);
    $stmt->bindParam(3, $descripcion);
    $stmt->bindParam(4, $imei);
    $stmt->bindParam(5, $condicion);
    $stmt->bindParam(6, $fabricante);
    $stmt->bindParam(7, $codfamilia);
    $stmt->bindParam(8, $codsubfamilia);
    $stmt->bindParam(9, $codmarca);
    $stmt->bindParam(10, $codmodelo);
    $stmt->bindParam(11, $codpresentacion);
    $stmt->bindParam(12, $codcolor);
    $stmt->bindParam(13, $codorigen);
    $stmt->bindParam(14, $year);
    $stmt->bindParam(15, $nroparte);
    $stmt->bindParam(16, $lote);
    $stmt->bindParam(17, $peso);
    $stmt->bindParam(18, $preciocompra);
    $stmt->bindParam(19, $precioxmayor);
    $stmt->bindParam(20, $precioxmenor);
    $stmt->bindParam(21, $precioxpublico);
    $stmt->bindParam(22, $existencia);
    $stmt->bindParam(23, $stockoptimo);
    $stmt->bindParam(24, $stockmedio);
    $stmt->bindParam(25, $stockminimo);
    $stmt->bindParam(26, $ivaproducto);
    $stmt->bindParam(27, $descproducto);
    $stmt->bindParam(28, $tipo_comision);
    $stmt->bindParam(29, $comision_venta);
    $stmt->bindParam(30, $codigobarra);
    $stmt->bindParam(31, $fechaelaboracion);
    $stmt->bindParam(32, $fechaoptimo);
    $stmt->bindParam(33, $fechamedio);
    $stmt->bindParam(34, $fechaminimo);
    $stmt->bindParam(35, $codproveedor);
    $stmt->bindParam(36, $stockteorico);
    $stmt->bindParam(37, $motivoajuste);
    $stmt->bindParam(38, $codsucursal);
    $stmt->bindParam(39, $tipo_producto);
    $stmt->bindValue(40, $producto_padre_id, PDO::PARAM_NULL);
    $stmt->bindParam(41, $cantidad_conversion);
    $stmt->bindParam(42, $usa_inventario);
    $stmt->execute();

    // Solo registrar kardex si usa inventario y tiene existencia
    if ($usa_inventario == 'SI' && floatval($existencia) > 0) {
        $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
        $stmt = $this->dbh->prepare($query);
        $stmt->bindParam(1, $codproceso);
        $stmt->bindParam(2, $codresponsable);
        $stmt->bindParam(3, $codproductoK);
        $stmt->bindParam(4, $movimiento);
        $stmt->bindParam(5, $entradas);
        $stmt->bindParam(6, $salidas);
        $stmt->bindParam(7, $devolucion);
        $stmt->bindParam(8, $stockactual);
        $stmt->bindParam(9, $ivaproductoK);
        $stmt->bindParam(10, $descproductoK);
        $stmt->bindParam(11, $precio);
        $stmt->bindParam(12, $documento);
        $stmt->bindParam(13, $fechakardex);
        $stmt->bindParam(14, $tipokardex);
        $stmt->bindParam(15, $procedimiento);
        $stmt->bindParam(16, $codsucursalK);
        $stmt->bindParam(17, $codigo);
        
        $codproceso     = $codproducto;
        $codresponsable = "0";
        $codproductoK   = $codproducto;
        $movimiento     = "ENTRADAS";
        $entradas       = $existencia;
        $salidas        = "0.00";
        $devolucion     = "0.00";
        $stockactual    = $existencia;
        $ivaproductoK   = ($ivaproducto == '0' ? "EXENTO" : $nomimpuesto." (".$valorimpuesto." %)");
        $descproductoK  = "0.00";
        $precio         = "0.00";
        $documento      = "INVENTARIO INICIAL (CARGA MASIVA)";
        $fechakardex    = date("Y-m-d H:i:s");
        $tipokardex     = "1";
        $procedimiento  = "1";
        $codsucursalK   = $codsucursal;
        $codigo         = $_SESSION["codigo"];
        $stmt->execute();
    }
   }
           
   $this->dbh->commit();
   fclose($handle);
	        
   echo "<span class='fa fa-check-square-o'></span> LA CARGA MASIVA DE PRODUCTOS FUE REALIZADA EXITOSAMENTE";
   exit;
             
    }
    else
    {
        echo "2";
		exit;
    }  
}
############################## FUNCION CARGAR PRODUCTOS ##############################

########################### FUNCION REGISTRAR PRODUCTOS ###############################
public function RegistrarProductos()
{
	self::SetNames();
	if(empty($_POST["codproducto"]) or empty($_POST["producto"]) or empty($_POST["codfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	############## OBTENGO VALOR DE IMPUESTO #################
	$sql = "SELECT
	nomimpuesto, 
	valorimpuesto
	FROM impuestos 
	WHERE codsucursal = '".decrypt($_POST["codsucursal"])."'
	AND statusimpuesto = 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nomimpuesto   = (empty($row['nomimpuesto']) ? "" : $row['nomimpuesto']);
	$valorimpuesto = (empty($row['valorimpuesto']) ? "0.00" : $row['valorimpuesto']);
	############## OBTENGO VALOR DE IMPUESTO #################

	$sql = " SELECT codproducto FROM productos WHERE codproducto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codproducto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
	    ##################### REGISTRO DE PRODUCTO #####################
	    $query = "INSERT INTO productos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
    	$stmt = $this->dbh->prepare($query);
    	$stmt->bindParam(1, $codproducto);
    	$stmt->bindParam(2, $producto);
    	$stmt->bindParam(3, $descripcion);
    	$stmt->bindParam(4, $imei);
    	$stmt->bindParam(5, $condicion);
    	$stmt->bindParam(6, $fabricante);
    	$stmt->bindParam(7, $codfamilia);
    	$stmt->bindParam(8, $codsubfamilia);
    	$stmt->bindParam(9, $codmarca);
    	$stmt->bindParam(10, $codmodelo);
    	$stmt->bindParam(11, $codpresentacion);
    	$stmt->bindParam(12, $codcolor);
    	$stmt->bindParam(13, $codorigen);
    	$stmt->bindParam(14, $year);
    	$stmt->bindParam(15, $nroparte);
    	$stmt->bindParam(16, $lote);
    	$stmt->bindParam(17, $peso);
    	$stmt->bindParam(18, $preciocompra);
    	$stmt->bindParam(19, $precioxmayor);
    	$stmt->bindParam(20, $precioxmenor);
    	$stmt->bindParam(21, $precioxpublico);
    	$stmt->bindParam(22, $existencia);
    	$stmt->bindParam(23, $stockoptimo);
    	$stmt->bindParam(24, $stockmedio);
    	$stmt->bindParam(25, $stockminimo);
    	$stmt->bindParam(26, $ivaproducto);
    	$stmt->bindParam(27, $descproducto);
    	$stmt->bindParam(28, $tipo_comision);
    	$stmt->bindParam(29, $comision_venta);
    	$stmt->bindParam(30, $codigobarra);
    	$stmt->bindParam(31, $fechaelaboracion);
    	$stmt->bindParam(32, $fechaoptimo);
    	$stmt->bindParam(33, $fechamedio);
    	$stmt->bindParam(34, $fechaminimo);
    	$stmt->bindParam(35, $codproveedor);
    	$stmt->bindParam(36, $stockteorico);
    	$stmt->bindParam(37, $motivoajuste);
    	$stmt->bindParam(38, $codsucursal);
    	$stmt->bindParam(39, $tipo_producto);
    	// producto_padre_id se bindea después de asignar su valor para manejar NULL correctamente
    	$stmt->bindParam(41, $cantidad_conversion);
    	$stmt->bindParam(42, $usa_inventario);

		$codproducto      = limpiar($_POST["codproducto"]);
		$producto         = limpiar($_POST["producto"]);
		$descripcion      = limpiar($_POST["descripcion"]);
		$imei             = limpiar($_POST["imei"]);
		$condicion        = limpiar($_POST["condicion"]);
		$fabricante       = limpiar($_POST["modulo"] == 1 ? $_POST["fabricante"] : "");
		$codfamilia       = limpiar(decrypt($_POST["codfamilia"]));
		
		if(limpiar($_POST["modulo"]) == 1){
		$codsubfamilia    = limpiar($_POST['codsubfamilia'] == '' ? "0" : decrypt($_POST['codsubfamilia']));
		$codmarca         = limpiar($_POST['codmarca'] == '' ? "0" : decrypt($_POST['codmarca']));
		$codmodelo        = limpiar($_POST['codmodelo'] == '' ? "0" : decrypt($_POST['codmodelo']));
		$codpresentacion  = limpiar($_POST['codpresentacion'] == '' ? "0" : decrypt($_POST['codpresentacion']));
		$codcolor         = limpiar($_POST['codcolor'] == '' ? "0" : decrypt($_POST['codcolor']));
		$codorigen        = limpiar($_POST['codorigen'] == '' ? "0" : decrypt($_POST['codorigen']));
		$year             = limpiar($_POST["year"]);
		$nroparte         = limpiar($_POST["nroparte"]);
		$lote             = limpiar($_POST['lote'] == '' ? "0" : $_POST['lote']);
		$peso             = limpiar($_POST["peso"]);
		$fechaelaboracion = limpiar($_POST['fechaelaboracion'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaelaboracion'])));
		$fechaoptimo      = limpiar($_POST['fechaoptimo'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaoptimo'])));
		$fechamedio       = limpiar($_POST['fechamedio'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechamedio'])));
		$fechaminimo      = limpiar($_POST['fechaminimo'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaminimo'])));
		} else {
		$codsubfamilia    = limpiar("0");
		$codmarca         = limpiar($_POST['codmarca'] == '' ? "0" : decrypt($_POST['codmarca']));
		$codmodelo        = limpiar($_POST['codmodelo'] == '' ? "0" : decrypt($_POST['codmodelo']));
		$codpresentacion  = limpiar($_POST['codpresentacion'] == '' ? "0" : decrypt($_POST['codpresentacion']));
		$codcolor         = limpiar($_POST['codcolor'] == '' ? "0" : decrypt($_POST['codcolor']));	
		$codorigen        = limpiar("0");
		$year             = limpiar("0");
		$nroparte         = limpiar("0");
		$lote             = limpiar("0");
		$peso             = limpiar("0");
		$fechaelaboracion = limpiar("0000-00-00");
		$fechaoptimo      = limpiar("0000-00-00");
		$fechamedio       = limpiar("0000-00-00");
		$fechaminimo      = limpiar("0000-00-00");
		}

		$preciocompra     = limpiar($_POST["preciocompra"]);
		$precioxmayor     = limpiar($_POST["modulo"] == 1 ? $_POST["precioxmayor"] : "0.00");
		$precioxmenor     = limpiar($_POST["modulo"] == 1 ? $_POST["precioxmenor"] : "0.00");
		$precioxpublico   = limpiar($_POST["precioxpublico"]);
		$existencia       = limpiar($_POST["existencia"]);
		$stockoptimo      = limpiar($_POST["modulo"] == 1 ? $_POST["stockoptimo"] : "0.00");
		$stockmedio       = limpiar($_POST["modulo"] == 1 ? $_POST["stockmedio"] : "0.00");
		$stockminimo      = limpiar($_POST["modulo"] == 1 ? $_POST["stockminimo"] : "0.00");
		$ivaproducto      = limpiar(decrypt($_POST["ivaproducto"]));
		$descproducto     = limpiar($_POST["descproducto"]);
		$tipo_comision    = limpiar(isset($_POST["tipo_comision"]) ? $_POST["tipo_comision"] : "NINGUNA");
		$comision_venta   = limpiar(isset($_POST["comision_venta"]) ? $_POST["comision_venta"] : "0.00");
		$codigobarra      = limpiar($_POST["codigobarra"]);
		$codproveedor     = limpiar(decrypt($_POST["codproveedor"]));
		$stockteorico     = limpiar("0");
		$motivoajuste     = limpiar("NINGUNO");
		$codsucursal      = decrypt($_POST["codsucursal"]);
		
		// Campos para productos compuestos
		$tipo_producto    = limpiar(isset($_POST["tipo_producto"]) ? $_POST["tipo_producto"] : "SIMPLE");
		// Para producto_padre_id: si es HIJO y tiene valor, usar el ID; si no, usar NULL
		$producto_padre_id = ($tipo_producto == "HIJO" && !empty($_POST["producto_padre_id"])) ? limpiar(decrypt($_POST["producto_padre_id"])) : null;
		$cantidad_conversion = limpiar($tipo_producto == "HIJO" ? $_POST["cantidad_conversion"] : "1.00");
		
		// Campo para servicios (sin inventario)
		$usa_inventario = limpiar(isset($_POST["usa_inventario"]) ? $_POST["usa_inventario"] : "SI");
		
		// Bindear producto_padre_id con el tipo correcto (NULL o INT)
		if ($producto_padre_id === null) {
			$stmt->bindValue(40, null, PDO::PARAM_NULL);
		} else {
			$stmt->bindValue(40, $producto_padre_id, PDO::PARAM_INT);
		}
		
		// Si es producto HIJO o servicio sin inventario, forzar existencia a 0
		if ($tipo_producto == "HIJO" || $usa_inventario == "NO") {
			$existencia = "0.00";
		}
		
		$stmt->execute();
		##################### REGISTRO DE PRODUCTO #####################

		##################### REGISTRAMOS DATOS DE PRODUCTOS EN KARDEX #####################
		// Solo registrar kardex si NO es producto HIJO y SI usa inventario
		if ($tipo_producto != "HIJO" && $usa_inventario == "SI") {
		$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codproceso);
		$stmt->bindParam(2, $codresponsable);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);
		$stmt->bindParam(14, $tipokardex);
		$stmt->bindParam(15, $procedimiento);
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproceso     = limpiar($_POST['codproducto']);
		$codresponsable = limpiar("0");
		$codproducto    = limpiar($_POST['codproducto']);
		$movimiento     = limpiar("ENTRADAS");
		$entradas       = limpiar($_POST['existencia']);
		$salidas        = limpiar("0.00");
		$devolucion     = limpiar("0.00");
		$stockactual    = limpiar($_POST['existencia']);
		$ivaproducto    = limpiar(decrypt($_POST["ivaproducto"]) == '0' ? "EXENTO" : $nomimpuesto." (".$valorimpuesto." %)");
		$descproducto   = limpiar($_POST["descproducto"]);
		$precio         = limpiar("0.00");
		$documento      = limpiar("INVENTARIO INICIAL");
		$fechakardex    = limpiar(date("Y-m-d H:i:s"));
		$tipokardex     = limpiar("1");
		$procedimiento  = limpiar("1");
		$codsucursal    = decrypt($_POST["codsucursal"]);
    	$codigo         = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		} // Fin del IF - Solo registrar kardex si NO es producto HIJO
		##################### REGISTRAMOS DATOS DE PRODUCTOS EN KARDEX #####################

		############################## SUBIR FOTO DE PRODUCTO ##############################
		$dirmake        = limpiar(is_dir('./fotos/productos/'.$codsucursal) ? "" : mkdir('./fotos/productos/'.$codsucursal, 0777));
		$permitidos     = array("image/jpg", "image/jpeg", "image/png");
		$limite_kb      = 0;
	    //datos del arhivo  
	    $nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
		//$extension = pathinfo($nombre_archivo, PATHINFO_EXTENSION);
		$file           = new SplFileInfo($nombre_archivo);
		$extension      = $file->getExtension();
	    //compruebo si las características del archivo son las que deseo 
	    if(!empty($_FILES["imagen"]) && in_array($_FILES['imagen']['type'], $permitidos)){
	 
	       if (move_uploaded_file($_FILES['imagen']['tmp_name'], "./fotos/productos/".$codsucursal."/".$nombre_archivo) && rename("./fotos/productos/".$codsucursal."/".$nombre_archivo,"./fotos/productos/".$codsucursal."/".$codproducto.".".$extension))
		   { 
		   ## se puede dar un aviso
		   } 
		   ## se puede dar otro aviso 
		}
		############################## SUBIR FOTO DE PRODUCTO ##############################

		echo "<span class='fa fa-check-square-o'></span> EL PRODUCTO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################## FUNCION REGISTRAR PRODUCTOS ###############################

########################### FUNCION REGISTRAR NUEVO PRODUCTO ###############################
public function RegistrarNuevoProducto()
{
	self::SetNames();
	if(empty($_POST["codproducto2"]) or empty($_POST["producto2"]) or empty($_POST["codfamilia2"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	$sql = " SELECT codproducto FROM productos WHERE codproducto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codproducto2"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
	    ##################### REGISTRO DE PRODUCTO #####################
	    $query = "INSERT INTO productos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
    	$stmt = $this->dbh->prepare($query);
    	$stmt->bindParam(1, $codproducto);
    	$stmt->bindParam(2, $producto);
    	$stmt->bindParam(3, $descripcion);
    	$stmt->bindParam(4, $imei);
    	$stmt->bindParam(5, $condicion);
    	$stmt->bindParam(6, $fabricante);
    	$stmt->bindParam(7, $codfamilia);
    	$stmt->bindParam(8, $codsubfamilia);
    	$stmt->bindParam(9, $codmarca);
    	$stmt->bindParam(10, $codmodelo);
    	$stmt->bindParam(11, $codpresentacion);
    	$stmt->bindParam(12, $codcolor);
    	$stmt->bindParam(13, $codorigen);
    	$stmt->bindParam(14, $year);
    	$stmt->bindParam(15, $nroparte);
    	$stmt->bindParam(16, $lote);
    	$stmt->bindParam(17, $peso);
    	$stmt->bindParam(18, $preciocompra);
    	$stmt->bindParam(19, $precioxmayor);
    	$stmt->bindParam(20, $precioxmenor);
    	$stmt->bindParam(21, $precioxpublico);
    	$stmt->bindParam(22, $existencia);
    	$stmt->bindParam(23, $stockoptimo);
    	$stmt->bindParam(24, $stockmedio);
    	$stmt->bindParam(25, $stockminimo);
    	$stmt->bindParam(26, $ivaproducto);
    	$stmt->bindParam(27, $descproducto);
    	$stmt->bindParam(28, $codigobarra);
    	$stmt->bindParam(29, $fechaelaboracion);
    	$stmt->bindParam(30, $fechaoptimo);
    	$stmt->bindParam(31, $fechamedio);
    	$stmt->bindParam(32, $fechaminimo);
    	$stmt->bindParam(33, $codproveedor);
    	$stmt->bindParam(34, $stockteorico);
    	$stmt->bindParam(35, $motivoajuste);
    	$stmt->bindParam(36, $codsucursal);

		$codproducto      = limpiar($_POST["codproducto2"]);
		$producto         = limpiar($_POST["producto2"]);
		$descripcion      = limpiar($_POST["descripcion2"]);
		$imei             = limpiar($_POST["imei2"]);
		$condicion        = limpiar($_POST["condicion2"]);
		$fabricante       = limpiar("0");
		$codfamilia       = limpiar(decrypt($_POST["codfamilia2"]));
		$codsubfamilia    = limpiar("0");
		$codmarca         = limpiar(decrypt($_POST["codmarca2"]));
		$codmodelo        = limpiar($_POST['codmodelo2'] == '' ? "0" : decrypt($_POST['codmodelo2']));
		$codpresentacion  = limpiar($_POST['codpresentacion2'] == '' ? "0" : decrypt($_POST['codpresentacion2']));
		$codcolor         = limpiar($_POST['codcolor2'] == '' ? "0" : decrypt($_POST['codcolor2']));	
		$codorigen        = limpiar("0");
		$year             = limpiar("0");
		$nroparte         = limpiar("0");
		$lote             = limpiar("0");
		$peso             = limpiar("0");
		$preciocompra     = limpiar($_POST["preciocompra2"]);
		$precioxmayor     = limpiar("0.00");
		$precioxmenor     = limpiar("0.00");
		$precioxpublico   = limpiar($_POST["precioxpublico2"]);
		$existencia       = limpiar($_POST["existencia2"]);
		$stockoptimo      = limpiar("0.00");
		$stockmedio       = limpiar("0.00");
		$stockminimo      = limpiar("0.00");
		$ivaproducto      = limpiar(decrypt($_POST["ivaproducto2"]));
		$descproducto     = limpiar($_POST["descproducto2"]);
		$codigobarra      = limpiar($_POST["codigobarra2"]);
		$fechaelaboracion = limpiar("0000-00-00");
		$fechaoptimo      = limpiar("0000-00-00");
		$fechamedio       = limpiar("0000-00-00");
		$fechaminimo      = limpiar("0000-00-00");
		$codproveedor     = limpiar(decrypt($_POST["codproveedor2"]));
		$stockteorico     = limpiar("0");
		$motivoajuste     = limpiar("NINGUNO");
		$codsucursal      = decrypt($_POST["codsucursal"]);
		$stmt->execute();
		##################### REGISTRO DE PRODUCTO #####################

		echo "<span class='fa fa-check-square-o'></span> EL PRODUCTO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################## FUNCION REGISTRAR NUEVO PRODUCTO ###############################

########################### FUNCION LISTAR PRODUCTOS ################################
public function ListarProductos()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	provincias.provincia,
	departamentos.departamento
	FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE productos.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";	
	   //exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}

	} else {

    $sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	provincias.provincia,
	departamentos.departamento
	FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
   }
}
########################## FUNCION LISTAR PRODUCTOS ################################

########################### FUNCION LISTAR PRODUCTOS POR SUCURSAL ################################
public function ListarProductosxSucursales()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	provincias.provincia,
	departamentos.departamento
	FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE productos.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";	
	   //exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION LISTAR PRODUCTOS POR SUCURSAL ################################

########################### FUNCION LISTAR PRODUCTOS EN STOCK OPTIMO ################################
public function ListarProductosOptimo()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockoptimo AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockmedio AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockoptimo AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockmedio AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN STOCK OPTIMO ################################

########################### FUNCION LISTAR PRODUCTOS EN STOCK MEDIO ################################
public function ListarProductosMedio()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockmedio AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockminimo AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockmedio AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockminimo AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN STOCK MEDIO ################################

########################### FUNCION LISTAR PRODUCTOS EN STOCK MINIMO ################################
public function ListarProductosMinimo()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockminimo AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockminimo AS DECIMAL(10,2))";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN STOCK MINIMO ################################

########################### FUNCION LISTAR PRODUCTOS EN STOCK CERO ################################
public function ListarProductosCero()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) = 0)";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND CAST(productos.existencia AS DECIMAL(10,2)) = 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN STOCK CERO ################################

########################### FUNCION LISTAR PRODUCTOS EN FECHAS OPTIMO ################################
public function ListarProductosFechasOptimo()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND '".date("Y-m-d")."' <= DATE_FORMAT(productos.fechaoptimo,'%Y-%m-%d')
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND '".date("Y-m-d")."' <= DATE_FORMAT(productos.fechaoptimo,'%Y-%m-%d')
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN FECHAS OPTIMO ################################

########################### FUNCION LISTAR PRODUCTOS EN FECHAS MEDIO ################################
public function ListarProductosFechasMedio()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND '".date("Y-m-d")."' > DATE_FORMAT(productos.fechaoptimo,'%Y-%m-%d')
		AND '".date("Y-m-d")."' <= DATE_FORMAT(productos.fechamedio,'%Y-%m-%d')
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND '".date("Y-m-d")."' > DATE_FORMAT(productos.fechaoptimo,'%Y-%m-%d')
		AND '".date("Y-m-d")."' <= DATE_FORMAT(productos.fechamedio,'%Y-%m-%d')
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN FECHAS MEDIO ################################

########################### FUNCION LISTAR PRODUCTOS EN FECHAS MINIMO ################################
public function ListarProductosFechasMinimo()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {
		
	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		AND fechaminimo != '0000-00-00' 
		AND DATE_FORMAT(productos.fechaminimo,'%Y-%m-%d') <= '".date("Y-m-d")."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND fechaminimo != '0000-00-00' 
		AND DATE_FORMAT(productos.fechaminimo,'%Y-%m-%d') <= '".date("Y-m-d")."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR PRODUCTOS EN FECHAS MINIMO ################################

###################### FUNCION LISTAR PRECIOS POR CODIGO DE PRODUCTO #####################
public function BuscarPrecioProductoxCodigo() 
{
	self::SetNames();
	$sql = "SELECT GROUP_CONCAT('PRECIO MAYOR', '_', precioxmayor, '|', 'PRECIO MENOR', '_', precioxmenor, '|', 'PRECIO PUBLICO', '_', precioxpublico SEPARATOR '<br>') AS precioventa 
	FROM productos 
	WHERE idproducto = ? 
	AND codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["idproducto"]));
	$num = $stmt->rowCount();
	    if($num==0)
	{
		echo "<option value='' selected=''> -- SIN RESULTADOS -- </option>";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
##################### FUNCION LISTAR PRECIOS POR CODIGO PRODUCTO ######################

############################# FUNCION LISTAR PRODUCTOS EN VENTANA MODAL ################################
public function ListarProductosModal()
{
	self::SetNames();
	$sql = "SELECT 
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	CASE 
	    WHEN productos.tipo_producto = 'HIJO' AND productos.producto_padre_id IS NOT NULL 
	    THEN FLOOR(IFNULL(padre.existencia, 0) / IFNULL(productos.cantidad_conversion, 1))
	    ELSE productos.existencia 
	END AS existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codigobarra,
	productos.codsucursal,
	productos.tipo_producto,
	productos.producto_padre_id,
	productos.cantidad_conversion,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	familias.nomfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	sucursales.codmoneda,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo
	FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
    LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
    LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
    LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion 
    LEFT JOIN colores ON productos.codcolor = colores.codcolor
    LEFT JOIN productos AS padre ON productos.producto_padre_id = padre.idproducto
    WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
    AND (
        productos.usa_inventario = 'NO'
        OR productos.existencia != 0.00 
        OR (productos.tipo_producto = 'HIJO' AND productos.producto_padre_id IS NOT NULL AND padre.existencia > 0)
    )";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION LISTAR PRODUCTOS EN VENTANA MODAL ################################

########################## FUNCION LISTAR CODIGO DE BARRAS #########################
public function ListarCodigoBarra()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion, 
		productos.codigobarra, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal, 
		sucursales.nomencargado, 
		documentos.documento 
		FROM productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codigobarra != ''";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT 
	    productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion, 
		productos.codigobarra, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal, 
		sucursales.nomencargado, 
		documentos.documento 
		FROM productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento 
	    WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND productos.codigobarra != ''";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################ FUNCION LISTAR CODIGO DE BARRAS #########################

############################ FUNCION BUSCAR PRODUCTOS PADRE #################################
public function BuscarProductosPadre($codsucursal, $busqueda = '')
{
	self::SetNames();
	
	$sql = "SELECT 
		idproducto,
		codproducto,
		producto,
		tipo_producto,
		existencia,
		precioxpublico
	FROM productos 
	WHERE codsucursal = :codsucursal
	AND tipo_producto = 'PADRE'";
	
	if (!empty($busqueda)) {
		$sql .= " AND (producto LIKE :busqueda OR codproducto LIKE :busqueda2)";
	}
	
	$sql .= " ORDER BY producto ASC LIMIT 50";
	
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(':codsucursal', $codsucursal, PDO::PARAM_INT);
	
	if (!empty($busqueda)) {
		$busquedaLike = "%$busqueda%";
		$stmt->bindParam(':busqueda', $busquedaLike, PDO::PARAM_STR);
		$stmt->bindParam(':busqueda2', $busquedaLike, PDO::PARAM_STR);
	}
	
	$stmt->execute();
	$resultados = $stmt->fetchAll(PDO::FETCH_ASSOC);
	
	// Encriptar el idproducto para uso seguro en el frontend
	foreach ($resultados as &$row) {
		$row['idproducto'] = encrypt($row['idproducto']);
	}
	
	return $resultados;
}
############################ FIN FUNCION BUSCAR PRODUCTOS PADRE #########################

############################ FUNCION ID PRODUCTOS #################################
public function ProductosPorId()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	productos.tipo_producto,
	productos.producto_padre_id,
	productos.cantidad_conversion,
	productos.tipo_comision,
	productos.comision_venta,
	productos.usa_inventario,
	producto_padre.codproducto AS codproducto_padre,
	producto_padre.producto AS producto_padre_nombre,
	CONCAT(producto_padre.codproducto, ' - ', producto_padre.producto) AS producto_padre_nombre,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	provincias.provincia,
	departamentos.departamento
	FROM(productos LEFT JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN productos AS producto_padre ON productos.producto_padre_id = producto_padre.idproducto
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia 
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE productos.codproducto = ? 
	AND productos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codproducto"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PRODUCTOS #################################

############################ FUNCION ID PRODUCTOS PARA VERIFICADOR #################################
public function VerificadorProductosPorId()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.cuitproveedor,
	proveedores.nomproveedor,
	provincias.provincia,
	departamentos.departamento
	FROM(productos LEFT JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia 
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE productos.codigobarra = ? 
	AND productos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["barcode"]),decrypt($_GET["sucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PRODUCTOS PARA VERIFICADOR #################################

############################ FUNCION DETALLES PRODUCTOS #################################
public function DetallesProductoPorId()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	proveedores.cuitproveedor,
	proveedores.nomproveedor
	FROM(productos LEFT JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia 
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	WHERE productos.idproducto = ? 
	AND productos.codproducto = ? 
	AND productos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["d_id"]),limpiar($_GET["d_codigo"]),limpiar($_SESSION["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION DETALLES PRODUCTOS #################################

############################ FUNCION ACTUALIZAR PRODUCTOS ############################
public function ActualizarProductos()
{
	self::SetNames();
	if(empty($_POST["codproducto"]) or empty($_POST["producto"]) or empty($_POST["codfamilia"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	############## OBTENGO VALOR DE IMPUESTO #################
	$sql = "SELECT
	nomimpuesto, 
	valorimpuesto
	FROM impuestos 
	WHERE codsucursal = '".decrypt($_POST["codsucursal"])."'
	AND statusimpuesto = 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nomimpuesto   = (empty($row['nomimpuesto']) ? "" : $row['nomimpuesto']);
	$valorimpuesto = (empty($row['valorimpuesto']) ? "0.00" : $row['valorimpuesto']);
	############## OBTENGO VALOR DE IMPUESTO #################

	$sql = "SELECT codproducto FROM productos WHERE idproducto != ? AND codproducto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["idproducto"]),$_POST["codproducto"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		##################### ACTUALIZO LOS DATOS DE PRODUCTOS #####################
		$sql = "UPDATE productos set"
		." producto = ?, "
		." descripcion = ?, "
		." imei = ?, "
		." condicion = ?, "
		." fabricante = ?, "
		." codfamilia = ?, "
		." codsubfamilia = ?, "
		." codmarca = ?, "
		." codmodelo = ?, "
		." codpresentacion = ?, "
		." codcolor = ?, "
		." codorigen = ?, "
		." year = ?, "
		." nroparte = ?, "
		." lote = ?, "
		." peso = ?, "
		." preciocompra = ?, "
		." precioxmayor = ?, "
		." precioxmenor = ?, "
		." precioxpublico = ?, "
		." existencia = ?, "
		." stockoptimo = ?, "
		." stockmedio = ?, "
		." stockminimo = ?, "
		." ivaproducto = ?, "
		." descproducto = ?, "
		." tipo_comision = ?, "
		." comision_venta = ?, "
		." codigobarra = ?, "
		." fechaelaboracion = ?, "
		." fechaoptimo = ?, "
		." fechamedio = ?, "
		." fechaminimo = ?, "
		." codproveedor = ?, "
		." tipo_producto = ?, "
		." producto_padre_id = ?, "
		." cantidad_conversion = ?, "
		." usa_inventario = ? "
		." WHERE "
		." idproducto = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $producto);
		$stmt->bindParam(2, $descripcion);
		$stmt->bindParam(3, $imei);
		$stmt->bindParam(4, $condicion);
		$stmt->bindParam(5, $fabricante);
		$stmt->bindParam(6, $codfamilia);
		$stmt->bindParam(7, $codsubfamilia);
		$stmt->bindParam(8, $codmarca);
		$stmt->bindParam(9, $codmodelo);
		$stmt->bindParam(10, $codpresentacion);
		$stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $codorigen);
		$stmt->bindParam(13, $year);
		$stmt->bindParam(14, $nroparte);
		$stmt->bindParam(15, $lote);
		$stmt->bindParam(16, $peso);
		$stmt->bindParam(17, $preciocompra);
		$stmt->bindParam(18, $precioxmayor);
		$stmt->bindParam(19, $precioxmenor);
		$stmt->bindParam(20, $precioxpublico);
		$stmt->bindParam(21, $existencia);
		$stmt->bindParam(22, $stockoptimo);
		$stmt->bindParam(23, $stockmedio);
		$stmt->bindParam(24, $stockminimo);
		$stmt->bindParam(25, $ivaproducto);
		$stmt->bindParam(26, $descproducto);
		$stmt->bindParam(27, $tipo_comision);
		$stmt->bindParam(28, $comision_venta);
		$stmt->bindParam(29, $codigobarra);
		$stmt->bindParam(30, $fechaelaboracion);
		$stmt->bindParam(31, $fechaoptimo);
		$stmt->bindParam(32, $fechamedio);
		$stmt->bindParam(33, $fechaminimo);
		$stmt->bindParam(34, $codproveedor);
		$stmt->bindParam(35, $tipo_producto);
		// producto_padre_id se bindea después de asignar su valor para manejar NULL correctamente
		$stmt->bindParam(37, $cantidad_conversion);
		$stmt->bindParam(38, $usa_inventario);
		$stmt->bindParam(39, $idproducto);

		$producto         = limpiar($_POST["producto"]);
		$descripcion      = limpiar($_POST["descripcion"]);
		$imei             = limpiar($_POST["imei"]);
		$condicion        = limpiar($_POST["condicion"]);
		$fabricante       = limpiar($_POST["fabricante"]);
		$codfamilia       = limpiar(decrypt($_POST["codfamilia"]));
		$codsubfamilia    = limpiar($_POST['codsubfamilia'] == '' ? "0" : decrypt($_POST['codsubfamilia']));
		$codmarca         = limpiar($_POST['codmarca'] == '' ? "0" : decrypt($_POST['codmarca']));
		$codmodelo        = limpiar($_POST['codmodelo'] == '' ? "0" : decrypt($_POST['codmodelo']));
		$codpresentacion  = limpiar($_POST['codpresentacion'] == '' ? "0" : decrypt($_POST['codpresentacion']));
		$codcolor         = limpiar($_POST['codcolor'] == '' ? "0" : decrypt($_POST['codcolor']));
		$codorigen        = limpiar($_POST['codorigen'] == '' ? "0" : decrypt($_POST['codorigen']));
		$year             = limpiar($_POST["year"]);
		$nroparte         = limpiar($_POST["nroparte"]);
		$lote             = limpiar($_POST['lote'] == '' ? "0" : $_POST['lote']);
		$peso             = limpiar($_POST["peso"]);
		$preciocompra     = limpiar($_POST["preciocompra"]);
		$precioxmayor     = limpiar($_POST["precioxmayor"]);
		$precioxmenor     = limpiar($_POST["precioxmenor"]);
		$precioxpublico   = limpiar($_POST["precioxpublico"]);
		
		// Campos para productos compuestos
		$tipo_producto    = limpiar(isset($_POST["tipo_producto"]) ? $_POST["tipo_producto"] : "SIMPLE");
		// Para producto_padre_id: si es HIJO y tiene valor, usar el ID; si no, usar NULL
		$producto_padre_id = ($tipo_producto == "HIJO" && !empty($_POST["producto_padre_id"])) ? limpiar(decrypt($_POST["producto_padre_id"])) : null;
		$cantidad_conversion = limpiar($tipo_producto == "HIJO" ? $_POST["cantidad_conversion"] : "1.00");
		
		// Campo para servicios (sin inventario)
		$usa_inventario = limpiar(isset($_POST["usa_inventario"]) ? $_POST["usa_inventario"] : "SI");
		
		// Bindear producto_padre_id con el tipo correcto (NULL o INT)
		if ($producto_padre_id === null) {
			$stmt->bindValue(36, null, PDO::PARAM_NULL);
		} else {
			$stmt->bindValue(36, $producto_padre_id, PDO::PARAM_INT);
		}
		
		// Si es producto HIJO o servicio sin inventario, forzar existencia a 0
		$existencia       = limpiar(($tipo_producto == "HIJO" || $usa_inventario == "NO") ? "0.00" : $_POST["existencia"]);
		
		$stockoptimo      = limpiar($_POST["stockoptimo"]);
		$stockmedio       = limpiar($_POST["stockmedio"]);
		$stockminimo      = limpiar($_POST["stockminimo"]);
		$ivaproducto      = limpiar(decrypt($_POST["ivaproducto"]));
		$descproducto     = limpiar($_POST["descproducto"]);
		$tipo_comision    = limpiar(isset($_POST["tipo_comision"]) ? $_POST["tipo_comision"] : "NINGUNA");
		$comision_venta   = limpiar(isset($_POST["comision_venta"]) ? $_POST["comision_venta"] : "0.00");
		$codigobarra      = limpiar($_POST["codigobarra"]);
		$fechaelaboracion = limpiar($_POST['fechaelaboracion'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaelaboracion'])));
		$fechaoptimo      = limpiar($_POST['fechaoptimo'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaoptimo'])));
		$fechamedio       = limpiar($_POST['fechamedio'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechamedio'])));
		$fechaminimo      = limpiar($_POST['fechaminimo'] == '' ? "0000-00-00" : date("Y-m-d",strtotime($_POST['fechaminimo'])));
		$codproveedor     = limpiar(decrypt($_POST["codproveedor"]));
		$codproducto      = limpiar($_POST["codproducto"]);
		$idproducto       = limpiar(decrypt($_POST["idproducto"]));
		$codsucursal      = decrypt($_POST["codsucursal"]);
		$stmt->execute();
		##################### ACTUALIZO LOS DATOS DE PRODUCTOS #####################

	// Solo registrar kardex si NO es producto HIJO y si cambió la existencia
	if($tipo_producto != "HIJO" && $_POST['existencia'] != $_POST['existencia2']){

		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
		$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codproceso);
		$stmt->bindParam(2, $codresponsable);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);
		$stmt->bindParam(14, $tipokardex);
		$stmt->bindParam(15, $procedimiento);
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproceso     = limpiar($_POST['codproducto']);
		$codresponsable = limpiar("0");
		$codproducto    = limpiar($_POST['codproducto']);
		$movimiento     = limpiar($_POST['existencia'] > $_POST['existencia2'] ? "ENTRADAS" : "SALIDAS");
		$entradas       = limpiar($_POST['existencia'] > $_POST['existencia2'] ? $_POST['existencia']-$_POST['existencia2'] : '0');
		$salidas        = limpiar($_POST['existencia'] > $_POST['existencia2'] ? '0' : $_POST['existencia2']-$_POST['existencia']);
		$devolucion     = limpiar("0.00");
		$stockactual    = limpiar($_POST['existencia']);
		$ivaproducto    = limpiar(decrypt($_POST["ivaproducto"]) == '0' ? "EXENTO" : $nomimpuesto." (".$valorimpuesto." %)");
		$descproducto   = limpiar($_POST["descproducto"]);
		$precio         = limpiar("0.00");
		$documento      = limpiar("ACTUALIZACIÓN DE INVENTARIO");
		$fechakardex    = limpiar(date("Y-m-d H:i:s"));
		$tipokardex     = limpiar("1");
		$procedimiento  = limpiar("1");
		$codsucursal    = decrypt($_POST["codsucursal"]);
    	$codigo         = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
	}

    ############################## SUBIR FOTO DE PRODUCTO ##############################
	$dirmake        = limpiar(is_dir('./fotos/productos/'.$codsucursal) ? "" : mkdir('./fotos/productos/'.$codsucursal, 0777));
	$permitidos     = array("image/jpg", "image/jpeg", "image/png");
	$limite_kb      = 0;
    //datos del arhivo  
    $nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
	$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
	$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
	//$extension = pathinfo($nombre_archivo, PATHINFO_EXTENSION);
	$file           = new SplFileInfo($nombre_archivo);
	$extension      = $file->getExtension();
    //compruebo si las características del archivo son las que deseo 
    if(!empty($_FILES["imagen"]) && in_array($_FILES['imagen']['type'], $permitidos)){
 
       if (move_uploaded_file($_FILES['imagen']['tmp_name'], "./fotos/productos/".$codsucursal."/".$nombre_archivo) && rename("./fotos/productos/".$codsucursal."/".$nombre_archivo,"./fotos/productos/".$codsucursal."/".$codproducto.".".$extension))
	   { 
	   ## se puede dar un aviso
	   } 
	   ## se puede dar otro aviso 
	}
	############################## SUBIR FOTO DE PRODUCTO ##############################
        
	echo "<span class='fa fa-check-square-o'></span> EL PRODUCTO HA SIDO ACTUALIZADO EXITOSAMENTE";
	exit;

	} else {

		echo "2";
		exit;
	}
}
############################ FUNCION ACTUALIZAR PRODUCTOS ############################

########################## FUNCION AJUSTAR STOCK DE PRODUCTOS ###########################
public function ActualizarAjuste()
{
	self::SetNames();
	if(empty($_POST["codproducto"]) or empty($_POST["stockteorico"]) or empty($_POST["motivoajuste"]))
	{
		echo "1";
	   exit;
	}
	
	$sql = "UPDATE productos set"
		." stockteorico = ?, "
		." motivoajuste = ? "
		." WHERE "
		." idproducto = ?;
		";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $stockteorico);
	$stmt->bindParam(2, $motivoajuste);
    $stmt->bindParam(3, $idproducto);
	
	$stockteorico = limpiar($_POST["stockteorico"]);
	$motivoajuste = limpiar($_POST["motivoajuste"]);
	$idproducto = limpiar(decrypt($_POST["idproducto"]));
	$stmt->execute();

	echo "<span class='fa fa-check-square-o'></span> EL AJUSTE DE STOCK DEL PRODUCTO SE HA REALIZADO EXITOSAMENTE";
	exit;
}
###################### FUNCION AJUSTAR STOCK DE PRODUCTOS #########################

########################## FUNCION ELIMINAR PRODUCTOS ###########################
public function EliminarProductos()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codproducto FROM detalleventas WHERE codproducto = ? AND codsucursal = ? AND tipodetalle = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codproducto"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		################### ELIMINO PRODUCTO ###################
		$sql = "DELETE FROM productos WHERE codproducto = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codproducto);
		$stmt->bindParam(2,$codsucursal);
		$codproducto = decrypt($_GET["codproducto"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################### ELIMINO PRODUCTO ###################

		################### ELIMINO KARDEX ###################
		$sql = "DELETE FROM kardex WHERE codproducto = ? AND codsucursal = ? AND tipokardex = 1";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codproducto);
		$stmt->bindParam(2,$codsucursal);
		$codproducto = decrypt($_GET["codproducto"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################### ELIMINO KARDEX ###################

		################### ELIMINO PRODUCTO DE COMBO ###################
		$sql = "DELETE FROM combosxproductos WHERE codproducto = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codproducto);
		$stmt->bindParam(2,$codsucursal);
		$codproducto = decrypt($_GET["codproducto"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################### ELIMINO PRODUCTO DE COMBO ###################

		if (file_exists("fotos/productos/".$codsucursal."_".$codproducto.".jpg")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/productos/".$codsucursal."_".$codproducto.".jpg";		
		unlink($archivos);
	    } else if (file_exists("fotos/productos/".$codsucursal."_".$codproducto.".jpeg")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/productos/".$codsucursal."_".$codproducto.".jpeg";		
		unlink($archivos);
	    } else if (file_exists("fotos/productos/".$codsucursal."_".$codproducto.".png")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/productos/".$codsucursal."_".$codproducto.".png";		
		unlink($archivos);
		}

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
    } 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR PRODUCTOS #################################

########################## FUNCION BUSQUEDA DE PRODUCTOS POR TIPO BUSQUEDA ###############################
public function BusquedaProductos() 
{
	self::SetNames();
    if(limpiar($_GET['tipobusqueda']) == 1){

    	if(empty($_GET["codsubfamilia"])){

	    	$sql = "SELECT
			productos.idproducto,
			productos.codproducto,
			productos.producto,
			productos.descripcion,
			productos.imei,
			productos.condicion,
			productos.fabricante,
			productos.codfamilia,
			productos.codsubfamilia,
			productos.codmarca,
			productos.codmodelo,
			productos.codpresentacion,
			productos.codcolor,
			productos.codorigen,
			productos.year,
			productos.nroparte,
			productos.lote,
			productos.peso,
			productos.preciocompra,
			productos.precioxmayor,
			productos.precioxmenor,
			productos.precioxpublico,
			productos.existencia,
			productos.stockoptimo,
			productos.stockmedio,
			productos.stockminimo,
			productos.ivaproducto,
			productos.descproducto,
			productos.codigobarra,
			productos.fechaelaboracion,
			productos.fechaoptimo,
			productos.fechamedio,
			productos.fechaminimo,
			productos.codproveedor,
			productos.stockteorico,
			productos.motivoajuste,
			productos.codsucursal,
			impuestos.codimpuesto,
			impuestos.nomimpuesto,
			impuestos.valorimpuesto,
			impuestos.posicionimpuesto,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			sucursales.codmoneda,
			sucursales.codmoneda2,
			documentos.documento,
			documentos2.documento AS documento2,
			documentos3.documento AS documento3,
			tiposmoneda.moneda,
			tiposmoneda.siglas,
			tiposmoneda.simbolo,
			tiposmoneda2.moneda AS moneda2,
			tiposmoneda2.siglas AS siglas2,
			tiposmoneda2.simbolo AS simbolo2,
			valor_cambio.montocambio,
			familias.nomfamilia,
			subfamilias.nomsubfamilia,
			marcas.nommarca,
			modelos.nommodelo,
			presentaciones.nompresentacion,
			colores.nomcolor,
			origenes.nomorigen,
			proveedores.documproveedor,
			proveedores.cuitproveedor,
			proveedores.nomproveedor,
			provincias.provincia,
			departamentos.departamento
			FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
			LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
			LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
			LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
			LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
			LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
			LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
			LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
			LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
			LEFT JOIN colores ON productos.codcolor=colores.codcolor 
			LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
			LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
			LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
			WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND productos.codfamilia = '".limpiar(decrypt($_GET["codfamilia"]))."'";

	    } else {

	    	$sql = "SELECT
			productos.idproducto,
			productos.codproducto,
			productos.producto,
			productos.descripcion,
			productos.imei,
			productos.condicion,
			productos.fabricante,
			productos.codfamilia,
			productos.codsubfamilia,
			productos.codmarca,
			productos.codmodelo,
			productos.codpresentacion,
			productos.codcolor,
			productos.codorigen,
			productos.year,
			productos.nroparte,
			productos.lote,
			productos.peso,
			productos.preciocompra,
			productos.precioxmayor,
			productos.precioxmenor,
			productos.precioxpublico,
			productos.existencia,
			productos.stockoptimo,
			productos.stockmedio,
			productos.stockminimo,
			productos.ivaproducto,
			productos.descproducto,
			productos.codigobarra,
			productos.fechaelaboracion,
			productos.fechaoptimo,
			productos.fechamedio,
			productos.fechaminimo,
			productos.codproveedor,
			productos.stockteorico,
			productos.motivoajuste,
			productos.codsucursal,
			impuestos.codimpuesto,
			impuestos.nomimpuesto,
			impuestos.valorimpuesto,
			impuestos.posicionimpuesto,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			sucursales.codmoneda,
			sucursales.codmoneda2,
			documentos.documento,
			documentos2.documento AS documento2,
			documentos3.documento AS documento3,
			tiposmoneda.moneda,
			tiposmoneda.siglas,
			tiposmoneda.simbolo,
			tiposmoneda2.moneda AS moneda2,
			tiposmoneda2.siglas AS siglas2,
			tiposmoneda2.simbolo AS simbolo2,
			valor_cambio.montocambio,
			familias.nomfamilia,
			subfamilias.nomsubfamilia,
			marcas.nommarca,
			modelos.nommodelo,
			presentaciones.nompresentacion,
			colores.nomcolor,
			origenes.nomorigen,
			proveedores.documproveedor,
			proveedores.cuitproveedor,
			proveedores.nomproveedor,
			provincias.provincia,
			departamentos.departamento
			FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
			LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
			LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
			LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
			LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
			LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
			LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
			LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
			LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
			LEFT JOIN colores ON productos.codcolor=colores.codcolor 
			LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
			LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
			LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
			WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND productos.codfamilia = '".limpiar(decrypt($_GET["codfamilia"]))."'
			AND productos.codsubfamilia = '".limpiar(decrypt($_GET["codsubfamilia"]))."'";
	    }
    
  	} elseif(limpiar($_GET['tipobusqueda']) == 2){

  		if(empty($_GET["codmodelo"])){

	    	$sql = "SELECT
			productos.idproducto,
			productos.codproducto,
			productos.producto,
			productos.descripcion,
			productos.imei,
			productos.condicion,
			productos.fabricante,
			productos.codfamilia,
			productos.codsubfamilia,
			productos.codmarca,
			productos.codmodelo,
			productos.codpresentacion,
			productos.codcolor,
			productos.codorigen,
			productos.year,
			productos.nroparte,
			productos.lote,
			productos.peso,
			productos.preciocompra,
			productos.precioxmayor,
			productos.precioxmenor,
			productos.precioxpublico,
			productos.existencia,
			productos.stockoptimo,
			productos.stockmedio,
			productos.stockminimo,
			productos.ivaproducto,
			productos.descproducto,
			productos.codigobarra,
			productos.fechaelaboracion,
			productos.fechaoptimo,
			productos.fechamedio,
			productos.fechaminimo,
			productos.codproveedor,
			productos.stockteorico,
			productos.motivoajuste,
			productos.codsucursal,
			impuestos.codimpuesto,
			impuestos.nomimpuesto,
			impuestos.valorimpuesto,
			impuestos.posicionimpuesto,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			sucursales.codmoneda,
			sucursales.codmoneda2,
			documentos.documento,
			documentos2.documento AS documento2,
			documentos3.documento AS documento3,
			tiposmoneda.moneda,
			tiposmoneda.siglas,
			tiposmoneda.simbolo,
			tiposmoneda2.moneda AS moneda2,
			tiposmoneda2.siglas AS siglas2,
			tiposmoneda2.simbolo AS simbolo2,
			valor_cambio.montocambio,
			familias.nomfamilia,
			subfamilias.nomsubfamilia,
			marcas.nommarca,
			modelos.nommodelo,
			presentaciones.nompresentacion,
			colores.nomcolor,
			origenes.nomorigen,
			proveedores.documproveedor,
			proveedores.cuitproveedor,
			proveedores.nomproveedor,
			provincias.provincia,
			departamentos.departamento
			FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
			LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
			LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
			LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
			LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
			LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
			LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
			LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
			LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
			LEFT JOIN colores ON productos.codcolor=colores.codcolor 
			LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
			LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
			LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
			WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND productos.codmarca = '".limpiar(decrypt($_GET["codmarca"]))."'";

	    } else {

	    	$sql = "SELECT
			productos.idproducto,
			productos.codproducto,
			productos.producto,
			productos.descripcion,
			productos.imei,
			productos.condicion,
			productos.fabricante,
			productos.codfamilia,
			productos.codsubfamilia,
			productos.codmarca,
			productos.codmodelo,
			productos.codpresentacion,
			productos.codcolor,
			productos.codorigen,
			productos.year,
			productos.nroparte,
			productos.lote,
			productos.peso,
			productos.preciocompra,
			productos.precioxmayor,
			productos.precioxmenor,
			productos.precioxpublico,
			productos.existencia,
			productos.stockoptimo,
			productos.stockmedio,
			productos.stockminimo,
			productos.ivaproducto,
			productos.descproducto,
			productos.codigobarra,
			productos.fechaelaboracion,
			productos.fechaoptimo,
			productos.fechamedio,
			productos.fechaminimo,
			productos.codproveedor,
			productos.stockteorico,
			productos.motivoajuste,
			productos.codsucursal,
			impuestos.codimpuesto,
			impuestos.nomimpuesto,
			impuestos.valorimpuesto,
			impuestos.posicionimpuesto,
			sucursales.documsucursal, 
			sucursales.cuitsucursal, 
			sucursales.nomsucursal,
			sucursales.documencargado,
			sucursales.dniencargado,
			sucursales.nomencargado,
			sucursales.codmoneda,
			sucursales.codmoneda2,
			documentos.documento,
			documentos2.documento AS documento2,
			documentos3.documento AS documento3,
			tiposmoneda.moneda,
			tiposmoneda.siglas,
			tiposmoneda.simbolo,
			tiposmoneda2.moneda AS moneda2,
			tiposmoneda2.siglas AS siglas2,
			tiposmoneda2.simbolo AS simbolo2,
			valor_cambio.montocambio,
			familias.nomfamilia,
			subfamilias.nomsubfamilia,
			marcas.nommarca,
			modelos.nommodelo,
			presentaciones.nompresentacion,
			colores.nomcolor,
			origenes.nomorigen,
			proveedores.documproveedor,
			proveedores.cuitproveedor,
			proveedores.nomproveedor,
			provincias.provincia,
			departamentos.departamento
			FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
			LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
			LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
			LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
			LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
			LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
			LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
			LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
			LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
			LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
			LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
			LEFT JOIN colores ON productos.codcolor=colores.codcolor 
			LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
			LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
			LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
			WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
			AND productos.codmarca = '".limpiar(decrypt($_GET["codmarca"]))."'
			AND productos.codmodelo = '".limpiar(decrypt($_GET["codmodelo"]))."'";
	    }

	} else if(limpiar($_GET['tipobusqueda']) == 3){

		$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codpresentacion = '".limpiar(decrypt($_GET["codpresentacion"]))."'";

	} else if(limpiar($_GET['tipobusqueda']) == 4){

		$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codcolor = '".limpiar(decrypt($_GET["codcolor"]))."'";

	} else if(limpiar($_GET['tipobusqueda']) == 5){

		$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codorigen = '".limpiar(decrypt($_GET["codorigen"]))."'";

	} else if(limpiar($_GET['tipobusqueda']) == 6){

		$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codproveedor = '".limpiar(decrypt($_GET["codproveedor"]))."'";

	} else if(limpiar($_GET['tipobusqueda']) == 7){	

    	$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codfamilia = '".limpiar(decrypt($_GET["codfamilia"]))."'
		AND productos.codproveedor = '".limpiar(decrypt($_GET["codproveedor"]))."'";

	} else if(limpiar($_GET['tipobusqueda']) == 8){

    	$sql = "SELECT
		productos.idproducto,
		productos.codproducto,
		productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
		productos.fabricante,
		productos.codfamilia,
		productos.codsubfamilia,
		productos.codmarca,
		productos.codmodelo,
		productos.codpresentacion,
		productos.codcolor,
		productos.codorigen,
		productos.year,
		productos.nroparte,
		productos.lote,
		productos.peso,
		productos.preciocompra,
		productos.precioxmayor,
		productos.precioxmenor,
		productos.precioxpublico,
		productos.existencia,
		productos.stockoptimo,
		productos.stockmedio,
		productos.stockminimo,
		productos.ivaproducto,
		productos.descproducto,
		productos.codigobarra,
		productos.fechaelaboracion,
		productos.fechaoptimo,
		productos.fechamedio,
		productos.fechaminimo,
		productos.codproveedor,
		productos.stockteorico,
		productos.motivoajuste,
		productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		documentos3.documento AS documento3,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		familias.nomfamilia,
		subfamilias.nomsubfamilia,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		origenes.nomorigen,
		proveedores.documproveedor,
		proveedores.cuitproveedor,
		proveedores.nomproveedor,
		provincias.provincia,
		departamentos.departamento
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND productos.codmarca = '".limpiar(decrypt($_GET["codmarca"]))."'
		AND productos.codproveedor = '".limpiar(decrypt($_GET["codproveedor"]))."'";
	}
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION BUSQUEDA DE PRODUCTOS POR TIPO BUSQUEDA ###############################

######################## FUNCION BUSCA KARDEX PRODUCTOS ##########################
public function BuscarKardexProducto() 
{
	self::SetNames();
	$sql ="SELECT
	kardex.*,
	usuarios.dni,
	usuarios.nombres,
	usuarios.nivel
	FROM kardex LEFT JOIN usuarios ON kardex.codigo = usuarios.codigo 
	WHERE kardex.codproducto = ? AND kardex.codsucursal = ? AND kardex.tipokardex = 1";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codproducto"], decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN MOVIMIENTOS EN KARDEX PARA EL PRODUCTO INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION BUSCA KARDEX PRODUCTOS #########################

######################## FUNCION DETALLE PRODUCTO KARDEX #########################
public function DetalleKardexProducto()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.fabricante,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.year,
	productos.nroparte,
	productos.lote,
	productos.peso,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.existencia,
	productos.stockoptimo,
	productos.stockmedio,
	productos.stockminimo,
	productos.ivaproducto,
	productos.descproducto,
	productos.codigobarra,
	productos.fechaelaboracion,
	productos.fechaoptimo,
	productos.fechamedio,
	productos.fechaminimo,
	productos.codproveedor,
	productos.stockteorico,
	productos.motivoajuste,
	productos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen,
	proveedores.cuitproveedor,
	proveedores.nomproveedor
	FROM(productos LEFT JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN familias ON productos.codfamilia=familias.codfamilia 
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
	LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE productos.codproducto = ? AND productos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codproducto"],decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION DETALLE PRODUCTO KARDEX #########################

########################### FUNCION LISTAR KARDEX PRODUCTO VALORIZADO ################################
public function ListarKardexProductosValorizado()
{
	self::SetNames();
        
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
	 	productos.idproducto,
	 	productos.codproducto,
	 	productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
	 	productos.fabricante,
	 	productos.codfamilia,
	 	productos.codsubfamilia,
	 	productos.codmarca,
	 	productos.codmodelo,
	 	productos.codpresentacion,
	 	productos.codcolor,
	 	productos.codorigen,
	 	productos.year,
	 	productos.nroparte,
	 	productos.lote,
	 	productos.peso,
	 	productos.preciocompra,
	 	productos.precioxmayor,
	 	productos.precioxmenor,
	 	productos.precioxpublico,
	 	productos.existencia,
	 	productos.stockoptimo,
	 	productos.stockmedio,
	 	productos.stockminimo,
	 	productos.ivaproducto,
	 	productos.descproducto,
	 	productos.codigobarra,
	 	productos.fechaelaboracion,
	 	productos.fechaoptimo,
	 	productos.fechamedio,
	 	productos.fechaminimo,
	 	productos.codproveedor,
	 	productos.stockteorico,
	 	productos.motivoajuste,
	 	productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
	 	familias.nomfamilia,
	 	subfamilias.nomsubfamilia,
	 	marcas.nommarca,
	 	modelos.nommodelo,
	 	presentaciones.nompresentacion,
	 	colores.nomcolor,
	 	origenes.nomorigen,
	 	proveedores.cuitproveedor,
	 	proveedores.nomproveedor
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	 	$sql = "SELECT
	 	productos.idproducto,
	 	productos.codproducto,
	 	productos.producto,
		productos.descripcion,
		productos.imei,
		productos.condicion,
	 	productos.fabricante,
	 	productos.codfamilia,
	 	productos.codsubfamilia,
	 	productos.codmarca,
	 	productos.codmodelo,
	 	productos.codpresentacion,
	 	productos.codcolor,
	 	productos.codorigen,
	 	productos.year,
	 	productos.nroparte,
	 	productos.lote,
	 	productos.peso,
	 	productos.preciocompra,
	 	productos.precioxmayor,
	 	productos.precioxmenor,
	 	productos.precioxpublico,
	 	productos.existencia,
	 	productos.stockoptimo,
	 	productos.stockmedio,
	 	productos.stockminimo,
	 	productos.ivaproducto,
	 	productos.descproducto,
	 	productos.codigobarra,
	 	productos.fechaelaboracion,
	 	productos.fechaoptimo,
	 	productos.fechamedio,
	 	productos.fechaminimo,
	 	productos.codproveedor,
	 	productos.stockteorico,
	 	productos.motivoajuste,
	 	productos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
	 	familias.nomfamilia,
	 	subfamilias.nomsubfamilia,
	 	marcas.nommarca,
	 	modelos.nommodelo,
	 	presentaciones.nompresentacion,
	 	colores.nomcolor,
	 	origenes.nomorigen,
	 	proveedores.cuitproveedor,
	 	proveedores.nomproveedor
		FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
		LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
		LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
		LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
		LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
		LEFT JOIN colores ON productos.codcolor=colores.codcolor 
		LEFT JOIN origenes ON productos.codorigen=origenes.codorigen
		LEFT JOIN proveedores ON productos.codproveedor=proveedores.codproveedor
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE productos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR KARDEX PRODUCTO VALORIZADO ################################

###################### FUNCION PRODUCTOS VALORIZADO POR FECHAS Y VENDEDOR #########################
public function BuscarProductosValorizadoxFechas() 
{
	self::SetNames();
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto, 
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion, 
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.preciocompra,  
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,  
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.subtotalimpuestos,
    detalleventas.tipodetalle,
    marcas.nommarca, 
    modelos.nommodelo,
    presentaciones.nompresentacion,
    colores.nomcolor,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres, 
    SUM(detalleventas.cantidad) AS cantidad 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa=detalleventas.codventa) 
    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion 
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo 
    LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
    WHERE ventas.codsucursal = ? 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
    AND detalleventas.tipodetalle = 1 
    GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	//$stmt->bindValue(1, trim($_GET['codigo']));
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
	echo "<div class='alert alert-danger'>";
	echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
	echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL VENDEDOR Y RANGO DE FECHA INGRESADA</center>";
	echo "</div>";		
	exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION PRODUCTOS VALORIZADO POR FECHAS Y VENDEDOR ###############################

###################### FUNCION BUSCAR PRODUCTOS VENDIDOS POR FECHAS #########################
public function BuscarProductosVendidosxFechas() 
{
	self::SetNames();
	$sql ="SELECT
	detalleventas.idproducto, 
	detalleventas.codproducto,
	detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion, 
	detalleventas.codmarca,
	detalleventas.codmodelo, 
	detalleventas.codpresentacion,
	detalleventas.codcolor, 
	detalleventas.preciocompra, 
	detalleventas.precioventa, 
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,
	detalleventas.ivaproducto,
	detalleventas.descproducto,
    detalleventas.tipodetalle,
	marcas.nommarca, 
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	sucursales.cuitsucursal, 
	sucursales.nomsucursal, 
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio, 
	SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
	FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
	INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion 
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor 
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND detalleventas.tipodetalle = 1 
	GROUP BY 
		detalleventas.idproducto,
		detalleventas.codproducto,
		detalleventas.producto,
		detalleventas.descripcion,
		detalleventas.imei,
		detalleventas.condicion,
		detalleventas.codmarca,
		detalleventas.codmodelo,
		detalleventas.codpresentacion,
		detalleventas.codcolor,
		detalleventas.preciocompra,
		detalleventas.precioventa,
		detalleventas.posicionimpuesto,
		detalleventas.tipoimpuesto,
		detalleventas.ivaproducto,
		detalleventas.descproducto,
		detalleventas.tipodetalle,
		marcas.nommarca,
		modelos.nommodelo,
		presentaciones.nompresentacion,
		colores.nomcolor,
		sucursales.cuitsucursal,
		sucursales.nomsucursal,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio
	ORDER BY detalleventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION PRODUCTOS VENDIDOS POR FECHAS ###############################

############################### FIN DE CLASE PRODUCTOS ###############################
























############################### CLASE AJUSTE DE PRODUCTOS ###############################

########################## FUNCION AJUSTAR STOCK DE PRODUCTOS ###########################
public function RegistrarAjusteProducto()
{
	self::SetNames();
	if(empty($_POST["idproducto"]) or empty($_POST["procedimiento"]) or empty($_POST["cantidad"]))
	{
		echo "1";
	    exit;
	}
	elseif($_POST["cantidad"] == 0 || $_POST["cantidad"] == 0.00){

		echo "2";
		exit();
	}

	############ VALIDO QUE NO SEA PRODUCTO HIJO #############
	$sqlTipo = "SELECT tipo_producto FROM productos WHERE idproducto = '".limpiar(decrypt($_POST['idproducto']))."'";
	$stmtTipo = $this->dbh->prepare($sqlTipo);
	$stmtTipo->execute();
	$rowTipo = $stmtTipo->fetch(PDO::FETCH_ASSOC);
	if ($rowTipo && $rowTipo['tipo_producto'] == 'HIJO') {
		echo "8"; // Código de error: Producto HIJO no puede recibir ajustes
		exit;
	}
	############ FIN VALIDACION PRODUCTOS HIJO #############

	################ OBTENGO EXISTENCIA DE PRODUCTO ################
	$sql = "SELECT
	productos.codproducto,
	productos.producto,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.existencia,
	productos.preciocompra,
	productos.precioxmayor,
	productos.precioxmenor,
	productos.precioxpublico,
	productos.ivaproducto, 
	productos.descproducto,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto
	FROM productos LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	WHERE productos.idproducto = '".limpiar(decrypt($_POST['idproducto']))."'";
	foreach ($this->dbh->query($sql) AS $row)
	{
		$this->p[] = $row;
	}
	$codproductoBD     = $row['codproducto'];
	$productoBD        = $row['producto'];
	$codmarcaBD        = $row['codmarca'];
	$codmodeloBD       = $row['codmodelo'];
	$codpresentacionBD = $row['codpresentacion'];
	$existenciaBD      = $row['existencia'];
	$preciocompraBD    = $row['preciocompra'];
	$precioxmayorBD    = $row['precioxmayor'];
	$precioxmenorBD    = $row['precioxmenor'];
	$precioxpublicoBD  = $row['precioxpublico'];
	$nomimpuestoBD     = $row['nomimpuesto'];
	$valorimpuestoBD   = $row['valorimpuesto'];
	$ivaproductoBD     = $row['ivaproducto'];
	$descproductoBD    = $row['descproducto'];
    ################ OBTENGO EXISTENCIA DE PRODUCTO ################

    ################ CREO Nº DE AJUSTE ####################
	$sql = "SELECT codajuste FROM ajustes
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idajuste DESC LIMIT 1";
	foreach ($this->dbh->query($sql) AS $row){

		$ajuste = $row["codajuste"];
	}
	if(empty($ajuste))
	{
		$codajuste = "01";

	} else {

		$num       = substr($ajuste, 0);
		$digitos   = $num + 1;
		$numfinal  = str_pad($digitos, 2, "0", STR_PAD_LEFT);
		$codajuste = $numfinal;
	}
    ################ CREO Nº DE AJUSTE ###############

    ################### CREO CODIGO DE FACTURA ####################
	$sql4 = "SELECT codfactura FROM ajustes 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idajuste DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$factura = $row4["codfactura"];
	}
	if(empty($factura))
	{
		$codfactura = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = $var4;
	}
	################### CREO CODIGO DE FACTURA ####################

	if($_POST["proceso"] == 2 && $_POST["cantidad"] > $existenciaBD){

		echo "3";
		exit();
	} 

	$stockactual = limpiar($_POST["procedimiento"] == 2 ? number_format($existenciaBD-$_POST["cantidad"], 2, '.', '') : number_format($_POST["cantidad"]+$existenciaBD, 2, '.', ''));
	$msj          = limpiar($_POST["procedimiento"] == 2 ? "RESTADA" : "SUMADA");
	
	##################### REGISTRO DATOS DE AJUSTE #####################
	$query = "INSERT INTO ajustes values (null, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codajuste);
	$stmt->bindParam(2, $tipodocumento);
	$stmt->bindParam(3, $codfactura);
	$stmt->bindParam(4, $codigo);
	$stmt->bindParam(5, $motivoajuste);
	$stmt->bindParam(6, $fechaajuste);
	$stmt->bindParam(7, $codsucursal);

	$tipodocumento = limpiar($_POST["tipodocumento"]);
	$codigo        = limpiar($_SESSION["codigo"]);
	$motivoajuste  = limpiar($_POST["motivoajuste"]);
	$fechaajuste   = limpiar(date("Y-m-d H:i:s"));
	$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
    ##################### REGISTRO DATOS DE AJUSTE #####################

    ##################### REGISTRO DETALLES DE AJUSTE #####################
	$query = "INSERT INTO detalleajustes values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codajuste);
	$stmt->bindParam(2, $idproducto);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $producto);
	$stmt->bindParam(5, $codmarca);
	$stmt->bindParam(6, $codmodelo);
	$stmt->bindParam(7, $codpresentacion);
	$stmt->bindParam(8, $preciocompra);
	$stmt->bindParam(9, $precioxmayor);
	$stmt->bindParam(10, $precioxmenor);
	$stmt->bindParam(11, $precioxpublico);
	$stmt->bindParam(12, $existencia);
	$stmt->bindParam(13, $cantidad);
	$stmt->bindParam(14, $tipoimpuesto);
	$stmt->bindParam(15, $ivaproducto);
	$stmt->bindParam(16, $descproducto);
	$stmt->bindParam(17, $procedimiento);
	$stmt->bindParam(18, $tipodetalle);
	$stmt->bindParam(19, $observaciones);
	$stmt->bindParam(20, $codsucursal);

	$idproducto      = limpiar(decrypt($_POST["idproducto"]));
	$codproducto     = limpiar($codproductoBD);
	$producto        = limpiar($productoBD);
	$codmarca        = limpiar($codmarcaBD);
	$codmodelo       = limpiar($codmodeloBD);
	$codpresentacion = limpiar($codpresentacionBD);
	$preciocompra    = limpiar($preciocompraBD);
	$precioxmayor    = limpiar($precioxmayorBD);
	$precioxmenor    = limpiar($precioxmenorBD);
	$precioxpublico  = limpiar($precioxpublicoBD);
	$existencia      = limpiar($existenciaBD);
	$cantidad        = limpiar($_POST["cantidad"]);
	$tipoimpuesto    = limpiar($nomimpuestoBD);
	$ivaproducto     = limpiar($valorimpuestoBD);
	$descproducto    = limpiar($descproductoBD);
	$procedimiento   = limpiar($_POST["procedimiento"]);
	$tipodetalle     = limpiar("1");
	$observaciones   = limpiar("");
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
    ##################### REGISTRO DETALLES DE AJUSTE #####################

    ################ ACTUALIZO EXISTENCIA DE PRODUCTO ################
	$sql = "UPDATE productos set"
		." existencia = ? "
		." WHERE "
		." idproducto = ?;
		";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $existencia);
	$stmt->bindParam(2, $idproducto);
	
	$existencia = number_format($stockactual, 2, '.', '');
	$idproducto = limpiar(decrypt($_POST["idproducto"]));
	$stmt->execute();
	################ ACTUALIZO EXISTENCIA DE PRODUCTO ################

	##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
	$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codproceso);
	$stmt->bindParam(2, $codresponsable);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $movimiento);
	$stmt->bindParam(5, $entradas);
	$stmt->bindParam(6, $salidas);
	$stmt->bindParam(7, $devolucion);
	$stmt->bindParam(8, $stockactual);
	$stmt->bindParam(9, $ivaproducto);
	$stmt->bindParam(10, $descproducto);
	$stmt->bindParam(11, $precio);
	$stmt->bindParam(12, $documento);
	$stmt->bindParam(13, $fechakardex);	
    $stmt->bindParam(14, $tipokardex);	
    $stmt->bindParam(15, $procedimiento);			
	$stmt->bindParam(16, $codsucursal);
	$stmt->bindParam(17, $codigo);

	$codproceso     = limpiar($codproductoBD);
	$codresponsable = limpiar($_SESSION["codigo"]);
	$movimiento     = limpiar($_POST["procedimiento"] == 2 ? "SALIDAS" : "ENTRADAS");
	$entradas       = limpiar($_POST["procedimiento"] == 2 ? "0.00" : $_POST['cantidad']);
	$salidas        = limpiar($_POST["procedimiento"] == 2 ? $_POST['cantidad'] : "0.00");
	$devolucion     = limpiar("0.00");
	$stockactual    = number_format($stockactual, 2, '.', '');
	$ivaproducto    = limpiar($ivaproductoBD == '0' ? "EXENTO" : $nomimpuestoBD." (".$valorimpuestoBD." %)");
	$descproducto   = limpiar($descproductoBD);
	$precio         = limpiar($precioxpublicoBD);
	$documento      = limpiar($_POST["proceso"] == 2 ? "AJUSTE DE STOCK" : "AJUSTE DE STOCK");
	$fechakardex    = limpiar(date("Y-m-d H:i:s"));
	$tipokardex     = limpiar("1");
	$procedimiento  = limpiar("1");
	$codigo         = limpiar($_SESSION["codigo"]);
	$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
    ##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################

	echo "<span class='fa fa-check-square-o'></span> LA CANTIDAD FUE ".$msj." AL STOCK DEL PRODUCTO EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?numero=".encrypt($codajuste)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
###################### FUNCION AJUSTAR STOCK DE PRODUCTOS #########################

########################### FUNCION LISTAR AJUSTES DE PRODUCTOS ################################
public function ListarAjustesProductos()
{
	self::SetNames();
	$sql = "SELECT
	ajustes.*,
	detalleajustes.idproducto,
	detalleajustes.codproducto,
	detalleajustes.producto,
	detalleajustes.codmarca,
	detalleajustes.codmodelo,
	detalleajustes.codpresentacion,
	detalleajustes.preciocompra,
	detalleajustes.precioxmayor,
	detalleajustes.precioxmenor,
	detalleajustes.precioxpublico,
	detalleajustes.existencia,
	detalleajustes.cantidad,
	detalleajustes.tipoimpuesto,
	detalleajustes.ivaproducto,
	detalleajustes.descproducto,
	detalleajustes.procedimiento,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
    departamentos.departamento,
    provincias.provincia,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel
	FROM (ajustes INNER JOIN detalleajustes ON ajustes.codajuste = detalleajustes.codajuste)
	LEFT JOIN sucursales ON ajustes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN marcas ON detalleajustes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleajustes.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleajustes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN usuarios ON ajustes.codigo = usuarios.codigo		 
	WHERE detalleajustes.codsucursal = ? 
	ORDER BY ajustes.codajuste ASC";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
	    exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION LISTAR AJUSTES DE PRODUCTOS ################################

########################## FUNCION BUSQUEDA AJUSTE DE PRODUCTOS ###############################
public function BusquedaAjustesProductos() 
{
	self::SetNames();
    if(limpiar($_GET['tipobusqueda']) == 1){
    $sql ="SELECT 
	ajustes.*,
	detalleajustes.idproducto,
	detalleajustes.codproducto,
	detalleajustes.producto,
	detalleajustes.codmarca,
	detalleajustes.codmodelo,
	detalleajustes.codpresentacion,
	detalleajustes.preciocompra,
	detalleajustes.precioxmayor,
	detalleajustes.precioxmenor,
	detalleajustes.precioxpublico,
	detalleajustes.existencia,
	detalleajustes.cantidad,
	detalleajustes.tipoimpuesto,
	detalleajustes.ivaproducto,
	detalleajustes.descproducto,
	detalleajustes.procedimiento,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
    departamentos.departamento,
    provincias.provincia,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel
	FROM (ajustes INNER JOIN detalleajustes ON ajustes.codajuste = detalleajustes.codajuste)
	LEFT JOIN sucursales ON ajustes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN marcas ON detalleajustes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleajustes.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleajustes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN usuarios ON ajustes.codigo = usuarios.codigo
	WHERE ajustes.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY ajustes.codajuste 
	ORDER BY ajustes.codajuste ASC LIMIT 0,60";
    } elseif(limpiar($_GET['tipobusqueda']) == 2){
    $sql ="SELECT 
	ajustes.*,
	detalleajustes.idproducto,
	detalleajustes.codproducto,
	detalleajustes.producto,
	detalleajustes.codmarca,
	detalleajustes.codmodelo,
	detalleajustes.codpresentacion,
	detalleajustes.preciocompra,
	detalleajustes.precioxmayor,
	detalleajustes.precioxmenor,
	detalleajustes.precioxpublico,
	detalleajustes.existencia,
	detalleajustes.cantidad,
	detalleajustes.tipoimpuesto,
	detalleajustes.ivaproducto,
	detalleajustes.descproducto,
	detalleajustes.procedimiento,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
    departamentos.departamento,
    provincias.provincia,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel
	FROM (ajustes INNER JOIN detalleajustes ON ajustes.codajuste = detalleajustes.codajuste)
	LEFT JOIN sucursales ON ajustes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN marcas ON detalleajustes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleajustes.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleajustes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN usuarios ON ajustes.codigo = usuarios.codigo
	WHERE CONCAT(detalleajustes.codproducto, '',detalleajustes.producto, '',if(detalleajustes.codmarca='0','0',marcas.nommarca), '',if(detalleajustes.codmodelo='0','0',modelos.nommodelo), '',if(detalleajustes.codpresentacion='0','0',presentaciones.nompresentacion), '',if(detalleajustes.procedimiento='1','SUMA','RESTA'), '',sucursales.cuitsucursal, '',sucursales.nomsucursal, '',sucursales.dniencargado, '',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
	AND ajustes.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY ajustes.codajuste 
	ORDER BY ajustes.codajuste ASC LIMIT 0,60";
    } else if(limpiar($_GET['tipobusqueda']) == 3){
    $sql ="SELECT 
	ajustes.*,
	detalleajustes.idproducto,
	detalleajustes.codproducto,
	detalleajustes.producto,
	detalleajustes.codmarca,
	detalleajustes.codmodelo,
	detalleajustes.codpresentacion,
	detalleajustes.preciocompra,
	detalleajustes.precioxmayor,
	detalleajustes.precioxmenor,
	detalleajustes.precioxpublico,
	detalleajustes.existencia,
	detalleajustes.cantidad,
	detalleajustes.tipoimpuesto,
	detalleajustes.ivaproducto,
	detalleajustes.descproducto,
	detalleajustes.procedimiento,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
    departamentos.departamento,
    provincias.provincia,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel
	FROM (ajustes INNER JOIN detalleajustes ON ajustes.codajuste = detalleajustes.codajuste)
	LEFT JOIN sucursales ON ajustes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN marcas ON detalleajustes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleajustes.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleajustes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN usuarios ON ajustes.codigo = usuarios.codigo
	WHERE DATE_FORMAT(ajustes.fechaajuste,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
	AND ajustes.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY ajustes.codajuste 
	ORDER BY ajustes.codajuste ASC LIMIT 0,60";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION BUSQUEDA AJUSTE DE PRODUCTOS ###############################

############################ FUNCION ID AJUSTE DE PRODUCTOS #################################
public function AjustesProductosPorId()
{
	self::SetNames();
	$sql = "SELECT
	ajustes.*,
	detalleajustes.idproducto,
	detalleajustes.codproducto,
	detalleajustes.producto,
	detalleajustes.codmarca,
	detalleajustes.codmodelo,
	detalleajustes.codpresentacion,
	detalleajustes.preciocompra,
	detalleajustes.precioxmayor,
	detalleajustes.precioxmenor,
	detalleajustes.precioxpublico,
	detalleajustes.existencia,
	detalleajustes.cantidad,
	detalleajustes.tipoimpuesto,
	detalleajustes.ivaproducto,
	detalleajustes.descproducto,
	detalleajustes.procedimiento,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
    departamentos.departamento,
    provincias.provincia,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel
	FROM (ajustes INNER JOIN detalleajustes ON ajustes.codajuste = detalleajustes.codajuste)
	LEFT JOIN sucursales ON ajustes.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN marcas ON detalleajustes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleajustes.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalleajustes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN usuarios ON ajustes.codigo = usuarios.codigo
	WHERE ajustes.codajuste = ? AND ajustes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["numero"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID AJUSTE DE PRODUCTOS #################################

############################### CLASE AJUSTE DE PRODUCTOS ###############################


















################################# CLASE COMBOS ######################################

########################### FUNCION REGISTRAR PRODUCTOS ###############################
public function RegistrarCombos()
{
	self::SetNames();
	if(empty($_POST["nomcombo"]) or empty($_POST["codfamilia"]) or empty($_POST["precioxpublico"]) or empty($_POST["existencia"]) or empty($_POST["ivacombo"]) or empty($_POST["desccombo"]) or empty($_POST["codsucursal"]))
	{
		echo "1";
		exit;
	}

	if(!empty($_SESSION["CarritoProducto"])){

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$v = $_SESSION["CarritoProducto"];
	for($i=0;$i<count($v);$i++){

		$sql = "SELECT existencia
		FROM productos 
		WHERE codproducto = '".limpiar($v[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		
		$cantproductobd = $row['existencia'];
		$cantidad       = $v[$i]['cantidad'];

        if($cantidad == "" || $cantidad == 0 || $cantidad == 0.00){

		    echo "2";
		    exit();
	    }
	    elseif ($cantidad > $cantproductobd) 
        { 
		    echo "3";
		    exit;
	    } 
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

    }

    ############## OBTENGO VALOR DE IMPUESTO #################
	$sql = "SELECT
	nomimpuesto, 
	valorimpuesto
	FROM impuestos 
	WHERE codsucursal = '".decrypt($_POST["codsucursal"])."'
	AND statusimpuesto = 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nomimpuesto   = (empty($row['nomimpuesto']) ? "" : $row['nomimpuesto']);
	$valorimpuesto = (empty($row['valorimpuesto']) ? "0.00" : $row['valorimpuesto']);
	############## OBTENGO VALOR DE IMPUESTO #################

	############## CREO CODIGO DE COMBO #################
	$sql = "SELECT codcombo
	FROM combos 
	WHERE codsucursal = '".decrypt($_POST["codsucursal"])."' 
	ORDER BY idcombo DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$combo=$row["codcombo"];
	}
	$codcombo = limpiar(empty($combo) ? "1" : $combo + 1);
	############## CREO CODIGO DE COMBO #################

	$sql = " SELECT nomcombo FROM combos WHERE nomcombo = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomcombo"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
	    $query = "INSERT INTO combos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcombo);
		$stmt->bindParam(2, $nomcombo);
		$stmt->bindParam(3, $codfamilia);
		$stmt->bindParam(4, $preciocompra);
		$stmt->bindParam(5, $precioxmayor);
    	$stmt->bindParam(6, $precioxmenor);
    	$stmt->bindParam(7, $precioxpublico);
		$stmt->bindParam(8, $existencia);
		$stmt->bindParam(9, $stockminimo);
		$stmt->bindParam(10, $stockmaximo);
		$stmt->bindParam(11, $ivacombo);
		$stmt->bindParam(12, $desccombo);
	    $stmt->bindParam(13, $codsucursal);

		$nomcombo       = limpiar($_POST["nomcombo"]);
		$codfamilia     = limpiar(decrypt($_POST["codfamilia"]));
		$preciocompra   = limpiar($_POST["preciocompra"]);
		$precioxmayor   = limpiar($_POST["precioxmayor"]);
		$precioxmenor   = limpiar($_POST["precioxmenor"]);
		$precioxpublico = limpiar($_POST["precioxpublico"]);
		$existencia     = limpiar($_POST["existencia"]);
		$stockminimo    = limpiar($_POST["stockminimo"]);
		$stockmaximo    = limpiar($_POST["stockmaximo"]);
		$ivacombo       = limpiar(decrypt($_POST["ivacombo"]));
		$desccombo      = limpiar($_POST["desccombo"]);
	    $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

	    ##################### REGISTRAMOS LOS DATOS DE COMBOS EN KARDEX #####################
		$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codproceso);
		$stmt->bindParam(2, $codresponsable);
		$stmt->bindParam(3, $codcombo);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivacombo);
		$stmt->bindParam(10, $desccombo);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);
		$stmt->bindParam(14, $tipokardex);
		$stmt->bindParam(15, $procedimiento);
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproceso     = limpiar($codcombo);
		$codresponsable = limpiar("0");
		$movimiento     = limpiar("ENTRADAS");
		$entradas       = limpiar($_POST['existencia']);
		$salidas        = limpiar("0.00");
		$devolucion     = limpiar("0.00");
		$stockactual    = limpiar($_POST['existencia']);
		$ivacombo       = limpiar(decrypt($_POST["ivacombo"]) == '0' ? "EXENTO" : $nomimpuesto." (".$valorimpuesto." %)");
		$desccombo      = limpiar($_POST["desccombo"]);
		$precio         = limpiar($_POST['precioxpublico']);
		$documento      = limpiar("INVENTARIO INICIAL");
		$fechakardex    = limpiar(date("Y-m-d H:i:s"));
		$tipokardex     = limpiar("2");
		$procedimiento  = limpiar("2");
		$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
	    $codigo         = limpiar($_SESSION["codigo"]);
		$stmt->execute();
	    ##################### REGISTRAMOS LOS DATOS DE COMBOS EN KARDEX #####################

	    ############################## SUBIR FOTO DE COMBO ##############################
		$dirmake        = limpiar(is_dir('./fotos/combos/'.$codsucursal) ? "" : mkdir('./fotos/combos/'.$codsucursal, 0777));
		$permitidos     = array("image/jpg", "image/jpeg", "image/png");
		$limite_kb      = 0;
	    //datos del arhivo  
	    $nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
		//$extension = pathinfo($nombre_archivo, PATHINFO_EXTENSION);
		$file           = new SplFileInfo($nombre_archivo);
		$extension      = $file->getExtension();
	    //compruebo si las características del archivo son las que deseo 
	    if(!empty($_FILES["imagen"]) && in_array($_FILES['imagen']['type'], $permitidos)){
	 
	      if (move_uploaded_file($_FILES['imagen']['tmp_name'], "./fotos/combos/".$codsucursal."/".$nombre_archivo) && rename("./fotos/combos/".$codsucursal."/".$nombre_archivo,"./fotos/combos/".$codsucursal."/".$codcombo.".".$extension))
		   { 
		   ## se puede dar un aviso
		   } 
		   ## se puede dar otro aviso 
		}
		############################## SUBIR FOTO DE COMBO ##############################

	if(!empty($_SESSION["CarritoProducto"])){

	################## PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ####################
	$this->dbh->beginTransaction();

	$detalle = $_SESSION["CarritoProducto"];
	for($i=0;$i<count($detalle);$i++){

		$query = " INSERT INTO combosxproductos values (null, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcombo);
		$stmt->bindParam(2, $idproducto);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $cantidad);
		$stmt->bindParam(5, $codsucursal);
		
		$idproducto  = limpiar($detalle[$i]['id']);
		$codproducto = limpiar($detalle[$i]['txtCodigo']);
		$cantidad    = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
	}
	unset($_SESSION["CarritoProducto"]);
    $this->dbh->commit();
	################### PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ##################

    }
		echo "<span class='fa fa-check-square-o'></span> EL COMBO HA SIDO REGISTRADO EXITOSAMENTE";
		exit;

	} else {

		echo "4";
		exit;
	}
}
########################## FUNCION REGISTRAR COMBOS ###############################

########################### FUNCION LISTAR COMBOS ################################
public function ListarCombos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
		
		LEFT JOIN
		    (SELECT
		    codcombo,
		    SUM(combosxproductos.cantidad) AS articulos,	   
		    GROUP_CONCAT(
		    	combosxproductos.cantidad, ' | ', 
			 	productos.producto, ' | ', 
			   	productos.descripcion, ' | ',
			   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
			   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
			   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
			   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		    LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		    LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		    LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		    LEFT JOIN colores ON productos.codcolor = colores.codcolor
		    WHERE combosxproductos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		    GROUP BY
		    combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = ? 
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
	    $stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "";
			//echo "<div class='alert alert-danger'>";
			//echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			//echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
			//echo "</div>";		
		   //exit;
		}
		else
		{
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}

	} else { 

	    $sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
		
		LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR COMBOS ################################

########################### FUNCION LISTAR COMBOS EN STOCK MINIMO ################################
public function ListarCombosMinimo()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		provincias.provincia,
		departamentos.departamento,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
		
		LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND	CAST(combos.existencia AS DECIMAL(10,2)) <= CAST(combos.stockminimo AS DECIMAL(10,2))
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
	    foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else { 

	    $sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		provincias.provincia,
		departamentos.departamento,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
		
		LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE combos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND CAST(combos.existencia AS DECIMAL(10,2)) <= CAST(combos.stockminimo AS DECIMAL(10,2))
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR COMBOS EN STOCK MINIMO ################################

########################### FUNCION LISTAR COMBOS EN STOCK MAXIMO ################################
public function ListarCombosMaximo()
{
	self::SetNames();

	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		provincias.provincia,
		departamentos.departamento,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
		
		LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND	CAST(combos.existencia AS DECIMAL(10,2)) >= CAST(combos.stockmaximo AS DECIMAL(10,2))
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
	    foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else { 

	    $sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		provincias.provincia,
		departamentos.departamento,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia

	    LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND CAST(combos.existencia AS DECIMAL(10,2)) >= CAST(combos.stockmaximo AS DECIMAL(10,2))
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR COMBOS EN STOCK MAXIMO ################################

###################### FUNCION LISTAR PRECIOS POR CODIGO DE COMBO #####################
public function BuscarPrecioComboxCodigo() 
{
	self::SetNames();
	$sql = "SELECT GROUP_CONCAT('PRECIO MAYOR', '_', precioxmayor, '|', 'PRECIO MENOR', '_', precioxmenor, '|', 'PRECIO PUBLICO', '_', precioxpublico SEPARATOR '<br>') AS precioventa 
	FROM combos 
	WHERE idcombo = ? 
	AND codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["idcombo"]));
	$num = $stmt->rowCount();
	    if($num==0)
	{
		echo "<option value='' selected=''> -- SIN RESULTADOS -- </option>";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
##################### FUNCION LISTAR PRECIOS POR CODIGO COMBO ######################

############################# FUNCION LISTAR COMBOS EN MODAL ################################
public function ListarCombosModal()
{
	self::SetNames();
	$sql = "SELECT 
	combos.idcombo,
	combos.codcombo,
	combos.nomcombo,
	combos.codfamilia,
	combos.preciocompra,
	combos.precioxmayor,
	combos.precioxmenor,
	combos.precioxpublico,
	combos.existencia,
	combos.stockminimo,
	combos.stockmaximo,
	combos.ivacombo,
	combos.desccombo,
	combos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
 	familias.nomfamilia,
	sucursales.codmoneda,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo
	FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
    WHERE combos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION LISTAR COMBOS EN MODAL ################################

############################ FUNCION ID COMBOS #################################
public function CombosPorId()
{
	self::SetNames();
	$sql = "SELECT
	combos.idcombo,
	combos.codcombo,
	combos.nomcombo,
	combos.codfamilia,
	combos.preciocompra,
	combos.precioxmayor,
	combos.precioxmenor,
	combos.precioxpublico,
	combos.existencia,
	combos.stockminimo,
	combos.stockmaximo,
	combos.ivacombo,
	combos.desccombo,
	combos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
 	familias.nomfamilia,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio
	FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE combos.codcombo = ? AND combos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcombo"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID COMBOS #################################

############################ FUNCION VER PRODUCTOS EN COMBOS ############################
public function VerDetallesProductos()
{
	self::SetNames();
	$sql ="SELECT 
	combosxproductos.codcombo,
	combosxproductos.iddetallecombo,
	combosxproductos.idproducto,  
	combosxproductos.codproducto,
	combosxproductos.cantidad,
	combosxproductos.codsucursal, 
	productos.producto, 
	productos.preciocompra,  
	productos.precioxpublico AS precioventa, 
	productos.existencia,
	productos.descproducto, 
	productos.codmarca, 
	productos.codmodelo,
	productos.codpresentacion,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion
	FROM combosxproductos 
	LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
	LEFT JOIN marcas ON productos.codmarca = marcas.codmarca
    LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion 
	WHERE combosxproductos.codcombo = ? 
	AND combosxproductos.codsucursal = ?
	GROUP BY combosxproductos.codproducto, combosxproductos.codsucursal";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcombo"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
	echo "";		
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION VER PRODUCTOS EN COMBOS ############################

############################ FUNCION DETALLE COMBO #################################
public function DetallesComboPorId()
{
	self::SetNames();
	$sql = "SELECT
	combos.idcombo,
	combos.codcombo,
	combos.nomcombo,
	combos.codfamilia,
	combos.preciocompra,
	combos.precioxmayor,
	combos.precioxmenor,
	combos.precioxpublico,
	combos.existencia,
	combos.stockminimo,
	combos.stockmaximo,
	combos.ivacombo,
	combos.desccombo,
	combos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.posicionimpuesto,
	impuestos.valorimpuesto,
 	familias.nomfamilia
	FROM combos LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
	LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
    WHERE combos.idcombo = ? AND combos.codcombo = ? AND combos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["d_id"]),limpiar($_GET["d_codigo"]),limpiar($_SESSION["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION DETALLE COMBO #################################

############################ FUNCION DETALLE PRODUCTOS POR COMBO ############################
public function DetallesProductosxCombo()
{
	self::SetNames();
	$sql ="SELECT 
	combosxproductos.codcombo,
	combosxproductos.idproducto,  
	combosxproductos.codproducto, 
	combosxproductos.cantidad, 
	productos.producto, 
	productos.descproducto, 
	productos.codmarca,
	productos.codmodelo, 
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM combosxproductos 
	LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
	LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON productos.codcolor = colores.codcolor
	WHERE combosxproductos.codcombo = ? 
	AND combosxproductos.codsucursal = ?
	GROUP BY combosxproductos.codproducto, combosxproductos.codsucursal";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["d_codigo"]),limpiar($_SESSION["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
	echo "";		
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION DETALLE PRODUCTOS POR COMBO ############################

############################ FUNCION ACTUALIZAR COMBOS ############################
public function ActualizarCombos()
{
	self::SetNames();
	if(empty($_POST["codcombo"]) or empty($_POST["nomcombo"]) or empty($_POST["codfamilia"]) or empty($_POST["precioxpublico"]) or empty($_POST["existencia"]) or empty($_POST["ivacombo"]) or empty($_POST["desccombo"]) or empty($_POST["codsucursal"]))
	{
	    echo "1";
		exit;
	}

	################## PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ####################
	$this->dbh->beginTransaction();
	if (isset($_POST["codproducto"])) {
	    for($i=0;$i<count($_POST['codproducto']);$i++){  //recorro el array
		    if (!empty($_POST['codproducto'][$i])) {

		        if($_POST['cantidad'][$i] == "" || $_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		            echo "2";
		            exit();
	            }
		    }
        }
	}
	$this->dbh->commit();
	################### PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ##################

	$sql = "SELECT codcombo FROM combos WHERE idcombo != ? AND codcombo = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["idcombo"]),decrypt($_POST["codcombo"]),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE combos set"
		." nomcombo = ?, "
		." codfamilia = ?, "
		." preciocompra = ?, "
		." precioxmayor = ?, "
		." precioxmenor = ?, "
		." precioxpublico = ?, "
		." existencia = ?, "
		." stockminimo = ?, "
		." stockmaximo = ?, "
		." ivacombo = ?, "
		." desccombo = ? "
		." WHERE "
		." idcombo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nomcombo);
		$stmt->bindParam(2, $codfamilia);
		$stmt->bindParam(3, $preciocompra);
		$stmt->bindParam(4, $precioxmayor);
		$stmt->bindParam(5, $precioxmenor);
		$stmt->bindParam(6, $precioxpublico);
		$stmt->bindParam(7, $existencia);
		$stmt->bindParam(8, $stockminimo);
		$stmt->bindParam(9, $stockmaximo);
		$stmt->bindParam(10, $ivacombo);
		$stmt->bindParam(11, $desccombo);
		$stmt->bindParam(12, $idcombo);

		$nomcombo       = limpiar($_POST["nomcombo"]);
		$codfamilia     = limpiar(decrypt($_POST["codfamilia"]));
		$preciocompra   = limpiar($_POST["preciocompra"]);
		$precioxmayor   = limpiar($_POST["precioxmayor"]);
		$precioxmenor   = limpiar($_POST["precioxmenor"]);
		$precioxpublico = limpiar($_POST["precioxpublico"]);
		$existencia     = limpiar($_POST["existencia"]);
		$stockminimo    = limpiar($_POST["stockminimo"]);
		$stockmaximo    = limpiar($_POST["stockmaximo"]);
		$ivacombo       = limpiar(decrypt($_POST["ivacombo"]));
		$desccombo      = limpiar($_POST["desccombo"]);
		$codcombo       = limpiar(decrypt($_POST["codcombo"]));
		$idcombo        = limpiar(decrypt($_POST["idcombo"]));
		$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		############################## SUBIR FOTO DE COMBO ##############################
		$dirmake        = limpiar(is_dir('./fotos/combos/'.$codsucursal) ? "" : mkdir('./fotos/combos/'.$codsucursal, 0777));
		$permitidos     = array("image/jpg", "image/jpeg", "image/png");
		$limite_kb      = 0;
	    //datos del arhivo  
	    $nombre_archivo = limpiar(isset($_FILES['imagen']['name']) ? $_FILES['imagen']['name'] : "");
		$tipo_archivo   = limpiar(isset($_FILES['imagen']['type']) ? $_FILES['imagen']['type'] : "");
		$tamano_archivo = limpiar(isset($_FILES['imagen']['size']) ? $_FILES['imagen']['size'] : "");
		//$extension = pathinfo($nombre_archivo, PATHINFO_EXTENSION);
		$file           = new SplFileInfo($nombre_archivo);
		$extension      = $file->getExtension();
	    //compruebo si las características del archivo son las que deseo 
	    if(!empty($_FILES["imagen"]) && in_array($_FILES['imagen']['type'], $permitidos)){
	 
	      if (move_uploaded_file($_FILES['imagen']['tmp_name'], "./fotos/combos/".$codsucursal."/".$nombre_archivo) && rename("./fotos/combos/".$codsucursal."/".$nombre_archivo,"./fotos/combos/".$codsucursal."/".$codcombo.".".$extension))
		   { 
		   ## se puede dar un aviso
		   } 
		   ## se puede dar otro aviso 
		}
		############################## SUBIR FOTO DE COMBO ##############################

	################## PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ####################
	$this->dbh->beginTransaction();
	if (isset($_POST["codproducto"])) {
	    for($i=0;$i<count($_POST['codproducto']);$i++){  //recorro el array
		    if (!empty($_POST['codproducto'][$i])) {

			   	$query = "UPDATE combosxproductos set"
			   	." cantidad = ? "
			   	." WHERE "
			   	." iddetallecombo = ?;
			   	";
			   	$stmt = $this->dbh->prepare($query);
			   	$stmt->bindParam(1, $cantidad);
			   	$stmt->bindParam(2, $iddetallecombo);
			   	//$stmt->bindParam(3, $idproducto);
			   	//$stmt->bindParam(4, $codproducto);
				//$stmt->bindParam(5, $codsucursal);

			   	$cantidad       = limpiar($_POST['cantidad'][$i]);
			   	$codcombo       = limpiar(decrypt($_POST["codcombo"]));
			   	$iddetallecombo = limpiar($_POST['iddetallecombo'][$i]);
			   	$idproducto     = limpiar($_POST['idproducto'][$i]);
			   	$codproducto    = limpiar($_POST['codproducto'][$i]);
			    $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			   	$stmt->execute();
		    }
        }
	}
	$this->dbh->commit();
	################### PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ##################
        
	echo "<span class='fa fa-check-square-o'></span> EL COMBO HA SIDO ACTUALIZADO EXITOSAMENTE";
	exit;

	} else {

		echo "3";
		exit;
	}
}
############################ FUNCION ACTUALIZAR COMBOS ############################

############################ FUNCION AGREGAR PRODUCTOS A COMBOS ############################
public function AgregarProductosxCombo()
{
   self::SetNames();
	if(empty($_POST["codcombo"]) or empty($_SESSION["CarritoProducto"]))
	{
		echo "1";
		exit;
	}

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$v = $_SESSION["CarritoProducto"];
	for($i=0;$i<count($v);$i++){

		$sql = "SELECT existencia
		FROM productos 
		WHERE codproducto = '".limpiar($v[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		
		$cantproductobd = $row['existencia'];
		$cantidad = $v[$i]['cantidad'];

        if($cantidad == "" || $cantidad == 0 || $cantidad == 0.00){

		    echo "2";
		    exit();
	    }
	    elseif ($cantidad > $cantproductobd) 
        { 
		    echo "2";
		    exit;
	    }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################## PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ####################
	$this->dbh->beginTransaction();

	$detalle = $_SESSION["CarritoProducto"];
	for($i=0;$i<count($detalle);$i++){

		$sql = "SELECT 
		codcombo, 
		codproducto 
		FROM combosxproductos 
		WHERE codcombo = '".limpiar(decrypt($_POST['codcombo']))."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num == 0)
		{
			################### REGISTRO PRODUCTOS ###################
			$query = " INSERT INTO combosxproductos values (null, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcombo);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $cantidad);
			$stmt->bindParam(5, $codsucursal);
			
			$codcombo    = limpiar(decrypt($_POST["codcombo"]));
			$idproducto  = limpiar($detalle[$i]['id']);
			$codproducto = limpiar($detalle[$i]['txtCodigo']);
			$cantidad    = number_format($detalle[$i]['cantidad'], 2, '.', '');
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			################### REGISTRO PRODUCTOS ###################

		} else {

			$sql = "SELECT 
			cantidad
			FROM combosxproductos 
			WHERE codcombo = '".limpiar(decrypt($_POST["codcombo"]))."' 
			AND idproducto = '".limpiar($detalle[$i]['id'])."' 
			AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$cantidadbd = $row['cantidad'];

			################### ACTUALIZO PRODUCTOS ###################
			$query = "UPDATE combosxproductos set"
			." cantidad = ? "
			." WHERE "
			." codcombo = ? AND idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $cantidad);
			$stmt->bindParam(2, $codcombo);
			$stmt->bindParam(3, $idproducto);
			$stmt->bindParam(4, $codproducto);
			$stmt->bindParam(5, $codsucursal);

			$cantidad    = limpiar($cantidadbd+$detalle[$i]['cantidad']);
			$codcombo    = limpiar(decrypt($_POST["codcombo"]));
			$idproducto  = limpiar($detalle[$i]['id']);
			$codproducto = limpiar($detalle[$i]['txtCodigo']);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			################### ACTUALIZO PRODUCTOS ###################
		}
	}
	unset($_SESSION["CarritoProducto"]);
    $this->dbh->commit();
	################### PROCESO DE REGISTRO DE PRODUCTOS A COMBOS ##################

	############## ACTUALIZAMOS LOS PRECIO DEL COMBO ###################
    /*$sql2 = " UPDATE combos set "
    ." preciocompra = ?, "
    ." precioventa = ? "
    ." WHERE "
    ." codcombo = ? AND codsucursal = ?;
    ";
    $stmt = $this->dbh->prepare($sql2);
    $stmt->bindParam(1, $preciocompra);
    $stmt->bindParam(2, $precioventa);
    $stmt->bindParam(3, $codcombo);
	$stmt->bindParam(4, $codsucursal);

    $preciocompra = number_format($_POST["preciocomprabd"]+$_POST["preciocompra"], 2, '.', '');
    $precioventa = number_format($_POST["precioventabd"]+$_POST["precioventa"], 2, '.', '');
	$codcombo = limpiar(decrypt($_POST["codcombo"]));
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
    $stmt->execute();*/
    ############## ACTUALIZAMOS LOS PRECIO DEL COMBO ###################
        
	echo "<span class='fa fa-check-square-o'></span> LOS PRODUCTOS FUERON AGREGADOS AL COMBO EXITOSAMENTE";
	exit;
}
############################ FUNCION AGREGAR PRODUCTOS A COMBOS ############################

########################## FUNCION ELIMINAR DETALLES COMBOS ###########################
public function EliminarDetalleCombo()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT 
	preciocompra,
	precioxpublico AS precioventa FROM productos 
	WHERE codproducto = '".limpiar(decrypt($_GET["codproducto"]))."'
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
	$this->p[] = $row;
	}
	$preciocomprabd = $row["preciocompra"];
	$precioventabd = $row["precioventa"];

	$racionbd = decrypt($_GET["cantidad"]);
	$totalracioncompra = number_format($racionbd * $preciocomprabd, 2, '.', '');
	$totalracionventa = number_format($racionbd * $precioventabd, 2, '.', '');
    
    $sql = "DELETE FROM combosxproductos 
    WHERE codcombo = ? 
    AND idproducto = ? 
    AND codproducto = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1,$codcombo);
	$stmt->bindParam(2,$idproducto);
	$stmt->bindParam(3,$codproducto);
	$stmt->bindParam(4,$codsucursal);

	$codcombo    = limpiar(decrypt($_GET["codcombo"]));
	$idproducto  = limpiar(decrypt($_GET["idproducto"]));
	$codproducto = limpiar(decrypt($_GET["codproducto"]));
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
	$stmt->execute();

	/*############ ACTUALIZAMOS PRECIO DEL COMBO ################
    /*$sql2 = " UPDATE combos set "
    ." preciocompra = ?, "
    ." precioventa = ? "
    ." WHERE"
    ." codcombo = ? AND codsucursal = ?;
    ";
    $stmt = $this->dbh->prepare($sql2);
    $stmt->bindParam(1, $preciocompra);
    $stmt->bindParam(2, $precioventa);
    $stmt->bindParam(3, $codcombo);
    $stmt->bindParam(4, $codsucursal);

    $preciocompra = number_format($preciocomprabd-$totalracioncompra, 2, '.', '');
    $precioventa = number_format($precioventabd-$totalracionventa, 2, '.', '');
	$codcombo = limpiar(decrypt($_GET["codcombo"]));
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
    $stmt->execute();*/
    ############ ACTUALIZAMOS PRECIO DEL COMBO ################

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
}
########################## FUNCION ELIMINAR DETALLES COMBOS #################################

########################## FUNCION ELIMINAR COMBOS ###########################
public function EliminarCombos()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codproducto FROM detalleventas WHERE codproducto = ? AND codsucursal = ? AND tipodetalle = 2";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcombo"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		################### ELIMINO COMBO ###################
		$sql = "DELETE FROM combos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcombo);
		$stmt->bindParam(2,$codsucursal);

		$codcombo = decrypt($_GET["codcombo"]);
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		################### ELIMINO COMBO ###################

		################### ELIMINO KARDEX ###################
		$sql = "DELETE FROM kardex WHERE codproducto = ? AND codsucursal = ? AND tipokardex = 2";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcombo);
		$stmt->bindParam(2,$codsucursal);

		$codcombo = decrypt($_GET["codcombo"]);
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		################### ELIMINO KARDEX ###################

		################### ELIMINO PRODUCTOS ###################
		$sql = "DELETE FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcombo);
		$stmt->bindParam(2,$codsucursal);

		$codcombo = decrypt($_GET["codcombo"]);
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		################### ELIMINO PRODUCTOS ###################

		if (file_exists("fotos/combos/".$codsucursal."_".$codcombo.".jpg")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/combos/".$codsucursal."_".$codcombo.".jpg";		
		unlink($archivos);
	    } else if (file_exists("fotos/combos/".$codsucursal."_".$codcombo.".jpeg")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/combos/".$codsucursal."_".$codcombo.".jpeg";		
		unlink($archivos);
	    } else if (file_exists("fotos/combos/".$codsucursal."_".$codcombo.".png")){
	    //funcion para eliminar una carpeta con contenido
		$archivos = "fotos/combos/".$codsucursal."_".$codcombo.".png";		
		unlink($archivos);
		}

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
########################## FUNCION ELIMINAR COMBOS #################################

######################## FUNCION BUSCA KARDEX COMBOS ##########################
public function BuscarKardexCombo() 
{
	self::SetNames();
	$sql ="SELECT
	kardex.*,
	usuarios.dni,
	usuarios.nombres,
	usuarios.nivel
	FROM kardex LEFT JOIN usuarios ON kardex.codigo = usuarios.codigo 
	WHERE kardex.codproducto = ? AND kardex.codsucursal = ? AND kardex.tipokardex = 2";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codcombo"],decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN MOVIMIENTOS EN KARDEX PARA EL COMBO INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION BUSCA KARDEX COMBOS #########################

######################## FUNCION DETALLE KARDEX COMBO #########################
public function DetalleKardexCombo()
{
	self::SetNames();
	$sql = "SELECT
	combos.idcombo,
	combos.codcombo,
	combos.nomcombo,
	combos.codfamilia,
	combos.preciocompra,
	combos.precioxmayor,
	combos.precioxmenor,
	combos.precioxpublico,
	combos.existencia,
	combos.stockminimo,
	combos.stockmaximo,
	combos.ivacombo,
	combos.desccombo,
	combos.codsucursal,
	impuestos.codimpuesto,
	impuestos.nomimpuesto,
	impuestos.valorimpuesto,
	impuestos.posicionimpuesto,
 	familias.nomfamilia,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio
	FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE combos.codcombo = ? AND combos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codcombo"],decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION DETALLE KARDEX COMBO #########################

########################### FUNCION LISTAR KARDEX COMBO VALORIZADO ################################
public function ListarKardexCombosValorizado()
{
	self::SetNames(); 
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN combosxproductos ON combos.codcombo = combosxproductos.codcombo
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia

	    LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else { 

	    $sql = "SELECT
		combos.idcombo,
		combos.codcombo,
		combos.nomcombo,
		combos.codfamilia,
		combos.preciocompra,
		combos.precioxmayor,
		combos.precioxmenor,
		combos.precioxpublico,
		combos.existencia,
		combos.stockminimo,
		combos.stockmaximo,
		combos.ivacombo,
		combos.desccombo,
		combos.codsucursal,
		impuestos.codimpuesto,
		impuestos.nomimpuesto,
		impuestos.valorimpuesto,
		impuestos.posicionimpuesto,
	 	familias.nomfamilia,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		documentos2.documento AS documento2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		pag.detalles_productos
		FROM (combos INNER JOIN sucursales ON combos.codsucursal = sucursales.codsucursal)
	    LEFT JOIN impuestos ON combos.ivacombo = impuestos.codimpuesto
		LEFT JOIN combosxproductos ON combos.codcombo = combosxproductos.codcombo
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	    LEFT JOIN familias ON combos.codfamilia = familias.codfamilia

	    LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		   LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		   LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		   LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		   LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON productos.codcolor = colores.codcolor
		   WHERE combosxproductos.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		   GROUP BY
		   combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo
		
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE combos.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY combos.codcombo
		ORDER BY combos.codcombo DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION LISTAR KARDEX COMBO VALORIZADO ################################

###################### FUNCION COMBOS VALORIZADO POR FECHAS Y VENDEDOR #########################
public function BuscarCombosValorizadoxFechas() 
{
	self::SetNames();
	$sql ="SELECT
	detalleventas.idproducto, 
	detalleventas.codproducto,
	detalleventas.producto,
	detalleventas.preciocompra, 
	detalleventas.precioventa, 
	detalleventas.descproducto,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,
	detalleventas.ivaproducto,
	detalleventas.subtotalimpuestos,
    detalleventas.tipodetalle,
	sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) AS cantidad
	FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa)
	INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
    AND detalleventas.tipodetalle = 2
	GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
	ORDER BY detalleventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION COMBOS VALORIZADO POR FECHAS Y VENDEDOR ###############################

###################### FUNCION BUSCAR COMBOS VENDIDOS POR FECHAS #########################
public function BuscarCombosVendidosxFechas() 
{
	self::SetNames();
    $sql ="SELECT
	detalleventas.idproducto, 
	detalleventas.codproducto,
	detalleventas.producto,
	detalleventas.preciocompra, 
	detalleventas.precioventa, 
	detalleventas.descproducto,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,
	detalleventas.ivaproducto,
    detalleventas.tipodetalle,
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos,
	pag.detalles_productos
	FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa)
	INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo

	LEFT JOIN
	    (SELECT
	    codcombo,
	    SUM(combosxproductos.cantidad) AS articulos,	   
	    GROUP_CONCAT(
	    	combosxproductos.cantidad, ' | ', 
		 	productos.producto, ' | ', 
		   	productos.descripcion, ' | ',
		   	if(productos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(productos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(productos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(productos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		
		FROM combosxproductos
		    LEFT JOIN productos ON combosxproductos.idproducto = productos.idproducto
		    LEFT JOIN marcas ON productos.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
		    LEFT JOIN presentaciones ON productos.codpresentacion = presentaciones.codpresentacion
		    LEFT JOIN colores ON productos.codcolor = colores.codcolor
		    WHERE combosxproductos.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		    GROUP BY
		    combosxproductos.codcombo) pag ON pag.codcombo = combos.codcombo

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
    AND detalleventas.tipodetalle = 2
	GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
	ORDER BY detalleventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
	echo "<div class='alert alert-danger'>";
	echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
	echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN COMBOS FACTURADOS PARA EL RANGO DE FECHA INGRESADA</center>";
	echo "</div>";		
	exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION COMBOS VENDIDOS POR FECHAS ###############################

############################### FIN DE CLASE COMBOS ###############################



























################################## CLASE TRASPASOS ###################################

############################## FUNCION REGISTRAR TRASPASOS ############################
public function RegistrarTraspasos()
{
	self::SetNames();
	if(empty($_POST["tipodocumento"]) or empty($_POST["sucursal_envia"]) or empty($_POST["sucursal_recibe"]) or empty($_POST["fechatraspaso"]))
	{
		echo "1";
		exit;
	}
	else if(empty($_SESSION["CarritoTraspaso"]) || $_POST["txtTotal"]=="0.00")
	{
		echo "2";
		exit;
	}

	############ VALIDO QUE NO SE INCLUYAN PRODUCTOS HIJO EN TRASPASOS #############
	$v = $_SESSION["CarritoTraspaso"];
	for($i=0;$i<count($v);$i++){
		$sqlTipo = "SELECT tipo_producto FROM productos 
		WHERE idproducto = '".limpiar($v[$i]['id'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
		$stmtTipo = $this->dbh->prepare($sqlTipo);
		$stmtTipo->execute();
		$rowTipo = $stmtTipo->fetch(PDO::FETCH_ASSOC);
		if ($rowTipo && $rowTipo['tipo_producto'] == 'HIJO') {
			echo "7"; // Código de error: Producto HIJO no puede ser traspasado
			exit;
		}
	}
	############ FIN VALIDACION PRODUCTOS HIJO #############

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	for($i=0;$i<count($v);$i++){

	    $sql = "SELECT existencia FROM productos 
	    WHERE idproducto = '".limpiar($v[$i]['id'])."'
	    AND codproducto = '".$v[$i]['txtCodigo']."' 
	    AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	    foreach ($this->dbh->query($sql) as $row)
	    {
		   $this->p[] = $row;
	    }
	
	    $existenciabd = $row['existencia'];
	    $cantidad = $v[$i]['cantidad'];

        if ($cantidad > $existenciabd) 
        { 
	        echo "3";
	        exit;
        }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	cuitsucursal, 
	nroactividadsucursal 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cuitsucursal = $row['cuitsucursal'];
	$nroactividad = $row['nroactividadsucursal'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE TRASPASO ####################
	$sql = "SELECT codtraspaso FROM traspasos 
	ORDER BY idtraspaso DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$traspaso=$row["codtraspaso"];
	}
	if(empty($traspaso))
	{
		$codtraspaso = "01";

	} else {

		$num = substr($traspaso, 0);
        $dig = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codtraspaso = $codigofinal;
	}
    ################ CREO CODIGO DE TRASPASO ###############

	################### CREO CODIGO DE FACTURA ####################
	$sql4 = "SELECT codfactura FROM traspasos 
	WHERE sucursal_envia = '".limpiar(decrypt($_POST["sucursal_envia"]))."' 
	ORDER BY idtraspaso DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$factura=$row4["codfactura"];
	}
	if(empty($factura))
	{
		$codfactura = "0000001";
		$numero_tracking = date("Ymd")."-".$codfactura;

	} else {

		$var = strlen("");
        $var1 = substr($factura , $var);
        $var2 = strlen($var1);
        $var3 = $var1 + 1;
        $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = $var4;
        $numero_tracking = date("Ymd")."-".$codfactura;
	}
    ################### CREO CODIGO DE FACTURA ####################

    ################### REGISTRO EL TRASPASO ####################
    $query = "INSERT INTO traspasos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codtraspaso);
	$stmt->bindParam(2, $tipodocumento);
	$stmt->bindParam(3, $codfactura);
	$stmt->bindParam(4, $numero_tracking);
	$stmt->bindParam(5, $sucursal_envia);
	$stmt->bindParam(6, $sucursal_recibe);
	$stmt->bindParam(7, $nombres_responsable);
	$stmt->bindParam(8, $subtotal);
	$stmt->bindParam(9, $subtotalexento);
	$stmt->bindParam(10, $subtotaliva);
	$stmt->bindParam(11, $iva);
	$stmt->bindParam(12, $totaliva);
	$stmt->bindParam(13, $descontado);
	$stmt->bindParam(14, $descuento);
	$stmt->bindParam(15, $totaldescuento);
	$stmt->bindParam(16, $totalpago);
	$stmt->bindParam(17, $totalpago2);
	$stmt->bindParam(18, $fechatraspaso);
	$stmt->bindParam(19, $observaciones);
	$stmt->bindParam(20, $codigo);
	$stmt->bindParam(21, $estado_traspaso);
	$stmt->bindParam(22, $fecha_enviado);
	$stmt->bindParam(23, $persona_recibe);
	$stmt->bindParam(24, $fecha_recibe);
	$stmt->bindParam(25, $observaciones_recibido);
	$stmt->bindParam(26, $agregar_stock);
    
	$tipodocumento          = limpiar($_POST["tipodocumento"]);
	$sucursal_envia         = limpiar(decrypt($_POST["sucursal_envia"]));
	$sucursal_recibe        = limpiar(decrypt($_POST["sucursal_recibe"]));
	$nombres_responsable    = limpiar($_POST["nombres_responsable"]);
	$subtotal               = limpiar($_POST["txtsubtotal"]);
	$subtotalexento         = limpiar($_POST["txtexento"]);
	$subtotaliva            = limpiar($_POST["txtsubtotaliva"]);
	$iva                    = limpiar($_POST["iva"]);
	$totaliva               = limpiar($_POST["txtIva"]);
	$descontado             = limpiar($_POST["txtdescontado"]);
	$descuento              = limpiar($_POST["descuento"]);
	$totaldescuento         = limpiar($_POST["txtDescuento"]);
	$totalpago              = limpiar($_POST["txtTotal"]);
	$totalpago2             = limpiar($_POST["txtTotalCompra"]);
	$fechatraspaso          = limpiar(date("Y-m-d",strtotime($_POST['fechatraspaso']))." ".date("H:i:s"));
	$observaciones          = limpiar($_POST["observaciones"]);
	$codigo                 = limpiar($_SESSION["codigo"]);
	$estado_traspaso        = limpiar($_POST["estado_traspaso"]);
	$fecha_enviado          = limpiar($_POST["estado_traspaso"] == 2 ? date("Y-m-d H:i:s") : "");
	$persona_recibe         = limpiar("0");
	$fecha_recibe           = limpiar("");
	$observaciones_recibido = limpiar("");
	$agregar_stock = limpiar("0");
	$stmt->execute();
	################### REGISTRO EL TRASPASO ####################
	
	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoTraspaso"];
	for($i=0;$i<count($detalle);$i++){

	################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
	$sql = "SELECT * FROM productos 
	WHERE idproducto = '".limpiar($detalle[$i]['id'])."'
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
	AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$existenciabd = $row['existencia'];
	################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

	################### REGISTRO DETALLES DE TRASPASO ####################
	$query = "INSERT INTO detalletraspasos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codtraspaso);
    $stmt->bindParam(2, $idproducto);
    $stmt->bindParam(3, $codproducto);
    $stmt->bindParam(4, $producto);
	$stmt->bindParam(5, $descripcion);
	$stmt->bindParam(6, $imei);
	$stmt->bindParam(7, $condicion);
	$stmt->bindParam(8, $codmarca);
	$stmt->bindParam(9, $codmodelo);
	$stmt->bindParam(10, $codpresentacion);
	$stmt->bindParam(11, $codcolor);
	$stmt->bindParam(12, $cantidad);
	$stmt->bindParam(13, $preciocompra);
	$stmt->bindParam(14, $precioventa);
	$stmt->bindParam(15, $posicionimpuesto);
	$stmt->bindParam(16, $tipoimpuesto);
	$stmt->bindParam(17, $ivaproducto);
	$stmt->bindParam(18, $descproducto);
	$stmt->bindParam(19, $valortotal);
	$stmt->bindParam(20, $totaldescuentov);
	$stmt->bindParam(21, $subtotalimpuestos);
	$stmt->bindParam(22, $valorneto);
	$stmt->bindParam(23, $valorneto2);
    $stmt->bindParam(24, $tipodetalle);
	$stmt->bindParam(25, $codsucursal);
		
	$idproducto      = limpiar($detalle[$i]['id']);
	$codproducto     = limpiar($detalle[$i]['txtCodigo']);
	$producto        = limpiar($detalle[$i]['producto']);
    $descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	$imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	$condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
	$codmarca        = limpiar($detalle[$i]['codmarca']);
	$codmodelo       = limpiar($detalle[$i]['codmodelo']);
	$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
	$codcolor        = limpiar($detalle[$i]['codcolor']);
	$cantidad        = limpiar($detalle[$i]['cantidad']);
	$preciocompra    = limpiar($detalle[$i]['precio']);
	$precioventa     = limpiar($detalle[$i]['precio2']);
	$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
	$descproducto    = limpiar($detalle[$i]['descproducto']);
	$descuento       = $detalle[$i]['descproducto']/100;
	$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
	$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');
    $valorneto       = number_format($valortotal-$totaldescuentov, 2, '.', '');

	//CALCULO SUBTOTAL IMPUESTOS
	if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
	$subtotalimpuestos    = "0.00";
    } else {
   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
	$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
	$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
	$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
    }

	$valorneto2  = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
    $tipodetalle = limpiar($detalle[$i]['tipodetalle']);
	$codsucursal = limpiar(decrypt($_POST["sucursal_envia"]));
	$stmt->execute();
	################### REGISTRO DETALLES DE TRASPASO ####################

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################

    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
	$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."'
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."';
		";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $existencia);
	$cantraspaso = limpiar($detalle[$i]['cantidad']);
	$existencia = number_format($existenciabd-$cantraspaso, 2, '.', '');
	$stmt->execute();
	##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	################ REGISTRAMOS LOS PRODUCTOS SALIENTES EN KARDEX #################
    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codtraspaso);
	$stmt->bindParam(2, $codresponsable);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $movimiento);
	$stmt->bindParam(5, $entradas);
	$stmt->bindParam(6, $salidas);
	$stmt->bindParam(7, $devolucion);
	$stmt->bindParam(8, $stockactual);
	$stmt->bindParam(9, $ivaproducto);
	$stmt->bindParam(10, $descproducto);
	$stmt->bindParam(11, $precio);
	$stmt->bindParam(12, $documento);
	$stmt->bindParam(13, $fechakardex);	
	$stmt->bindParam(14, $tipokardex);	
	$stmt->bindParam(15, $procedimiento);	
	$stmt->bindParam(16, $codsucursal);
	$stmt->bindParam(17, $codigo);

	$codresponsable = limpiar(decrypt($_POST["sucursal_recibe"]));
	$codproducto    = limpiar($detalle[$i]['txtCodigo']);
	$movimiento     = limpiar("SALIDAS");
	$entradas       = limpiar("0.00");
	$salidas        = limpiar($detalle[$i]['cantidad']);
	$devolucion     = limpiar("0.00");
	$stockactual    = limpiar($existenciabd-$detalle[$i]['cantidad']);
	$precio         = limpiar($detalle[$i]["precio2"]);
	$ivaproducto    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
	$descproducto   = limpiar($detalle[$i]['descproducto']);
	$documento      = limpiar("TRASPASO: ".$codfactura);
	$fechakardex    = limpiar(date("Y-m-d H:i:s"));
	$tipokardex     = limpiar($detalle[$i]['tipodetalle']);
	$procedimiento  = limpiar("1");
	$codsucursal    = limpiar(decrypt($_POST["sucursal_envia"]));
    $codigo         = limpiar($_SESSION["codigo"]);
	$stmt->execute();
	################ REGISTRAMOS LOS PRODUCTOS SALIENTES EN KARDEX #################

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################

    }//FIN SESSION DETALLES
        
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoTraspaso"]);
    $this->dbh->commit();
    ################################### REGISTRO DETALLES DE FACTURA ###################################
		
    echo "<span class='fa fa-check-square-o'></span> EL TRASPASO DE PRODUCTOS HA SIDO REALIZADO EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codtraspaso=".encrypt($codtraspaso)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
############################## FUNCION REGISTRAR TRASPASOS #############################

############################## FUNCION LISTAR TRASPASOS ################################
public function ListarTraspasos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		traspasos.idtraspaso,
		traspasos.codtraspaso,
		traspasos.tipodocumento,
		traspasos.codfactura,
	    traspasos.numero_tracking,
		traspasos.sucursal_envia,
		traspasos.sucursal_recibe,
		traspasos.nombres_responsable,
		traspasos.subtotal,
		traspasos.subtotalexento,
		traspasos.subtotaliva,
		traspasos.iva,
		traspasos.totaliva,
		traspasos.descontado,
		traspasos.descuento,
		traspasos.totaldescuento,
		traspasos.totalpago,
		traspasos.totalpago2,
		traspasos.fechatraspaso,
		traspasos.observaciones,
		traspasos.codigo,
		traspasos.estado_traspaso,
		traspasos.fecha_enviado,
		traspasos.persona_recibe,
		traspasos.fecha_recibe,
		traspasos.observaciones_recibido,
		traspasos.agregar_stock,
		documentos.documento,
		documentos2.documento AS documento2,
		sucursales.documsucursal,
		sucursales.cuitsucursal,
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		documentos3.documento AS documento3,
		documentos4.documento AS documento4,
		sucursales2.documsucursal AS documsucursal2,
		sucursales2.cuitsucursal AS cuitsucursal2,
		sucursales2.nomsucursal AS nomsucursal2,
		sucursales2.documencargado AS documencargado2,
		sucursales2.dniencargado AS dniencargado2,
		sucursales2.nomencargado AS nomencargado2,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		usuarios.dni,
		usuarios.nombres,
		usuarios2.dni AS dni2,
		usuarios2.nombres AS nombres2,
		pag.articulos,
		pag.detalles_productos	
		FROM (traspasos LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN sucursales AS sucursales2 ON traspasos.sucursal_recibe = sucursales2.codsucursal
		LEFT JOIN documentos AS documentos3 ON sucursales.documsucursal = documentos3.coddocumento
		LEFT JOIN documentos AS documentos4 ON sucursales.documencargado = documentos4.coddocumento
		LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo 
		LEFT JOIN usuarios AS usuarios2 ON traspasos.persona_recibe = usuarios2.codigo

		LEFT JOIN
			(SELECT
			codtraspaso,
			SUM(detalletraspasos.cantidad) AS articulos,
			GROUP_CONCAT(
			   	detalletraspasos.cantidad, ' | ', 
			   	detalletraspasos.producto, ' | ', 
			   	detalletraspasos.descripcion, ' | ',
			   	if(detalletraspasos.codmarca='0','',marcas.nommarca), ' | ',
			   	if(detalletraspasos.codmodelo='0','',modelos.nommodelo), ' | ', 
			   	if(detalletraspasos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
			   	if(detalletraspasos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

			FROM detalletraspasos
			   LEFT JOIN marcas ON detalletraspasos.codmarca = marcas.codmarca
			   LEFT JOIN modelos ON detalletraspasos.codmodelo = modelos.codmodelo 
			   LEFT JOIN presentaciones ON detalletraspasos.codpresentacion = presentaciones.codpresentacion
			   LEFT JOIN colores ON detalletraspasos.codcolor = colores.codcolor
			   WHERE detalletraspasos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			   GROUP BY
			   detalletraspasos.codtraspaso) pag ON pag.codtraspaso = traspasos.codtraspaso

		WHERE traspasos.sucursal_envia = '".limpiar(decrypt($_GET["codsucursal"]))."'
		GROUP BY traspasos.codtraspaso, traspasos.sucursal_envia
		ORDER BY traspasos.idtraspaso ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

	    $sql = "SELECT 
		traspasos.idtraspaso,
		traspasos.codtraspaso,
		traspasos.tipodocumento,
		traspasos.codfactura,
	    traspasos.numero_tracking,
		traspasos.sucursal_envia,
		traspasos.sucursal_recibe,
		traspasos.nombres_responsable,
		traspasos.subtotal,
		traspasos.subtotalexento,
		traspasos.subtotaliva,
		traspasos.iva,
		traspasos.totaliva,
		traspasos.descontado,
		traspasos.descuento,
		traspasos.totaldescuento,
		traspasos.totalpago,
		traspasos.totalpago2,
		traspasos.fechatraspaso,
		traspasos.observaciones,
		traspasos.codigo,
		traspasos.estado_traspaso,
		traspasos.fecha_enviado,
		traspasos.persona_recibe,
		traspasos.fecha_recibe,
		traspasos.observaciones_recibido,
		traspasos.agregar_stock,
		documentos.documento,
		documentos2.documento AS documento2,
		sucursales.documsucursal,
		sucursales.cuitsucursal,
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		documentos3.documento AS documento3,
		documentos4.documento AS documento4,
		sucursales2.documsucursal AS documsucursal2,
		sucursales2.cuitsucursal AS cuitsucursal2,
		sucursales2.nomsucursal AS nomsucursal2,
		sucursales2.documencargado AS documencargado2,
		sucursales2.dniencargado AS dniencargado2,
		sucursales2.nomencargado AS nomencargado2,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		usuarios.dni,
		usuarios.nombres,
		usuarios2.dni AS dni2,
		usuarios2.nombres AS nombres2,
		pag.articulos,
		pag.detalles_productos 
		FROM (traspasos LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN sucursales AS sucursales2 ON traspasos.sucursal_recibe = sucursales2.codsucursal
		LEFT JOIN documentos AS documentos3 ON sucursales.documsucursal = documentos3.coddocumento
		LEFT JOIN documentos AS documentos4 ON sucursales.documencargado = documentos4.coddocumento
		LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo 
		LEFT JOIN usuarios AS usuarios2 ON traspasos.persona_recibe = usuarios2.codigo

		LEFT JOIN
			(SELECT
			codtraspaso,
			SUM(detalletraspasos.cantidad) AS articulos,
			GROUP_CONCAT(
			   	detalletraspasos.cantidad, ' | ', 
			   	detalletraspasos.producto, ' | ', 
			   	detalletraspasos.descripcion, ' | ',
			   	if(detalletraspasos.codmarca='0','',marcas.nommarca), ' | ',
			   	if(detalletraspasos.codmodelo='0','',modelos.nommodelo), ' | ', 
			   	if(detalletraspasos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
			   	if(detalletraspasos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

			FROM detalletraspasos
			   LEFT JOIN marcas ON detalletraspasos.codmarca = marcas.codmarca
			   LEFT JOIN modelos ON detalletraspasos.codmodelo = modelos.codmodelo 
			   LEFT JOIN presentaciones ON detalletraspasos.codpresentacion = presentaciones.codpresentacion
			   LEFT JOIN colores ON detalletraspasos.codcolor = colores.codcolor
			   WHERE detalletraspasos.codsucursal = '".limpiar($_SESSION['codsucursal'])."'
			   GROUP BY
			   detalletraspasos.codtraspaso) pag ON pag.codtraspaso = traspasos.codtraspaso

		WHERE (traspasos.sucursal_envia = '".limpiar($_SESSION["codsucursal"])."'
		OR traspasos.sucursal_recibe = '".limpiar($_SESSION["codsucursal"])."') 
		GROUP BY traspasos.codtraspaso, traspasos.sucursal_envia 
		ORDER BY traspasos.idtraspaso ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
############################ FUNCION LISTAR TRASPASOS ############################

############################ FUNCION ID TRASPASOS #################################
public function TraspasosPorId()
{
	self::SetNames();
	$sql = "SELECT 
	traspasos.idtraspaso,
	traspasos.codtraspaso,
	traspasos.tipodocumento,
	traspasos.codfactura,
	traspasos.numero_tracking,
	traspasos.sucursal_envia,
	traspasos.sucursal_recibe,
	traspasos.nombres_responsable,
	traspasos.subtotal,
	traspasos.subtotalexento,
	traspasos.subtotaliva,
	traspasos.iva,
	traspasos.totaliva,
	traspasos.descontado,
	traspasos.descuento,
	traspasos.totaldescuento,
	traspasos.totalpago,
	traspasos.totalpago2,
	traspasos.fechatraspaso,
	traspasos.observaciones,
	traspasos.codigo,
	traspasos.estado_traspaso,
	traspasos.fecha_enviado,
	traspasos.persona_recibe,
	traspasos.fecha_recibe,
	traspasos.observaciones_recibido,
	traspasos.agregar_stock, 
	documentos.documento,
	documentos2.documento AS documento2,
	sucursales.documsucursal,
	sucursales.cuitsucursal,
	sucursales.nomsucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	provincias.provincia,
	departamentos.departamento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	documentos3.documento AS documento3,
	documentos4.documento AS documento4,
	sucursales2.documsucursal AS documsucursal2,
	sucursales2.cuitsucursal AS cuitsucursal2,
	sucursales2.nomsucursal AS nomsucursal2,
	sucursales2.id_provincia AS id_provincia2,
	sucursales2.id_departamento AS id_departamento2,
	sucursales2.direcsucursal AS direcsucursal2,
	sucursales2.correosucursal AS correosucursal2,
	sucursales2.tlfsucursal AS tlfsucursal2,
	sucursales2.documencargado AS documencargado2,
	sucursales2.dniencargado AS dniencargado2,
	sucursales2.nomencargado AS nomencargado2,
	sucursales2.tlfencargado AS tlfencargado2,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	usuarios.dni, 
	usuarios.nombres,
	usuarios2.dni AS dni2,
	usuarios2.nombres AS nombres2,
	pag.articulos
	FROM (traspasos LEFT JOIN detalletraspasos ON detalletraspasos.codtraspaso = traspasos.codtraspaso)
	LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN sucursales AS sucursales2 ON traspasos.sucursal_recibe = sucursales2.codsucursal
	LEFT JOIN documentos AS documentos3 ON sucursales.documsucursal = documentos3.coddocumento
	LEFT JOIN documentos AS documentos4 ON sucursales.documencargado = documentos4.coddocumento
	LEFT JOIN provincias AS provincias2 ON sucursales.id_provincia = provincias2.id_provincia
	LEFT JOIN departamentos AS departamentos2 ON sucursales.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo
	LEFT JOIN usuarios AS usuarios2 ON traspasos.persona_recibe = usuarios2.codigo
	LEFT JOIN
	   (SELECT
	   codtraspaso,
	   SUM(detalletraspasos.cantidad) AS articulos
	   FROM detalletraspasos
	   WHERE detalletraspasos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detalletraspasos.codtraspaso) pag ON pag.codtraspaso = traspasos.codtraspaso 
	WHERE traspasos.codtraspaso = ? AND traspasos.sucursal_envia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codtraspaso"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID TRASPASOS #################################

############################ FUNCION VER DETALLES TRASPASOS ###########################
public function VerDetallesTraspasos()
{
	self::SetNames();
	$sql = "SELECT
	detalletraspasos.coddetalletraspaso,
	detalletraspasos.codtraspaso,
	detalletraspasos.idproducto,
	detalletraspasos.codproducto,
	detalletraspasos.producto,
	detalletraspasos.descripcion,
	detalletraspasos.imei,
	detalletraspasos.condicion,
	detalletraspasos.codmarca,
	detalletraspasos.codmodelo,
	detalletraspasos.codpresentacion,
	detalletraspasos.codcolor,
	detalletraspasos.cantidad,
	detalletraspasos.preciocompra,
	detalletraspasos.precioventa,
	detalletraspasos.posicionimpuesto,
	detalletraspasos.tipoimpuesto,  
	detalletraspasos.ivaproducto,
	detalletraspasos.descproducto,
	detalletraspasos.valortotal, 
	detalletraspasos.totaldescuentov,
	detalletraspasos.subtotalimpuestos,
	detalletraspasos.valorneto,
	detalletraspasos.valorneto2,
	detalletraspasos.tipodetalle,
	detalletraspasos.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detalletraspasos 
	LEFT JOIN marcas ON detalletraspasos.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalletraspasos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalletraspasos.codpresentacion = presentaciones.codpresentacion 
	LEFT JOIN colores ON detalletraspasos.codcolor = colores.codcolor 
	WHERE detalletraspasos.codtraspaso = ?
	AND detalletraspasos.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codtraspaso"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION VER DETALLES TRASPASOS ############################

############################ FUNCION ACTUALIZAR TRASPASOS ##########################
public function ActualizarTraspasos()
{
	self::SetNames();
	if(empty($_POST["codtraspaso"]) or empty($_POST["tipodocumento"]) or empty($_POST["sucursal_envia"]) or empty($_POST["sucursal_recibe"]) or empty($_POST["fechatraspaso"]))
	{
		echo "1";
		exit;
	}

	############ VERIFICO QUE CANTIDAD NO SEA IGUAL A CERO #############
	for($i=0;$i<count($_POST['coddetalletraspaso']);$i++){  //recorro el array
        if (!empty($_POST['coddetalletraspaso'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
   }
   ############ VERIFICO QUE CANTIDAD NO SEA IGUAL A CERO #############

	$this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['coddetalletraspaso']);$i++){  //recorro el array
	if (!empty($_POST['coddetalletraspaso'][$i])) {

	############### OBTENGO DETALLES DE TRASPASOS ##################
	$sql = "SELECT 
	cantidad 
	FROM detalletraspasos 
	WHERE coddetalletraspaso = '".limpiar($_POST['coddetalletraspaso'][$i])."' 
	AND codtraspaso = '".limpiar(decrypt($_POST["codtraspaso"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cantidadBD = number_format($row['cantidad'], 2, '.', '');
	############### OBTENGO DETALLES DE TRASPASOS ##################

	if($cantidadBD != $_POST['cantidad'][$i]){

	############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN SALIENTE ############
    $sql = "SELECT existencia FROM productos 
    WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."'
	AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
    AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$existenciaBD  = $row['existencia'];
	$cantidad      = $_POST["cantidad"][$i];
	$cantidad2BD   = $_POST["cantidadbd"][$i];
	$totaltraspaso = number_format($cantidad-$cantidadBD, 2, '.', '');
	############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN SALIENTE ############

    if ($totaltraspaso > $existenciaBD) 
    { 
	   echo "3";
	   exit;
    }

	################### ACTUALIZO DETALLES DE TRASPASO ####################
	$query = "UPDATE detalletraspasos set"
	." cantidad = ?, "
	." valortotal = ?, "
	." totaldescuentov = ?, "
	." subtotalimpuestos = ?, "
	." valorneto = ?, "
	." valorneto2 = ? "
	." WHERE "
	." coddetalletraspaso = ? AND codtraspaso = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $cantidad);
	$stmt->bindParam(2, $valortotal);
	$stmt->bindParam(3, $totaldescuentov);
	$stmt->bindParam(4, $subtotalimpuestos);
	$stmt->bindParam(5, $valorneto);
	$stmt->bindParam(6, $valorneto2);
	$stmt->bindParam(7, $coddetalletraspaso);
	$stmt->bindParam(8, $codtraspaso);
	$stmt->bindParam(9, $codsucursal);

	$cantidad           = limpiar($_POST['cantidad'][$i]);
	$preciocompra       = limpiar($_POST['preciocompra'][$i]);
	$precioventa        = limpiar($_POST['precioventa'][$i]);
	$ivaproducto        = limpiar($_POST['ivaproducto'][$i]);
	$descuento          = $_POST['descproducto'][$i]/100;
	$valortotal         = number_format($_POST['valortotal'][$i], 2, '.', '');
	$totaldescuento     = number_format($_POST['totaldescuentov'][$i], 2, '.', '');
	$subtotalimpuestos  = number_format($_POST['subtotalimpuestos'][$i], 0, '.', '');
	$valorneto          = number_format($_POST['valorneto'][$i], 2, '.', '');
	$valorneto2         = number_format($_POST['valorneto2'][$i], 2, '.', '');
	$coddetalletraspaso = limpiar($_POST['coddetalletraspaso'][$i]);
	$codtraspaso        = limpiar(decrypt($_POST["codtraspaso"]));
	$codsucursal        = limpiar(decrypt($_POST["sucursal_envia"]));
	$stmt->execute();
	################### ACTUALIZO DETALLES DE TRASPASO ####################

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################


	############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN #1 ##############
	$sql2 = " UPDATE productos set "
	." existencia = ? "
	." WHERE "
	." idproducto = '".limpiar($_POST['idproducto'][$i])."'
	AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
	AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."';
	";
	$stmt = $this->dbh->prepare($sql2);
	$stmt->bindParam(1, $existencia);
	$existencia = number_format($existenciaBD-$totaltraspaso, 2, '.', '');
	$stmt->execute();
    ############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN #1 ##############

	############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX #1 ###############
	$sql3 = " UPDATE kardex set "
	." salidas = ?, "
	." stockactual = ? "
	." WHERE "
	." codproceso = '".limpiar($_POST["codtraspaso"])."' 
	AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
	AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'
	AND tipokardex = 1
	AND procedimiento = 1;
	";
	$stmt = $this->dbh->prepare($sql3);
	$stmt->bindParam(1, $salidas);
	$stmt->bindParam(2, $existencia);
	
	$salidas = limpiar($_POST["cantidad"][$i]);
	$stmt->execute();
	############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX #1 ###############

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################

	} else {
                echo "";

	        }
        }
    }
    $this->dbh->commit();

    ################### ACTUALIZO TRASPASO ####################
	$sql = "UPDATE traspasos SET "
	." tipodocumento = ?, "
	." nombres_responsable = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2 = ?, "
	." observaciones = ?, "
	." estado_traspaso = ?, "
	." fecha_enviado = ? "
	." WHERE "
	." codtraspaso = ? AND sucursal_envia = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $nombres_responsable);
	$stmt->bindParam(3, $subtotal);
	$stmt->bindParam(4, $subtotalexento);
	$stmt->bindParam(5, $subtotaliva);
	$stmt->bindParam(6, $totaliva);
	$stmt->bindParam(7, $descontado);
	$stmt->bindParam(8, $descuento);
	$stmt->bindParam(9, $totaldescuento);
	$stmt->bindParam(10, $totalpago);
	$stmt->bindParam(11, $totalpago2);
	$stmt->bindParam(12, $observaciones);
	$stmt->bindParam(13, $estado_traspaso);
	$stmt->bindParam(14, $fecha_enviado);
	$stmt->bindParam(15, $codtraspaso);
	$stmt->bindParam(16, $codsucursal);

	$tipodocumento       = limpiar($_POST["tipodocumento"]);
	$nombres_responsable = limpiar($_POST["nombres_responsable"]);
	$subtotal            = number_format($_POST["txtsubtotal"], 2, '.', '');
	$subtotalexento      = number_format($_POST["txtexento"], 2, '.', '');
	$subtotaliva         = number_format($_POST["txtsubtotaliva"], 2, '.', '');
	$totaliva            = number_format($_POST["txtIva"], 2, '.', '');
	$descontado          = number_format($_POST["txtdescontado"], 2, '.', '');
	$descuento           = limpiar($_POST["descuento"]);
    $totaldescuento      = number_format($_POST["txtDescuento"], 2, '.', '');
    $totalpago           = number_format($_POST["txtTotal"], 2, '.', '');
    $totalpago2          = number_format($_POST["txtTotalCompra"], 2, '.', '');
    $observaciones       = limpiar($_POST["observaciones"]);
    $estado_traspaso     = limpiar($_POST["estado_traspaso"]);
    $fecha_enviado       = limpiar($_POST["estado_traspaso"] == 2 ? date("Y-m-d H:i:s") : "");
	$codtraspaso         = limpiar(decrypt($_POST["codtraspaso"]));
    $codsucursal         = limpiar(decrypt($_POST["sucursal_envia"]));
	$stmt->execute();
	################### ACTUALIZO TRASPASO ####################

    echo "<span class='fa fa-check-square-o'></span> EL TRASPASO DE PRODUCTOS HA SIDO ACTUALIZADO EXITOSAMENTE";
	echo "<script>VentanaCentrada('reportepdf?codtraspaso=".encrypt($codtraspaso)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
######################### FUNCION ACTUALIZAR TRASPASOS ############################

######################### FUNCION AGREGAR DETALLES TRASPASOS #########################
public function AgregarDetallesTraspasos()
{
	self::SetNames();
	if(empty($_POST["codtraspaso"]) or empty($_POST["tipodocumento"]) or empty($_POST["sucursal_envia"]) or empty($_POST["sucursal_recibe"]) or empty($_POST["fechatraspaso"]))
	{
		echo "1";
		exit;
	}
    elseif(empty($_SESSION["CarritoTraspaso"]) || $_POST["txtTotal"]=="0.00")
	{
		echo "2";
		exit;
	}

	############### CONSULTO TOTAL DE TRASPASOS ###############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM traspasos 
	WHERE codtraspaso = '".limpiar(decrypt($_POST["codtraspaso"]))."' 
	AND sucursal_envia = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row['descuento'];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL DE TRASPASOS ###############

    $this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoTraspaso"];
	for($i=0;$i<count($detalle);$i++){

    ############### VERIFICO AL EXISTENCIA DEL PRODUCTO AGREGADO ################
	$sql = "SELECT * FROM productos 
	WHERE idproducto = '".limpiar($detalle[$i]['id'])."'
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
	AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$existenciaBD = $row['existencia'];
	$fechaelaboracionBD = $row['fechaelaboracion'];
	$fechaoptimoBD      = $row['fechaoptimo'];
	$fechamedioBD       = $row['fechamedio'];
	$fechaminimoBD      = $row['fechaminimo'];
	############### VERIFICO AL EXISTENCIA DEL PRODUCTO AGREGADO ################

	############# REVISAMOS QUE LA CANTIDAD NO SEA IGUAL A CERO ##############
	if($detalle[$i]['cantidad']==0){

		echo "3";
		exit;
    }
    ############# REVISAMOS QUE LA CANTIDAD NO SEA IGUAL A CERO ##############

	############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######
    if ($detalle[$i]['cantidad'] > $existenciaBD) 
    { 
        echo "4";
        exit;
    }
    ############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######

	$sql = "SELECT 
	codtraspaso, 
	codproducto 
	FROM detalletraspasos 
	WHERE codtraspaso = '".limpiar(decrypt($_POST['codtraspaso']))."' 
	AND codsucursal = '".limpiar(decrypt($_POST['sucursal_envia']))."'
	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0)
	{
        ################### REGISTRO DETALLES DE TRASPASO ####################
        $query = "INSERT INTO detalletraspasos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codtraspaso);
        $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
        $stmt->bindParam(8, $codmarca);
        $stmt->bindParam(9, $codmodelo);
        $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
		$stmt->bindParam(17, $ivaproducto);
		$stmt->bindParam(18, $descproducto);
		$stmt->bindParam(19, $valortotal);
		$stmt->bindParam(20, $totaldescuentov);
		$stmt->bindParam(21, $subtotalimpuestos);
		$stmt->bindParam(22, $valorneto);
		$stmt->bindParam(23, $valorneto2);
		$stmt->bindParam(24, $tipodetalle);
		$stmt->bindParam(25, $codsucursal);
			
		$codtraspaso     = limpiar(decrypt($_POST["codtraspaso"]));
	    $idproducto      = limpiar($detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	    $condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentov, 2, '.', '');
		$valorneto2  = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
        $tipodetalle = limpiar($detalle[$i]['tipodetalle']);
		$codsucursal = limpiar(decrypt($_POST["sucursal_envia"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE TRASPASO ####################

	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN #1 ###################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."'
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad    = limpiar($detalle[$i]['cantidad']);
		$existencia  = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN #1 ###################

		############### REGISTRAMOS LOS PRODUCTOS SALIENTES EN KARDEX #1 ###############
        $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codtraspaso);
		$stmt->bindParam(2, $codresponsable);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
		$stmt->bindParam(14, $tipokardex);	
		$stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codtraspaso     = limpiar(decrypt($_POST["codtraspaso"]));
		$codresponsable = limpiar(decrypt($_POST["sucursal_recibe"]));
		$codproducto    = limpiar($detalle[$i]['txtCodigo']);
		$movimiento     = limpiar("SALIDAS");
		$entradas       = limpiar("0.00");
		$salidas        = limpiar($detalle[$i]['cantidad']);
		$devolucion     = limpiar("0.00");
		$stockactual    = limpiar($existenciaBD-$detalle[$i]['cantidad']);
		$precio         = limpiar($detalle[$i]["precio2"]);
		$ivaproducto    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto   = limpiar($detalle[$i]['descproducto']);
		$documento      = limpiar("TRASPASO: ".$codfacturaBD);
		$fechakardex    = limpiar(date("Y-m-d H:i:s"));
		$tipokardex     = limpiar($detalle[$i]['tipodetalle']);
		$procedimiento  = limpiar("1");
		$codsucursal    = limpiar(decrypt($_POST["sucursal_envia"]));
    	$codigo         = limpiar($_SESSION["codigo"]);
		$stmt->execute();

	} else {

	  	############### OBTENGO DETALLES DE TRASPASOS ##################
	  	$sql = "SELECT cantidad FROM detalletraspasos 
	  	WHERE codtraspaso = '".limpiar(decrypt($_POST['codtraspaso']))."' 
	  	AND codsucursal = '".limpiar(decrypt($_POST['sucursal_envia']))."' 
	  	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	  	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$cantidadBD = $row['cantidad'];
		############### OBTENGO DETALLES DE TRASPASOS ##################

	  	################### ACTUALIZO DETALLES DE TRASPASO ####################
	  	$query = "UPDATE detalletraspasos set"
		." cantidad = ?, "
		." descproducto = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." codtraspaso = ? AND codsucursal = ? AND codproducto = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $descproducto);
		$stmt->bindParam(3, $valortotal);
		$stmt->bindParam(4, $totaldescuentov);
		$stmt->bindParam(5, $subtotalimpuestos);
		$stmt->bindParam(6, $valorneto);
		$stmt->bindParam(7, $valorneto2);
		$stmt->bindParam(8, $codtraspaso);
		$stmt->bindParam(9, $codsucursal);
		$stmt->bindParam(10, $codproducto);

		$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidadBD);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2'] * $cantidad, 2, '.', '');
		$totaldescuentov = number_format($valortotal * $descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

		$valorneto   = number_format($valortotal - $totaldescuentov, 2, '.', '');
		$valorneto2  = number_format($detalle[$i]['precio'] * $cantidad, 2, '.', '');
		$codtraspaso = limpiar(decrypt($_POST["codtraspaso"]));
		$codsucursal = limpiar(decrypt($_POST['sucursal_envia']));
		$codproducto = limpiar($detalle[$i]['txtCodigo']);
		$stmt->execute();
		################### ACTUALIZO DETALLES DE TRASPASO ####################

		############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO ##############
		$sql = " UPDATE productos set "
			." existencia = ? "
			." WHERE "
			." idproducto = '".limpiar($detalle[$i]['id'])."'
	        AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
			AND codsucursal = '".limpiar(decrypt($_POST['sucursal_envia']))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = limpiar($detalle[$i]['cantidad']);
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO ##############

		############### ACTUALIZAMOS DATOS EN KARDEX ##############
		$sql3 = " UPDATE kardex set "
		." salidas = ?, "
		." stockactual = ? "
		." WHERE "
		." codproceso = '".limpiar(decrypt($_POST["codtraspaso"]))."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST['sucursal_envia']))."'
		AND tipokardex = 1 AND procedimiento = 1;
		";
		$stmt = $this->dbh->prepare($sql3);
		$stmt->bindParam(1, $salidas);
		$stmt->bindParam(2, $existencia);
		
		$salidas = limpiar($detalle[$i]['cantidad']+$cantidadBD);
		$stmt->execute();
		############### ACTUALIZAMOS DATOS EN KARDEX ##############

	}//FIN DE AGREGAR DETALLES DE PRODUCTOS

    }//FIN SESSION DETALLES

    
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
    unset($_SESSION["CarritoTraspaso"]);
    $this->dbh->commit();

    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalletraspasos WHERE codtraspaso = '".limpiar(decrypt($_POST["codtraspaso"]))."' AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
     	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalletraspasos WHERE codtraspaso = '".limpiar(decrypt($_POST["codtraspaso"]))."' AND codsucursal = '".limpiar(decrypt($_POST["sucursal_envia"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ################### ACTUALIZO TRASPASO ####################
	$sql = " UPDATE traspasos SET "
	." tipodocumento = ?, "
	." nombres_responsable = ?, "
	." subtotal = ?, "
    ." subtotalexento = ?, "
    ." subtotaliva = ?, "
    ." totaliva = ?, "
    ." descontado = ?, "
    ." descuento = ?, "
    ." totaldescuento = ?, "
    ." totalpago = ?, "
    ." totalpago2 = ?, "
	." observaciones = ?, "
	." estado_traspaso = ? "
	." WHERE "
	." codtraspaso = ? AND sucursal_envia = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $nombres_responsable);
    $stmt->bindParam(3, $TxtSubtotal);
    $stmt->bindParam(4, $TxtSubtotalExento);
    $stmt->bindParam(5, $TxtSubtotalIva);
    $stmt->bindParam(6, $TxtTotalIva);
    $stmt->bindParam(7, $TxtDescontado);
    $stmt->bindParam(8, $descuento);
    $stmt->bindParam(9, $TxtTotalDescuento);
    $stmt->bindParam(10, $TxtTotal);
    $stmt->bindParam(11, $totalpago2);
	$stmt->bindParam(12, $observaciones);
	$stmt->bindParam(13, $estado_traspaso);
	$stmt->bindParam(14, $codtraspaso);
	$stmt->bindParam(15, $codsucursal);

	$tipodocumento       = limpiar($_POST["tipodocumento"]);
	$nombres_responsable = limpiar($_POST["nombres_responsable"]);

	/*###################################################### CALCULO DE DESCUENTO ######################################################*/
	//PORCENTAJE DESCUENTO
    $descuento  = $_POST["descuento"]+$descuentoBD;
    $Porcentaje = $descuento/100;

    //PORCENTAJE IVA
    $txtIva        = $ivaBD;
    $PorcentajeIva = $txtIva/100;

    /*OBTENGO DESCUENTO DE EXENTO*/
    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

    /*OBTENGO SUBTOTAL IVA*/
    $RestoSubtotalIva = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva   = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
    /*OBTENGO TOTAL IVA*/
    $TxtTotalIva      = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
   
    //CALCULO DE TOTAL FACTURA
    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
    $TxtTotal          = number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', '');
    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

	$observaciones    = limpiar($_POST["observaciones"]);
    $estado_traspaso  = limpiar($_POST["estado_traspaso"]);
    $fecha_enviado    = limpiar($_POST["estado_traspaso"] == 2 ? date("Y-m-d H:i:s") : "");
	$codtraspaso      = limpiar(decrypt($_POST["codtraspaso"]));
	$codsucursal      = limpiar(decrypt($_POST["sucursal_envia"]));
	$stmt->execute();
	################### ACTUALIZO TRASPASO ####################

    echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS AL TRASPASO EXITOSAMENTE";
	echo "<script>VentanaCentrada('reportepdf?codtraspaso=".encrypt($codtraspaso)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################### FUNCION AGREGAR DETALLES TRASPASOS #########################

########################## FUNCION ELIMINAR DETALLES TRASPASOS ##########################
public function EliminarDetallesTraspasos()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

    ############ CONSULTO TOTAL ACTUAL DE TRASPASOS ##############
	$sql = "SELECT
	codfactura,
	sucursal_recibe, 
	iva,
	descuento,
	totalpago 
	FROM traspasos 
	WHERE codtraspaso = '".limpiar(decrypt($_GET["codtraspaso"]))."' 
	AND sucursal_envia = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD      = $row['codfactura'];
	$sucursal_recibeBD = $row['sucursal_recibe'];
	$ivaBD             = $row["iva"];
	$descuentoBD       = $row["descuento"];
	$totalpagoBD       = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE TRASPASOS ##############

	$sql = "SELECT * FROM detalletraspasos WHERE codtraspaso = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codtraspaso"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		############ OBTENGO DETALLES DE TRASPASO ##############
		$sql = "SELECT
		idproducto, 
		codproducto, 
		cantidad, 
		precioventa,
		posicionimpuesto,
		tipoimpuesto, 
		ivaproducto, 
		descproducto 
		FROM detalletraspasos 
		WHERE coddetalletraspaso = ? 
		AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["coddetalletraspaso"]),decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$cantidadBD     = $row['cantidad'];
		$precioventaBD  = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];
		############ OBTENGO DETALLES DE TRASPASO ##############

    ##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################	

	############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
	$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql2);
	$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();

	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$existenciaBD = $row['existencia'];
	############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

	############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
	$sql = "UPDATE productos SET "
	." existencia = ? "
	." WHERE "
	." idproducto = ? AND codproducto = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $existencia);
	$stmt->bindParam(2, $idproducto);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $codsucursal);

	$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
	$idproducto = limpiar($idproductoBD);
	$codproducto = limpiar($codproductoBD);
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
	$stmt->execute();
	############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
	$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codtraspaso);
	$stmt->bindParam(2, $recibe);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $movimiento);
	$stmt->bindParam(5, $entradas);
	$stmt->bindParam(6, $salidas);
	$stmt->bindParam(7, $devolucion);
	$stmt->bindParam(8, $stockactual);
	$stmt->bindParam(9, $ivaproducto);
	$stmt->bindParam(10, $descproducto);
	$stmt->bindParam(11, $precio);
	$stmt->bindParam(12, $documento);
	$stmt->bindParam(13, $fechakardex);	
	$stmt->bindParam(14, $tipokardex);	
	$stmt->bindParam(15, $procedimiento);
	$stmt->bindParam(16, $codsucursal);
    $stmt->bindParam(17, $codigo);

	$codtraspaso   = limpiar(decrypt($_GET["codtraspaso"]));
	$recibe        = limpiar($sucursal_recibeBD);
	$codproducto   = limpiar($codproductoBD);
	$movimiento    = limpiar("DEVOLUCION");
	$entradas      = limpiar("0.00");
	$salidas       = limpiar("0.00");
	$devolucion    = limpiar($cantidadBD);
	$stockactual   = limpiar($existenciaBD+$cantidadBD);
	$precio        = limpiar($precioventaBD);
	$ivaproducto   = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
	$descproducto  = limpiar($descproductoBD);
	$documento     = limpiar("DEVOLUCION TRASPASO: ".$codfacturaBD);
	$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	$tipokardex    = limpiar("1");
	$procedimiento = limpiar("1");
	$codsucursal   = limpiar(decrypt($_GET["codsucursal"]));
    $codigo        = limpiar($_SESSION["codigo"]);
	$stmt->execute();
	########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

    ##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################				

	########## ELIMINO DETALLES DE TRASPASOS ##########
	$sql = "DELETE FROM detalletraspasos WHERE coddetalletraspaso = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1,$coddetalletraspaso);
	$stmt->bindParam(2,$codsucursal);
	$coddetalletraspaso = decrypt($_GET["coddetalletraspaso"]);
	$codsucursal        = decrypt($_GET["codsucursal"]);
	$stmt->execute();
	########## ELIMINO DETALLES DE TRASPASOS ##########

	############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	$sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalletraspasos WHERE codtraspaso = '".limpiar(decrypt($_GET["codtraspaso"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	foreach ($this->dbh->query($sql3) as $row3)
	{
		$this->p[] = $row3;
	}
	$subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	$subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	$subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	$subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
	############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalletraspasos WHERE codtraspaso = '".limpiar(decrypt($_GET["codtraspaso"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ################### ACTUALIZO EL TRASPASO ####################
	$sql = " UPDATE traspasos SET "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2= ? "
	." WHERE "
	." codtraspaso = ? AND sucursal_envia = ?;
	";
	$stmt = $this->dbh->prepare($sql);
    $stmt->bindParam(1, $TxtSubtotal);
    $stmt->bindParam(2, $TxtSubtotalExento);
    $stmt->bindParam(3, $TxtSubtotalIva);
    $stmt->bindParam(4, $TxtTotalIva);
    $stmt->bindParam(5, $TxtDescontado);
    $stmt->bindParam(6, $TxtTotalDescuento);
    $stmt->bindParam(7, $TxtTotal);
	$stmt->bindParam(8, $totalpago2);
	$stmt->bindParam(9, $codtraspaso);
	$stmt->bindParam(10, $codsucursal);

	###################################################### CALCULO DE DESCUENTO ######################################################*/
	//PORCENTAJE DESCUENTO
    $descuento  = $descuentoBD;
    $Porcentaje = $descuento/100;

    //PORCENTAJE IVA
    $txtIva        = $ivaBD;
    $PorcentajeIva = $txtIva/100;

    /*OBTENGO DESCUENTO DE EXENTO*/
    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

    /*OBTENGO SUBTOTAL IVA*/
    $RestoSubtotalIva = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva   = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
    /*OBTENGO TOTAL IVA*/
    $TxtTotalIva      = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
   
    //CALCULO DE TOTAL FACTURA
    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
    $TxtTotal          = number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', '');
    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

	$codtraspaso = limpiar(decrypt($_GET["codtraspaso"]));
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
	$stmt->execute();
	################### ACTUALIZO EL TRASPASO ####################

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
######################### FUNCION ELIMINAR DETALLES TRASPASOS #########################

########################## FUNCION ELIMINAR TRASPASOS #############################
public function EliminarTraspasos()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

    ########################## CONSULTO DATOS DE TRASPASO ##########################
	$sql = "SELECT
	codfactura,
	sucursal_recibe, 
	totalpago 
	FROM traspasos 
	WHERE codtraspaso = '".limpiar(decrypt($_GET["codtraspaso"]))."' 
	AND sucursal_envia = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD      = $row['codfactura'];
	$sucursal_recibeBD = $row['sucursal_recibe'];
	$totalpagoBD       = $row['totalpago'];
	########################## CONSULTO DATOS DE TRASPASO ##########################

    $sql = "SELECT * FROM detalletraspasos 
    WHERE codtraspaso = '".limpiar(decrypt($_GET["codtraspaso"]))."' 
    AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;

		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$cantidadBD     = $row['cantidad'];
		$precioventaBD  = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];

    ##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################

    ############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
	$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql2);
	$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();

	if($row2 = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row2;
	}
	$existenciaBD = $row2['existencia'];
	############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

	########### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN ############
	$sql = "UPDATE productos SET "
	." existencia = ? "
	." WHERE "
	." idproducto = ? AND codproducto = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $existencia);
	$stmt->bindParam(2, $idproducto);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $codsucursal);

	$existencia  = limpiar($existenciaBD+$cantidadBD);
	$idproducto  = limpiar($idproductoBD);
	$codproducto = limpiar($codproductoBD);
	$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
	$stmt->execute();
	########### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN ############

    ########### REGISTRAMOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ############
	$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codtraspaso);
	$stmt->bindParam(2, $recibe);
	$stmt->bindParam(3, $codproducto);
	$stmt->bindParam(4, $movimiento);
	$stmt->bindParam(5, $entradas);
	$stmt->bindParam(6, $salidas);
	$stmt->bindParam(7, $devolucion);
	$stmt->bindParam(8, $stockactual);
	$stmt->bindParam(9, $ivaproducto);
	$stmt->bindParam(10, $descproducto);
	$stmt->bindParam(11, $precio);
	$stmt->bindParam(12, $documento);
	$stmt->bindParam(13, $fechakardex);	
	$stmt->bindParam(14, $tipokardex);	
	$stmt->bindParam(15, $procedimiento);
	$stmt->bindParam(16, $codsucursal);
	$stmt->bindParam(17, $codigo);	

	$codtraspaso   = limpiar(decrypt($_GET["codtraspaso"]));
    $recibe        = limpiar($sucursal_recibeBD);
    $codproducto   = limpiar($codproductoBD);
	$movimiento    = limpiar("DEVOLUCION");
	$entradas      = limpiar("0.00");
	$salidas       = limpiar("0.00");
	$devolucion    = limpiar($cantidadBD);
	$stockactual   = limpiar($existenciaBD+$cantidadBD);
	$ivaproducto   = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
	$descproducto  = limpiar($descproductoBD);
	$precio        = limpiar($precioventaBD);
	$documento     = limpiar("DEVOLUCION TRASPASO: ".$codfacturaBD);
	$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	$tipokardex    = limpiar("1");
	$procedimiento = limpiar("1");
	$codsucursal   = limpiar(decrypt($_GET["codsucursal"]));
    $codigo        = limpiar($_SESSION["codigo"]);
	$stmt->execute();
	########### REGISTRAMOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ############

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS SALIENTES                                       #
	#                                                                                                        #
	##########################################################################################################
    		
	}

	########################## ELIMINO TRASPASOS ##########################
	$sql = "DELETE FROM traspasos WHERE codtraspaso = ? AND sucursal_envia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1,$codtraspaso);
	$stmt->bindParam(2,$codsucursal);
	$codtraspaso = decrypt($_GET["codtraspaso"]);
	$codsucursal = decrypt($_GET["codsucursal"]);
	$stmt->execute();
	########################## ELIMINO TRASPASOS ##########################

	########################## ELIMINO DETALLES TRASPASOS ##########################
	$sql = "DELETE FROM detalletraspasos WHERE codtraspaso = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1,$codtraspaso);
	$stmt->bindParam(2,$codsucursal);
	$codtraspaso = decrypt($_GET["codtraspaso"]);
	$codsucursal = decrypt($_GET["codsucursal"]);
	$stmt->execute();
	########################## ELIMINO DETALLES TRASPASOS ##########################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
########################## FUNCION ELIMINAR TRASPASOS ###########################

####################### FUNCION BUSQUEDA TRASPASOS POR FECHAS #######################
public function BuscarTraspasosxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	traspasos.idtraspaso,
	traspasos.codtraspaso,
	traspasos.tipodocumento,
	traspasos.codfactura,
	traspasos.numero_tracking,
	traspasos.sucursal_envia,
	traspasos.sucursal_recibe,
	traspasos.nombres_responsable,
	traspasos.subtotal,
	traspasos.subtotalexento,
	traspasos.subtotaliva,
	traspasos.iva,
	traspasos.totaliva,
	traspasos.descontado,
	traspasos.descuento,
	traspasos.totaldescuento,
	traspasos.totalpago,
	traspasos.totalpago2,
	traspasos.fechatraspaso,
	traspasos.observaciones,
	traspasos.codigo,
	traspasos.estado_traspaso,
	traspasos.fecha_enviado,
	traspasos.persona_recibe,
	traspasos.fecha_recibe,
	traspasos.observaciones_recibido,
	traspasos.agregar_stock,
	documentos.documento,
	documentos2.documento AS documento2,
	sucursales.documsucursal,
	sucursales.cuitsucursal,
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	documentos3.documento AS documento3,
	documentos4.documento AS documento4,
	sucursales2.documsucursal AS documsucursal2,
	sucursales2.cuitsucursal AS cuitsucursal2,
	sucursales2.nomsucursal AS nomsucursal2,
	sucursales2.documencargado AS documencargado2,
	sucursales2.dniencargado AS dniencargado2,
	sucursales2.nomencargado AS nomencargado2,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	usuarios.dni,
	usuarios.nombres,
	usuarios2.dni AS dni2,
	usuarios2.nombres AS nombres2,
	pag.articulos,
	pag.detalles_productos 
	FROM (traspasos LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN sucursales AS sucursales2 ON traspasos.sucursal_recibe = sucursales2.codsucursal
	LEFT JOIN documentos AS documentos3 ON sucursales.documsucursal = documentos3.coddocumento
	LEFT JOIN documentos AS documentos4 ON sucursales.documencargado = documentos4.coddocumento
	LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo 
	LEFT JOIN usuarios AS usuarios2 ON traspasos.persona_recibe = usuarios2.codigo

	LEFT JOIN
		(SELECT
		codtraspaso,
		SUM(detalletraspasos.cantidad) AS articulos,
		GROUP_CONCAT(
		   	detalletraspasos.cantidad, ' | ', 
		   	detalletraspasos.producto, ' | ', 
		   	detalletraspasos.descripcion, ' | ',
		   	if(detalletraspasos.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalletraspasos.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalletraspasos.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalletraspasos.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

		FROM detalletraspasos
		   LEFT JOIN marcas ON detalletraspasos.codmarca = marcas.codmarca
		   LEFT JOIN modelos ON detalletraspasos.codmodelo = modelos.codmodelo 
		   LEFT JOIN presentaciones ON detalletraspasos.codpresentacion = presentaciones.codpresentacion
		   LEFT JOIN colores ON detalletraspasos.codcolor = colores.codcolor
		   WHERE detalletraspasos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
		   GROUP BY
		   detalletraspasos.codtraspaso) pag ON pag.codtraspaso = traspasos.codtraspaso

	WHERE traspasos.sucursal_envia = ? 
	AND DATE_FORMAT(traspasos.fechatraspaso,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY traspasos.codtraspaso
	ORDER BY traspasos.codtraspaso ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON TRASPASOS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA TRASPASOS POR FECHAS ###########################

####################### FUNCION BUSQUEDA DETALLES TRASPASOS POR FECHAS #######################
public function BuscarDetallesTraspasosxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	detalletraspasos.idproducto,
	detalletraspasos.codproducto,
	detalletraspasos.producto,
	detalletraspasos.descripcion,
	detalletraspasos.imei,
	detalletraspasos.condicion,
	detalletraspasos.codmarca,
	detalletraspasos.codmodelo,
	detalletraspasos.codpresentacion,
	detalletraspasos.codcolor,
	detalletraspasos.preciocompra,
	detalletraspasos.precioventa,
	detalletraspasos.posicionimpuesto,
	detalletraspasos.tipoimpuesto,  
	detalletraspasos.ivaproducto,
	detalletraspasos.descproducto,
    detalletraspasos.tipodetalle,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	traspasos.fechatraspaso,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	documentos.documento,
	documentos2.documento AS documento2,
	usuarios.dni,
	usuarios.nombres, 
	SUM(detalletraspasos.cantidad) AS cantidad,
	pag.existencia 
	FROM (detalletraspasos LEFT JOIN traspasos ON detalletraspasos.codtraspaso = traspasos.codtraspaso)
	LEFT JOIN marcas ON detalletraspasos.codmarca = marcas.codmarca 
	LEFT JOIN modelos ON detalletraspasos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detalletraspasos.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalletraspasos.codcolor = colores.codcolor  
	LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   idproducto,
	   existencia
	   FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detalletraspasos.idproducto

	WHERE traspasos.sucursal_envia = '".decrypt($_GET['codsucursal'])."'
	AND DATE_FORMAT(traspasos.fechatraspaso,'%Y-%m-%d') BETWEEN ? AND ?
	GROUP BY detalletraspasos.codproducto, detalletraspasos.producto, detalletraspasos.precioventa, detalletraspasos.descproducto, detalletraspasos.codsucursal
	ORDER BY detalletraspasos.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
	   echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA DETALLES TRASPASOS POR FECHAS ###########################

############################ FUNCION PROCESAR TRASPASOS ############################
public function ProcesarTraspaso()
{
	self::SetNames();
	if(empty($_POST["codtraspaso"]) or empty($_POST["codsucursal"]) or empty($_POST["persona_recibe"]) or empty($_POST["estado_traspaso"]) or empty($_POST["agregar_stock"]))
	{
		echo "1";
		exit;
	}

	################### OBTENGO DATOS DE TRASPASO ######################
    $sql = "SELECT codfactura, sucursal_recibe FROM traspasos WHERE codtraspaso = ? AND sucursal_envia = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST['codtraspaso']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codfacturaBD      = $row['codfactura'];
	$sucursal_recibeBD = $row['sucursal_recibe'];
    ################### OBTENGO DATOS DE TRASPASO ######################

	############################ PROCESO EL TRASPASO ############################
    $sql = "UPDATE traspasos set "
	." estado_traspaso = ?, "
	." persona_recibe = ?, "
	." fecha_recibe = ?, "
	." observaciones_recibido = ?, "
	." agregar_stock = ? "
	." WHERE "
	." codtraspaso = ? AND sucursal_envia = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $estado_traspaso);
	$stmt->bindParam(2, $persona_recibe);
	$stmt->bindParam(3, $fecha_recibe);
	$stmt->bindParam(4, $observaciones_recibido);
	$stmt->bindParam(5, $agregar_stock);
	$stmt->bindParam(6, $codtraspaso);
	$stmt->bindParam(7, $codsucursal);

	$estado_traspaso        = limpiar($_POST["estado_traspaso"]);
    $persona_recibe         = limpiar(decrypt($_POST['persona_recibe']));
	$fecha_recibe           = limpiar(date("Y-m-d H:i:s"));
	$observaciones_recibido = limpiar($_POST["observaciones_recibido"]);
	$agregar_stock          = limpiar($_POST["agregar_stock"]);
    $codtraspaso            = limpiar(decrypt($_POST['codtraspaso']));
    $codsucursal            = limpiar(decrypt($_POST['codsucursal']));
	$stmt->execute();
	############################ PROCESO EL TRASPASO ############################

	if($_POST["estado_traspaso"] == 4 && $_POST["agregar_stock"] == 1){

	##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS ENTRANTES                                       #
	#                                                                                                        #
	##########################################################################################################
	$this->dbh->beginTransaction();

	$sql = "SELECT * FROM detalletraspasos 
	WHERE codtraspaso = '".limpiar(decrypt($_POST["codtraspaso"]))."'
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
    foreach ($this->dbh->query($sql) as $row){  
	$this->p[] = $row;

	    ############################ VERIFICO SI EXISTE EN SUCURSAL ############################
		$sql = "SELECT codproducto FROM productos WHERE codproducto = ? AND producto = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(limpiar($row['codproducto']),limpiar($row['producto']),limpiar($sucursal_recibeBD)));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			############################## VERIFICO EXISTENCIA EN SUCURSAL QUE ENVIA ##############################
			$sql2 = "SELECT
			productos.*,
			impuestos.codimpuesto,
			impuestos.nomimpuesto,
			impuestos.valorimpuesto
			FROM productos LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
			WHERE productos.codproducto = '".limpiar($row['codproducto'])."' 
			AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql2) as $row2)
			{
				$this->p[] = $row2;
			}
			############################## VERIFICO EXISTENCIA EN SUCURSAL QUE ENVIA ##############################

	        ############################## REGISTRO DATOS DE PRODUCTOS ##############################
			$query = "INSERT INTO productos values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codproducto);
			$stmt->bindParam(2, $producto);
			$stmt->bindParam(3, $descripcion);
			$stmt->bindParam(4, $imei);
			$stmt->bindParam(5, $condicion);
			$stmt->bindParam(6, $fabricante);
			$stmt->bindParam(7, $codfamilia);
			$stmt->bindParam(8, $codsubfamilia);
			$stmt->bindParam(9, $codmarca);
			$stmt->bindParam(10, $codmodelo);
			$stmt->bindParam(11, $codpresentacion);
			$stmt->bindParam(12, $codcolor);
			$stmt->bindParam(13, $codorigen);
			$stmt->bindParam(14, $year);
			$stmt->bindParam(15, $nroparte);
			$stmt->bindParam(16, $lote);
			$stmt->bindParam(17, $peso);
			$stmt->bindParam(18, $preciocompra);
			$stmt->bindParam(19, $precioxmayor);
			$stmt->bindParam(20, $precioxmenor);
			$stmt->bindParam(21, $precioxpublico);
			$stmt->bindParam(22, $existencia);
			$stmt->bindParam(23, $stockoptimo);
			$stmt->bindParam(24, $stockmedio);
			$stmt->bindParam(25, $stockminimo);
			$stmt->bindParam(26, $ivaproducto);
			$stmt->bindParam(27, $descproducto);
			$stmt->bindParam(28, $codigobarra);
			$stmt->bindParam(29, $fechaelaboracion);
			$stmt->bindParam(30, $fechaoptimo);
			$stmt->bindParam(31, $fechamedio);
			$stmt->bindParam(32, $fechaminimo);
			$stmt->bindParam(33, $codproveedor);
			$stmt->bindParam(34, $stockteorico);
			$stmt->bindParam(35, $motivoajuste);
			$stmt->bindParam(36, $recibe);

			$codproducto      = limpiar($row["codproducto"]);
			$producto         = limpiar($row["producto"]);
			$descripcion      = limpiar($row["descripcion"]);
			$imei             = limpiar($row["imei"]);
			$condicion        = limpiar($row["condicion"]);
			$fabricante       = limpiar($row2["fabricante"]);
			$codfamilia       = limpiar($row2["codfamilia"]);
			$codsubfamilia    = limpiar($row2["codsubfamilia"]);
			$codmarca         = limpiar($row["codmarca"]);
			$codmodelo        = limpiar($row["codmodelo"]);
			$codpresentacion  = limpiar($row["codpresentacion"]);
			$codcolor         = limpiar($row["codcolor"]);
			$codorigen        = limpiar($row2["codorigen"]);
			$year             = limpiar($row2["year"]);
			$nroparte         = limpiar($row2["nroparte"]);
			$lote             = limpiar($row2["lote"]);
			$peso             = limpiar($row2["peso"]);
			$preciocompra     = limpiar($row["preciocompra"]);
			$precioxmayor     = limpiar($row2["precioxmayor"]);
			$precioxmenor     = limpiar($row2["precioxmenor"]);
			$precioxpublico   = limpiar($row["precioventa"]);
			$existencia       = limpiar($row["cantidad"]);
			$stockoptimo      = limpiar($row2["stockoptimo"]);
			$stockmedio       = limpiar($row2["stockmedio"]);
			$stockminimo      = limpiar($row2["stockminimo"]);
		    $ivaproducto      = limpiar($row2['codimpuesto']);
			$descproducto     = limpiar($row['descproducto']);
			$codigobarra      = limpiar($row2["codigobarra"]);
			$fechaelaboracion = limpiar($row2['fechaelaboracion']);
			$fechaoptimo      = limpiar($row2['fechaoptimo']);
			$fechamedio       = limpiar($row2['fechamedio']);
			$fechaminimo      = limpiar($row2['fechaminimo']);
			$codproveedor     = limpiar($row2["codproveedor"]);
			$stockteorico     = limpiar("0");
			$motivoajuste     = limpiar("NINGUNO");
			$recibe           = limpiar($sucursal_recibeBD);
			$stmt->execute();
			############################## REGISTRO DATOS DE PRODUCTOS ##############################

			############## REGISTRAMOS LOS PRODUCTOS ENTRANTES EN KARDEX ###############
	        $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codtraspaso);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);
			$stmt->bindParam(14, $tipokardex);	
			$stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $recibe);
			$stmt->bindParam(17, $codigo);

			$codtraspaso    = limpiar(decrypt($_POST['codtraspaso']));
			$codresponsable = limpiar(decrypt($_POST["codsucursal"]));
			$codproducto    = limpiar($row['codproducto']);
			$movimiento     = limpiar("ENTRADAS");
			$entradas       = limpiar($row['cantidad']);
			$salidas        = limpiar("0.00");
			$devolucion     = limpiar("0.00");
			$stockactual    = limpiar($row['cantidad']);
			$precio         = limpiar($row["precioventa"]);
			$ivaproducto    = limpiar($row['tipoimpuesto'] == 'EXENTO' ? "EXENTO" : $row['tipoimpuesto']." (".$row['ivaproducto']." %)");
			$descproducto   = limpiar($row['descproducto']);
			$documento      = limpiar("TRASPASO ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));	
		    $tipokardex     = limpiar($row['tipodetalle']);	
		    $procedimiento  = limpiar("1");	
			$recibe         = limpiar($sucursal_recibeBD);
	    	$codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			############## REGISTRAMOS LOS PRODUCTOS ENTRANTES EN KARDEX ###############

		} else {

			############################## VERIFICO EXISTENCIA EN SUCURSAL QUE RECIBE ##############################
			$sql2 = "SELECT * FROM productos 
			WHERE codproducto = '".limpiar($row['codproducto'])."' 
			AND codsucursal = '".limpiar($sucursal_recibeBD)."'";
			foreach ($this->dbh->query($sql2) as $row2)
			{
				$this->p[] = $row2;
			}
			$existenciaBD = $row2['existencia'];
		    ############################## VERIFICO EXISTENCIA EN SUCURSAL QUE RECIBE ##############################

		    ############# ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS RECIBIDOS ###############
			$sql = "UPDATE productos set "
				." existencia = ? "
				." WHERE "
				." codproducto = ? AND codsucursal = ?;
				";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $codproducto);
			$stmt->bindParam(3, $sucursal_recibe);

			$existencia      = limpiar($existenciaBD+$row['cantidad']);
			$codproducto     = limpiar($row['codproducto']);
			$sucursal_recibe = limpiar($sucursal_recibeBD);
			$stmt->execute();
			############# ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS RECIBIDOS ###############

			############## REGISTRAMOS LOS PRODUCTOS ENTRANTES EN KARDEX ###############
	        $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codtraspaso);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);
			$stmt->bindParam(14, $tipokardex);	
			$stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $recibe);
			$stmt->bindParam(17, $codigo);

			$codtraspaso    = limpiar(decrypt($_POST['codtraspaso']));
			$codresponsable = limpiar(decrypt($_POST["codsucursal"]));
			$codproducto    = limpiar($row['codproducto']);
			$movimiento     = limpiar("ENTRADAS");
			$entradas       = limpiar($row['cantidad']);
			$salidas        = limpiar("0.00");
			$devolucion     = limpiar("0.00");
			$stockactual    = limpiar($row['cantidad']);
			$precio         = limpiar($row["precioventa"]);
			$ivaproducto    = limpiar($row['tipoimpuesto'] == 'EXENTO' ? "EXENTO" : $row['tipoimpuesto']." (".$row['ivaproducto']." %)");
			$descproducto   = limpiar($row['descproducto']);
			$documento      = limpiar("TRASPASO ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));	
		    $tipokardex     = limpiar($row['tipodetalle']);	
		    $procedimiento  = limpiar("1");	
			$recibe         = limpiar($sucursal_recibeBD);
	    	$codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			############## REGISTRAMOS LOS PRODUCTOS ENTRANTES EN KARDEX ###############
		}
    }//FIN SESSION DETALLES
    $this->dbh->commit();
    ##########################################################################################################
	#                                                                                                        #
	#                                   PROCESO DE PRODUCTOS ENTRANTES                                       #
	#                                                                                                        #
	##########################################################################################################

    }

    echo "<span class='fa fa-check-square-o'></span> EL TRASPASO HA SIDO PROCESADO EXITOSAMENTE";
	exit;
}
############################ FUNCION PROCESAR TRASPASOS ############################

############################ FUNCION BUSQUEDA DE TRACKING #################################
public function BusquedaTracking()
{
	self::SetNames();
	$sql = "SELECT 
	traspasos.*, 
	documentos.documento,
	documentos2.documento AS documento2,
	sucursales.documsucursal,
	sucursales.cuitsucursal,
	sucursales.nomsucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	provincias.provincia,
	departamentos.departamento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	documentos3.documento AS documento3,
	documentos4.documento AS documento4,
	sucursales2.documsucursal AS documsucursal2,
	sucursales2.cuitsucursal AS cuitsucursal2,
	sucursales2.nomsucursal AS nomsucursal2,
	sucursales2.id_provincia AS id_provincia2,
	sucursales2.id_departamento AS id_departamento2,
	sucursales2.direcsucursal AS direcsucursal2,
	sucursales2.correosucursal AS correosucursal2,
	sucursales2.tlfsucursal AS tlfsucursal2,
	sucursales2.documencargado AS documencargado2,
	sucursales2.dniencargado AS dniencargado2,
	sucursales2.nomencargado AS nomencargado2,
	sucursales2.tlfencargado AS tlfencargado2,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	usuarios.dni, 
	usuarios.nombres,
	usuarios2.dni AS dni2,
	usuarios2.nombres AS nombres2
	FROM (traspasos LEFT JOIN detalletraspasos ON detalletraspasos.codtraspaso = traspasos.codtraspaso)
	LEFT JOIN sucursales ON traspasos.sucursal_envia = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN sucursales AS sucursales2 ON traspasos.sucursal_recibe = sucursales2.codsucursal
	LEFT JOIN documentos AS documentos3 ON sucursales.documsucursal = documentos3.coddocumento
	LEFT JOIN documentos AS documentos4 ON sucursales.documencargado = documentos4.coddocumento
	LEFT JOIN provincias AS provincias2 ON sucursales.id_provincia = provincias2.id_provincia
	LEFT JOIN departamentos AS departamentos2 ON sucursales.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON traspasos.codigo = usuarios.codigo
	LEFT JOIN usuarios AS usuarios2 ON traspasos.persona_recibe = usuarios2.codigo 
	WHERE traspasos.numero_tracking = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["tracking"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-warning'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION BUSQUEDA DE TRACKING #################################

################################## CLASE TRASPASOS ###################################
























###################################### CLASE COMPRAS ###################################

############################# FUNCION REGISTRAR COMPRAS #############################
public function RegistrarCompras()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["codfactura"]) or empty($_POST["fechaemision"]) or empty($_POST["fecharecepcion"]) or empty($_POST["codproveedor"]))
	{
		echo "1";
		exit;
	}
	elseif(empty($_SESSION["CarritoCompra"]))
	{
		echo "2";
		exit;
	}

	############ VALIDO QUE NO SE INCLUYAN PRODUCTOS HIJO EN COMPRAS #############
	$c = $_SESSION["CarritoCompra"];
    for ($i = 0, $iMax = count($c); $i < $iMax; $i++) {
		$sql = "SELECT tipo_producto FROM productos 
		WHERE idproducto = '".limpiar($c[$i]['id'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$row = $stmt->fetch(PDO::FETCH_ASSOC);
		if ($row && $row['tipo_producto'] == 'HIJO') {
			echo "16"; // Código de error: Producto HIJO no puede recibir compras
			exit;
		}
	}
	############ FIN VALIDACION PRODUCTOS HIJO #############

	if (limpiar($_POST["tipocompra"]) == "CREDITO") { 

	    $fechaactual = date("Y-m-d");
	    $fechavence = date("Y-m-d",strtotime($_POST['fechavencecredito']));
	
        if (strtotime($fechavence) < strtotime($fechaactual)) {
  
            echo "3";
	        exit;
        }
    }

    $sql = "SELECT codfactura FROM compras WHERE codfactura = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST['codfactura'],decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		################ CREO CODIGO DE COMPRA ####################
		$sql = "SELECT codcompra FROM compras 
		ORDER BY idcompra DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$compra = $row["codcompra"];
		}
		if(empty($compra))
		{
			$codcompra = "01";

		} else {

			$num         = substr($compra, 0);
	        $dig         = $num + 1;
	        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
	        $codcompra   = $codigofinal;
		}
	    ################ CREO CODIGO DE COMPRA ###############

	    ################### REGISTRO LA COMPRA ####################
		$query = "INSERT INTO compras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $tipodocumento);
		$stmt->bindParam(3, $codfactura);
		$stmt->bindParam(4, $codproveedor);
		$stmt->bindParam(5, $subtotal);
		$stmt->bindParam(6, $subtotalexento);
		$stmt->bindParam(7, $subtotaliva);
		$stmt->bindParam(8, $iva);
		$stmt->bindParam(9, $totaliva);
		$stmt->bindParam(10, $descontado);
		$stmt->bindParam(11, $descuento);
		$stmt->bindParam(12, $totaldescuento);
		$stmt->bindParam(13, $totalpago);
		$stmt->bindParam(14, $gastoenvio);
		$stmt->bindParam(15, $creditopagado);
		$stmt->bindParam(16, $tipocompra);
		$stmt->bindParam(17, $formacompra);
		$stmt->bindParam(18, $fechavencecredito);
		$stmt->bindParam(19, $fechapagado);
		$stmt->bindParam(20, $statuscompra);
		$stmt->bindParam(21, $fechaemision);
		$stmt->bindParam(22, $fecharecepcion);
		$stmt->bindParam(23, $observaciones);
		$stmt->bindParam(24, $codigo);
		$stmt->bindParam(25, $codsucursal);
	   
		$tipodocumento     = limpiar($_POST["tipodocumento"]);
		$codfactura        = limpiar($_POST["codfactura"]);
		$codproveedor      = limpiar($_POST["codproveedor"]);
		$subtotal          = limpiar($_POST["txtsubtotal"]);
		$subtotalexento    = limpiar($_POST["txtexento"]);
		$subtotaliva       = limpiar($_POST["txtsubtotaliva"]);
		$iva               = limpiar($_POST["iva"]);
		$totaliva          = limpiar($_POST["txtIva"]);
		$descontado        = limpiar($_POST["txtdescontado"]);
		$descuento         = limpiar($_POST["descuento"]);
		$totaldescuento    = limpiar($_POST["txtDescuento"]);
		$totalpago         = limpiar($_POST["txtTotal"]);
		$gastoenvio        = limpiar($_POST["gastoenvio"]);
		$creditopagado     = limpiar("0.00");
		$tipocompra        = limpiar($_POST["tipocompra"]);
		$tipocompra        = limpiar($_POST["tipocompra"]);
		$formacompra       = limpiar($_POST["tipocompra"]=="CONTADO" ? decrypt($_POST["formacompra"]) : "CREDITO");
		$fechavencecredito = limpiar($_POST["tipocompra"]=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
	    $fechapagado       = limpiar("0000-00-00");
		$statuscompra      = limpiar($_POST["tipocompra"]=="CONTADO" ? "PAGADA" : "PENDIENTE");
	    $fechaemision      = limpiar(date("Y-m-d",strtotime($_POST['fechaemision'])));
	    $fecharecepcion    = limpiar(date("Y-m-d",strtotime($_POST['fecharecepcion'])));
	    $observaciones     = limpiar($_POST["observaciones"]);
		$codigo            = limpiar($_SESSION["codigo"]);
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO LA COMPRA ####################
	
	$this->dbh->beginTransaction();

	$detalle = $_SESSION["CarritoCompra"];
	for($i=0;$i<count($detalle);$i++){

	    ############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT 
		ivaproducto, 
		existencia 
		FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$ivaproductoBD = $row['ivaproducto'];
		$existenciaBD  = $row['existencia'];
		############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		################### REGISTRO DETALLES DE COMPRA ####################
		$query = "INSERT INTO detallecompras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $preciocompra);
		$stmt->bindParam(13, $precioxmayor);
		$stmt->bindParam(14, $precioxmenor);
		$stmt->bindParam(15, $precioxpublico);
		$stmt->bindParam(16, $cantidad);
	    $stmt->bindParam(17, $posicionimpuesto);
	    $stmt->bindParam(18, $tipoimpuesto);
		$stmt->bindParam(19, $ivaproducto);
		$stmt->bindParam(20, $descproducto);
		$stmt->bindParam(21, $descfactura);
		$stmt->bindParam(22, $valortotal);
		$stmt->bindParam(23, $totaldescuentoc);
		$stmt->bindParam(24, $subtotalimpuestos);
		$stmt->bindParam(25, $valorneto);
		$stmt->bindParam(26, $lote);
		$stmt->bindParam(27, $fechaelaboracion);
		$stmt->bindParam(28, $fechaoptimo);
		$stmt->bindParam(29, $fechamedio);
		$stmt->bindParam(30, $fechaminimo);
		$stmt->bindParam(31, $stockoptimo);
		$stmt->bindParam(32, $stockmedio);
		$stmt->bindParam(33, $stockminimo);
		$stmt->bindParam(34, $codsucursal);
			
		$idproducto      = limpiar($detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	    $condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['codcolor']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$cantidad      = limpiar($detalle[$i]['cantidad']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]["descproductofact"]/100;
		$valortotal      = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproductofact'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto        = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$lote             = limpiar($detalle[$i]['lote']);
		$fechaelaboracion = limpiar($detalle[$i]['fechaelaboracion'] == "" || $detalle[$i]['fechaelaboracion'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaelaboracion'])));
		$fechaoptimo      = limpiar($detalle[$i]['fechaexpiracion1'] == "" || $detalle[$i]['fechaexpiracion1'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion1'])));
		$fechamedio       = limpiar($detalle[$i]['fechaexpiracion2'] == "" || $detalle[$i]['fechaexpiracion2'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion2'])));
		$fechaminimo      = limpiar($detalle[$i]['fechaexpiracion3'] == "" || $detalle[$i]['fechaexpiracion3'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion3'])));
		$stockoptimo      = limpiar($detalle[$i]['optimo']);
		$stockmedio       = limpiar($detalle[$i]['medio']);
		$stockminimo      = limpiar($detalle[$i]['minimo']);
		$codsucursal      = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE COMPRA ####################

		##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################
		$sql = "UPDATE productos set "
			." lote = ?, "
		    ." preciocompra = ?, "
			." precioxmayor = ?, "
			." precioxmenor = ?, "
			." precioxpublico = ?, "
			." existencia = ?, "
			." stockoptimo = ?, "
			." stockmedio = ?, "
			." stockminimo = ?, "
			." ivaproducto = ?, "
			." descproducto = ?, "
			." fechaelaboracion = ?, "
			." fechaoptimo = ?, "
			." fechamedio = ?, "
			." fechaminimo = ?, "
			." codproveedor = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $lote);
		$stmt->bindParam(2, $preciocompra);
		$stmt->bindParam(3, $precioxmayor);
		$stmt->bindParam(4, $precioxmenor);
		$stmt->bindParam(5, $precioxpublico);
		$stmt->bindParam(6, $existencia);
		$stmt->bindParam(7, $stockoptimo);
		$stmt->bindParam(8, $stockmedio);
		$stmt->bindParam(9, $stockminimo);
		$stmt->bindParam(10, $ivaproducto);
		$stmt->bindParam(11, $descproducto);
		$stmt->bindParam(12, $fechaelaboracion);
		$stmt->bindParam(13, $fechaoptimo);
		$stmt->bindParam(14, $fechamedio);
		$stmt->bindParam(15, $fechaminimo);
		$stmt->bindParam(16, $codproveedor);
		$stmt->bindParam(17, $idproducto);
		$stmt->bindParam(18, $codproducto);
		$stmt->bindParam(19, $codsucursal);
		
		$lote             = limpiar($detalle[$i]['lote']);
		$preciocompra     = limpiar($detalle[$i]['precio']);
		$precioxmayor     = limpiar($detalle[$i]['precio1']);
		$precioxmenor     = limpiar($detalle[$i]['precio2']);
		$precioxpublico   = limpiar($detalle[$i]['precio3']);
		$existencia       = limpiar($detalle[$i]['cantidad']+$existenciaBD);
		$stockoptimo      = limpiar($detalle[$i]['optimo']);
		$stockmedio       = limpiar($detalle[$i]['medio']);
		$stockminimo      = limpiar($detalle[$i]['minimo']);
		$ivaproducto      = limpiar($ivaproductoBD);
		$descproducto     = limpiar($detalle[$i]['descproducto']);
		$fechaelaboracion = limpiar($detalle[$i]['fechaelaboracion'] == "" || $detalle[$i]['fechaelaboracion'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaelaboracion'])));
		$fechaoptimo      = limpiar($detalle[$i]['fechaexpiracion1'] == "" || $detalle[$i]['fechaexpiracion1'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion1'])));
		$fechamedio       = limpiar($detalle[$i]['fechaexpiracion2'] == "" || $detalle[$i]['fechaexpiracion2'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion2'])));
		$fechaminimo      = limpiar($detalle[$i]['fechaexpiracion3'] == "" || $detalle[$i]['fechaexpiracion3'] == "0000-00-00" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion3'])));
		$codproveedor     = limpiar($_POST['codproveedor']);	
		$idproducto       = limpiar($detalle[$i]['id']);
		$codproducto      = limpiar($detalle[$i]['txtCodigo']);
		$codsucursal      = limpiar(decrypt($_POST['codsucursal']));
		$stmt->execute();
		##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################

		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $codproveedor);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
		$stmt->bindParam(14, $tipokardex);	
		$stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproveedor  = limpiar($_POST["codproveedor"]);
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("ENTRADAS");
		$entradas      = limpiar($detalle[$i]['cantidad']);
		$salidas       = limpiar("0.00");
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar($detalle[$i]['cantidad']+$existenciaBD);
		$precio        = limpiar($detalle[$i]["precio"]);
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = limpiar($detalle[$i]['descproducto']);
		$documento     = limpiar("COMPRA: ".$_POST['codfactura']);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		$tipokardex    = limpiar("1");
		$procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
    }
	####################### DESTRUYO LA VARIABLE DE SESSION #####################
    unset($_SESSION["CarritoCompra"]);
    $this->dbh->commit();
		
       echo "<span class='fa fa-check-square-o'></span> LA COMPRA DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
       echo "<script>VentanaCentrada('reportepdf?codcompra=".encrypt($codcompra)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	   exit;
	}
	else
	{
		echo "4";
		exit;
	}
}
############################ FUNCION REGISTRAR COMPRAS ##########################

########################## FUNCION BUSQUEDA DE COMPRAS ###############################
public function BusquedaCompras() 
{
	self::SetNames();
    if(limpiar($_GET['tipobusqueda']) == 1){
    $sql ="SELECT 
	compras.codcompra, 
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(detallecompras.cantidad) AS articulos 
	FROM (compras LEFT JOIN detallecompras ON detallecompras.codcompra = compras.codcompra) 
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
	GROUP BY detallecompras.codcompra 
	ORDER BY compras.idcompra ASC";
  	} elseif(limpiar($_GET['tipobusqueda']) == 2){
  	$sql ="SELECT 
	compras.codcompra, 
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(detallecompras.cantidad) AS articulos 
	FROM (compras LEFT JOIN detallecompras ON detallecompras.codcompra = compras.codcompra) 
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE CONCAT(compras.codcompra, '',compras.codfactura, '',compras.totalpago, '',proveedores.cuitproveedor, '',proveedores.nomproveedor, '',sucursales.cuitsucursal, '',sucursales.nomsucursal, '',sucursales.dniencargado, '',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
	AND compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
	GROUP BY detallecompras.codcompra 
	ORDER BY compras.idcompra ASC LIMIT 0,60";
	} else if(limpiar($_GET['tipobusqueda']) == 3){
	$sql ="SELECT 
	compras.codcompra,
	compras.tipodocumento, 
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(detallecompras.cantidad) AS articulos 
	FROM (compras LEFT JOIN detallecompras ON detallecompras.codcompra = compras.codcompra) 
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE DATE_FORMAT(compras.fecharecepcion,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
	AND compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY detallecompras.codcompra 
	ORDER BY compras.idcompra ASC LIMIT 0,60";
	}
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION BUSQUEDA DE COMPRAS ###############################

######################### FUNCION LISTAR COMPRAS ################################
public function ListarCompras()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		
		$sql = "SELECT 
		compras.codcompra,
		compras.tipodocumento,
		compras.codfactura, 
		compras.codproveedor, 
		compras.subtotal,
		compras.subtotalexento, 
		compras.subtotaliva, 
		compras.iva, 
		compras.totaliva, 
		compras.descontado, 
		compras.descuento, 
		compras.totaldescuento, 
		compras.totalpago,
		compras.gastoenvio,
		compras.creditopagado, 
		compras.statuscompra, 
		compras.fechavencecredito, 
		compras.fechapagado,
		compras.fecharecepcion, 
		compras.fechaemision, 
		compras.observaciones,
		compras.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(detallecompras.cantidad) AS articulos 
		FROM (compras LEFT JOIN detallecompras ON detallecompras.codcompra = compras.codcompra) 
		LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
		WHERE compras.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		GROUP BY detallecompras.codcompra 
		ORDER BY compras.codcompra ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    
    } else {

	    $sql = "SELECT 
		compras.codcompra,
		compras.tipodocumento, 
		compras.codfactura,
		compras.codproveedor, 
		compras.subtotal,
		compras.subtotalexento, 
		compras.subtotaliva, 
		compras.iva, 
		compras.totaliva, 
		compras.descontado, 
		compras.descuento, 
		compras.totaldescuento, 
		compras.totalpago,
		compras.gastoenvio,
		compras.creditopagado, 
		compras.statuscompra, 
		compras.fechavencecredito, 
		compras.fechapagado,
		compras.fecharecepcion, 
		compras.fechaemision, 
		compras.observaciones,
		compras.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(detallecompras.cantidad) AS articulos 
		FROM (compras LEFT JOIN detallecompras ON detallecompras.codcompra = compras.codcompra) 
		LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON compras.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."'  
		GROUP BY detallecompras.codcompra 
		ORDER BY compras.codcompra ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
################################## FUNCION LISTAR COMPRAS ############################

########################## FUNCION BUSQUEDA DE CUENTAS POR PAGAR ###############################
public function BusquedaCuentasxPagar() 
{
	self::SetNames();
	if(limpiar($_GET['tipobusqueda']) == 1){
	$sql ="SELECT 
	compras.codcompra,
	compras.tipodocumento, 
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(abonoscreditoscompras.montoabono) AS abonototal 
	FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND compras.statuscompra = 'PENDIENTE' 
	GROUP BY compras.codcompra 
	ORDER BY compras.codcompra ASC";
	} elseif(limpiar($_GET['tipobusqueda']) == 2){
  	$sql ="SELECT 
	compras.codcompra,
	compras.tipodocumento, 
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(abonoscreditoscompras.montoabono) AS abonototal 
	FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE CONCAT(compras.codcompra, '',compras.codfactura, '',compras.totalpago, '',proveedores.cuitproveedor, '',proveedores.nomproveedor, '',sucursales.cuitsucursal, '',sucursales.nomsucursal, '',sucursales.dniencargado, '',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
	AND compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND compras.statuscompra = 'PENDIENTE' 
	GROUP BY compras.codcompra 
	ORDER BY compras.codcompra ASC LIMIT 0,60";
	} else if(limpiar($_GET['tipobusqueda']) == 3){
	$sql ="SELECT 
	compras.codcompra,
	compras.tipodocumento, 
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(abonoscreditoscompras.montoabono) AS abonototal 
	FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	   WHERE DATE_FORMAT(compras.fecharecepcion,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
	AND compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND compras.statuscompra = 'PENDIENTE' 
	GROUP BY compras.codcompra 
	ORDER BY compras.codcompra ASC LIMIT 0,60";
	}
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION BUSQUEDA DE CUENTAS POR PAGAR ###############################

########################### FUNCION LISTAR CUENTAS POR PAGAR #######################
public function ListarCuentasxPagar()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {
		$sql = "SELECT 
		compras.codcompra,
		compras.tipodocumento,
		compras.codfactura, 
		compras.codproveedor, 
		compras.subtotal,
		compras.subtotalexento, 
		compras.subtotaliva, 
		compras.iva, 
		compras.totaliva, 
		compras.descontado, 
		compras.descuento, 
		compras.totaldescuento, 
		compras.totalpago,
		compras.gastoenvio,
		compras.creditopagado, 
		compras.statuscompra, 
		compras.fechavencecredito, 
		compras.fechapagado,
		compras.fecharecepcion, 
		compras.fechaemision, 
		compras.observaciones,
		compras.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(abonoscreditoscompras.montoabono) AS abonototal 
		FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
		LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON compras.codigo = usuarios.codigo 
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE compras.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND compras.statuscompra = 'PENDIENTE'
		GROUP BY compras.codcompra 
		ORDER BY compras.codcompra ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

   } else {

	    $sql = "SELECT 
		compras.codcompra,
		compras.tipodocumento,
		compras.codfactura, 
		compras.codproveedor, 
		compras.subtotal,
		compras.subtotalexento, 
		compras.subtotaliva, 
		compras.iva, 
		compras.totaliva, 
		compras.descontado, 
		compras.descuento, 
		compras.totaldescuento, 
		compras.totalpago,
		compras.gastoenvio,
		compras.creditopagado, 
		compras.statuscompra, 
		compras.fechavencecredito, 
		compras.fechapagado,
		compras.fecharecepcion, 
		compras.fechaemision, 
		compras.observaciones,
		compras.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		proveedores.documproveedor, 
		proveedores.cuitproveedor, 
		proveedores.nomproveedor, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni, 
		usuarios.nombres, 
		SUM(abonoscreditoscompras.montoabono) AS abonototal 
		FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
		LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
		LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
		LEFT JOIN usuarios ON compras.codigo = usuarios.codigo 
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND compras.statuscompra = 'PENDIENTE' 
		GROUP BY compras.codcompra 
		ORDER BY compras.codcompra ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR CUENTAS POR PAGAR ############################

########################### FUNCION LISTAR CUENTAS POR PAGAR VENCIDAS #######################
public function ListarCuentasxPagarVencidas()
{
	self::SetNames();
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura, 
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.statuscompra, 
	compras.fechavencecredito, 
	compras.fechapagado,
	compras.fecharecepcion, 
	compras.fechaemision, 
	compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres, 
	SUM(abonoscreditoscompras.montoabono) AS abonototal 
	FROM (compras LEFT JOIN abonoscreditoscompras ON compras.codcompra = abonoscreditoscompras.codcompra)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal  
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo 
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
	AND compras.statuscompra = 'PENDIENTE'
	AND DATE_FORMAT(compras.fechavencecredito,'%Y-%m-%d') <= '".date("Y-m-d")."' 
	GROUP BY compras.codcompra 
	ORDER BY compras.codcompra ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
######################### FUNCION LISTAR CUENTAS POR PAGAR VENCIDAS ############################

############################ FUNCION PARA PAGAR COMPRAS ############################
public function RegistrarPagoCompra()
{
	self::SetNames();
	if(empty($_POST["codproveedor"]) or empty($_POST["codcompra"]) or empty($_POST["montoabono"]))
	{
		echo "1";
		exit;
	} 
	else if($_POST["montoabono"] > $_POST["totaldebe"])
	{
		echo "2";
		exit;
	}
	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	ticket_general 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$ticket_general  = $row['ticket_general'];
	################# OBTENGO DATOS DE SUCURSAL #################

	######################### CODIGO DE ABONO #########################
	$sql = "SELECT 
	codabono 
	FROM abonoscreditoscompras 
	ORDER BY idabono 
	DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$num=$row["codabono"];
	}
	$codabono = (empty($num) ? "1" : $num + 1);
    ######################### CODIGO DE ABONO #########################

    ################### CODIGO DE CREDITO ABONO ####################
	$sql4 = "SELECT codcredito FROM abonoscreditoscompras 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idabono DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$factura = $row4["codcredito"];
	}
	if(empty($factura))
	{
		$codcredito = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codcredito = $var4;
	}
	################### CODIGO DE CREDITO ABONO ####################

	####################### REGISTRO ABONOS DE COMPRAS #######################
	$query = "INSERT INTO abonoscreditoscompras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codabono);
	$stmt->bindParam(2, $codcredito);
	$stmt->bindParam(3, $codcompra);
	$stmt->bindParam(4, $codproveedor);
	$stmt->bindParam(5, $montoabono);
	$stmt->bindParam(6, $formaabono);
	$stmt->bindParam(7, $codbanco);
	$stmt->bindParam(8, $comprobante);
	$stmt->bindParam(9, $fechaabono);
	$stmt->bindParam(10, $codsucursal);

	$tipodocumento= limpiar($ticket_general == "8" ? "TICKET_CREDITO_COMPRA_8" : "TICKET_CREDITO_COMPRA_5");
	$codcompra    = limpiar(decrypt($_POST["codcompra"]));
	$codproveedor = limpiar(decrypt($_POST["codproveedor"]));
	$montoabono   = limpiar($_POST["montoabono"]);
	$formaabono   = limpiar(decrypt($_POST["formaabono"]));
	$codbanco     = limpiar(decrypt($_POST["codbanco"]));
	$comprobante  = limpiar($_POST["comprobante"]);
	$fechaabono   = limpiar(date("Y-m-d H:i:s"));
	$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	####################### REGISTRO ABONOS DE COMPRAS #######################

    ############## ACTUALIZAMOS EL STATUS DE LA FACTURA ##################
	if($_POST["montoabono"] == $_POST["totaldebe"]) {

		######################### ACTUALIZO DATOS EN COMPRA #########################
		$sql = "UPDATE compras set "
		." creditopagado = ?, "
		." statuscompra = ?, "
		." fechapagado = ? "
		." WHERE "
		." codcompra = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $creditopagado);
		$stmt->bindParam(2, $statuscompra);
		$stmt->bindParam(3, $fechapagado);
		$stmt->bindParam(4, $codcompra);
		$stmt->bindParam(5, $codsucursal);

		$creditopagado = number_format($_POST["totalabono"] + $_POST["montoabono"], 2, '.', '');
		$statuscompra  = limpiar("PAGADA");
		$fechapagado   = limpiar(date("Y-m-d"));
		$codcompra     = limpiar(decrypt($_POST["codcompra"]));
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		######################### ACTUALIZO DATOS EN COMPRA #########################
	
	} else {

		######################### ACTUALIZO DATOS EN COMPRA #########################
		$sql = "UPDATE compras set "
		." creditopagado = ? "
		." WHERE "
		." codcompra = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $creditopagado);
		$stmt->bindParam(2, $codcompra);
		$stmt->bindParam(3, $codsucursal);

		$creditopagado = number_format($_POST["totalabono"] + $_POST["montoabono"], 2, '.', '');
		$codcompra     = limpiar(decrypt($_POST["codcompra"]));
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		######################### ACTUALIZO DATOS EN COMPRA #########################
	}
    ############## ACTUALIZAMOS EL STATUS DE LA FACTURA ##################

    echo "<span class='fa fa-check-square-o'></span> EL ABONO AL CR&Eacute;DITO DE COMPRA HA SIDO REGISTRADO EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcompra=".encrypt($codcompra)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################## FUNCION PARA PAGAR COMPRAS ###############################

########################### FUNCION VER DETALLES COMPRAS #######################
public function VerDetallesAbonosCompras()
{
	self::SetNames();
	$sql = "SELECT
	abonoscreditoscompras.*,
	compras.codcompra,
	mediospagos.mediopago,
	bancos.nombanco
	FROM abonoscreditoscompras 
	INNER JOIN compras ON abonoscreditoscompras.codcompra = compras.codcompra
	LEFT JOIN mediospagos ON abonoscreditoscompras.formaabono = mediospagos.codmediopago
	LEFT JOIN bancos ON abonoscreditoscompras.codbanco = bancos.codbanco 
	WHERE abonoscreditoscompras.codcompra = ? 
	AND abonoscreditoscompras.codsucursal = ?";	
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET["codcompra"])));
	$stmt->bindValue(2, trim(decrypt($_GET["codsucursal"])));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	   while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION VER DETALLES COMPRAS ###########################

############################ FUNCION ID COMPRAS #################################
public function ComprasPorId()
{
	self::SetNames();
	$sql = " SELECT 
	compras.idcompra, 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codigo,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor,
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	proveedores.id_provincia AS id_provincia2, 
	proveedores.id_departamento AS id_departamento2, 
	proveedores.direcproveedor, 
	proveedores.emailproveedor,
	proveedores.vendedor,
	proveedores.tlfvendedor,
    documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3, 
	mediospagos.mediopago,
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
    pag.articulos 
    FROM (compras LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON proveedores.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON proveedores.id_departamento = departamentos2.id_departamento 
	LEFT JOIN mediospagos ON compras.formacompra = mediospagos.codmediopago
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos
	   FROM detallecompras
	   WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codcompra = ? AND compras.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcompra"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID COMPRAS #################################
	
############################ FUNCION VER DETALLES COMPRAS ############################
public function VerDetallesCompras()
{
	self::SetNames();
	$sql = "SELECT
	detallecompras.coddetallecompra,
	detallecompras.codcompra,
	detallecompras.idproducto,
	detallecompras.codproducto,
	detallecompras.producto,
	detallecompras.descripcion,
	detallecompras.imei,
	detallecompras.condicion,
	detallecompras.codmarca,
	detallecompras.codmodelo,
	detallecompras.codpresentacion,
	detallecompras.codcolor,
	detallecompras.preciocompra,
	detallecompras.precioxmayor,
	detallecompras.precioxmenor,
	detallecompras.precioxpublico,
	detallecompras.cantidad,
	detallecompras.posicionimpuesto,
	detallecompras.tipoimpuesto,
	detallecompras.ivaproducto,
	detallecompras.descproducto,
	detallecompras.descfactura,
	detallecompras.valortotal, 
	detallecompras.totaldescuentoc,
	detallecompras.subtotalimpuestos,
	detallecompras.valorneto,
	detallecompras.lote,
	detallecompras.fechaelaboracion,
	detallecompras.fechaoptimo,
	detallecompras.fechamedio,
	detallecompras.fechaminimo,
	detallecompras.stockoptimo,
	detallecompras.stockmedio,
	detallecompras.stockminimo,
	detallecompras.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallecompras 
	LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor  
	WHERE detallecompras.codcompra = ? 
	AND detallecompras.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcompra"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION VER DETALLES COMPRAS ##############################

############################## FUNCION ACTUALIZAR COMPRAS #############################
public function ActualizarCompras()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["codfactura"]) or empty($_POST["fechaemision"]) or empty($_POST["fecharecepcion"]) or empty($_POST["codproveedor"]))
	{
		echo "1";
		exit;
	}

	for($i=0;$i<count($_POST['coddetallecompra']);$i++){  //recorro el array
        if (!empty($_POST['coddetallecompra'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
    }

	if (limpiar($_POST["tipocompra"]) == "CREDITO") { 

	    $fechaactual = date("Y-m-d");
	    $fechavence = date("Y-m-d",strtotime($_POST['fechavencecredito']));
	
        if (strtotime($fechavence) < strtotime($fechaactual)) {
  
            echo "3";
	        exit;
        }
    }

    $this->dbh->beginTransaction();

    for($i=0;$i<count($_POST['coddetallecompra']);$i++){  //recorro el array
        if (!empty($_POST['coddetallecompra'][$i])) {

    $sql = "SELECT cantidad FROM detallecompras 
    WHERE coddetallecompra = '".limpiar($_POST['coddetallecompra'][$i])."' 
    AND codcompra = '".limpiar(decrypt($_POST["codcompra"]))."' 
    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cantidadBD = $row['cantidad'];

	if($cantidadBD != $_POST['cantidad'][$i]){

		$sql = "SELECT existencia FROM productos 
		WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."'
		AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    foreach ($this->dbh->query($sql) as $row)
	    {
		   $this->p[] = $row;
	    }
	    $existenciaBD = $row['existencia'];
	    $cantidad     = $_POST["cantidad"][$i];
	    $cantidadBD   = $_POST["cantidadbd"][$i];
	    $totalcompra  = number_format($cantidad-$cantidadBD, 2, '.', '');

		################### ACTUALIZO DETALLES COMPRAS ###################
		$query = "UPDATE detallecompras set"
		." cantidad = ?, "
		." valortotal = ?, "
		." totaldescuentoc = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ? "
		." WHERE "
		." coddetallecompra = ? AND codcompra = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $valortotal);
		$stmt->bindParam(3, $totaldescuento);
		$stmt->bindParam(4, $subtotalimpuestos);
		$stmt->bindParam(5, $valorneto);
		$stmt->bindParam(6, $coddetallecompra);
		$stmt->bindParam(7, $codcompra);
		$stmt->bindParam(8, $codsucursal);

		$cantidad          = limpiar($_POST['cantidad'][$i]);
		$preciocompra      = limpiar($_POST['preciocompra'][$i]);
		$ivaproducto       = limpiar($_POST['ivaproducto'][$i]);
		$descuento         = $_POST['descfactura'][$i]/100;
		$valortotal        = number_format($_POST['valortotal'][$i], 2, '.', '');
		$totaldescuento    = number_format($_POST['totaldescuentoc'][$i], 2, '.', '');
		$subtotalimpuestos = number_format($_POST['subtotalimpuestos'][$i], 2, '.', '');
		$valorneto         = number_format($_POST['valorneto'][$i], 2, '.', '');
		$coddetallecompra  = limpiar($_POST['coddetallecompra'][$i]);
		$codcompra         = limpiar(decrypt($_POST["codcompra"]));
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### ACTUALIZO DETALLES COMPRAS ###################

		############ ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql2 = " UPDATE productos set "
	    ." existencia = ? "
	    ." WHERE "
	    ." idproducto = '".limpiar($_POST["idproducto"][$i])."'
		AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
	    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	    ";
	    $stmt = $this->dbh->prepare($sql2);
	    $stmt->bindParam(1, $existencia);
	    $existencia = number_format($existenciaBD+$totalcompra, 2, '.', '');
	    $stmt->execute();
		############ ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		############## ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###################
		$sql3 = " UPDATE kardex set "
		    ." entradas = ?, "
		    ." stockactual = ?, "
		    ." documento = ? "
		    ." WHERE "
			." codproceso = '".limpiar(decrypt($_POST["codcompra"]))."'
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."'
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 1
			AND procedimiento = 1;
			";
		$stmt = $this->dbh->prepare($sql3);
		$stmt->bindParam(1, $entradas);
		$stmt->bindParam(2, $existencia);
		$stmt->bindParam(3, $documento);
		
		$entradas  = limpiar($_POST["cantidad"][$i]);
		$documento = limpiar("COMPRA: ".$_POST['codfactura']);
		$stmt->execute();
		############## ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###################

		} else {

                echo "";
	        }
        }
    }

    $this->dbh->commit();

        ############ ACTUALIZO LOS TOTALES EN LA COMPRA ##############
		$sql = " UPDATE compras SET "
		." tipodocumento = ?, "
		." codfactura = ?, "
		." codproveedor = ?, "
		." subtotal = ?, "
		." subtotalexento = ?, "
		." subtotaliva = ?, "
		." totaliva = ?, "
		." descontado = ?, "
		." descuento = ?, "
		." totaldescuento = ?, "
		." totalpago = ?, "
		." gastoenvio = ?, "
		." tipocompra = ?, "
		." formacompra = ?, "
		." fechavencecredito = ?, "
		." fechaemision = ?, "
	    ." fecharecepcion = ?, "
	    ." observaciones = ? "
		." WHERE "
		." codcompra = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $codfactura);
		$stmt->bindParam(3, $codproveedor);
		$stmt->bindParam(4, $subtotal);
		$stmt->bindParam(5, $subtotalexento);
		$stmt->bindParam(6, $subtotaliva);
		$stmt->bindParam(7, $totaliva);
		$stmt->bindParam(8, $descontado);
		$stmt->bindParam(9, $descuento);
		$stmt->bindParam(10, $totaldescuento);
		$stmt->bindParam(11, $totalpago);
		$stmt->bindParam(12, $gastoenvio);
		$stmt->bindParam(13, $tipocompra);
		$stmt->bindParam(14, $formacompra);
		$stmt->bindParam(15, $fechavencecredito);
		$stmt->bindParam(16, $fechaemision);
		$stmt->bindParam(17, $fecharecepcion);
	    $stmt->bindParam(18, $observaciones);
		$stmt->bindParam(19, $codcompra);
		$stmt->bindParam(20, $codsucursal);

		$tipodocumento     = limpiar($_POST["tipodocumento"]);
		$codfactura        = limpiar($_POST["codfactura"]);
		$codproveedor      = limpiar($_POST["codproveedor"]);
		$subtotal          = number_format($_POST["txtsubtotal"], 2, '.', '');
		$subtotalexento    = number_format($_POST["txtexento"], 2, '.', '');
		$subtotaliva       = number_format($_POST["txtsubtotaliva"], 2, '.', '');
		$totaliva          = number_format($_POST["txtIva"], 2, '.', '');
		$descontado        = number_format($_POST["txtdescontado"], 2, '.', '');
		$descuento         = limpiar($_POST["descuento"]);
	    $totaldescuento    = number_format($_POST["txtDescuento"], 2, '.', '');
	    $totalpago         = number_format($_POST["txtTotal"], 2, '.', '');
		$gastoenvio        = limpiar($_POST["gastoenvio"]);
		$tipocompra        = limpiar($_POST["tipocompra"]);
		$formacompra       = limpiar($_POST["tipocompra"] == "CONTADO" ? decrypt($_POST["formacompra"]) : "CREDITO");
		$fechavencecredito = limpiar($_POST["tipocompra"] == "CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
		$statuscompra      = limpiar($_POST["tipocompra"] == "CONTADO" ? "PAGADA" : "PENDIENTE");
		$fechaemision      = limpiar(date("Y-m-d",strtotime($_POST['fechaemision'])));
		$fecharecepcion    = limpiar(date("Y-m-d",strtotime($_POST['fecharecepcion'])));
	    $observaciones     = limpiar($_POST["observaciones"]);
		$codcompra         = limpiar(decrypt($_POST["codcompra"]));
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN LA COMPRA ##############

    echo "<span class='fa fa-check-square-o'></span> LA COMPRA DE PRODUCTOS HA SIDO ACTUALIZADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcompra=".encrypt($codcompra)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
############################# FUNCION ACTUALIZAR COMPRAS #########################

####################### FUNCION AGREGAR DETALLES COMPRAS ########################
public function AgregarDetallesCompras()
{
	self::SetNames();
	if(empty($_POST["codcompra"]) or empty($_POST["codsucursal"]) or empty($_POST["codfactura"]) or empty($_POST["fechaemision"]) or empty($_POST["fecharecepcion"]) or empty($_POST["codproveedor"]))
	{
		echo "1";
		exit;
	}
    elseif(empty($_SESSION["CarritoCompra"]))
	{
		echo "2";
		exit;
	}

	############ CONSULTO TOTAL ACTUAL DE COMPRA ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM compras 
	WHERE codcompra = '".limpiar(decrypt($_POST["codcompra"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$ivaBD        = $row['iva'];
	$descuentoBD  = $row['descuento'];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE COMPRA ##############

    $this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoCompra"];
	for($i=0;$i<count($detalle);$i++){

  	############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
	$sql = "SELECT existencia, ivaproducto
	FROM productos 
	WHERE idproducto = '".limpiar($detalle[$i]['id'])."'
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$existenciaBD  = $row['existencia'];
	$ivaproductoBD = $row['ivaproducto'];
	############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

	$sql = "SELECT * 
	FROM detallecompras 
	WHERE codcompra = '".limpiar(decrypt($_POST['codcompra']))."' 
	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'  
	AND idproducto = '".limpiar($detalle[$i]['id'])."'
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0)
	{
        ############################ REGISTRO DETALLES DE COMPRAS ############################
		$query = "INSERT INTO detallecompras values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $preciocompra);
		$stmt->bindParam(13, $precioxmayor);
		$stmt->bindParam(14, $precioxmenor);
		$stmt->bindParam(15, $precioxpublico);
		$stmt->bindParam(16, $cantidad);
	    $stmt->bindParam(17, $posicionimpuesto);
	    $stmt->bindParam(18, $tipoimpuesto);
		$stmt->bindParam(19, $ivaproducto);
		$stmt->bindParam(20, $descproducto);
		$stmt->bindParam(21, $descfactura);
		$stmt->bindParam(22, $valortotal);
		$stmt->bindParam(23, $totaldescuentoc);
		$stmt->bindParam(24, $subtotalimpuestos);
		$stmt->bindParam(25, $valorneto);
		$stmt->bindParam(26, $lote);
		$stmt->bindParam(27, $fechaelaboracion);
		$stmt->bindParam(28, $fechaoptimo);
		$stmt->bindParam(29, $fechamedio);
		$stmt->bindParam(30, $fechaminimo);
		$stmt->bindParam(31, $stockoptimo);
		$stmt->bindParam(32, $stockmedio);
		$stmt->bindParam(33, $stockminimo);
		$stmt->bindParam(34, $codsucursal);
			
		$codcompra       = limpiar(decrypt($_POST["codcompra"]));
		$idproducto      = limpiar($detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	    $condicion       = limpiar($detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['codcolor']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]["descproductofact"]/100;
		$valortotal      = number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
	    $subtotalimpuestos    = "0.00";
		} else {
		$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproductofact'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto         = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$lote              = limpiar($detalle[$i]['lote']);
		$fechaelaboracion  = limpiar($detalle[$i]['fechaelaboracion']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaelaboracion'])));
		$fechaoptimo       = limpiar($detalle[$i]['fechaexpiracion1']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion1'])));
		$fechamedio        = limpiar($detalle[$i]['fechaexpiracion2']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion2'])));
		$fechaminimo       = limpiar($detalle[$i]['fechaexpiracion3']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion3'])));
		$stockoptimo       = limpiar($detalle[$i]['optimo']);
		$stockmedio        = limpiar($detalle[$i]['medio']);
		$stockminimo       = limpiar($detalle[$i]['minimo']);
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		############################ REGISTRO DETALLES DE COMPRAS ############################

		##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################
		$sql = "UPDATE productos set "
			." lote = ?, "
		    ." preciocompra = ?, "
		    ." precioxmayor = ?, "
			." precioxmenor = ?, "
			." precioxpublico = ?, "
			." existencia = ?, "
			." stockoptimo = ?, "
			." stockmedio = ?, "
			." stockminimo = ?, "
			." ivaproducto = ?, "
			." descproducto = ?, "
			." fechaelaboracion = ?, "
			." fechaoptimo = ?, "
			." fechamedio = ?, "
			." fechaminimo = ?, "
			." codproveedor = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $lote);
		$stmt->bindParam(2, $preciocompra);
		$stmt->bindParam(3, $precioxmayor);
		$stmt->bindParam(4, $precioxmenor);
		$stmt->bindParam(5, $precioxpublico);
		$stmt->bindParam(6, $existencia);
		$stmt->bindParam(7, $stockoptimo);
		$stmt->bindParam(8, $stockmedio);
		$stmt->bindParam(9, $stockminimo);
		$stmt->bindParam(10, $ivaproducto);
		$stmt->bindParam(11, $descproducto);
		$stmt->bindParam(12, $fechaelaboracion);
		$stmt->bindParam(13, $fechaoptimo);
		$stmt->bindParam(14, $fechamedio);
		$stmt->bindParam(15, $fechaminimo);
		$stmt->bindParam(16, $codproveedor);
		$stmt->bindParam(17, $idproducto);
		$stmt->bindParam(18, $codproducto);
		$stmt->bindParam(19, $codsucursal);
		
		$lote             = limpiar($detalle[$i]['lote']);
		$preciocompra     = limpiar($detalle[$i]['precio']);
		$precioxmayor     = limpiar($detalle[$i]['precio1']);
		$precioxmenor     = limpiar($detalle[$i]['precio2']);
		$precioxpublico   = limpiar($detalle[$i]['precio3']);
		$existencia       = limpiar($detalle[$i]['cantidad']+$existenciaBD);
		$stockoptimo      = limpiar($detalle[$i]['optimo']);
		$stockmedio       = limpiar($detalle[$i]['medio']);
		$stockminimo      = limpiar($detalle[$i]['minimo']);
		$ivaproducto      = limpiar($ivaproductoBD);
		$descproducto     = limpiar($detalle[$i]['descproducto']);
		$fechaelaboracion = limpiar($detalle[$i]['fechaelaboracion']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaelaboracion'])));
		$fechaoptimo      = limpiar($detalle[$i]['fechaexpiracion1']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion1'])));
		$fechamedio       = limpiar($detalle[$i]['fechaexpiracion2']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion2'])));
		$fechaminimo      = limpiar($detalle[$i]['fechaexpiracion3']=="" ? "0000-00-00" : date("Y-m-d",strtotime($detalle[$i]['fechaexpiracion3'])));
		$codproveedor     = limpiar($_POST['codproveedor']);
		$idproducto       = limpiar($detalle[$i]['id']);
		$codproducto      = limpiar($detalle[$i]['txtCodigo']);
		$codsucursal      = limpiar(decrypt($_POST['codsucursal']));
		$stmt->execute();
		##################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTOS #####################

		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $codproveedor);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
		$stmt->bindParam(14, $tipokardex);	
		$stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcompra     = limpiar(decrypt($_POST["codcompra"]));
		$codproveedor  = limpiar($_POST["codproveedor"]);
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("ENTRADAS");
		$entradas      = limpiar($detalle[$i]['cantidad']);
		$salidas       = limpiar("0.00");
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar($detalle[$i]['cantidad']+$existenciaBD);
		$precio        = limpiar($detalle[$i]["precio"]);
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = limpiar($detalle[$i]['descproducto']);
		$documento     = limpiar("COMPRA: ".$_POST['codfactura']);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		$tipokardex    = limpiar("1");
		$procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################

	} else {

		################## OBTENGO CANTIDAD DE DETALLE ##################
		$sql = "SELECT cantidad 
	  	FROM detallecompras 
	  	WHERE codcompra = '".limpiar(decrypt($_POST['codcompra']))."' 
	  	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'
	  	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	  	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$cantidadBD = number_format($row['cantidad'], 2, '.', '');
		################## OBTENGO CANTIDAD DE DETALLE ##################

	  	############################ ACTUALIZO DETALLES DE COMPRAS ############################
	  	$query = "UPDATE detallecompras set"
		." cantidad = ?, "
		." descproducto = ?, "
		." descfactura = ?, "
		." valortotal = ?, "
		." totaldescuentoc = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ? "
		." WHERE "
		." codcompra = ? AND codsucursal = ? AND idproducto = ? AND codproducto = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $descproducto);
		$stmt->bindParam(3, $descfactura);
		$stmt->bindParam(4, $valortotal);
		$stmt->bindParam(5, $totaldescuentoc);
		$stmt->bindParam(6, $subtotalimpuestos);
		$stmt->bindParam(7, $valorneto);
		$stmt->bindParam(8, $codcompra);
		$stmt->bindParam(9, $codsucursal);
		$stmt->bindParam(10, $idproducto);
		$stmt->bindParam(11, $codproducto);

		$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidadBD);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioxmayor    = limpiar($detalle[$i]['precio1']);
		$precioxmenor    = limpiar($detalle[$i]['precio2']);
		$precioxpublico  = limpiar($detalle[$i]['precio3']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descfactura     = limpiar($detalle[$i]['descproductofact']);
		$descuento       = $detalle[$i]["descproductofact"]/100;
		$valortotal      = number_format($detalle[$i]['precio']*$cantidad, 2, '.', '');
		$totaldescuentoc = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
		} else {
		$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproductofact'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentoc, 2, '.', '');
		$codcompra   = limpiar(decrypt($_POST["codcompra"]));
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$idproducto  = limpiar($detalle[$i]['id']);
		$codproducto = limpiar($detalle[$i]['txtCodigo']);
		$stmt->execute();
		############################ ACTUALIZO DETALLES DE COMPRAS ############################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."'
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = limpiar($detalle[$i]['cantidad']);
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $codproveedor);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
		$stmt->bindParam(14, $tipokardex);	
		$stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcompra     = limpiar(decrypt($_POST["codcompra"]));
		$codproveedor  = limpiar($_POST["codproveedor"]);
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("ENTRADAS");
		$entradas      = limpiar($detalle[$i]['cantidad']);
		$salidas       = limpiar("0.00");
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar($detalle[$i]['cantidad']+$existenciaBD);
		$precio        = limpiar($detalle[$i]["precio"]);
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = limpiar($detalle[$i]['descproducto']);
		$documento     = limpiar("COMPRA: ".$_POST['codfactura']);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		$tipokardex    = limpiar("1");
		$procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		##################### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX #####################

	   }
    }    
   
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoCompra"]);
    $this->dbh->commit();

    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentoc) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto FROM detallecompras WHERE codcompra = '".limpiar(decrypt($_POST["codcompra"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
      	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentoc) AS totaldescuentono, SUM(valorneto) AS valorneto FROM detallecompras WHERE codcompra = '".limpiar(decrypt($_POST["codcompra"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ################### ACTUALIZO LA COMPRA ####################
	$sql = " UPDATE compras SET "
	." tipodocumento = ?, "
	." codfactura = ?, "
	." codproveedor = ?, "
    ." subtotal = ?, "
    ." subtotalexento = ?, "
    ." subtotaliva = ?, "
    ." totaliva = ?, "
    ." descontado = ?, "
    ." descuento = ?, "
    ." totaldescuento = ?, "
    ." totalpago = ?, "
	." tipocompra = ?, "
	." formacompra = ?, "
	." fechavencecredito = ?, "
	." fechaemision = ?, "
	." fecharecepcion = ?, "
	." observaciones = ? "
	." WHERE "
	." codcompra = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codfactura);
	$stmt->bindParam(3, $codproveedor);
    $stmt->bindParam(4, $TxtSubtotal);
    $stmt->bindParam(5, $TxtSubtotalExento);
    $stmt->bindParam(6, $TxtSubtotalIva);
    $stmt->bindParam(7, $TxtTotalIva);
    $stmt->bindParam(8, $TxtDescontado);
    $stmt->bindParam(9, $descuento);
    $stmt->bindParam(10, $TxtTotalDescuento);
    $stmt->bindParam(11, $TxtTotal);
	$stmt->bindParam(12, $tipocompra);
	$stmt->bindParam(13, $formacompra);
	$stmt->bindParam(14, $fechavencecredito);
	$stmt->bindParam(15, $fechaemision);
	$stmt->bindParam(16, $fecharecepcion);
	$stmt->bindParam(17, $observaciones);
	$stmt->bindParam(18, $codcompra);
	$stmt->bindParam(19, $codsucursal);

	$tipodocumento = limpiar($_POST["tipodocumento"]);
	$codfactura    = limpiar($_POST["codfactura"]);
	$codproveedor  = limpiar($_POST["codproveedor"]);

	/*###################################################### CALCULO DE DESCUENTO ######################################################*/
	//PORCENTAJE DESCUENTO
    $descuento  = $_POST["descuento"]+$descuentoBD;
    $Porcentaje = $descuento/100;

    //PORCENTAJE IVA
    $txtIva        = $ivaBD;
    $PorcentajeIva = $txtIva/100;

    /*OBTENGO DESCUENTO DE EXENTO*/
    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

    /*OBTENGO SUBTOTAL IVA*/
    $RestoSubtotalIva = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva   = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
    /*OBTENGO TOTAL IVA*/
    $TxtTotalIva      = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
   
    //CALCULO DE TOTAL FACTURA
    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
    $TxtTotal          = number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', '');
    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

	$gastoenvio        = limpiar($_POST["gastoenvio"]);
	$tipocompra        = limpiar($_POST["tipocompra"]);
	$formacompra       = limpiar($_POST["tipocompra"] == "CONTADO" ? decrypt($_POST["formacompra"]) : "CREDITO");
	$fechavencecredito = limpiar($_POST["tipocompra"] == "CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
	$statuscompra      = limpiar($_POST["tipocompra"] == "CONTADO" ? "PAGADA" : "PENDIENTE");
	$fechaemision      = limpiar(date("Y-m-d",strtotime($_POST['fechaemision'])));
	$fecharecepcion    = limpiar(date("Y-m-d",strtotime($_POST['fecharecepcion'])));
	$observaciones     = limpiar($_POST["observaciones"]);
	$codcompra         = limpiar(decrypt($_POST["codcompra"]));
	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### ACTUALIZO LA COMPRA ####################
		
    echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS A LA COMPRA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcompra=".encrypt($codcompra)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
######################### FUNCION AGREGAR DETALLES COMPRAS #######################

########################## FUNCION ELIMINAR DETALLES COMPRAS ########################
public function EliminarDetallesCompras()
{
    self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

	############ CONSULTO TOTAL ACTUAL DE COMPRAS ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM compras 
	WHERE codcompra = '".limpiar(decrypt($_GET["codcompra"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row["descuento"];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE COMPRAS ##############

	$sql = "SELECT * FROM detallecompras WHERE codcompra = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcompra"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		$sql = "SELECT
		idproducto, 
		codproducto, 
		cantidad, 
		preciocompra,
		posicionimpuesto,
		tipoimpuesto, 
		ivaproducto, 
		descproducto 
		FROM detallecompras WHERE coddetallecompra = ? and codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["coddetallecompra"]),decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$cantidadBD     = $row['cantidad'];
		$preciocompraBD = $row['preciocompra'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];

		$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql2);
		$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$existenciaBD = $row['existencia'];

		############# ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
		$sql = "UPDATE productos SET "
		." existencia = ? "
		." WHERE "
		." idproducto = ? AND codproducto = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$stmt->bindParam(2, $idproducto);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $codsucursal);

		$existencia  = number_format($existenciaBD-$cantidadBD, 2, '.', '');
		$idproducto  = limpiar($idproductoBD);
	    $codproducto = limpiar($codproductoBD);
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############# ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

	    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
		$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $codproveedor);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
		$stmt->bindParam(14, $tipokardex);
		$stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcompra     = limpiar(decrypt($_GET["codcompra"]));
	    $codproveedor  = limpiar(decrypt($_GET["codproveedor"]));
		$movimiento    = limpiar("DEVOLUCION");
		$entradas      = limpiar("0.00");
		$salidas       = limpiar("0.00");
		$devolucion    = limpiar($cantidadBD);
		$stockactual   = limpiar($existenciaBD-$cantidadBD);
		$precio        = limpiar($preciocompraBD);
		$ivaproducto   = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
		$descproducto  = limpiar($descproductoBD);
		$documento     = limpiar("DEVOLUCION COMPRA ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		$tipokardex    = limpiar("1");
		$procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_GET["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();

		########## ELIMINAMOS EL PRODUCTO EN DETALLES DE COMPRAS ###########
		$sql = "DELETE FROM detallecompras WHERE coddetallecompra = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetallecompra);
		$stmt->bindParam(2,$codsucursal);
		$coddetallecompra = decrypt($_GET["coddetallecompra"]);
		$codsucursal      = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		########## ELIMINAMOS EL PRODUCTO EN DETALLES DE COMPRAS ###########

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentoc) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto FROM detallecompras WHERE codcompra = '".limpiar(decrypt($_GET["codcompra"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentoc) AS totaldescuentono, SUM(valorneto) AS valorneto FROM detallecompras WHERE codcompra = '".limpiar(decrypt($_GET["codcompra"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

        ############ ACTUALIZO LOS TOTALES EN LA COMPRAS ##############
		$sql = " UPDATE compras SET "
		." subtotal = ?, "
		." subtotalexento = ?, "
		." subtotaliva = ?, "
		." totaliva = ?, "
		." descontado = ?, "
		." totaldescuento = ?, "
		." totalpago = ? "
		." WHERE "
		." codcompra = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $TxtTotal);
		$stmt->bindParam(8, $codcompra);
		$stmt->bindParam(9, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento  = $descuentoBD;
	    $Porcentaje = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva        = $ivaBD;
	    $PorcentajeIva = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva   = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva      = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $TxtTotal          = number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

		$codcompra   = limpiar(decrypt($_GET["codcompra"]));
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN LA COMPRAS ##############

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
###################### FUNCION ELIMINAR DETALLES COMPRAS #######################

####################### FUNCION ELIMINAR COMPRAS #################################
public function EliminarCompras()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

	########################## CONSULTO DATOS DE COMPRA ##########################
	$sql = "SELECT
	codfactura 
	FROM compras 
	WHERE codcompra = '".limpiar(decrypt($_GET["codcompra"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	########################## CONSULTO DATOS DE COMPRA ##########################

	$sql = "SELECT * FROM detallecompras WHERE codcompra = '".limpiar(decrypt($_GET["codcompra"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	$array=array();
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;

		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$cantidadBD     = $row['cantidad'];
		$preciocompraBD = $row['preciocompra'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];

		$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql2);
		$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$existenciaBD = $row['existencia'];

		########### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
		$sql = "UPDATE productos SET "
		." existencia = ? "
		." WHERE "
		." idproducto = ? AND codproducto = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$stmt->bindParam(2, $idproducto);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $codsucursal);

		$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
		$idproducto  = limpiar($idproductoBD);
		$codproducto = limpiar($codproductoBD);
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		########### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

	    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
		$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcompra);
		$stmt->bindParam(2, $codproveedor);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);
		$stmt->bindParam(14, $tipokardex);	
		$stmt->bindParam(15, $procedimiento);	
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcompra     = limpiar(decrypt($_GET["codcompra"]));
	    $codproveedor  = limpiar(decrypt($_GET["codproveedor"]));
		$movimiento    = limpiar("DEVOLUCION");
		$entradas      = limpiar("0.00");
		$salidas       = limpiar("0.00");
		$devolucion    = limpiar($cantidadBD);
		$stockactual   = limpiar($existenciaBD-$cantidadBD);
		$precio        = limpiar($preciocompraBD);
		$ivaproducto   = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
		$descproducto  = limpiar($descproductoBD);
		$documento     = limpiar("DEVOLUCION COMPRA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		$tipokardex    = limpiar("1");
		$procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_GET["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
	}
		#################### ELIMINO LA COMPRA ####################
	    $sql = "DELETE FROM compras WHERE codcompra = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcompra);
		$stmt->bindParam(2,$codsucursal);
		$codcompra   = decrypt($_GET["codcompra"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		#################### ELIMINO LA COMPRA ####################

		#################### ELIMINO DETALLE DE COMPRA ####################
		$sql = "DELETE FROM detallecompras WHERE codcompra = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcompra);
		$stmt->bindParam(2,$codsucursal);
		$codcompra   = decrypt($_GET["codcompra"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		#################### ELIMINO DETALLE DE COMPRA ####################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
######################### FUNCION ELIMINAR COMPRAS #################################

##################### FUNCION BUSQUEDA COMPRAS POR PROVEEDORES ###################
public function BuscarComprasxProveedor() 
{
	self::SetNames();
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor,
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	proveedores.id_provincia AS id_provincia2, 
	proveedores.id_departamento AS id_departamento2, 
	proveedores.direcproveedor, 
	proveedores.emailproveedor,
	proveedores.vendedor,
	proveedores.tlfvendedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3, 
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2, 
	SUM(detallecompras.cantidad) as articulos 
	FROM (compras LEFT JOIN detallecompras ON compras.codcompra=detallecompras.codcompra) 
	INNER JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON proveedores.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON proveedores.id_departamento = departamentos2.id_departamento 
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ?
	GROUP BY detallecompras.codcompra";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"]),decrypt($_GET["codproveedor"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON COMPRAS DE PRODUCTOS PARA EL PROVEEDOR SELECCIONADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION BUSQUEDA COMPRAS POR PROVEEDORES ###################

###################### FUNCION BUSQUEDA COMPRAS POR FECHAS ###########################
public function BuscarComprasxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.documproveedor,
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	proveedores.id_provincia AS id_provincia2, 
	proveedores.id_departamento AS id_departamento2, 
	proveedores.direcproveedor, 
	proveedores.emailproveedor,
	proveedores.vendedor,
	proveedores.tlfvendedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3, 
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2, 
	SUM(detallecompras.cantidad) as articulos 
	FROM (compras LEFT JOIN detallecompras ON compras.codcompra=detallecompras.codcompra) 
	INNER JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento 
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor 
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON proveedores.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON proveedores.id_departamento = departamentos2.id_departamento 
	LEFT JOIN usuarios ON compras.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fecharecepcion,'%Y-%m-%d') BETWEEN ? AND ?
	GROUP BY detallecompras.codcompra";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON COMPRAS DE PRODUCTO PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA COMPRAS POR FECHAS ###########################

###################### FUNCION BUSQUEDA ABONOS CREDITOS POR FECHAS ###########################
public function BuscarAbonosCreditosComprasxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	compras.idcompra, 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura, 
	compras.creditopagado,
	abonoscreditoscompras.idabono,
	abonoscreditoscompras.codabono,
	abonoscreditoscompras.codcompra,
	abonoscreditoscompras.codproveedor,
	abonoscreditoscompras.montoabono, 
	abonoscreditoscompras.formaabono, 
	abonoscreditoscompras.codbanco, 
	abonoscreditoscompras.comprobante,
	abonoscreditoscompras.fechaabono,
    abonoscreditoscompras.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	proveedores.direcproveedor,
	proveedores.emailproveedor,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
	provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
    mediospagos.mediopago,
	bancos.nombanco
	FROM (abonoscreditoscompras LEFT JOIN compras ON abonoscreditoscompras.codcompra = compras.codcompra)
	LEFT JOIN mediospagos ON abonoscreditoscompras.formaabono = mediospagos.codmediopago
	LEFT JOIN bancos ON abonoscreditoscompras.codbanco = bancos.codbanco
	LEFT JOIN sucursales ON abonoscreditoscompras.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN proveedores ON abonoscreditoscompras.codproveedor = proveedores.codproveedor
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON proveedores.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON proveedores.id_departamento = departamentos2.id_departamento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE abonoscreditoscompras.codsucursal = ?
	AND abonoscreditoscompras.formaabono = ?
	AND DATE_FORMAT(abonoscreditoscompras.fechaabono,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codmediopago'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA ABONOS CREDITOS POR FECHAS ###########################

###################### FUNCION BUSQUEDA CREDITOS POR PROVEEDOR ###########################
public function BuscarCreditosComprasxProveedor() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ? 
	AND compras.tipocompra ='CREDITO' 
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ? 
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PAGADA'
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ? 
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PENDIENTE'
	GROUP BY compras.codcompra";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codproveedor'])));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA EL PROVEEDOR INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS POR PROVEEDOR ###########################

###################### FUNCION BUSQUEDA CREDITOS DE COMPRAS POR FECHAS ###########################
public function BuscarCreditosComprasxFechas() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO'
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO'
	AND compras.statuscompra ='PAGADA'
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.direcsucursal,
	sucursales.correosucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3
	FROM (compras INNER JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
	LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO'
	AND compras.statuscompra ='PENDIENTE'
	GROUP BY compras.codcompra";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS DE COMPRAS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS DE COMPRAS POR FECHAS ###########################

###################### FUNCION BUSQUEDA DETALLES CREDITOS POR PROVEEDOR ###########################
public function BuscarDetallesCreditosComprasxProveedor() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	proveedores.direcproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ? 
	AND compras.tipocompra ='CREDITO' 
	GROUP BY compras.codcompra";
	} elseif(decrypt($_GET['status']) == 2){
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	proveedores.direcproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ? 
	AND compras.codproveedor = ?  
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PAGADA'
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	proveedores.direcproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ?  
	AND compras.codproveedor = ? 
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PENDIENTE'
	GROUP BY compras.codcompra";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codproveedor'])));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA DETALLES CREDITOS POR PROVEEDOR ###########################

###################### FUNCION BUSQUEDA DETALLES CREDITOS POR FECHAS ###########################
public function BuscarDetallesCreditosComprasxFechas() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){
	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO' 
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor, 
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PAGADA'
	GROUP BY compras.codcompra";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	compras.codcompra,
	compras.tipodocumento,
	compras.codfactura,
	compras.codproveedor,  
	compras.subtotal,
	compras.subtotalexento, 
	compras.subtotaliva, 
	compras.iva, 
	compras.totaliva, 
	compras.descontado, 
	compras.descuento, 
	compras.totaldescuento, 
	compras.totalpago,
	compras.gastoenvio,
	compras.creditopagado, 
	compras.tipocompra,
	compras.formacompra,
	compras.fechavencecredito,
    compras.fechapagado,
	compras.statuscompra,
	compras.fechaemision,
	compras.fecharecepcion,
    compras.observaciones,
	compras.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	proveedores.codproveedor,
	proveedores.documproveedor, 
	proveedores.cuitproveedor, 
	proveedores.nomproveedor, 
	proveedores.tlfproveedor,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos
    FROM (compras LEFT JOIN proveedores ON compras.codproveedor = proveedores.codproveedor)
    LEFT JOIN sucursales ON compras.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON proveedores.documproveedor = documentos3.coddocumento

	LEFT JOIN
	   (SELECT
	   codcompra,
	   SUM(detallecompras.cantidad) AS articulos,
	   GROUP_CONCAT(
	   	    detallecompras.cantidad, ' | ', 
		 	detallecompras.producto, ' | ', 
		   	detallecompras.descripcion, ' | ',
		   	if(detallecompras.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecompras.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecompras.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecompras.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecompras
	        LEFT JOIN marcas ON detallecompras.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecompras.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecompras.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecompras.codcolor = colores.codcolor
	        WHERE detallecompras.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	        GROUP BY
	        detallecompras.codcompra) pag ON pag.codcompra = compras.codcompra

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE compras.codsucursal = ? 
	AND DATE_FORMAT(compras.fechaemision,'%Y-%m-%d') BETWEEN ? AND ?
	AND compras.tipocompra ='CREDITO' 
	AND compras.statuscompra ='PENDIENTE'
	GROUP BY compras.codcompra";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA DETALLES CREDITOS POR FECHAS ###########################

############################# FIN DE CLASE COMPRAS ###################################





























############################## CLASE COTIZACIONES ###################################

########################### FUNCION REGISTRAR COTIZACIONES ##########################
public function RegistrarCotizaciones()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]) or empty($_POST["txtTotal"]))
	{
		echo "1";
		exit;
	}
	elseif(empty($_SESSION["CarritoCotizacion"]))
	{
		echo "2";
		exit;
	}

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	cuitsucursal, 
	nroactividadsucursal 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cuitsucursal = $row['cuitsucursal'];
	$nroactividad = $row['nroactividadsucursal'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE COTIZACION ####################
	$sql = "SELECT codcotizacion FROM cotizaciones 
	ORDER BY idcotizacion DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$cotizacion=$row["codcotizacion"];
	}
	if(empty($cotizacion))
	{
		$codcotizacion = "01";

	} else {

		$num           = substr($cotizacion, 0);
        $dig           = $num + 1;
        $codigofinal   = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codcotizacion = $codigofinal;
	}
    ################ CREO CODIGO DE COTIZACION ###############

    ################### CREO CODIGO DE FACTURA ####################
	$sql4 = "SELECT codfactura FROM cotizaciones 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idcotizacion DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$factura = $row4["codfactura"];
	}
	if(empty($factura))
	{
		$codfactura = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = $var4;
	}
	################### CREO CODIGO DE FACTURA ####################

    ################### REGISTRO LA COTIZACION ####################
    $query = "INSERT INTO cotizaciones values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codcotizacion);
	$stmt->bindParam(2, $tipodocumento);
	$stmt->bindParam(3, $codfactura);
	$stmt->bindParam(4, $codcliente);
	$stmt->bindParam(5, $exonerado);
	$stmt->bindParam(6, $subtotal);
	$stmt->bindParam(7, $subtotalexento);
	$stmt->bindParam(8, $subtotaliva);
	$stmt->bindParam(9, $iva);
	$stmt->bindParam(10, $totaliva);
	$stmt->bindParam(11, $descontado);
	$stmt->bindParam(12, $descuento);
	$stmt->bindParam(13, $totaldescuento);
	$stmt->bindParam(14, $totalpago);
	$stmt->bindParam(15, $totalpago2);
	$stmt->bindParam(16, $observaciones);
	$stmt->bindParam(17, $fechacotizacion);
	$stmt->bindParam(18, $procesada);
	$stmt->bindParam(19, $codigo);
	$stmt->bindParam(20, $codsucursal);
    
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$observaciones   = limpiar($_POST["observaciones"]);
    $fechacotizacion = limpiar(date("Y-m-d H:i:s"));
	$procesada       = limpiar("1");
	$codigo          = limpiar($_SESSION["codigo"]);
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### REGISTRO LA COTIZACION ####################
	
	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoCotizacion"];
	for($i=0;$i<count($detalle);$i++){

		################### REGISTRO DETALLES DE COTIZACION ####################
		$query = "INSERT INTO detallecotizaciones values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codcotizacion);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
		$stmt->bindParam(17, $ivaproducto);
		$stmt->bindParam(18, $descproducto);
		$stmt->bindParam(19, $valortotal);
		$stmt->bindParam(20, $totaldescuentov);
		$stmt->bindParam(21, $subtotalimpuestos);
		$stmt->bindParam(22, $valorneto);
		$stmt->bindParam(23, $valorneto2);
		$stmt->bindParam(24, $tipodetalle);
		$stmt->bindParam(25, $codsucursal);
			
	    $idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
		$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
	    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentov, 2, '.', '');
		$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
		$tipodetalle = limpiar($detalle[$i]['tipodetalle']);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE COTIZACION ####################
    }
        
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoCotizacion"]);
    $this->dbh->commit();
		
    echo "<span class='fa fa-check-square-o'></span> LA COTIZACI&Oacute;N DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcotizacion=".encrypt($codcotizacion)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################## FUNCION REGISTRAR COTIZACIONES ############################

########################## FUNCION BUSQUEDA DE COTIZACIONES ###############################
public function BusquedaCotizaciones() 
{
	self::SetNames();
    if(limpiar($_GET['tipobusqueda']) == 1){
    $sql ="SELECT 
	cotizaciones.idcotizacion, 
	cotizaciones.codcotizacion, 
	cotizaciones.tipodocumento, 
	cotizaciones.codfactura,
	cotizaciones.codcliente, 
	cotizaciones.exonerado,  
	cotizaciones.subtotal,
	cotizaciones.subtotalexento, 
	cotizaciones.subtotaliva, 
	cotizaciones.iva, 
	cotizaciones.totaliva, 
	cotizaciones.descontado, 
	cotizaciones.descuento, 
	cotizaciones.totaldescuento, 
	cotizaciones.totalpago,
	cotizaciones.totalpago2,
	cotizaciones.observaciones,
	cotizaciones.fechacotizacion, 
	cotizaciones.procesada,  
	cotizaciones.codigo,
	cotizaciones.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio, 
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni,
	usuarios.nombres,    
	SUM(detallecotizaciones.cantidad) AS articulos 
	FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
	LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE cotizaciones.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY detallecotizaciones.codcotizacion 
	ORDER BY cotizaciones.idcotizacion ASC";
    } else if(limpiar($_GET['tipobusqueda']) == 2){
    $sql ="SELECT 
	cotizaciones.idcotizacion, 
	cotizaciones.codcotizacion, 
	cotizaciones.tipodocumento, 
	cotizaciones.codfactura,
	cotizaciones.codcliente, 
	cotizaciones.exonerado,  
	cotizaciones.subtotal,
	cotizaciones.subtotalexento, 
	cotizaciones.subtotaliva, 
	cotizaciones.iva, 
	cotizaciones.totaliva, 
	cotizaciones.descontado, 
	cotizaciones.descuento, 
	cotizaciones.totaldescuento, 
	cotizaciones.totalpago,
	cotizaciones.totalpago2,
	cotizaciones.observaciones,
	cotizaciones.fechacotizacion, 
	cotizaciones.procesada,  
	cotizaciones.codigo,
	cotizaciones.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio, 
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni,
	usuarios.nombres,    
	SUM(detallecotizaciones.cantidad) AS articulos 
	FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
	LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE CONCAT(cotizaciones.codcotizacion, '',cotizaciones.codfactura, '',cotizaciones.totalpago, '',if(cotizaciones.codcliente='0','0',clientes.dnicliente), '',if(cotizaciones.codcliente='0','0',clientes.nomcliente), '',if(cotizaciones.codcliente='0','0',clientes.girocliente), '',sucursales.cuitsucursal, '',sucursales.nomsucursal, '',sucursales.dniencargado, '',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
	AND cotizaciones.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY detallecotizaciones.codcotizacion 
	ORDER BY cotizaciones.idcotizacion ASC LIMIT 0,60";
    } else if(limpiar($_GET['tipobusqueda']) == 3){
    $sql ="SELECT 
	cotizaciones.idcotizacion, 
	cotizaciones.codcotizacion, 
	cotizaciones.tipodocumento, 
	cotizaciones.codfactura,
	cotizaciones.codcliente, 
	cotizaciones.exonerado,  
	cotizaciones.subtotal,
	cotizaciones.subtotalexento, 
	cotizaciones.subtotaliva, 
	cotizaciones.iva, 
	cotizaciones.totaliva, 
	cotizaciones.descontado, 
	cotizaciones.descuento, 
	cotizaciones.totaldescuento, 
	cotizaciones.totalpago,
	cotizaciones.totalpago2, 
	cotizaciones.observaciones,
	cotizaciones.fechacotizacion, 
	cotizaciones.procesada,  
	cotizaciones.codigo,
	cotizaciones.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio, 
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni,
	usuarios.nombres,    
	SUM(detallecotizaciones.cantidad) AS articulos 
	FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
	LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE DATE_FORMAT(cotizaciones.fechacotizacion,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
	AND cotizaciones.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	GROUP BY detallecotizaciones.codcotizacion 
	ORDER BY cotizaciones.idcotizacion ASC LIMIT 0,60";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
########################## FUNCION BUSQUEDA DE COTIZACIONES ###############################

####################### FUNCION LISTAR COTIZACIONES ################################
public function ListarCotizaciones()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		cotizaciones.idcotizacion, 
		cotizaciones.codcotizacion, 
		cotizaciones.tipodocumento, 
		cotizaciones.codfactura,
		cotizaciones.codcliente, 
		cotizaciones.exonerado,  
		cotizaciones.subtotal,
		cotizaciones.subtotalexento, 
		cotizaciones.subtotaliva, 
		cotizaciones.iva, 
		cotizaciones.totaliva, 
		cotizaciones.descontado, 
		cotizaciones.descuento, 
		cotizaciones.totaldescuento, 
		cotizaciones.totalpago,
		cotizaciones.totalpago2, 
		cotizaciones.observaciones,
		cotizaciones.fechacotizacion, 
		cotizaciones.procesada, 
		cotizaciones.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio, 
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni,
		usuarios.nombres,    
		SUM(detallecotizaciones.cantidad) AS articulos 
		FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
		LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	    WHERE cotizaciones.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' 
		GROUP BY cotizaciones.codcotizacion 
		ORDER BY cotizaciones.idcotizacion ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else if($_SESSION["acceso"] == "vendedor") {

	    $sql = "SELECT 
		cotizaciones.idcotizacion, 
		cotizaciones.codcotizacion, 
		cotizaciones.tipodocumento, 
		cotizaciones.codfactura,
		cotizaciones.codcliente, 
		cotizaciones.exonerado,  
		cotizaciones.subtotal,
		cotizaciones.subtotalexento, 
		cotizaciones.subtotaliva, 
		cotizaciones.iva, 
		cotizaciones.totaliva, 
		cotizaciones.descontado, 
		cotizaciones.descuento, 
		cotizaciones.totaldescuento, 
		cotizaciones.totalpago,
		cotizaciones.totalpago2, 
		cotizaciones.observaciones,
		cotizaciones.fechacotizacion,  
		cotizaciones.procesada,
		cotizaciones.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio, 
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni,
		usuarios.nombres,    
		SUM(detallecotizaciones.cantidad) AS articulos 
		FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
		LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE cotizaciones.codigo = '".limpiar($_SESSION["codigo"])."' 
		GROUP BY cotizaciones.codcotizacion 
		ORDER BY cotizaciones.idcotizacion ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT 
		cotizaciones.idcotizacion, 
		cotizaciones.codcotizacion, 
		cotizaciones.tipodocumento, 
		cotizaciones.codfactura,
		cotizaciones.codcliente, 
		cotizaciones.exonerado,  
		cotizaciones.subtotal,
		cotizaciones.subtotalexento, 
		cotizaciones.subtotaliva, 
		cotizaciones.iva, 
		cotizaciones.totaliva, 
		cotizaciones.descontado, 
		cotizaciones.descuento, 
		cotizaciones.totaldescuento, 
		cotizaciones.totalpago, 
		cotizaciones.totalpago2, 
		cotizaciones.observaciones,
		cotizaciones.fechacotizacion, 
		cotizaciones.procesada, 
		cotizaciones.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio, 
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		usuarios.dni,
		usuarios.nombres,    
		SUM(detallecotizaciones.cantidad) AS articulos 
		FROM (cotizaciones LEFT JOIN detallecotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion) 
		LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE cotizaciones.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY cotizaciones.codcotizacion
		ORDER BY cotizaciones.idcotizacion ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR COTIZACIONES ############################

############################ FUNCION ID COTIZACIONES #################################
public function CotizacionesPorId()
{
	self::SetNames();
	$sql = " SELECT 
	cotizaciones.*,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	pag.articulos
	FROM (cotizaciones INNER JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   codcotizacion,
	   SUM(detallecotizaciones.cantidad) AS articulos
	   FROM detallecotizaciones
	   WHERE detallecotizaciones.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detallecotizaciones.codcotizacion) pag ON pag.codcotizacion = cotizaciones.codcotizacion

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE cotizaciones.codcotizacion = ? AND cotizaciones.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcotizacion"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID COTIZACIONES #################################
	
######################## FUNCION VER DETALLES COTIZACIONES ############################
public function VerDetallesCotizaciones()
{
	self::SetNames();
	$sql = "SELECT
	detallecotizaciones.coddetallecotizacion,
	detallecotizaciones.codcotizacion,
	detallecotizaciones.coddetallecotizacion,
	detallecotizaciones.idproducto,
	detallecotizaciones.codproducto,
	detallecotizaciones.producto,
	detallecotizaciones.descripcion,
	detallecotizaciones.imei,
	detallecotizaciones.condicion,
	detallecotizaciones.codmarca,
	detallecotizaciones.codmodelo,
	detallecotizaciones.codpresentacion,
	detallecotizaciones.codcolor,
	detallecotizaciones.cantidad,
	detallecotizaciones.preciocompra,
	detallecotizaciones.precioventa,
	detallecotizaciones.posicionimpuesto,
	detallecotizaciones.tipoimpuesto,
	detallecotizaciones.ivaproducto,
	detallecotizaciones.descproducto,
	detallecotizaciones.valortotal, 
	detallecotizaciones.totaldescuentov,
	detallecotizaciones.subtotalimpuestos,
	detallecotizaciones.valorneto,
	detallecotizaciones.valorneto2,
	detallecotizaciones.tipodetalle,
	detallecotizaciones.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallecotizaciones 
	LEFT JOIN marcas ON detallecotizaciones.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallecotizaciones.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON detallecotizaciones.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallecotizaciones.codcolor = colores.codcolor  
	WHERE detallecotizaciones.codcotizacion = ? 
	AND detallecotizaciones.codsucursal = ? ";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcotizacion"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
##################### FUNCION VER DETALLES COTIZACIONES #########################

######################## FUNCION ACTUALIZAR COTIZACIONES #######################
public function ActualizarCotizaciones()
{
	self::SetNames();
	if(empty($_POST["codcotizacion"]) or empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]))
	{
		echo "1";
		exit;
	}

	for($i=0;$i<count($_POST['coddetallecotizacion']);$i++){  //recorro el array
        if (!empty($_POST['coddetallecotizacion'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
    }

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    $this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['coddetallecotizacion']);$i++){  //recorro el array
	if (!empty($_POST['coddetallecotizacion'][$i])) {

	$sql = "SELECT cantidad 
	FROM detallecotizaciones 
	WHERE coddetallecotizacion = '".limpiar($_POST['coddetallecotizacion'][$i])."' 
	AND codcotizacion = '".limpiar(decrypt($_POST["codcotizacion"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cantidadBD = $row['cantidad'];

	if($cantidadBD != $_POST['cantidad'][$i]){

		################### ACTUALIZO DETALLES DE COTIZACION ####################
		$query = "UPDATE detallecotizaciones set"
		." cantidad = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
	    ." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." coddetallecotizacion = ? AND codcotizacion = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $valortotal);
		$stmt->bindParam(3, $totaldescuentov);
	    $stmt->bindParam(4, $subtotalimpuestos);
		$stmt->bindParam(5, $valorneto);
		$stmt->bindParam(6, $valorneto2);
		$stmt->bindParam(7, $coddetallecotizacion);
		$stmt->bindParam(8, $codcotizacion);
		$stmt->bindParam(9, $codsucursal);

		$cantidad             = limpiar($_POST['cantidad'][$i]);
		$preciocompra         = limpiar($_POST['preciocompra'][$i]);
		$precioventa          = limpiar($_POST['precioventa'][$i]);
		$ivaproducto          = limpiar($_POST['ivaproducto'][$i]);
		$descuento            = $_POST['descproducto'][$i]/100;
		$valortotal           = number_format($_POST['valortotal'][$i], 2, '.', '');
		$totaldescuento       = number_format($_POST['totaldescuentov'][$i], 2, '.', '');
		$subtotalimpuestos    = number_format($_POST['subtotalimpuestos'][$i], 0, '.', '');
		$valorneto            = number_format($_POST['valorneto'][$i], 2, '.', '');
		$valorneto2           = number_format($_POST['valorneto2'][$i], 2, '.', '');
		$coddetallecotizacion = limpiar($_POST['coddetallecotizacion'][$i]);
		$codcotizacion        = limpiar(decrypt($_POST["codcotizacion"]));
		$codsucursal          = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### ACTUALIZO DETALLES DE COTIZACION ####################

		} else {

                echo "";
	        }
        }
    }
    $this->dbh->commit();

    ################### ACTUALIZO COTIZACION ####################
	$sql = " UPDATE cotizaciones SET "
	." tipodocumento = ?, "
	." codcliente = ?, "
	." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2= ?, "
	." observaciones = ? "
	." WHERE "
	." codcotizacion = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codcliente);
	$stmt->bindParam(3, $exonerado);
	$stmt->bindParam(4, $subtotal);
	$stmt->bindParam(5, $subtotalexento);
	$stmt->bindParam(6, $subtotaliva);
	$stmt->bindParam(7, $totaliva);
	$stmt->bindParam(8, $descontado);
	$stmt->bindParam(9, $descuento);
	$stmt->bindParam(10, $totaldescuento);
	$stmt->bindParam(11, $totalpago);
	$stmt->bindParam(12, $totalpago2);
	$stmt->bindParam(13, $observaciones);
	$stmt->bindParam(14, $codcotizacion);
	$stmt->bindParam(15, $codsucursal);

	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = number_format($_POST["txtsubtotal"], 2, '.', '');
	$subtotalexento  = number_format($_POST["txtexento"], 2, '.', '');
	$subtotaliva     = number_format($_POST["txtsubtotaliva"], 2, '.', '');
	$totaliva        = number_format($_POST["txtIva"], 2, '.', '');
	$descontado      = number_format($_POST["txtdescontado"], 2, '.', '');
	$descuento       = limpiar($_POST["descuento"]);
    $totaldescuento  = number_format($_POST["txtDescuento"], 2, '.', '');
    $totalpago       = number_format($_POST["txtTotal"], 2, '.', '');
    $totalpago2      = number_format($_POST["txtTotalCompra"], 2, '.', '');
	$observaciones   = limpiar($_POST["observaciones"]);
	$codcotizacion   = limpiar(decrypt($_POST["codcotizacion"]));
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### ACTUALIZO COTIZACION ####################

    echo "<span class='fa fa-check-square-o'></span> LA COTIZACI&Oacute;N DE PRODUCTOS HA SIDO ACTUALIZADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcotizacion=".encrypt($codcotizacion)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
####################### FUNCION ACTUALIZAR COTIZACIONES ############################

####################### FUNCION AGREGAR DETALLES COTIZACIONES ########################
public function AgregarDetallesCotizaciones()
{
	self::SetNames();
	if(empty($_POST["codcotizacion"]) or empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]))
	{
		echo "1";
		exit;
	}
    elseif(empty($_SESSION["CarritoCotizacion"]))
	{
		echo "2";
		exit;
	}

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ############ CONSULTO TOTAL ACTUAL DE COTIZACION ##############
	$sql = "SELECT
	iva,
	descuento,
	totalpago 
	FROM cotizaciones 
	WHERE codcotizacion = '".limpiar(decrypt($_POST["codcotizacion"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$ivaBD       = $row["iva"];
	$descuentoBD = $row["descuento"];
	$totalpagoBD = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE COTIZACION ##############

    $this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoCotizacion"];
	for($i=0;$i<count($detalle);$i++){

	$sql = "SELECT codcotizacion, codproducto 
	FROM detallecotizaciones 
	WHERE codcotizacion = '".limpiar(decrypt($_POST['codcotizacion']))."' 
	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."' 
	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0)
	{
        ################### REGISTRO DETALLES DE COTIZACION ####################
        $query = "INSERT INTO detallecotizaciones values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
        $stmt = $this->dbh->prepare($query);
        $stmt->bindParam(1, $codcotizacion);
        $stmt->bindParam(2, $idproducto);
        $stmt->bindParam(3, $codproducto);
        $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
        $stmt->bindParam(8, $codmarca);
        $stmt->bindParam(9, $codmodelo);
        $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
        $stmt->bindParam(12, $cantidad);
        $stmt->bindParam(13, $preciocompra);
        $stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
        $stmt->bindParam(17, $ivaproducto);
        $stmt->bindParam(18, $descproducto);
        $stmt->bindParam(19, $valortotal);
        $stmt->bindParam(20, $totaldescuentov);
        $stmt->bindParam(21, $subtotalimpuestos);
        $stmt->bindParam(22, $valorneto);
        $stmt->bindParam(23, $valorneto2);
        $stmt->bindParam(24, $tipodetalle);
        $stmt->bindParam(25, $codsucursal);
			
		$codcotizacion   = limpiar(decrypt($_POST["codcotizacion"]));
		$idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
	    $codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
		$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
	    $codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
	    $codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
		$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
		$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
		$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$Discriminado         = $precioconiva/$ValorImpuesto;
		$SubtotalDiscriminado = $precioconiva - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

		$valorneto   = number_format($valortotal-$totaldescuentov, 2, '.', '');
		$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
		$tipodetalle = limpiar($detalle[$i]['tipodetalle']);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE COTIZACION ####################

	} else {

	  	$sql = "SELECT cantidad 
	  	FROM detallecotizaciones 
	  	WHERE codcotizacion = '".limpiar(decrypt($_POST['codcotizacion']))."' 
	  	AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'
	    AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	  	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$cantidadBD = $row['cantidad'];

	  	################### ACTUALIZO DETALLES DE COTIZACION ####################
	  	$query = "UPDATE detallecotizaciones set"
		." cantidad = ?, "
		." descproducto = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." codcotizacion = ? AND codsucursal = ? AND idproducto = ? AND codproducto = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $descproducto);
		$stmt->bindParam(3, $valortotal);
		$stmt->bindParam(4, $totaldescuentov);
		$stmt->bindParam(5, $subtotalimpuestos);
		$stmt->bindParam(6, $valorneto);
		$stmt->bindParam(7, $valorneto2);
		$stmt->bindParam(8, $codcotizacion);
		$stmt->bindParam(9, $codsucursal);
		$stmt->bindParam(10, $idproducto);
		$stmt->bindParam(11, $codproducto);

		$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidadBD);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
		$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
		$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
		$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2'] * $cantidad, 2, '.', '');
		$totaldescuentov = number_format($valortotal * $descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	   	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$Discriminado         = $precioconiva/$ValorImpuesto;
		$SubtotalDiscriminado = $precioconiva - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

		$valorneto     = number_format($valortotal - $totaldescuentov, 2, '.', '');
		$valorneto2    = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$cantidad, 2, '.', ''));
		$codcotizacion = limpiar(decrypt($_POST["codcotizacion"]));
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
		$idproducto    = limpiar($detalle[$i]['id']);
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$stmt->execute();
		################### ACTUALIZO DETALLES DE COTIZACION ####################
	   }
    }    
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoCotizacion"]);
    $this->dbh->commit();

    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallecotizaciones WHERE codcotizacion = '".limpiar(decrypt($_POST["codcotizacion"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
     	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallecotizaciones WHERE codcotizacion = '".limpiar(decrypt($_POST["codcotizacion"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ################### ACTUALIZO LA COTIZACION ####################
    $sql = " UPDATE cotizaciones SET "
	." tipodocumento = ?, "
    ." codcliente = ?, "
    ." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
    ." totalpago2 = ?, "
    ." observaciones = ? "
    ." WHERE "
    ." codcotizacion = ? AND codsucursal = ?;
    ";
    $stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
    $stmt->bindParam(2, $codcliente);
    $stmt->bindParam(3, $exonerado);
	$stmt->bindParam(4, $TxtSubtotal);
	$stmt->bindParam(5, $TxtSubtotalExento);
	$stmt->bindParam(6, $TxtSubtotalIva);
	$stmt->bindParam(7, $TxtTotalIva);
	$stmt->bindParam(8, $TxtDescontado);
	$stmt->bindParam(9, $descuento);
	$stmt->bindParam(10, $TxtTotalDescuento);
	$stmt->bindParam(11, $TxtTotal);
    $stmt->bindParam(12, $totalpago2);
    $stmt->bindParam(13, $observaciones);
    $stmt->bindParam(14, $codcotizacion);
    $stmt->bindParam(15, $codsucursal);

    $tipodocumento   = limpiar($_POST["tipodocumento"]);
    $exonerado       = limpiar($_POST["exonerado"]);

    /*###################################################### CALCULO DE DESCUENTO ######################################################*/
    //PORCENTAJE DESCUENTO
	$descuento     = $_POST["descuento"]+$descuentoBD;
	$Porcentaje    = $descuento/100;

	//PORCENTAJE IVA
	$txtIva        = $ivaBD;
	$PorcentajeIva = $txtIva/100;

	/*OBTENGO DESCUENTO DE EXENTO*/
	$RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	$TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	/*OBTENGO SUBTOTAL IVA*/
	$RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	/*OBTENGO TOTAL IVA*/
	$TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	//CALCULO DE TOTAL FACTURA
	$TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	$TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	$TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	$TxtTotal          = ($_POST["exonerado"] == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	$totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	/*###################################################### CALCULO DE DESCUENTO ######################################################*/

    $observaciones = limpiar($_POST["observaciones"]);
    $codcotizacion = limpiar(decrypt($_POST["codcotizacion"]));
    $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    $stmt->execute();
    ################### ACTUALIZO LA COTIZACION ####################
        	
    echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS A LA COTIZACI&Oacute;N EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codcotizacion=".encrypt($codcotizacion)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
######################### FUNCION AGREGAR DETALLES COTIZACIONES #######################

######################## FUNCION ELIMINAR DETALLES COTIZACIONES #######################
public function EliminarDetallesCotizaciones()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

	############ CONSULTO TOTAL ACTUAL DE COTIZACIONES ##############
	$sql = "SELECT
	codfactura,
	codcliente, 
	exonerado,
	iva,
	descuento,
	totalpago 
	FROM cotizaciones 
	WHERE codcotizacion = '".limpiar(decrypt($_GET["codcotizacion"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD  = $row['codfactura'];
	$codclienteBD  = $row['codcliente'];
	$exoneradoBD   = $row['exonerado'];
	$ivaBD         = $row["iva"];
	$descuentoBD   = $row["descuento"];
	$totalpagoBD   = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE COTIZACIONES ##############

	$sql = "SELECT * FROM detallecotizaciones WHERE codcotizacion = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcotizacion"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		################## ELIMINO DETALLE DE COTIZACION ##################
		$sql = "DELETE FROM detallecotizaciones WHERE coddetallecotizacion = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetallecotizacion);
		$stmt->bindParam(2,$codsucursal);
		$coddetallecotizacion = decrypt($_GET["coddetallecotizacion"]);
		$codsucursal          = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE COTIZACION ##################

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallecotizaciones WHERE codcotizacion = '".limpiar(decrypt($_GET["codcotizacion"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallecotizaciones WHERE codcotizacion = '".limpiar(decrypt($_GET["codcotizacion"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

        ############ ACTUALIZO LOS TOTALES EN LA COTIZACION ##############
		$sql = " UPDATE cotizaciones SET "
		." subtotal = ?, "
	    ." subtotalexento = ?, "
	    ." subtotaliva = ?, "
	    ." totaliva = ?, "
	    ." descontado = ?, "
	    ." totaldescuento = ?, "
	    ." totalpago = ?, "
	    ." totalpago2= ? "
		." WHERE "
		." codcotizacion = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $TxtTotal);
	    $stmt->bindParam(8, $totalpago2);
		$stmt->bindParam(9, $codcotizacion);
		$stmt->bindParam(10, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento     = $descuentoBD;
	    $Porcentaje    = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva        = $ivaBD;
	    $PorcentajeIva = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $TxtTotal          = ($exoneradoBD == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

		$codcotizacion = limpiar(decrypt($_GET["codcotizacion"]));
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN LA COTIZACION ##############

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
################### FUNCION ELIMINAR DETALLES COTIZACIONES #####################

####################### FUNCION ELIMINAR COTIZACIONES #################################
public function EliminarCotizaciones()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

		################## ELIMINO COTIZACION ##################
		$sql = "DELETE FROM cotizaciones WHERE codcotizacion = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcotizacion);
		$stmt->bindParam(2,$codsucursal);
		$codcotizacion = decrypt($_GET["codcotizacion"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO COTIZACION ##################

		################## ELIMINO DETALLE DE COTIZACION ##################
		$sql = "DELETE FROM detallecotizaciones WHERE codcotizacion = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcotizacion);
		$stmt->bindParam(2,$codsucursal);
		$codcotizacion = decrypt($_GET["codcotizacion"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE COTIZACION ##################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
###################### FUNCION ELIMINAR COTIZACIONES #################################

####################### FUNCION PROCESAR COTIZACIONES A VENTA #################################
public function ProcesarCotizaciones()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

    if(empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]) or empty($_POST["tipopago"]))
	{
		echo "2";
		exit;
	}
	elseif(limpiar($_POST["txtTotal"]=="") && limpiar($_POST["txtTotal"]==0) && limpiar($_POST["txtTotal"]==0.00))
	{
		echo "3";
		exit;
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$sql = "SELECT * FROM detallecotizaciones 
	WHERE codcotizacion = '".decrypt($_POST['codcotizacion'])."' 
	AND codsucursal = '".decrypt($_POST['codsucursal'])."'";
    foreach ($this->dbh->query($sql) as $row2) {

    	if(limpiar($row2['tipodetalle'])==1){	

		   $sql = "SELECT 
		   existencia 
		   FROM productos 
		   WHERE idproducto = '".limpiar($row2['idproducto'])."' 
		   AND codproducto = '".limpiar($row2['codproducto'])."' 
		   AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		   foreach ($this->dbh->query($sql) as $row)
		   {
			   $this->p[] = $row;
		   }
		
		   $existenciaBD = $row['existencia'];
		   $cantidad     = $row2['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "4";
		        exit;
	        }

		} elseif(limpiar($row2['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

			$sql = "SELECT 
		    existencia 
		    FROM combos 
		    WHERE codcombo = '".limpiar($row2['codproducto'])."'
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			   $this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $row2['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "5";
		        exit;
	        }

		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($row2['codproducto'],limpiar(decrypt($_POST["codsucursal"]))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia
	        	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($row2['codproducto'])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	    AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				   $this->p[] = $row;

				   $cantracionBD  = $row['cantidad'];
				   $idproductoBD  = $row['idproducto'];
				   $codproductoBD = $row['codproducto'];
				   $existenciaBD  = $row['existencia'];
			       $racion        = number_format($cantracionBD*$row2['cantidad'], 2, '.', '');

			        if ($racion > $existenciaBD) 
			        { 
			        	echo "6";
			        	exit;
			        }
			    }
		    }//fin de consulta de productos de combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    
    LEFT JOIN
        (SELECT
        codcliente, montocredito       
        FROM creditosxclientes 
        WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."') pag ON pag.codcliente = clientes.codcliente
        WHERE clientes.dnicliente = ? 
        AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono"]) ? "" : $_POST["formaabono"]);
    $montoabono        = (empty($_POST["montoabono"]) ? "0.00" : $_POST["montoabono"]);
    $total             = number_format($_POST["txtTotal"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################
    if (limpiar($_POST["tipopago"]) == "CREDITO") {

    	$fechaactual = date("Y-m-d");
		$fechavence = date("Y-m-d",strtotime($_POST['fechavencecredito']));

		if ($codcliente == '0') { 

            echo "7";
            exit;

        } else if (strtotime($fechavence) < strtotime($fechaactual)) {

			echo "8";
			exit;

		} else if ($montoabono != "0.00" && $medioabono == "") {
  
            echo "9";
	        exit;

		} else if ($limitecredito != "0.00" && $total > $creditodisponible) {

            echo "10";
            exit;

        } else if($_POST["montoabono"] >= $_POST["txtTotal"]) { 

	        echo "11";
	        exit;
        }
    }
    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################

    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
    if (limpiar($_POST["tipopago"]) == "CONTADO") {

   	foreach ($_POST['pagos'] as $value)
   	{
			if($value['montopagado'] == "" || $value['montopagado'] == 0.00)	
			{
		        echo "12";
		        exit;
		    }
		}

	    if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {

    		$formas_pago = array_column($_POST['pagos'], 'codmediopago');
            if(count($formas_pago) != count(array_unique($formas_pago)))
   	        {
   		        echo "13";
			    exit;
            } 
            else if (count($formas_pago) > 1 && $_POST["txtPagado"] > $_POST["txtTotal"])
            {
                echo "14";
                exit;
            }

        } else {

      	    if ($_POST["txtTotal"] > $_POST["txtPagado"])
            {
                echo "15";
                exit;
            }
        } 
	}
    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
	
	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	codsucursal, 
	nroactividadsucursal, 
	inicioticket,
	iniciofactura, 
	inicioguia, 
	inicionotaventa  
	FROM sucursales 
	WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nroactividad    = $row['nroactividadsucursal'];
	$inicioticket    = $row['inicioticket'];
	$iniciofactura   = $row['iniciofactura'];
	$inicioguia      = $row['inicioguia'];
	$inicionotaventa = $row['inicionotaventa'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE VENTA ####################
	$sql = "SELECT codventa FROM ventas 
	ORDER BY idventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$venta = $row["codventa"];
	}
	if(empty($venta))
	{
		$codventa    = "01";

	} else {

		$num         = substr($venta, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codventa    = $codigofinal;
	}
    ################ CREO CODIGO DE VENTA ###############

	################### CREO CODIGO DE FACTURA ####################
	if($_POST['tipodocumento'] == "TICKET_5" || $_POST['tipodocumento'] == "TICKET_8" || $_POST['tipodocumento'] == "BOLETA_A4") {

	    $sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'TICKET_5' or tipodocumento = 'TICKET_8' or tipodocumento = 'BOLETA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}
		if(empty($factura)){ 
        	$codfactura = "B".$nroactividad.'-'.$inicioticket;
        } else {
            $var  = strlen("B".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "B".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "FACTURA" || $_POST['tipodocumento'] == "FACTURA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'FACTURA' or tipodocumento = 'FACTURA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "F".$nroactividad.'-'.$iniciofactura;
        } else {
            $var  = strlen("F".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "F".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "GUIA_REMISION") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE tipodocumento = 'GUIA_REMISION'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "G".$nroactividad.'-'.$inicioguia;
        } else {
            $var  = strlen("G".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "G".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "NOTA_VENTA_5" || $_POST['tipodocumento'] == "NOTA_VENTA_8" || $_POST['tipodocumento'] == "NOTA_VENTA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'NOTA_VENTA_5' OR tipodocumento = 'NOTA_VENTA_8' OR tipodocumento = 'NOTA_VENTA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		AND codfactura LIKE 'NV%'
		ORDER BY CAST(SUBSTRING_INDEX(codfactura, '-', -1) AS UNSIGNED) DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}
        if(empty($factura)){ 
        	$codfactura = "NV".$nroactividad.'-'.$inicionotaventa;
        } else {
            $var  = strlen("NV".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "NV".$nroactividad.'-'.$var4;
        }
		   $codserie = limpiar($nroactividad);
		   $codautorizacion = limpiar(GenerateRandomStringg());
	}

    ################### CREO CODIGO DE FACTURA ####################

	################### SELECCIONE LOS DATOS DE LA COTIZACION ######################
    $sql = "SELECT * FROM cotizaciones WHERE codcotizacion = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST['codcotizacion']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    ################### SELECCIONE LOS DATOS DE LA COTIZACION ######################

    $fecha = date("Y-m-d H:i:s");

    ################################ REGISTRO DE VENTAS ################################
    $query = "INSERT INTO ventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codarqueo);
	$stmt->bindParam(3, $codcaja);
	$stmt->bindParam(4, $codventa);
	$stmt->bindParam(5, $codfactura);
	$stmt->bindParam(6, $codserie);
	$stmt->bindParam(7, $codautorizacion);
	$stmt->bindParam(8, $codcliente);
	$stmt->bindParam(9, $exonerado);
	$stmt->bindParam(10, $subtotal);
	$stmt->bindParam(11, $subtotalexento);
	$stmt->bindParam(12, $subtotaliva);
	$stmt->bindParam(13, $iva);
	$stmt->bindParam(14, $totaliva);
	$stmt->bindParam(15, $descontado);
	$stmt->bindParam(16, $descuento);
	$stmt->bindParam(17, $totaldescuento);
	$stmt->bindParam(18, $totalpago);
	$stmt->bindParam(19, $totalpago2);
	$stmt->bindParam(20, $creditopagado);
	$stmt->bindParam(21, $tipopago);
	$stmt->bindParam(22, $formapago);
	$stmt->bindParam(23, $montopagado);
	$stmt->bindParam(24, $montodevuelto);
	$stmt->bindParam(25, $fechavencecredito);
	$stmt->bindParam(26, $fechapagado);
	$stmt->bindParam(27, $statusventa);
	$stmt->bindParam(28, $fechaventa);
	$stmt->bindParam(29, $observaciones);
	$stmt->bindParam(30, $notacredito);
	$stmt->bindParam(31, $codigo);
	$stmt->bindParam(32, $codsucursal);
   
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$codarqueo       = limpiar($codarqueoBD);
	$codcaja         = limpiar($codcajaBD);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$creditopagado   = limpiar(isset($_POST['montoabono']) ? $_POST["montoabono"] : "0.00");
	$tipopago        = limpiar($_POST["tipopago"]);
	$montopagado = '0.00';
    if ($_POST['tipopago'] == 'CONTADO') {
        
        if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {
            $formapago    = 'VARIOS';
            $montopagado  = array_reduce($_POST['pagos'], function ($a, $o) {
                return $a + $o['montopagado'];
            });
        }
        else 
        {
            $formapago   = decrypt($_POST['codmediopago']);
            $montopagado = limpiar($_POST['montopagado']);
        }
    }
    else 
    { 
        $formapago     = limpiar(decrypt($_POST["formaabono"]) != "" ? decrypt($_POST["formaabono"]) : "CREDITO");
    	$montopagado   = limpiar(decrypt($_POST["formaabono"]) != "" ? $_POST['montoabono'] : "0.00");
    }
    $montodevuelto      = limpiar(isset($_POST['montodevuelto']) ? $_POST["montodevuelto"] : "0.00");

	$fechavencecredito = limpiar($_POST["tipopago"]=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
    $fechapagado       = limpiar("0000-00-00");
    $statusventa       = limpiar($_POST["tipopago"]=="CONTADO" ? "PAGADA" : "PENDIENTE");
    $fechaventa        = limpiar($fecha);
	$observaciones     = limpiar($_POST["observaciones"]);
	$notacredito       = limpiar("0");
	$codigo            = limpiar($row["codigo"]);
	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################################ REGISTRO DE VENTAS ################################

	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################
	if(limpiar($_POST["tipopago"])=="CONTADO"){

	    $sql  = "INSERT INTO mediospagoxventas VALUES (NULL, ?, ?, ?, ?, ?, ?)";
	    foreach ($_POST['pagos'] as $pago) {
	      $stmt = $this->dbh->prepare($sql);
	      $stmt->execute([$codarqueoBD, $codcajaBD, $codventa, decrypt($pago['codmediopago']), $pago['montopagado'], $_POST['montodevuelto']]);
	    }
	}
	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################

	################### SELECCIONO DETALLES DE LA COTIZACION ######################
	$sql = "SELECT * FROM detallecotizaciones 
	WHERE codcotizacion = '".decrypt($_POST['codcotizacion'])."' 
	AND codsucursal = '".decrypt($_POST['codsucursal'])."'";
    foreach ($this->dbh->query($sql) as $row2)
	{
	    ############################### REGISTRO DETALLES DE VENTAS ###############################
        $query = "INSERT INTO detalleventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
    	$stmt = $this->dbh->prepare($query);
    	$stmt->bindParam(1, $codventa);
    	$stmt->bindParam(2, $idproducto);
    	$stmt->bindParam(3, $codproducto);
    	$stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
    	$stmt->bindParam(8, $codmarca);
    	$stmt->bindParam(9, $codmodelo);
    	$stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
    	$stmt->bindParam(12, $cantidad);
    	$stmt->bindParam(13, $preciocompra);
    	$stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
    	$stmt->bindParam(17, $ivaproducto);
    	$stmt->bindParam(18, $descproducto);
    	$stmt->bindParam(19, $valortotal);
    	$stmt->bindParam(20, $totaldescuentov);
	    $stmt->bindParam(21, $subtotalimpuestos);
    	$stmt->bindParam(22, $valorneto);
    	$stmt->bindParam(23, $valorneto2);
    	$stmt->bindParam(24, $tipodetalle);
    	$stmt->bindParam(25, $codsucursal);

	    $idproducto        = limpiar($row2['idproducto']);
    	$codproducto       = limpiar($row2['codproducto']);
    	$producto          = limpiar($row2['producto']);
    	$descripcion       = limpiar($row2['descripcion']);
    	$imei              = limpiar($row2['imei']);
    	$condicion         = limpiar($row2['condicion']);
    	$codmarca          = limpiar($row2['codmarca']);
    	$codmodelo         = limpiar($row2['codmodelo']);
    	$codpresentacion   = limpiar($row2['codpresentacion']);
    	$codcolor          = limpiar($row2['codcolor']);
    	$cantidad          = limpiar($row2['cantidad']);
    	$preciocompra      = limpiar($row2['preciocompra']);
    	$precioventa       = limpiar($row2['precioventa']);
    	$precioconiva      = limpiar($row2['ivaproducto'] == "0.00" ? "0.00" : $row2['precioventa']);
		$posicionimpuesto  = limpiar($row2['posicionimpuesto']);
		$tipoimpuesto      = limpiar($row2['tipoimpuesto']);
    	$ivaproducto       = limpiar($row2['ivaproducto']);
    	$descproducto      = limpiar($row2['descproducto']);
    	$descuento         = $row2['descproducto']/100;
    	$valortotal        = number_format($row2['valortotal'], 2, '.', '');
    	$totaldescuentov   = number_format($row2['totaldescuentov'], 2, '.', '');
    	$subtotalimpuestos = number_format($row2['subtotalimpuestos'], 2, '.', '');
    	$valorneto         = number_format($row2['valorneto'], 2, '.', '');
    	$valorneto2        = number_format($row2['valorneto2'], 2, '.', '');
    	$tipodetalle       = limpiar($row2['tipodetalle']);
    	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
    	$stmt->execute();
    	############################### REGISTRO DETALLES DE VENTAS ###############################
    
    	if(limpiar($row2['tipodetalle'])==1){

	        ############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ##################
			$sql = "SELECT existencia FROM productos 
			WHERE idproducto = '".limpiar($row2['idproducto'])."'
			AND codproducto = '".limpiar($row2['codproducto'])."'  
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
			foreach ($this->dbh->query($sql) as $row3)
			{
				$this->p[] = $row3;
			}
			$existenciaBD = $row3['existencia'];
		    ############### VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ##################

		    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
	    	$sql = " UPDATE productos set "
	    	." existencia = ? "
	    	." WHERE "
	    	." idproducto = '".limpiar($row2['idproducto'])."'
	    	AND codproducto = '".limpiar($row2['codproducto'])."' 
	    	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	    	";
	    	$stmt = $this->dbh->prepare($sql);
	    	$stmt->bindParam(1, $existencia);
	    	$cantidad   = limpiar($row2['cantidad']);
	    	$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
	    	$stmt->execute();
	    	##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    	############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    	$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	    	$stmt = $this->dbh->prepare($query);
	    	$stmt->bindParam(1, $codventa);
	    	$stmt->bindParam(2, $codcliente);
	    	$stmt->bindParam(3, $codproducto);
	    	$stmt->bindParam(4, $movimiento);
	    	$stmt->bindParam(5, $entradas);
	    	$stmt->bindParam(6, $salidas);
	    	$stmt->bindParam(7, $devolucion);
	    	$stmt->bindParam(8, $stockactual);
	    	$stmt->bindParam(9, $ivaproducto);
	    	$stmt->bindParam(10, $descproducto);
	    	$stmt->bindParam(11, $precio);
	    	$stmt->bindParam(12, $documento);
	    	$stmt->bindParam(13, $fechakardex);	
	    	$stmt->bindParam(14, $tipokardex);	
	    	$stmt->bindParam(15, $procedimiento);		
	    	$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

	    	$codproducto   = limpiar($row2['codproducto']);
	    	$movimiento    = limpiar("SALIDAS");
	    	$entradas      = limpiar("0.00");
	    	$salidas       = number_format($row2['cantidad'], 2, '.', '');
	    	$devolucion    = limpiar("0.00");
	    	$stockactual   = number_format($existenciaBD-$row2['cantidad'], 2, '.', '');
	    	$ivaproducto   = limpiar($row2['tipoimpuesto'] == 'EXENTO' ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
	    	$descproducto  = number_format($row2['descproducto'], 2, '.', '');
	    	$precio        = number_format($row2["precioventa"], 2, '.', '');
	    	$documento     = limpiar("VENTA: ".$codfactura);
	    	$fechakardex   = limpiar(date("Y-m-d H:i:s"));	
	    	$tipokardex    = limpiar($row2['tipodetalle']);
	    	$procedimiento = limpiar("1");
	    	$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo        = limpiar($_SESSION["codigo"]);
	    	$stmt->execute();
	    	############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

    	} elseif(limpiar($row2['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

		    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql = "SELECT 
			existencia
			FROM combos
			WHERE idcombo = '".limpiar($row2['idproducto'])."'
			AND codcombo = '".limpiar($row2['codproducto'])."'
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

		    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
			$sql = " UPDATE combos set "
				." existencia = ? "
				." WHERE "
				." idcombo = '".limpiar($row2['idproducto'])."'
		        AND codcombo = '".limpiar($row2['codproducto'])."'
		        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
				";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$cantidad   = number_format($row2['cantidad'], 2, '.', '');
			$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
			$stmt->execute();
			##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

			############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
		    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
		    $stmt->bindParam(14, $tipokardex);	
	    	$stmt->bindParam(15, $procedimiento);			
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codproducto   = limpiar($row2['codproducto']);
			$movimiento    = limpiar("SALIDAS");
			$entradas      = limpiar("0.00");
			$salidas       = number_format($row2['cantidad'], 2, '.', '');
			$devolucion    = limpiar("0.00");
			$stockactual   = number_format($existenciaBD-$row2['cantidad'], 2, '.', '');
			$ivaproducto   = limpiar($row2['tipoimpuesto'] == 'EXENTO' ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
			$descproducto  = number_format($row2['descproducto'], 2, '.', '');
			$precio        = number_format($row2["precioventa"], 2, '.', '');
			$documento     = limpiar("VENTA: ".$codfactura);
			$fechakarde    = limpiar(date("Y-m-d"));
		    $tipokardex    = limpiar($row2['tipodetalle']);
	    	$procedimiento = limpiar("2");
			$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo        = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($row2['codproducto'],limpiar(decrypt($_POST["codsucursal"]))));
			$num = $stmt->rowCount();
		    if($num>0) {  

		    	$sql = "SELECT 
		    	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
		    	combosxproductos.codproducto,
		    	combosxproductos.cantidad,
		    	combosxproductos.codsucursal,
		    	productos.existencia,
		    	productos.precioxpublico AS precioventa,
		    	productos.ivaproducto,
		    	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
		    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
		    	WHERE combosxproductos.codcombo IN ('".limpiar($row2['codproducto'])."') 
		    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		    	foreach ($this->dbh->query($sql) as $row)
			    { 
				   $this->p[] = $row;

				   $cantracionBD2    = $row['cantidad'];
				   $idproductoBD2    = $row['idproducto'];
			       $codproductoBD2   = $row['codproducto'];
				   $existenciaBD2    = $row['existencia'];
				   $precioventaBD2   = $row['precioventa'];
			       $nomimpuestoBD2   = $row['nomimpuesto'];
			       $valorimpuestoBD2 = $row['valorimpuesto'];
				   $ivaproductoBD2   = $row['ivaproducto'];
				   $descproductoBD2  = $row['descproducto'];

				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
				    $update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
				    $stmt->bindParam(2, $idproducto);
				    $stmt->bindParam(3, $codproducto);
		            $stmt->bindParam(4, $codsucursal);

				    $racion         = number_format($cantracionBD2*$row2['cantidad'], 2, '.', '');
				    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		            $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
		            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
				    $stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

				    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
				    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				    $stmt = $this->dbh->prepare($query);
				    $stmt->bindParam(1, $codventa);
				    $stmt->bindParam(2, $codcliente);
				    $stmt->bindParam(3, $codproducto);
				    $stmt->bindParam(4, $movimiento);
				    $stmt->bindParam(5, $entradas);
				    $stmt->bindParam(6, $salidas);
				    $stmt->bindParam(7, $devolucion);
				    $stmt->bindParam(8, $stockactual);
				    $stmt->bindParam(9, $ivaproducto);
				    $stmt->bindParam(10, $descproducto);
				    $stmt->bindParam(11, $precio);
				    $stmt->bindParam(12, $documento);
				    $stmt->bindParam(13, $fechakardex);
		            $stmt->bindParam(14, $tipokardex);
	    	        $stmt->bindParam(15, $procedimiento);	
		            $stmt->bindParam(16, $codsucursal);
		            $stmt->bindParam(17, $codigo);		

				    $codproducto   = limpiar($codproductoBD2);
				    $movimiento    = limpiar("SALIDAS");
				    $entradas      = limpiar("0.00");
				    $salidas       = number_format($racion, 2, '.', '');
				    $devolucion    = limpiar("0.00");
				    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
				    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
				    $descproducto  = number_format($descproductoBD2, 2, '.', '');
				    $precio        = number_format($precioventaBD2, 2, '.', '');
				    $documento     = limpiar("VENTA (DETALLE DE COMBO): ".$codfactura);
				    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
		            $tipokardex    = limpiar("1");
	    	        $procedimiento = limpiar("2");
		            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	            $codigo        = limpiar($_SESSION["codigo"]);
				    $stmt->execute();
				    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################  
			    }
		    }//fin de consulta de productos de combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
	   } else { // SI EL DETALLE ES UN SERVICIO

		    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
		    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
		    $stmt->bindParam(14, $tipokardex);
	    	$stmt->bindParam(15, $procedimiento);			
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codproducto   = limpiar($row2['codproducto']);
			$movimiento    = limpiar("SALIDAS");
			$entradas      = limpiar("0.00");
			$salidas       = number_format($row2['cantidad'], 2, '.', '');
			$devolucion    = limpiar("0.00");
			$stockactual   = limpiar("0.00");
			$ivaproducto   = limpiar($row2['tipoimpuesto'] == 'EXENTO' ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
			$descproducto  = number_format($row2['descproducto'], 2, '.', '');
			$precio        = number_format($row2["precioventa"], 2, '.', '');
			$documento     = limpiar("VENTA: ".$codfactura);
			$fechakardex   = limpiar(date("Y-m-d H:i:s"));
		    $tipokardex    = limpiar($row2['tipodetalle']);
	    	$procedimiento = limpiar("3");	
			$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo        = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    }
	}
	################### SELECCIONO DETALLES DE LA COTIZACION ######################

	##################### ACTUALIZO COTIZACION A PROCESADO ####################
	$sql = "UPDATE cotizaciones set "
	." procesada = ? "
	." WHERE "
	." codcotizacion = '".limpiar(decrypt($_POST["codcotizacion"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $procesada);

	$procesada = limpiar("2");
	$stmt->execute();
    ##################### ACTUALIZO COTIZACION A PROCESADO ####################

	################ AGREGAMOS EL INGRESO A CONTADO ##############
    if (limpiar($_POST["tipopago"]=="CONTADO")){

		$sql = "UPDATE arqueocaja set "
		." ingresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $codarqueo);

		$txtTotal  = number_format($_POST["txtTotal"]+$ingresoBD, 2, '.', '');
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
    }
    ################ AGREGAMOS EL INGRESO A CONTADO ##############

    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################
    if (limpiar($_POST["tipopago"]=="CREDITO")) {

		$sql = " UPDATE arqueocaja SET "
		." creditos = ?, "
		." abonos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $totalabono);
		$stmt->bindParam(3, $codarqueo);

		$TotalCredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
		$txtTotal     = number_format($TotalCredito+$creditoBD, 2, '.', '');
		$totalabono   = number_format($_POST["montoabono"]+$abonoBD, 2, '.', '');
		$codarqueo    = limpiar($codarqueoBD);
		$stmt->execute(); 

		$sql = " SELECT codcliente FROM creditosxclientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($codcliente,decrypt($_POST["codsucursal"])));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			$query = "INSERT INTO creditosxclientes values (null, ?, ?, ?);";
			$stmt  = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcliente);
			$stmt->bindParam(2, $montocredito);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();

		} else { 

			$sql = "UPDATE creditosxclientes set"
			." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($montoactual+($_POST["txtTotal"]-$_POST["montoabono"]), 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
		}

		if (limpiar($_POST["montoabono"]!="0.00" && $_POST["montoabono"]!="0" && $_POST["montoabono"]!="")) {
			
			######################### CODIGO DE ABONO #########################
	        $sql = "SELECT 
			codabono 
			FROM abonoscreditosventas 
			ORDER BY idabono 
			DESC LIMIT 1";
			foreach ($this->dbh->query($sql) as $row)
			{
				$num = $row["codabono"];
			}
			$codabono = (empty($num) ? "1" : $num + 1);
            ######################### CODIGO DE ABONO #########################

            ################### CODIGO DE CREDITO ABONO ####################
			$sql4 = "SELECT codcredito FROM abonoscreditosventas 
			WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
			ORDER BY idabono DESC LIMIT 1";
			foreach ($this->dbh->query($sql4) as $row4){

				$id = $row4["codcredito"];
			}
			if(empty($id))
			{
				$codcredito = "0000001";

			} else {

				$var  = strlen("");
		        $var1 = substr($id , $var);
		        $var2 = strlen($var1);
		        $var3 = $var1 + 1;
		        $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
		        $codcredito = $var4;
			}
			################### CODIGO DE CREDITO ABONO ####################

			######################### REGISTRO ABONO DE CREDITO #########################
            $query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codabono);
			$stmt->bindParam(2, $codcredito);
			$stmt->bindParam(3, $codarqueo);
			$stmt->bindParam(4, $codcaja);
			$stmt->bindParam(5, $codventa);
			$stmt->bindParam(6, $codcliente);
			$stmt->bindParam(7, $montoabono);
			$stmt->bindParam(8, $formaabono);
			$stmt->bindParam(9, $codbanco);
			$stmt->bindParam(10, $comprobante);
			$stmt->bindParam(11, $fechaabono);
			$stmt->bindParam(12, $codsucursal);

			$codarqueo   = limpiar($codarqueoBD);
			$codcaja     = limpiar($codcajaBD);
			$montoabono  = number_format($_POST["montoabono"], 2, '.', '');
			$formaabono  = decrypt($_POST["formaabono"]);
			$codbanco    = limpiar("0");
			$comprobante = limpiar("0");
			$fechaabono  = limpiar($fecha);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			######################### REGISTRO ABONO DE CREDITO #########################
		}
	}
	################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################

    echo "<span class='fa fa-check-square-o'></span> LA COTIZACION HA SIDO PROCESADA COMO VENTA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
###################### FUNCION PROCESAR COTIZACIONES A VENTAS #################################

###################### FUNCION BUSQUEDA COTIZACIONES POR FECHAS ####################
public function BuscarCotizacionesxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	cotizaciones.idcotizacion, 
	cotizaciones.codcotizacion,
	cotizaciones.tipodocumento,
	cotizaciones.codfactura,
	cotizaciones.codcliente,
	cotizaciones.exonerado,
	cotizaciones.subtotal,
	cotizaciones.subtotalexento,
	cotizaciones.subtotaliva, 
	cotizaciones.iva,
	cotizaciones.totaliva, 
	cotizaciones.descontado,
	cotizaciones.descuento,
	cotizaciones.totaldescuento, 
	cotizaciones.totalpago, 
	cotizaciones.totalpago2,
	cotizaciones.observaciones,
	cotizaciones.fechacotizacion,
	cotizaciones.procesada,
	cotizaciones.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	pag.articulos,
	pag.detalles_productos 
	FROM (cotizaciones LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal) 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codcotizacion,
	    SUM(detallecotizaciones.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallecotizaciones.cantidad, ' | ', 
		 	detallecotizaciones.producto, ' | ', 
		   	detallecotizaciones.descripcion, ' | ',
		   	if(detallecotizaciones.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecotizaciones.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecotizaciones.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecotizaciones.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecotizaciones
			LEFT JOIN marcas ON detallecotizaciones.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecotizaciones.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecotizaciones.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecotizaciones.codcolor = colores.codcolor
			WHERE detallecotizaciones.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallecotizaciones.codcotizacion) pag ON pag.codcotizacion = cotizaciones.codcotizacion

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE cotizaciones.codsucursal = ? 
	AND DATE_FORMAT(cotizaciones.fechacotizacion,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY cotizaciones.codcotizacion
	ORDER BY cotizaciones.codcotizacion ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON COTIZACIONES PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION BUSQUEDA COTIZACIONES POR FECHAS ###################

###################### FUNCION BUSQUEDA COTIZACIONES POR VENDEDOR ####################
public function BuscarCotizacionesxVendedor() 
{
	self::SetNames();
	$sql ="SELECT 
	cotizaciones.idcotizacion, 
	cotizaciones.codcotizacion,
	cotizaciones.tipodocumento,
	cotizaciones.codfactura,
	cotizaciones.codcliente,
	cotizaciones.exonerado,
	cotizaciones.subtotal,
	cotizaciones.subtotalexento,
	cotizaciones.subtotaliva, 
	cotizaciones.iva,
	cotizaciones.totaliva, 
	cotizaciones.descontado,
	cotizaciones.descuento,
	cotizaciones.totaldescuento, 
	cotizaciones.totalpago, 
	cotizaciones.totalpago2,
	cotizaciones.observaciones,
	cotizaciones.fechacotizacion,
	cotizaciones.procesada,
	cotizaciones.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
    usuarios.dni,
    usuarios.nombres,
	pag.articulos,
	pag.detalles_productos 
	FROM (cotizaciones LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal) 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON cotizaciones.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codcotizacion,
	    SUM(detallecotizaciones.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallecotizaciones.cantidad, ' | ', 
		 	detallecotizaciones.producto, ' | ', 
		   	detallecotizaciones.descripcion, ' | ',
		   	if(detallecotizaciones.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallecotizaciones.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallecotizaciones.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallecotizaciones.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallecotizaciones
			LEFT JOIN marcas ON detallecotizaciones.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallecotizaciones.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallecotizaciones.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallecotizaciones.codcolor = colores.codcolor
			WHERE detallecotizaciones.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallecotizaciones.codcotizacion) pag ON pag.codcotizacion = cotizaciones.codcotizacion

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE cotizaciones.codsucursal = ?
	AND cotizaciones.codigo = ? 
	AND DATE_FORMAT(cotizaciones.fechacotizacion,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY cotizaciones.codcotizacion
	ORDER BY cotizaciones.codcotizacion ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codigo']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON COTIZACIONES PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION BUSQUEDA COTIZACIONES POR VENDEDOR ###################

###################### FUNCION BUSCAR DETALLES COTIZACIONES POR FECHAS #########################
public function BuscarDetallesCotizacionesxFechas() 
{
    self::SetNames();
    $sql ="SELECT 
    detallecotizaciones.idproducto,
    detallecotizaciones.codproducto,
    detallecotizaciones.producto,
	detallecotizaciones.descripcion,
	detallecotizaciones.imei,
	detallecotizaciones.condicion, 
    detallecotizaciones.codmarca, 
    detallecotizaciones.codmodelo, 
    detallecotizaciones.codpresentacion,
	detallecotizaciones.codcolor, 
    detallecotizaciones.precioventa,
	detallecotizaciones.posicionimpuesto,
	detallecotizaciones.tipoimpuesto,
    detallecotizaciones.ivaproducto,
    detallecotizaciones.descproducto,
    detallecotizaciones.valortotal,
    detallecotizaciones.valorneto,
    detallecotizaciones.tipodetalle, 
    marcas.nommarca,
    modelos.nommodelo,
    presentaciones.nompresentacion,
	colores.nomcolor,
    sucursales.documsucursal, 
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.tlfsucursal,
    sucursales.direcsucursal,
    sucursales.correosucursal,
    sucursales.llevacontabilidad,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    provincias.provincia,
    departamentos.departamento,
    documentos.documento,
    usuarios.dni,
    usuarios.nombres,
    SUM(detallecotizaciones.cantidad) AS cantidad,
    pag.existencia
    FROM (detallecotizaciones LEFT JOIN cotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion)
    LEFT JOIN marcas ON detallecotizaciones.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detallecotizaciones.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detallecotizaciones.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallecotizaciones.codcolor = colores.codcolor 
    LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo

    LEFT JOIN
		(SELECT
		idproducto,
		existencia
		FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detallecotizaciones.idproducto
 
    WHERE cotizaciones.codsucursal = ? 
    AND DATE_FORMAT(cotizaciones.fechacotizacion,'%Y-%m-%d') BETWEEN ? AND ? 
    GROUP BY detallecotizaciones.codproducto, detallecotizaciones.producto, detallecotizaciones.precioventa, detallecotizaciones.descproducto, detallecotizaciones.codsucursal
    ORDER BY detallecotizaciones.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS COTIZADOS PARA EL RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES COTIZACIONES POR FECHAS ###############################

###################### FUNCION BUSCAR DETALLES COTIZACIONES POR VENDEDOR #########################
public function BuscarDetallesCotizacionesxVendedor() 
{
    self::SetNames();
    $sql ="SELECT 
    detallecotizaciones.idproducto,
    detallecotizaciones.codproducto,
    detallecotizaciones.producto,
	detallecotizaciones.descripcion,
	detallecotizaciones.imei,
	detallecotizaciones.condicion, 
    detallecotizaciones.codmarca, 
    detallecotizaciones.codmodelo, 
    detallecotizaciones.codpresentacion,
	detallecotizaciones.codcolor, 
    detallecotizaciones.precioventa,
	detallecotizaciones.posicionimpuesto,
	detallecotizaciones.tipoimpuesto,
    detallecotizaciones.ivaproducto,
    detallecotizaciones.descproducto,
    detallecotizaciones.valortotal,
    detallecotizaciones.valorneto,
    detallecotizaciones.tipodetalle, 
    marcas.nommarca,
    modelos.nommodelo,
    presentaciones.nompresentacion,
	colores.nomcolor,
    sucursales.documsucursal, 
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.tlfsucursal,
    sucursales.direcsucursal,
    sucursales.correosucursal,
    sucursales.llevacontabilidad,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    provincias.provincia,
    departamentos.departamento,
    documentos.documento,
    usuarios.dni,
    usuarios.nombres,
    SUM(detallecotizaciones.cantidad) AS cantidad,
    pag.existencia
    FROM (detallecotizaciones LEFT JOIN cotizaciones ON detallecotizaciones.codcotizacion = cotizaciones.codcotizacion)
    LEFT JOIN marcas ON detallecotizaciones.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detallecotizaciones.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detallecotizaciones.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallecotizaciones.codcolor = colores.codcolor 
    LEFT JOIN sucursales ON cotizaciones.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON cotizaciones.codigo = usuarios.codigo

    LEFT JOIN
		(SELECT
		idproducto,
		existencia
		FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detallecotizaciones.idproducto
 
    WHERE cotizaciones.codsucursal = ? 
    AND cotizaciones.codigo = ?
    AND DATE_FORMAT(cotizaciones.fechacotizacion,'%Y-%m-%d') BETWEEN ? AND ? 
    GROUP BY detallecotizaciones.codproducto, detallecotizaciones.producto, detallecotizaciones.precioventa, detallecotizaciones.descproducto, detallecotizaciones.codsucursal
    ORDER BY detallecotizaciones.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codigo']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL VENDEDOR Y RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES COTIZACIONES POR VENDEDOR ###############################

########################### FIN DE CLASE COTIZACIONES ############################





























############################## CLASE PREVENTAS ###################################

########################### FUNCION REGISTRAR PREVENTAS ##########################
public function RegistrarPreventas()
{
	self::SetNames();
	if(empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]) or empty($_POST["txtTotal"]))
	{
		echo "1";
		exit;
	}
	elseif(empty($_SESSION["CarritoPreventa"]))
	{
		echo "2";
		exit;
	}

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$v = $_SESSION["CarritoPreventa"];
    for ($i = 0, $iMax = count($v); $i < $iMax; $i++) {

	    if($v[$i]['tipodetalle'] == 1){ 

		    $sql = "SELECT existencia FROM productos 
		    WHERE idproducto = '".limpiar($v[$i]['id'])."' 
		    AND codproducto = '".limpiar($v[$i]['txtCodigo'])."' 
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			   $this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $v[$i]['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "3";
		        exit;
	        }

		} elseif(limpiar($v[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

			$sql = "SELECT 
		    existencia 
		    FROM combos 
		    WHERE idcombo = '".limpiar($v[$i]['id'])."' 
	        AND codcombo = '".limpiar($v[$i]['txtCodigo'])."'
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			   $this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $v[$i]['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "4";
		        exit;
	        }

		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($v[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia
	        	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($v[$i]['txtCodigo'])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	    AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				   $this->p[] = $row;

				    $cantracionBD2  = $row['cantidad'];
				    $idproductoBD2  = $row['idproducto'];
				    $codproductoBD2 = $row['codproducto'];
				    $existenciaBD2  = $row['existencia'];
			        $racion        = number_format($cantracionBD2*$v[$i]['cantidad'], 2, '.', '');

			        if ($racion > $existenciaBD2) 
			        { 
			            echo "5";
			        	exit;
			        }
			    }
		    }//fin de consulta de productos de combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	cuitsucursal, 
	nroactividadsucursal 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cuitsucursal = $row['cuitsucursal'];
	$nroactividad = $row['nroactividadsucursal'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE PREVENTA ####################
	$sql = "SELECT codpreventa FROM preventas 
	ORDER BY idpreventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$preventa = $row["codpreventa"];
	}
	if(empty($preventa))
	{
		$codpreventa = "01";

	} else {

		$num         = substr($preventa, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codpreventa = $codigofinal;
	}
    ################ CREO CODIGO DE PREVENTA ###############

	################### CREO CODIGO DE FACTURA ####################
	$sql4 = "SELECT codfactura FROM preventas 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idpreventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$factura = $row4["codfactura"];
	}
	if(empty($factura))
	{
		$codfactura = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = $var4;
	}
    ################### CREO LOS CODIGO DE PREVENTA ####################

    ################### REGISTRO LA PREVENTA ####################
    $query = "INSERT INTO preventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codpreventa);
	$stmt->bindParam(2, $tipodocumento);
	$stmt->bindParam(3, $codfactura);
	$stmt->bindParam(4, $codcliente);
	$stmt->bindParam(5, $exonerado);
	$stmt->bindParam(6, $subtotal);
	$stmt->bindParam(7, $subtotalexento);
	$stmt->bindParam(8, $subtotaliva);
	$stmt->bindParam(9, $iva);
	$stmt->bindParam(10, $totaliva);
	$stmt->bindParam(11, $descontado);
	$stmt->bindParam(12, $descuento);
	$stmt->bindParam(13, $totaldescuento);
	$stmt->bindParam(14, $totalpago);
	$stmt->bindParam(15, $totalpago2);
	$stmt->bindParam(16, $observaciones);
	$stmt->bindParam(17, $fechapreventa);
	$stmt->bindParam(18, $procesada);
	$stmt->bindParam(19, $codigo);
	$stmt->bindParam(20, $codsucursal);
    
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$observaciones   = limpiar($_POST["observaciones"]);
    $fechapreventa   = limpiar(date("Y-m-d H:i:s"));
	$procesada       = limpiar("1");
	$codigo          = limpiar($_SESSION["codigo"]);
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### REGISTRO LA PREVENTA ####################
	
	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoPreventa"];
	for($i=0;$i<count($detalle);$i++){

	################### REGISTRO DETALLES DE PREVENTA ####################
	$query = "INSERT INTO detallepreventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codpreventa);
	$stmt->bindParam(2, $idproducto);
    $stmt->bindParam(3, $codproducto);
    $stmt->bindParam(4, $producto);
	$stmt->bindParam(5, $descripcion);
	$stmt->bindParam(6, $imei);
	$stmt->bindParam(7, $condicion);
    $stmt->bindParam(8, $codmarca);
    $stmt->bindParam(9, $codmodelo);
    $stmt->bindParam(10, $codpresentacion);
	$stmt->bindParam(11, $codcolor);
	$stmt->bindParam(12, $cantidad);
	$stmt->bindParam(13, $preciocompra);
	$stmt->bindParam(14, $precioventa);
	$stmt->bindParam(15, $posicionimpuesto);
	$stmt->bindParam(16, $tipoimpuesto);
	$stmt->bindParam(17, $ivaproducto);
	$stmt->bindParam(18, $descproducto);
	$stmt->bindParam(19, $valortotal);
	$stmt->bindParam(20, $totaldescuentov);
	$stmt->bindParam(21, $subtotalimpuestos);
	$stmt->bindParam(22, $valorneto);
	$stmt->bindParam(23, $valorneto2);
	$stmt->bindParam(24, $tipodetalle);
	$stmt->bindParam(25, $codsucursal);
		
    $idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
	$codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
	$producto        = limpiar($detalle[$i]['producto']);
    $descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	$imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
	$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
	$codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
	$codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
	$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
	$cantidad        = limpiar($detalle[$i]['cantidad']);
	$preciocompra    = limpiar($detalle[$i]['precio']);
	$precioventa     = limpiar($detalle[$i]['precio2']);
	$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
	$descproducto    = limpiar($detalle[$i]['descproducto']);
	$descuento       = $detalle[$i]['descproducto']/100;
	$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
	$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

	//CALCULO SUBTOTAL IMPUESTOS
	if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
	$subtotalimpuestos = "0.00";
	} else {
	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
	$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
	$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
	$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
    }

    $valorneto   = number_format($valortotal-$totaldescuentov, 2, '.', '');
	$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
	$tipodetalle = limpiar($detalle[$i]['tipodetalle']);
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### REGISTRO DETALLES DE PREVENTA ####################

	################### ACTUALIZO EL ESTADO DE IMEI ###################
	if($detalle[$i]['opcionimei'] == "SI"){

		$valoresArray = explode(',', $detalle[$i]['imei']);
	    $sql = "UPDATE imei SET estadoimei = ?
		WHERE numeroimei IN (".implode(',', $valoresArray).") 
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $estadoimei);
		$estadoimei = "3";
		$stmt->execute();
	}
	################### ACTUALIZO EL ESTADO DE IMEI ###################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);

		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
    	
   } elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
	    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
			." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($detalle[$i]['id'])."' 
	        AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad']);
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
			    $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codpreventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	    	    $stmt->bindParam(15, $procedimiento);	
	            $stmt->bindParam(16, $codsucursal);
		        $stmt->bindParam(17, $codigo);		

			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("PREVENTA (DETALLE DE COMBO): ".$codfactura);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	    	    $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ################### 
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
    } else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("3");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
       }
    }  
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoPreventa"]);
    $this->dbh->commit();
		
    echo "<span class='fa fa-check-square-o'></span> LA PREVENTA DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codpreventa=".encrypt($codpreventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################## FUNCION REGISTRAR PREVENTAS ############################

####################### FUNCION LISTAR PREVENTAS ################################
public function ListarPreventas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente, 
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2,
		preventas.observaciones,
		preventas.fechapreventa, 
		preventas.procesada,  
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,  
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	    WHERE preventas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else if($_SESSION["acceso"] == "vendedor") {

	    $sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente,  
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2,
		preventas.observaciones,
		preventas.fechapreventa,
		preventas.procesada,   
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,  
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE preventas.codigo = '".limpiar($_SESSION["codigo"])."' 
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
	    return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente, 
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2,
		preventas.observaciones,
		preventas.fechapreventa,
		preventas.procesada,   
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,  
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE preventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR PREVENTAS ############################

####################### FUNCION LISTAR CLIENTES CON PREVENTAS ################################
public function ListarClientesxPreventas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente,  
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2, 
		preventas.observaciones,
		preventas.fechapreventa,
		preventas.procesada,   
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		provincias.provincia,
		departamentos.departamento,
		provincias2.provincia AS provincia2,
		departamentos2.departamento AS departamento2,  
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		INNER JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
		LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else if($_SESSION["acceso"] == "vendedor") {

	    $sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente,  
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2,
		preventas.observaciones,
		preventas.fechapreventa,
		preventas.procesada,   
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		provincias.provincia,
		departamentos.departamento,
		provincias2.provincia AS provincia2,
		departamentos2.departamento AS departamento2,  
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		INNER JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
		LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE preventas.codigo = '".limpiar($_SESSION["codigo"])."' 
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
	   return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT 
		preventas.idpreventa, 
		preventas.codpreventa,
		preventas.tipodocumento,
		preventas.codfactura, 
		preventas.codcliente,  
		preventas.exonerado,  
		preventas.subtotal,
		preventas.subtotalexento, 
		preventas.subtotaliva, 
		preventas.iva, 
		preventas.totaliva, 
		preventas.descontado, 
		preventas.descuento, 
		preventas.totaldescuento, 
		preventas.totalpago,
		preventas.totalpago2, 
		preventas.observaciones,
		preventas.fechapreventa,
		preventas.procesada,   
		preventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		provincias.provincia,
		departamentos.departamento,
		provincias2.provincia AS provincia2,
		departamentos2.departamento AS departamento2, 
		SUM(detallepreventas.cantidad) AS articulos 
		FROM (preventas LEFT JOIN detallepreventas ON detallepreventas.codpreventa = preventas.codpreventa) 
		LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
		LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		INNER JOIN clientes ON preventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
		LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
		LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo 
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE preventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY preventas.codpreventa 
		ORDER BY preventas.codpreventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR CLIENTES CON PREVENTAS ############################

############################ FUNCION ID PREVENTAS #################################
public function PreventasPorId()
{
	self::SetNames();
	$sql = " SELECT 
	preventas.idpreventa, 
	preventas.codpreventa,
	preventas.tipodocumento,
	preventas.codfactura, 
	preventas.codcliente,  
	preventas.exonerado,  
	preventas.subtotal,
	preventas.subtotalexento, 
	preventas.subtotaliva, 
	preventas.iva, 
	preventas.totaliva, 
	preventas.descontado, 
	preventas.descuento, 
	preventas.totaldescuento, 
	preventas.totalpago,
	preventas.totalpago2,
    preventas.observaciones,
	preventas.fechapreventa,
	preventas.procesada,  
	preventas.codsucursal,
	sucursales.membrete, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	pag.articulos
	FROM (preventas INNER JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   codpreventa,
	   SUM(detallepreventas.cantidad) AS articulos
	   FROM detallepreventas
	   WHERE detallepreventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detallepreventas.codpreventa) pag ON pag.codpreventa = preventas.codpreventa

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE preventas.codpreventa = ? AND preventas.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpreventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID PREVENTAS #################################
	
######################## FUNCION VER DETALLES PREVENTAS ############################
public function VerDetallesPreventas()
{
	self::SetNames();
	$sql = "SELECT
	detallepreventas.coddetallepreventa,
	detallepreventas.codpreventa,
	detallepreventas.coddetallepreventa,
	detallepreventas.idproducto,
	detallepreventas.codproducto,
	detallepreventas.producto,
	detallepreventas.descripcion,
	detallepreventas.imei,
	detallepreventas.condicion,
	detallepreventas.codmarca,
	detallepreventas.codmodelo,
	detallepreventas.codpresentacion,
	detallepreventas.codcolor,
	detallepreventas.cantidad,
	detallepreventas.preciocompra,
	detallepreventas.precioventa,
	detallepreventas.posicionimpuesto,
	detallepreventas.tipoimpuesto,
	detallepreventas.ivaproducto,
	detallepreventas.descproducto,
	detallepreventas.valortotal, 
	detallepreventas.totaldescuentov,
	detallepreventas.subtotalimpuestos,
	detallepreventas.valorneto,
	detallepreventas.valorneto2,
	detallepreventas.tipodetalle,
	detallepreventas.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallepreventas 
	LEFT JOIN marcas ON detallepreventas.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallepreventas.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detallepreventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallepreventas.codcolor = colores.codcolor 
	WHERE detallepreventas.codpreventa = ? AND detallepreventas.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpreventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
##################### FUNCION VER DETALLES PREVENTAS #########################

######################## FUNCION ACTUALIZAR PREVENTAS #######################
public function ActualizarPreventas()
{
	self::SetNames();
	if(empty($_POST["codpreventa"]) or empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]))
	{
		echo "1";
		exit;
	}

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    for($i=0;$i<count($_POST['coddetallepreventa']);$i++){  //recorro el array
        if (!empty($_POST['coddetallepreventa'][$i])) {

	        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

		        echo "2";
		        exit();
	        }
        }
    }

	$this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['coddetallepreventa']);$i++){  //recorro el array
	if (!empty($_POST['coddetallepreventa'][$i])) {

	$sql = "SELECT 
	cantidad 
	FROM detallepreventas 
	WHERE coddetallepreventa = '".limpiar($_POST['coddetallepreventa'][$i])."' 
	AND codpreventa = '".limpiar(decrypt($_POST["codpreventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
		
		$cantidadBD = $row['cantidad'];

		if($cantidadBD != $_POST['cantidad'][$i]){

		if($_POST['tipodetalle'][$i] == 1){//SI EL DETALLE ES UN PRODUCTO

			############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN ############
		    $sql = "SELECT 
		    existencia 
		    FROM productos 
		    WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$existenciaBD  = $row['existencia'];
			$cantidad      = $_POST["cantidad"][$i];
			$cantidadBD    = $_POST["cantidadbd"][$i];
		    $totalpreventa = number_format($cantidad - $cantidadBD, 2, '.', '');
			############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN ############

		    ############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN ##############
			$sql2 = " UPDATE productos set "
			." existencia = ? "
			." WHERE "
			." idproducto = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->bindParam(1, $existencia);
			$existencia = number_format($existenciaBD - $totalpreventa, 2, '.', '');
			$stmt->execute();
		    ############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN ##############

		    ############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###############
			$sql3 = " UPDATE kardex set "
			." salidas = ?, "
			." stockactual = ? "
			." WHERE "
			." codproceso = '".limpiar($_POST["codpreventa"])."' 
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 1
			AND procedimiento = 1;
			";
			$stmt = $this->dbh->prepare($sql3);
			$stmt->bindParam(1, $salidas);
			$stmt->bindParam(2, $existencia);
			
			$salidas = limpiar($_POST["cantidad"][$i]);
			$existencia = number_format($existenciaBD - $totalpreventa, 2, '.', '');
			$stmt->execute();
			############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###############

	   } elseif(limpiar($_POST['tipodetalle'][$i]) == 2){ // SI EL DETALLE ES UN COMBO

	        ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
	    	$sql = "SELECT 
	    	existencia 
	    	FROM combos 
	    	WHERE idcombo = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codcombo = '".limpiar($_POST["codproducto"][$i])."'
	    	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
	    	{
	    		$this->p[] = $row;
	    	}
	    	$existenciaBD  = $row['existencia'];
			$cantidad      = $_POST["cantidad"][$i];
			$cantidadBD    = $_POST["cantidadbd"][$i];
		    $totalpreventa = number_format($cantidad - $cantidadBD, 2, '.', '');
	        ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

		    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
			$sql = " UPDATE combos set "
		    ." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codcombo = '".limpiar($_POST["codproducto"][$i])."'
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);

			$existencia = number_format($existenciaBD - $totalpreventa, 2, '.', '');
			$stmt->execute();
			##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

			############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############
			$sql3 = " UPDATE kardex set "
			." salidas = ?, "
			." stockactual = ? "
			." WHERE "
			." codproceso = '".limpiar($_POST["codpreventa"])."' 
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 2
			AND procedimiento = 2;
			";
			$stmt = $this->dbh->prepare($sql3);
			$stmt->bindParam(1, $salidas);
			$stmt->bindParam(2, $existencia);
			
			$salidas = limpiar($_POST["cantidad"][$i]);
			$existencia = number_format($existenciaBD - $totalpreventa, 2, '.', '');
			$stmt->execute();
			############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############	
	    }

		################### ACTUALIZO DETALLES DE PREVENTA ####################
		$query = "UPDATE detallepreventas set"
		." cantidad = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
	    ." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." coddetallepreventa = ? AND codpreventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $valortotal);
		$stmt->bindParam(3, $totaldescuentov);
	    $stmt->bindParam(4, $subtotalimpuestos);
		$stmt->bindParam(5, $valorneto);
		$stmt->bindParam(6, $valorneto2);
		$stmt->bindParam(7, $coddetallepreventa);
		$stmt->bindParam(8, $codpreventa);
		$stmt->bindParam(9, $codsucursal);

		$cantidad           = limpiar($_POST['cantidad'][$i]);
		$preciocompra       = limpiar($_POST['preciocompra'][$i]);
		$precioventa        = limpiar($_POST['precioventa'][$i]);
		$ivaproducto        = limpiar($_POST['ivaproducto'][$i]);
		$descuento          = $_POST['descproducto'][$i]/100;
		$valortotal         = number_format($_POST['valortotal'][$i], 2, '.', '');
		$totaldescuento     = number_format($_POST['totaldescuentov'][$i], 2, '.', '');
	    $subtotalimpuestos  = number_format($_POST['subtotalimpuestos'][$i], 0, '.', '');
		$valorneto          = number_format($_POST['valorneto'][$i], 2, '.', '');
		$valorneto2         = number_format($_POST['valorneto2'][$i], 2, '.', '');
		$coddetallepreventa = limpiar($_POST['coddetallepreventa'][$i]);
		$codpreventa        = limpiar(decrypt($_POST["codpreventa"]));
		$codsucursal        = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### ACTUALIZO DETALLES DE PREVENTA ####################

		} else {

                echo "";
	        }
        }
    }
    $this->dbh->commit();

    ################### ACTUALIZO PREVENTA ####################
	$sql = "UPDATE preventas SET "
	." tipodocumento = ?, "
	." codcliente = ?, "
	." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2= ?, "
	." observaciones = ? "
	." WHERE "
	." codpreventa = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codcliente);
	$stmt->bindParam(3, $exonerado);
	$stmt->bindParam(4, $subtotal);
	$stmt->bindParam(5, $subtotalexento);
	$stmt->bindParam(6, $subtotaliva);
	$stmt->bindParam(7, $totaliva);
	$stmt->bindParam(8, $descontado);
	$stmt->bindParam(9, $descuento);
	$stmt->bindParam(10, $totaldescuento);
	$stmt->bindParam(11, $totalpago);
	$stmt->bindParam(12, $totalpago2);
	$stmt->bindParam(13, $observaciones);
	$stmt->bindParam(14, $codpreventa);
	$stmt->bindParam(15, $codsucursal);

	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = number_format($_POST["txtsubtotal"], 2, '.', '');
	$subtotalexento  = number_format($_POST["txtexento"], 2, '.', '');
	$subtotaliva     = number_format($_POST["txtsubtotaliva"], 2, '.', '');
	$totaliva        = number_format($_POST["txtIva"], 2, '.', '');
	$descontado      = number_format($_POST["txtdescontado"], 2, '.', '');
	$descuento       = limpiar($_POST["descuento"]);
    $totaldescuento  = number_format($_POST["txtDescuento"], 2, '.', '');
    $totalpago       = number_format($_POST["txtTotal"], 2, '.', '');
    $totalpago2      = number_format($_POST["txtTotalCompra"], 2, '.', '');
	$observaciones   = limpiar($_POST["observaciones"]);
	$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### ACTUALIZO PREVENTA ####################

	echo "<span class='fa fa-check-square-o'></span> LA PREVENTA DE PRODUCTOS HA SIDO ACTUALIZADA EXITOSAMENTE";
	echo "<script>VentanaCentrada('reportepdf?codpreventa=".encrypt($codpreventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
####################### FUNCION ACTUALIZAR PREVENTAS ############################

####################### FUNCION AGREGAR DETALLES PREVENTAS ########################
public function AgregarDetallesPreventas()
{
	self::SetNames();
	if(empty($_POST["codpreventa"]) or empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]))
	{
		echo "1";
		exit;
	}
    elseif(empty($_SESSION["CarritoPreventa"]) || $_POST["txtTotal"]=="0.00")
	{
		echo "2";
		exit;
	}

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$v = $_SESSION["CarritoPreventa"];
    for ($i = 0, $iMax = count($v); $i < $iMax; $i++) {

		if(limpiar($v[$i]['tipodetalle'])==1){

			$sql = "SELECT 
			existencia 
			FROM productos 
			WHERE idproducto = '".limpiar($v[$i]['id'])."' 
			AND codproducto = '".limpiar($v[$i]['txtCodigo'])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			
			$existenciaBD = $row['existencia'];
			$cantidad     = $v[$i]['cantidad'];

			if ($cantidad > $existenciaBD) 
			{ 
				echo "3";
				exit;
			}

		} elseif(limpiar($v[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

			$sql = "SELECT 
		    existencia 
		    FROM combos 
		    WHERE idcombo = '".limpiar($v[$i]['id'])."' 
			AND codcombo = '".limpiar($v[$i]['txtCodigo'])."'
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			    $this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $v[$i]['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "4";
		        exit;
	        }

		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($v[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia
	        	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($v[$i]['txtCodigo'])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	    AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD  = $row['cantidad'];
				    $idproductoBD  = $row['idproducto'];
				    $codproductoBD = $row['codproducto'];
				    $existenciaBD  = $row['existencia'];
			        $racion        = number_format($cantracionBD*$v[$i]['cantidad'], 2, '.', '');

			        if ($racion > $existenciabd2) 
			        { 
			        	echo "5";
			        	exit;
			        }
			    }
		    }//fin de consulta de productos de combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    codcliente
    FROM clientes
    WHERE dnicliente = ?
    AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
	$codcliente = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ############ CONSULTO TOTAL ACTUAL DE PREVENTA ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM preventas 
	WHERE codpreventa = '".limpiar(decrypt($_POST["codpreventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row["codfactura"];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row["descuento"];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE PREVENTA ##############
   
    $this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoPreventa"];
	for($i=0;$i<count($detalle);$i++){

	$sql = "SELECT 
	codpreventa, 
	codproducto 
	FROM detallepreventas 
	WHERE codpreventa = '".limpiar(decrypt($_POST['codpreventa']))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0)
	{
        ################### REGISTRO DETALLES DE PREVENTA ####################
        $query = "INSERT INTO detallepreventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
		$stmt->bindParam(17, $ivaproducto);
		$stmt->bindParam(18, $descproducto);
		$stmt->bindParam(19, $valortotal);
		$stmt->bindParam(20, $totaldescuentov);
		$stmt->bindParam(21, $subtotalimpuestos);
		$stmt->bindParam(22, $valorneto);
		$stmt->bindParam(23, $valorneto2);
		$stmt->bindParam(24, $tipodetalle);
		$stmt->bindParam(25, $codsucursal);
			
		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
	    $codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	    $imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
		$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
	    $codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
	    $codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
	    $codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

	    //CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	    $SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto   = number_format($valortotal-$totaldescuentov, 2, '.', '');
		$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
		$tipodetalle = limpiar($detalle[$i]['tipodetalle']);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE PREVENTA ####################

		################### ACTUALIZO EL ESTADO DE IMEI ###################
		if($detalle[$i]['opcionimei'] == "SI"){

			$valoresArray = explode(',', $detalle[$i]['imei']);
		    $sql = "UPDATE imei SET estadoimei = ?
			WHERE numeroimei IN (".implode(',', $valoresArray).") 
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $estadoimei);
			$estadoimei = "3";
			$stmt->execute();
		}
		################### ACTUALIZO EL ESTADO DE IMEI ###################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad = limpiar($detalle[$i]['cantidad']);
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

	} elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
	    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
		." existencia = ? "
		." WHERE "
		." idcombo = '".limpiar($detalle[$i]['id'])."' 
	    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	    ";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codpreventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	            $stmt->bindParam(15, $procedimiento);
	            $stmt->bindParam(16, $codsucursal);	
		        $stmt->bindParam(17, $codigo);	

			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("PREVENTA (DETALLE DE COMBO): ".$codfacturaBD);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	            $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
   } else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("3");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
    }
		
	} else {

	  	$sql = "SELECT cantidad 
	  	FROM detallepreventas 
	  	WHERE codpreventa = '".limpiar(decrypt($_POST['codpreventa']))."' 
	  	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	  	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$cantidad = $row['cantidad'];

	  	################### ACTUALIZO DETALLES DE COTIZACION ####################
	  	$query = "UPDATE detallepreventas set"
		." cantidad = ?, "
		." descproducto = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." codpreventa = ? AND codsucursal = ? AND idproducto = ? AND codproducto = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $descproducto);
		$stmt->bindParam(3, $valortotal);
		$stmt->bindParam(4, $totaldescuentov);
		$stmt->bindParam(5, $subtotalimpuestos);
		$stmt->bindParam(6, $valorneto);
		$stmt->bindParam(7, $valorneto2);
		$stmt->bindParam(8, $codpreventa);
		$stmt->bindParam(9, $codsucursal);
		$stmt->bindParam(10, $idproducto);
		$stmt->bindParam(11, $codproducto);

		$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidad);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2'] * $cantidad, 2, '.', '');
		$totaldescuentov = number_format($valortotal * $descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
		$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

		$valorneto   = number_format($valortotal - $totaldescuentov, 2, '.', '');
		$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$cantidad, 2, '.', ''));
		$codpreventa = limpiar(decrypt($_POST["codpreventa"]));
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$idproducto  = limpiar($detalle[$i]['id']);
		$codproducto = limpiar($detalle[$i]['txtCodigo']);
		$stmt->execute();
		################### ACTUALIZO DETALLES DE COTIZACION ####################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."' 
	    AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);

		$cantidad   = limpiar($detalle[$i]['cantidad']);
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

	} elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
	    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
		." existencia = ? "
		." WHERE "
		." idcombo = '".limpiar($detalle[$i]['id'])."' 
	    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	    ";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codpreventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	            $stmt->bindParam(15, $procedimiento);
	            $stmt->bindParam(16, $codsucursal);
		        $stmt->bindParam(17, $codigo);		

			    $codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("PREVENTA (DETALLE DE COMBO): ".$codfacturaBD);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	            $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ################### 
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
    } else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codpreventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codpreventa     = limpiar(decrypt($_POST["codpreventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("PREVENTA: ".$codfacturaBD);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############

            }
	    }
    }    
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
    unset($_SESSION["CarritoPreventa"]);
    $this->dbh->commit();

    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallepreventas WHERE codpreventa = '".limpiar(decrypt($_POST["codpreventa"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
     	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallepreventas WHERE codpreventa = '".limpiar(decrypt($_POST["codpreventa"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ############ ACTUALIZO LOS TOTALES EN LA PREVENTA ##############
	$sql = " UPDATE preventas SET "
	." tipodocumento = ?, "
    ." codcliente = ?, "
    ." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
    ." totalpago2 = ?, "
    ." observaciones = ? "
    ." WHERE "
    ." codpreventa = ? AND codsucursal = ?;
    ";
    $stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $tipodocumento);
    $stmt->bindParam(2, $codcliente);
    $stmt->bindParam(3, $exonerado);
	$stmt->bindParam(4, $TxtSubtotal);
	$stmt->bindParam(5, $TxtSubtotalExento);
	$stmt->bindParam(6, $TxtSubtotalIva);
	$stmt->bindParam(7, $TxtTotalIva);
	$stmt->bindParam(8, $TxtDescontado);
	$stmt->bindParam(9, $descuento);
	$stmt->bindParam(10, $TxtTotalDescuento);
	$stmt->bindParam(11, $TxtTotal);
    $stmt->bindParam(12, $totalpago2);
    $stmt->bindParam(13, $observaciones);
    $stmt->bindParam(14, $codpreventa);
    $stmt->bindParam(15, $codsucursal);

    $tipodocumento   = limpiar($_POST["tipodocumento"]);
    $exonerado       = limpiar($_POST["exonerado"]);

    /*###################################################### CALCULO DE DESCUENTO ######################################################*/
    //PORCENTAJE DESCUENTO
	$descuento         = $_POST["descuento"]+$descuentoBD;
	$Porcentaje        = $descuento/100;

	//PORCENTAJE IVA
	$txtIva            = $ivaBD;
	$PorcentajeIva     = $txtIva/100;

	/*OBTENGO DESCUENTO DE EXENTO*/
	$RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	$TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	/*OBTENGO SUBTOTAL IVA*/
	$RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	/*OBTENGO TOTAL IVA*/
	$TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	//CALCULO DE TOTAL FACTURA
	$TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	$TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	$TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	$TxtTotal          = ($_POST["exonerado"] == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	$totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	/*###################################################### CALCULO DE DESCUENTO ######################################################*/

    $observaciones = limpiar($_POST["observaciones"]);
	$codpreventa = limpiar(decrypt($_POST["codpreventa"]));
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	############ ACTUALIZO LOS TOTALES EN LA PREVENTA ##############

    echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS A LA PREVENTA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codpreventa=".encrypt($codpreventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
######################### FUNCION AGREGAR DETALLES PREVENTAS #######################

######################## FUNCION ELIMINAR DETALLES PREVENTAS #######################
public function EliminarDetallesPreventas()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

    ############ CONSULTO DATOS DE PREVENTAS ##############
	$sql = "SELECT
	codfactura,
	codcliente, 
	exonerado,
	iva,
	descuento,
	totalpago
	FROM preventas 
	WHERE codpreventa = '".limpiar(decrypt($_GET["codpreventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$codclienteBD = $row['codcliente'];
	$exoneradoBD  = $row['exonerado'];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row["descuento"];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO DATOS DE PREVENTAS ##############

	$sql = "SELECT * FROM detallepreventas WHERE codpreventa = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpreventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		$sql = "SELECT
		idproducto, 
		codproducto,
		imei, 
		cantidad, 
		precioventa,
		posicionimpuesto,
		tipoimpuesto,  
		ivaproducto, 
		descproducto, 
		tipodetalle 
		FROM detallepreventas WHERE coddetallepreventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["coddetallepreventa"]),decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$imeiBD         = $row['imei'];
		$cantidadBD     = $row['cantidad'];
		$precioventaBD  = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];
		$tipodetalleBD  = $row['tipodetalle'];

		if(limpiar($tipodetalleBD) == 1){// SSI EL DETALLE ES UN PRODCUTO

			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql = "UPDATE productos SET "
			." existencia = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $codsucursal);

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);
	        $stmt->bindParam(15, $procedimiento);	
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("1");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			################### ACTUALIZO EL ESTADO DE IMEI ###################
			if($imeiBD != ""){

				$valoresArray = explode(',', $imeiBD);
			    $sql = "UPDATE imei SET estadoimei = ?
				WHERE numeroimei IN (".implode(',', $valoresArray).") 
				AND codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."';";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $estadoimei);
				$estadoimei = "1";
				$stmt->execute();
			}
			################### ACTUALIZO EL ESTADO DE IMEI ###################

		} elseif(limpiar($tipodetalleBD) == 2){ // SI EL DETALLE ES UN COMBO

			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql2 = "SELECT existencia FROM combos WHERE idcombo = ? AND codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################	

			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############
			$sql = "UPDATE combos SET "
			." existencia = ? "
			." WHERE "
			." idcombo = ? AND codcombo = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);	
			$stmt->bindParam(4, $codsucursal);	

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);
	        $stmt->bindParam(15, $procedimiento);	
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = limpiar($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("2");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($codproductoBD),decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia,
	        	productos.precioxpublico AS precioventa,
	        	productos.ivaproducto,
	        	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($codproductoBD)."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2    = $row['cantidad'];
					$idproductoBD2    = $row['idproducto'];
			        $codproductoBD2   = $row['codproducto'];
					$existenciaBD2    = $row['existencia'];
					$precioventaBD2   = $row['precioventa'];
			        $nomimpuestoBD2   = $row['nomimpuesto'];
			        $valorimpuestoBD2 = $row['valorimpuesto'];
					$ivaproductoBD2   = $row['ivaproducto'];
					$descproductoBD2  = $row['descproducto'];

					############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
					$update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
				    $stmt->bindParam(2, $idproducto);
				    $stmt->bindParam(3, $codproducto);
		            $stmt->bindParam(4, $codsucursal);

					$racion         = number_format($cantracionBD2*$cantidadBD, 2, '.', '');
					$cantidadracion = number_format($existenciaBD2+$racion, 2, '.', '');
		            $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
					$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
					$stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

					########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
					$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
					$stmt = $this->dbh->prepare($query);
					$stmt->bindParam(1, $codpreventa);
					$stmt->bindParam(2, $codresponsable);
					$stmt->bindParam(3, $codproducto);
					$stmt->bindParam(4, $movimiento);
					$stmt->bindParam(5, $entradas);
					$stmt->bindParam(6, $salidas);
					$stmt->bindParam(7, $devolucion);
					$stmt->bindParam(8, $stockactual);
					$stmt->bindParam(9, $ivaproducto);
					$stmt->bindParam(10, $descproducto);
					$stmt->bindParam(11, $precio);
					$stmt->bindParam(12, $documento);
					$stmt->bindParam(13, $fechakardex);	
					$stmt->bindParam(14, $tipokardex);
	                $stmt->bindParam(15, $procedimiento);	
					$stmt->bindParam(16, $codsucursal);
		            $stmt->bindParam(17, $codigo);

					$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
					$codresponsable = limpiar($codclienteBD);
					$codproducto    = limpiar($codproductoBD2);
					$movimiento     = limpiar("DEVOLUCION");
					$entradas       = limpiar("0.00");
					$salidas        = limpiar("0.00");
					$devolucion     = number_format($racion, 2, '.', '');
					$stockactual    = number_format($existenciaBD2+$racion, 2, '.', '');
					$ivaproducto    = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
					$descproducto   = number_format($descproductoBD2, 2, '.', '');
					$precio         = number_format($precioventaBD2, 2, '.', '');
					$documento      = limpiar("DEVOLUCION PREVENTA (DETALLE DE COMBO): ".$codfacturaBD);
					$fechakardex    = limpiar(date("Y-m-d H:i:s"));
					$tipokardex     = limpiar("1");
	                $procedimiento  = limpiar("2");
					$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	            $codigo         = limpiar($_SESSION["codigo"]);
					$stmt->execute();
				    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########   
			    }
		    }//fin de consulta de productos en combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

		} else { // SI EL DETALLE ES UN SERVICIO

			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
		    $codproducto    = limpiar($codproductoDB);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = limpiar("0.00");
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("3");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
		}
	   
		################## ELIMINO DETALLE DE PREVENTA ##################
		$sql = "DELETE FROM detallepreventas WHERE coddetallepreventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetallepreventa);
		$stmt->bindParam(2,$codsucursal);

		$coddetallepreventa = decrypt($_GET["coddetallepreventa"]);
		$codsucursal        = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE PREVENTA ##################

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallepreventas WHERE codpreventa = '".limpiar(decrypt($_GET["codpreventa"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallepreventas WHERE codpreventa = '".limpiar(decrypt($_GET["codpreventa"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

        ################### ACTUALIZO LA PREVENTA ####################
		$sql = " UPDATE preventas SET "
		." subtotal = ?, "
	    ." subtotalexento = ?, "
	    ." subtotaliva = ?, "
	    ." totaliva = ?, "
	    ." descontado = ?, "
	    ." totaldescuento = ?, "
	    ." totalpago = ?, "
	    ." totalpago2= ? "
		." WHERE "
		." codpreventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $TxtTotal);
	    $stmt->bindParam(8, $totalpago2);
		$stmt->bindParam(9, $codpreventa);
		$stmt->bindParam(10, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento         = $descuentoBD;
	    $Porcentaje        = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva            = $ivaBD;
	    $PorcentajeIva     = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $TxtTotal          = ($exoneradoBD == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/

		$codpreventa       = limpiar(decrypt($_GET["codpreventa"]));
		$codsucursal       = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		################### ACTUALIZO LA PREVENTA ####################

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
################### FUNCION ELIMINAR DETALLES PREVENTAS #####################

####################### FUNCION ELIMINAR PREVENTAS #################################
public function EliminarPreventas()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS") {

    ############ CONSULTO DATOS DE TRASPASO ##############
	$sql = "SELECT * FROM preventas 
	WHERE codpreventa = '".limpiar(decrypt($_GET["codpreventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row['codfactura'];
	$codclienteBD = $row['codcliente'];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO DATOS DE TRASPASO ##############

    $sql = "SELECT * FROM detallepreventas 
    WHERE codpreventa = '".limpiar(decrypt($_GET["codpreventa"]))."' 
    AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;

		$idproductoBD   = $row['idproducto'];
		$codproductoBD  = $row['codproducto'];
		$imeiBD         = $row['imei'];
		$cantidadBD     = $row['cantidad'];
		$precioventaBD  = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD = $row['tipoimpuesto'];
		$ivaproductoBD  = $row['ivaproducto'];
		$descproductoBD = $row['descproducto'];
		$tipodetalleBD  = $row['tipodetalle'];

		if(limpiar($tipodetalleBD) == 1){// SSI EL DETALLE ES UN PRODCUTO

			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql = "UPDATE productos SET "
			." existencia = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $codsucursal);

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("1");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			################### ACTUALIZO EL ESTADO DE IMEI ###################
			if($imeiBD != ""){

				$valoresArray = explode(',', $imeiBD);
			    $sql = "UPDATE imei SET estadoimei = ?
				WHERE numeroimei IN (".implode(',', $valoresArray).") 
				AND codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."';";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $estadoimei);
				$estadoimei = "1";
				$stmt->execute();
			}
			################### ACTUALIZO EL ESTADO DE IMEI ###################

		} elseif(limpiar($tipodetalleBD) == 2){ // SI EL DETALLE ES UN COMBO

			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql2 = "SELECT existencia FROM combos WHERE idcombo = ? AND codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################	

			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############
			$sql = "UPDATE combos SET "
			." existencia = ? "
			." WHERE "
			." idcombo = ? AND codcombo = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);	
			$stmt->bindParam(4, $codsucursal);	

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);	
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = limpiar($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("2");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($codproductoBD),decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia,
	        	productos.precioxpublico AS precioventa,
	        	productos.ivaproducto,
	        	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($codproductoBD)."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2    = $row['cantidad'];
				    $idproductoBD2    = $row['idproducto'];
			        $codproductoBD2   = $row['codproducto'];
				    $existenciaBD2    = $row['existencia'];
				    $precioventaBD2   = $row['precioventa'];
			        $nomimpuestoBD2   = $row['nomimpuesto'];
			        $valorimpuestoBD2 = $row['valorimpuesto'];
				    $ivaproductoBD2   = $row['ivaproducto'];
				    $descproductoBD2  = $row['descproducto'];

				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
				    $update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
				    $stmt->bindParam(2, $idproducto);
				    $stmt->bindParam(3, $codproducto);
		            $stmt->bindParam(4, $codsucursal);

				    $racion         = number_format($cantracionBD2*$cantidadBD, 2, '.', '');
				    $cantidadracion = number_format($existenciaBD2+$racion, 2, '.', '');
		            $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
		            $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
				    $stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

				    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
				    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				    $stmt = $this->dbh->prepare($query);
				    $stmt->bindParam(1, $codpreventa);
				    $stmt->bindParam(2, $codresponsable);
				    $stmt->bindParam(3, $codproducto);
				    $stmt->bindParam(4, $movimiento);
				    $stmt->bindParam(5, $entradas);
				    $stmt->bindParam(6, $salidas);
				    $stmt->bindParam(7, $devolucion);
				    $stmt->bindParam(8, $stockactual);
				    $stmt->bindParam(9, $ivaproducto);
				    $stmt->bindParam(10, $descproducto);
				    $stmt->bindParam(11, $precio);
				    $stmt->bindParam(12, $documento);
				    $stmt->bindParam(13, $fechakardex);	
				    $stmt->bindParam(14, $tipokardex);	
	                $stmt->bindParam(15, $procedimiento);	
				    $stmt->bindParam(16, $codsucursal);
		            $stmt->bindParam(17, $codigo);

				    $codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
				    $codresponsable = limpiar($codclienteBD);
			        $codproducto    = limpiar($codproductoBD2);
				    $movimiento     = limpiar("DEVOLUCION");
				    $entradas       = limpiar("0.00");
				    $salidas        = limpiar("0.00");
				    $devolucion     = number_format($racion, 2, '.', '');
				    $stockactual    = number_format($existenciaBD2+$racion, 2, '.', '');
				    $ivaproducto    = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
				    $descproducto   = number_format($descproductoBD2, 2, '.', '');
				    $precio         = number_format($precioventaBD2, 2, '.', '');
				    $documento      = limpiar("DEVOLUCION PREVENTA (DETALLE DE COMBO): ".$codfacturaBD);
				    $fechakardex    = limpiar(date("Y-m-d H:i:s"));
				    $tipokardex     = limpiar("1");
	                $procedimiento  = limpiar("2");
				    $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	            $codigo         = limpiar($_SESSION["codigo"]);
				    $stmt->execute();
			        ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			    }
		    }//fin de consulta de productos en combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

	    } else { // SI EL DETALLE ES UN SERVICIO

	    	########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codpreventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);		
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codpreventa    = limpiar(decrypt($_GET["codpreventa"]));
			$codresponsable = limpiar($codclienteBD);
		    $codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = limpiar("0.00");
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION PREVENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("3");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
	    }
	}

		################## ELIMINO PREVENTA ##################
	    $sql = "DELETE FROM preventas WHERE codpreventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpreventa);
		$stmt->bindParam(2,$codsucursal);
		$codpreventa = decrypt($_GET["codpreventa"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO PREVENTA ##################

		################## ELIMINO DETALLE DE PREVENTA ##################
		$sql = "DELETE FROM detallepreventas WHERE codpreventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpreventa);
		$stmt->bindParam(2,$codsucursal);
		$codpreventa = decrypt($_GET["codpreventa"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE PREVENTA ##################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
###################### FUNCION ELIMINAR PREVENTAS #################################

####################### FUNCION PROCESAR PREVENTAS A VENTA #################################
public function ProcesarPreventas()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

    if(empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]) or empty($_POST["tipopago"]))
	{
		echo "2";
		exit;
	}
	elseif(limpiar($_POST["txtTotal"]=="") && limpiar($_POST["txtTotal"]==0) && limpiar($_POST["txtTotal"]==0.00))
	{
		echo "3";
		exit;
	}

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    
    LEFT JOIN
       (SELECT
       codcliente, montocredito       
       FROM creditosxclientes 
       WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."') pag ON pag.codcliente = clientes.codcliente
       WHERE clientes.dnicliente = ? 
       AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono"]) ? "" : $_POST["formaabono"]);
    $montoabono        = (empty($_POST["montoabono"]) ? "0.00" : $_POST["montoabono"]);
    $total             = number_format($_POST["txtTotal"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################
    if (limpiar($_POST["tipopago"]) == "CREDITO") {

    	$fechaactual = date("Y-m-d");
		$fechavence  = date("Y-m-d",strtotime($_POST['fechavencecredito']));

		if ($codcliente == '0') { 

            echo "4";
            exit;

        } else if (strtotime($fechavence) < strtotime($fechaactual)) {

			echo "5";
			exit;

		} else if ($montoabono != "0.00" && $medioabono == "") {
  
            echo "6";
	        exit;

		} else if ($limitecredito != "0.00" && $total > $creditodisponible) {

            echo "7";
            exit;

        } else if($_POST["montoabono"] >= $_POST["txtTotal"]) { 

	        echo "8";
	        exit;
        }
    }
    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################

    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
    if (limpiar($_POST["tipopago"]) == "CONTADO") {

   	foreach ($_POST['pagos'] as $value)
   	{
		if($value['montopagado'] == "" || $value['montopagado'] == 0.00)	
		{
		    echo "9";
		    exit;
		}
	}

		if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {

	        $formas_pago = array_column($_POST['pagos'], 'codmediopago');
	        if(count($formas_pago) != count(array_unique($formas_pago)))
	   	    {
	   		    echo "10";
				exit;
	        } 
	        else if (count($formas_pago) > 1 && $_POST["txtPagado"] > $_POST["txtTotal"])
	        {
	            echo "11";
	            exit;
	        }

	    } else {

	      	if ($_POST["txtTotal"] > $_POST["txtPagado"])
	        {
	            echo "12";
	            exit;
	        }
	    } 
	}
    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################

	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	codsucursal, 
	nroactividadsucursal,  
	inicioticket,
	iniciofactura, 
	inicioguia, 
	inicionotaventa  
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nroactividad    = $row['nroactividadsucursal'];
	$inicioticket    = $row['inicioticket'];
	$iniciofactura   = $row['iniciofactura'];
	$inicioguia      = $row['inicioguia'];
	$inicionotaventa = $row['inicionotaventa'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE VENTA ####################
	$sql = "SELECT codventa FROM ventas 
	ORDER BY idventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$venta = $row["codventa"];
	}
	if(empty($venta))
	{
		$codventa = "01";

	} else {

		$num = substr($venta, 0);
        $dig = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codventa = $codigofinal;
	}
    ################ CREO CODIGO DE VENTA ###############

    ################### CREO CODIGO DE FACTURA ####################
	if($_POST['tipodocumento'] == "TICKET_5" || $_POST['tipodocumento'] == "TICKET_8" || $_POST['tipodocumento'] == "BOLETA_A4") {

	    $sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'TICKET_5' or tipodocumento = 'TICKET_8' or tipodocumento = 'BOLETA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}
		if(empty($factura)){ 
        	$codfactura = "B".$nroactividad.'-'.$inicioticket;
        } else {
            $var = strlen("B".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "B".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "FACTURA" || $_POST['tipodocumento'] == "FACTURA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'FACTURA' or tipodocumento = 'FACTURA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "F".$nroactividad.'-'.$iniciofactura;
        } else {
            $var = strlen("F".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "F".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "GUIA_REMISION") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE tipodocumento = 'GUIA_REMISION'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "G".$nroactividad.'-'.$inicioguia;
        } else {
            $var = strlen("G".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "G".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "NOTA_VENTA_5" || $_POST['tipodocumento'] == "NOTA_VENTA_8" || $_POST['tipodocumento'] == "NOTA_VENTA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'NOTA_VENTA_5' OR tipodocumento = 'NOTA_VENTA_8' OR tipodocumento = 'NOTA_VENTA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		AND codfactura LIKE 'NV%'
		ORDER BY CAST(SUBSTRING_INDEX(codfactura, '-', -1) AS UNSIGNED) DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}
        if(empty($factura)){ 
        	$codfactura = "NV".$nroactividad.'-'.$inicionotaventa;
        } else {
            $var = strlen("NV".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "NV".$nroactividad.'-'.$var4;
        }
		   $codserie = limpiar($nroactividad);
		   $codautorizacion = limpiar(GenerateRandomStringg());
	}
    ################### CREO CODIGO DE FACTURA ####################

	################### SELECCIONE LOS DATOS DE LA preventa ######################
    $sql = "SELECT * FROM preventas WHERE codpreventa = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST['codpreventa']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    ################### SELECCIONE LOS DATOS DE LA preventa ######################

    $fecha = date("Y-m-d H:i:s");

    ################### REGISTRO LA VENTA ####################
    $query = "INSERT INTO ventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codarqueo);
	$stmt->bindParam(3, $codcaja);
	$stmt->bindParam(4, $codventa);
	$stmt->bindParam(5, $codfactura);
	$stmt->bindParam(6, $codserie);
	$stmt->bindParam(7, $codautorizacion);
	$stmt->bindParam(8, $codcliente);
	$stmt->bindParam(9, $exonerado);
	$stmt->bindParam(10, $subtotal);
	$stmt->bindParam(11, $subtotalexento);
	$stmt->bindParam(12, $subtotaliva);
	$stmt->bindParam(13, $iva);
	$stmt->bindParam(14, $totaliva);
	$stmt->bindParam(15, $descontado);
	$stmt->bindParam(16, $descuento);
	$stmt->bindParam(17, $totaldescuento);
	$stmt->bindParam(18, $totalpago);
	$stmt->bindParam(19, $totalpago2);
	$stmt->bindParam(20, $creditopagado);
	$stmt->bindParam(21, $tipopago);
	$stmt->bindParam(22, $formapago);
	$stmt->bindParam(23, $montopagado);
	$stmt->bindParam(24, $montodevuelto);
	$stmt->bindParam(25, $fechavencecredito);
	$stmt->bindParam(26, $fechapagado);
	$stmt->bindParam(27, $statusventa);
	$stmt->bindParam(28, $fechaventa);
	$stmt->bindParam(29, $observaciones);
	$stmt->bindParam(30, $notacredito);
	$stmt->bindParam(31, $codigo);
	$stmt->bindParam(32, $codsucursal);
   
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$codarqueo       = limpiar($codarqueoBD);
	$codcaja         = limpiar($codcajaBD);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$creditopagado   = limpiar(isset($_POST['montoabono']) ? $_POST["montoabono"] : "0.00");
	$tipopago        = limpiar($_POST["tipopago"]);
	$montopagado     = '0.00';
    if ($_POST['tipopago'] == 'CONTADO') {
        
        if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {
            $formapago    = 'VARIOS';
            $montopagado  = array_reduce($_POST['pagos'], function ($a, $o) {
                return $a + $o['montopagado'];
            });
        }
        else 
        {
            $formapago   = decrypt($_POST['codmediopago']);
            $montopagado = limpiar($_POST['montopagado']);
        }
    }
    else 
    {
        $formapago     = limpiar(decrypt($_POST["formaabono"]) != "" ? decrypt($_POST["formaabono"]) : "CREDITO");
    	$montopagado   = limpiar(decrypt($_POST["formaabono"]) != "" ? $_POST['montoabono'] : "0.00");
    }
    $montodevuelto     = limpiar(isset($_POST['montodevuelto']) ? $_POST["montodevuelto"] : "0.00");
	$fechavencecredito = limpiar($_POST["tipopago"]=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
    $fechapagado       = limpiar("0000-00-00");
    $statusventa       = limpiar($_POST["tipopago"]=="CONTADO" ? "PAGADA" : "PENDIENTE");
    $fechaventa        = limpiar($fecha);
	$observaciones     = limpiar($_POST["observaciones"]);
	$notacredito       = limpiar("0");
	$codigo            = limpiar($row["codigo"]);
	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### REGISTRO LA VENTA ####################

	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################
	if(limpiar($_POST["tipopago"])=="CONTADO"){

	    $sql = "INSERT INTO mediospagoxventas VALUES (NULL, ?, ?, ?, ?, ?, ?)";
	    foreach ($_POST['pagos'] as $pago) {
	        $stmt = $this->dbh->prepare($sql);
	        $stmt->execute([$codarqueoBD, $codcajaBD, $codventa, decrypt($pago['codmediopago']), $pago['montopagado'], $_POST['montodevuelto']]);
	    }
	}
	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################

	################### SELECCIONO DETALLES DE PREVENTA ######################
	$sql = "SELECT * FROM detallepreventas 
	WHERE codpreventa = '".decrypt($_POST['codpreventa'])."' 
	AND codsucursal = '".decrypt($_POST['codsucursal'])."'";
    foreach ($this->dbh->query($sql) as $row2)
	{
	    ################### REGISTRO DETALLES DE VENTA ####################
        $query = "INSERT INTO detalleventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
    	$stmt = $this->dbh->prepare($query);
    	$stmt->bindParam(1, $codventa);
    	$stmt->bindParam(2, $idproducto);
    	$stmt->bindParam(3, $codproducto);
    	$stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
    	$stmt->bindParam(8, $codmarca);
    	$stmt->bindParam(9, $codmodelo);
    	$stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
    	$stmt->bindParam(12, $cantidad);
    	$stmt->bindParam(13, $preciocompra);
    	$stmt->bindParam(14, $precioventa);
	    $stmt->bindParam(15, $posicionimpuesto);
	    $stmt->bindParam(16, $tipoimpuesto);
    	$stmt->bindParam(17, $ivaproducto);
    	$stmt->bindParam(18, $descproducto);
    	$stmt->bindParam(19, $valortotal);
    	$stmt->bindParam(20, $totaldescuentov);
	    $stmt->bindParam(21, $subtotalimpuestos);
    	$stmt->bindParam(22, $valorneto);
    	$stmt->bindParam(23, $valorneto2);
    	$stmt->bindParam(24, $tipodetalle);
    	$stmt->bindParam(25, $codsucursal);

	    $idproducto        = limpiar($row2['idproducto']);
    	$codproducto       = strip_tags($row2['codproducto']);
    	$producto          = strip_tags($row2['producto']);
		$descripcion       = limpiar($row2['descripcion']);
		$imei              = limpiar($row2['imei']);
		$condicion         = limpiar($row2['condicion']);
    	$codmarca          = strip_tags($row2['codmarca']);
    	$codmodelo         = strip_tags($row2['codmodelo']);
    	$codpresentacion   = strip_tags($row2['codpresentacion']);
    	$codcolor          = strip_tags($row2['codcolor']);
    	$cantidad          = limpiar($row2['cantidad']);
    	$preciocompra      = limpiar($row2['preciocompra']);
    	$precioventa       = limpiar($row2['precioventa']);
    	$posicionimpuesto  = limpiar($row2['posicionimpuesto']);
    	$tipoimpuesto      = limpiar($row2['tipoimpuesto']);
    	$ivaproducto       = limpiar($row2['ivaproducto']);
    	$descproducto      = limpiar($row2['descproducto']);
    	$descuento         = $row2['descproducto']/100;
    	$valortotal        = number_format($row2['valortotal'], 2, '.', '');
    	$totaldescuentov   = number_format($row2['totaldescuentov'], 2, '.', '');
    	$subtotalimpuestos = number_format($row2['subtotalimpuestos'], 2, '.', '');
    	$valorneto         = number_format($row2['valorneto'], 2, '.', '');
    	$valorneto2        = number_format($row2['valorneto2'], 2, '.', '');
    	$tipodetalle       = limpiar($row2['tipodetalle']);
    	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
    	$stmt->execute();
    	################### REGISTRO DETALLES DE VENTA ####################
	}

	##################### ACTUALIZO PREVENTA A PROCESADO ####################
	$sql = "UPDATE preventas set "
	." procesada = ? "
	." WHERE "
	." codpreventa = '".limpiar(decrypt($_POST["codpreventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $procesada);

	$procesada = limpiar("2");
	$stmt->execute();
    ##################### ACTUALIZO PREVENTA A PROCESADO ####################

	################ AGREGAMOS EL INGRESO A CONTADO ##############
    if (limpiar($_POST["tipopago"]=="CONTADO")){

		$sql = "UPDATE arqueocaja set "
		." ingresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $codarqueo);

		$txtTotal  = number_format($_POST["txtTotal"]+$ingresoBD, 2, '.', '');
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
    }
    ################ AGREGAMOS EL INGRESO A CONTADO ##############

   ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################
   if (limpiar($_POST["tipopago"]=="CREDITO")) {

		$sql = " UPDATE arqueocaja SET "
		." creditos = ?, "
		." abonos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $totalabono);
		$stmt->bindParam(3, $codarqueo);

		$TotalCredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
		$txtTotal     = number_format($TotalCredito+$creditoBD, 2, '.', '');
		$totalabono   = number_format($_POST["montoabono"]+$abonoBD, 2, '.', '');
		$codarqueo    = limpiar($codarqueoBD);
		$stmt->execute(); 

		$sql = " SELECT codcliente FROM creditosxclientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($codcliente,decrypt($_POST["codsucursal"])));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			$query = "INSERT INTO creditosxclientes values (null, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcliente);
			$stmt->bindParam(2, $montocredito);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();

		} else { 

			$sql = "UPDATE creditosxclientes set"
			." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($montoactual+($_POST["txtTotal"]-$_POST["montoabono"]), 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
		}

		if (limpiar($_POST["montoabono"]!="0.00" && $_POST["montoabono"]!="0" && $_POST["montoabono"]!="")) {
			
			######################### CODIGO DE ABONO #########################
	        $sql = "SELECT 
			codabono 
			FROM abonoscreditosventas 
			ORDER BY idabono 
			DESC LIMIT 1";
			foreach ($this->dbh->query($sql) as $row)
			{
				$num=$row["codabono"];
			}
			$codabono = (empty($num) ? "1" : $num + 1);
            ######################### CODIGO DE ABONO #########################

            ################### CODIGO DE CREDITO ABONO ####################
			$sql4 = "SELECT codcredito FROM abonoscreditosventas 
			WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
			ORDER BY idabono DESC LIMIT 1";
			foreach ($this->dbh->query($sql4) as $row4){

				$id = $row4["codcredito"];
			}
			if(empty($id))
			{
				$codcredito = "0000001";

			} else {

				$var  = strlen("");
		        $var1 = substr($id , $var);
		        $var2 = strlen($var1);
		        $var3 = $var1 + 1;
		        $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
		        $codcredito = $var4;
			}
			################### CODIGO DE CREDITO ABONO ####################

			######################### REGISTRO ABONO DE CREDITO #########################
            $query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codabono);
			$stmt->bindParam(2, $codcredito);
			$stmt->bindParam(3, $codarqueo);
			$stmt->bindParam(4, $codcaja);
			$stmt->bindParam(5, $codventa);
			$stmt->bindParam(6, $codcliente);
			$stmt->bindParam(7, $montoabono);
			$stmt->bindParam(8, $formaabono);
			$stmt->bindParam(9, $codbanco);
			$stmt->bindParam(10, $comprobante);
			$stmt->bindParam(11, $fechaabono);
			$stmt->bindParam(12, $codsucursal);

			$codarqueo   = limpiar($codarqueoBD);
			$codcaja     = limpiar($codcajaBD);
			$montoabono  = number_format($_POST["montoabono"], 2, '.', '');
			$formaabono  = decrypt($_POST["formaabono"]);
			$codbanco    = limpiar("0");
			$comprobante = limpiar("0");
			$fechaabono  = limpiar($fecha);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			######################### REGISTRO ABONO DE CREDITO #########################
		}
	}
	################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################

    echo "<span class='fa fa-check-square-o'></span> LA PREVENTA HA SIDO PROCESADA COMO VENTA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
###################### FUNCION PROCESAR PREVENTAS A VENTAS #################################

###################### FUNCION BUSQUEDA PREVENTAS POR FECHAS ####################
public function BuscarPreventasxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	preventas.idpreventa, 
	preventas.codpreventa,
	preventas.tipodocumento,
	preventas.codfactura,
	preventas.codcliente,
	preventas.exonerado,
	preventas.subtotal,
	preventas.subtotalexento,
	preventas.subtotaliva, 
	preventas.iva,
	preventas.totaliva, 
	preventas.descontado,
	preventas.descuento,
	preventas.totaldescuento, 
	preventas.totalpago, 
	preventas.totalpago2,
	preventas.observaciones,
	preventas.fechapreventa,
	preventas.procesada,
	preventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
	pag.articulos,
	pag.detalles_productos
	FROM (preventas LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento

	LEFT JOIN
	    (SELECT
	    codpreventa,
	    SUM(detallepreventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallepreventas.cantidad, ' | ', 
		 	detallepreventas.producto, ' | ', 
		   	detallepreventas.descripcion, ' | ',
		   	if(detallepreventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallepreventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallepreventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallepreventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallepreventas
			LEFT JOIN marcas ON detallepreventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallepreventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallepreventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallepreventas.codcolor = colores.codcolor
			WHERE detallepreventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallepreventas.codpreventa) pag ON pag.codpreventa = preventas.codpreventa

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE preventas.codsucursal = ? 
	AND DATE_FORMAT(preventas.fechapreventa,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY preventas.codpreventa 
	ORDER BY preventas.codpreventa ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON PREVENTAS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION BUSQUEDA PREVENTAS POR FECHAS ###################

###################### FUNCION BUSQUEDA PREVENTAS POR VENDEDOR ####################
public function BuscarPreventasxVendedor() 
{
	self::SetNames();
	$sql ="SELECT 
	preventas.idpreventa, 
	preventas.codpreventa,
	preventas.tipodocumento,
	preventas.codfactura,
	preventas.codcliente,
	preventas.exonerado,
	preventas.subtotal,
	preventas.subtotalexento,
	preventas.subtotaliva, 
	preventas.iva,
	preventas.totaliva, 
	preventas.descontado,
	preventas.descuento,
	preventas.totaldescuento, 
	preventas.totalpago, 
	preventas.totalpago2,
	preventas.observaciones,
	preventas.fechapreventa,
	preventas.procesada,
	preventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	provincias2.provincia AS provincia2,
	departamentos2.departamento AS departamento2,
    usuarios.dni,
    usuarios.nombres,
	pag.articulos,
	pag.detalles_productos
	FROM (preventas LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON preventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
    LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codpreventa,
	    SUM(detallepreventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detallepreventas.cantidad, ' | ', 
		 	detallepreventas.producto, ' | ', 
		   	detallepreventas.descripcion, ' | ',
		   	if(detallepreventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallepreventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallepreventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallepreventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detallepreventas
			LEFT JOIN marcas ON detallepreventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallepreventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallepreventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallepreventas.codcolor = colores.codcolor
			WHERE detallepreventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detallepreventas.codpreventa) pag ON pag.codpreventa = preventas.codpreventa

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE preventas.codsucursal = ? 
	AND preventas.codigo = ?
	AND DATE_FORMAT(preventas.fechapreventa,'%Y-%m-%d') BETWEEN ? AND ? 
	GROUP BY preventas.codpreventa 
	ORDER BY preventas.codpreventa ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codigo']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON PREVENTAS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
################### FUNCION BUSQUEDA PREVENTAS POR VENDEDOR ###################

###################### FUNCION BUSCAR DETALLES PREVENTAS POR FECHAS #########################
public function BuscarDetallesPreventasxFechas() 
{
	self::SetNames();
    $sql ="SELECT 
    detallepreventas.idproducto,
    detallepreventas.codproducto,
    detallepreventas.producto,
	detallepreventas.descripcion,
	detallepreventas.imei,
	detallepreventas.condicion,
    detallepreventas.codmarca,
    detallepreventas.codmodelo,
    detallepreventas.codpresentacion, 
    detallepreventas.codcolor,
    detallepreventas.precioventa,
	detallepreventas.posicionimpuesto,
	detallepreventas.tipoimpuesto,
    detallepreventas.ivaproducto,
    detallepreventas.descproducto,
    detallepreventas.valortotal,
    detallepreventas.valorneto,
    detallepreventas.tipodetalle, 
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,  
    sucursales.documsucursal, 
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.tlfsucursal,
    sucursales.direcsucursal,
    sucursales.correosucursal,
    sucursales.llevacontabilidad,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    documentos.documento,
    documentos2.documento AS documento2,
    provincias.provincia,
    departamentos.departamento,
    SUM(detallepreventas.cantidad) AS cantidad,
	pag.existencia  
    FROM (detallepreventas LEFT JOIN preventas ON detallepreventas.codpreventa = preventas.codpreventa)   
    LEFT JOIN marcas ON detallepreventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detallepreventas.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detallepreventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallepreventas.codcolor = colores.codcolor
    LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda

    LEFT JOIN
		(SELECT
		idproducto,
		existencia
		FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detallepreventas.idproducto

    WHERE preventas.codsucursal = ? 
    AND DATE_FORMAT(preventas.fechapreventa,'%Y-%m-%d') BETWEEN ? AND ? 
    GROUP BY detallepreventas.codproducto, detallepreventas.producto, detallepreventas.precioventa, detallepreventas.descproducto, detallepreventas.codsucursal
    ORDER BY detallepreventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS PREVENTAS PARA EL RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES PREVENTAS POR FECHAS ###############################

###################### FUNCION BUSCAR DETALLES PREVENTAS POR VENDEDOR #########################
public function BuscarDetallesPreventasxVendedor() 
{
	self::SetNames();
    $sql ="SELECT 
    detallepreventas.idproducto,
    detallepreventas.codproducto,
    detallepreventas.producto,
	detallepreventas.descripcion,
	detallepreventas.imei,
	detallepreventas.condicion,
    detallepreventas.codmarca,
    detallepreventas.codmodelo,
    detallepreventas.codpresentacion, 
    detallepreventas.codcolor,
    detallepreventas.precioventa,
	detallepreventas.posicionimpuesto,
	detallepreventas.tipoimpuesto,
    detallepreventas.ivaproducto,
    detallepreventas.descproducto,
    detallepreventas.valortotal,
    detallepreventas.valorneto,
    detallepreventas.tipodetalle, 
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,  
    sucursales.documsucursal, 
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.tlfsucursal,
    sucursales.direcsucursal,
    sucursales.correosucursal,
    sucursales.llevacontabilidad,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    documentos.documento,
    documentos2.documento AS documento2,
    provincias.provincia,
    departamentos.departamento,
    usuarios.dni,
    usuarios.nombres,
    SUM(detallepreventas.cantidad) AS cantidad,
	pag.existencia  
    FROM (detallepreventas INNER JOIN preventas ON detallepreventas.codpreventa = preventas.codpreventa)   
    LEFT JOIN marcas ON detallepreventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detallepreventas.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detallepreventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallepreventas.codcolor = colores.codcolor
    LEFT JOIN sucursales ON preventas.codsucursal = sucursales.codsucursal 
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON preventas.codigo = usuarios.codigo

    LEFT JOIN
		(SELECT
		idproducto,
		existencia
		FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detallepreventas.idproducto

    WHERE preventas.codsucursal = ?
    AND preventas.codigo = ? 
    AND DATE_FORMAT(preventas.fechapreventa,'%Y-%m-%d') BETWEEN ? AND ? 
    GROUP BY detallepreventas.codproducto, detallepreventas.producto, detallepreventas.precioventa, detallepreventas.descproducto, detallepreventas.codsucursal
    ORDER BY detallepreventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codigo']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL VENDEDOR Y RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES PREVENTAS POR VENDEDOR ###############################

########################### FIN DE CLASE PREVENTAS ############################




















################################ CLASE CAJAS DE VENTAS ################################

######################### FUNCION REGISTRAR CAJAS DE VENTAS #######################
public function RegistrarCajas()
{
	self::SetNames();
	if(empty($_POST["nrocaja"]) or empty($_POST["nomcaja"]) or empty($_POST["codigo"]))
	{
		echo "1";
		exit;
	}
	$sql = "SELECT nrocaja FROM cajas WHERE nrocaja = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nrocaja"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 0)
	{
	    echo "2";
	    exit;
	} 
	$sql = "SELECT nomcaja FROM cajas WHERE nomcaja = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["nomcaja"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "3";
		exit;
	}	
	$sql = "SELECT codigo FROM cajas WHERE codigo = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_POST["codigo"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = "INSERT INTO cajas values (null, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $nrocaja);
		$stmt->bindParam(2, $nomcaja);
		$stmt->bindParam(3, $codigo);
		$stmt->bindParam(4, $codsucursal);

		$nrocaja     = limpiar($_POST["nrocaja"]);
		$nomcaja     = limpiar($_POST["nomcaja"]);
		$codigo      = limpiar($_POST["codigo"]);
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA CAJA PARA VENTA HA SIDO REGISTRADA EXITOSAMENTE";
		exit;

	} else {

		echo "4";
		exit;
	}
}
######################### FUNCION REGISTRAR CAJAS DE VENTAS #########################

######################### FUNCION LISTAR CAJAS DE VENTAS ################################
public function ListarCajas()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorS") {

        $sql = "SELECT
	    cajas.*,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM cajas LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	    INNER JOIN usuarios ON cajas.codigo = usuarios.codigo  
        WHERE cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		ORDER BY cajas.codcaja ASC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else if($_SESSION['acceso'] == "secretaria" || $_SESSION["acceso"] == "cajero" || $_SESSION["acceso"] == "vendedor") {

		$sql = "SELECT
	    cajas.*,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM cajas LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	    INNER JOIN usuarios ON cajas.codigo = usuarios.codigo
        WHERE cajas.codigo = '".limpiar($_SESSION["codigo"])."'
        AND cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		ORDER BY cajas.codcaja ASC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
	    cajas.*,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		documentos.documento
	    FROM cajas LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	    INNER JOIN usuarios ON cajas.codigo = usuarios.codigo
        WHERE cajas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		ORDER BY cajas.codcaja ASC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################### FUNCION LISTAR CAJAS DE VENTAS ##########################

############################ FUNCION ID CAJAS DE VENTAS #################################
public function CajasPorId()
{
	self::SetNames();
	$sql = "SELECT 
    cajas.*,
    usuarios.codigo,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.simbolo,
	tiposmoneda.siglas
    FROM cajas LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	WHERE cajas.codcaja = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcaja"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID CAJAS DE VENTAS #################################

#################### FUNCION ACTUALIZAR CAJAS DE VENTAS ############################
public function ActualizarCajas()
{
	self::SetNames();
	if(empty($_POST["codcaja"]) or empty($_POST["nrocaja"]) or empty($_POST["nomcaja"]) or empty($_POST["codigo"]))
	{
		echo "1";
		exit;
	}
	$sql = "SELECT nrocaja FROM cajas WHERE codcaja != ? AND nrocaja = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcaja"]),$_POST["nrocaja"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 0)
	{
	   echo "2";
	   exit;
	} 
	$sql = "SELECT nomcaja FROM cajas WHERE codcaja != ? AND nomcaja = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcaja"]),$_POST["nomcaja"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 0)
	{
		echo "3";
		exit;
	}	
	$sql = "SELECT codigo FROM cajas WHERE codcaja != ? AND codigo = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcaja"]),$_POST["codigo"],decrypt($_POST["codsucursal"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "UPDATE cajas set "
		." nrocaja = ?, "
		." nomcaja = ?, "
		." codigo = ? "
		." WHERE "
		." codcaja = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $nrocaja);
		$stmt->bindParam(2, $nomcaja);
		$stmt->bindParam(3, $codigo);
		$stmt->bindParam(4, $codcaja);

		$nrocaja = limpiar($_POST["nrocaja"]);
		$nomcaja = limpiar($_POST["nomcaja"]);
		$codigo = limpiar($_POST["codigo"]);
		$codcaja = limpiar(decrypt($_POST["codcaja"]));
		$stmt->execute();

		echo "<span class='fa fa-check-square-o'></span> LA CAJA PARA VENTA HA SIDO ACTUALIZADA EXITOSAMENTE";
		exit;

	} else {

		echo "4";
		exit;
	}
}
#################### FUNCION ACTUALIZAR CAJAS DE VENTAS ###########################

####################### FUNCION ELIMINAR CAJAS DE VENTAS ########################
public function EliminarCajas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG" || $_SESSION["acceso"]=="administradorS") {

	$sql = "SELECT codcaja FROM arqueocaja WHERE codcaja = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codcaja"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$sql = "DELETE FROM cajas WHERE codcaja = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codcaja);
		$codcaja = decrypt($_GET["codcaja"]);
		$stmt->execute();

		echo "1";
		exit;

	} else {
		   
		echo "2";
		exit;
	} 
			
	} else {
		
		echo "3";
		exit;
	}	
}
####################### FUNCION ELIMINAR CAJAS DE VENTAS #######################

####################### FUNCION BUSCAR CAJAS POR SUCURSAL ###############################
public function BuscarCajasxSucursal() 
{
	self::SetNames();
	$sql = "SELECT 
    cajas.*,
    usuarios.codigo,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	documentos.documento
    FROM cajas 
    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	WHERE cajas.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<option value=''> -- SIN RESULTADOS -- </option>";
		exit;
	}
	else
	{
	    while($row = $stmt->fetch())
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION BUSCAR CAJAS POR SUCURSAL #######################

######################### FUNCION LISTAR CAJAS ABIERTAS ##########################
public function ListarCajasAbiertas()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
	    cajas.*,
	    arqueocaja.codarqueo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
	    usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento
	    FROM arqueocaja INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE cajas.codsucursal = ? 
		AND arqueocaja.statusarqueo = 1
		ORDER BY arqueocaja.codarqueo ASC";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<option value=''> -- SIN RESULTADOS -- </option>";
			exit;
		}
		else
		{
		   while($row = $stmt->fetch())
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}

	} else if($_SESSION["acceso"] == "secretaria" || $_SESSION["acceso"] == "cajero" || $_SESSION["acceso"] == "vendedor") {

	    $sql = "SELECT 
	    cajas.*,
	    arqueocaja.codarqueo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
	    usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento
	    FROM arqueocaja INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE cajas.codigo = '".limpiar($_SESSION["codigo"])."'
	    AND cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND arqueocaja.statusarqueo = 1
		ORDER BY arqueocaja.codarqueo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT 
	    cajas.*,
	    arqueocaja.codarqueo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
	    usuarios.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento
	    FROM arqueocaja INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		WHERE cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND arqueocaja.statusarqueo = 1
		ORDER BY arqueocaja.codarqueo ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################### FUNCION LISTAR CAJAS ABIERTAS ##########################

############################ FIN DE CLASE CAJAS DE VENTAS ##############################


























########################## CLASE ARQUEOS DE CAJA ###################################

########################## FUNCION PARA REGISTRAR ARQUEO DE CAJA ####################
public function RegistrarArqueoCaja()
{
	self::SetNames();
	if(empty($_POST["codcaja"]) or empty($_POST["montoinicial"]) or empty($_POST["fecharegistro"]))
	{
		echo "1";
		exit;
	}
	$sql = "SELECT codcaja FROM arqueocaja WHERE codcaja = ? AND statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codcaja"])));
	$num = $stmt->rowCount();
	if($num == 0)
	{
		$query = "INSERT INTO arqueocaja values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $codcaja);
		$stmt->bindParam(3, $montoinicial);
		$stmt->bindParam(4, $ingresos);
		$stmt->bindParam(5, $ingresos2);
		$stmt->bindParam(6, $egresos);
		$stmt->bindParam(7, $egresonotas);
		$stmt->bindParam(8, $creditos);
		$stmt->bindParam(9, $abonos);
		$stmt->bindParam(10, $efectivocaja);
		$stmt->bindParam(11, $dineroefectivo);
		$stmt->bindParam(12, $diferencia);
		$stmt->bindParam(13, $comentarios);
		$stmt->bindParam(14, $fechaapertura);
		$stmt->bindParam(15, $fechacierre);
		$stmt->bindParam(16, $statusarqueo);

		$tipodocumento  = limpiar("TICKET_CIERRE_8");
		$codcaja        = limpiar(decrypt($_POST["codcaja"]));
		$montoinicial   = limpiar($_POST["montoinicial"]);
		$ingresos       = limpiar("0.00");
		$ingresos2      = limpiar("0.00");
		$egresos        = limpiar("0.00");
		$egresonotas    = limpiar("0.00");
		$creditos       = limpiar("0.00");
		$abonos         = limpiar("0.00");
		$efectivocaja   = limpiar("0.00");
		$dineroefectivo = limpiar("0.00");
		$diferencia     = limpiar("0.00");
		$comentarios    = limpiar('NINGUNO');
		$fechaapertura  = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fecharegistro'])));
		$fechacierre    = limpiar(date("0000-00-00 00:00:00"));
		$statusarqueo   = limpiar("1");
		$stmt->execute();

	    echo "<span class='fa fa-check-square-o'></span> EL ARQUEO DE CAJA HA SIDO REALIZADO EXITOSAMENTE";
	    exit;

	} else {

		echo "2";
		exit;
    }
}
######################## FUNCION PARA REGISTRAR ARQUEO DE CAJA #######################

######################## FUNCION PARA LISTAR ARQUEO DE CAJA ########################
public function ListarArqueoCaja()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorS") {

	    $sql = "SELECT
	    arqueocaja.*,
	    cajas.nrocaja,
	    cajas.nomcaja,
	    cajas.codigo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.simbolo,
		tiposmoneda.siglas
	    FROM arqueocaja 
	    INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
        WHERE cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
        ORDER BY arqueocaja.codarqueo DESC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else if($_SESSION['acceso'] == "secretaria" || $_SESSION["acceso"] == "cajero" || $_SESSION["acceso"] == "vendedor") {

	    $sql = "SELECT
	    arqueocaja.*,
	    cajas.nrocaja,
	    cajas.nomcaja,
	    cajas.codigo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.simbolo,
		tiposmoneda.siglas
	    FROM arqueocaja 
	    INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
        WHERE cajas.codigo = '".limpiar($_SESSION["codigo"])."'
	    AND cajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
        ORDER BY arqueocaja.codarqueo DESC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

		$sql = "SELECT
	    arqueocaja.*,
	    cajas.nrocaja,
	    cajas.nomcaja,
	    cajas.codigo,
	    usuarios.codigo,
	    usuarios.dni,
	    usuarios.nombres,
	    usuarios.nivel,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.simbolo,
		tiposmoneda.siglas
	    FROM arqueocaja 
	    INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
        WHERE cajas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
        ORDER BY arqueocaja.codarqueo DESC";
        foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION PARA LISTAR ARQUEO DE CAJA #########################

########################## FUNCION ID ARQUEO DE CAJA #############################
public function ArqueoCajaPorId()
{
	self::SetNames();
	$sql = "SELECT 
	arqueocaja.codarqueo,
	arqueocaja.tipodocumento,
	arqueocaja.codcaja,
	arqueocaja.montoinicial,
	arqueocaja.ingresos,
	arqueocaja.ingresos2,
	arqueocaja.egresos,
	arqueocaja.egresonotas,
	arqueocaja.creditos,
	arqueocaja.abonos,
	arqueocaja.efectivocaja,
	arqueocaja.dineroefectivo,
	arqueocaja.diferencia,
	arqueocaja.comentarios,
	arqueocaja.fechaapertura,
	arqueocaja.fechacierre,
	arqueocaja.statusarqueo,
	cajas.nrocaja,
	cajas.nomcaja,
	cajas.codigo,
	usuarios.dni,
	usuarios.nombres,
	usuarios.telefono,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	provincias.provincia,
    departamentos.departamento,
	pag.montopagado,
	pag.operaciones,
	pag2.mediopago
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo 
	LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	
	LEFT JOIN
	   (SELECT
	   mediospagoxventas.codarqueo,
	   mediospagoxventas.codmediopago, 
	   (SUM(mediospagoxventas.montopagado) - SUM(mediospagoxventas.montodevuelto)) AS montopagado,
	   COUNT(mediospagoxventas.codmediopago) AS operaciones
	   FROM mediospagoxventas
	   WHERE mediospagoxventas.codarqueo = '".decrypt($_GET["codarqueo"])."'
	   GROUP BY mediospagoxventas.codarqueo, mediospagoxventas.codmediopago
	   ORDER BY mediospagoxventas.codmediopago DESC) pag ON arqueocaja.codarqueo = pag.codarqueo
          
    LEFT JOIN
	   (SELECT
	   mediospagos.codmediopago,
	   mediospagos.mediopago
	   FROM mediospagos) pag2 ON pag.codmediopago = pag2.codmediopago

	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION ID ARQUEO DE CAJA #############################

########################## FUNCION ID ARQUEO DE CAJA (DETALLES ABONOS) #############################
public function DetallesAbonosArqueoCajaPorId()
{
	self::SetNames();
	$sql = "SELECT 
	arqueocaja.codarqueo,
	pag.monto_abonado,
	pag.operaciones_abonos,
	pag2.mediopago
	FROM arqueocaja 
	
	LEFT JOIN
      (SELECT
      abonoscreditosventas.codarqueo,
      abonoscreditosventas.formaabono, 
      SUM(abonoscreditosventas.montoabono) AS monto_abonado,
      COUNT(abonoscreditosventas.formaabono) AS operaciones_abonos
      FROM abonoscreditosventas
      WHERE abonoscreditosventas.codarqueo = '".decrypt($_GET["codarqueo"])."'
      GROUP BY abonoscreditosventas.codarqueo, abonoscreditosventas.formaabono
	  ORDER BY abonoscreditosventas.formaabono DESC) pag ON pag.codarqueo = arqueocaja.codarqueo

    LEFT JOIN
      (SELECT
      mediospagos.codmediopago,
      mediospagos.mediopago
      FROM mediospagos) pag2 ON pag2.codmediopago = pag.formaabono

	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	    while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION ID ARQUEO DE CAJA (DETALLES ABONOS) #############################

########################## FUNCION ID ARQUEO DE CAJA (DETALLES MOVIMIENTOS) #############################
public function DetallesMovimientosArqueoCajaPorId()
{
	self::SetNames();
	$sql = "SELECT 
	arqueocaja.codarqueo,
	mov.movimientos_efectivo,
	mov.operaciones_movimientos,
	med.mediopago
	FROM arqueocaja 
	
	LEFT JOIN
      (SELECT
      movimientoscajas.codarqueo,
      movimientoscajas.codmediopago, 
      SUM(movimientoscajas.montomovimiento) AS movimientos_efectivo,
      COUNT(movimientoscajas.codmediopago) AS operaciones_movimientos
      FROM movimientoscajas
      WHERE movimientoscajas.codarqueo = '".decrypt($_GET["codarqueo"])."'
      AND movimientoscajas.tipomovimiento = 'INGRESO'
      GROUP BY movimientoscajas.codarqueo, movimientoscajas.codmediopago
	  ORDER BY movimientoscajas.codmediopago DESC) mov ON mov.codarqueo = arqueocaja.codarqueo

    LEFT JOIN
      (SELECT
      mediospagos.codmediopago,
      mediospagos.mediopago
      FROM mediospagos) med ON med.codmediopago = mov.codmediopago

	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION ID ARQUEO DE CAJA (DETALLES MOVIMIENTOS) #############################

##################### FUNCION VERIFICA ARQUEO DE CAJA POR USUARIO #######################
public function ArqueoCajaPorUsuario()
{
	self::SetNames();
	$sql = "SELECT
    arqueocaja.*,
    cajas.nrocaja,
    cajas.nomcaja,
    cajas.codigo,
    usuarios.codigo,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.simbolo,
	tiposmoneda.siglas
    FROM arqueocaja 
    INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    WHERE usuarios.codigo = ? 
	AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	    if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION VERIFICA ARQUEO DE CAJA POR USUARIO ###################

######################### FUNCION PARA CERRAR ARQUEO DE CAJA #########################
public function CerrarArqueoCaja()
{
	self::SetNames();
	if(empty($_POST["codarqueo"]) or empty($_POST["tipodocumento"]) or empty($_POST["dineroefectivo"]))
	{
		echo "1";
		exit;
	}

	if($_POST["dineroefectivo"] != 0.00 || $_POST["dineroefectivo"] != 0){

		$sql = "UPDATE arqueocaja SET "
		." tipodocumento = ?, "
		." efectivocaja = ?, "
		." dineroefectivo = ?, "
		." diferencia = ?, "
		." comentarios = ?, "
		." fechacierre = ?, "
		." statusarqueo = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $efectivocaja);
		$stmt->bindParam(3, $dineroefectivo);
		$stmt->bindParam(4, $diferencia);
		$stmt->bindParam(5, $comentarios);
		$stmt->bindParam(6, $fechacierre);
		$stmt->bindParam(7, $statusarqueo);
		$stmt->bindParam(8, $codarqueo);

		$tipodocumento  = limpiar($_POST["tipodocumento"]);
		$efectivocaja   = limpiar($_POST["efectivocaja"]);
		$dineroefectivo = limpiar($_POST["dineroefectivo"]);
		$diferencia     = limpiar($_POST["diferencia"]);
		$comentarios    = limpiar($_POST['comentarios']);
		$fechacierre    = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fecharegistro'])));
		$statusarqueo   = limpiar("0");
		$codarqueo      = limpiar(decrypt($_POST["codarqueo"]));
		$stmt->execute();

	   echo "<span class='fa fa-check-square-o'></span> EL CIERRE DE CAJA FUE REALIZADO EXITOSAMENTE";
	   echo "<script>VentanaCentrada('reportepdf?codarqueo=".encrypt($codarqueo)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	   exit;

	} else {

		echo "2";
		exit;
    }
}
######################### FUNCION PARA CERRAR ARQUEO DE CAJA ######################

######################### FUNCION PARA ACTUALIZAR ARQUEO DE CAJA #########################
public function ActualizarArqueoCaja()
{
	self::SetNames();
	if(empty($_POST["codarqueo"]) or empty($_POST["tipodocumento"]) or empty($_POST["dineroefectivo"]))
	{
		echo "1";
		exit;
	}

	if($_POST["dineroefectivo"] != 0.00 || $_POST["dineroefectivo"] != 0){

		$sql = "UPDATE arqueocaja SET "
		." tipodocumento = ?, "
		." efectivocaja = ?, "
		." dineroefectivo = ?, "
		." diferencia = ?, "
		." comentarios = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $efectivocaja);
		$stmt->bindParam(3, $dineroefectivo);
		$stmt->bindParam(4, $diferencia);
		$stmt->bindParam(5, $comentarios);
		$stmt->bindParam(6, $codarqueo);

		$tipodocumento  = limpiar($_POST["tipodocumento"]);
		$efectivocaja   = limpiar($_POST["efectivocaja"]);
		$dineroefectivo = limpiar($_POST["dineroefectivo"]);
		$diferencia     = limpiar($_POST["diferencia"]);
		$comentarios    = limpiar($_POST['comentarios']);
		$codarqueo      = limpiar(decrypt($_POST["codarqueo"]));
		$stmt->execute();

	   echo "<span class='fa fa-check-square-o'></span> EL ARQUEO DE CAJA FUE ACTUALIZADO EXITOSAMENTE";
	   echo "<script>VentanaCentrada('reportepdf?codarqueo=".encrypt($codarqueo)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	   exit;

	} else {

		echo "2";
		exit;
    }
}
######################### FUNCION PARA ACTUALIZAR ARQUEO DE CAJA ######################

###################### FUNCION BUSCAR ARQUEOS DE CAJA POR FECHAS ######################
public function BuscarArqueosxFechas() 
{
	self::SetNames();		
	$sql = "SELECT
    arqueocaja.*,
    cajas.nrocaja,
    cajas.nomcaja,
    cajas.codigo,
    usuarios.codigo,
    usuarios.dni,
    usuarios.nombres,
    usuarios.nivel,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.simbolo,
	tiposmoneda.siglas
    FROM arqueocaja 
    INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
    LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    WHERE sucursales.codsucursal = ? 
	AND arqueocaja.codcaja = ? 
	AND DATE_FORMAT(arqueocaja.fechaapertura,'%Y-%m-%d') BETWEEN ? AND ?
	ORDER BY arqueocaja.codarqueo DESC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<center><div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<span class='fa fa-info-circle'></span> NO SE ENCONTRARON ARQUEOS DE CAJAS PARA LAS FECHAS SELECCIONADAS</div></center>";
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
######################## FUNCION BUSCAR ARQUEOS DE CAJA POR FECHAS ####################

######################## FUNCION INFORME VENTAS DE CAJAS POR FECHAS ########################
public function SumarVentasCajasxFechas()
{
	self::SetNames();
	$sql = "SELECT 
	SUM(subtotal) AS subtotal,
	SUM(totaliva) AS totaliva, 
	SUM(totalpago) AS totalventa, 
	SUM(totalpago2) AS totalcompra
	FROM ventas WHERE codcaja = ? 
	AND DATE_FORMAT(fechaventa,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION INFORME VENTAS DE CAJAS POR FECHAS ########################

######################## FUNCION INFORME APERTURAS DE CAJAS POR FECHAS ########################
public function SumarArqueosCajasxFechas()
{
	self::SetNames();
	$sql = "SELECT 
	SUM(ingresos2) AS totalingresos, 
	SUM(egresos+egresonotas) AS totalegresos, 
	SUM(abonos) AS totalabonos
	FROM arqueocaja WHERE codcaja = ? 
	AND DATE_FORMAT(fechaapertura,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION INFORME APERTURAS DE CAJAS POR FECHAS ########################

########################## FUNCION INGRESOS POR FECHAS #############################
public function BuscarIngresosxFechas()
{
	self::SetNames();
	$sql = "SELECT 
	SUM(arqueocaja.ingresos2) AS totalingresos, 
	SUM(arqueocaja.egresos+arqueocaja.egresonotas) AS totalegresos, 
	SUM(arqueocaja.abonos) AS totalabonos
	FROM arqueocaja
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	WHERE cajas.codsucursal = ? 
    AND DATE_FORMAT(arqueocaja.fechaapertura,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	   if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION INGRESOS POR FECHAS #############################

###################### FUNCION GANANCIAS POR FECHAS #########################
public function BuscarGananciasxFechas()
{
	self::SetNames();
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto, 
    detalleventas.producto,
    detalleventas.condicion,
    detalleventas.descripcion,
    detalleventas.imei, 
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
    detalleventas.preciocompra,  
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,  
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.subtotalimpuestos,
    detalleventas.tipodetalle,
    marcas.nommarca, 
    modelos.nommodelo,
    presentaciones.nompresentacion,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres, 
    SUM(detalleventas.cantidad) AS cantidad,
	pag.existencia
    FROM (detalleventas LEFT JOIN ventas ON detalleventas.codventa = ventas.codventa)
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   idproducto,
	   existencia
	   FROM productos WHERE codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."') pag ON pag.idproducto = detalleventas.idproducto 
   
    LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
    AND ventas.notacredito = 0
    GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA EL RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION GANANCIAS POR FECHAS ###############################

############################# FIN DE CLASE ARQUEOS DE CAJA ###########################



























############################ CLASE MOVIMIENTOS EN CAJAS ##############################

###################### FUNCION PARA REGISTRAR MOVIMIENTO EN CAJA #######################
public function RegistrarMovimientos()
{
	self::SetNames();
	if(empty($_POST["codarqueo"]) or empty($_POST["tipomovimiento"]) or empty($_POST["montomovimiento"]) or empty($_POST["descripcionmovimiento"]) or empty($_POST["codmediopago"]))
	{
		echo "1";
		exit;
	}
	elseif($_POST["montomovimiento"] == "" || $_POST["montomovimiento"] == 0 || $_POST["montomovimiento"] == 0.00)
	{
		echo "2";
		exit;
	}
	
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
    arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.montoinicial,
	arqueocaja.ingresos,
	arqueocaja.ingresos2,
	arqueocaja.egresos,
	arqueocaja.egresonotas,
	pagos.total_efectivo,
	IFNULL(movimientos.movimientos_efectivo,'0.00') AS movimientos_efectivo,
	IFNULL(abonos.abonos_efectivo,'0.00') AS abonos_efectivo
	FROM arqueocaja
	   
	   LEFT JOIN
		   (SELECT
		   mediospagoxventas.codarqueo,
		   (SUM(mediospagoxventas.montopagado) - SUM(mediospagoxventas.montodevuelto)) AS total_efectivo,
		   mediospagos.mediopago
		   FROM mediospagoxventas LEFT JOIN mediospagos ON mediospagoxventas.codmediopago = mediospagos.codmediopago
		   WHERE mediospagoxventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY mediospagoxventas.codarqueo, mediospagos.mediopago
	       ORDER BY mediospagoxventas.codarqueo ASC) pagos ON arqueocaja.codarqueo = pagos.codarqueo
          
      LEFT JOIN
		   (SELECT
		   movimientoscajas.codarqueo,
		   SUM(movimientoscajas.montomovimiento) AS movimientos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM movimientoscajas LEFT JOIN mediospagos ON movimientoscajas.codmediopago = mediospagos.codmediopago
		   WHERE movimientoscajas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
           AND movimientoscajas.tipomovimiento = 'INGRESO'
		   GROUP BY movimientoscajas.codarqueo, mediospagos.mediopago
		   ORDER BY movimientoscajas.codarqueo ASC) movimientos ON arqueocaja.codarqueo = movimientos.codarqueo

		LEFT JOIN
		   (SELECT
		   abonoscreditosventas.codarqueo,
		   SUM(abonoscreditosventas.montoabono) AS abonos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM abonoscreditosventas LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
		   WHERE abonoscreditosventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY abonoscreditosventas.codarqueo, mediospagos.mediopago
		   ORDER BY abonoscreditosventas.codarqueo ASC) abonos ON arqueocaja.codarqueo = abonos.codarqueo
            
	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "4";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD           = $row['codarqueo'];
		$codcajaBD             = $row['codcaja'];
		$inicialBD             = $row['montoinicial'];
		$ingresosBD            = $row['ingresos'];
		$ingresos2BD           = $row['ingresos2'];
		$total_efectivoBD      = $row['total_efectivo'];
		$movimiento_EfectivoBD = $row['movimientos_efectivo'];
		$total_abonosBD        = $row['abonos_efectivo'];
		$egresosBD             = $row['egresos'];
		$egresonotasBD         = $row['egresonotas'];
		$total                 = ($inicialBD+$total_efectivoBD+$movimiento_EfectivoBD+$total_abonosBD)-($egresosBD+$egresonotasBD);
	}
   ####################### VERIFICO ARQUEO DE CAJA #######################

   ################ CREO Nº DE MOVIMIENTO ####################
	$sql = "SELECT numero FROM movimientoscajas
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
	ORDER BY codmovimiento DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$documento=$row["numero"];

	}
	if(empty($documento))
	{
		$numero = "01";

	} else {

		$num = substr($documento, 0);
		$digitos = $num + 1;
		$numfinal = str_pad($digitos, 2, "0", STR_PAD_LEFT);
		$numero = $numfinal;
	}
    ################ CREO Nº DE MOVIMIENTO ###############

	//REALIZO LA CONDICION SI EL MOVIMIENTO ES UN INGRESO
	if($_POST["tipomovimiento"]=="INGRESO"){ 

		######################## ACTUALIZO DATOS EN ARQUEO ########################
		$sql = " UPDATE arqueocaja SET "
		." ingresos2 = ? "
		." WHERE "
		." codarqueo = ? AND statusarqueo = 1;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtIngresos);
		$stmt->bindParam(2, $codarqueo);

		$txtIngresos = number_format($_POST["montomovimiento"] + $ingresos2BD, 2, '.', '');
		$codarqueo   = limpiar($codarqueoBD);
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

		######################## REGISTRO EL MOVIMIENTOS EN CAJA ########################
		$query = "INSERT INTO movimientoscajas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $numero);
		$stmt->bindParam(3, $codarqueo);
		$stmt->bindParam(4, $codcaja);
		$stmt->bindParam(5, $tipomovimiento);
		$stmt->bindParam(6, $codmediopago);
		$stmt->bindParam(7, $montomovimiento);
		$stmt->bindParam(8, $descripcionmovimiento);
		$stmt->bindParam(9, $fechamovimiento);
		$stmt->bindParam(10, $codsucursal);

		$tipodocumento         = limpiar($_POST["tipodocumento"]);
		$codarqueo             = limpiar($codarqueoBD);
		$codcaja               = limpiar($codcajaBD);
		$tipomovimiento        = limpiar($_POST["tipomovimiento"]);
		$codmediopago          = limpiar(decrypt($_POST["codmediopago"]));
		$montomovimiento       = limpiar($_POST["montomovimiento"]);
		$descripcionmovimiento = limpiar($_POST["descripcionmovimiento"]);
		$fechamovimiento       = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fecharegistro'])));
		$codsucursal           = limpiar($_SESSION["codsucursal"]);
		$stmt->execute();
		######################## REGISTRO EL MOVIMIENTOS EN CAJA ########################

	//REALIZO LA CONDICION SI EL MOVIMIENTO ES UN EGRESO
	} else { 

	    if($_POST["montomovimiento"]>$total){

			echo "6";
			exit;
        }

		######################## ACTUALIZO DATOS EN ARQUEO ########################
        $sql = "UPDATE arqueocaja SET "
		." egresos = ? "
		." WHERE "
		." codarqueo = ? AND statusarqueo = 1;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtEgresos);
		$stmt->bindParam(2, $codarqueo);

		$txtEgresos = number_format($_POST["montomovimiento"] + $egresosBD, 2, '.', '');
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

		######################## REGISTRO EL MOVIMIENTOS EN CAJA ########################
		$query = "INSERT INTO movimientoscajas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $numero);
		$stmt->bindParam(3, $codarqueo);
		$stmt->bindParam(4, $codcaja);
		$stmt->bindParam(5, $tipomovimiento);
		$stmt->bindParam(6, $codmediopago);
		$stmt->bindParam(7, $montomovimiento);
		$stmt->bindParam(8, $descripcionmovimiento);
		$stmt->bindParam(9, $fechamovimiento);
		$stmt->bindParam(10, $codsucursal);

		$tipodocumento         = limpiar($_POST["tipodocumento"]);
		$codarqueo             = limpiar($codarqueoBD);
		$codcaja               = limpiar($codcajaBD);
		$tipomovimiento        = limpiar($_POST["tipomovimiento"]);
		$codmediopago          = limpiar(decrypt($_POST["codmediopago"]));
		$montomovimiento       = limpiar($_POST["montomovimiento"]);
		$descripcionmovimiento = limpiar($_POST["descripcionmovimiento"]);
		$fechamovimiento       = limpiar(date("Y-m-d H:i:s",strtotime($_POST['fecharegistro'])));
		$codsucursal           = limpiar($_SESSION["codsucursal"]);
		$stmt->execute();
		######################## REGISTRO EL MOVIMIENTOS EN CAJA ########################
	}

	echo "<span class='fa fa-check-square-o'></span> EL MOVIMIENTO EN CAJA HA SIDO REGISTRADO EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?numero=".encrypt($numero)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;	 
}
##################### FUNCION PARA REGISTRAR MOVIMIENTO EN CAJA #######################

###################### FUNCION PARA LISTAR MOVIMIENTO EN CAJA #######################
public function ListarMovimientos()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorS") {

	    $sql = " SELECT 
	    movimientoscajas.*,
		mediospagos.mediopago,
		cajas.nrocaja,
		cajas.nomcaja,
		cajas.codigo,
		arqueocaja.statusarqueo,
		usuarios.dni,
		usuarios.nombres,
		usuarios.telefono,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.tlfsucursal,
		sucursales.correosucursal,
		sucursales.id_provincia,
		sucursales.id_departamento,
		sucursales.direcsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.tlfencargado,
		sucursales.fechaautorsucursal,
		sucursales.llevacontabilidad,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo
	    FROM movimientoscajas 
		LEFT JOIN mediospagos ON mediospagos.codmediopago = movimientoscajas.codmediopago
		LEFT JOIN arqueocaja ON movimientoscajas.codarqueo = arqueocaja.codarqueo
		LEFT JOIN cajas ON movimientoscajas.codcaja = cajas.codcaja 
		LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
		LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	    WHERE movimientoscajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	    ORDER BY movimientoscajas.codmovimiento DESC";
	    foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else if($_SESSION["acceso"] == "secretaria" || $_SESSION['acceso'] == "cajero" || $_SESSION["acceso"] == "vendedor") {

		$sql = " SELECT 
	    movimientoscajas.*,
		mediospagos.mediopago,
		cajas.nrocaja,
		cajas.nomcaja,
		cajas.codigo,
		arqueocaja.statusarqueo,
		usuarios.dni,
		usuarios.nombres,
		usuarios.telefono,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.tlfsucursal,
		sucursales.correosucursal,
		sucursales.id_provincia,
		sucursales.id_departamento,
		sucursales.direcsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.tlfencargado,
		sucursales.fechaautorsucursal,
		sucursales.llevacontabilidad,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo
	    FROM movimientoscajas 
		LEFT JOIN mediospagos ON mediospagos.codmediopago = movimientoscajas.codmediopago
		LEFT JOIN arqueocaja ON movimientoscajas.codarqueo = arqueocaja.codarqueo
		LEFT JOIN cajas ON movimientoscajas.codcaja = cajas.codcaja 
		LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
		LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	    WHERE usuarios.codigo = '".limpiar($_SESSION["codigo"])."'
        AND movimientoscajas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	    ORDER BY movimientoscajas.codmovimiento DESC";
	    foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = " SELECT 
	    movimientoscajas.*,
		mediospagos.mediopago,
		cajas.nrocaja,
		cajas.nomcaja,
		cajas.codigo,
		arqueocaja.statusarqueo,
		usuarios.dni,
		usuarios.nombres,
		usuarios.telefono,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.tlfsucursal,
		sucursales.correosucursal,
		sucursales.id_provincia,
		sucursales.id_departamento,
		sucursales.direcsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.tlfencargado,
		sucursales.fechaautorsucursal,
		sucursales.llevacontabilidad,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		documentos.documento,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo
	    FROM movimientoscajas 
		LEFT JOIN mediospagos ON mediospagos.codmediopago = movimientoscajas.codmediopago
		LEFT JOIN arqueocaja ON movimientoscajas.codarqueo = arqueocaja.codarqueo
		LEFT JOIN cajas ON movimientoscajas.codcaja = cajas.codcaja 
		LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
		LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
        WHERE movimientoscajas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
	    ORDER BY movimientoscajas.codmovimiento DESC";
	    foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION PARA LISTAR MOVIMIENTO EN CAJA ######################

########################## FUNCION ID MOVIMIENTO EN CAJA #############################
public function MovimientosPorId()
{
	self::SetNames();
	$sql = "SELECT 
	movimientoscajas.*,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	mediospagos.mediopago,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	documentos.documento,
    cajas.nrocaja,
    cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres,
    provincias.provincia,
    departamentos.departamento
	FROM movimientoscajas 
    LEFT JOIN sucursales ON movimientoscajas.codsucursal = sucursales.codsucursal
    LEFT JOIN arqueocaja ON movimientoscajas.codarqueo = arqueocaja.codarqueo
    LEFT JOIN cajas ON movimientoscajas.codcaja = cajas.codcaja
    LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN mediospagos ON mediospagos.codmediopago = movimientoscajas.codmediopago
	WHERE movimientoscajas.numero = ? AND movimientoscajas.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["numero"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION ID MOVIMIENTO EN CAJA #############################

##################### FUNCION PARA ACTUALIZAR MOVIMIENTOS EN CAJA ##################
public function ActualizarMovimientos()
{
	self::SetNames();
	if(empty($_POST["codmovimiento"]) or empty($_POST["codarqueo"]) or empty($_POST["tipomovimiento"]) or empty($_POST["montomovimiento"]) or empty($_POST["descripcionmovimiento"]) or empty($_POST["codmediopago"]))
	{
		echo "1";
		exit;
	}
	elseif($_POST["montomovimiento"] == "" || $_POST["montomovimiento"] == 0 || $_POST["montomovimiento"] == 0.00)
	{
		echo "2";
		exit;
	}
	elseif($_POST["tipomovimiento"] != $_POST["tipomovimientobd"] || $_POST["codmediopago"] != $_POST["codmediopagobd"])
	{
		echo "3";
		exit;
	}

	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
    arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.montoinicial,
	arqueocaja.ingresos,
	arqueocaja.ingresos2,
	arqueocaja.egresos,
	arqueocaja.egresonotas,
	arqueocaja.statusarqueo,
	pagos.total_efectivo,
	IFNULL(movimientos.movimientos_efectivo,'0.00') AS movimientos_efectivo,
	IFNULL(abonos.abonos_efectivo,'0.00') AS abonos_efectivo
	FROM arqueocaja
	   
	    LEFT JOIN
		   (SELECT
		   mediospagoxventas.codarqueo,
		   (SUM(mediospagoxventas.montopagado) - SUM(mediospagoxventas.montodevuelto)) AS total_efectivo,
		   mediospagos.mediopago
		   FROM mediospagoxventas LEFT JOIN mediospagos ON mediospagoxventas.codmediopago = mediospagos.codmediopago
		   WHERE mediospagoxventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY mediospagoxventas.codarqueo, mediospagos.mediopago
	       ORDER BY mediospagoxventas.codarqueo ASC) pagos ON arqueocaja.codarqueo = pagos.codarqueo
          
        LEFT JOIN
		   (SELECT
		   movimientoscajas.codarqueo,
		   SUM(movimientoscajas.montomovimiento) AS movimientos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM movimientoscajas LEFT JOIN mediospagos ON movimientoscajas.codmediopago = mediospagos.codmediopago
		   WHERE movimientoscajas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
           AND movimientoscajas.tipomovimiento = 'INGRESO'
		   GROUP BY movimientoscajas.codarqueo, mediospagos.mediopago
		   ORDER BY movimientoscajas.codarqueo ASC) movimientos ON arqueocaja.codarqueo = movimientos.codarqueo

		LEFT JOIN
		   (SELECT
		   abonoscreditosventas.codarqueo,
		   SUM(abonoscreditosventas.montoabono) AS abonos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM abonoscreditosventas LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
		   WHERE abonoscreditosventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY abonoscreditosventas.codarqueo, mediospagos.mediopago
		   ORDER BY abonoscreditosventas.codarqueo ASC) abonos ON arqueocaja.codarqueo = abonos.codarqueo
            
	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "4";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD           = $row['codarqueo'];
		$codcajaBD             = $row['codcaja'];
		$inicialBD             = $row['montoinicial'];
		$ingresosBD            = $row['ingresos'];
		$ingresos2BD           = $row['ingresos2'];
		$total_efectivoBD      = $row['total_efectivo'];
		$movimiento_EfectivoBD = $row['movimientos_efectivo'];
		$total_abonosBD        = $row['abonos_efectivo'];
		$egresosBD             = $row['egresos'];
		$egresonotasBD         = $row['egresonotas'];
		$statusBD              = $row['statusarqueo'];
		$total                 = ($inicialBD+$total_efectivoBD+$movimiento_EfectivoBD+$total_abonosBD)-($egresosBD+$egresonotasBD);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

	//REALIZAMOS CALCULO DE CAMPOS
	$numero = limpiar(decrypt($_POST["numero"]));
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
	$montomovimiento = limpiar($_POST["montomovimiento"]);
	$montomovimientoBD = limpiar($_POST["montomovimientobd"]);
	//$ingresobd = number_format($ingreso2-$montomovimientobd, 2, '.', '');
	$totalmovimiento = number_format($montomovimiento-$montomovimientoBD, 2, '.', '');

	if($statusBD == 1) {

	//REALIZO LA CONDICION SI EL MOVIMIENTO ES UN INGRESO
	if($_POST["tipomovimiento"]=="INGRESO"){ 

	   ######################## ACTUALIZO DATOS EN ARQUEO ########################
	   $sql = "UPDATE arqueocaja SET "
		." ingresos2 = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtIngresos);
		$stmt->bindParam(2, $codarqueo);
		
	    $txtIngresos = number_format($ingresos2BD + $totalmovimiento, 2, '.', '');
		$codarqueo  = limpiar($codarqueoBD);
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

	    ######################## ACTUALIZO EL MOVIMIENTOS EN CAJA ########################
	    $sql = "UPDATE movimientoscajas SET"
		." tipodocumento = ?, "
		." codcaja = ?, "
		." tipomovimiento = ?, "
		." codmediopago = ?, "
		." montomovimiento = ?, "
		." descripcionmovimiento = ? "
		." WHERE "
		." codmovimiento = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $codcaja);
		$stmt->bindParam(3, $tipomovimiento);
		$stmt->bindParam(4, $codmediopago);
		$stmt->bindParam(5, $montomovimiento);
		$stmt->bindParam(6, $descripcionmovimiento);
		$stmt->bindParam(7, $codmovimiento);

		$tipodocumento         = limpiar($_POST["tipodocumento"]);
		$codcaja               = limpiar($codcajaBD);
		$tipomovimiento        = limpiar($_POST["tipomovimiento"]);
		$codmediopago          = limpiar(decrypt($_POST["codmediopago"]));
		$montomovimiento       = limpiar($_POST["montomovimiento"]);
		$descripcionmovimiento = limpiar($_POST["descripcionmovimiento"]);
		$codmovimiento         = limpiar(decrypt($_POST["codmovimiento"]));
		$stmt->execute();
		######################## ACTUALIZO EL MOVIMIENTOS EN CAJA ########################

	//REALIZO LA CONDICION SI EL MOVIMIENTO ES UN EGRESO
	} else { 

	    if($totalmovimiento>$total){

			echo "6";
			exit;
        } 

		######################## ACTUALIZO DATOS EN ARQUEO ########################
        $sql = "UPDATE arqueocaja SET"
		." egresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtEgresos);
		$stmt->bindParam(2, $codarqueo);

		$txtEgresos = number_format($egresosBD + $totalmovimiento, 2, '.', '');
		$codarqueo  = limpiar($codarqueoBD);
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

	    ######################## ACTUALIZO EL MOVIMIENTOS EN CAJA ########################
		$sql = "UPDATE movimientoscajas SET"
		." tipodocumento = ?, "
		." codcaja = ?, "
		." tipomovimiento = ?, "
		." codmediopago = ?, "
		." montomovimiento = ?, "
		." descripcionmovimiento = ? "
		." WHERE "
		." codmovimiento = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $tipodocumento);
		$stmt->bindParam(2, $codcaja);
		$stmt->bindParam(3, $tipomovimiento);
		$stmt->bindParam(4, $codmediopago);
		$stmt->bindParam(5, $montomovimiento);
		$stmt->bindParam(6, $descripcionmovimiento);
		$stmt->bindParam(7, $codmovimiento);

		$tipodocumento         = limpiar($_POST["tipodocumento"]);
		$codcaja               = limpiar($codcajaBD);
		$tipomovimiento        = limpiar($_POST["tipomovimiento"]);
		$codmediopago          = limpiar(decrypt($_POST["codmediopago"]));
		$montomovimiento       = limpiar($_POST["montomovimiento"]);
		$descripcionmovimiento = limpiar($_POST["descripcionmovimiento"]);
		$codmovimiento         = limpiar(decrypt($_POST["codmovimiento"]));
		$stmt->execute();
		######################## ACTUALIZO EL MOVIMIENTOS EN CAJA ########################
	}

	    echo "<span class='fa fa-check-square-o'></span> EL MOVIMIENTO EN CAJA HA SIDO ACTUALIZADO EXITOSAMENTE";
        echo "<script>VentanaCentrada('reportepdf?numero=".encrypt($numero)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
        exit;	

	} else {
		   
		echo "7";
		exit;
    }
} 
##################### FUNCION PARA ACTUALIZAR MOVIMIENTOS EN CAJA ####################	

###################### FUNCION PARA ELIMINAR MOVIMIENTOS EN CAJA ######################
public function EliminarMovimientos()
{
	if($_SESSION['acceso'] == "administradorS" || $_SESSION['acceso'] == "cajero" || $_SESSION["acceso"] == "vendedor") {

    #################### OBTENEMOS DATOS DE MOVIMIENTO ####################
	$sql = "SELECT * FROM movimientoscajas 
	INNER JOIN arqueocaja ON movimientoscajas.codarqueo = arqueocaja.codarqueo 
	WHERE movimientoscajas.codmovimiento = '".limpiar(decrypt($_GET["codmovimiento"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	
	//OBTENEMOS CAMPOS DE MOVIMIENTOS
	$codcaja               = $row['codcaja'];
	$codarqueo             = $row['codarqueo'];
	$tipomovimiento        = $row['tipomovimiento'];
	$codmediopago          = $row['codmediopago'];
	$montomovimiento       = $row['montomovimiento'];
	$descripcionmovimiento = $row['descripcionmovimiento'];
	$fechamovimiento       = $row['fechamovimiento'];
	//OBTENEMOS CAMPOS DE MOVIMIENTOS

	//OBTENEMOS CAMPOS DE ARQUEO
	$inicial  = $row['montoinicial'];
	$ingreso  = $row['ingresos'];
	$ingreso2 = $row['ingresos2'];
	$egreso   = $row['egresos'];
	$status   = $row['statusarqueo'];
	//OBTENEMOS CAMPOS DE ARQUEO
	#################### OBTENEMOS DATOS DE MOVIMIENTO ####################

    if($status == 1) {

      //REALIZO LA CONDICION SI EL MOVIMIENTO ES UN INGRESO
      if($tipomovimiento == "INGRESO"){

		######################## ACTUALIZO DATOS EN ARQUEO ########################
        $sql = "UPDATE arqueocaja SET"
		." ingresos2 = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtIngresos);
		$stmt->bindParam(2, $codarqueo);

	    $txtIngresos = number_format($ingreso2 - $montomovimiento, 2, '.', '');
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

        //REALIZO LA CONDICION SI EL MOVIMIENTO ES UN EGRESO
	    } else {

		######################## ACTUALIZO DATOS EN ARQUEO ########################
		$sql = "UPDATE arqueocaja SET "
		." egresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtEgresos);
		$stmt->bindParam(2, $codarqueo);

		$txtEgresos = number_format($egreso - $montomovimiento, 2, '.', '');
		$stmt->execute();
		######################## ACTUALIZO DATOS EN ARQUEO ########################

        }

		######################## ELIMINO EL MOVIMIENTO EN CAJA ########################
        $sql = "DELETE FROM movimientoscajas WHERE codmovimiento = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codmovimiento);
		$codmovimiento = decrypt($_GET["codmovimiento"]);
		$stmt->execute();
		######################## ELIMINO EL MOVIMIENTO EN CAJA ########################

		echo "1";
		exit;
		   
	} else {
		   
		echo "2";
		exit;
	}
			
	} else {
		
		echo "3";
		exit;
	}	
}
###################### FUNCION PARA ELIMINAR MOVIMIENTOS EN CAJAS  ####################

################## FUNCION BUSCAR MOVIMIENTOS DE CAJA POR FECHAS #######################
public function BuscarMovimientosxFechas() 
{
	self::SetNames();
	$sql = "SELECT
	movimientoscajas.*,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
	cajas.codigo,
	usuarios.dni,
	usuarios.nombres,
	usuarios.telefono,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	documentos.documento,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	provincias.provincia,
    departamentos.departamento
	FROM movimientoscajas 
	LEFT JOIN mediospagos ON mediospagos.codmediopago = movimientoscajas.codmediopago
	LEFT JOIN cajas ON movimientoscajas.codcaja = cajas.codcaja 
	LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	LEFT JOIN sucursales ON cajas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	WHERE movimientoscajas.codsucursal = ? 
	AND movimientoscajas.codcaja = ? 
	AND DATE_FORMAT(movimientoscajas.fechamovimiento,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<center><div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<span class='fa fa-info-circle'></span> NO SE ENCONTRARON MOVIMIENTOS DE CAJAS PARA LAS FECHAS SELECCIONADAS</div></center>";
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
###################### FUNCION BUSCAR MOVIMIENTOS DE CAJA POR FECHAS ###################

######################### FIN DE CLASE MOVIMIENTOS EN CAJAS #############################

















###################################### CLASE FACTURAS PENDIENTES ###################################

############################# FUNCION COBRAR FACTURA ###############################
public function CobrarFactura()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

    if(empty($_POST["codsucursal2"]) or empty($_POST["tipodocumento2"]) or empty($_POST["tipopago2"]))
	{
		echo "2";
		exit;
	}
	elseif($_POST["txtTotal2"] == 0.00)
	{
		echo "3";
		exit;	
	}

	###################### VALIDO SI CANTIDAD ES MAYOR QUE EXISTENCIA ######################
	$sql = "SELECT * FROM detallependientes 
	WHERE codpendiente = '".decrypt($_POST['codpendiente'])."' 
	AND codsucursal = '".decrypt($_POST['codsucursal2'])."'";
    foreach ($this->dbh->query($sql) as $row2) {

		if(limpiar($row2['tipodetalle']) == 1){

			$sql = "SELECT 
			existencia 
			FROM productos 
			WHERE idproducto = '".$row2['idproducto']."' 
			AND codproducto = '".$row2['codproducto']."' 
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			
			$existenciaBD = $row['existencia'];
			$cantidad     = $row2['cantidad'];

			if ($cantidad > $existenciaBD) 
			{ 
				echo "4";
				exit;
			}

		} elseif(limpiar($row2['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

			$sql = "SELECT 
		    existencia 
		    FROM combos 
		    WHERE idcombo = '".$row2['idproducto']."' 
			AND codcombo = '".limpiar($row2['codproducto'])."'
		    AND codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			$this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $row2['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		       echo "5";
		       exit;
	        }

		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($row2['codproducto'],limpiar(decrypt($_POST['codsucursal2']))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia
	        	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($row2['codproducto'])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."' 
	    	    AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2  = $row['cantidad'];
				    $codproductoBD2 = $row['codproducto'];
				    $existenciaBD2  = $row['existencia'];
			        $racion         = number_format($cantracionBD2*$row2['cantidad'], 2, '.', '');

			        if ($racion > $existenciaBD2) 
			        { 
			        	echo "6";
			        	exit;
			        }
			    }
		    }//fin de consulta de productos de combos	
		   ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

	    }
	}
	###################### VALIDO SI CANTIDAD ES MAYOR QUE EXISTENCIA ######################

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    
    LEFT JOIN
      (SELECT
      codcliente, montocredito       
      FROM creditosxclientes 
      WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."') pag ON pag.codcliente = clientes.codcliente
      WHERE clientes.dnicliente = ? 
      AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento2']),decrypt($_POST['codsucursal2'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono2"]) ? "" : $_POST["formaabono2"]);
    $montoabono        = (empty($_POST["montoabono2"]) ? "0.00" : $_POST["montoabono2"]);
    $total             = number_format($_POST["txtTotal2"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################
    if (limpiar($_POST["tipopago2"]) == "CREDITO") {

    	$fechaactual = date("Y-m-d");
		$fechavence  = date("Y-m-d",strtotime($_POST['fechavencecredito2']));

		if ($codcliente == '0') { 

            echo "7";
            exit;

        } else if (strtotime($fechavence) < strtotime($fechaactual)) {

			echo "8";
			exit;

		} else if ($montoabono != "0.00" && $medioabono == "") {
  
            echo "9";
	        exit;

		} else if ($limitecredito != "0.00" && $total > $creditodisponible) {

            echo "10";
            exit;

        } else if($_POST["montoabono2"] >= $_POST["txtTotal2"]) { 

	        echo "11";
	        exit;
        }
    }
    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################

    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
    if (limpiar($_POST["tipopago2"]) == "CONTADO") {

	   	foreach ($_POST['pagos2'] as $value)
	   	{
			if($value['montopagado'] == "" || $value['montopagado'] == 0.00)	
			{
			    echo "12";
			    exit;
			}
		}

	    if (isset($_POST['pagos2']) && is_array($_POST['pagos2'])) {

    		$formas_pago = array_column($_POST['pagos2'], 'codmediopago');
            if(count($formas_pago) != count(array_unique($formas_pago)))
   	        {
   		        echo "13";
			    exit;
            } 
            else if (count($formas_pago) > 1 && $_POST["txtPagado2"] > $_POST["txtTotal2"])
            {
                echo "14";
                exit;
            }

        } else {

      	    if ($_POST["txtTotal2"] > $_POST["txtPagado2"])
            {
                echo "15";
                exit;
            }
        } 
	}
    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################

    ################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	codsucursal, 
	nroactividadsucursal,
	inicioticket,
	iniciofactura, 
	inicioguia, 
	inicionotaventa 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal2']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nroactividad    = $row['nroactividadsucursal'];
	$inicioticket    = $row['inicioticket'];
	$iniciofactura   = $row['iniciofactura'];
	$inicioguia      = $row['inicioguia'];
	$inicionotaventa = $row['inicionotaventa'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE VENTA ####################
	$sql = "SELECT codventa FROM ventas 
	ORDER BY idventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$venta = $row["codventa"];
	}
	if(empty($venta))
	{
		$codventa = "01";
        $fecha       = date("Y-m-d H:i:s");

	} else {

		$num         = substr($venta, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codventa    = $codigofinal;
        $fecha       = date("Y-m-d H:i:s");
	}
    ################ CREO CODIGO DE VENTA ###############

    ################### CREO CODIGO DE FACTURA ####################
	if($_POST['tipodocumento2'] == "TICKET_5" || $_POST['tipodocumento2'] == "TICKET_8" || $_POST['tipodocumento2'] == "BOLETA_A4") {

	    $sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'TICKET_5' or tipodocumento = 'TICKET_8' or tipodocumento = 'BOLETA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}
		if(empty($factura)){ 
        	$codfactura = "B".$nroactividad.'-'.$inicioticket;
        } else {
            $var        = strlen("B".$nroactividad."-");
            $var1       = substr($factura , $var);
            $var2       = strlen($var1);
            $var3       = $var1 + 1;
            $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "B".$nroactividad.'-'.$var4;
        }
		    $codserie        = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento2'] == "FACTURA" || $_POST['tipodocumento2'] == "FACTURA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'FACTURA' or tipodocumento = 'FACTURA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "F".$nroactividad.'-'.$iniciofactura;
        } else {
            $var        = strlen("F".$nroactividad."-");
            $var1       = substr($factura , $var);
            $var2       = strlen($var1);
            $var3       = $var1 + 1;
            $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "F".$nroactividad.'-'.$var4;
        }
		    $codserie        = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento2'] == "GUIA_REMISION") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE tipodocumento = 'GUIA_REMISION'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "G".$nroactividad.'-'.$inicioguia;
        } else {
            $var        = strlen("G".$nroactividad."-");
            $var1       = substr($factura , $var);
            $var2       = strlen($var1);
            $var3       = $var1 + 1;
            $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "G".$nroactividad.'-'.$var4;
        }
		    $codserie        = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento2'] == "NOTA_VENTA_5" || $_POST['tipodocumento2'] == "NOTA_VENTA_8" || $_POST['tipodocumento2'] == "NOTA_VENTA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'NOTA_VENTA_5' OR tipodocumento = 'NOTA_VENTA_8' OR tipodocumento = 'NOTA_VENTA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
		AND codfactura LIKE 'NV%'
		ORDER BY CAST(SUBSTRING_INDEX(codfactura, '-', -1) AS UNSIGNED) DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura = $row["codfactura"];
		}
        if(empty($factura)){ 
        	$codfactura = "NV".$nroactividad.'-'.$inicionotaventa;
        } else {
            $var        = strlen("NV".$nroactividad."-");
            $var1       = substr($factura , $var);
            $var2       = strlen($var1);
            $var3       = $var1 + 1;
            $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "NV".$nroactividad.'-'.$var4;
        }
		   $codserie        = limpiar($nroactividad);
		   $codautorizacion = limpiar(GenerateRandomStringg());
	}
    ################### CREO CODIGO DE FACTURA ####################

    ################### REGISTRO LA VENTA ####################
    $query = "INSERT INTO ventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codarqueo);
	$stmt->bindParam(3, $codcaja);
	$stmt->bindParam(4, $codventa);
	$stmt->bindParam(5, $codfactura);
	$stmt->bindParam(6, $codserie);
	$stmt->bindParam(7, $codautorizacion);
	$stmt->bindParam(8, $codcliente);
	$stmt->bindParam(9, $exonerado);
	$stmt->bindParam(10, $subtotal);
	$stmt->bindParam(11, $subtotalexento);
	$stmt->bindParam(12, $subtotaliva);
	$stmt->bindParam(13, $iva);
	$stmt->bindParam(14, $totaliva);
	$stmt->bindParam(15, $descontado);
	$stmt->bindParam(16, $descuento);
	$stmt->bindParam(17, $totaldescuento);
	$stmt->bindParam(18, $totalpago);
	$stmt->bindParam(19, $totalpago2);
	$stmt->bindParam(20, $creditopagado);
	$stmt->bindParam(21, $tipopago);
	$stmt->bindParam(22, $formapago);
	$stmt->bindParam(23, $montopagado);
	$stmt->bindParam(24, $montodevuelto);
	$stmt->bindParam(25, $fechavencecredito);
	$stmt->bindParam(26, $fechapagado);
	$stmt->bindParam(27, $statusventa);
	$stmt->bindParam(28, $fechaventa);
	$stmt->bindParam(29, $observaciones);
	$stmt->bindParam(30, $notacredito);
	$stmt->bindParam(31, $codigo);
	$stmt->bindParam(32, $codsucursal);
   
	$tipodocumento   = limpiar($_POST["tipodocumento2"]);
	$codarqueo       = limpiar($codarqueoBD);
	$codcaja         = limpiar($codcajaBD);
	$exonerado       = limpiar($_POST["exonerado2"]);
	$subtotal        = limpiar($_POST["txtsubtotal2"]);
	$subtotalexento  = limpiar($_POST["txtexento2"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva2"]);
	$iva             = limpiar($_POST["iva2"]);
	$totaliva        = limpiar($_POST["txtIva2"]);
	$descontado      = limpiar($_POST["txtdescontado2"]);
	$descuento       = limpiar($_POST["descuento2"]);
	$totaldescuento  = limpiar($_POST["txtDescuento2"]);
	$totalpago       = limpiar($_POST["txtTotal2"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra2"]);
	$creditopagado   = limpiar(isset($_POST['montoabono2']) ? $_POST["montoabono2"] : "0.00");
	$tipopago        = limpiar($_POST["tipopago2"]);

	$montopagado     = '0.00';
    if ($_POST['tipopago2'] == 'CONTADO') {
        
        if (isset($_POST['pagos2']) && is_array($_POST['pagos2'])) {
            $formapago   = 'VARIOS';
            $montopagado = array_reduce($_POST['pagos2'], function ($a, $o) {
               return $a + $o['montopagado'];
            });
        }
        else 
        {
            $formapago   = decrypt($_POST['codmediopago2']);
            $montopagado = limpiar($_POST['montopagado2']);
        }
    }
    else 
    {
        $formapago     = limpiar(decrypt($_POST["formaabono2"]) != "" ? decrypt($_POST["formaabono2"]) : "CREDITO");
    	$montopagado   = limpiar(decrypt($_POST["formaabono2"]) != "" ? $_POST['montoabono2'] : "0.00");
    }
    $montodevuelto     = limpiar(isset($_POST['montodevuelto2']) ? $_POST["montodevuelto2"] : "0.00");

	$fechavencecredito = limpiar($_POST["tipopago2"]=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito2'])) : "0000-00-00");
    $fechapagado       = limpiar("0000-00-00");
    $statusventa       = limpiar($_POST["tipopago2"]=="CONTADO" ? "PAGADA" : "PENDIENTE");
    $fechaventa        = limpiar($fecha);
	$observaciones     = limpiar($_POST["observaciones2"]);
	$notacredito       = limpiar("0");
	$codigo            = limpiar($_SESSION["codigo"]);
	$codsucursal       = limpiar(decrypt($_POST['codsucursal2']));
	$stmt->execute();
	################### REGISTRO LA VENTA ####################

	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################
	if(limpiar($_POST["tipopago2"])=="CONTADO"){

	    $sql  = "INSERT INTO mediospagoxventas VALUES (NULL, ?, ?, ?, ?, ?, ?)";
	    foreach ($_POST['pagos2'] as $pago) {
	        $stmt = $this->dbh->prepare($sql);
	        $stmt->execute([$codarqueoBD, $codcajaBD, $codventa, decrypt($pago['codmediopago']), $pago['montopagado'], $_POST['montodevuelto2']]);
	    }
	}
	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################

	$this->dbh->beginTransaction();
	$sql = "SELECT * FROM detallependientes 
	WHERE codpendiente = '".decrypt($_POST['codpendiente'])."' 
	AND codsucursal = '".decrypt($_POST['codsucursal2'])."'";
    foreach ($this->dbh->query($sql) as $row2)
	{
	
	################### REGISTRO DETALLES DE VENTA ####################
    $query = "INSERT INTO detalleventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codventa);
    $stmt->bindParam(2, $idproducto);
    $stmt->bindParam(3, $codproducto);
    $stmt->bindParam(4, $producto);
    $stmt->bindParam(5, $descripcion);
    $stmt->bindParam(6, $imei);
    $stmt->bindParam(7, $condicion);
    $stmt->bindParam(8, $codmarca);
    $stmt->bindParam(9, $codmodelo);
    $stmt->bindParam(10, $codpresentacion);
    $stmt->bindParam(11, $codcolor);
	$stmt->bindParam(12, $cantidad);
	$stmt->bindParam(13, $preciocompra);
	$stmt->bindParam(14, $precioventa);
	$stmt->bindParam(15, $posicionimpuesto);
	$stmt->bindParam(16, $tipoimpuesto);
	$stmt->bindParam(17, $ivaproducto);
	$stmt->bindParam(18, $descproducto);
	$stmt->bindParam(19, $valortotal);
	$stmt->bindParam(20, $totaldescuentov);
	$stmt->bindParam(21, $subtotalimpuestos);
	$stmt->bindParam(22, $valorneto);
	$stmt->bindParam(23, $valorneto2);
    $stmt->bindParam(24, $tipodetalle);
	$stmt->bindParam(25, $codsucursal);

	$idproducto        = limpiar($row2['idproducto']);
	$codproducto       = limpiar($row2['codproducto']);
	$producto          = limpiar($row2['producto']);
	$descripcion       = limpiar($row2['descripcion']);
	$imei              = limpiar($row2['imei']);
	$condicion         = limpiar($row2['condicion']);
	$codmarca          = limpiar($row2['codmarca']);
	$codmodelo         = limpiar($row2['codmodelo']);
	$codpresentacion   = limpiar($row2['codpresentacion']);
	$codcolor          = limpiar($row2['codcolor']);
	$cantidad          = limpiar($row2['cantidad']);
	$preciocompra      = limpiar($row2['preciocompra']);
	$precioventa       = limpiar($row2['precioventa']);
	$posicionimpuesto  = limpiar($row2['posicionimpuesto']);
	$tipoimpuesto      = limpiar($row2['tipoimpuesto']);
	$ivaproducto       = limpiar($row2['ivaproducto']);
	$descproducto      = limpiar($row2['descproducto']);
	$valortotal        = number_format($row2['valortotal'], 2, '.', '');
	$totaldescuentov   = number_format($row2['totaldescuentov'], 2, '.', '');
	$subtotalimpuestos = number_format($row2['subtotalimpuestos'], 2, '.', '');
    $valorneto         = number_format($row2['valorneto'], 2, '.', '');
    $valorneto2        = number_format($row2['valorneto2'], 2, '.', '');
    $tipodetalle       = limpiar($row2['tipodetalle']);
	$codsucursal       = limpiar(decrypt($_POST["codsucursal2"]));
	$stmt->execute();
	############################### REGISTRO DETALLES DE VENTAS ###############################

	if(limpiar($row2['tipodetalle']) == 1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($row2['idproducto'])."'
		AND codproducto = '".limpiar($row2['codproducto'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($row2['idproducto'])."'
		AND codproducto = '".limpiar($row2['codproducto'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = limpiar($row2['cantidad']);
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcliente    = limpiar($_POST["codcliente2"]);
		$codproducto   = limpiar($row2['codproducto']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($row2['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $row2['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($row2['ivaproducto'] == "0" ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
		$descproducto  = number_format($row2['descproducto'], 2, '.', '');
		$precio        = number_format($row2["precioventa"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($row2['tipodetalle']);
	    $procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal2']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

    } elseif(limpiar($row2['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($row2['idproducto'])."'
		AND codcombo = '".limpiar($row2['codproducto'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
			." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($row2['idproducto'])."'
		    AND codcombo = '".limpiar($row2['codproducto'])."'
	        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($row2['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcliente    = limpiar($_POST["codcliente2"]);
		$codproducto   = limpiar($row2['codproducto']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($row2['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $row2['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($row2['ivaproducto'] == "0" ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
		$descproducto  = number_format($row2['descproducto'], 2, '.', '');
		$precio        = number_format($row2["precioventa"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($row2['tipodetalle']);
	    $procedimiento = limpiar("2");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal2']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($row2['codproducto'],limpiar(decrypt($_POST["codsucursal2"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto  
	    	WHERE combosxproductos.codcombo IN ('".limpiar($row2['codproducto'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$row2['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST['codsucursal2']));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				$stmt = $this->dbh->prepare($query);
				$stmt->bindParam(1, $codventa);
				$stmt->bindParam(2, $codcliente);
				$stmt->bindParam(3, $codproducto);
				$stmt->bindParam(4, $movimiento);
				$stmt->bindParam(5, $entradas);
				$stmt->bindParam(6, $salidas);
				$stmt->bindParam(7, $devolucion);
				$stmt->bindParam(8, $stockactual);
				$stmt->bindParam(9, $ivaproducto);
				$stmt->bindParam(10, $descproducto);
				$stmt->bindParam(11, $precio);
				$stmt->bindParam(12, $documento);
				$stmt->bindParam(13, $fechakardex);	
			    $stmt->bindParam(14, $tipokardex);
			    $stmt->bindParam(15, $procedimiento);			
				$stmt->bindParam(16, $codsucursal);
				$stmt->bindParam(17, $codigo);

				$codcliente    = limpiar($_POST["codcliente2"]);
				$codproducto   = limpiar($codproductoBD2);
				$movimiento    = limpiar("SALIDAS");
				$entradas      = limpiar("0.00");
				$salidas       = number_format($racion, 2, '.', '');
				$devolucion    = limpiar("0.00");
				$stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
				$ivaproducto   = limpiar($ivaproductoBD2 == "0" ? "EXENTO" : $tipoimpuestoBD2." (".$ivaproductoBD2." %)");
				$descproducto  = number_format($descproductoBD2, 2, '.', '');
				$precio        = number_format($precioventaBD2, 2, '.', '');
				$documento     = limpiar("DETALLE DE COMBO VENTA: ".$codfactura);
				$fechakardex   = limpiar(date("Y-m-d H:i:s"));
			    $tipokardex    = limpiar("1");
			    $procedimiento = limpiar("2");
				$codsucursal   = limpiar(decrypt($_POST['codsucursal2']));
		    	$codigo        = limpiar($_SESSION["codigo"]);
				$stmt->execute();
			   ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
    } else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codcliente    = limpiar($_POST["codcliente2"]);
		$codproducto   = limpiar($row2['codproducto']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($row2['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $row2['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($row2['ivaproducto'] == "0" ? "EXENTO" : $row2['tipoimpuesto']." (".$row2['ivaproducto']." %)");
		$descproducto  = number_format($row2['descproducto'], 2, '.', '');
		$precio        = number_format($row2["precioventa"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($row2['tipodetalle']);
	    $procedimiento = limpiar("3");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal2']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
        }
    }
		
	####################### DESTRUYO LA VARIABLE DE SESSION #####################
    $this->dbh->commit();

    ##################### ACTUALIZO FACTURA PENDIENTE A PROCESADO ####################
	$sql = "UPDATE pendientes set "
	." estado = ? "
	." WHERE "
	." codpendiente = '".limpiar(decrypt($_POST["codpendiente"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."';
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $estado);

	$estado = limpiar("2");
	$stmt->execute();
    ##################### ACTUALIZO COTIZACION A PROCESADO ####################

    ################ AGREGAMOS EL INGRESO A CONTADO ##############
	if (limpiar($_POST["tipopago2"]=="CONTADO")){

		$sql = "UPDATE arqueocaja set "
		." ingresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $codarqueo);

		$txtTotal  = number_format($_POST["txtTotal2"]+$ingresoBD, 2, '.', '');
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
	}
    ################ AGREGAMOS EL INGRESO A CONTADO ################

    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################
	if (limpiar($_POST["tipopago2"]=="CREDITO")) {

		$sql = " UPDATE arqueocaja SET "
		." creditos = ?, "
		." abonos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $totalabono);
		$stmt->bindParam(3, $codarqueo);

		$TotalCredito = number_format($_POST["txtTotal2"]-$_POST["montoabono2"], 2, '.', '');
		$txtTotal     = number_format($TotalCredito+$creditoBD, 2, '.', '');
		$totalabono   = number_format($_POST["montoabono2"]+$abonoBD, 2, '.', '');
		$codarqueo    = limpiar($codarqueoBD);
		$stmt->execute();

		$sql = " SELECT codcliente FROM creditosxclientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($codcliente,decrypt($_POST['codsucursal2'])));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			$query = "INSERT INTO creditosxclientes values (null, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcliente);
			$stmt->bindParam(2, $montocredito);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($_POST["txtTotal2"]-$_POST["montoabono2"], 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST['codsucursal2']));
			$stmt->execute();

		} else { 

			$sql = "UPDATE creditosxclientes set"
			." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($montoactual+($_POST["txtTotal2"]-$_POST["montoabono2"]), 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST['codsucursal2']));
			$stmt->execute();
		}

		if (limpiar($_POST["montoabono2"]!="0.00" && $_POST["montoabono2"]!="0" && $_POST["montoabono2"]!="")) {

			######################### CODIGO DE ABONO #########################
	        $sql = "SELECT 
			codabono 
			FROM abonoscreditosventas 
			ORDER BY idabono 
			DESC LIMIT 1";
			foreach ($this->dbh->query($sql) as $row)
			{
				$num=$row["codabono"];
			}
			$codabono = (empty($num) ? "1" : $num + 1);
            ######################### CODIGO DE ABONO #########################

            ################### CODIGO DE CREDITO ABONO ####################
			$sql4 = "SELECT codcredito FROM abonoscreditosventas 
			WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal2"]))."' 
			ORDER BY idabono DESC LIMIT 1";
			foreach ($this->dbh->query($sql4) as $row4){

				$id = $row4["codcredito"];
			}
			if(empty($id))
			{
				$codcredito = "0000001";

			} else {

				$var        = strlen("");
		        $var1       = substr($id , $var);
		        $var2       = strlen($var1);
		        $var3       = $var1 + 1;
		        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
		        $codcredito = $var4;
			}
			################### CODIGO DE CREDITO ABONO ####################

			######################### REGISTRO ABONO DE CREDITO #########################
            $query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codabono);
			$stmt->bindParam(2, $codcredito);
			$stmt->bindParam(3, $codarqueo);
			$stmt->bindParam(4, $codcaja);
			$stmt->bindParam(5, $codventa);
			$stmt->bindParam(6, $codcliente);
			$stmt->bindParam(7, $montoabono);
			$stmt->bindParam(8, $formaabono);
			$stmt->bindParam(9, $codbanco);
			$stmt->bindParam(10, $comprobante);
			$stmt->bindParam(11, $fechaabono);
			$stmt->bindParam(12, $codsucursal);

			$codarqueo   = limpiar($codarqueoBD);
			$codcaja     = limpiar($codcajaBD);
			$montoabono  = number_format($_POST["montoabono2"], 2, '.', '');
			$formaabono  = decrypt($_POST["formaabono2"]);
			$codbanco    = limpiar("0");
			$comprobante = limpiar("0");
			$fechaabono  = limpiar($fecha);
			$codsucursal = limpiar(decrypt($_POST["codsucursal2"]));
			$stmt->execute();
			######################### REGISTRO ABONO DE CREDITO #########################
		}
	}
    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################

    echo "<span class='fa fa-check-square-o'></span> LA VENTA DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
############################# FUNCION COBRAR FACTURA ###############################



########################## FUNCION LISTAR FACTURAS PENDIENTES ################################
public function ListarFacturasPendientes()
{
	self::SetNames();
    $sql = "SELECT 
	pendientes.idpendiente, 
	pendientes.codpendiente,
	pendientes.codfactura, 
	pendientes.codcliente,
	pendientes.exonerado, 
	pendientes.subtotal,
	pendientes.subtotalexento, 
	pendientes.subtotaliva, 
	pendientes.iva, 
	pendientes.totaliva, 
	pendientes.descontado, 
	pendientes.descuento, 
	pendientes.totaldescuento, 
	pendientes.totalpago, 
	pendientes.totalpago2,
	pendientes.estado, 
	pendientes.fechapendiente,
	pendientes.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='JURIDICO',clientes.razoncliente,clientes.nomcliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	SUM(detallependientes.cantidad) AS articulos 
	FROM (pendientes LEFT JOIN detallependientes ON detallependientes.codpendiente = pendientes.codpendiente)
	LEFT JOIN sucursales ON pendientes.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON pendientes.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN usuarios ON pendientes.codigo = usuarios.codigo
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE pendientes.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND pendientes.estado = 1
	GROUP BY 
	pendientes.idpendiente, 
	pendientes.codpendiente,
	pendientes.codfactura, 
	pendientes.codcliente,
	pendientes.exonerado, 
	pendientes.subtotal,
	pendientes.subtotalexento, 
	pendientes.subtotaliva, 
	pendientes.iva, 
	pendientes.totaliva, 
	pendientes.descontado, 
	pendientes.descuento, 
	pendientes.totaldescuento, 
	pendientes.totalpago, 
	pendientes.totalpago2,
	pendientes.estado, 
	pendientes.fechapendiente,
	pendientes.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY pendientes.codfactura ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION LISTAR FACTURAS PENDIENTES ############################

############################ FUNCION ID FACTURA PENDIENTE #################################
public function FacturaPendientePorId()
{
	self::SetNames();
	$sql = "SELECT 
	pendientes.idpendiente, 
	pendientes.codpendiente,
	pendientes.codfactura, 
	pendientes.codcliente,
	pendientes.exonerado, 
	pendientes.subtotal,
	pendientes.subtotalexento, 
	pendientes.subtotaliva, 
	pendientes.iva, 
	pendientes.totaliva, 
	pendientes.descontado, 
	pendientes.descuento, 
	pendientes.totaldescuento, 
	pendientes.totalpago, 
	pendientes.totalpago2,
	pendientes.estado, 
	pendientes.fechapendiente,
	pendientes.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='JURIDICO',clientes.razoncliente,clientes.nomcliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
    usuarios.dni, 
    usuarios.nombres,
    provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2
    FROM (pendientes LEFT JOIN sucursales ON pendientes.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN clientes ON pendientes.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento 
	LEFT JOIN usuarios ON pendientes.codigo = usuarios.codigo
    WHERE pendientes.codpendiente = ? AND pendientes.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpendiente"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID FACTURA PENDIENTE #################################

########################### FUNCION VER DETALLES FACTURA PENDIENTES ##########################
public function VerDetallesFacturaPendientes()
{
	self::SetNames();
	$sql = "SELECT
	detallependientes.coddetallependiente,
	detallependientes.codpendiente,
	detallependientes.idproducto,
	detallependientes.codproducto,
	detallependientes.producto,
	detallependientes.descripcion,
	detallependientes.imei,
	detallependientes.condicion,
	detallependientes.codmarca,
	detallependientes.codmodelo,
	detallependientes.codpresentacion,
	detallependientes.codcolor,
	detallependientes.cantidad,
	detallependientes.preciocompra,
	detallependientes.precioventa,
	detallependientes.posicionimpuesto,
	detallependientes.tipoimpuesto,
	detallependientes.ivaproducto,
	detallependientes.descproducto,
	detallependientes.valortotal, 
	detallependientes.totaldescuentov,
	detallependientes.subtotalimpuestos,
	detallependientes.valorneto,
	detallependientes.valorneto2,
	detallependientes.tipodetalle,
	detallependientes.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallependientes
	LEFT JOIN marcas ON detallependientes.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallependientes.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detallependientes.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallependientes.codcolor = colores.codcolor 
	WHERE detallependientes.codpendiente = ? 
	AND detallependientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpendiente"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION VER DETALLES FACTURA PENDIENTES #######################

########################### FUNCION ELIMINAR DETALLES FACTURAS PENDIENTES ###########################
public function EliminarDetallesFacturasPendientes()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS" || $_SESSION["acceso"]=="secretaria" || $_SESSION["acceso"]=="cajero") {

    ############ CONSULTO TOTAL ACTUAL DE FACTURA PENDIENTE ##############
	$sql = "SELECT
	codfactura, 
	codcliente, 
	exonerado,
	iva,
	descuento, 
	totalpago
	FROM pendientes WHERE codpendiente = '".limpiar(decrypt($_GET["codpendiente"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD    = $row['codfactura'];
	$codclienteBD    = $row['codcliente'];
	$exoneradoBD     = $row['exonerado'];
	$ivaBD           = $row["iva"];
	$descuentoBD     = $row["descuento"];
	$totalpagoBD     = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE FACTURA PENDIENTE ##############

	$sql = "SELECT * FROM detallependientes WHERE codpendiente = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codpendiente"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		$sql = "SELECT
		idproducto, 
		codproducto,
		imei, 
		cantidad, 
		precioventa,
		posicionimpuesto,
		tipoimpuesto, 
		ivaproducto, 
		descproducto, 
		tipodetalle 
		FROM detallependientes 
		WHERE coddetallependiente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["coddetallependiente"]),decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$idproductoBD       = $row['idproducto'];
		$codproductoBD      = $row['codproducto'];
		$cantidadBD         = $row['cantidad'];
		$precioventaBD      = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD     = $row['tipoimpuesto'];
		$ivaproductoBD      = $row['ivaproducto'];
		$descproductoBD     = $row['descproducto'];
		$tipodetalleBD      = $row['tipodetalle'];

		################## ELIMINO DETALLE DE FACTURA PENDIENTE ##################
		$sql = "DELETE FROM detallependientes WHERE coddetallependiente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetallependiente);
		$stmt->bindParam(2,$codsucursal);
		$coddetallependiente = decrypt($_GET["coddetallependiente"]);
		$codsucursal         = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE FACTURA PENDIENTE ##################

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallependientes WHERE codpendiente = '".limpiar(decrypt($_GET["codpendiente"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detallependientes WHERE codpendiente = '".limpiar(decrypt($_GET["codpendiente"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

        ############ ACTUALIZO LOS TOTALES EN LA VENTA ##############
		$sql = "UPDATE pendientes SET "
		." subtotal = ?, "
		." subtotalexento = ?, "
		." subtotaliva = ?, "
		." totaliva = ?, "
		." descontado = ?, "
		." totaldescuento = ?, "
		." totalpago = ?, "
		." totalpago2= ? "
		." WHERE "
		." codpendiente = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $totalpago);
		$stmt->bindParam(8, $totalpago2);
		$stmt->bindParam(9, $codpendiente);
		$stmt->bindParam(10, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento  = $descuentoBD;
	    $Porcentaje = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva        = $ivaBD;
	    $PorcentajeIva = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $totalpago         = ($exoneradoBD == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/
		
		$codpendiente = limpiar(decrypt($_GET["codpendiente"]));
		$codsucursal  = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN LA VENTA ##############

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	} 

	} else {
		
		echo "3";
		exit;
	}	
}
######################## FUNCION ELIMINAR DETALLES FACTURAS PENDIENTES ########################

####################### FUNCION ELIMINAR FACTURAS PENDIENTES #################################
public function EliminarFacturasPendientes()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS" || $_SESSION["acceso"]=="secretaria" || $_SESSION["acceso"]=="cajero" || $_SESSION["acceso"]=="vendedor") {

		################## ELIMINO PENDIENTE ##################
		$sql = "DELETE FROM pendientes WHERE codpendiente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpendiente);
		$stmt->bindParam(2,$codsucursal);
		$codpendiente = decrypt($_GET["codpendiente"]);
		$codsucursal  = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO PENDIENTE ##################

		################## ELIMINO DETALLE DE PENDIENTE ##################
		$sql = "DELETE FROM detallependientes WHERE codpendiente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codpendiente);
		$stmt->bindParam(2,$codsucursal);
		$codpendiente = decrypt($_GET["codpendiente"]);
		$codsucursal  = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE PENDIENTE ##################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
###################### FUNCION ELIMINAR FACTURAS PENDIENTES #################################

###################################### CLASE FACTURAS PENDIENTES ###################################



















###################################### CLASE VENTAS ###################################

############################# FUNCION REGISTRAR VENTAS ###############################
public function RegistrarVentas()
{
	self::SetNames();
	if(limpiar($_POST["tipoproceso"]) == '1'){

	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

    }

	if(empty($_POST["codsucursal"]) or empty($_POST["tipodocumento"]) or empty($_POST["tipopago"]))
	{
		echo "2";
		exit;
	}
	elseif(empty($_SESSION["CarritoVenta"]) || $_POST["txtTotal"] == 0.00)
	{
		echo "3";
		exit;	
	}

	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
	$v = $_SESSION["CarritoVenta"];
    for ($i = 0, $iMax = count($v); $i < $iMax; $i++) {

		if(limpiar($v[$i]['tipodetalle'])==1){

			// Obtengo datos del producto incluyendo info del padre si es HIJO
			$sql = "SELECT 
			productos.existencia,
			productos.tipo_producto,
			productos.producto_padre_id,
			productos.cantidad_conversion,
			productos.usa_inventario,
			producto_padre.existencia AS padre_existencia
			FROM productos 
			LEFT JOIN productos AS producto_padre ON productos.producto_padre_id = producto_padre.idproducto
			WHERE productos.idproducto = '".limpiar($v[$i]['id'])."' 
			AND productos.codproducto = '".limpiar($v[$i]['txtCodigo'])."' 
			AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			
			$existenciaBD = $row['existencia'];
			$tipoProducto = isset($row['tipo_producto']) ? $row['tipo_producto'] : 'SIMPLE';
			$cantidadConversion = isset($row['cantidad_conversion']) ? $row['cantidad_conversion'] : 1;
			$padreExistencia = isset($row['padre_existencia']) ? $row['padre_existencia'] : 0;
			$usaInventario = isset($row['usa_inventario']) ? $row['usa_inventario'] : 'SI';
			$cantidad     = $v[$i]['cantidad'];

			// Si es servicio (no usa inventario), no validar existencia
			if ($usaInventario == 'NO') {
				continue; // Saltar validación para servicios
			}

			// Si es producto HIJO, validamos contra el stock del PADRE
			if ($tipoProducto == 'HIJO' && $row['producto_padre_id']) {
				$cantidadRequerida = $cantidad * $cantidadConversion;
				if ($cantidadRequerida > $padreExistencia) 
				{ 
					echo "4"; // Existencia insuficiente
					exit;
				}
			} else {
				// Producto SIMPLE o PADRE: validación normal
				if ($cantidad > $existenciaBD) 
				{ 
					echo "4";
					exit;
				}
			}

		} elseif(limpiar($v[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

			$sql = "SELECT 
		    existencia 
		    FROM combos 
		    WHERE idcombo = '".limpiar($v[$i]['id'])."' 
			AND codcombo = '".limpiar($v[$i]['txtCodigo'])."'
		    AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
		    foreach ($this->dbh->query($sql) as $row)
		    {
			   $this->p[] = $row;
		    }
		
		    $existenciaBD = $row['existencia'];
		    $cantidad     = $v[$i]['cantidad'];

	        if ($cantidad > $existenciaBD) 
	        { 
		        echo "5";
		        exit;
	        }

		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($v[$i]['txtCodigo'],limpiar(decrypt($_POST['codsucursal']))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia
	        	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($v[$i]['txtCodigo'])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."' 
	    	    AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				   $this->p[] = $row;

				    $cantracionBD2  = $row['cantidad'];
				    $idproductoBD2  = $row['idproducto'];
				    $codproductoBD2 = $row['codproducto'];
				    $existenciaBD2  = $row['existencia'];
			        $racion         = number_format($cantracionBD2*$v[$i]['cantidad'], 2, '.', '');

			        if ($racion > $existenciaBD2) 
			        { 
			        	echo "6";
			        	exit;
			        }
			    }
		    }//fin de consulta de productos de combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    }
	}
	############ VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    
    LEFT JOIN
      (SELECT
      codcliente, montocredito       
      FROM creditosxclientes 
      WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."') pag ON pag.codcliente = clientes.codcliente
      WHERE clientes.dnicliente = ? 
      AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono"]) ? "" : $_POST["formaabono"]);
    $montoabono        = (empty($_POST["montoabono"]) ? "0.00" : $_POST["montoabono"]);
    $total             = number_format($_POST["txtTotal"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################
    if (limpiar($_POST["tipoproceso"]) == 1 && limpiar($_POST["tipopago"]) == "CREDITO") {

    	$fechaactual = date("Y-m-d");
		$fechavence = date("Y-m-d",strtotime($_POST['fechavencecredito']));

		if ($codcliente == '0') { 

         echo "7";
         exit;

      } else if (strtotime($fechavence) < strtotime($fechaactual)) {

			echo "8";
			exit;

		} else if ($montoabono != "0.00" && $medioabono == "") {
  
         echo "9";
	      exit;

		} else if ($limitecredito != "0.00" && $total > $creditodisponible) {

         echo "10";
         exit;

      } else if($_POST["montoabono"] >= $_POST["txtTotal"]) { 

	      echo "11";
	      exit;
      }
   }
   ################### VALIDO TIPO DE PAGO ES A CREDITO ######################

   ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
   if (limpiar($_POST["tipoproceso"]) == 1 && limpiar($_POST["tipopago"]) == "CONTADO") {

	   	foreach ($_POST['pagos'] as $value)
	   	{
			if($value['montopagado'] == "" || $value['montopagado'] == 0.00)	
			{
			    echo "12";
			    exit;
			}
		}

	    if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {

    		$formas_pago = array_column($_POST['pagos'], 'codmediopago');
            if(count($formas_pago) != count(array_unique($formas_pago)))
   	        {
   		        echo "13";
			    exit;
            } 
            else if (count($formas_pago) > 1 && $_POST["txtPagado"] > $_POST["txtTotal"])
            {
                echo "14";
                exit;
            }

        } else {

      	    if ($_POST["txtTotal"] > $_POST["txtPagado"])
            {
                echo "15";
                exit;
            }
        } 
	}
    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################

	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	codsucursal, 
	nroactividadsucursal,
	inicioticket,
	iniciofactura, 
	inicioguia, 
	inicionotaventa 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$nroactividad    = $row['nroactividadsucursal'];
	$inicioticket    = $row['inicioticket'];
	$iniciofactura   = $row['iniciofactura'];
	$inicioguia      = $row['inicioguia'];
	$inicionotaventa = $row['inicionotaventa'];
	################# OBTENGO DATOS DE SUCURSAL #################

	if(limpiar($_POST["tipoproceso"]) == 1){//SI SE COBRARA LA VENTA

	################ CREO CODIGO DE VENTA ####################
	$sql = "SELECT codventa FROM ventas 
	ORDER BY idventa DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$venta = $row["codventa"];
	}
	if(empty($venta))
	{
		$codventa = "01";
        $fecha       = date("Y-m-d H:i:s");

	} else {

		$num         = substr($venta, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codventa    = $codigofinal;
        $fecha       = date("Y-m-d H:i:s");
	}
    ################ CREO CODIGO DE VENTA ###############

    ################### CREO CODIGO DE FACTURA ####################
	if($_POST['tipodocumento'] == "TICKET_5" || $_POST['tipodocumento'] == "TICKET_8" || $_POST['tipodocumento'] == "BOLETA_A4") {

	    $sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'TICKET_5' or tipodocumento = 'TICKET_8' or tipodocumento = 'BOLETA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}
		if(empty($factura)){ 
        	$codfactura = "B".$nroactividad.'-'.$inicioticket;
        } else {
            $var = strlen("B".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "B".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "FACTURA" || $_POST['tipodocumento'] == "FACTURA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'FACTURA' or tipodocumento = 'FACTURA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "F".$nroactividad.'-'.$iniciofactura;
        } else {
            $var = strlen("F".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "F".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "GUIA_REMISION") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE tipodocumento = 'GUIA_REMISION'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		ORDER BY idventa DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}

        if(empty($factura)){ 
        	$codfactura = "G".$nroactividad.'-'.$inicioguia;
        } else {
            $var = strlen("G".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "G".$nroactividad.'-'.$var4;
        }
		    $codserie = limpiar($nroactividad);
		    $codautorizacion = limpiar(GenerateRandomStringg());

	} elseif($_POST['tipodocumento'] == "NOTA_VENTA_5" || $_POST['tipodocumento'] == "NOTA_VENTA_8" || $_POST['tipodocumento'] == "NOTA_VENTA_A4") {

		$sql = "SELECT 
		codfactura 
		FROM ventas 
		WHERE (tipodocumento = 'NOTA_VENTA_5' OR tipodocumento = 'NOTA_VENTA_8' OR tipodocumento = 'NOTA_VENTA_A4')
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		AND codfactura LIKE 'NV%'
		ORDER BY CAST(SUBSTRING_INDEX(codfactura, '-', -1) AS UNSIGNED) DESC LIMIT 1";
		foreach ($this->dbh->query($sql) as $row){

			$factura=$row["codfactura"];
		}
        if(empty($factura)){ 
        	$codfactura = "NV".$nroactividad.'-'.$inicionotaventa;
        } else {
            $var = strlen("NV".$nroactividad."-");
            $var1 = substr($factura , $var);
            $var2 = strlen($var1);
            $var3 = $var1 + 1;
            $var4 = str_pad($var3, $var2, "0", STR_PAD_LEFT);
            $codfactura = "NV".$nroactividad.'-'.$var4;
        }
		   $codserie = limpiar($nroactividad);
		   $codautorizacion = limpiar(GenerateRandomStringg());
	}
    ################### CREO CODIGO DE FACTURA ####################

    ################### REGISTRO LA VENTA ####################
    $query = "INSERT INTO ventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";

	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $tipodocumento);
	$stmt->bindParam(2, $codarqueo);
	$stmt->bindParam(3, $codcaja);
	$stmt->bindParam(4, $codventa);
	$stmt->bindParam(5, $codfactura);
	$stmt->bindParam(6, $codserie);
	$stmt->bindParam(7, $codautorizacion);
	$stmt->bindParam(8, $codcliente);
	$stmt->bindParam(9, $exonerado);
	$stmt->bindParam(10, $subtotal);
	$stmt->bindParam(11, $subtotalexento);
	$stmt->bindParam(12, $subtotaliva);
	$stmt->bindParam(13, $iva);
	$stmt->bindParam(14, $totaliva);
	$stmt->bindParam(15, $descontado);
	$stmt->bindParam(16, $descuento);
	$stmt->bindParam(17, $totaldescuento);
	$stmt->bindParam(18, $totalpago);
	$stmt->bindParam(19, $totalpago2);
	$stmt->bindParam(20, $creditopagado);
	$stmt->bindParam(21, $tipopago);
	$stmt->bindParam(22, $formapago);
	$stmt->bindParam(23, $montopagado);
	$stmt->bindParam(24, $montodevuelto);
	$stmt->bindParam(25, $fechavencecredito);
	$stmt->bindParam(26, $fechapagado);
	$stmt->bindParam(27, $statusventa);
	$stmt->bindParam(28, $fechaventa);
	$stmt->bindParam(29, $observaciones);
	$stmt->bindParam(30, $notacredito);
	$stmt->bindParam(31, $codigo);
	$stmt->bindParam(32, $codsucursal);
   
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$codarqueo       = limpiar($codarqueoBD);
	$codcaja         = limpiar($codcajaBD);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$creditopagado   = limpiar(isset($_POST['montoabono']) ? $_POST["montoabono"] : "0.00");
	$tipopago        = limpiar($_POST["tipopago"]);

	$montopagado     = '0.00';
    if ($_POST['tipopago'] == 'CONTADO') {
        
        if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {
            $formapago   = 'VARIOS';
            $montopagado = array_reduce($_POST['pagos'], function ($a, $o) {
               return $a + $o['montopagado'];
            });
        }
        else 
        {
            $formapago   = decrypt($_POST['codmediopago']);
            $montopagado = limpiar($_POST['montopagado']);
        }
    }
    else 
    {
        $formapago     = limpiar(decrypt($_POST["formaabono"]) != "" ? decrypt($_POST["formaabono"]) : "CREDITO");
    	$montopagado   = limpiar(decrypt($_POST["formaabono"]) != "" ? $_POST['montoabono'] : "0.00");
    }
    $montodevuelto     = limpiar(isset($_POST['montodevuelto']) ? $_POST["montodevuelto"] : "0.00");

	$fechavencecredito = limpiar($_POST["tipopago"]=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
    $fechapagado       = limpiar("0000-00-00");
    $statusventa       = limpiar($_POST["tipopago"]=="CONTADO" ? "PAGADA" : "PENDIENTE");
    $fechaventa        = limpiar($fecha);
	$observaciones     = limpiar($_POST["observaciones"]);
	$notacredito       = limpiar("0");
	$codigo            = limpiar($_SESSION["codigo"]);
	$codsucursal       = limpiar(decrypt($_POST['codsucursal']));
	$stmt->execute();
	################### REGISTRO LA VENTA ####################

	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################
	if(limpiar($_POST["tipopago"])=="CONTADO"){

	    $sql  = "INSERT INTO mediospagoxventas VALUES (NULL, ?, ?, ?, ?, ?, ?)";
	    foreach ($_POST['pagos'] as $pago) {
	        $stmt = $this->dbh->prepare($sql);
	        $stmt->execute([$codarqueoBD, $codcajaBD, $codventa, decrypt($pago['codmediopago']), $pago['montopagado'], $_POST['montodevuelto']]);
	    }
	}
	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################

	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoVenta"];
    for ($i = 0, $iMax = count($detalle); $i < $iMax; $i++) {

	################### REGISTRO DETALLES DE VENTA ####################
    $query = "INSERT INTO detalleventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codventa);
    $stmt->bindParam(2, $idproducto);
    $stmt->bindParam(3, $codproducto);
    $stmt->bindParam(4, $producto);
    $stmt->bindParam(5, $descripcion);
    $stmt->bindParam(6, $imei);
    $stmt->bindParam(7, $condicion);
    $stmt->bindParam(8, $codmarca);
    $stmt->bindParam(9, $codmodelo);
    $stmt->bindParam(10, $codpresentacion);
    $stmt->bindParam(11, $codcolor);
	$stmt->bindParam(12, $cantidad);
	$stmt->bindParam(13, $preciocompra);
	$stmt->bindParam(14, $precioventa);
	$stmt->bindParam(15, $posicionimpuesto);
	$stmt->bindParam(16, $tipoimpuesto);
	$stmt->bindParam(17, $ivaproducto);
	$stmt->bindParam(18, $descproducto);
	$stmt->bindParam(19, $valortotal);
	$stmt->bindParam(20, $totaldescuentov);
	$stmt->bindParam(21, $subtotalimpuestos);
	$stmt->bindParam(22, $valorneto);
	$stmt->bindParam(23, $valorneto2);
    $stmt->bindParam(24, $tipodetalle);
	$stmt->bindParam(25, $codsucursal);
		
	$idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
	$codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
	$producto        = limpiar($detalle[$i]['producto']);
	$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	$imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
	$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
	$codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
	$codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
	$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
	$cantidad        = limpiar($detalle[$i]['cantidad']);
	$preciocompra    = limpiar($detalle[$i]['precio']);
	$precioventa     = limpiar($detalle[$i]['precio2']);
	$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
	$descproducto    = limpiar($detalle[$i]['descproducto']);
	$descuento       = $detalle[$i]['descproducto']/100;
	$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
	$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

	//CALCULO SUBTOTAL IMPUESTOS
	if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
	$subtotalimpuestos    = "0.00";
	} else {
	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
	$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
	$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
	$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
    }

    $valorneto = number_format($valortotal-$totaldescuentov, 2, '.', '');
	$valorneto2 = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
    $tipodetalle = limpiar($detalle[$i]['tipodetalle']);
	$codsucursal = limpiar(decrypt($_POST['codsucursal']));
	$stmt->execute();
	################### REGISTRO DETALLES DE VENTA ####################

	################### ACTUALIZO EL ESTADO DE IMEI ###################
	if($detalle[$i]['opcionimei'] == "SI"){

		$valoresArray = explode(',', $detalle[$i]['imei']);
	    $sql = "UPDATE imei SET estadoimei = ?
		WHERE numeroimei IN (".implode(',', $valoresArray).") 
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $estadoimei);
		$estadoimei = "3";
		$stmt->execute();
	}
	################### ACTUALIZO EL ESTADO DE IMEI ###################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT productos.*, 
		producto_padre.idproducto AS padre_idproducto,
		producto_padre.codproducto AS padre_codproducto,
		producto_padre.existencia AS padre_existencia
		FROM productos 
		LEFT JOIN productos AS producto_padre ON productos.producto_padre_id = producto_padre.idproducto
		WHERE productos.idproducto = '".limpiar($detalle[$i]['id'])."'
		AND productos.codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		$tipoProductoBD = isset($row['tipo_producto']) ? $row['tipo_producto'] : 'SIMPLE';
		$cantidadConversionBD = isset($row['cantidad_conversion']) ? $row['cantidad_conversion'] : 1;
		$padreIdProductoBD = isset($row['padre_idproducto']) ? $row['padre_idproducto'] : null;
		$padreCodProductoBD = isset($row['padre_codproducto']) ? $row['padre_codproducto'] : null;
		$padreExistenciaBD = isset($row['padre_existencia']) ? $row['padre_existencia'] : 0;
		$usaInventarioBD = isset($row['usa_inventario']) ? $row['usa_inventario'] : 'SI';
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		// Si es servicio (no usa inventario), no actualizar stock ni registrar kardex
		if ($usaInventarioBD == 'NO') {
			// Servicio: no hacer nada con el inventario
			$codproductoKardex = null; // Marcador para no registrar kardex
		}
		// Si es producto HIJO, descontamos del PADRE
		elseif ($tipoProductoBD == 'HIJO' && $padreIdProductoBD) {
			$cantidadDescontar = number_format($detalle[$i]['cantidad'] * $cantidadConversionBD, 2, '.', '');
			$sql = "UPDATE productos set "
			." existencia = ? "
			." WHERE "
			." idproducto = '".limpiar($padreIdProductoBD)."'
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$existencia = number_format($padreExistenciaBD - $cantidadDescontar, 2, '.', '');
			$stmt->execute();
			
			// Variables para el kardex (registramos en el PADRE)
			$codproductoKardex = $padreCodProductoBD;
			$stockactualKardex = $existencia;
			$salidasKardex = $cantidadDescontar;
			$documentoKardex = "VENTA: ".$codfactura." (HIJO: ".$detalle[$i]['txtCodigo']." x ".$detalle[$i]['cantidad'].")";
		} else {
			// Producto SIMPLE o PADRE: descuento normal
			$sql = "UPDATE productos set "
			." existencia = ? "
			." WHERE "
			." idproducto = '".limpiar($detalle[$i]['id'])."'
			AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$cantidad   = limpiar($detalle[$i]['cantidad']);
			$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
			$stmt->execute();
			
			// Variables para el kardex
			$codproductoKardex = $detalle[$i]['txtCodigo'];
			$stockactualKardex = $existencia;
			$salidasKardex = number_format($detalle[$i]['cantidad'], 2, '.', '');
			$documentoKardex = "VENTA: ".$codfactura;
		}
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    // Solo registrar kardex si no es un servicio (usa inventario)
	    if ($codproductoKardex !== null) {
	    // Registramos el kardex en el producto que maneja el stock (PADRE si es HIJO, o el mismo si es SIMPLE/PADRE)
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($codproductoKardex);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = $salidasKardex;
		$devolucion    = limpiar("0.00");
		$stockactual   = $stockactualKardex;
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar($documentoKardex);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
	    } // Fin de condición para servicios
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

    } elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."'
		AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
			." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($detalle[$i]['id'])."'
		    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	        AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD-$cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);						
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST['codsucursal']))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST['codsucursal']));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	            $stmt->bindParam(15, $procedimiento);			
	            $stmt->bindParam(16, $codsucursal);
		        $stmt->bindParam(17, $codigo);		

			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("VENTA (DETALLE DE COMBO): ".$codfactura);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	            $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST['codsucursal']));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
    } else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);					
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfactura);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("3");
		$codsucursal   = limpiar(decrypt($_POST['codsucursal']));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
       }
    }
		
	####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoVenta"]);
    $this->dbh->commit();

    ################ AGREGAMOS EL INGRESO A CONTADO ##############
	if (limpiar($_POST["tipopago"]=="CONTADO")){

		$sql = "UPDATE arqueocaja set "
		." ingresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $codarqueo);

		$txtTotal  = number_format($_POST["txtTotal"]+$ingresoBD, 2, '.', '');
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
	}
    ################ AGREGAMOS EL INGRESO A CONTADO ################

    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################
	if (limpiar($_POST["tipopago"]=="CREDITO")) {

		$sql = " UPDATE arqueocaja SET "
		." creditos = ?, "
		." abonos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $totalabono);
		$stmt->bindParam(3, $codarqueo);

		$TotalCredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
		$txtTotal     = number_format($TotalCredito+$creditoBD, 2, '.', '');
		$totalabono   = number_format($_POST["montoabono"]+$abonoBD, 2, '.', '');
		$codarqueo    = limpiar($codarqueoBD);
		$stmt->execute();

		$sql = " SELECT codcliente FROM creditosxclientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($codcliente,decrypt($_POST['codsucursal'])));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			$query = "INSERT INTO creditosxclientes values (null, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcliente);
			$stmt->bindParam(2, $montocredito);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
			$stmt->execute();

		} else { 

			$sql = "UPDATE creditosxclientes set"
			." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($montoactual+($_POST["txtTotal"]-$_POST["montoabono"]), 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
			$stmt->execute();
		}

		if (limpiar($_POST["montoabono"]!="0.00" && $_POST["montoabono"]!="0" && $_POST["montoabono"]!="")) {

			######################### CODIGO DE ABONO #########################
	        $sql = "SELECT 
			codabono 
			FROM abonoscreditosventas 
			ORDER BY idabono 
			DESC LIMIT 1";
			foreach ($this->dbh->query($sql) as $row)
			{
				$num=$row["codabono"];
			}
			$codabono = (empty($num) ? "1" : $num + 1);
            ######################### CODIGO DE ABONO #########################

            ################### CODIGO DE CREDITO ABONO ####################
			$sql4 = "SELECT codcredito FROM abonoscreditosventas 
			WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
			ORDER BY idabono DESC LIMIT 1";
			foreach ($this->dbh->query($sql4) as $row4){

				$id = $row4["codcredito"];
			}
			if(empty($id))
			{
				$codcredito = "0000001";

			} else {

				$var        = strlen("");
		        $var1       = substr($id , $var);
		        $var2       = strlen($var1);
		        $var3       = $var1 + 1;
		        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
		        $codcredito = $var4;
			}
			################### CODIGO DE CREDITO ABONO ####################

			######################### REGISTRO ABONO DE CREDITO #########################
            $query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codabono);
			$stmt->bindParam(2, $codcredito);
			$stmt->bindParam(3, $codarqueo);
			$stmt->bindParam(4, $codcaja);
			$stmt->bindParam(5, $codventa);
			$stmt->bindParam(6, $codcliente);
			$stmt->bindParam(7, $montoabono);
			$stmt->bindParam(8, $formaabono);
			$stmt->bindParam(9, $codbanco);
			$stmt->bindParam(10, $comprobante);
			$stmt->bindParam(11, $fechaabono);
			$stmt->bindParam(12, $codsucursal);

			$codarqueo   = limpiar($codarqueoBD);
			$codcaja     = limpiar($codcajaBD);
			$montoabono  = number_format($_POST["montoabono"], 2, '.', '');
			$formaabono  = decrypt($_POST["formaabono"]);
			$codbanco    = limpiar("0");
			$comprobante = limpiar("0");
			$fechaabono  = limpiar($fecha);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			######################### REGISTRO ABONO DE CREDITO #########################
		}
	}
    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################

    echo "<span class='fa fa-check-square-o'></span> LA VENTA DE PRODUCTOS HA SIDO REGISTRADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;

	} elseif(limpiar($_POST["tipoproceso"]) == 2){

	####################### OBTENGO DATOS DE PENDIENTE #######################
	$sql = "SELECT
	codpendiente, 
	codfactura 
	FROM pendientes 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'  
	ORDER BY idpendiente DESC LIMIT 1";
	foreach ($this->dbh->query($sql) AS $row){

		$pendiente = $row["codpendiente"];
		$factura   = $row["codfactura"];
	}
	####################### OBTENGO DATOS DE PENDIENTE #######################
	
	####################### CODIGO PENDIENTE #######################
	if(empty($pendiente))
	{
		$codpendiente   = "1";
        $codfactura     = "00000001";
        $fecha        = date("Y-m-d H:i:s");

	} else {

		$var          = strlen("");
        $var1         = substr($factura , $var);
        $var2         = strlen($var1);
        $var3         = $var1 + 1;
        $var4         = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codpendiente = $pendiente + 1;
        $codfactura   = $var4;
        $fecha        = date("Y-m-d H:i:s");
	}
	####################### CODIGO PENDIENTE #######################

	################### REGISTRO LA VENTA PENDIENTE ####################
    $query = "INSERT INTO pendientes values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codpendiente);
	$stmt->bindParam(2, $codfactura);
	$stmt->bindParam(3, $codcliente);
	$stmt->bindParam(4, $exonerado);
	$stmt->bindParam(5, $subtotal);
	$stmt->bindParam(6, $subtotalexento);
	$stmt->bindParam(7, $subtotaliva);
	$stmt->bindParam(8, $iva);
	$stmt->bindParam(9, $totaliva);
	$stmt->bindParam(10, $descontado);
	$stmt->bindParam(11, $descuento);
	$stmt->bindParam(12, $totaldescuento);
	$stmt->bindParam(13, $totalpago);
	$stmt->bindParam(14, $totalpago2);
	$stmt->bindParam(15, $estado);
	$stmt->bindParam(16, $fechapendiente);
	$stmt->bindParam(17, $codigo);
	$stmt->bindParam(18, $codsucursal);
   
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$totalpago2      = limpiar($_POST["txtTotalCompra"]);
	$estado          = limpiar('1');
    $fechapendiente  = limpiar($fecha);
	$codigo          = limpiar($_SESSION["codigo"]);
	$codsucursal     = limpiar(decrypt($_POST['codsucursal']));
	$stmt->execute();
	################### REGISTRO LA VENTA PENDIENTE ####################

	$this->dbh->beginTransaction();
	$detalle = $_SESSION["CarritoVenta"];
    for ($i = 0, $iMax = count($detalle); $i < $iMax; $i++) {

	################### REGISTRO DETALLES DE VENTA PENDIENTES ####################
    $query = "INSERT INTO detallependientes values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codpendiente);
    $stmt->bindParam(2, $idproducto);
    $stmt->bindParam(3, $codproducto);
    $stmt->bindParam(4, $producto);
    $stmt->bindParam(5, $descripcion);
    $stmt->bindParam(6, $imei);
    $stmt->bindParam(7, $condicion);
    $stmt->bindParam(8, $codmarca);
    $stmt->bindParam(9, $codmodelo);
    $stmt->bindParam(10, $codpresentacion);
    $stmt->bindParam(11, $codcolor);
	$stmt->bindParam(12, $cantidad);
	$stmt->bindParam(13, $preciocompra);
	$stmt->bindParam(14, $precioventa);
	$stmt->bindParam(15, $posicionimpuesto);
	$stmt->bindParam(16, $tipoimpuesto);
	$stmt->bindParam(17, $ivaproducto);
	$stmt->bindParam(18, $descproducto);
	$stmt->bindParam(19, $valortotal);
	$stmt->bindParam(20, $totaldescuentov);
	$stmt->bindParam(21, $subtotalimpuestos);
	$stmt->bindParam(22, $valorneto);
	$stmt->bindParam(23, $valorneto2);
    $stmt->bindParam(24, $tipodetalle);
	$stmt->bindParam(25, $codsucursal);
		
	$idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
	$codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
	$producto        = limpiar($detalle[$i]['producto']);
	$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
	$imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
	$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
	$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
	$codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
	$codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
	$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
	$cantidad        = limpiar($detalle[$i]['cantidad']);
	$preciocompra    = limpiar($detalle[$i]['precio']);
	$precioventa     = limpiar($detalle[$i]['precio2']);
	$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
	$descproducto    = limpiar($detalle[$i]['descproducto']);
	$descuento       = $detalle[$i]['descproducto']/100;
	$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
	$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

	//CALCULO SUBTOTAL IMPUESTOS
	if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
	$subtotalimpuestos    = "0.00";
	} else {
	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
	$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
	$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
	$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
    $BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
    $subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
    }

    $valorneto    = number_format($valortotal-$totaldescuentov, 2, '.', '');
	$valorneto2   = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
    $tipodetalle  = limpiar($detalle[$i]['tipodetalle']);
	$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
	$stmt->execute();
	################### REGISTRO DETALLES DE VENTA PENDIENTES ####################

	################### ACTUALIZO EL ESTADO DE IMEI ###################
	if($detalle[$i]['opcionimei'] == "SI"){

		$valoresArray = explode(',', $detalle[$i]['imei']);
	    $sql = "UPDATE imei SET estadoimei = ?
		WHERE numeroimei IN (".implode(',', $valoresArray).") 
		AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $estadoimei);
		$estadoimei = "3";
		$stmt->execute();
	}
	################### ACTUALIZO EL ESTADO DE IMEI ###################

    }
		
	####################### DESTRUYO LA VARIABLE DE SESSION #####################
	unset($_SESSION["CarritoVenta"]);
    $this->dbh->commit();

	echo "<span class='fa fa-check-square-o'></span> EL PEDIDO HA SIDO REGISTRADO EXITOSAMENTE";
	exit;

	}
}
########################### FUNCION REGISTRAR VENTAS ################################

########################## FUNCION BUSQUEDA DE VENTAS ###############################
public function BusquedaVentas() 
{
	self::SetNames();
	if ($_SESSION['acceso'] == "cajero") {

		if(limpiar($_GET['tipobusqueda']) == 1){
	  	$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago, 
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago 
		ORDER BY ventas.codfactura ASC";
		} else if(limpiar($_GET['tipobusqueda']) == 2){
	  	$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago, 
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE CONCAT(ventas.codventa, ' ',ventas.codfactura, ' ',ventas.tipodocumento, ' ',ventas.totalpago, ' ',cajas.nrocaja, ' ',cajas.nomcaja, ' ',if(ventas.codcliente='0','0',clientes.dnicliente), ' ',if(ventas.codcliente='0','0',clientes.nomcliente), ' ',if(ventas.codcliente='0','0',clientes.girocliente), ' ',sucursales.cuitsucursal, ' ',sucursales.nomsucursal, ' ',sucursales.dniencargado, ' ',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago 
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		} else if(limpiar($_GET['tipobusqueda']) == 3){
		$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago, 
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	    WHERE DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago 
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		}
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
			echo "</div>";		
			exit;
		}
		else
		{
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}

   } else {

	  	if(limpiar($_GET['tipobusqueda']) == 1){
	  	$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago
		ORDER BY ventas.codfactura ASC";
		} else if(limpiar($_GET['tipobusqueda']) == 2){
	  	$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE CONCAT(ventas.codventa, ' ',ventas.codfactura, ' ',ventas.tipodocumento, ' ',ventas.totalpago, ' ',cajas.nrocaja, ' ',cajas.nomcaja, ' ',if(ventas.codcliente='0','0',clientes.dnicliente), ' ',if(ventas.codcliente='0','0',clientes.nomcliente), ' ',if(ventas.codcliente='0','0',clientes.girocliente), ' ',sucursales.cuitsucursal, ' ',sucursales.nomsucursal, ' ',sucursales.dniencargado, ' ',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		} else if(limpiar($_GET['tipobusqueda']) == 3){
		$sql ="SELECT 
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
		INNER JOIN cajas ON ventas.codcaja = cajas.codcaja
		LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	       (SELECT
	       codcambio, descripcioncambio, montocambio, codmoneda       
	       FROM tiposcambio
	       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		arqueocaja.statusarqueo,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		}
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
			echo "</div>";		
			exit;
		}
		else
		{
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
	    }
    }
}
########################## FUNCION BUSQUEDA DE VENTAS ###############################

########################## FUNCION LISTAR VENTAS ################################
public function ListarVentas()
{
	self::SetNames();

   if ($_SESSION['acceso'] == "administradorG") {

	$sql = "SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	mediospagos.mediopago,
	SUM(detalleventas.cantidad) AS articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
	INNER JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo 
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
    WHERE ventas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'  
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	mediospagos.mediopago
	ORDER BY ventas.codfactura ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;

   } else if($_SESSION["acceso"] == "cajero") {

	$sql = "SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	mediospagos.mediopago,
	SUM(detalleventas.cantidad) AS articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
	INNER JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE ventas.codigo = '".limpiar($_SESSION["codigo"])."'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	mediospagos.mediopago
	ORDER BY ventas.codfactura ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;

   } else {

   $sql = "SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	mediospagos.mediopago,
	SUM(detalleventas.cantidad) AS articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa = ventas.codventa)
	INNER JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2  
	WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	mediospagos.mediopago
	ORDER BY ventas.codfactura ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
   }
}
############################ FUNCION LISTAR VENTAS ############################

############################ FUNCION ID VENTAS #################################
public function VentasPorId()
{
	self::SetNames();
	$sql = "SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codarqueo, 
	ventas.codcaja, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,
	ventas.totalpago2,
	ventas.creditopagado,
	ventas.tipopago, 
	ventas.fechavencecredito, 
    ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
    ventas.observaciones,  
    ventas.notacredito,
    ventas.codigo,   
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
    cajas.nrocaja,
    cajas.nomcaja,
	arqueocaja.statusarqueo,
    usuarios.dni, 
    usuarios.nombres,
    provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
	pagos.detalles_pagos,
	pagos.detalles_medios,
	IFNULL(balance.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-balance.montocredito,clientes.limitecredito) AS creditodisponible,
	pag.articulos
    FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento 
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja
	LEFT JOIN arqueocaja ON ventas.codarqueo = arqueocaja.codarqueo
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	   (SELECT
	   codventa,
	   SUM(detalleventas.cantidad) AS articulos
	   FROM detalleventas
	   WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	   GROUP BY
	   detalleventas.codventa) pag ON pag.codventa = ventas.codventa
	
	LEFT JOIN
	   (SELECT
	   mediospagoxventas.codventa,
	   GROUP_CONCAT(mediospagos.mediopago SEPARATOR ' / ') AS detalles_medios, 
	   GROUP_CONCAT(mediospagoxventas.codmediopago, '|', mediospagos.mediopago, '|',mediospagoxventas.montopagado, '|', mediospagoxventas.montodevuelto ORDER BY mediospagoxventas.codmediopago ASC SEPARATOR '<br>') AS detalles_pagos
	   FROM mediospagoxventas LEFT JOIN mediospagos ON mediospagos.codmediopago = mediospagoxventas.codmediopago
	   GROUP BY mediospagoxventas.codventa) pagos ON ventas.codventa = pagos.codventa
    
    LEFT JOIN
      (SELECT
      codcliente, montocredito       
      FROM creditosxclientes 
      WHERE codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."') balance ON balance.codcliente = clientes.codcliente

    WHERE ventas.codventa = ? AND ventas.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID VENTAS #################################
	
########################### FUNCION VER DETALLES VENTAS ##########################
public function VerDetallesVentas()
{
	self::SetNames();
	$sql = "SELECT
	detalleventas.coddetalleventa,
	detalleventas.codventa,
	detalleventas.idproducto,
	detalleventas.codproducto,
	detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
	detalleventas.codmarca,
	detalleventas.codmodelo,
	detalleventas.codpresentacion,
	detalleventas.codcolor,
	detalleventas.cantidad,
	detalleventas.preciocompra,
	detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,  
	detalleventas.ivaproducto,
	detalleventas.descproducto,
	detalleventas.valortotal, 
	detalleventas.totaldescuentov,
	detalleventas.subtotalimpuestos,
	detalleventas.valorneto,
	detalleventas.valorneto2,
	detalleventas.tipodetalle,
	detalleventas.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detalleventas  
	LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor 
	WHERE detalleventas.codventa = ? 
	AND detalleventas.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION VER DETALLES VENTAS #######################

############################# FUNCION ACTUALIZAR VENTAS ##########################
public function ActualizarVentas()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

	if(decrypt($_POST["arqueoxventa"]) != $codarqueoBD)
	{
		echo "2";
		exit;
	}
	elseif(empty($_POST["codventa"]) or empty($_POST["codsucursal"]))
	{
		echo "3";
		exit;
	}

	################## VERIFICO STOCK DISPONIBLE ##################
	for($i=0;$i<count($_POST['coddetalleventa']);$i++){  //recorro el array
       if (!empty($_POST['coddetalleventa'][$i])) {

        if($_POST['cantidad'][$i] == 0 || $_POST['cantidad'][$i] == 0.00){

	        echo "4";
	        exit();
        }
        elseif($_POST['cantidad'][$i] != $_POST['cantidadbd'][$i])
        {
	        if($_POST['tipodetalle'][$i] == 1){ // SI EL DETALLE ES UN PRODUCTO

			    ############## VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############
			    $sql = "SELECT existencia 
			    FROM productos 
			    WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."' 
			    AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
			    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
				foreach ($this->dbh->query($sql) as $row)
				{
					$this->p[] = $row;
				}
				$existenciaBD = $row['existencia'];
				$cantidad     = $_POST["cantidad"][$i];
				$cantidadBD   = $_POST["cantidadbd"][$i];
				$totalventa   = number_format($cantidad - $cantidadBD, 2, '.', '');
				############## VALIDO SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #############

				if ($totalventa > $existenciaBD) 
				{ 
					echo "5";
					exit;
				}

			} elseif(limpiar($_POST['tipodetalle'][$i]) == 2){ // SI EL DETALLE ES UN COMBO

				############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
				$sql = "SELECT 
				existencia 
				FROM combos 
				WHERE idcombo = '".limpiar($_POST['idproducto'][$i])."' 
			    AND codcombo = '".limpiar($_POST["codproducto"][$i])."'
				AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
				foreach ($this->dbh->query($sql) as $row)
				{
					$this->p[] = $row;
				}
				$existenciaBD  = $row['existencia'];
				$cantidad      = $_POST["cantidad"][$i];
				$cantidadBD    = $_POST["cantidadbd"][$i];
				$totalventa    = number_format($cantidad - $cantidadBD, 2, '.', '');
                ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

				if ($totalventa > $existenciaBD) 
				{ 
					echo "6";
					exit;
				}

                ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
				$sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
				$stmt = $this->dbh->prepare($sql);
				$stmt->execute(array($_POST["codproducto"][$i],limpiar(decrypt($_POST["codsucursal"]))));
				$num = $stmt->rowCount();
				if($num>0) {  

					$sql = "SELECT 
					combosxproductos.codcombo,
	    	        combosxproductos.idproducto,
					combosxproductos.codproducto,
					combosxproductos.cantidad,
					combosxproductos.codsucursal,
					productos.existencia
					FROM combosxproductos 
					LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
					WHERE combosxproductos.codcombo IN ('".limpiar($_POST["codproducto"][$i])."') 
					AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
					AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
					foreach ($this->dbh->query($sql) as $row)
					{ 
						$this->p[] = $row;

						$cantracionBD2  = $row['cantidad'];
						$idproductoBD2  = $row['idproducto'];
				        $codproductoBD2 = $row['codproducto'];
						$existenciaBD2  = $row['existencia'];
						$racion         = number_format($cantracionBD2*$cantidad, 2, '.', '');

						if ($racion > $existenciaBD2) 
						{ 
							echo "7";
							exit;
						}
					}
                }//fin de consulta de productos de combos	
                ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
				}
	        }
        }
    }
    ################## VERIFICO STOCK DISPONIBLE ##################

    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    LEFT JOIN
      (SELECT
      codcliente, montocredito       
      FROM creditosxclientes 
      WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."') pag ON pag.codcliente = clientes.codcliente
      WHERE clientes.dnicliente = ? 
      AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono"]) ? "0" : decrypt($_POST["formaabono"]));
    $montoabono        = (empty($_POST["montoabono"]) ? "0.00" : $_POST["montoabono"]);
    $total             = number_format($_POST["txtTotal"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ################### OBTENGO DATOS DE FACTURA ###################
    $sql = "SELECT
    tipodocumento,
	codfactura,
	iva,
	descuento,
	totalpago,
	montopagado,
	tipopago 
	FROM ventas 
	WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$tipodocumentoBD  = $row['tipodocumento'];
	$codfacturaBD     = $row['codfactura'];
	$ivaBD            = $row["iva"];
	$descuentoBD      = $row['descuento'];
	$totalpagoBD      = $row['totalpago'];
	$totalcreditoBD   = $row['totalpago']-$row['montopagado'];
	$totalabonoBD     = $row['montopagado'];
	$tipopagoBD       = $row['tipopago'];
	################### OBTENGO DATOS DE FACTURA ###################

	################### VALIDO TIPO DE PAGO ES A CREDITO ######################
    if (limpiar($tipopagoBD) == "CREDITO") {

    	$fechaactual = date("Y-m-d");
		$fechavence  = date("Y-m-d",strtotime($_POST['fechavencecredito']));

		if ($codcliente == '0') { 

            echo "8";
            exit;

        } else if (strtotime($fechavence) < strtotime($fechaactual)) {

			echo "9";
			exit;

		} else if ($montoabono != "0.00" && $medioabono == "0") {
  
            echo "10";
	        exit;

		} else if ($limitecredito != "0.00" && $total > $creditodisponible+$totalpagoBD) {

            echo "11";
            exit;

        } else if($_POST["montoabono"] >= $_POST["txtTotal"]) { 

	        echo "12";
	        exit;
        }
    }
    ################### VALIDO TIPO DE PAGO ES A CREDITO ######################

    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################
    if (limpiar($tipopagoBD) == "CONTADO") {

	   	foreach ($_POST['pagos'] as $value)
	   	{
			if($value['montopagado'] == "" || $value['montopagado'] == 0.00)	
			{
			    echo "13";
			    exit;
			}
		}

		if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {

	        $formas_pago = array_column($_POST['pagos'], 'codmediopago');
	        $txtPagado = array_reduce($_POST['pagos'], function ($a, $o) {
	            return $a + $o['montopagado'];
	        });

	        if(count($formas_pago) != count(array_unique($formas_pago)))
	   	    {
	   		    echo "14";
				exit;
	        } 
	        else if (count($formas_pago) > 1 && $txtPagado > $_POST["txtTotal"])
	        {
	            echo "15";
	            exit;
	        }

	    } else {

	        if ($_POST["txtTotal"] > $_POST["txtPagado"])
	        {
	            echo "16";
	            exit;
	        }
        } 
	}
    ################### VALIDO TIPO DE PAGO ES A CONTADO ######################

    $this->dbh->beginTransaction();
    for($i=0;$i<count($_POST['coddetalleventa']);$i++){  //recorro el array
    if (!empty($_POST['coddetalleventa'][$i])) {

    $sql = "SELECT cantidad FROM detalleventas
    WHERE coddetalleventa = '".limpiar($_POST['coddetalleventa'][$i])."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cantidadBD = $row['cantidad'];

    if($cantidadBD != $_POST['cantidad'][$i]){

	    if($_POST['tipodetalle'][$i] == 1){//SI EL DETALLE ES UN PRODUCTO

		    ############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN ############
		    $sql = "SELECT existencia 
		    FROM productos 
		    WHERE idproducto = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codproducto = '".limpiar($_POST['codproducto'][$i])."' 
		    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$existenciaBD  = $row['existencia'];
			$cantidad      = $_POST["cantidad"][$i];
			$cantidadBD    = $_POST["cantidadbd"][$i];
		    $totalventa    = number_format($cantidad - $cantidadBD, 2, '.', '');
			############ CONSULTO LA EXISTENCIA DE PRODUCTO EN ALMACEN ############

			############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN #1 ##############
			$sql2 = " UPDATE productos set "
			." existencia = ? "
			." WHERE "
			." idproducto = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->bindParam(1, $existencia);
			$existencia = number_format($existenciaBD - $totalventa, 2, '.', '');
			$stmt->execute();
		    ############## ACTUALIZAMOS EXISTENCIA DEL PRODUCTO EN ALMACEN #1 ##############

		    ############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###############
			$sql3 = " UPDATE kardex set "
			." salidas = ?, "
			." stockactual = ? "
			." WHERE "
			." codproceso = '".limpiar(decrypt($_POST["codventa"]))."' 
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 1
			AND procedimiento = 1;
			";
			$stmt = $this->dbh->prepare($sql3);
			$stmt->bindParam(1, $salidas);
			$stmt->bindParam(2, $existencia);
			
			$salidas    = limpiar($_POST["cantidad"][$i]);
			$existencia = number_format($existenciaBD - $totalventa, 2, '.', '');
			$stmt->execute();
			############### ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ###############

	   } elseif(limpiar($_POST['tipodetalle'][$i]) == 2){ // SI EL DETALLE ES UN COMBO

		    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql = "SELECT 
			existencia 
			FROM combos 
			WHERE idcombo = '".limpiar($_POST['idproducto'][$i])."' 
		    AND codcombo = '".limpiar($_POST["codproducto"][$i])."'
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			$cantidad     = $_POST["cantidad"][$i];
			$cantidadBD   = $_POST["cantidadbd"][$i];
			$totalventa   = number_format($cantidad - $cantidadBD, 2, '.', '');
		    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

		    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
			$sql = " UPDATE combos set "
				." existencia = ? "
				." WHERE "
				." idcombo = '".limpiar($_POST['idproducto'][$i])."' 
		        AND codcombo = '".limpiar($_POST["codproducto"][$i])."'
		        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
				";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);

			$existencia = number_format($existenciaBD - $totalventa, 2, '.', '');
			$stmt->execute();
			##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

			############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############
			$sql3 = " UPDATE kardex set "
			." salidas = ?, "
			." stockactual = ? "
			." WHERE "
			." codproceso = '".limpiar(decrypt($_POST["codventa"]))."' 
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 2
			AND procedimiento = 2;
			";
			$stmt = $this->dbh->prepare($sql3);
			$stmt->bindParam(1, $salidas);
			$stmt->bindParam(2, $existencia);
			
			$salidas    = limpiar($_POST["cantidad"][$i]);
			$existencia = number_format($existenciaBD - $totalventa, 2, '.', '');
			$stmt->execute();
			############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($_POST["codproducto"][$i]),limpiar(decrypt($_POST["codsucursal"]))));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia,
	        	productos.precioxpublico AS precioventa,
	        	productos.ivaproducto,
	        	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto  
	        	WHERE combosxproductos.codcombo IN ('".limpiar($_POST["codproducto"][$i])."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2    = $row['cantidad'];
			        $idproductoBD2    = $row['idproducto'];
				    $codproductoBD2   = $row['codproducto'];
				    $existenciaBD2    = $row['existencia'];
				    $precioventaBD2   = $row['precioventa'];
			        $nomimpuestoBD2   = $row['nomimpuesto'];
			        $valorimpuestoBD2 = $row['valorimpuesto'];
				    $ivaproductoBD2   = $row['ivaproducto'];
				    $descproductoBD2  = $row['descproducto'];
			       
			        $cantidad         = $_POST["cantidad"][$i];
			        $cantidadBD       = $_POST["cantidadbd"][$i];
			        $totalventa       = number_format($cantidad - $cantidadBD, 2, '.', '');

				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
				    $update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
			        $stmt->bindParam(2, $idproducto);
			        $stmt->bindParam(3, $codproducto);
	                $stmt->bindParam(4, $codsucursal);

			        $racion         = number_format($cantracionBD2*$totalventa, 2, '.', '');
				    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
				    $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
		            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
				    $stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

				    ########## ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ##########
				    $sql3 = " UPDATE kardex set "
				    ." salidas = ?, "
				    ." stockactual = ? "
				    ." WHERE "
				    ." codproceso = '".limpiar(decrypt($_POST["codventa"]))."' 
				    AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
				    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			        AND tipokardex = 1
			        AND procedimiento = 2;
				    ";
				    $stmt = $this->dbh->prepare($sql3);
				    $stmt->bindParam(1, $salidas);
				    $stmt->bindParam(2, $existencia);

				    $salidas    = limpiar($_POST["cantidad"][$i]);
				    $existencia = number_format($existenciaBD2 - $racion, 2, '.', '');
				    $stmt->execute();
			        ########## ACTUALIZAMOS LOS DATOS DEL PRODUCTO EN KARDEX ##########/**/
			    }
		    }//fin de consulta de ingredientes de productos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

	   } else { // SI EL DETALLE ES UN SERVICIO

		    ############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############
			$sql3 = " UPDATE kardex set "
			." salidas = ?, "
			." stockactual = ? "
			." WHERE "
			." codproceso = '".limpiar(decrypt($_POST["codventa"]))."' 
			AND codproducto = '".limpiar($_POST["codproducto"][$i])."' 
			AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'
			AND tipokardex = 3
			AND procedimiento = 3;
			";
			$stmt = $this->dbh->prepare($sql3);
			$stmt->bindParam(1, $salidas);
			$stmt->bindParam(2, $existencia);
			
			$salidas = limpiar($_POST["cantidad"][$i]);
			$existencia = "0";
			$stmt->execute();
			############### ACTUALIZAMOS LOS DATOS DEL COMBO EN KARDEX ###############
	    }

	    ####################### ACTUALIZO DETALLES DE VENTAS #######################
	    $query = "UPDATE detalleventas set"
		." cantidad = ?, "
		." valortotal = ?, "
		." totaldescuentov = ?, "
		." subtotalimpuestos = ?, "
		." valorneto = ?, "
		." valorneto2 = ? "
		." WHERE "
		." coddetalleventa = ? AND codventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $cantidad);
		$stmt->bindParam(2, $valortotal);
		$stmt->bindParam(3, $totaldescuentov);
		$stmt->bindParam(4, $subtotalimpuestos);
		$stmt->bindParam(5, $valorneto);
		$stmt->bindParam(6, $valorneto2);
		$stmt->bindParam(7, $coddetalleventa);
		$stmt->bindParam(8, $codventa);
		$stmt->bindParam(9, $codsucursal);

		$cantidad          = limpiar($_POST['cantidad'][$i]);
		$preciocompra      = limpiar($_POST['preciocompra'][$i]);
		$precioventa       = limpiar($_POST['precioventa'][$i]);
		$ivaproducto       = limpiar($_POST['ivaproducto'][$i]);
		$descuento         = $_POST['descproducto'][$i]/100;
		$valortotal        = number_format($_POST['valortotal'][$i], 2, '.', '');
		$totaldescuento    = number_format($_POST['totaldescuentov'][$i], 2, '.', '');
		$subtotalimpuestos = number_format($_POST['subtotalimpuestos'][$i], 2, '.', '');
		$valorneto         = number_format($_POST['valorneto'][$i], 2, '.', '');
		$valorneto2        = number_format($_POST['valorneto2'][$i], 2, '.', '');
		$coddetalleventa   = limpiar($_POST['coddetalleventa'][$i]);
		$codventa          = limpiar(decrypt($_POST["codventa"]));
		$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		####################### ACTUALIZO DETALLES DE VENTAS #######################

	        }
        } 
    }    
    $this->dbh->commit();

    ################### ACTUALIZO LA VENTA ####################
    $sql = " UPDATE ventas SET "
    ." codcliente = ?, "
	." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2 = ?, "
	." creditopagado= ?, "
	." formapago= ?, "
	." montopagado= ?, "
	." montodevuelto= ?, "
	." fechavencecredito= ?, "
	." observaciones = ? "
    ." WHERE "
    ." codventa = ? AND codsucursal = ?;
    ";
    $stmt = $this->dbh->prepare($sql);
    $stmt->bindParam(1, $codcliente);
	$stmt->bindParam(2, $exonerado);
	$stmt->bindParam(3, $subtotal);
	$stmt->bindParam(4, $subtotalexento);
	$stmt->bindParam(5, $subtotaliva);
	$stmt->bindParam(6, $totaliva);
	$stmt->bindParam(7, $descontado);
	$stmt->bindParam(8, $descuento);
	$stmt->bindParam(9, $totaldescuento);
	$stmt->bindParam(10, $totalpago);
    $stmt->bindParam(11, $totalpago2);
	$stmt->bindParam(12, $creditopagado);
	$stmt->bindParam(13, $formapago);
	$stmt->bindParam(14, $montopagado);
	$stmt->bindParam(15, $montodevuelto);
	$stmt->bindParam(16, $fechavencecredito);
	$stmt->bindParam(17, $observaciones);
    $stmt->bindParam(18, $codventa);
    $stmt->bindParam(19, $codsucursal);

    $exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = number_format($_POST["txtsubtotal"], 2, '.', '');
	$subtotalexento  = number_format($_POST["txtexento"], 2, '.', '');
	$subtotaliva     = number_format($_POST["txtsubtotaliva"], 2, '.', '');
	$totaliva        = number_format($_POST["txtIva"], 2, '.', '');
	$descontado      = number_format($_POST["txtdescontado"], 2, '.', '');
	$descuento       = limpiar($_POST["descuento"]);
    $totaldescuento  = number_format($_POST["txtDescuento"], 2, '.', '');
    $totalpago       = number_format($_POST["txtTotal"], 2, '.', '');
	$totalpago2      = number_format($_POST["txtTotalCompra"], 2, '.', '');
	$creditopagado   = limpiar(isset($_POST['montoabono']) ? $_POST["montoabono"] : "0.00");
	$montopagado     = '0.00';
    if ($tipopagoBD == 'CONTADO') {
        
        if (isset($_POST['pagos']) && is_array($_POST['pagos'])) {
            $formapago    = 'VARIOS';
	        $montopagado  = array_reduce($_POST['pagos'], function ($a, $o) {
	            return $a + $o['montopagado'];
	        });
        }
        else 
        {
            $formapago   = decrypt($_POST['codmediopago']);
            $montopagado = limpiar($_POST['montopagado']);
        }
    }
    else 
    {
        $formapago     = limpiar(decrypt($_POST["formaabono"]) != "" ? decrypt($_POST["formaabono"]) : "CREDITO");
    	$montopagado   = limpiar(decrypt($_POST["formaabono"]) != "" ? $_POST['montoabono'] : "0.00");
    }
    $montodevuelto     = limpiar(isset($_POST['montodevuelto']) ? $_POST["montodevuelto"] : "0.00");
	$fechavencecredito = limpiar($tipopagoBD=="CREDITO" ? date("Y-m-d",strtotime($_POST['fechavencecredito'])) : "0000-00-00");
    $codventa          = limpiar(decrypt($_POST["codventa"]));
    $codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
    $tipodocumento     = limpiar($tipodocumentoBD);
    $observaciones     = limpiar($_POST["observaciones"]);
    $fecha             = date("Y-m-d H:i:s");
    $stmt->execute();
    ################### ACTUALIZO LA VENTA ####################

    ################## ELIMINO DETALLES PAGOS EN VENTA ##################
    $sql = "DELETE FROM mediospagoxventas WHERE codventa = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1,$codventa);
	$codventa = decrypt($_POST["codventa"]);
	$stmt->execute();
	################## ELIMINO DETALLES PAGOS EN VENTA ##################

	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################
	if(limpiar($tipopagoBD)=="CONTADO"){

	    $sql  = "INSERT INTO mediospagoxventas VALUES (NULL, ?, ?, ?, ?, ?, ?)";
	    foreach ($_POST['pagos'] as $pago) {
	        $stmt = $this->dbh->prepare($sql);
	        $stmt->execute([$codarqueoBD, $codcajaBD, $codventa, decrypt($pago['codmediopago']), $pago['montopagado'], $_POST['montodevuelto']]);
	    }
	}
	################################ REGISTRO DE FORMAS DE PAGOS EN VENTA ################################

    ################ AGREGAMOS EL INGRESO A CONTADO ##############
	if (limpiar($tipopagoBD=="CONTADO")){

		################ ACTUALIZO DATOS EN CAJA ##############
		$sql = "UPDATE arqueocaja set "
		." ingresos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtIngresos);
		$stmt->bindParam(2, $codarqueo);

		if($totalpagoBD > $totalpago){
        $txtIngresos = number_format($ingresoBD-($totalpagoBD-$totalpago), 2, '.', '');
        } elseif($totalpagoBD < $totalpago){
        $txtIngresos = number_format($ingresoBD+($totalpago-$totalpagoBD), 2, '.', '');
        } else {
        $txtIngresos = number_format($ingresoBD, 2, '.', '');
        }
		$codarqueo = limpiar($codarqueoBD);
		$stmt->execute();
		################ ACTUALIZO DATOS EN CAJA ##############
	}
    ################ AGREGAMOS EL INGRESO A CONTADO ################

    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################
	if (limpiar($tipopagoBD=="CREDITO")) {

		################ ACTUALIZO DATOS EN CAJA ##############
		$sql = "UPDATE arqueocaja SET "
		." creditos = ?, "
		." abonos = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtCreditos);
		$stmt->bindParam(2, $txtAbonos);
		$stmt->bindParam(3, $codarqueo);

        $TotalCredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
		if($totalcreditoBD > $TotalCredito){
        $txtCreditos  = number_format($creditoBD-($totalcreditoBD-$TotalCredito), 2, '.', '');
        } elseif($totalcreditoBD < $TotalCredito){
        $txtCreditos  = number_format($creditoBD+($TotalCredito-$totalcreditoBD), 2, '.', '');
        } else {
        $txtCreditos  = number_format($creditoBD, 2, '.', '');
        }

		if($totalabonoBD > $_POST["montoabono"]){
        $txtAbonos    = number_format($abonoBD-($totalabonoBD-$_POST["montoabono"]), 2, '.', '');
        } elseif($totalabonoBD < $_POST["montoabono"]){
        $txtAbonos    = number_format($abonoBD+($_POST["montoabono"]-$totalabonoBD), 2, '.', '');
        } else {
        $txtAbonos    = number_format($abonoBD, 2, '.', '');
        }
		$codarqueo    = limpiar($codarqueoBD);
		$stmt->execute();
		################ ACTUALIZO DATOS EN CAJA ##############

		$sql = "SELECT codcliente FROM creditosxclientes WHERE codcliente = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($codcliente,decrypt($_POST['codsucursal'])));
		$num = $stmt->rowCount();
		if($num == 0)
		{
			################ REGISTRO DATOS DE CREDITO ##############
			$query = "INSERT INTO creditosxclientes values (null, ?, ?, ?);";
			$stmt  = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codcliente);
			$stmt->bindParam(2, $montocredito);
			$stmt->bindParam(3, $codsucursal);

			$montocredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
			$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
			$stmt->execute();
			################ REGISTRO DATOS DE CREDITO ##############

		} else { 

			################ ACTUALIZO DATOS DE CREDITO ##############
			$sql = "UPDATE creditosxclientes set"
			." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$TotalCredito = number_format($_POST["txtTotal"]-$_POST["montoabono"], 2, '.', '');
			if($totalcreditoBD > $TotalCredito){
	        $montocredito = number_format($montoactual-($totalcreditoBD-$TotalCredito), 2, '.', '');
	        } elseif($totalcreditoBD < $TotalCredito){
	        $montocredito = number_format($montoactual+($TotalCredito-$totalcreditoBD), 2, '.', '');
	        } else {
	        $montocredito = number_format($montoactual, 2, '.', '');
	        }
			$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
			$stmt->execute();
			################ ACTUALIZO DATOS DE CREDITO ##############
		}

		if (limpiar($_POST["montoabono"]!="0.00" && $_POST["montoabono"]!="0" && $_POST["montoabono"]!="")) {

			$sql = "SELECT codcliente FROM abonoscreditosventas WHERE codarqueo = ? AND codventa = ? AND codcliente = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array($codarqueoBD,decrypt($_POST["codventa"]),$codcliente,decrypt($_POST['codsucursal'])));
			$num = $stmt->rowCount();
			if($num == 0)
			{
				################ REGISTRO DATOS DE ABONOS ##############
				$query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?); ";
				$stmt = $this->dbh->prepare($query);
				$stmt->bindParam(1, $codarqueo);
				$stmt->bindParam(2, $codcaja);
				$stmt->bindParam(3, $codventa);
				$stmt->bindParam(4, $codcliente);
				$stmt->bindParam(5, $montoabono);
				$stmt->bindParam(6, $formaabono);
				$stmt->bindParam(7, $fechaabono);
				$stmt->bindParam(8, $codsucursal);

				$codarqueo   = limpiar($codarqueoBD);
				$codcaja     = limpiar($codcajaBD);
				$codventa    = limpiar(decrypt($_POST["codventa"]));
				$montoabono  = number_format($_POST["montoabono"], 2, '.', '');
				$formaabono  = limpiar(decrypt($_POST["formaabono"]));
				$fechaabono  = limpiar($fecha);
				$codsucursal = limpiar(decrypt($_POST['codsucursal']));
				$stmt->execute();
				################ REGISTRO DATOS DE ABONOS ##############

		    } else {

		    	################ ACTUALIZO DATOS DE CREDITO ##############
				$sql = "UPDATE abonoscreditosventas SET"
				." montoabono = ?, "
				." formaabono = ? "
				." WHERE "
				." codarqueo = ? AND codventa = ? AND codcliente = ? AND codsucursal = ?;
				";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $montoabono);
				$stmt->bindParam(2, $formaabono);
				$stmt->bindParam(3, $codarqueo);
				$stmt->bindParam(4, $codventa);
				$stmt->bindParam(5, $codcliente);
				$stmt->bindParam(6, $codsucursal);

				$montoabono   = number_format($_POST["montoabono"], 2, '.', '');
		        $formaabono   = limpiar(decrypt($_POST["formaabono"]));
				$codarqueo    = limpiar($codarqueoBD);
				$codventa     = limpiar(decrypt($_POST["codventa"]));
				$codsucursal  = limpiar(decrypt($_POST['codsucursal']));
				$stmt->execute();
				################ ACTUALIZO DATOS DE CREDITO ##############
		    }
		}
	}
    ################ AGREGAMOS EL INGRESO Y ABONOS A CREDITO ################

    echo "<span class='fa fa-check-square-o'></span> LA VENTA DE PRODUCTOS HA SIDO ACTUALIZADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################## FUNCION ACTUALIZAR VENTAS ###########################

########################## FUNCION AGREGAR DETALLES VENTAS ############################
public function AgregarDetallesVentas()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

	if(decrypt($_POST["arqueoxventa"]) != $codarqueoBD)
	{
		echo "2";
		exit;
	}
	elseif(empty($_POST["codventa"]) or empty($_POST["codsucursal"]))
	{
		echo "3";
		exit;
	}
	else if(empty($_SESSION["CarritoVenta"]) || $_POST["txtTotal"]=="0.00")
	{
		echo "4";
		exit;
	}

	$this->dbh->beginTransaction();
    $detalle = $_SESSION["CarritoVenta"];
	for($i=0;$i<count($detalle);$i++){

	   if(limpiar($detalle[$i]['tipodetalle']) == 1){//SI EL DETALLE ES UN PRODUCTO

	    ############### VERIFICO AL EXISTENCIA DEL PRODUCTO AGREGADO ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############### VERIFICO AL EXISTENCIA DEL PRODUCTO AGREGADO ################

		############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######
	    if ($detalle[$i]['cantidad'] > $existenciaBD) 
	    { 
		   echo "5";
		   exit;
	    }
	    ############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######

	} elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

		############### VERIFICO AL EXISTENCIA DEL COMBO AGREGADO ################
		$sql = "SELECT * FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
		AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciacBD = $row['existencia'];
		############### VERIFICO AL EXISTENCIA DEL COMBO AGREGADO ################

		############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######
	    if ($detalle[$i]['cantidad'] > $existenciaBD) 
	    { 
		   echo "6";
		   exit;
	    }
	    ############ REVISAMOS SI LA CANTIDAD ES MAYOR QUE LA EXISTENCIA #######

	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
        if($num>0) {  

        	$sql = "SELECT 
        	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
        	combosxproductos.codproducto,
        	combosxproductos.cantidad,
        	combosxproductos.codsucursal,
        	productos.existencia
        	FROM combosxproductos 
        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto 
        	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
    	    AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
        	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2  = $row['cantidad'];
			    $idproductoBD2  = $row['idproducto'];
				$codproductoBD2 = $row['codproducto'];
			    $existenciaBD2  = $row['existencia'];
		        $racion = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');

		        if ($racion > $existenciaBD2) 
		        { 
		        	echo "7";
		        	exit;
		       }
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	}

	################### SELECCIONE LOS DATOS DEL CLIENTE ######################
    $sql = "SELECT
    clientes.codcliente,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	provincias.provincia,
	departamentos.departamento,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    IFNULL(clientes.limitecredito-pag.montocredito,clientes.limitecredito) AS creditodisponible
    FROM clientes
    LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
    LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento 
    LEFT JOIN
      (SELECT
      codcliente, montocredito       
      FROM creditosxclientes 
      WHERE codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."') pag ON pag.codcliente = clientes.codcliente
      WHERE clientes.dnicliente = ? 
      AND clientes.codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_POST['nrodocumento']),decrypt($_POST['codsucursal'])));
	$num = $stmt->rowCount();
	if($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$p[] = $row;
	}
    $codcliente        = (empty($row['codcliente']) ? "0" : $row['codcliente']);
    $tipocliente       = (empty($row['tipocliente']) ? "0" : $row['tipocliente']);
    $dnicliente        = (empty($row['dnicliente']) ? "0" : $row['dnicliente']);
    $nomcliente        = (empty($row['nomcliente']) ? "0" : $row['nomcliente']);
    $girocliente       = (empty($row['girocliente']) ? "0" : $row['girocliente']);
    $emailcliente      = (empty($row['emailcliente']) ? "0" : $row['emailcliente']);
    $provincia         = (empty($row['id_provincia']) ? "0" : $row['provincia']);
    $departamento      = (empty($row['id_departamento']) ? "0" : $row['departamento']);
    $direccliente      = (empty($row['direccliente']) ? "0" : $row['direccliente']);
    $limitecredito     = (empty($row['limitecredito']) ? "0.00" : $row['limitecredito']);
    $montoactual       = (empty($row['montoactual']) ? "0.00" : $row['montoactual']);
    $creditodisponible = (empty($row['creditodisponible']) ? "0.00" : $row['creditodisponible']);
    $medioabono        = (empty($_POST["formaabono"]) ? "" : $_POST["formaabono"]);
    $montoabono        = (empty($_POST["montoabono"]) ? "0.00" : $_POST["montoabono"]);
    $total             = number_format($_POST["txtTotal"]-$montoabono, 2, '.', '');
    ################### SELECCIONE LOS DATOS DEL CLIENTE ######################

    ############ CONSULTO TOTAL ACTUAL DE VENTAS ##############
	$sql = "SELECT
	codfactura,
	iva,
	descuento,
	totalpago 
	FROM ventas 
	WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD = $row["codfactura"];
	$ivaBD        = $row["iva"];
	$descuentoBD  = $row["descuento"];
	$totalpagoBD  = $row['totalpago'];
	############ CONSULTO TOTAL ACTUAL DE VENTAS ##############

    if ($_POST["tipopago"] == "CREDITO") {
  
	    if ($limitecredito != "0.00" && $total > $creditodisponible) {	
  
            echo "8";
	        exit;
        } 
    }

    ############# REVISAMOS QUE EL PRODUCTO NO ESTE EN LA BD ###################
    $sql = "SELECT 
    codventa, 
    codproducto 
    FROM detalleventas 
    WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' 
    AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
    AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num == 0){

	    ################### REGISTRO DETALLES DE VENTA ####################
		$query = "INSERT INTO detalleventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
	    $stmt->bindParam(2, $idproducto);
	    $stmt->bindParam(3, $codproducto);
	    $stmt->bindParam(4, $producto);
	    $stmt->bindParam(5, $descripcion);
	    $stmt->bindParam(6, $imei);
	    $stmt->bindParam(7, $condicion);
	    $stmt->bindParam(8, $codmarca);
	    $stmt->bindParam(9, $codmodelo);
	    $stmt->bindParam(10, $codpresentacion);
	    $stmt->bindParam(11, $codcolor);
		$stmt->bindParam(12, $cantidad);
		$stmt->bindParam(13, $preciocompra);
		$stmt->bindParam(14, $precioventa);
		$stmt->bindParam(15, $posicionimpuesto);
		$stmt->bindParam(16, $tipoimpuesto);
		$stmt->bindParam(15, $ivaproducto);
		$stmt->bindParam(16, $descproducto);
		$stmt->bindParam(17, $valortotal);
		$stmt->bindParam(18, $totaldescuentov);
		$stmt->bindParam(19, $subtotalimpuestos);
		$stmt->bindParam(20, $valorneto);
		$stmt->bindParam(21, $valorneto2);
		$stmt->bindParam(22, $tipodetalle);
		$stmt->bindParam(23, $codsucursal);
			
		$codventa        = limpiar(decrypt($_POST["codventa"]));
		$idproducto      = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['id']);
		$codproducto     = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['txtCodigo']);
		$producto        = limpiar($detalle[$i]['producto']);
		$descripcion     = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['descripcion'] == "0" ? "" : $detalle[$i]['descripcion']);
		$imei            = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['imei'] == "0" ? "" : $detalle[$i]['imei']);
		$condicion       = limpiar($detalle[$i]['tipodetalle'] == "3" || $detalle[$i]['condicion'] == "0" ? "" : $detalle[$i]['condicion']);
		$codmarca        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmarca']);
		$codmodelo       = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codmodelo']);
		$codpresentacion = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codpresentacion']);
		$codcolor        = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0" : $detalle[$i]['codcolor']);
		$cantidad        = limpiar($detalle[$i]['cantidad']);
		$preciocompra    = limpiar($detalle[$i]['precio']);
		$precioventa     = limpiar($detalle[$i]['precio2']);
		$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	    $posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	    $tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	    $ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
		$descproducto    = limpiar($detalle[$i]['descproducto']);
		$descuento       = $detalle[$i]['descproducto']/100;
		$valortotal      = number_format($detalle[$i]['precio2']*$detalle[$i]['cantidad'], 2, '.', '');
		$totaldescuentov = number_format($valortotal*$descuento, 2, '.', '');

		//CALCULO SUBTOTAL IMPUESTOS
		if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
		$subtotalimpuestos    = "0.00";
	    } else {
	    $ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
		$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
		$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
		$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
		$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
		$BaseDiscriminado     = $SubtotalDiscriminado * $detalle[$i]['cantidad'];
		$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
	    }

	    $valorneto    = number_format($valortotal-$totaldescuentov, 2, '.', '');
		$valorneto2   = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$detalle[$i]['cantidad'], 2, '.', ''));
		$tipodetalle  = limpiar($detalle[$i]['tipodetalle']);
		$codsucursal  = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute();
		################### REGISTRO DETALLES DE VENTA ####################

		################### ACTUALIZO EL ESTADO DE IMEI ###################
		if($detalle[$i]['opcionimei'] == "SI"){

			$valoresArray = explode(',', $detalle[$i]['imei']);
		    $sql = "UPDATE imei SET estadoimei = ?
			WHERE numeroimei IN (".implode(',', $valoresArray).") 
			AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $estadoimei);
			$estadoimei = "3";
			$stmt->execute();
		}
		################### ACTUALIZO EL ESTADO DE IMEI ###################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD - $cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

	} elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
		AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
			." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($detalle[$i]['id'])."' 
		    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', ''); 
		$existencia = number_format($existenciaBD - $cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD - $detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionbd2    = $row['cantidad'];
			    $idproductobd2    = $row['idproducto'];
			    $codproductobd2   = $row['codproducto'];
			    $existenciabd2    = $row['existencia'];
			    $precioventabd2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductobd2   = $row['ivaproducto'];
			    $descproductobd2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	            $stmt->bindParam(15, $procedimiento);
	            $stmt->bindParam(16, $codsucursal);	
		        $stmt->bindParam(17, $codigo);	

			    $codventa      = limpiar(decrypt($_POST["codventa"]));
			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("VENTA (DETALLE DE COMBO): ".$codfacturaBD);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	            $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ################### 
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
	} else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);		
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("3");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	}

    } else {

  	$sql = "SELECT cantidad 
  	FROM detalleventas 
  	WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' 
  	AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
  	AND idproducto = '".limpiar($detalle[$i]['id'])."' 
	AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cantidad = $row['cantidad'];

  	################### ACTUALIZO DETALLES DE VENTA ####################
  	$query = "UPDATE detalleventas set"
	." cantidad = ?, "
	." descproducto = ?, "
	." valortotal = ?, "
	." totaldescuentov = ?, "
	." subtotalimpuestos = ?, "
	." valorneto = ?, "
	." valorneto2 = ? "
	." WHERE "
	." codventa = ? AND codsucursal = ? AND idproducto = ? AND codproducto = ?;
	";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $cantidad);
	$stmt->bindParam(2, $descproducto);
	$stmt->bindParam(3, $valortotal);
	$stmt->bindParam(4, $totaldescuentov);
	$stmt->bindParam(5, $subtotalimpuestos);
	$stmt->bindParam(6, $valorneto);
	$stmt->bindParam(7, $valorneto2);
	$stmt->bindParam(8, $codventa);
	$stmt->bindParam(9, $codsucursal);
	$stmt->bindParam(10, $idproducto);
	$stmt->bindParam(11, $codproducto);

	$cantidad        = limpiar($detalle[$i]['cantidad']+$cantidad);
	$preciocompra    = limpiar($detalle[$i]['precio']);
	$precioventa     = limpiar($detalle[$i]['precio2']);
	$precioconiva    = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['precio2']);
	$posicionimpuesto= limpiar($detalle[$i]['posicionimpuesto']);
	$tipoimpuesto    = limpiar($detalle[$i]['tipoimpuesto']);
	$ivaproducto     = limpiar($detalle[$i]['ivaproducto'] == "0" ? "0.00" : $detalle[$i]['ivaproducto']);
	$descproducto    = limpiar($detalle[$i]['descproducto']);
	$descuento       = $detalle[$i]['descproducto']/100;
	$valortotal      = number_format($detalle[$i]['precio2'] * $cantidad, 2, '.', '');
	$totaldescuentov = number_format($valortotal * $descuento, 2, '.', '');

	//CALCULO SUBTOTAL IMPUESTOS
	if($detalle[$i]['tipoimpuesto'] == "EXENTO"){
    $subtotalimpuestos    = "0.00";
	} else {
	$ValorImpuesto        = 1 + ($detalle[$i]['ivaproducto']/100);
	$RestoDescuento       = $precioconiva * $detalle[$i]['descproducto'] / 100;
	$PrecioIvaDescuento   = $precioconiva - $RestoDescuento;
	$Discriminado         = $PrecioIvaDescuento/$ValorImpuesto;
	$SubtotalDiscriminado = $PrecioIvaDescuento - $Discriminado;
	$BaseDiscriminado     = $SubtotalDiscriminado * $cantidad;
	$subtotalimpuestos    = number_format($BaseDiscriminado, 2, '.', '');
    }

	$valorneto   = number_format($valortotal - $totaldescuentov, 2, '.', '');
	$valorneto2  = limpiar($detalle[$i]['tipodetalle'] == "3" ? "0.00" : number_format($detalle[$i]['precio']*$cantidad, 2, '.', ''));
	$codventa    = limpiar(decrypt($_POST["codventa"]));
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
	$idproducto  = limpiar($detalle[$i]['id']);
	$codproducto = limpiar($detalle[$i]['txtCodigo']);
	$stmt->execute();
	################### ACTUALIZO DETALLES DE VENTA ####################

	if(limpiar($detalle[$i]['tipodetalle'])==1){ // SI EL DETALLE ES UN PRODUCTO

		################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################
		$sql = "SELECT * FROM productos 
		WHERE idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
	    ################ VERIFICO LA EXISTENCIA DEL PRODUCTO EN ALMACEN ################

		##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################
		$sql = " UPDATE productos set "
		." existencia = ? "
		." WHERE "
		." idproducto = '".limpiar($detalle[$i]['id'])."' 
		AND codproducto = '".limpiar($detalle[$i]['txtCodigo'])."' 
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD - $cantidad, 2, '.', '');
		$stmt->execute();
	    ##################### ACTUALIZO LA EXISTENCIA DEL ALMACEN ####################

	    ############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);
	    $stmt->bindParam(15, $procedimiento);			
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("1");
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###############

	} elseif(limpiar($detalle[$i]['tipodetalle']) == 2){ // SI EL DETALLE ES UN COMBO

	    ############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
		$sql = "SELECT 
		existencia 
		FROM combos 
		WHERE idcombo = '".limpiar($detalle[$i]['id'])."' 
		AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
		AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$existenciaBD = $row['existencia'];
		############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################

	    ##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################
		$sql = " UPDATE combos set "
			." existencia = ? "
			." WHERE "
			." idcombo = '".limpiar($detalle[$i]['id'])."' 
		    AND codcombo = '".limpiar($detalle[$i]['txtCodigo'])."'
	        AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."';
			";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $existencia);
		$cantidad   = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$existencia = number_format($existenciaBD - $cantidad, 2, '.', '');
		$stmt->execute();
		##################### ACTUALIZO LA EXISTENCIA DEL COMBO DEL ALMACEN ####################

		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);	
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar($detalle[$i]['txtCodigo']);
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = number_format($existenciaBD-$detalle[$i]['cantidad'], 2, '.', '');
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = number_format($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("2");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE COMBO EN KARDEX ###############

		############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
	    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array($detalle[$i]['txtCodigo'],limpiar(decrypt($_POST["codsucursal"]))));
		$num = $stmt->rowCount();
	    if($num>0) {  

	    	$sql = "SELECT 
	    	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
	    	combosxproductos.codproducto,
	    	combosxproductos.cantidad,
	    	combosxproductos.codsucursal,
	    	productos.existencia,
	    	productos.precioxpublico AS precioventa,
	    	productos.ivaproducto,
	    	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
	    	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto
	    	WHERE combosxproductos.codcombo IN ('".limpiar($detalle[$i]['txtCodigo'])."') 
	    	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	    	foreach ($this->dbh->query($sql) as $row)
		   { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion = number_format($cantracionBD2*$detalle[$i]['cantidad'], 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2-$racion, 2, '.', '');
			    $idproducto = limpiar($idproductoBD2);
		        $codproducto = limpiar($codproductoBD2);
	            $codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ###################
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			    $stmt = $this->dbh->prepare($query);
			    $stmt->bindParam(1, $codventa);
			    $stmt->bindParam(2, $codcliente);
			    $stmt->bindParam(3, $codproducto);
			    $stmt->bindParam(4, $movimiento);
			    $stmt->bindParam(5, $entradas);
			    $stmt->bindParam(6, $salidas);
			    $stmt->bindParam(7, $devolucion);
			    $stmt->bindParam(8, $stockactual);
			    $stmt->bindParam(9, $ivaproducto);
			    $stmt->bindParam(10, $descproducto);
			    $stmt->bindParam(11, $precio);
			    $stmt->bindParam(12, $documento);
			    $stmt->bindParam(13, $fechakardex);
	            $stmt->bindParam(14, $tipokardex);
	            $stmt->bindParam(15, $procedimiento);
	            $stmt->bindParam(16, $codsucursal);	
		        $stmt->bindParam(17, $codigo);	

			    $codventa      = limpiar(decrypt($_POST["codventa"]));
			    $codproducto   = limpiar($codproductoBD2);
			    $movimiento    = limpiar("SALIDAS");
			    $entradas      = limpiar("0.00");
			    $salidas       = number_format($racion, 2, '.', '');
			    $devolucion    = limpiar("0.00");
			    $stockactual   = number_format($existenciaBD2-$racion, 2, '.', '');
			    $ivaproducto   = limpiar($ivaproductoBD2 == '0' ? "EXENTO" : $nomimpuestoBD2." (".$valorimpuestoBD2." %)");
			    $descproducto  = number_format($descproductoBD2, 2, '.', '');
			    $precio        = number_format($precioventaBD2, 2, '.', '');
			    $documento     = limpiar("VENTA (DETALLE DE COMBO): ".$codfacturaBD);
			    $fechakardex   = limpiar(date("Y-m-d H:i:s"));
	            $tipokardex    = limpiar("1");
	            $procedimiento = limpiar("2");
	            $codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo        = limpiar($_SESSION["codigo"]);
			    $stmt->execute();
			    ############## REGISTRAMOS LOS DATOS DE PRODUCTOS EN KARDEX ################### 
		    }
	    }//fin de consulta de productos de combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
    	
	} else { // SI EL DETALLE ES UN SERVICIO

	    ############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ###############
	    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
		$stmt = $this->dbh->prepare($query);
		$stmt->bindParam(1, $codventa);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codproducto);
		$stmt->bindParam(4, $movimiento);
		$stmt->bindParam(5, $entradas);
		$stmt->bindParam(6, $salidas);
		$stmt->bindParam(7, $devolucion);
		$stmt->bindParam(8, $stockactual);
		$stmt->bindParam(9, $ivaproducto);
		$stmt->bindParam(10, $descproducto);
		$stmt->bindParam(11, $precio);
		$stmt->bindParam(12, $documento);
		$stmt->bindParam(13, $fechakardex);	
	    $stmt->bindParam(14, $tipokardex);	
	    $stmt->bindParam(15, $procedimiento);	
		$stmt->bindParam(16, $codsucursal);
		$stmt->bindParam(17, $codigo);

		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codproducto   = limpiar("0");
		$movimiento    = limpiar("SALIDAS");
		$entradas      = limpiar("0.00");
		$salidas       = number_format($detalle[$i]['cantidad'], 2, '.', '');
		$devolucion    = limpiar("0.00");
		$stockactual   = limpiar("0.00");
		$ivaproducto   = limpiar($detalle[$i]['ivaproducto'] == "0" ? "EXENTO" : $detalle[$i]['tipoimpuesto']." (".$detalle[$i]['ivaproducto']." %)");
		$descproducto  = limpiar($detalle[$i]['descproducto'], 2, '.', '');
		$precio        = number_format($detalle[$i]["precio2"], 2, '.', '');
		$documento     = limpiar("VENTA: ".$codfacturabd);
		$fechakardex   = limpiar(date("Y-m-d H:i:s"));
	    $tipokardex    = limpiar($detalle[$i]['tipodetalle']);
	    $procedimiento = limpiar("3");	
		$codsucursal   = limpiar(decrypt($_POST["codsucursal"]));
    	$codigo        = limpiar($_SESSION["codigo"]);
		$stmt->execute();
		############### REGISTRAMOS LOS DATOS DE SERVICIO EN KARDEX ##############
	       }
        } 
    }
    ####################### DESTRUYO LA VARIABLE DE SESSION #####################
    unset($_SESSION["CarritoVenta"]);
    $this->dbh->commit();
 
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalleventas WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
    foreach ($this->dbh->query($sql3) as $row3)
    {
     	$this->p[] = $row3;
    }
    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalleventas WHERE codventa = '".limpiar(decrypt($_POST["codventa"]))."' AND codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
    foreach ($this->dbh->query($sql5) as $row5)
    {
     	$this->p[] = $row5;
    }
    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

    ################### ACTUALIZO LA VENTA ####################
	$sql = " UPDATE ventas SET "
	." codcliente = ?, "
    ." exonerado = ?, "
	." subtotal = ?, "
	." subtotalexento = ?, "
	." subtotaliva = ?, "
	." totaliva = ?, "
	." descontado = ?, "
	." descuento = ?, "
	." totaldescuento = ?, "
	." totalpago = ?, "
	." totalpago2 = ?, "
	." montopagado = ?, "
	." montodevuelto = ?, "
	." observaciones = ? "
	." WHERE "
	." codventa = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $codcliente);
    $stmt->bindParam(2, $exonerado);
	$stmt->bindParam(3, $TxtSubtotal);
	$stmt->bindParam(4, $TxtSubtotalExento);
	$stmt->bindParam(5, $TxtSubtotalIva);
	$stmt->bindParam(6, $TxtTotalIva);
	$stmt->bindParam(7, $TxtDescontado);
	$stmt->bindParam(8, $descuento);
	$stmt->bindParam(9, $TxtTotalDescuento);
	$stmt->bindParam(10, $TxtTotal);
	$stmt->bindParam(11, $totalpago2);
	$stmt->bindParam(12, $montopagado);
	$stmt->bindParam(13, $montodevuelto);
	$stmt->bindParam(14, $observaciones);
	$stmt->bindParam(15, $codventa);
	$stmt->bindParam(16, $codsucursal);

	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$exonerado       = limpiar($_POST["exonerado"]);

	/*###################################################### CALCULO DE DESCUENTO ######################################################*/
    //PORCENTAJE DESCUENTO
	$descuento     = $_POST["descuento"]+$descuentoBD;
	$Porcentaje    = $descuento/100;

	//PORCENTAJE IVA
	$txtIva        = $ivaBD;
	$PorcentajeIva = $txtIva/100;

	/*OBTENGO DESCUENTO DE EXENTO*/
	$RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	$TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	/*OBTENGO SUBTOTAL IVA*/
	$RestoSubtotalIva  = number_format($subtotaliva*$Porcentaje, 2, '.', '');
    $TxtSubtotalIva    = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	/*OBTENGO TOTAL IVA*/
	$TxtTotalIva       = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	//CALCULO DE TOTAL FACTURA
	$TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	$TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	$TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	$TxtTotal          = ($_POST["exonerado"] == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	$totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	/*###################################################### CALCULO DE DESCUENTO ######################################################*/

	$montopagado     = number_format($totalpago, 2, '.', '');
	$montodevuelto   = limpiar("0.00");
	$codventa        = limpiar(decrypt($_POST["codventa"]));
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$tipodocumento   = limpiar($_POST["tipodocumento"]);
	$tipopago        = limpiar($_POST["tipopago"]);
	$observaciones   = limpiar($_POST["observaciones"]);
	$fecha           = date("Y-m-d H:i:s");
	$stmt->execute();
	################### ACTUALIZO LA VENTA ####################

    ################## AGREGAMOS O QUITAMOS LA DIFERENCIA EN CAJA ###############
    if (limpiar($_POST["tipopago"]=="CONTADO") && $totalpagoBD != $totalpago){

        ##################### ACTUALIZO DATOS EN CAJA #####################
        $sql = "UPDATE arqueocaja set "
        ." ingresos = ? "
        ." WHERE "
         ." codarqueo = ?;
        ";
        $stmt = $this->dbh->prepare($sql);
        $stmt->bindParam(1, $TxtTotal);
        $stmt->bindParam(2, $codarqueo);

        $TxtTotal  = number_format($ingresoBD+($totalpago-$totalpagoBD), 2, '.', '');
        $codarqueo = limpiar($codarqueoBD);
        $stmt->execute();
        ##################### ACTUALIZO DATOS EN CAJA #####################

		##################### ACTUALIZO DATOS EN FORMAS DE PAGO #####################
		$sql = "UPDATE mediospagoxventas set "
		." montopagado = ?, "
		." montodevuelto = ? "
		." WHERE "
		." codventa = ? AND codmediopago = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $TxtPagado);
		$stmt->bindParam(2, $TxtDevuelto);
		$stmt->bindParam(3, $codventa);
		$stmt->bindParam(4, $codmediopago);

        $TxtPagado    = number_format($totalpago, 2, '.', '');
        $TxtDevuelto  = limpiar("0.00");
		$codmediopago = decrypt($_POST["codmediopago"]);
		$stmt->execute();
		##################### ACTUALIZO DATOS EN FORMAS DE PAGO #####################
    }
    ################# AGREGAMOS O QUITAMOS LA DIFERENCIA EN CAJA ###################

   ############## AGREGAMOS O QUITAMOS LA DIFERENCIA EN CAJA ##################
   if (limpiar($_POST["tipopago"]=="CREDITO") && $totalpagoBD != $totalpago) {

        ##################### ACTUALIZO DATOS EN CAJA #####################
        $sql = " UPDATE arqueocaja SET "
        ." creditos = ? "
        ." WHERE "
        ." codarqueo = ?;
        ";
        $stmt = $this->dbh->prepare($sql);
        $stmt->bindParam(1, $TxtCredito);
        $stmt->bindParam(2, $codarqueo);
        
        $TxtCredito = number_format($creditoBD+($totalpago-$totalpagoBD), 2, '.', '');
        $codarqueo  = limpiar($codarqueoBD);
        $stmt->execute(); 
        ##################### ACTUALIZO DATOS EN CAJA #####################

		##################### ACTUALIZO CREDITO X CLIENTE #####################
		$sql = "UPDATE creditosxclientes set"
		." montocredito = ? "
		." WHERE "
		." codcliente = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $TxtMonto);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codsucursal);
		
		$TxtMonto    = number_format($montoactual+($totalpago-$totalpagoBD), 2, '.', '');
		$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
		$stmt->execute(); 
		##################### ACTUALIZO CREDITO X CLIENTE #####################
    }
    ############## AGREGAMOS O QUITAMOS LA DIFERENCIA EN CAJA ##################

    echo "<span class='fa fa-check-square-o'></span> LOS DETALLES DE PRODUCTOS FUERON AGREGADOS A LA VENTA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################### FUNCION AGREGAR DETALLES VENTAS ##########################

########################### FUNCION ELIMINAR DETALLES VENTAS ###########################
public function EliminarDetallesVentas()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS" || $_SESSION["acceso"]=="secretaria" || $_SESSION["acceso"]=="cajero") {

    ############ CONSULTO TOTAL ACTUAL DE VENTAS ##############
	$sql = "SELECT
	codfactura, 
	codarqueo,  
	codcaja, 
	codcliente, 
	exonerado,
	iva,
	descuento, 
	tipopago, 
	totalpago, 
	creditopagado 
	FROM ventas WHERE codventa = '".limpiar(decrypt($_GET["codventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD    = $row['codfactura'];
	$codarqueoBD     = $row['codarqueo'];
	$codcajaBD       = $row['codcaja'];
	$codclienteBD    = $row['codcliente'];
	$exoneradoBD     = $row['exonerado'];
	$ivaBD           = $row["iva"];
	$descuentoBD     = $row["descuento"];
	$tipopagoBD      = $row['tipopago'];
	$totalpagoBD     = $row['totalpago'];
	$creditopagadoBD = $row['creditopagado'];
	############ CONSULTO TOTAL ACTUAL DE VENTAS ##############

	################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################
	$sql = "SELECT montocredito FROM creditosxclientes 
	WHERE codcliente = '".$codclienteBD."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$montocreditoBD = (empty($row['montocredito']) ? "0.00" : $row['montocredito']);
	################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################

	$sql = "SELECT * FROM detalleventas WHERE codventa = ? AND codsucursal = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num > 1)
	{
		$sql = "SELECT
		idproducto, 
		codproducto,
		imei, 
		cantidad, 
		precioventa,
		posicionimpuesto,
		tipoimpuesto, 
		ivaproducto, 
		descproducto, 
		tipodetalle 
		FROM detalleventas 
		WHERE coddetalleventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute(array(decrypt($_GET["coddetalleventa"]),decrypt($_GET["codsucursal"])));
		$num = $stmt->rowCount();

		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$p[] = $row;
		}
		$idproductoBD       = $row['idproducto'];
		$codproductoBD      = $row['codproducto'];
		$cantidadBD         = $row['cantidad'];
		$precioventaBD      = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD     = $row['tipoimpuesto'];
		$ivaproductoBD      = $row['ivaproducto'];
		$descproductoBD     = $row['descproducto'];
		$tipodetalleBD      = $row['tipodetalle'];

	   if(limpiar($tipodetalleBD) == 1){// SSI EL DETALLE ES UN PRODCUTO

			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql = "UPDATE productos SET "
			." existencia = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $codsucursal);

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("1");	
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			################### ACTUALIZO EL ESTADO DE IMEI ###################
			if($imeiBD != ""){

				$valoresArray = explode(',', $imeiBD);
			    $sql = "UPDATE imei SET estadoimei = ?
				WHERE numeroimei IN (".implode(',', $valoresArray).") 
				AND codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."';";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $estadoimei);
				$estadoimei = "1";
				$stmt->execute();
			}
			################### ACTUALIZO EL ESTADO DE IMEI ###################

		} elseif(limpiar($tipodetalleBD) == 2){ // SI EL DETALLE ES UN COMBO

			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql2 = "SELECT existencia FROM combos WHERE idcombo = ? AND codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################	

			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############
			$sql = "UPDATE combos SET "
			." existencia = ? "
			." WHERE "
			." idcombo = ? AND codcombo = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);	
			$stmt->bindParam(4, $codsucursal);	

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = limpiar($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA (DETALLE DE COMBO): ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("2");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($codproductoBD),decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia,
	        	productos.precioxpublico AS precioventa,
	        	productos.ivaproducto,
	        	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($codproductoBD)."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2    = $row['cantidad'];
					$idproductoBD2    = $row['idproducto'];
			        $codproductoBD2   = $row['codproducto'];
					$existenciaBD2    = $row['existencia'];
					$precioventaBD2   = $row['precioventa'];
			        $nomimpuestoBD2   = $row['nomimpuesto'];
			        $valorimpuestoBD2 = $row['valorimpuesto'];
					$ivaproductoBD2   = $row['ivaproducto'];
					$descproductoBD2  = $row['descproducto'];

				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
				    $update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
				    $stmt->bindParam(2, $idproducto);
				    $stmt->bindParam(3, $codproducto);
		            $stmt->bindParam(4, $codsucursal);

				    $racion         = number_format($cantracionBD2*$cantidadBD, 2, '.', '');
				    $cantidadracion = number_format($existenciaBD2+$racion, 2, '.', '');
		            $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
		            $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
				    $stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

				    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
				    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				    $stmt = $this->dbh->prepare($query);
				    $stmt->bindParam(1, $codventa);
				    $stmt->bindParam(2, $codresponsable);
				    $stmt->bindParam(3, $codproducto);
				    $stmt->bindParam(4, $movimiento);
				    $stmt->bindParam(5, $entradas);
				    $stmt->bindParam(6, $salidas);
				    $stmt->bindParam(7, $devolucion);
				    $stmt->bindParam(8, $stockactual);
				    $stmt->bindParam(9, $ivaproducto);
				    $stmt->bindParam(10, $descproducto);
				    $stmt->bindParam(11, $precio);
				    $stmt->bindParam(12, $documento);
				    $stmt->bindParam(13, $fechakardex);	
				    $stmt->bindParam(14, $tipokardex);	
	                $stmt->bindParam(15, $procedimiento);	
				    $stmt->bindParam(16, $codsucursal);
		            $stmt->bindParam(17, $codigo);

				    $codventa       = limpiar(decrypt($_GET["codventa"]));
				    $codresponsable = limpiar($codclienteBD);
				    $codproducto    = limpiar($codproductoBD2);
				    $movimiento     = limpiar("DEVOLUCION");
				    $entradas       = limpiar("0.00");
				    $salidas        = limpiar("0.00");
				    $devolucion     = number_format($racion, 2, '.', '');
				    $stockactual    = number_format($existenciaBD2+$racion, 2, '.', '');
				    $ivaproducto    = limpiar($ivaproductoBD2);
				    $descproducto   = number_format($descproductoBD2, 2, '.', '');
				    $precio         = number_format($precioventaBD2, 2, '.', '');
				    $documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
				    $fechakardex    = limpiar(date("Y-m-d H:i:s"));
				    $tipokardex     = limpiar("1");
	                $procedimiento  = limpiar("2");
				    $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	            $codigo         = limpiar($_SESSION["codigo"]);
				    $stmt->execute();
			        ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########  
			    }
		    }//fin de consulta de productos en combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

		} else { // SI EL DETALLE ES UN SERVICIO

			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);		
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
		    $codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = limpiar("0.00");
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("3");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
		}

		################## ELIMINO DETALLE DE VENTA ##################
		$sql = "DELETE FROM detalleventas WHERE coddetalleventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$coddetalleventa);
		$stmt->bindParam(2,$codsucursal);
		$coddetalleventa = decrypt($_GET["coddetalleventa"]);
		$codsucursal     = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE VENTA ##################

        ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############
	    $sql3 = "SELECT SUM(totaldescuentov) AS totaldescuentosi, SUM(subtotalimpuestos) AS subtotalimpuestos, SUM(valorneto-subtotalimpuestos) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalleventas WHERE codventa = '".limpiar(decrypt($_GET["codventa"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto != 'EXENTO' AND ivaproducto != '0.00'";
	    foreach ($this->dbh->query($sql3) as $row3)
	    {
	     	$this->p[] = $row3;
	    }
	    $subtotaldescuentoiva = ($row3['totaldescuentosi']== "" ? "0.00" : $row3['totaldescuentosi']);
	    $subtotalimpuestosiva = ($row3['subtotalimpuestos']== "" ? "0.00" : $row3['subtotalimpuestos']);
	    $subtotaliva          = ($row3['valorneto']== "" ? "0.00" : $row3['valorneto']);
	    $subtotaliva2         = ($row3['valorneto2']== "" ? "0.00" : $row3['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS CON IVA ##############

	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############
	    $sql5 = "SELECT SUM(totaldescuentov) AS totaldescuentono, SUM(valorneto) AS valorneto, SUM(valorneto2) AS valorneto2 FROM detalleventas WHERE codventa = '".limpiar(decrypt($_GET["codventa"]))."' AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."' AND tipoimpuesto = 'EXENTO' AND ivaproducto = '0.00'";
	    foreach ($this->dbh->query($sql5) as $row5)
	    {
	     	$this->p[] = $row5;
	    }
	    $subtotaldescuentoexento = ($row5['totaldescuentono']== "" ? "0.00" : $row5['totaldescuentono']);
	    $subtotalexento          = ($row5['valorneto']== "" ? "0.00" : $row5['valorneto']);
	    $subtotalexento2         = ($row5['valorneto2']== "" ? "0.00" : $row5['valorneto2']);
	    ############ SUMO LOS IMPORTE DE PRODUCTOS EXENTO ##############

        ############ ACTUALIZO LOS TOTALES EN LA VENTA ##############
		$sql = " UPDATE ventas SET "
		." subtotal = ?, "
		." subtotalexento = ?, "
		." subtotaliva = ?, "
		." totaliva = ?, "
		." descontado = ?, "
		." totaldescuento = ?, "
		." totalpago = ?, "
		." totalpago2= ? "
		." WHERE "
		." codventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtSubtotal);
	    $stmt->bindParam(2, $TxtSubtotalExento);
	    $stmt->bindParam(3, $TxtSubtotalIva);
	    $stmt->bindParam(4, $TxtTotalIva);
	    $stmt->bindParam(5, $TxtDescontado);
	    $stmt->bindParam(6, $TxtTotalDescuento);
	    $stmt->bindParam(7, $totalpago);
		$stmt->bindParam(8, $totalpago2);
		$stmt->bindParam(9, $codventa);
		$stmt->bindParam(10, $codsucursal);

		/*###################################################### CALCULO DE DESCUENTO ######################################################*/
		//PORCENTAJE DESCUENTO
	    $descuento  = $descuentoBD;
	    $Porcentaje = $descuento/100;

	    //PORCENTAJE IVA
	    $txtIva        = $ivaBD;
	    $PorcentajeIva = $txtIva/100;

	    /*OBTENGO DESCUENTO DE EXENTO*/
	    $RestoExento       = number_format($subtotalexento*$Porcentaje, 2, '.', '');
	    $TxtSubtotalExento = number_format($subtotalexento-$RestoExento, 2, '.', '');

	    /*OBTENGO SUBTOTAL IVA*/
	    $RestoSubtotalIva = number_format($subtotaliva*$Porcentaje, 2, '.', '');
	    $TxtSubtotalIva   = number_format($subtotaliva-$RestoSubtotalIva, 2, '.', '');
	    /*OBTENGO TOTAL IVA*/
	    $TxtTotalIva      = number_format($TxtSubtotalIva*$PorcentajeIva, 2, '.', '');
	   
	    //CALCULO DE TOTAL FACTURA
	    $TxtDescontado     = number_format($subtotaldescuentoiva+$subtotaldescuentoexento, 2, '.', '');
	    $TxtTotalDescuento = number_format($RestoExento+$RestoSubtotalIva, 2, '.', '');
	    $TxtSubtotal       = number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '');
	    $totalpago         = ($exoneradoBD == 2 ? number_format($TxtSubtotalExento+$TxtSubtotalIva, 2, '.', '') : number_format($TxtSubtotalExento+$TxtSubtotalIva+$TxtTotalIva, 2, '.', ''));
	    $totalpago2        = number_format($subtotaliva2+$subtotalexento2, 2, '.', '');
	    /*###################################################### CALCULO DE DESCUENTO ######################################################*/
		
		$codventa    = limpiar(decrypt($_GET["codventa"]));
		$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute();
		############ ACTUALIZO LOS TOTALES EN LA VENTA ##############

		#################### QUITAMOS LA DIFERENCIA EN CAJA ####################
		if ($tipopagoBD == "CONTADO"){

		    ################# OBTENGO DATOS DE ARQUEO #################
			$sql = "SELECT ingresos FROM arqueocaja WHERE codarqueo = $codarqueoBD";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$ingresoBD = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
			################# OBTENGO DATOS DE ARQUEO #################

		    ################# ACTUALIZO DATOS DE ARQUEO #################
			$sql = "UPDATE arqueocaja set "
			    ." ingresos = ? "
			    ." WHERE "
			    ." codarqueo = ?;
			    ";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $TxtTotal);
			$stmt->bindParam(2, $codarqueo);

	        $MontoCalculo = number_format($totalpagoBD-$totalpago, 2, '.', '');
	        $TxtTotal     = number_format($ingresoBD-$MontoCalculo, 2, '.', '');
	        $codarqueo    = limpiar($codarqueoBD);
			$stmt->execute();
			################# ACTUALIZO DATOS DE ARQUEO #################
		}
	    #################### QUITAMOS LA DIFERENCIA EN CAJA ####################
	    
	    ############## QUITAMOS LA DIFERENCIA EN CAJA ##################
		if ($tipopagoBD == "CREDITO") {

			################# OBTENGO DATOS DE ARQUEO #################
			$sql = "SELECT creditos, abonos FROM arqueocaja WHERE codarqueo = $codarqueoBD";
			foreach ($this->dbh->query($sql) as $row)
			{
				$this->p[] = $row;
			}
			$creditoBD = ($row['creditos']== "" ? "0.00" : $row['creditos']);
			$abonoBD   = ($row['abonos']== "" ? "0.00" : $row['abonos']);
			################# OBTENGO DATOS DE ARQUEO #################

			################# ACTUALIZO DATOS DE ARQUEO #################
		    $sql = "UPDATE arqueocaja SET"
		    ." creditos = ?, "
		    ." abonos = ? "
		    ." WHERE "
		    ." codarqueo = ?;
		    ";
		    $stmt = $this->dbh->prepare($sql);
		    $stmt->bindParam(1, $TxtTotal);
		    $stmt->bindParam(2, $TxtAbonos);
		    $stmt->bindParam(3, $codarqueo);

		    $MontoCalculo = number_format($totalpagoBD-$totalpago, 2, '.', '');
		    $TxtTotal     = ($creditopagadoBD == "0.00" ? number_format($creditoBD-$MontoCalculo, 2, '.', '') : number_format($creditoBD-($MontoCalculo-$creditopagadoBD), 2, '.', ''));
		    $TxtAbonos    = number_format($abonoBD-$creditopagadoBD, 2, '.', '');
		    $codarqueo    = limpiar($codarqueoBD);
		    $stmt->execute();
		    ################# ACTUALIZO DATOS DE ARQUEO #################

		    ################# ACTUALIZO DATOS DE CREDITO A CLIENTE #################
		    $sql = "UPDATE creditosxclientes SET"
		    ." montocredito = ? "
			." WHERE "
			." codcliente = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $montocredito);
			$stmt->bindParam(2, $codcliente);
			$stmt->bindParam(3, $codsucursal);

			$codcliente   = limpiar($codclienteBD);
			$MontoCalculo = number_format($totalpagoBD-$totalpago, 2, '.', '');
			$montocredito = number_format($montocreditoBD-($MontoCalculo-$creditopagadoBD), 2, '.', '');
			$codsucursal  = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute(); 
			################# ACTUALIZO DATOS DE CREDITO A CLIENTE #################
		}
	    ############## QUITAMOS LA DIFERENCIA EN CAJA ##################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	} 

	} else {
		
		echo "3";
		exit;
	}	
}
######################## FUNCION ELIMINAR DETALLES VENTAS ########################

####################### FUNCION ELIMINAR VENTAS ########################
public function EliminarVentas()
{
	self::SetNames();
	if ($_SESSION["acceso"]=="administradorS" || $_SESSION["acceso"]=="secretaria" || $_SESSION["acceso"]=="cajero") {

    ############ CONSULTO TOTAL ACTUAL ##############
	$sql = "SELECT
	codfactura, 
	codarqueo,  
	codcaja, 
	codcliente, 
	exonerado,
	iva,
	descuento, 
	tipopago, 
	totalpago, 
	creditopagado 
	FROM ventas WHERE codventa = '".limpiar(decrypt($_GET["codventa"]))."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$codfacturaBD    = $row['codfactura'];
	$codarqueoBD     = $row['codarqueo'];
	$codcajaBD       = $row['codcaja'];
	$codclienteBD    = $row['codcliente'];
	$exoneradoBD     = $row['exonerado'];
	$ivaBD           = $row["iva"];
	$descuentoBD     = $row["descuento"];
	$tipopagoBD      = $row['tipopago'];
	$totalpagoBD     = $row['totalpago'];
	$creditopagadoBD = $row['creditopagado'];
	############ CONSULTO TOTAL ACTUAL ##############

	################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################
	$sql = "SELECT montocredito FROM creditosxclientes 
	WHERE codcliente = '".$codclienteBD."' 
	AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
    $montocreditoBD = (empty($row['montocredito']) ? "0.00" : $row['montocredito']);
    ################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################

    $sql = "SELECT * FROM detalleventas 
    WHERE codventa = '".limpiar(decrypt($_GET["codventa"]))."' 
    AND codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'";
	$array=array();

	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;

		$idproductoBD       = $row['idproducto'];
		$codproductoBD      = $row['codproducto'];
		$imeiBD             = $row['imei'];
		$cantidadBD         = $row['cantidad'];
		$precioventaBD      = $row['precioventa'];
		$posicionimpuestoBD = $row['posicionimpuesto'];
		$tipoimpuestoBD     = $row['tipoimpuesto'];
		$ivaproductoBD      = $row['ivaproducto'];
		$descproductoBD     = $row['descproducto'];
		$tipodetalleBD      = $row['tipodetalle'];

		if(limpiar($tipodetalleBD) == 1){// SSI EL DETALLE ES UN PRODCUTO

			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############ OBTENGO LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############
			$sql = "UPDATE productos SET "
			." existencia = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $codsucursal);

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			############ ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("1");	
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			################### ACTUALIZO EL ESTADO DE IMEI ###################
			if($imeiBD != ""){

				$valoresArray = explode(',', $imeiBD);
			    $sql = "UPDATE imei SET estadoimei = ?
				WHERE numeroimei IN (".implode(',', $valoresArray).") 
				AND codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."';";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $estadoimei);
				$estadoimei = "1";
				$stmt->execute();
			}
			################### ACTUALIZO EL ESTADO DE IMEI ###################

		} elseif(limpiar($tipodetalleBD) == 2){ // SI EL DETALLE ES UN COMBO

			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql2 = "SELECT existencia FROM combos WHERE idcombo = ? AND codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($idproductoBD,$codproductoBD,decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################	

			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############
			$sql = "UPDATE combos SET "
			." existencia = ? "
			." WHERE "
			." idcombo = ? AND codcombo = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);	
			$stmt->bindParam(4, $codsucursal);	

			$existencia  = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$idproducto  = limpiar($idproductoBD);
			$codproducto = limpiar($codproductoBD);
			$codsucursal = limpiar(decrypt($_GET["codsucursal"]));
			$stmt->execute();
			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
			$codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = number_format($existenciaBD+$cantidadBD, 2, '.', '');
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = limpiar($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA (DETALLE DE COMBO): ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("2");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($codproductoBD),decrypt($_GET["codsucursal"])));
			$num = $stmt->rowCount();
	        if($num>0) {  

	        	$sql = "SELECT 
	        	combosxproductos.codcombo,
	    	    combosxproductos.idproducto,
	        	combosxproductos.codproducto,
	        	combosxproductos.cantidad,
	        	combosxproductos.codsucursal,
	        	productos.existencia,
	        	productos.precioxpublico AS precioventa,
	        	productos.ivaproducto,
	        	productos.descproducto,
	    	    impuestos.codimpuesto,
	    	    impuestos.nomimpuesto,
	    	    impuestos.valorimpuesto
		    	FROM combosxproductos 
	        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	    LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
	        	WHERE combosxproductos.codcombo IN ('".limpiar($codproductoBD)."') 
	        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."' 
		    	AND productos.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'";
	        	foreach ($this->dbh->query($sql) as $row)
			    { 
				    $this->p[] = $row;

				    $cantracionBD2    = $row['cantidad'];
					$idproductoBD2    = $row['idproducto'];
			        $codproductoBD2   = $row['codproducto'];
					$existenciaBD2    = $row['existencia'];
					$precioventaBD2   = $row['precioventa'];
			        $nomimpuestoBD2   = $row['nomimpuesto'];
			        $valorimpuestoBD2 = $row['valorimpuesto'];
					$ivaproductoBD2   = $row['ivaproducto'];
					$descproductoBD2  = $row['descproducto'];

					############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
				    $update = "UPDATE productos set "
				    ." existencia = ? "
				    ." WHERE "
				    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
				    ";
				    $stmt = $this->dbh->prepare($update);
				    $stmt->bindParam(1, $cantidadracion);
				    $stmt->bindParam(2, $idproducto);
				    $stmt->bindParam(3, $codproducto);
		            $stmt->bindParam(4, $codsucursal);

				    $racion         = number_format($cantracionBD2*$cantidadBD, 2, '.', '');
				    $cantidadracion = number_format($existenciaBD2+$racion, 2, '.', '');
		            $idproducto     = limpiar($idproductoBD2);
		            $codproducto    = limpiar($codproductoBD2);
		            $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
				    $stmt->execute();
				    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

				    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
				    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				    $stmt = $this->dbh->prepare($query);
				    $stmt->bindParam(1, $codventa);
				    $stmt->bindParam(2, $codresponsable);
				    $stmt->bindParam(3, $codproducto);
				    $stmt->bindParam(4, $movimiento);
				    $stmt->bindParam(5, $entradas);
				    $stmt->bindParam(6, $salidas);
				    $stmt->bindParam(7, $devolucion);
				    $stmt->bindParam(8, $stockactual);
				    $stmt->bindParam(9, $ivaproducto);
				    $stmt->bindParam(10, $descproducto);
				    $stmt->bindParam(11, $precio);
				    $stmt->bindParam(12, $documento);
				    $stmt->bindParam(13, $fechakardex);	
				    $stmt->bindParam(14, $tipokardex);	
	                $stmt->bindParam(15, $procedimiento);	
				    $stmt->bindParam(16, $codsucursal);
		            $stmt->bindParam(17, $codigo);

				    $codventa       = limpiar(decrypt($_GET["codventa"]));
				    $codresponsable = limpiar($codclienteBD);
				    $codproducto    = limpiar($codproductoBD2);
				    $movimiento     = limpiar("DEVOLUCION");
				    $entradas       = limpiar("0.00");
				    $salidas        = limpiar("0.00");
				    $devolucion     = number_format($racion, 2, '.', '');
				    $stockactual    = number_format($existenciaBD2+$racion, 2, '.', '');
				    $ivaproducto    = limpiar($ivaproductoBD2);
				    $descproducto   = number_format($descproductoBD2, 2, '.', '');
				    $precio         = number_format($precioventaBD2, 2, '.', '');
				    $documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
				    $fechakardex    = limpiar(date("Y-m-d H:i:s"));
				    $tipokardex     = limpiar("1");
	                $procedimiento  = limpiar("2");
				    $codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	            $codigo         = limpiar($_SESSION["codigo"]);
				    $stmt->execute();
			        ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ########## 
			    }
		    }//fin de consulta de productos en combos	
		    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

		} else { // SI EL DETALLE ES UN SERVICIO

			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codventa);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);		
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codventa       = limpiar(decrypt($_GET["codventa"]));
			$codresponsable = limpiar($codclienteBD);
		    $codproducto    = limpiar($codproductoBD);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($cantidadBD, 2, '.', '');
			$stockactual    = limpiar("0.00");
			$ivaproducto    = limpiar($tipoimpuestoBD == "EXENTO" ? "EXENTO" : $tipoimpuestoBD." (".$ivaproductoBD." %)");
			$descproducto   = number_format($descproductoBD, 2, '.', '');
			$precio         = number_format($precioventaBD, 2, '.', '');
			$documento      = limpiar("DEVOLUCION VENTA: ".$codfacturaBD);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($tipodetalleBD);
	        $procedimiento  = limpiar("3");
			$codsucursal    = limpiar(decrypt($_GET["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL SERVICIO ELIMINADO EN KARDEX ##########
		}
	}

	#################### QUITAMOS LA DIFERENCIA EN CAJA ####################
	if ($tipopagoBD == "CONTADO"){

	    ################# OBTENGO DATOS DE ARQUEO #################
		$sql = "SELECT ingresos FROM arqueocaja WHERE codarqueo = $codarqueoBD";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$ingresoBD = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		################# OBTENGO DATOS DE ARQUEO #################

	    ################# ACTUALIZO DATOS DE ARQUEO #################
		$sql = "UPDATE arqueocaja set "
		    ." ingresos = ? "
		    ." WHERE "
		    ." codarqueo = ?;
		    ";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $TxtTotal);
		$stmt->bindParam(2, $codarqueo);

        $TxtTotal     = number_format($ingresoBD-$totalpagoBD, 2, '.', '');
        $codarqueo    = limpiar($codarqueoBD);
		$stmt->execute();
		################# ACTUALIZO DATOS DE ARQUEO #################
	}
    #################### QUITAMOS LA DIFERENCIA EN CAJA ####################

    ############## QUITAMOS LA DIFERENCIA EN CAJA ##################
	if ($tipodetalleBD == "CREDITO") {

	    ################# OBTENGO DATOS DE ARQUEO #################
		$sql = "SELECT creditos, abonos FROM arqueocaja WHERE codarqueo = $codarqueoBD";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		$creditoBD = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD   = ($row['abonos']== "" ? "0.00" : $row['abonos']);
		################# OBTENGO DATOS DE ARQUEO #################

	    ################# ACTUALIZO DATOS DE ARQUEO #################
	    $sql = "UPDATE arqueocaja SET"
	    ." creditos = ?, "
	    ." abonos = ? "
	    ." WHERE "
	    ." codarqueo = ?;
	    ";
	    $stmt = $this->dbh->prepare($sql);
	    $stmt->bindParam(1, $TxtTotal);
	    $stmt->bindParam(2, $TxtAbonos);
	    $stmt->bindParam(3, $codarqueo);

	    $MontoCalculo = number_format($totalpagoBD-$totalpago, 2, '.', '');
	    $TxtTotal     = ($creditopagadoBD == "0.00" ? number_format($creditoBD-$totalpagoBD, 2, '.', '') : number_format($creditoBD-($totalpagoBD-$creditopagadoBD), 2, '.', ''));
	    $TxtAbonos    = number_format($abonoBD-$creditopagadoBD, 2, '.', '');
	    $codarqueo    = limpiar($codarqueoBD);
	    $stmt->execute();
	    ################# ACTUALIZO DATOS DE ARQUEO #################

        ################# ACTUALIZO DATOS DE CREDITO A CLIENTE #################
	    $sql = "UPDATE creditosxclientes SET"
	    ." montocredito = ? "
		." WHERE "
		." codcliente = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $montocredito);
		$stmt->bindParam(2, $codcliente);
		$stmt->bindParam(3, $codsucursal);

		$montocredito = number_format($montocreditoBD-($totalpagoBD-$creditopagadoBD), 2, '.', '');
		$codcliente   = limpiar($codclienteBD);
		$codsucursal  = limpiar(decrypt($_GET["codsucursal"]));
		$stmt->execute(); 
		################# ACTUALIZO DATOS DE CREDITO A CLIENTE #################

		################## ELIMINO ABONOS ASOCIADOS ##################
	    $sql = "DELETE FROM abonoscreditosventas WHERE codventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codventa);
		$stmt->bindParam(2,$codsucursal);

		$codventa    = decrypt($_GET["codventa"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO ABONOS ASOCIADOS ##################
	}
    ############## QUITAMOS LA DIFERENCIA EN CAJA ##################

		################## ELIMINO VENTA ##################
	    $sql = "DELETE FROM ventas WHERE codventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codventa);
		$stmt->bindParam(2,$codsucursal);

		$codventa    = decrypt($_GET["codventa"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO VENTA ##################

		################## ELIMINO DETALLE DE VENTA ##################
		$sql = "DELETE FROM detalleventas WHERE codventa = ? AND codsucursal = ?";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1,$codventa);
		$stmt->bindParam(2,$codsucursal);

		$codventa    = decrypt($_GET["codventa"]);
		$codsucursal = decrypt($_GET["codsucursal"]);
		$stmt->execute();
		################## ELIMINO DETALLE DE VENTA ##################

		echo "1";
		exit;

	} else {

		echo "2";
		exit;
	}
}
######################### FUNCION ELIMINAR VENTAS ############################

######################### FUNCION LISTAR VENTAS DIARIAS ###########################
public function BuscarVentasDiarias()
{
	self::SetNames();
	if($_SESSION['acceso'] == "administradorS") {

		$sql = "SELECT
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa, 
		ventas.codfactura,
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago, 
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,   
		ventas.notacredito,  
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
		LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND DATE_FORMAT(ventas.fechaventa,'%d-%m-%Y') = '".date("d-m-Y")."' 
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente,
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago
		ORDER BY ventas.codventa DESC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

	} else {

		$sql = "SELECT
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa, 
		ventas.codfactura,
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,   
		ventas.notacredito,  
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3,
		mediospagos.mediopago,
		SUM(detalleventas.cantidad) AS articulos 
		FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
		LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
		LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
		LEFT JOIN
	      (SELECT
	      codcambio, descripcioncambio, montocambio, codmoneda       
	      FROM tiposcambio
	      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codigo = '".limpiar($_SESSION["codigo"])."' 
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND DATE_FORMAT(ventas.fechaventa,'%d-%m-%Y') = '".date("d-m-Y")."' 
		GROUP BY
		ventas.idventa, 
		ventas.tipodocumento, 
		ventas.codventa,
		ventas.codfactura, 
		ventas.codserie, 
		ventas.codautorizacion, 
		ventas.codcaja, 
		ventas.codcliente, 
		ventas.exonerado,  
		ventas.subtotal,
		ventas.subtotalexento, 
		ventas.subtotaliva, 
		ventas.iva, 
		ventas.totaliva, 
		ventas.descontado, 
		ventas.descuento, 
		ventas.totaldescuento, 
		ventas.totalpago,  
		ventas.totalpago2, 
		ventas.tipopago, 
		ventas.formapago, 
		ventas.montopagado, 
		ventas.montodevuelto, 
		ventas.fechavencecredito, 
		ventas.fechapagado,
		ventas.statusventa, 
		ventas.fechaventa,
		ventas.observaciones,  
		ventas.notacredito, 
		ventas.codigo,
		ventas.codsucursal,
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		usuarios.dni,
		usuarios.nombres,
		cajas.nrocaja,
		cajas.nomcaja,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3,
		mediospagos.mediopago
		ORDER BY ventas.codventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION LISTAR VENTAS DIARIAS ######################

###################### FUNCION BUSQUEDA LIBRO DE VENTAS POR FECHAS ###########################
public function BuscarLibroVentasxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	MAX(ventas.idventa) AS idventa, 
	MAX(ventas.codventa) AS codventa,
	MAX(ventas.tipodocumento) AS tipodocumento, 
	MAX(ventas.codfactura) AS codfactura, 
	MAX(ventas.codcliente) AS codcliente,
	SUM(if(ventas.exonerado=2,ventas.subtotal,'0.00')) AS totalexonerado, 
	SUM(ventas.subtotal) AS subtotal,
	SUM(if(ventas.exonerado!=2,ventas.subtotalexento,'0.00')) AS subtotalexento, 
	SUM(if(ventas.exonerado!=2,ventas.subtotaliva,'0.00')) AS subtotaliva, 
	SUM(if(ventas.exonerado!=2,ventas.totaliva,'0.00')) AS totaliva, 
	SUM(ventas.descontado) AS descontado, 
	MAX(ventas.descuento) AS descuento, 
	SUM(ventas.totaldescuento) AS totaldescuento, 
	SUM(ventas.totalpago) AS totalpago, 
	MAX(ventas.tipopago) AS tipopago, 
	DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') AS fechaventa, 
    ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	documentos.documento,
    documentos2.documento AS documento2, 
	provincias.provincia,
    departamentos.departamento,
    GROUP_CONCAT(ventas.codfactura SEPARATOR ', ') AS detalles_facturas
	FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	WHERE ventas.codsucursal = ?
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND (ventas.tipodocumento != 'NOTA_VENTA_5' or ventas.tipodocumento != 'NOTA_VENTA_8')  
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d'), ventas.codsucursal, sucursales.documsucursal, sucursales.cuitsucursal, sucursales.nomsucursal, sucursales.documencargado, sucursales.dniencargado, sucursales.nomencargado, sucursales.codmoneda, tiposmoneda.moneda, tiposmoneda.siglas, tiposmoneda.simbolo, documentos.documento, documentos2.documento, provincias.provincia, departamentos.departamento";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA LIBRO DE VENTAS POR FECHAS ###########################

###################### FUNCION BUSQUEDA LIBRO DE VENTAS NOTAS CREDITO POR FECHAS ###########################
public function BuscarLibroVentasNCxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	SUM(if(notascredito.exonerado=2,notascredito.subtotal,'0.00')) AS totalexoneradonc, 
	SUM(notascredito.subtotal) AS subtotal,
	SUM(if(notascredito.exonerado!=2,notascredito.subtotalexento,'0.00')) AS subtotalexentonc, 
	SUM(if(notascredito.exonerado!=2,notascredito.subtotaliva,'0.00')) AS subtotalivanc, 
	SUM(if(notascredito.exonerado!=2,notascredito.totaliva,'0.00')) AS totalivanc, 
	SUM(notascredito.descontado) AS descontadonc,
	MAX(notascredito.descuento) AS descuento, 
	SUM(notascredito.totaldescuento) AS totaldescuento, 
	SUM(notascredito.totalpago) AS totalpagonc, 
	DATE_FORMAT(notascredito.fechanota,'%Y-%m-%d') AS fechanota, 
    notascredito.codsucursal
    FROM notascredito WHERE notascredito.codsucursal = ?
	AND DATE_FORMAT(notascredito.fechanota,'%Y-%m-%d') BETWEEN ? AND ?
	AND notascredito.tipodocumento != 'NOTA DE VENTA'  
	GROUP BY DATE_FORMAT(notascredito.fechanota,'%Y-%m-%d'), notascredito.codsucursal";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
public function BuscarLibroVentasNCxFechas2() 
{
	self::SetNames();
	$sql ="SELECT 
	SUM(if(ventas.exonerado=2,ventas.subtotal,'0.00')) AS totalexoneradonc, 
	SUM(ventas.subtotal) AS subtotal,
	SUM(if(ventas.exonerado!=2,ventas.subtotalexento,'0.00')) AS subtotalexentonc, 
	SUM(if(ventas.exonerado!=2,ventas.subtotaliva,'0.00')) AS subtotalivanc, 
	SUM(if(ventas.exonerado!=2,ventas.totaliva,'0.00')) AS totalivanc, 
	SUM(ventas.descontado) AS descontadonc,
	MAX(ventas.descuento) AS descuento, 
	SUM(ventas.totaldescuento) AS totaldescuento, 
	SUM(ventas.totalpago) AS totalpagonc, 
	ventas.statusventa,
	DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') AS fechaventa, 
    ventas.codsucursal
    FROM ventas WHERE ventas.codsucursal = ?
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND (ventas.tipodocumento != 'NOTA_VENTA_5' or ventas.tipodocumento != 'NOTA_VENTA_8')  
	AND ventas.notacredito = 1 
	GROUP BY ventas.statusventa, ventas.codsucursal";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA LIBRO DE VENTAS NOTAS CREDITO POR FECHAS ###########################

###################### FUNCION BUSQUEDA COMISIONES POR CAJAS ###########################
public function BuscarComisionesxCajas() 
{
	self::SetNames();
	
	$sql = "SELECT 
		p.codproducto,
		p.producto,
		p.tipo_comision,
		p.comision_venta,
		SUM(dv.cantidad) as cantidad_vendida,
		AVG(dv.precioventa) as precio_unitario,
		SUM(dv.cantidad * dv.precioventa) as total_venta,
		CASE 
			WHEN p.tipo_comision = 'PORCENTAJE' THEN SUM((dv.cantidad * dv.precioventa) * (p.comision_venta / 100))
			WHEN p.tipo_comision = 'VALOR' THEN SUM(dv.cantidad * p.comision_venta)
			ELSE 0
		END as comision_generada,
		s.nomsucursal,
		tm.simbolo
	FROM detalleventas dv
	INNER JOIN ventas v ON dv.codventa = v.codventa
	INNER JOIN productos p ON dv.codproducto = p.codproducto AND dv.codsucursal = p.codsucursal
	INNER JOIN sucursales s ON v.codsucursal = s.codsucursal
	LEFT JOIN tiposmoneda tm ON s.codmoneda = tm.codmoneda
	WHERE v.codsucursal = ?
	AND v.codcaja = ?
	AND DATE_FORMAT(v.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND v.statusventa != 'ANULADA'
	AND p.tipo_comision != 'NINGUNA'
	AND p.comision_venta > 0
	GROUP BY p.codproducto, p.producto, p.tipo_comision, p.comision_venta, s.nomsucursal, tm.simbolo
	ORDER BY comision_generada DESC";
	
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(
		decrypt($_GET['codsucursal']), 
		decrypt($_GET['codcaja']), 
		date("Y-m-d", strtotime($_GET['desde'])), 
		date("Y-m-d", strtotime($_GET['hasta']))
	));
	$num = $stmt->rowCount();
	if($num > 0) {
		while($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
			$this->p[] = $row;
		}
		return $this->p;
	}
	$this->dbh = null;
}

public function BuscarInfoCaja() 
{
	self::SetNames();
	$this->p = array(); // Reiniciar el array para evitar conflictos
	
	$sql = "SELECT 
		c.codcaja,
		c.nrocaja,
		c.nomcaja,
		u.nombres
	FROM cajas c
	LEFT JOIN usuarios u ON c.codigo = u.codigo
	WHERE c.codcaja = ?";
	
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET['codcaja'])));
	$num = $stmt->rowCount();
	if($num > 0) {
		while($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
			$this->p[] = $row;
		}
		return $this->p;
	}
	$this->dbh = null;
}
###################### FUNCION BUSQUEDA COMISIONES POR CAJAS ###########################

###################### FUNCION BUSQUEDA VENTAS POR CAJAS ###########################
public function BuscarVentasxCajas() 
{
	self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){

	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcaja = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){

	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcaja = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){

	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcaja = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";
	}
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA VENTAS POR CAJAS ###########################

###################### FUNCION BUSQUEDA VENTAS POR FECHAS ###########################
public function BuscarVentasxFechas() 
{
	self::SetNames();
	
	if(decrypt($_GET['tipopago']) == 1){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA VENTAS POR FECHAS ###########################

###################### FUNCION BUSQUEDA VENTAS POR CLIENTES ###########################
public function BuscarVentasxClientes() 
{
	self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.statusventa != 'ANULADA'  
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA'  
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	SUM(detalleventas.cantidad) as articulos,
	GROUP_CONCAT(ROUND(detalleventas.cantidad, 2), ' | ', detalleventas.producto, ' | ', detalleventas.descripcion SEPARATOR '<br>') AS detalles_productos 
	FROM (ventas LEFT JOIN detalleventas ON detalleventas.codventa=ventas.codventa)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago
	ORDER BY ventas.codventa ASC";
	}
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codcliente']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA VENTAS POR CLIENTES ###########################

###################### FUNCION BUSQUEDA VENTAS POR CONDICION DE PAGO Y FECHAS ###########################
public function BuscarVentasxCondiciones() 
{
	self::SetNames();
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
	pag.articulos,
	pag.detalles_productos,
	mediospagos.mediopago,
	mediospagoxventas.idpago,
    mediospagoxventas.codventa,
    mediospagoxventas.codmediopago, 
    SUM(mediospagoxventas.montopagado-mediospagoxventas.montodevuelto) AS suma_pagado
  	FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN mediospagoxventas ON ventas.codventa = mediospagoxventas.codventa
	LEFT JOIN mediospagos ON mediospagoxventas.codmediopago = mediospagos.codmediopago
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
			LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
			WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ?
	AND ventas.codcaja = ?
	AND (DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?)
	AND mediospagoxventas.codmediopago = '".limpiar(decrypt($_GET['formapago']))."' 
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago,
	mediospagoxventas.idpago,
    mediospagoxventas.codventa,
    mediospagoxventas.codmediopago
	ORDER BY ventas.codventa ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA VENTAS POR CONDICION DE PAGO Y FECHAS ###########################

###################### FUNCION BUSQUEDA COMISION POR VENTAS ###########################
public function BuscarComisionxVentas() 
{
	self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
    usuarios.comision,
    pag.articulos,
	pag.valorneto,
	pag.detalles_productos
  	FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
		SUM(detalleventas.valorneto) AS valorneto,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
			LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
			WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codigo = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	usuarios.comision,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago,
	articulos,
	detalles_productos,
	pag.valorneto
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
    usuarios.comision,
    pag.articulos,
	pag.valorneto,
	pag.detalles_productos
	FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
		SUM(detalleventas.valorneto) AS valorneto,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
			LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
			WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	WHERE ventas.codsucursal = ? 
	AND ventas.codigo = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	usuarios.comision,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago,
	articulos,
	detalles_productos,
	pag.valorneto
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){
		
	$sql ="SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,  
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito,
    ventas.fechapagado, 
	ventas.statusventa, 
	ventas.fechaventa, 
    ventas.observaciones,  
	ventas.notacredito,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	provincias.provincia,
	departamentos.departamento,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni,
    usuarios.nombres,
    usuarios.comision,
    pag.articulos,
	pag.valorneto,
	pag.detalles_productos 
	FROM (ventas LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias ON clientes.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON clientes.id_departamento = departamentos.id_departamento
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
		SUM(detalleventas.valorneto) AS valorneto,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
			LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
			WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
			GROUP BY
			detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 

	WHERE ventas.codsucursal = ? 
	AND ventas.codigo = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago, 
	ventas.totalpago2, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
	ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
	ventas.observaciones,  
	ventas.notacredito, 
	ventas.codigo,
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos.documento,
	documento2, 
	documento3,
	provincias.provincia,
	departamentos.departamento,
	usuarios.dni,
	usuarios.nombres,
	usuarios.comision,
	cajas.nrocaja,
	cajas.nomcaja,
	mediospagos.mediopago,
	articulos,
	detalles_productos,
	pag.valorneto
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codigo']));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA COMISION POR VENTAS ###########################

###################### FUNCION BUSCAR DETALLES VENTAS POR CONDICIONES #########################
public function BuscarDetallesVentasxCondiciones() 
{
    self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){

		if(decrypt($_GET['tipodetalle']) == 0){//busqueda general

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.statusventa != 'ANULADA'
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
		    ORDER BY detalleventas.codproducto ASC";

		} elseif(decrypt($_GET['tipodetalle']) == 1){//busqueda productos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 1
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 2){//busqueda combos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 2
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 3){//busqueda servicios

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 3
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
		    ORDER BY detalleventas.codproducto ASC";

		}

	} elseif(decrypt($_GET['tipopago']) == 2){

		if(decrypt($_GET['tipodetalle']) == 0){//busqueda general

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CONTADO'
			AND ventas.statusventa != 'ANULADA'
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} elseif(decrypt($_GET['tipodetalle']) == 1){//busqueda productos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CONTADO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 1
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 2){//busqueda combos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CONTADO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 2
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 3){//busqueda servicios

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CONTADO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 3
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		}
		
	} elseif(decrypt($_GET['tipopago']) == 3){

		if(decrypt($_GET['tipodetalle']) == 0){//busqueda general

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CREDITO'
			AND ventas.statusventa != 'ANULADA'
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} elseif(decrypt($_GET['tipodetalle']) == 1){//busqueda productos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CREDITO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 1
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 2){//busqueda combos

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CREDITO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 2
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} else if(decrypt($_GET['tipodetalle']) == 3){//busqueda servicios

			$sql ="SELECT 
		    detalleventas.idproducto,
		    detalleventas.codproducto,
		    detalleventas.producto,
			detalleventas.descripcion,
			detalleventas.imei,
			detalleventas.condicion,
		    detalleventas.codmarca,
		    detalleventas.codmodelo,
		    detalleventas.codpresentacion,
			detalleventas.codcolor,
		    detalleventas.precioventa,
			detalleventas.posicionimpuesto,
			detalleventas.tipoimpuesto,   
		    detalleventas.ivaproducto,
		    detalleventas.descproducto,
		    detalleventas.valortotal,
		    detalleventas.valorneto,
		    detalleventas.tipodetalle,
		    productos.existencia,
		    marcas.nommarca, 
		    modelos.nommodelo, 
		    presentaciones.nompresentacion,
			colores.nomcolor,
		    combos.existencia AS cantcombo,
		    ventas.iva, 
		    ventas.fechaventa,  
		    sucursales.documsucursal,
		    sucursales.cuitsucursal, 
		    sucursales.nomsucursal,  
		    sucursales.documencargado,
		    sucursales.dniencargado,
		    sucursales.nomencargado,
		    sucursales.codmoneda,
		    sucursales.codmoneda2,
	        sucursales.ticket_general,
		    documentos.documento,
		    documentos2.documento AS documento2,
		    tiposmoneda.moneda,
		    tiposmoneda.siglas,
		    tiposmoneda.simbolo,
		    tiposmoneda2.moneda AS moneda2,
		    tiposmoneda2.siglas AS siglas2,
		    tiposmoneda2.simbolo AS simbolo2,
		    valor_cambio.montocambio, 
		    SUM(detalleventas.cantidad) AS cantidad,
			SUM(detalleventas.totaldescuentov) as totaldescuentov,
			SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
		    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
		    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
		    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
		    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
		    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
		    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
		    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
		    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
			LEFT JOIN
		      (SELECT
		      codcambio, descripcioncambio, montocambio, codmoneda       
		      FROM tiposcambio
		      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
		    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
			AND ventas.tipopago = 'CREDITO'
			AND ventas.statusventa != 'ANULADA'
			AND detalleventas.tipodetalle = 3
		    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
		    ORDER BY detalleventas.codproducto ASC";

		} 
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES VENTAS POR CONDICIONES ###############################

###################### FUNCION BUSCAR DETALLES VENTAS POR FECHAS #########################
public function BuscarDetallesVentasxFechas() 
{
    self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,  
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor  
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
    ORDER BY detalleventas.codproducto ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,  
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,  
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo  
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."' 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC"; 
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES VENTAS POR FECHAS ###############################

###################### FUNCION BUSCAR DETALLES VENTAS POR VENDEDOR #########################
public function BuscarDetallesVentasxVendedor() 
{
	self::SetNames();
	if(decrypt($_GET['tipopago']) == 1){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,   
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo 
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."'
    AND ventas.codigo = ? 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.idproducto, detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal
    ORDER BY detalleventas.codproducto ASC";

	} elseif(decrypt($_GET['tipopago']) == 2){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,   
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo 
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."'
    AND ventas.codigo = ? 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CONTADO'
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC";

	} elseif(decrypt($_GET['tipopago']) == 3){
		
    $sql ="SELECT 
    detalleventas.idproducto,
    detalleventas.codproducto,
    detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
    detalleventas.codmarca,
    detalleventas.codmodelo,
    detalleventas.codpresentacion,
	detalleventas.codcolor,
    detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,   
    detalleventas.ivaproducto,
    detalleventas.descproducto,
    detalleventas.valortotal,
    detalleventas.valorneto,
    detalleventas.tipodetalle,
    productos.existencia,
    marcas.nommarca, 
    modelos.nommodelo, 
    presentaciones.nompresentacion,
	colores.nomcolor,
    combos.existencia AS cantcombo,
    ventas.iva, 
    ventas.fechaventa,   
    sucursales.documsucursal,
    sucursales.cuitsucursal, 
    sucursales.nomsucursal,  
    sucursales.documencargado,
    sucursales.dniencargado,
    sucursales.nomencargado,
    sucursales.codmoneda,
    sucursales.codmoneda2,
	sucursales.ticket_general,
    documentos.documento,
    documentos2.documento AS documento2,
    tiposmoneda.moneda,
    tiposmoneda.siglas,
    tiposmoneda.simbolo,
    tiposmoneda2.moneda AS moneda2,
    tiposmoneda2.siglas AS siglas2,
    tiposmoneda2.simbolo AS simbolo2,
    valor_cambio.montocambio,
    usuarios.dni,
    usuarios.nombres, 
    SUM(detalleventas.cantidad) AS cantidad,
	SUM(detalleventas.totaldescuentov) as totaldescuentov,
	SUM(detalleventas.subtotalimpuestos) as subtotalimpuestos 
    FROM (ventas INNER JOIN detalleventas ON ventas.codventa = detalleventas.codventa) 
    LEFT JOIN productos ON detalleventas.idproducto = productos.idproducto 
    LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca 
    LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
    LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
    LEFT JOIN combos ON detalleventas.idproducto = combos.idcombo
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal
    LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
    LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
    LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
    LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
    LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo 
	LEFT JOIN
      (SELECT
      codcambio, descripcioncambio, montocambio, codmoneda       
      FROM tiposcambio
      ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
    WHERE ventas.codsucursal = '".decrypt($_GET['codsucursal'])."'
    AND ventas.codigo = ? 
    AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
    GROUP BY detalleventas.codproducto, detalleventas.precioventa, detalleventas.descproducto, detalleventas.codsucursal 
    ORDER BY detalleventas.codproducto ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim($_GET['codigo']));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO EXISTEN PRODUCTOS FACTURADOS PARA EL VENDEDOR Y RANGO DE FECHA INGRESADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################### FUNCION BUSCAR DETALLES VENTAS POR VENDEDOR ###############################

############################ FIN DE CLASE VENTAS #############################





































###################################### CLASE CREDITOS ###################################

####################### FUNCION REGISTRAR PAGOS A CREDITOS ##########################
public function RegistrarPagoVenta()
{
	self::SetNames();
	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
	arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.ingresos,
	arqueocaja.creditos,
	arqueocaja.abonos
	FROM arqueocaja 
	INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja 
	INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
	WHERE usuarios.codigo = ? AND arqueocaja.statusarqueo = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_SESSION["codigo"]));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD = $row['codarqueo'];
		$codcajaBD   = $row['codcaja'];
		$ingresoBD   = ($row['ingresos']== "" ? "0.00" : $row['ingresos']);
		$creditoBD   = ($row['creditos']== "" ? "0.00" : $row['creditos']);
		$abonoBD     = ($row['abonos']== "" ? "0.00" : $row['abonos']);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

	if(empty($_POST["codigocliente"]) or empty($_POST["codigosucursal"]) or empty($_POST["codventa"]) or empty($_POST["montoabono"]))
	{
		echo "2";
		exit;
	} 
	else if($_POST["montoabono"] > $_POST["totaldebe"])
	{
		echo "3";
		exit;
	} 
	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	ticket_general 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST['codigosucursal']))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$ticket_general  = $row['ticket_general'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################
	$sql = "SELECT montocredito 
	FROM creditosxclientes 
	WHERE codcliente = '".limpiar($_POST['codigocliente'])."' 
	AND codsucursal = '".limpiar(decrypt($_POST["codigosucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
    $montocreditoBD = (empty($row['montocredito']) ? "0.00" : $row['montocredito']);
    ################### VERIFICO MONTO DE CREDITO DEL CLIENTE ######################

    ######################### CODIGO DE ABONO #########################
	$sql = "SELECT 
	codabono 
	FROM abonoscreditosventas 
	ORDER BY idabono 
	DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$num=$row["codabono"];
	}
	$codabono = (empty($num) ? "1" : $num + 1);
    ######################### CODIGO DE ABONO #########################

    ################### CODIGO DE CREDITO ABONO ####################
	$sql4 = "SELECT codcredito FROM abonoscreditosventas 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codigosucursal"]))."' 
	ORDER BY idabono DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

		$id = $row4["codcredito"];
	}
	if(empty($id))
	{
		$codcredito = "0000001";

	} else {

		$var        = strlen("");
        $var1       = substr($id , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codcredito = $var4;
	}
	################### CODIGO DE CREDITO ABONO ####################

	######################### REGISTRO ABONO DE CREDITO #########################
    $query = "INSERT INTO abonoscreditosventas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codabono);
	$stmt->bindParam(2, $codcredito);
	$stmt->bindParam(3, $codarqueo);
	$stmt->bindParam(4, $codcaja);
	$stmt->bindParam(5, $codventa);
	$stmt->bindParam(6, $codcliente);
	$stmt->bindParam(7, $montoabono);
	$stmt->bindParam(8, $formaabono);
	$stmt->bindParam(9, $codbanco);
	$stmt->bindParam(10, $comprobante);
	$stmt->bindParam(11, $fechaabono);
	$stmt->bindParam(12, $codsucursal);

	$tipodocumento = limpiar($ticket_general == "8" ? "TICKET_CREDITO_VENTA_8" : "TICKET_CREDITO_VENTA_5");
	$codarqueo     = limpiar($codarqueoBD);
	$codcaja       = limpiar($codcajaBD);
	$codventa      = limpiar(decrypt($_POST["codventa"]));
	$codcliente    = limpiar($_POST["codigocliente"]);
	$montoabono    = number_format($_POST["montoabono"], 2, '.', '');
	$formaabono    = decrypt($_POST["formaabono"]);
	$codbanco      = limpiar(decrypt($_POST["codbanco"]));
	$comprobante   = limpiar($_POST["comprobante"]);
	$fechaabono    = limpiar(date("Y-m-d H:i:s"));
	$codsucursal   = limpiar(decrypt($_POST["codigosucursal"]));
	$stmt->execute();
	######################### REGISTRO ABONO DE CREDITO #########################

	############# ACTUALIZAMNOS DATOS DE CAJA ##############
	$sql = "UPDATE arqueocaja set "
	." abonos = ? "
	." WHERE "
	." codarqueo = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $txtAbono);
	$stmt->bindParam(2, $codarqueo);

    $txtAbono  = number_format($_POST["montoabono"]+$abonoBD, 2, '.', '');
    $codarqueo = limpiar($codarqueoBD);
	$stmt->execute();
	############# ACTUALIZAMNOS DATOS DE CAJA ##############

	############## ACTUALIZAMOS EL MONTO DE CREDITO ##################
	$sql = "UPDATE creditosxclientes set"
	." montocredito = ? "
	." WHERE "
	." codcliente = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $montocredito);
	$stmt->bindParam(2, $codcliente);
	$stmt->bindParam(3, $codsucursal);

	$montocredito = number_format($montocreditoBD - $_POST["montoabono"], 2, '.', '');
	$codcliente   = limpiar($_POST["codigocliente"]);
	$codsucursal  = limpiar(decrypt($_POST["codigosucursal"]));
	$stmt->execute();
    ############## ACTUALIZAMOS EL MONTO DE CREDITO ##################

    ############## ACTUALIZAMOS EL STATUS DE LA FACTURA ##################
	if($_POST["montoabono"] == $_POST["totaldebe"]) {

		######################### ACTUALIZO DATOS EN VENTA #########################
		$sql = "UPDATE ventas set "
		." creditopagado = ?, "
		." statusventa = ?, "
		." fechapagado = ? "
		." WHERE "
		." codventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $creditopagado);
		$stmt->bindParam(2, $statusventa);
		$stmt->bindParam(3, $fechapagado);
		$stmt->bindParam(4, $codventa);
		$stmt->bindParam(5, $codsucursal);

		$creditopagado = number_format($_POST["totalabono"] + $_POST["montoabono"], 2, '.', '');
		$statusventa   = limpiar("PAGADA");
		$fechapagado   = limpiar(date("Y-m-d"));
		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codsucursal   = limpiar(decrypt($_POST["codigosucursal"]));
		$stmt->execute();
		######################### ACTUALIZO DATOS EN VENTA #########################
	
	} else {

		######################### ACTUALIZO DATOS EN VENTA #########################
		$sql = "UPDATE ventas set "
		." creditopagado = ? "
		." WHERE "
		." codventa = ? AND codsucursal = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $creditopagado);
		$stmt->bindParam(2, $codventa);
		$stmt->bindParam(3, $codsucursal);

		$creditopagado = number_format($_POST["totalabono"] + $_POST["montoabono"], 2, '.', '');
		$codventa      = limpiar(decrypt($_POST["codventa"]));
		$codsucursal   = limpiar(decrypt($_POST["codigosucursal"]));
		$stmt->execute();
		######################### ACTUALIZO DATOS EN VENTA #########################
	}
    ############## ACTUALIZAMOS EL STATUS DE LA FACTURA ##################
	
    echo "<span class='fa fa-check-square-o'></span> EL ABONO AL CR&Eacute;DITO DE VENTA HA SIDO REGISTRADO EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codventa=".encrypt($codventa)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
########################## FUNCION REGISTRAR PAGOS A CREDITOS ####################

########################## FUNCION BUSQUEDA DE CREDITOS ###############################
public function BusquedaCreditos() 
{
	self::SetNames();
	if ($_SESSION['acceso'] == "cajero") {

		if(limpiar($_GET['tipobusqueda']) == 1){
	  	$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3
		ORDER BY ventas.codfactura ASC";
		} else if(limpiar($_GET['tipobusqueda']) == 2){
	  	$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE CONCAT(ventas.codventa, ' ',ventas.codfactura, ' ',ventas.tipodocumento, ' ',ventas.totalpago, ' ',if(ventas.codcliente='0','0',clientes.dnicliente), ' ',if(ventas.codcliente='0','0',clientes.nomcliente), ' ',if(ventas.codcliente='0','0',clientes.girocliente), ' ',sucursales.cuitsucursal, ' ',sucursales.nomsucursal, ' ',sucursales.dniencargado, ' ',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		} else if(limpiar($_GET['tipobusqueda']) == 3){
		$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
	    WHERE DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3 
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		}
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
			echo "</div>";		
			exit;
		}
		else
		{
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
		}

   } else {

	  	if(limpiar($_GET['tipobusqueda']) == 1){
	  	$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3
		ORDER BY ventas.codfactura ASC";
		} else if(limpiar($_GET['tipobusqueda']) == 2){
	  	$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		   WHERE CONCAT(ventas.codventa, ' ',ventas.codfactura, ' ',ventas.tipodocumento, ' ',ventas.totalpago, ' ',if(ventas.codcliente='0','0',clientes.dnicliente), ' ',if(ventas.codcliente='0','0',clientes.nomcliente), ' ',if(ventas.codcliente='0','0',clientes.girocliente), ' ',sucursales.cuitsucursal, ' ',sucursales.nomsucursal, ' ',sucursales.dniencargado, ' ',sucursales.nomencargado) LIKE '%".limpiar($_GET['search_criterio'])."%'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		} else if(limpiar($_GET['tipobusqueda']) == 3){
		$sql ="SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN '".limpiar(date("Y-m-d",strtotime($_GET['desde'])))."' AND '".limpiar(date("Y-m-d",strtotime($_GET['hasta'])))."'
		AND ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa !='ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
		documentos.documento,
		documento2, 
		documento3
		ORDER BY ventas.codfactura ASC LIMIT 0,60";
		}
		$stmt = $this->dbh->prepare($sql);
		$stmt->execute();
		$num = $stmt->rowCount();
		if($num==0)
		{
			echo "<div class='alert alert-danger'>";
			echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
			echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
			echo "</div>";		
			exit;
		}
		else
		{
			while($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$this->p[]=$row;
			}
			return $this->p;
			$this->dbh=null;
	    }
    }
}
########################## FUNCION BUSQUEDA DE CREDITOS ###############################

###################### FUNCION LISTAR CREDITOS ####################### 
public function ListarCreditos()
{
	self::SetNames();
    if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE ventas.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa != 'ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.nomcliente,
		clientes.razoncliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento, 
		documento2, 
		documento3
		ORDER BY ventas.codventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else if($_SESSION["acceso"] == "cajero") {

		$sql = "SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE ventas.codigo = '".limpiar($_SESSION["codigo"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa != 'ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.nomcliente,
		clientes.razoncliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento, 
		documento2, 
		documento3
		ORDER BY ventas.codventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT 
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento,
		documentos2.documento AS documento2, 
		documentos3.documento AS documento3 
		FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
		LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND ventas.tipopago = 'CREDITO'
		AND ventas.statusventa != 'ANULADA'
		GROUP BY
		ventas.idventa,
		ventas.tipodocumento,
		ventas.codventa,
		ventas.codcliente,
		ventas.codfactura, 
		ventas.totalpago, 
		ventas.tipopago,
		ventas.creditopagado,
		ventas.statusventa,
		ventas.fechaventa, 
		ventas.fechavencecredito,
		ventas.fechapagado,
		ventas.observaciones,
		ventas.codsucursal, 
		sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
	    sucursales.ticket_general,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.nomcliente,
		clientes.razoncliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito, 
		documentos.documento, 
		documento2, 
		documento3
		ORDER BY ventas.codventa ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
###################### FUNCION LISTAR CREDITOS #######################

###################### FUNCION LISTAR CREDITOS VENCIDOS ####################### 
public function ListarCreditosVencidos()
{
	self::SetNames();
    $sql = "SELECT 
	ventas.idventa,
	ventas.tipodocumento,
	ventas.codventa,
	ventas.codcliente,
	ventas.codfactura, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3 
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND DATE_FORMAT(ventas.fechavencecredito,'%Y-%m-%d') <= '".date("Y-m-d")."'
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa = 'PENDIENTE'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.idventa,
	ventas.tipodocumento,
	ventas.codventa,
	ventas.codcliente,
	ventas.codfactura, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento, 
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
###################### FUNCION LISTAR CREDITOS VENCIDOS ####################### 

############################ FUNCION ID CREDITOS #################################
public function CreditosPorId()
{
	self::SetNames();
	$sql = " SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcaja, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,
	ventas.totalpago2,
	ventas.creditopagado, 
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
    ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
    ventas.observaciones,  
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
	usuarios.dni, 
	usuarios.nombres,
	provincias.provincia,
	departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2
	FROM (ventas INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN abonoscreditosventas ON ventas.codventa = abonoscreditosventas.codventa
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento 
	LEFT JOIN cajas ON abonoscreditosventas.codcaja = cajas.codcaja
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codventa = ? 
	AND ventas.codsucursal = ? 
	GROUP BY abonoscreditosventas.codventa";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID CREDITOS #################################
	
########################### FUNCION VER DETALLES VENTAS #######################
public function VerDetallesAbonosVentas()
{
	self::SetNames();
	$sql = "SELECT 
	abonoscreditosventas.*, 
	cajas.nrocaja,
    cajas.nomcaja,
	ventas.codventa,
	mediospagos.mediopago,
	bancos.nombanco
	FROM abonoscreditosventas 
	LEFT JOIN ventas ON abonoscreditosventas.codventa = ventas.codventa
	LEFT JOIN cajas ON abonoscreditosventas.codcaja = cajas.codcaja 
	LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	LEFT JOIN bancos ON abonoscreditosventas.codbanco = bancos.codbanco
	WHERE abonoscreditosventas.codventa = ? 
	AND abonoscreditosventas.codsucursal = ?";	
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET["codventa"])));
	$stmt->bindValue(2, trim(decrypt($_GET["codsucursal"])));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
	    while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION VER DETALLES VENTAS ###########################

###################### FUNCION BUSQUEDA ABONOS CREDITOS POR CAJAS ###########################
public function BuscarAbonosCreditosVentasxCajas() 
{
	self::SetNames();
	$sql ="SELECT 
	ventas.idventa, 
	ventas.codventa,
	ventas.tipodocumento, 
	ventas.codfactura, 
	ventas.creditopagado,
	abonoscreditosventas.codcaja, 
	abonoscreditosventas.codventa,
	abonoscreditosventas.codcliente, 
	abonoscreditosventas.montoabono, 
	abonoscreditosventas.formaabono, 
	abonoscreditosventas.fechaabono, 
	abonoscreditosventas.codbanco, 
	abonoscreditosventas.comprobante,
    abonoscreditosventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
	provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
    mediospagos.mediopago,
	cajas.nrocaja,
	cajas.nomcaja,
	usuarios.dni,
	usuarios.nombres
	FROM (abonoscreditosventas LEFT JOIN ventas ON abonoscreditosventas.codventa = ventas.codventa)
	LEFT JOIN cajas ON abonoscreditosventas.codcaja = cajas.codcaja
	LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	LEFT JOIN bancos ON abonoscreditosventas.codbanco = bancos.codbanco
	LEFT JOIN usuarios ON cajas.codigo = usuarios.codigo
	LEFT JOIN sucursales ON abonoscreditosventas.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON abonoscreditosventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE abonoscreditosventas.codsucursal = ?
	AND abonoscreditosventas.codcaja = ?
	AND abonoscreditosventas.formaabono = ?
	AND DATE_FORMAT(abonoscreditosventas.fechaabono,'%Y-%m-%d') BETWEEN ? AND ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(decrypt($_GET['codmediopago'])));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(5, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA ABONOS CREDITOS POR CAJAS ###########################

###################### FUNCION BUSQUEDA CREDITOS POR CONDICIONES ###########################
public function BuscarCreditosVentasxCondiciones() 
{
	self::SetNames();
	if(decrypt($_GET['tipobusqueda']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipobusqueda']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PAGADA'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['tipobusqueda']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PENDIENTE'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

    } elseif(decrypt($_GET['tipobusqueda']) == 4){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechavencecredito,'%Y-%m-%d') < '".date('Y-m-d')."'
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PENDIENTE'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA EL CLIENTE INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS POR CONDICIONES ###########################

###################### FUNCION BUSQUEDA CREDITOS POR FECHAS ###########################
public function BuscarCreditosVentasxFechas() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PAGADA'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PENDIENTE' 
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS POR FECHAS ###########################

###################### FUNCION BUSQUEDA CREDITOS POR CLIENTES ###########################


###################### FUNCION BUSQUEDA CREDITOS AGRUPADOS POR CLIENTE Y FECHAS ###########################
public function BuscarCreditosVentasxFechasAgrupado() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	ORDER BY clientes.nomcliente ASC, clientes.razoncliente ASC, ventas.fechaventa ASC";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PAGADA'
	AND ventas.statusventa != 'ANULADA' 
	ORDER BY clientes.nomcliente ASC, clientes.razoncliente ASC, ventas.fechaventa ASC";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PENDIENTE' 
	AND ventas.statusventa != 'ANULADA'
	ORDER BY clientes.nomcliente ASC, clientes.razoncliente ASC, ventas.fechaventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA EL RANGO DE FECHA INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS AGRUPADOS POR CLIENTE Y FECHAS ###########################

public function BuscarCreditosVentasxClientes() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PAGADA' 
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago, 
	ventas.tipopago,
	ventas.creditopagado,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito, 
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3  
	FROM (ventas INNER JOIN clientes ON ventas.codcliente = clientes.codcliente)
	LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa ='PENDIENTE'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codcliente']));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA EL CLIENTE INGRESADO</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA CREDITOS POR CLIENTES ###########################

###################### FUNCION BUSQUEDA DETALLES CREDITOS POR FECHAS ###########################
public function BuscarDetallesCreditosVentasxFechas() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO' 
	AND ventas.statusventa ='PAGADA'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND DATE_FORMAT(ventas.fechaventa,'%Y-%m-%d') BETWEEN ? AND ?
	AND ventas.tipopago = 'CREDITO' 
	AND ventas.statusventa ='PENDIENTE'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA DETALLES CREDITOS POR FECHAS ###########################

###################### FUNCION BUSQUEDA DETALLES CREDITOS POR CLIENTES ###########################
public function BuscarDetallesCreditosVentasxClientes() 
{
	self::SetNames();
	if(decrypt($_GET['status']) == 1){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO'
	AND ventas.statusventa != 'ANULADA' 
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 2){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie,
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO' 
	AND ventas.statusventa ='PAGADA'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";

	} elseif(decrypt($_GET['status']) == 3){

	$sql = "SELECT 
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documentos2.documento AS documento2, 
	documentos3.documento AS documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
    FROM (ventas LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente)
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento

	LEFT JOIN
	    (SELECT
	    codventa,
	    SUM(detalleventas.cantidad) AS articulos,
	    GROUP_CONCAT(
	   	    detalleventas.cantidad, ' | ', 
		 	detalleventas.producto, ' | ', 
		   	detalleventas.descripcion, ' | ',
		   	if(detalleventas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detalleventas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detalleventas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detalleventas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos

	    FROM detalleventas
	        LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor
	    WHERE detalleventas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
	    GROUP BY
	    detalleventas.codventa) pag ON pag.codventa = ventas.codventa

	LEFT JOIN
	    (SELECT
	    codcliente, 
	    codventa, 
	    GROUP_CONCAT(
	        abonoscreditosventas.montoabono, ' | ',
	        mediospagos.mediopago, ' | ', 
	        DATE_FORMAT(abonoscreditosventas.fechaabono,'%d/%m/%Y %H:%i:%s') SEPARATOR '<br>') AS detalles_abonos
	    FROM abonoscreditosventas
	    LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
	    GROUP BY
	    abonoscreditosventas.codcliente, abonoscreditosventas.codventa
	    ORDER BY abonoscreditosventas.codventa ASC) pag2 ON ventas.codventa = pag2.codventa

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE ventas.codsucursal = ? 
	AND ventas.codcliente = ? 
	AND ventas.tipopago = 'CREDITO' 
	AND ventas.statusventa ='PENDIENTE'
	AND ventas.statusventa != 'ANULADA'
	GROUP BY
	ventas.codventa,
	ventas.tipodocumento,
	ventas.codcliente,
	ventas.codfactura,
	ventas.codserie, 
	ventas.totalpago,
	ventas.creditopagado, 
	ventas.tipopago,
	ventas.statusventa,
	ventas.fechaventa, 
	ventas.fechavencecredito,
	ventas.fechapagado,
	ventas.observaciones,
	ventas.codsucursal, 
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.ticket_general,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.nomcliente,
	clientes.razoncliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
	documento2, 
	documento3,
	pag.articulos,
	pag.detalles_productos,
	pag2.detalles_abonos
	ORDER BY ventas.codventa ASC";
    }
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET['codcliente']));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON CREDITOS PARA TU BUSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA DETALLES CREDITOS POR CLIENTES ###########################

###################################### CLASE CREDITOS ###################################































###################################### CLASE NOTA DE CREDITO ###################################

############################ FUNCION ID VENTAS #################################
public function BuscarVentasPorId()
{
	self::SetNames();
	$sql = "SELECT 
	ventas.idventa, 
	ventas.tipodocumento, 
	ventas.codarqueo, 
	ventas.codcaja, 
	ventas.codventa,
	ventas.codfactura, 
	ventas.codserie, 
	ventas.codautorizacion, 
	ventas.codcliente, 
	ventas.exonerado,  
	ventas.subtotal,
	ventas.subtotalexento, 
	ventas.subtotaliva, 
	ventas.iva, 
	ventas.totaliva, 
	ventas.descontado, 
	ventas.descuento, 
	ventas.totaldescuento, 
	ventas.totalpago,
	ventas.totalpago2, 
	ventas.creditopagado,
	ventas.tipopago, 
	ventas.formapago, 
	ventas.montopagado, 
	ventas.montodevuelto, 
	ventas.fechavencecredito, 
    ventas.fechapagado,
	ventas.statusventa, 
	ventas.fechaventa,
    ventas.observaciones,  
    ventas.notacredito,   
	ventas.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
    mediospagos.mediopago,
    cajas.nrocaja,
    cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres,
    provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
    IFNULL(pag.montocredito,'0.00') AS montoactual,
    pag2.abonototal
    FROM (ventas INNER JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON ventas.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento 
	LEFT JOIN cajas ON ventas.codcaja = cajas.codcaja
	LEFT JOIN mediospagos ON ventas.formapago = mediospagos.codmediopago 
	LEFT JOIN usuarios ON ventas.codigo = usuarios.codigo

	LEFT JOIN
       (SELECT
       codcambio, descripcioncambio, montocambio, codmoneda       
       FROM tiposcambio
       ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
    
    LEFT JOIN
       (SELECT
       codcliente, montocredito       
       FROM creditosxclientes 
       WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') pag ON pag.codcliente = clientes.codcliente
    
    LEFT JOIN
       (SELECT
       codventa, 
       codcliente, 
       IFNULL(montoabono,'0.00') AS abonototal
       FROM abonoscreditosventas 
       WHERE codventa = '".limpiar($_GET["codventa"])."' AND codsucursal = '".limpiar($_SESSION["codsucursal"])."') pag2 ON pag2.codcliente = clientes.codcliente

    WHERE ventas.codventa = ? AND ventas.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array($_GET["codventa"],limpiar($_SESSION["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID VENTAS #################################
	
############################ FUNCION VER DETALLES VENTAS #############################
public function BuscarDetallesVentas()
{
	self::SetNames();
	$sql = "SELECT
	detalleventas.coddetalleventa,
	detalleventas.codventa,
	detalleventas.idproducto,
	detalleventas.codproducto,
	detalleventas.producto,
	detalleventas.descripcion,
	detalleventas.imei,
	detalleventas.condicion,
	detalleventas.codmarca,
	detalleventas.codmodelo,
	detalleventas.codpresentacion,
	detalleventas.codcolor,
	detalleventas.cantidad,
	detalleventas.preciocompra,
	detalleventas.precioventa,
	detalleventas.posicionimpuesto,
	detalleventas.tipoimpuesto,  
	detalleventas.ivaproducto,
	detalleventas.descproducto,
	detalleventas.valortotal, 
	detalleventas.totaldescuentov,
	detalleventas.subtotalimpuestos,
	detalleventas.valorneto,
	detalleventas.valorneto2,
	detalleventas.tipodetalle,
	detalleventas.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detalleventas LEFT JOIN marcas ON detalleventas.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detalleventas.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detalleventas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detalleventas.codcolor = colores.codcolor 
	WHERE detalleventas.codventa = ? 
	AND detalleventas.codsucursal = ? ";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(limpiar($_GET["codventa"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION VER DETALLES VENTAS ###########################

####################### FUNCION REGISTRAR NOTA DE CREDITO #############################
public function RegistrarNotaCredito()
{
	self::SetNames();
	if($_POST["descontar"] == 1){//VERIFICO SI SE DESCONTARA DE CAJA

	####################### VERIFICO ARQUEO DE CAJA #######################
	$sql = "SELECT
    arqueocaja.codarqueo,
	arqueocaja.codcaja,
	arqueocaja.montoinicial,
	arqueocaja.ingresos,
	arqueocaja.ingresos2,
	arqueocaja.egresos,
	arqueocaja.egresonotas,
	pagos.total_efectivo,
	IFNULL(movimientos.movimientos_efectivo,'0.00') AS movimientos_efectivo,
	IFNULL(abonos.abonos_efectivo,'0.00') AS abonos_efectivo
	FROM arqueocaja
	   
	   LEFT JOIN
		   (SELECT
		   mediospagoxventas.codarqueo,
		   (SUM(mediospagoxventas.montopagado) - SUM(mediospagoxventas.montodevuelto)) AS total_efectivo,
		   mediospagos.mediopago
		   FROM mediospagoxventas LEFT JOIN mediospagos ON mediospagoxventas.codmediopago = mediospagos.codmediopago
		   WHERE mediospagoxventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY mediospagoxventas.codarqueo, mediospagos.mediopago
	       ORDER BY mediospagoxventas.codarqueo ASC) pagos ON arqueocaja.codarqueo = pagos.codarqueo
          
      LEFT JOIN
		   (SELECT
		   movimientoscajas.codarqueo,
		   SUM(movimientoscajas.montomovimiento) AS movimientos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM movimientoscajas LEFT JOIN mediospagos ON movimientoscajas.codmediopago = mediospagos.codmediopago
		   WHERE movimientoscajas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
           AND movimientoscajas.tipomovimiento = 'INGRESO'
		   GROUP BY movimientoscajas.codarqueo, mediospagos.mediopago
		   ORDER BY movimientoscajas.codarqueo ASC) movimientos ON arqueocaja.codarqueo = movimientos.codarqueo

		LEFT JOIN
		   (SELECT
		   abonoscreditosventas.codarqueo,
		   SUM(abonoscreditosventas.montoabono) AS abonos_efectivo,
		   mediospagos.mediopago AS mediopago
		   FROM abonoscreditosventas LEFT JOIN mediospagos ON abonoscreditosventas.formaabono = mediospagos.codmediopago
		   WHERE abonoscreditosventas.codarqueo = '".decrypt($_POST["codarqueo"])."'
		   AND mediospagos.mediopago = 'EFECTIVO'
		   GROUP BY abonoscreditosventas.codarqueo, mediospagos.mediopago
		   ORDER BY abonoscreditosventas.codarqueo ASC) abonos ON arqueocaja.codarqueo = abonos.codarqueo
            
	WHERE arqueocaja.codarqueo = ?";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_POST["codarqueo"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "1";
		exit;

	} else {
		
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		$codarqueoBD           = $row['codarqueo'];
		$codcajaBD             = $row['codcaja'];
		$inicialBD             = $row['montoinicial'];
		$ingresosBD            = $row['ingresos'];
		$ingresos2BD           = $row['ingresos2'];
		$total_efectivoBD      = $row['total_efectivo'];
		$movimiento_EfectivoBD = $row['movimientos_efectivo'];
		$total_abonosBD        = $row['abonos_efectivo'];
		$egresosBD             = $row['egresos'];
		$egresonotasBD         = $row['egresonotas'];
		$SaldoCaja             = ($inicialBD+$total_efectivoBD+$movimiento_EfectivoBD+$total_abonosBD)-($egresosBD+$egresonotasBD);
	}
    ####################### VERIFICO ARQUEO DE CAJA #######################

    }//FIN DE VERIFICO SI SE DESCONTARA DE CAJA

	if(empty($_POST["tipodocumento"]) or empty($_POST["codventa"]) or empty($_POST["tipofacturaventa"]) or empty($_POST["facturaventa"]) or empty($_POST["observaciones"]) or empty($_POST["fechanota"]))
	{
		echo "2";
		exit;
	} 
	elseif(!array_filter($_POST['devuelto']) || $_POST["txtTotal"] == "" || $_POST["txtTotal"] == "0" || $_POST["txtTotal"] == "0.00")
	{
		echo "3";
		exit;
	} 
	else if($_POST["descontar"] == 1 && $_POST["txtTotal"] > $SaldoCaja)
	{
		echo "4";
		exit;
	}

	$this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['devuelto']);$i++){
       if (!empty($_POST['devuelto'][$i])) {

        	if($_POST['devuelto'][$i] > $_POST['cantidad'][$i]){

        		echo "5";
        		exit;
        	}
        }//fin de if
	}//fin de for
    $this->dbh->commit();

	################# OBTENGO DATOS DE SUCURSAL #################
	$sql = " SELECT 
	cuitsucursal, 
	nroactividadsucursal, 
	inicionotacredito 
	FROM sucursales WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."'";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	$cuitsucursal      = $row['cuitsucursal'];
	$nroactividad      = $row['nroactividadsucursal'];
	$inicionotacredito = $row['inicionotacredito'];
	################# OBTENGO DATOS DE SUCURSAL #################

	################ CREO CODIGO DE NOTA ####################
	$sql = "SELECT codnota FROM notascredito 
	ORDER BY idnota DESC LIMIT 1";
	foreach ($this->dbh->query($sql) as $row){

		$nota = $row["codnota"];
	}
	if(empty($nota))
	{
		$codnota     = "01";

	} else {

		$num         = substr($nota, 0);
        $dig         = $num + 1;
        $codigofinal = str_pad($dig, 2, "0", STR_PAD_LEFT);
        $codnota     = $codigofinal;
	}
    ################ CREO CODIGO DE NOTA ###############

	################### CREO CODIGO DE FACTURA ####################
	$sql4 = "SELECT codfactura 
	FROM notascredito 
	WHERE codsucursal = '".limpiar(decrypt($_POST["codsucursal"]))."' 
	ORDER BY idnota DESC LIMIT 1";
	foreach ($this->dbh->query($sql4) as $row4){

	   $factura = $row4["codfactura"];
	}
	if(empty($nota))
	{
		$codfactura = "NC".$nroactividad.'-'.$inicionotacredito;

	} else {

        $var        = strlen("NC".$nroactividad."-");
        $var1       = substr($factura , $var);
        $var2       = strlen($var1);
        $var3       = $var1 + 1;
        $var4       = str_pad($var3, $var2, "0", STR_PAD_LEFT);
        $codfactura = "NC".$nroactividad.'-'.$var4;
	}
    ################ CREO LOS CODIGO VENTA-SERIE-AUTORIZACION ###############

	################### REGISTRO LA NOTA DE CREDITO ####################
	$query = "INSERT INTO notascredito values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
	$stmt = $this->dbh->prepare($query);
	$stmt->bindParam(1, $codcaja);
	$stmt->bindParam(2, $codnota);
	$stmt->bindParam(3, $tipodocumento);
	$stmt->bindParam(4, $codfactura);
	$stmt->bindParam(5, $tipofacturaventa);
	$stmt->bindParam(6, $facturaventa);
	$stmt->bindParam(7, $codcliente);
	$stmt->bindParam(8, $exonerado);
	$stmt->bindParam(9, $subtotal);
	$stmt->bindParam(10, $subtotalexento);
	$stmt->bindParam(11, $subtotaliva);
	$stmt->bindParam(12, $iva);
	$stmt->bindParam(13, $totaliva);
	$stmt->bindParam(14, $descontado);
	$stmt->bindParam(15, $descuento);
	$stmt->bindParam(16, $totaldescuento);
	$stmt->bindParam(17, $totalpago);
	$stmt->bindParam(18, $fechanota);
	$stmt->bindParam(19, $observaciones);
	$stmt->bindParam(20, $estado);
	$stmt->bindParam(21, $codigo);
	$stmt->bindParam(22, $codsucursal);

    $codcaja         = limpiar($_POST['descontar'] == 1 ? $codcajaBD : "0");
    $tipodocumento   = limpiar($_POST["tipodocumento"]);
    $tipofacturaventa= limpiar($_POST["tipofacturaventa"]);
	$facturaventa    = limpiar($_POST["facturaventa"]);
	$codcliente      = limpiar($_POST["codcliente"]);
	$exonerado       = limpiar($_POST["exonerado"]);
	$subtotal        = limpiar($_POST["txtsubtotal"]);
	$subtotalexento  = limpiar($_POST["txtexento"]);
	$subtotaliva     = limpiar($_POST["txtsubtotaliva"]);
	$iva             = limpiar($_POST["iva"]);
	$totaliva        = limpiar($_POST["txtIva"]);
	$descontado      = limpiar($_POST["txtdescontado"]);
	$descuento       = limpiar($_POST["descuento"]);
	$totaldescuento  = limpiar($_POST["txtDescuento"]);
	$totalpago       = limpiar($_POST["txtTotal"]);
	$fechanota       = limpiar(date("Y-m-d",strtotime($_POST['fechanota']))." ".date("H:i:s"));
	$observaciones   = limpiar($_POST["observaciones"]);
	$estado          = limpiar("1");
	$codigo          = limpiar($_SESSION["codigo"]);
	$codsucursal     = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
	################### REGISTRO LA NOTA DE CREDITO ####################

	$this->dbh->beginTransaction();
	for($i=0;$i<count($_POST['devuelto']);$i++){
        if (!empty($_POST['devuelto'][$i])) {

        	################### REGISTRO DETALLES DE NOTA DE CREDITO ####################
        	$query = "INSERT INTO detallenotas values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?); ";
        	$stmt = $this->dbh->prepare($query);
        	$stmt->bindParam(1, $codnota);
        	$stmt->bindParam(2, $idproducto);
        	$stmt->bindParam(3, $codproducto);
        	$stmt->bindParam(4, $producto);
		    $stmt->bindParam(5, $descripcion);
		    $stmt->bindParam(6, $imei);
		    $stmt->bindParam(7, $condicion);
		    $stmt->bindParam(8, $codmarca);
		    $stmt->bindParam(9, $codmodelo);
		    $stmt->bindParam(10, $codpresentacion);
		    $stmt->bindParam(11, $codcolor);
        	$stmt->bindParam(12, $cantidad);
        	$stmt->bindParam(13, $preciocompra);
        	$stmt->bindParam(14, $precioventa);
	        $stmt->bindParam(15, $posicionimpuesto);
        	$stmt->bindParam(16, $tipoimpuesto);
        	$stmt->bindParam(17, $ivaproducto);
        	$stmt->bindParam(18, $descproducto);
        	$stmt->bindParam(19, $valortotal);
        	$stmt->bindParam(20, $totaldescuentov);
        	$stmt->bindParam(21, $subtotalimpuestos);
        	$stmt->bindParam(22, $valorneto);
        	$stmt->bindParam(23, $tipodetalle);
        	$stmt->bindParam(24, $codsucursal);

        	$idproducto        = limpiar($_POST['idproducto'][$i]);
        	$codproducto       = limpiar($_POST['codproducto'][$i]);
        	$producto          = limpiar($_POST['producto'][$i]);
        	$descripcion       = limpiar($_POST['descripcion'][$i]);
        	$imei              = limpiar($_POST['imei'][$i]);
        	$condicion         = limpiar($_POST['condicion'][$i]);
        	$codmarca          = limpiar($_POST['codmarca'][$i]);
        	$codmodelo         = limpiar($_POST['codmodelo'][$i]);
        	$codpresentacion   = limpiar($_POST['codpresentacion'][$i]);
        	$codcolor          = limpiar($_POST['codcolor'][$i]);
        	$cantidad          = limpiar($_POST['devuelto'][$i]);
        	$preciocompra      = limpiar($_POST['preciocompra'][$i]);
        	$precioventa       = limpiar($_POST['precioventa'][$i]);
        	$posicionimpuesto  = limpiar($_POST['posicionimpuesto'][$i]);
        	$tipoimpuesto      = limpiar($_POST['tipoimpuesto'][$i]);
        	$ivaproducto       = limpiar($_POST['ivaproducto'][$i]);
        	$descproducto      = limpiar($_POST['descproducto'][$i]);
        	$descuento         = $_POST['descproducto'][$i]/100;
        	$valortotal        = number_format($_POST['valortotal'][$i], 2, '.', '');
        	$totaldescuentov   = number_format($_POST['totaldescuentov'][$i], 2, '.', '');
		    $subtotalimpuestos = number_format($_POST['subtotalimpuestos'][$i], 0, '.', '');
		    $valorneto         = number_format($_POST['valorneto'][$i], 0, '.', '');
        	$tipodetalle       = limpiar($_POST['tipodetalle'][$i]);
        	$codsucursal       = limpiar(decrypt($_POST["codsucursal"]));
        	$stmt->execute();
        	################### REGISTRO DETALLES DE NOTA DE CREDITO ####################

        	################### ACTUALIZO EL ESTADO DE IMEI ###################
			if($_POST['imei'][$i] != ""){

				$valoresArray = explode(',', $_POST['imei'][$i]);
			    $sql = "UPDATE imei SET estadoimei = ?
				WHERE numeroimei IN (".implode(',', $valoresArray).") 
				AND codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."';";
				$stmt = $this->dbh->prepare($sql);
				$stmt->bindParam(1, $estadoimei);
				$estadoimei = "1";
				$stmt->execute();
			}
			################### ACTUALIZO EL ESTADO DE IMEI ###################

      if(limpiar($_POST['tipodetalle'][$i]) == 1){ //SI EL DETALLE ES UN PRODUCTO

        	#################### CONSULTO EXISTENCIA DE PRODUCTO ####################
        	$sql2 = "SELECT existencia FROM productos WHERE idproducto = ? AND codproducto = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($_POST['idproducto'][$i],$_POST['codproducto'][$i],decrypt($_POST["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			#################### CONSULTO EXISTENCIA DE PRODUCTO ####################

        	#################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO ####################
			$sql = "UPDATE productos SET "
			." existencia = ? "
			." WHERE "
			." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $codsucursal);

			$existencia  = number_format($existenciaBD + $_POST['devuelto'][$i], 2, '.', '');
        	$idproducto  = limpiar($_POST['idproducto'][$i]);
        	$codproducto = limpiar($_POST['codproducto'][$i]);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			#################### ACTUALIZAMOS LA EXISTENCIA DE PRODUCTO ####################

		    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO DEVUELTO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codnota);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);	
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codresponsable = limpiar($_POST["codcliente"]);
			$codproducto    = limpiar($_POST['codproducto'][$i]);
			$movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($_POST['devuelto'][$i], 2, '.', '');
			$stockactual    = number_format($existenciaBD + $_POST['devuelto'][$i], 2, '.', '');
			$ivaproducto    = limpiar($_POST['ivaproducto'][$i] == "0.00" ? "EXENTO" : $_POST['tipoimpuesto'][$i]." (".$_POST['ivaproducto'][$i]." %)");
			$descproducto   = number_format($_POST['descproducto'][$i], 2, '.', '');
			$precio         = number_format($_POST["precioventa"][$i], 2, '.', '');
			$documento      = limpiar("NOTA DE CRÉDITO: ".$codfactura);
			$fechakardex    = limpiar(date("Y-m-d H:i:s"));
			$tipokardex     = limpiar($_POST['tipodetalle'][$i]);
	        $procedimiento  = limpiar("1");
			$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
		    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO DEVUELTO EN KARDEX ##########

		} elseif(limpiar($_POST['tipodetalle'][$i]) == 2){ // SI EL DETALLE ES UN COMBO

			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################
			$sql2 = "SELECT existencia FROM combos WHERE idcombo = ? AND codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql2);
			$stmt->execute(array($_POST['idproducto'][$i],$_POST['codproducto'][$i],decrypt($_POST["codsucursal"])));
			$num = $stmt->rowCount();

			if($row = $stmt->fetch(PDO::FETCH_ASSOC))
			{
				$p[] = $row;
			}
			$existenciaBD = $row['existencia'];
			############## VERIFICO LA EXISTENCIA DEL COMBO EN ALMACEN #################	

			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############
			$sql = "UPDATE combos SET "
			." existencia = ? "
			." WHERE "
			." idcombo = ? AND codcombo = ? AND codsucursal = ?;
			";
			$stmt = $this->dbh->prepare($sql);
			$stmt->bindParam(1, $existencia);
			$stmt->bindParam(2, $idproducto);
			$stmt->bindParam(3, $codproducto);	
			$stmt->bindParam(4, $codsucursal);	

			$existencia  = number_format($existenciaBD + $_POST['devuelto'][$i], 2, '.', '');
	        $idproducto  = limpiar($_POST['idproducto'][$i]);
	        $codproducto = limpiar($_POST['codproducto'][$i]);
			$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
			$stmt->execute();
			########### ACTUALIZAMOS LA EXISTENCIA DE COMBO EN ALMACEN #############

			########## REGISTRAMOS LOS DATOS DEL PRODUCTO DEVUELTO EN KARDEX ##########
			$query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codnota);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);	
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codresponsable = limpiar($_POST["codcliente"]);
	        $codproducto    = limpiar($_POST['codproducto'][$i]);
	        $movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
			$devolucion     = number_format($_POST['devuelto'][$i], 2, '.', '');
			$stockactual    = number_format($existenciaBD + $_POST['devuelto'][$i], 2, '.', '');
	        $ivaproducto    = limpiar($_POST['ivaproducto'][$i] == "0.00" ? "EXENTO" : $_POST['tipoimpuesto'][$i]." (".$_POST['ivaproducto'][$i]." %)");
	        $descproducto   = number_format($_POST['descproducto'][$i], 2, '.', '');
			$precio         = number_format($_POST["precioventa"][$i], 2, '.', '');
	        $documento      = limpiar("NOTA DE CRÉDITO: ".$codfactura);
	        $fechakardex    = limpiar(date("Y-m-d H:i:s"));
	        $tipokardex     = limpiar($_POST['tipodetalle'][$i]);
	        $procedimiento  = limpiar("2");
			$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
			########## REGISTRAMOS LOS DATOS DEL PRODUCTO DEVUELTO EN KARDEX ##########	

			############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################
		    $sql = "SELECT * FROM combosxproductos WHERE codcombo = ? AND codsucursal = ?";
			$stmt = $this->dbh->prepare($sql);
			$stmt->execute(array(limpiar($_POST['codproducto'][$i]),decrypt($_POST["codsucursal"])));
			$num = $stmt->rowCount();
	        if($num>0) {  

        	$sql = "SELECT 
        	combosxproductos.codcombo,
	    	combosxproductos.idproducto,
        	combosxproductos.codproducto,
        	combosxproductos.cantidad,
        	combosxproductos.codsucursal,
        	productos.existencia,
        	productos.precioxpublico AS precioventa,
        	productos.ivaproducto,
        	productos.descproducto,
	    	impuestos.codimpuesto,
	    	impuestos.nomimpuesto,
	    	impuestos.valorimpuesto
	    	FROM combosxproductos 
        	LEFT JOIN productos ON combosxproductos.codproducto = productos.codproducto
        	LEFT JOIN impuestos ON productos.ivaproducto = impuestos.codimpuesto 
        	WHERE combosxproductos.codcombo IN ('".limpiar($_POST['codproducto'][$i])."') 
        	AND combosxproductos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."' 
	    	AND productos.codsucursal = '".limpiar(decrypt($_POST['codsucursal']))."'";
        	foreach ($this->dbh->query($sql) as $row)
		    { 
			    $this->p[] = $row;

			    $cantracionBD2    = $row['cantidad'];
			    $idproductoBD2    = $row['idproducto'];
			    $codproductoBD2   = $row['codproducto'];
			    $existenciaBD2    = $row['existencia'];
			    $precioventaBD2   = $row['precioventa'];
			    $nomimpuestoBD2   = $row['nomimpuesto'];
			    $valorimpuestoBD2 = $row['valorimpuesto'];
			    $ivaproductoBD2   = $row['ivaproducto'];
			    $descproductoBD2  = $row['descproducto'];		

			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################
			    $update = "UPDATE productos set "
			    ." existencia = ? "
			    ." WHERE "
			    ." idproducto = ? AND codproducto = ? AND codsucursal = ?;
			    ";
			    $stmt = $this->dbh->prepare($update);
			    $stmt->bindParam(1, $cantidadracion);
			    $stmt->bindParam(2, $idproducto);
			    $stmt->bindParam(3, $codproducto);
	            $stmt->bindParam(4, $codsucursal);

			    $racion         = number_format($cantracionBD2*$cantidad, 2, '.', '');
			    $cantidadracion = number_format($existenciaBD2+$racion, 2, '.', '');
		        $idproducto     = limpiar($idproductoBD2);
		        $codproducto    = limpiar($codproductoBD2);
	            $codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
			    $stmt->execute();
			    ############## ACTUALIZO LOS DATOS DEL PRODUCTO #################

			    ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ##########
			    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
				$stmt = $this->dbh->prepare($query);
				$stmt->bindParam(1, $codnota);
				$stmt->bindParam(2, $codresponsable);
				$stmt->bindParam(3, $codproducto);
				$stmt->bindParam(4, $movimiento);
				$stmt->bindParam(5, $entradas);
				$stmt->bindParam(6, $salidas);
				$stmt->bindParam(7, $devolucion);
				$stmt->bindParam(8, $stockactual);
				$stmt->bindParam(9, $ivaproducto);
				$stmt->bindParam(10, $descproducto);
				$stmt->bindParam(11, $precio);
				$stmt->bindParam(12, $documento);
				$stmt->bindParam(13, $fechakardex);	
				$stmt->bindParam(14, $tipokardex);	
	            $stmt->bindParam(15, $procedimiento);	
				$stmt->bindParam(16, $codsucursal);
		        $stmt->bindParam(17, $codigo);

				$codresponsable = limpiar($_POST["codcliente"]);
		        $codproducto    = limpiar($codproductoBD2);
		        $movimiento     = limpiar("DEVOLUCION");
				$entradas       = limpiar("0.00");
				$salidas        = limpiar("0.00");
			    $devolucion     = number_format($racion, 2, '.', '');
			    $stockactual    = number_format($existenciaBD2 + $racion, 2, '.', '');
			    $ivaproducto    = limpiar($ivaproductoBD2);
			    $descproducto   = number_format($descproductoBD2, 2, '.', '');
			    $precio         = number_format($precioventaBD2, 2, '.', '');
		        $documento      = limpiar("NOTA DE CRÉDITO (DETALLE DE COMBO): ".$codfactura);
		        $fechakardex    = limpiar(date("Y-m-d H:i:s"));
		        $tipokardex     = limpiar("1");
	            $procedimiento  = limpiar("2");
			  	$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
    	        $codigo         = limpiar($_SESSION["codigo"]);
				$stmt->execute();
		        ########## REGISTRAMOS LOS DATOS DEL PRODUCTO ELIMINADO EN KARDEX ########## 
		    }
	    }//fin de consulta de productos en combos	
	    ############## VERIFICO SI EL COMBO TIENE PRODUCTO RELACIONADOS #################

		} else { // SI EL DETALLE ES UN SERVICIO

		    ########## REGISTRAMOS LOS DATOS DEL SERVICIO DEVUELTO EN KARDEX ##########
		    $query = "INSERT INTO kardex values (null, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?);";
			$stmt = $this->dbh->prepare($query);
			$stmt->bindParam(1, $codnota);
			$stmt->bindParam(2, $codresponsable);
			$stmt->bindParam(3, $codproducto);
			$stmt->bindParam(4, $movimiento);
			$stmt->bindParam(5, $entradas);
			$stmt->bindParam(6, $salidas);
			$stmt->bindParam(7, $devolucion);
			$stmt->bindParam(8, $stockactual);
			$stmt->bindParam(9, $ivaproducto);
			$stmt->bindParam(10, $descproducto);
			$stmt->bindParam(11, $precio);
			$stmt->bindParam(12, $documento);
			$stmt->bindParam(13, $fechakardex);	
			$stmt->bindParam(14, $tipokardex);	
	        $stmt->bindParam(15, $procedimiento);
			$stmt->bindParam(16, $codsucursal);
		    $stmt->bindParam(17, $codigo);

			$codresponsable = limpiar($_POST["codcliente"]);
	        $codproducto    = limpiar($_POST['codproducto'][$i]);
	        $movimiento     = limpiar("DEVOLUCION");
			$entradas       = limpiar("0.00");
			$salidas        = limpiar("0.00");
		    $devolucion     = number_format($_POST['devuelto'][$i], 2, '.', '');
		    $stockactual    = limpiar("0.00");
		    $ivaproducto    = limpiar($_POST['ivaproducto'][$i] == "0.00" ? "EXENTO" : $_POST['tipoimpuesto'][$i]." (".$_POST['ivaproducto'][$i]." %)");
	        $descproducto   = number_format($_POST['descproducto'][$i], 2, '.', '');
		    $precio         = number_format($_POST["precioventa"][$i], 2, '.', '');
	        $documento      = limpiar("NOTA DE CRÉDITO: ".$codfactura);
	        $fechakardex    = limpiar(date("Y-m-d H:i:s"));
	        $tipokardex     = limpiar($_POST['tipodetalle'][$i]);
	        $procedimiento  = limpiar("3");	
			$codsucursal    = limpiar(decrypt($_POST["codsucursal"]));
    	    $codigo         = limpiar($_SESSION["codigo"]);
			$stmt->execute();
	        ########## REGISTRAMOS LOS DATOS DEL SERVICIO DEVUELTO EN KARDEX ##########
		}

      }//fin de if
	}//fin de for
    $this->dbh->commit();

	############## ACTUALIZAMOS STATUS DE FACTURA ###############
	$sql = "UPDATE ventas set "
	." statusventa = ?, "
	." notacredito = ? "
	." WHERE "
	." codventa = ? AND codsucursal = ?;
	";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindParam(1, $statusventa);
	$stmt->bindParam(2, $notacredito);
	$stmt->bindParam(3, $codventa);
	$stmt->bindParam(4, $codsucursal);

	$statusventa = limpiar("ANULADA");
	$notacredito = limpiar("1");
	$codventa    = limpiar(decrypt($_POST["codventa"]));
	$codsucursal = limpiar(decrypt($_POST["codsucursal"]));
	$stmt->execute();
    ################ ACTUALIZAMOS STATUS DE FACTURA ##############

    ############## DESCONTAMOS EL TOTAL DE DOCUMENTO EN CAJA ###############
	if (limpiar($_POST["descontar"]) == 1){

		########################## DESCUENTO EL MONTO EN CAJA ##########################
	    $sql = "UPDATE arqueocaja set "
		." egresonotas = ? "
		." WHERE "
		." codarqueo = ?;
		";
		$stmt = $this->dbh->prepare($sql);
		$stmt->bindParam(1, $txtTotal);
		$stmt->bindParam(2, $codarqueo);

		$txtTotal   = number_format($egresonotasBD+$_POST["txtTotal"], 2, '.', '');
		$codarqueo  = limpiar($codarqueoBD);
		$stmt->execute();
		########################## DESCUENTO EL MONTO EN CAJA ##########################
	}
    ################ DESCONTAMOS EL TOTAL DE DOCUMENTO EN CAJA ##############

    echo "<span class='fa fa-check-square-o'></span> LA NOTA DE CR&Eacute;DITO HA SIDO REGISTRADA EXITOSAMENTE";
    echo "<script>VentanaCentrada('reportepdf?codnota=".encrypt($codnota)."&codsucursal=".encrypt($codsucursal)."&tipo=".encrypt($tipodocumento)."', '', '', '1024', '568', 'true');</script>";
	exit;
}
##################### FUNCION REGISTRAR NOTA DE CREDITO ###########################

############################ FUNCION ID NOTA CREDITO #################################
public function NotaCreditoPorId()
{
	self::SetNames();
	$sql = "SELECT 
    notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.tlfsucursal,
	sucursales.correosucursal,
	sucursales.id_provincia,
	sucursales.id_departamento,
	sucursales.direcsucursal,
	sucursales.nroactividadsucursal,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.tlfencargado,
	sucursales.fechaautorsucursal,
	sucursales.llevacontabilidad,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	sucursales.membrete,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia AS id_provincia2, 
	clientes.id_departamento AS id_departamento2,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
    provincias.provincia,
    departamentos.departamento,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
    cajas.nrocaja,
    cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres
    FROM (notascredito INNER JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento 
	LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
	LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo
	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE notascredito.codnota = ? 
	AND notascredito.codsucursal = ?";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codnota"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID NOTA CREDITO #################################

########################### FUNCION VER DETALLES NOTA DE CREDITO ##########################
public function VerDetallesNotasCredito()
{
	self::SetNames();
	$sql = "SELECT
	detallenotas.coddetallenota,
	detallenotas.codnota,
	detallenotas.idproducto,
	detallenotas.codproducto,
	detallenotas.producto,
	detallenotas.descripcion,
	detallenotas.imei,
	detallenotas.condicion,
	detallenotas.codmarca,
	detallenotas.codmodelo,
	detallenotas.codpresentacion,
	detallenotas.codcolor,
	detallenotas.cantidad,
	detallenotas.preciocompra,
	detallenotas.precioventa,
	detallenotas.posicionimpuesto,
	detallenotas.tipoimpuesto,
	detallenotas.ivaproducto,
	detallenotas.descproducto,
	detallenotas.valortotal, 
	detallenotas.totaldescuentov,
	detallenotas.subtotalimpuestos,
	detallenotas.valorneto,
	detallenotas.tipodetalle,
	detallenotas.codsucursal,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor
	FROM detallenotas 
	LEFT JOIN productos ON detallenotas.codproducto = productos.codproducto 
	LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
	LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
	LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
	LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor  
	WHERE detallenotas.codnota = ? 
	AND detallenotas.codsucursal = ? ";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute(array(decrypt($_GET["codnota"]),decrypt($_GET["codsucursal"])));
	$num = $stmt->rowCount();
	
	while($row = $stmt->fetch(PDO::FETCH_ASSOC))
	{
		$this->p[]=$row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION VER DETALLES NOTA DE CREDITO #######################

###################### FUNCION LISTAR NOTA DE CREDITO ####################### 
public function ListarNotasCreditos()
{
	self::SetNames();
	if ($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documentos2.documento AS documento2, 
	    documentos3.documento AS documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
		pag.articulos,
	    pag.detalles_productos 
		FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
		LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE notascredito.codsucursal = '".limpiar(decrypt($_GET["codsucursal"]))."'
		GROUP BY 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documento2, 
	    documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
	    articulos,
	    detalles_productos
		ORDER BY notascredito.codnota ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else if($_SESSION["acceso"] == "cajero") {

		$sql = "SELECT 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documentos2.documento AS documento2, 
	    documentos3.documento AS documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
		pag.articulos,
	    pag.detalles_productos 
		FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
		LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar($_SESSION['codsucursal'])."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2 
		WHERE notascredito.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND notascredito.codigo = '".limpiar($_SESSION["codigo"])."'
		GROUP BY 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente
		,clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documento2, 
	    documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
	    articulos,
	    detalles_productos
		ORDER BY notascredito.codnota ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

    } else {

	    $sql = "SELECT 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		tiposmoneda2.moneda AS moneda2,
		tiposmoneda2.siglas AS siglas2,
		tiposmoneda2.simbolo AS simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documentos2.documento AS documento2, 
	    documentos3.documento AS documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
		pag.articulos,
	    pag.detalles_productos 
		FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
		LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
		LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
		LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
		LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
		LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
		LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
		LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
		LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

		LEFT JOIN
	        (SELECT
	        codcambio, descripcioncambio, montocambio, codmoneda       
	        FROM tiposcambio
	        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
		WHERE notascredito.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		GROUP BY 
		notascredito.idnota,
		notascredito.codcaja, 
	    notascredito.codnota,
	    notascredito.tipodocumento,
	    notascredito.codfactura,
	    notascredito.tipofacturaventa,
	    notascredito.facturaventa,
		notascredito.codcliente,
		notascredito.exonerado, 
		notascredito.subtotal,
		notascredito.subtotalexento, 
		notascredito.subtotaliva, 
		notascredito.iva, 
		notascredito.totaliva, 
		notascredito.descontado, 
		notascredito.descuento, 
		notascredito.totaldescuento, 
		notascredito.totalpago,
		notascredito.fechanota,
	    notascredito.observaciones,
	    notascredito.estado, 
		notascredito.codsucursal,
	    sucursales.documsucursal, 
		sucursales.cuitsucursal, 
		sucursales.nomsucursal,
		sucursales.documencargado,
		sucursales.dniencargado,
		sucursales.nomencargado,
		sucursales.codmoneda,
		sucursales.codmoneda2,
		tiposmoneda.moneda,
		tiposmoneda.siglas,
		tiposmoneda.simbolo,
		moneda2,
		siglas2,
		simbolo2,
		valor_cambio.montocambio,
		clientes.tipocliente,
		clientes.documcliente,
		clientes.dnicliente,
		clientes.tipocliente,
		clientes.razoncliente,
		clientes.nomcliente,
		clientes.girocliente,
		clientes.tlfcliente,
		clientes.id_provincia,
		clientes.id_departamento,
		clientes.direccliente,
		clientes.emailcliente,
		clientes.limitecredito,
		documentos.documento,
	    documento2, 
	    documento3,
		cajas.nrocaja,
		cajas.nomcaja,
	    usuarios.dni, 
	    usuarios.dni, 
	    usuarios.nombres,
	    articulos,
	    detalles_productos
		ORDER BY notascredito.codnota ASC";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
    }
}
###################### FUNCION LISTAR NOTA DE CREDITO ####################### 

###################### FUNCION BUSQUEDA NOTAS POR CAJAS ###########################
public function BuscarNotasCreditosxCajas() 
{
	self::SetNames();
	$sql ="SELECT 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres,
	pag.articulos,
	pag.detalles_productos 
	FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
	LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE notascredito.codsucursal = ?
	AND notascredito.codcaja = ? 
	AND DATE_FORMAT(notascredito.fechanota,'%Y-%m-%d') BETWEEN ? AND ?  
	GROUP BY 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documento2, 
    documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.dni, 
    usuarios.nombres,
	articulos,
	detalles_productos
	ORDER BY notascredito.codnota ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(decrypt($_GET['codcaja'])));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(4, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA NOTAS POR CAJAS ###########################

###################### FUNCION BUSQUEDA NOTAS POR FECHAS ###########################
public function BuscarNotasCreditosxFechas() 
{
	self::SetNames();
	$sql ="SELECT 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres,
	pag.articulos,
	pag.detalles_productos 
	FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
	LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE notascredito.codsucursal = ? 
	AND DATE_FORMAT(notascredito.fechanota,'%Y-%m-%d') BETWEEN ? AND ?  
	GROUP BY 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documento2, 
    documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.dni, 
    usuarios.nombres,
	articulos,
	detalles_productos
	ORDER BY notascredito.codnota ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim(date("Y-m-d",strtotime($_GET['desde']))));
	$stmt->bindValue(3, trim(date("Y-m-d",strtotime($_GET['hasta']))));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA NOTAS POR FECHAS ###########################

###################### FUNCION BUSQUEDA NOTAS POR CLIENTE ###########################
public function BuscarNotasCreditosxClientes() 
{
	self::SetNames();
	$sql ="SELECT 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	tiposmoneda2.moneda AS moneda2,
	tiposmoneda2.siglas AS siglas2,
	tiposmoneda2.simbolo AS simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	CONCAT(if(clientes.tipocliente='NATURAL',clientes.nomcliente,clientes.razoncliente)) as nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documentos2.documento AS documento2, 
    documentos3.documento AS documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.nombres,
    provincias2.provincia AS provincia2,
    departamentos2.departamento AS departamento2,
	pag.articulos,
	pag.detalles_productos 
	FROM (notascredito LEFT JOIN sucursales ON notascredito.codsucursal = sucursales.codsucursal)
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN clientes ON notascredito.codcliente = clientes.codcliente
	LEFT JOIN documentos AS documentos3 ON clientes.documcliente = documentos3.coddocumento
	LEFT JOIN provincias AS provincias2 ON clientes.id_provincia = provincias2.id_provincia 
	LEFT JOIN departamentos AS departamentos2 ON clientes.id_departamento = departamentos2.id_departamento
	LEFT JOIN cajas ON notascredito.codcaja = cajas.codcaja
	LEFT JOIN usuarios ON notascredito.codigo = usuarios.codigo

		LEFT JOIN
		   (SELECT
		   codnota,
		   SUM(detallenotas.cantidad) AS articulos,
		   GROUP_CONCAT(
		   	detallenotas.cantidad, ' | ', 
		 	detallenotas.producto, ' | ', 
		   	detallenotas.descripcion, ' | ',
		   	if(detallenotas.codmarca='0','',marcas.nommarca), ' | ',
		   	if(detallenotas.codmodelo='0','',modelos.nommodelo), ' | ', 
		   	if(detallenotas.codpresentacion='0','',presentaciones.nompresentacion), ' | ', 
		   	if(detallenotas.codcolor='0','',colores.nomcolor) SEPARATOR '<br>') AS detalles_productos
		FROM detallenotas
		    LEFT JOIN marcas ON detallenotas.codmarca = marcas.codmarca
			LEFT JOIN modelos ON detallenotas.codmodelo = modelos.codmodelo 
			LEFT JOIN presentaciones ON detallenotas.codpresentacion = presentaciones.codpresentacion
			LEFT JOIN colores ON detallenotas.codcolor = colores.codcolor
		    WHERE detallenotas.codsucursal = '".limpiar(decrypt($_GET['codsucursal']))."'
		    GROUP BY
		    detallenotas.codnota) pag ON pag.codnota = notascredito.codnota

	LEFT JOIN
        (SELECT
        codcambio, descripcioncambio, montocambio, codmoneda       
        FROM tiposcambio
        ORDER BY codcambio DESC LIMIT 1) valor_cambio ON valor_cambio.codmoneda = sucursales.codmoneda2
	WHERE notascredito.codsucursal = ? 
	AND notascredito.codcliente = ?
	GROUP BY 
	notascredito.idnota,
	notascredito.codcaja, 
    notascredito.codnota,
    notascredito.tipodocumento,
    notascredito.codfactura,
    notascredito.tipofacturaventa,
    notascredito.facturaventa,
	notascredito.codcliente,
	notascredito.exonerado, 
	notascredito.subtotal,
	notascredito.subtotalexento, 
	notascredito.subtotaliva, 
	notascredito.iva, 
	notascredito.totaliva, 
	notascredito.descontado, 
	notascredito.descuento, 
	notascredito.totaldescuento, 
	notascredito.totalpago,
	notascredito.fechanota,
    notascredito.observaciones,
    notascredito.estado, 
	notascredito.codsucursal,
    sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	sucursales.codmoneda,
	sucursales.codmoneda2,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	moneda2,
	siglas2,
	simbolo2,
	valor_cambio.montocambio,
	clientes.tipocliente,
	clientes.documcliente,
	clientes.dnicliente,
	clientes.tipocliente,
	clientes.razoncliente,
	clientes.nomcliente,
	clientes.girocliente,
	clientes.tlfcliente,
	clientes.id_provincia,
	clientes.id_departamento,
	clientes.direccliente,
	clientes.emailcliente,
	clientes.limitecredito,
	documentos.documento,
    documento2, 
    documento3,
	cajas.nrocaja,
	cajas.nomcaja,
    usuarios.dni, 
    usuarios.dni, 
    usuarios.nombres,
    provincia2,
    departamento2,
	articulos,
	detalles_productos
	ORDER BY notascredito.codnota ASC";
	$stmt = $this->dbh->prepare($sql);
	$stmt->bindValue(1, trim(decrypt($_GET['codsucursal'])));
	$stmt->bindValue(2, trim($_GET["codcliente"]));
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "<div class='alert alert-danger'>";
		echo "<button type='button' class='close' data-dismiss='alert' aria-hidden='true'>&times;</button>";
		echo "<center><span class='fa fa-info-circle'></span> NO SE ENCONTRARON RESULTADOS EN TU BÚSQUEDA REALIZADA</center>";
		echo "</div>";		
		exit;
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
###################### FUNCION BUSQUEDA NOTAS POR CLIENTES ###########################

###################################### CLASE NOTA DE CREDITO ###################################













###################################### CLASE DATOS DE PAGINA WEB ###################################

############################ FUNCION ID SUCURSAL ACTIVA #################################
public function SucursalActivaPorId()
{
	self::SetNames();
	$sql = "SELECT  
	sucursales.*,
	documentos.documento,
	documentos2.documento AS documento2,
	tiposmoneda.moneda,
	tiposmoneda2.moneda AS moneda2,
	provincias.provincia,
	departamentos.departamento 
	FROM sucursales 
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	LEFT JOIN documentos AS documentos2 ON sucursales.documencargado = documentos2.coddocumento
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	LEFT JOIN tiposmoneda AS tiposmoneda2 ON sucursales.codmoneda2 = tiposmoneda2.codmoneda
	LEFT JOIN provincias ON sucursales.id_provincia = provincias.id_provincia 
	LEFT JOIN departamentos ON sucursales.id_departamento = departamentos.id_departamento
	WHERE sucursales.codsucursal = 1";
	$stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";
	}
	else
	{
		if($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
############################ FUNCION ID SUCURSAL ACTIVA #################################

########################### FUNCION LISTAR FAMILIAS X SUCURSAL ACTIVA ################################
public function ListarFamiliasxSucursalActiva()
{
	self::SetNames();
	$sql = "SELECT
	familias.codfamilia,
	familias.nomfamilia,
	familias.codsucursal,
	sucursales.documsucursal, 
	sucursales.cuitsucursal, 
	sucursales.nomsucursal,
	sucursales.documencargado,
	sucursales.dniencargado,
	sucursales.nomencargado,
	documentos.documento,
	GROUP_CONCAT(subfamilias.codsubfamilia, ' | ', subfamilias.nomsubfamilia SEPARATOR '<br>') AS detalles_subfamilias
   FROM familias LEFT JOIN subfamilias ON familias.codfamilia = subfamilias.codfamilia
   LEFT JOIN sucursales ON familias.codsucursal = sucursales.codsucursal
	LEFT JOIN documentos ON sucursales.documsucursal = documentos.coddocumento
	WHERE sucursales.codsucursal = 1
	GROUP BY familias.codfamilia
	ORDER BY familias.nomfamilia ASC";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
############################ FUNCION LISTAR FAMILIAS X SUCURSAL ACTIVA ################################

########################### FUNCION LISTAR PRODUCTOS X SUCURSAL ACTIVA ################################
public function ListarProductosxSucursalActivos()
{
	self::SetNames();
	$sql = "SELECT
	productos.idproducto,
	productos.codproducto,
	productos.producto,
	productos.descripcion,
	productos.imei,
	productos.condicion,
	productos.codfamilia,
	productos.codsubfamilia,
	productos.codmarca,
	productos.codmodelo,
	productos.codpresentacion,
	productos.codcolor,
	productos.codorigen,
	productos.precioxpublico,
	productos.existencia,
	productos.descproducto,
	productos.codsucursal,
	sucursales.codmoneda,
	tiposmoneda.moneda,
	tiposmoneda.siglas,
	tiposmoneda.simbolo,
	familias.nomfamilia,
	subfamilias.nomsubfamilia,
	marcas.nommarca,
	modelos.nommodelo,
	presentaciones.nompresentacion,
	colores.nomcolor,
	origenes.nomorigen
	FROM (productos INNER JOIN sucursales ON productos.codsucursal = sucursales.codsucursal)
    LEFT JOIN familias ON productos.codfamilia=familias.codfamilia
	LEFT JOIN subfamilias ON productos.codsubfamilia=subfamilias.codsubfamilia 
	LEFT JOIN marcas ON productos.codmarca=marcas.codmarca 
	LEFT JOIN modelos ON productos.codmodelo = modelos.codmodelo
	LEFT JOIN presentaciones ON productos.codpresentacion=presentaciones.codpresentacion 
	LEFT JOIN colores ON productos.codcolor=colores.codcolor 
	LEFT JOIN origenes ON productos.codorigen=origenes.codorigen 
	LEFT JOIN tiposmoneda ON sucursales.codmoneda = tiposmoneda.codmoneda
	WHERE sucursales.codsucursal = 1
	ORDER BY productos.producto ASC LIMIT 0,50";
    $stmt = $this->dbh->prepare($sql);
	$stmt->execute();
	$num = $stmt->rowCount();
	if($num==0)
	{
		echo "";	
	}
	else
	{
		while($row = $stmt->fetch(PDO::FETCH_ASSOC))
		{
			$this->p[]=$row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
########################## FUNCION LISTAR PRODUCTOS X SUCURSAL ACTIVA ################################

###################################### CLASE DATOS DE PAGINA WEB ###################################
















########################## FUNCION PARA GRAFICOS #################################

########################## FUNCION GRAFICO POR SUCURSALES ##########################
public function GraficoxSucursal()
{
	self::SetNames();
    $sql = "SELECT 
    sucursales.codsucursal,
	sucursales.nomsucursal,
    pag.sumcompras,
    pag2.sumcotizacion,
    pag3.sumventas
    FROM
        sucursales
        LEFT JOIN
            (SELECT
            codsucursal, SUM(totalpago) AS sumcompras         
            FROM compras WHERE DATE_FORMAT(fechaemision,'%Y') = '".date("Y")."' GROUP BY codsucursal) pag ON pag.codsucursal = sucursales.codsucursal  
        LEFT JOIN
            (SELECT
            codsucursal, SUM(totalpago) AS sumcotizacion
            FROM cotizaciones WHERE DATE_FORMAT(fechacotizacion,'%Y') = '".date("Y")."' GROUP BY codsucursal) pag2 ON pag2.codsucursal = sucursales.codsucursal 
        LEFT JOIN
            (SELECT
            codsucursal, SUM(totalpago) AS sumventas
            FROM ventas WHERE DATE_FORMAT(fechaventa,'%Y') = '".date("Y")."' GROUP BY codsucursal) pag3 ON pag3.codsucursal = sucursales.codsucursal
    GROUP BY 
    codsucursal,
    nomsucursal,
    sumcompras,
    sumcotizacion,
    sumventas";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION GRAFICO POR SUCURSALES ###########################

########################### FUNCION SUMA DE TRASPASOS #################################
public function SumaTraspasos()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fechatraspaso) mes, 
	SUM(totalpago) totalmes
	FROM traspasos 
	WHERE sucursal_envia = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fechatraspaso) = '".date('Y')."' AND MONTH(fechatraspaso) GROUP BY MONTH(fechatraspaso) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
} 
########################### FUNCION SUMA DE TRASPASOS #################################

########################### FUNCION SUMA DE PEDIDOS #################################
public function SumaPedidos()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fechapedido) mes, 
	SUM(totalpago) totalmes
	FROM pedidos 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fechapedido) = '".date('Y')."' AND MONTH(fechapedido) GROUP BY MONTH(fechapedido) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
} 
########################### FUNCION SUMA DE PEDIDOS #################################

########################### FUNCION SUMA DE COMPRAS #################################
public function SumaCompras()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fecharecepcion) mes, 
	SUM(totalpago) totalmes
	FROM compras 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fecharecepcion) = '".date('Y')."' AND MONTH(fecharecepcion) GROUP BY MONTH(fecharecepcion) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
} 
########################### FUNCION SUMA DE COMPRAS #################################

########################### FUNCION SUMA DE COTIZACIONES ############################
public function SumaCotizaciones()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fechacotizacion) mes, 
	SUM(totalpago) totalmes
	FROM cotizaciones 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fechacotizacion) = '".date('Y')."' AND MONTH(fechacotizacion) GROUP BY MONTH(fechacotizacion) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
} 
########################### FUNCION SUMA DE COTIZACIONES #############################

########################### FUNCION SUMA DE PREVENTAS ############################
public function SumaPreventas()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fechapreventa) mes, 
	SUM(totalpago) totalmes
	FROM preventas 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fechapreventa) = '".date('Y')."' AND MONTH(fechapreventa) GROUP BY MONTH(fechapreventa) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
} 
########################### FUNCION SUMA DE PREVENTAS #############################

########################### FUNCION SUMA DE VENTAS #################################
public function SumaVentas()
{
	self::SetNames();
	$sql ="SELECT  
	MONTH(fechaventa) mes, 
	SUM(totalpago) totalmes
	FROM ventas 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' AND YEAR(fechaventa) = '".date('Y')."' AND MONTH(fechaventa) GROUP BY MONTH(fechaventa) ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION SUMA DE VENTAS #################################

########################### FUNCION SUMA DE VENTAS DIARIAS X MES ACTUAL #################################
public function GraficoxVentasDiarias()
{
	self::SetNames();
	$sql ="SELECT  
	DATE_FORMAT(fechaventa,'%d %M') AS dia_venta,
	SUM(if(tipopago='CONTADO',totalpago,'0.00')) AS total_dia,
	SUM(if(tipopago='CREDITO',totalpago,'0.00')) AS total_dia2 
	FROM ventas 
	WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
	AND YEAR(fechaventa) = '".date('Y')."' 
	AND MONTH(fechaventa)  = '".date('m')."'
	GROUP BY 
	DAY(fechaventa)
	ORDER BY 1";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################### FUNCION SUMA DE VENTAS DIARIAS X MES ACTUAL #################################

########################### FUNCION PRODUCTOS 5 MAS VENDIDOS ############################
public function ProductosMasVendidos()
{
	self::SetNames();
	$sql = "SELECT 
    productos.codproducto, 
    productos.producto,
    SUM(detalleventas.cantidad) AS cantidad 
    FROM (ventas LEFT JOIN detalleventas ON ventas.codventa=detalleventas.codventa) 
    LEFT JOIN sucursales ON ventas.codsucursal = sucursales.codsucursal 
    LEFT JOIN productos ON detalleventas.codproducto=productos.codproducto 
    WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
    AND YEAR(ventas.fechaventa) = '".date('Y')."' 
    GROUP BY productos.codproducto, productos.producto 
    ORDER BY productos.codproducto ASC LIMIT 5";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION 5 PRODUCTOS MAS VENDIDOS ###########################

########################## FUNCION SUMAR VENTAS POR USUARIOS ##########################
public function VentasxUsuarios()
{
	self::SetNames();
    $sql = "SELECT usuarios.codigo, usuarios.nombres, SUM(ventas.totalpago) as total 
    FROM (usuarios INNER JOIN ventas ON usuarios.codigo=ventas.codigo) 
    WHERE ventas.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
    AND YEAR(ventas.fechaventa) = '".date('Y')."' 
    GROUP BY usuarios.codigo, usuarios.nombres";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION SUMAR VENTAS POR USUARIOS #########################

########################## FUNCION SUMAR COMPRAS POR PROVEEDOR ##########################
public function ComprasxProveedores()
{
	self::SetNames();
    $sql = "SELECT proveedores.codproveedor, proveedores.nomproveedor, SUM(compras.totalpago) as total 
    FROM (proveedores INNER JOIN compras ON proveedores.codproveedor = compras.codproveedor) 
    WHERE compras.codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
    AND YEAR(compras.fecharecepcion) = '".date('Y')."' 
    GROUP BY proveedores.codproveedor, proveedores.nomproveedor";
	foreach ($this->dbh->query($sql) as $row)
	{
		$this->p[] = $row;
	}
	return $this->p;
	$this->dbh=null;
}
########################## FUNCION SUMAR COMPRAS POR PROVEEDOR #########################

########################## FUNCION PARA CONTAR REGISTROS ###########################
public function ContarRegistros()
{
   self::SetNames();
   if($_SESSION['acceso'] == "administradorG") {

		$sql = "SELECT
		(SELECT COUNT(codsucursal) FROM sucursales) AS sucursales,
		(SELECT COUNT(codigo) FROM usuarios) AS usuarios,
		(SELECT COUNT(codproducto) FROM productos) AS productos,
		(SELECT COUNT(codcliente) FROM clientes) AS clientes,
		(SELECT COUNT(codproveedor) FROM proveedores) AS proveedores";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;

   } else {

		$sql = "SELECT
		(SELECT COUNT(codigo) FROM usuarios WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS usuarios,
		(SELECT COUNT(codproducto) FROM productos WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS productos,
		(SELECT COUNT(codcombo) FROM combos WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS combos,
		(SELECT COUNT(codcliente) FROM clientes WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS clientes,
		(SELECT COUNT(codproveedor) FROM proveedores WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS proveedores,
		(SELECT SUM(ingresos) FROM arqueocaja INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja INNER JOIN usuarios ON cajas.codigo = usuarios.codigo WHERE usuarios.codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS ingresos,
		(SELECT SUM(egresos) FROM arqueocaja INNER JOIN cajas ON arqueocaja.codcaja = cajas.codcaja INNER JOIN usuarios ON cajas.codigo = usuarios.codigo 
		WHERE usuarios.codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS egresos,
		(SELECT COUNT(idtraspaso) FROM traspasos WHERE sucursal_envia = '".limpiar($_SESSION["codsucursal"])."') AS traspasos,
		(SELECT COUNT(idpedido) FROM pedidos WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS pedidos,
		
		(SELECT COUNT(idcompra) FROM compras 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS compras,

		(SELECT ROUND(SUM(totalpago-creditopagado), 2) FROM compras 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."' 
		AND statuscompra = 'PENDIENTE') AS deudas_compras,

		(SELECT COUNT(idcotizacion) FROM cotizaciones WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS cotizaciones,
		(SELECT COUNT(idpreventa) FROM preventas WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS preventas,

		(SELECT COUNT(idventa) FROM ventas 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."') AS ventas,

		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockoptimo AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockmedio AS DECIMAL(10,2))) AS poptimo,
		
		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockmedio AS DECIMAL(10,2)) 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > CAST(productos.stockminimo AS DECIMAL(10,2))) AS pmedio,
		
		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) <= CAST(productos.stockminimo AS DECIMAL(10,2))) AS pminimo,

		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND fechaoptimo != '0000-00-00' 
		AND '".date("Y-m-d")."' <= fechaoptimo 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0) AS foptimo,
		
		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND fechamedio != '0000-00-00' 
		AND '".date("Y-m-d")."' > fechaoptimo 
		AND '".date("Y-m-d")."' <= fechamedio 
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0) AS fmedio,

		(SELECT COUNT(codproducto) FROM productos 
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND fechaminimo != '0000-00-00' 
		AND fechaminimo <= '".date("Y-m-d")."'
		AND CAST(productos.existencia AS DECIMAL(10,2)) > 0) AS fminimo,

		(SELECT COUNT(idcompra) FROM compras
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND DATE_FORMAT(fechavencecredito,'%Y-%m-%d') < '".date('Y-m-d')."'
		AND tipocompra = 'CREDITO' 
		AND statuscompra = 'PENDIENTE') AS creditoscomprasvencidos,

		(SELECT COUNT(idventa) FROM ventas
		WHERE codsucursal = '".limpiar($_SESSION["codsucursal"])."'
		AND DATE_FORMAT(fechavencecredito,'%Y-%m-%d') < '".date('Y-m-d')."'
		AND tipopago = 'CREDITO' 
		AND statusventa = 'PENDIENTE'
		AND statusventa != 'ANULADA') AS creditosventasvencidos";
		foreach ($this->dbh->query($sql) as $row)
		{
			$this->p[] = $row;
		}
		return $this->p;
		$this->dbh=null;
	}
}
######################## FUNCION PARA CONTAR REGISTROS #############################

########################## FUNCION PARA GRAFICOS #################################


}
############## TERMINA LA CLASE LOGIN ######################
?>